<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="zpj" type="application/atom+xml" />






<meta name="description" content="愿你在任何困难面前都足够坚强">
<meta property="og:type" content="website">
<meta property="og:title" content="zpj">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="zpj">
<meta property="og:description" content="愿你在任何困难面前都足够坚强">
<meta property="article:author" content="zhangpengjie">
<meta property="article:tag" content="加油">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/"/>





  <title>zpj</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<!-- 加入APlayer音乐播放器 -->
<link rel="stylesheet" href="/dist/APlayer.min.css">
<div id="aplayer"></div>
<script type="text/javascript" src="/dist/APlayer.min.js"></script>
<script type="text/javascript" src="/dist/music.js"></script>

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zpj</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">好好学习天天向上</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/26/k8s/7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhangpengjie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/zpj.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zpj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/26/k8s/7/" itemprop="url">K8S(05)核心插件-ingress(服务暴露)控制器-traefik</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-26T15:57:04+08:00">
                2020-12-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index">
                    <span itemprop="name">k8s</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/12/26/k8s/7/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/12/26/k8s/7/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<h1 id=""><a href="#" class="headerlink" title=""></a></h1><h1 id="K8S核心插件-ingress-服务暴露-控制器-traefik"><a href="#K8S核心插件-ingress-服务暴露-控制器-traefik" class="headerlink" title="K8S核心插件-ingress(服务暴露)控制器-traefik"></a>K8S核心插件-ingress(服务暴露)控制器-traefik</h1><h2 id="1-K8S两种服务暴露方法"><a href="#1-K8S两种服务暴露方法" class="headerlink" title="1 K8S两种服务暴露方法"></a>1 K8S两种服务暴露方法</h2><p>前面通过coredns在k8s集群内部做了serviceNAME和serviceIP之间的自动映射,使得不需要记录service的IP地址,只需要通过serviceNAME就能访问POD</p>
<p>但是在K8S集群外部,显然是不能通过serviceNAME或serviceIP来解析服务的</p>
<p>要在K8S集群外部来访问集群内部的资源,需要用到服务暴露功能</p>
<h3 id="1-1-K8S常用的两种服务暴露方法"><a href="#1-1-K8S常用的两种服务暴露方法" class="headerlink" title="1.1 K8S常用的两种服务暴露方法"></a>1.1 K8S常用的两种服务暴露方法</h3><ol>
<li>使用NodePort型的Service<br>nodeport型的service原理相当于端口映射，将容器内的端口映射到宿主机上的某个端口。<br>K8S集群不能使用ipvs的方式调度,必须使用iptables,且只支持rr模式</li>
<li>使用Ingress资源<br>Ingress是K8S API标准资源之一,也是核心资源<br>是一组基于域名和URL路径的规则,把用户的请求转发至指定的service资源<br>可以将集群外部的请求流量,转发至集群内部,从而实现’<strong>服务暴露</strong>‘</li>
</ol>
<h3 id="1-2-Ingress控制器是什么"><a href="#1-2-Ingress控制器是什么" class="headerlink" title="1.2 Ingress控制器是什么"></a>1.2 Ingress控制器是什么</h3><p>可以理解为一个简化版本的nginx</p>
<p>Ingress控制器是能够为Ingress资源健康某套接字,然后根据ingress规则匹配机制路由调度流量的一个组件</p>
<p>只能工作在七层网络下，建议暴露http, https可以使用前端nginx来做证书方面的卸载</p>
<p>我们使用的ingress控制器为<strong><code>Traefik</code></strong></p>
<p>traefik：<a href="https://github.com/containous/traefik" target="_blank" rel="noopener">GITHUB官方地址</a></p>
<h2 id="2-部署traefik"><a href="#2-部署traefik" class="headerlink" title="2 部署traefik"></a>2 部署traefik</h2><p>同样的,现在<code>7.200</code>完成docker镜像拉取和配置清单创建,然后再到任意master节点执行配置清单</p>
<h3 id="2-1-准备docker镜像"><a href="#2-1-准备docker镜像" class="headerlink" title="2.1 准备docker镜像"></a>2.1 准备docker镜像</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull traefik:v1.7.2-alpine</span><br><span class="line">docker tag  traefik:v1.7.2-alpine harbor.zq.com&#x2F;public&#x2F;traefik:v1.7.2</span><br><span class="line">docker push harbor.zq.com&#x2F;public&#x2F;traefik:v1.7.2</span><br></pre></td></tr></table></figure>

<h3 id="2-2-创建资源清单"><a href="#2-2-创建资源清单" class="headerlink" title="2.2 创建资源清单"></a>2.2 创建资源清单</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;data&#x2F;k8s-yaml&#x2F;traefik</span><br></pre></td></tr></table></figure>

<h4 id="2-2-1-rbac授权清单"><a href="#2-2-1-rbac授权清单" class="headerlink" title="2.2.1 rbac授权清单"></a>2.2.1 rbac授权清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;data&#x2F;k8s-yaml&#x2F;traefik&#x2F;rbac.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - services</span><br><span class="line">      - endpoints</span><br><span class="line">      - secrets</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - extensions</span><br><span class="line">    resources:</span><br><span class="line">      - ingresses</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="2-2-2-delepoly资源清单"><a href="#2-2-2-delepoly资源清单" class="headerlink" title="2.2.2 delepoly资源清单"></a>2.2.2 delepoly资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;data&#x2F;k8s-yaml&#x2F;traefik&#x2F;ds.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: traefik-ingress</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: traefik-ingress</span><br><span class="line">        name: traefik-ingress</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: traefik-ingress-controller</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      containers:</span><br><span class="line">      - image: harbor.zq.com&#x2F;public&#x2F;traefik:v1.7.2</span><br><span class="line">        name: traefik-ingress</span><br><span class="line">        ports:</span><br><span class="line">        - name: controller</span><br><span class="line">          containerPort: 80</span><br><span class="line">          hostPort: 81</span><br><span class="line">        - name: admin-web</span><br><span class="line">          containerPort: 8080</span><br><span class="line">        securityContext:</span><br><span class="line">          capabilities:</span><br><span class="line">            drop:</span><br><span class="line">            - ALL</span><br><span class="line">            add:</span><br><span class="line">            - NET_BIND_SERVICE</span><br><span class="line">        args:</span><br><span class="line">        - --api</span><br><span class="line">        - --kubernetes</span><br><span class="line">        - --logLevel&#x3D;INFO</span><br><span class="line">        - --insecureskipverify&#x3D;true</span><br><span class="line">        - --kubernetes.endpoint&#x3D;https:&#x2F;&#x2F;10.4.7.10:7443</span><br><span class="line">        - --accesslog</span><br><span class="line">        - --accesslog.filepath&#x3D;&#x2F;var&#x2F;log&#x2F;traefik_access.log</span><br><span class="line">        - --traefiklog</span><br><span class="line">        - --traefiklog.filepath&#x3D;&#x2F;var&#x2F;log&#x2F;traefik.log</span><br><span class="line">        - --metrics.prometheus</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="2-2-3-service清单"><a href="#2-2-3-service清单" class="headerlink" title="2.2.3 service清单"></a>2.2.3 service清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;data&#x2F;k8s-yaml&#x2F;traefik&#x2F;svc.yaml &lt;&lt;EOF</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-service</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: traefik-ingress</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      name: controller</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 8080</span><br><span class="line">      name: admin-web</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="2-2-4-ingress清单"><a href="#2-2-4-ingress清单" class="headerlink" title="2.2.4 ingress清单"></a>2.2.4 ingress清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;data&#x2F;k8s-yaml&#x2F;traefik&#x2F;ingress.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io&#x2F;ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: traefik.zq.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: &#x2F;</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: traefik-ingress-service</span><br><span class="line">          servicePort: 8080</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="2-3-创建资源"><a href="#2-3-创建资源" class="headerlink" title="2.3 创建资源"></a>2.3 创建资源</h3><h4 id="2-3-1-任意节点上创建资源"><a href="#2-3-1-任意节点上创建资源" class="headerlink" title="2.3.1 任意节点上创建资源"></a>2.3.1 任意节点上创建资源</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;traefik&#x2F;rbac.yaml</span><br><span class="line">kubectl create -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;traefik&#x2F;ds.yaml</span><br><span class="line">kubectl create -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;traefik&#x2F;svc.yaml</span><br><span class="line">kubectl create -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;traefik&#x2F;ingress.yaml</span><br></pre></td></tr></table></figure>

<h4 id="2-3-2-在前端nginx上做反向代理"><a href="#2-3-2-在前端nginx上做反向代理" class="headerlink" title="2.3.2 在前端nginx上做反向代理"></a>2.3.2 在前端nginx上做反向代理</h4><p>在<code>7.11</code>和<code>7.12</code>上,都做反向代理,将泛域名的解析都转发到<code>traefik</code>上去</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;zq.com.conf &lt;&lt;&#39;EOF&#39;</span><br><span class="line">upstream default_backend_traefik &#123;</span><br><span class="line">    server 10.4.7.21:81    max_fails&#x3D;3 fail_timeout&#x3D;10s;</span><br><span class="line">    server 10.4.7.22:81    max_fails&#x3D;3 fail_timeout&#x3D;10s;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    server_name *.zq.com;</span><br><span class="line"></span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;default_backend_traefik;</span><br><span class="line">        proxy_set_header Host       $http_host;</span><br><span class="line">        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"># 重启nginx服务</span><br><span class="line">nginx -t</span><br><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>

<h4 id="2-3-3-在bind9中添加域名解析"><a href="#2-3-3-在bind9中添加域名解析" class="headerlink" title="2.3.3 在bind9中添加域名解析"></a>2.3.3 在bind9中添加域名解析</h4><p>需要将traefik 服务的解析记录添加的DNS解析中,注意是绑定到VIP上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;var&#x2F;named&#x2F;zq.com.zone</span><br><span class="line">........</span><br><span class="line">traefik            A    10.4.7.10</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意前滚serial编号</p>
</blockquote>
<p>重启named服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart named</span><br><span class="line">#dig验证解析结果</span><br><span class="line">[root@hdss7-11 ~]# dig -t A traefik.zq.com +short</span><br><span class="line">10.4.7.10</span><br></pre></td></tr></table></figure>

<p>2.3.4 在集群外访问验证</p>
<p>在集群外,访问<code>http://traefik.zq.com</code>,如果能正常显示web页面.说明我们已经暴露服务成功</p>
<p>转载自：<a href="https://www.cnblogs.com/noah-luo/p/13345211.html" target="_blank" rel="noopener">https://www.cnblogs.com/noah-luo/p/13345211.html</a></p>
<pre><code></code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/26/k8s/6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhangpengjie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/zpj.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zpj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/26/k8s/6/" itemprop="url">K8S(04)核心插件-coredns服务</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-26T15:56:56+08:00">
                2020-12-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index">
                    <span itemprop="name">k8s</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/12/26/k8s/6/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/12/26/k8s/6/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<h1 id="K8S核心插件-coredns服务"><a href="#K8S核心插件-coredns服务" class="headerlink" title="K8S核心插件-coredns服务"></a>K8S核心插件-coredns服务</h1><p>目录</p>
<ul>
<li><p>K8S核心插件-coredns服务</p>
</li>
<li><ul>
<li>1 coredns用途</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>1.1 为什么需要服务发现</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li>2 coredns的部署</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>2.1 获取coredns的docker镜像</li>
<li>2.2 创建coredns的资源配置清单</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>2.2.1 rbac集群权限清单</li>
<li>2.2.2 configmap配置清单</li>
<li>2.2.3 depoly控制器清单</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>2.2.4 service资源清单</li>
<li>2.3 创建资源并验证</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>2.3.1 验证服务能够访问`</li>
<li>2.3.2 创建资源:</li>
<li>2.3.3. 查看创建情况:</li>
<li>2.3.4 使用dig测试解析</li>
<li>2.3.5 创建一个service资源来验证</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="1-coredns用途"><a href="#1-coredns用途" class="headerlink" title="1 coredns用途"></a>1 coredns用途</h2><p><a href="https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/dns/coredns/coredns.yaml.base" target="_blank" rel="noopener">coredns github地址</a></p>
<p>coredns都做了什么：<a href="http://ccnuo.com/2019/08/25/CoreDNS：Kubernetes内部域名解析原理、弊端及优化方式/" target="_blank" rel="noopener">Kubernetes内部域名解析原理、弊端及优化方式</a></p>
<p>coredns在K8S中的用途,主要是用作服务发现，也就是服务(应用)之间相互定位的过程。</p>
<h3 id="1-1-为什么需要服务发现"><a href="#1-1-为什么需要服务发现" class="headerlink" title="1.1 为什么需要服务发现"></a>1.1 为什么需要服务发现</h3><p><strong>在K8S集群中，POD有以下特性：</strong></p>
<ol>
<li>服务动态性强<br>容器在k8s中迁移会导致POD的IP地址变化</li>
<li>更新发布频繁<br>版本迭代快，新旧POD的IP地址会不同</li>
<li>支持自动伸缩<br>大促或流量高峰需要动态伸缩，IP地址会动态增减</li>
</ol>
<p><strong>service资源解决POD服务发现：</strong></p>
<p>为了解决pod地址变化的问题，需要部署service资源，用service资源代理后端pod，通过暴露service资源的固定地址(集群IP)，来解决以上POD资源变化产生的IP变动问题</p>
<p><strong>那service资源的服务发现呢？</strong></p>
<p>service资源提供了一个不变的集群IP供外部访问，但</p>
<ol>
<li>IP地址毕竟难以记忆</li>
<li>service资源可能也会被销毁和创建</li>
<li>能不能将service资源名称和service暴露的集群网络IP对于</li>
<li>类似域名与IP关系，则只需记服务名就能自动匹配服务IP</li>
<li>岂不就达到了service服务的自动发现</li>
</ol>
<p><strong>在k8s中，coredns就是为了解决以上问题。</strong></p>
<h2 id="2-coredns的部署"><a href="#2-coredns的部署" class="headerlink" title="2 coredns的部署"></a>2 coredns的部署</h2><p>从coredns开始，我们使用声明式向k8s中交付容器的方式，来部署服务</p>
<h3 id="2-1-获取coredns的docker镜像"><a href="#2-1-获取coredns的docker镜像" class="headerlink" title="2.1 获取coredns的docker镜像"></a>2.1 获取coredns的docker镜像</h3><p>以下操作可以在任意节点上完成,推荐在<code>7.200</code>上做,因为接下来制作coredns的k8s配置清单也是在运维主机<code>7.200</code>上创建后,再到node节点上应用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker.io&#x2F;coredns&#x2F;coredns:1.6.1</span><br><span class="line">docker tag coredns:1.6.1 harbor.zq.com&#x2F;public&#x2F;coredns:v1.6.1</span><br><span class="line">docker push harbor.zq.com&#x2F;public&#x2F;coredns:v1.6.1</span><br></pre></td></tr></table></figure>

<h3 id="2-2-创建coredns的资源配置清单"><a href="#2-2-创建coredns的资源配置清单" class="headerlink" title="2.2 创建coredns的资源配置清单"></a>2.2 创建coredns的资源配置清单</h3><p>以下资源配置清单,都是参考官网改出来的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;data&#x2F;k8s-yaml&#x2F;coredns</span><br></pre></td></tr></table></figure>

<h4 id="2-2-1-rbac集群权限清单"><a href="#2-2-1-rbac集群权限清单" class="headerlink" title="2.2.1 rbac集群权限清单"></a>2.2.1 rbac集群权限清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;data&#x2F;k8s-yaml&#x2F;coredns&#x2F;rbac.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">      kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">      addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io&#x2F;bootstrapping: rbac-defaults</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">  name: system:coredns</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - endpoints</span><br><span class="line">  - services</span><br><span class="line">  - pods</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io&#x2F;autoupdate: &quot;true&quot;</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io&#x2F;bootstrapping: rbac-defaults</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: EnsureExists</span><br><span class="line">  name: system:coredns</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:coredns</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="2-2-2-configmap配置清单"><a href="#2-2-2-configmap配置清单" class="headerlink" title="2.2.2 configmap配置清单"></a>2.2.2 configmap配置清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;data&#x2F;k8s-yaml&#x2F;coredns&#x2F;cm.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:</span><br><span class="line">  Corefile: |</span><br><span class="line">    .:53 &#123;</span><br><span class="line">        errors</span><br><span class="line">        log</span><br><span class="line">        health</span><br><span class="line">        ready</span><br><span class="line">        kubernetes cluster.local 192.168.0.0&#x2F;16  #service资源cluster地址</span><br><span class="line">        forward . 10.4.7.11   #上级DNS地址</span><br><span class="line">        cache 30</span><br><span class="line">        loop</span><br><span class="line">        reload</span><br><span class="line">        loadbalance</span><br><span class="line">       &#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="2-2-3-depoly控制器清单"><a href="#2-2-3-depoly控制器清单" class="headerlink" title="2.2.3 depoly控制器清单"></a>2.2.3 depoly控制器清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;data&#x2F;k8s-yaml&#x2F;coredns&#x2F;dp.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: coredns</span><br><span class="line">    kubernetes.io&#x2F;name: &quot;CoreDNS&quot;</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: coredns</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: coredns</span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      serviceAccountName: coredns</span><br><span class="line">      containers:</span><br><span class="line">      - name: coredns</span><br><span class="line">        image: harbor.zq.com&#x2F;public&#x2F;coredns:v1.6.1</span><br><span class="line">        args:</span><br><span class="line">        - -conf</span><br><span class="line">        - &#x2F;etc&#x2F;coredns&#x2F;Corefile</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: config-volume</span><br><span class="line">          mountPath: &#x2F;etc&#x2F;coredns</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns</span><br><span class="line">          protocol: UDP</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns-tcp</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 9153</span><br><span class="line">          name: metrics</span><br><span class="line">          protocol: TCP</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;health</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">      dnsPolicy: Default</span><br><span class="line">      volumes:</span><br><span class="line">        - name: config-volume</span><br><span class="line">          configMap:</span><br><span class="line">            name: coredns</span><br><span class="line">            items:</span><br><span class="line">            - key: Corefile</span><br><span class="line">              path: Corefile</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="2-2-4-service资源清单"><a href="#2-2-4-service资源清单" class="headerlink" title="2.2.4 service资源清单"></a>2.2.4 service资源清单</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;data&#x2F;k8s-yaml&#x2F;coredns&#x2F;svc.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: coredns</span><br><span class="line">    kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">    kubernetes.io&#x2F;name: &quot;CoreDNS&quot;</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: coredns</span><br><span class="line">  clusterIP: 192.168.0.2</span><br><span class="line">  ports:</span><br><span class="line">  - name: dns</span><br><span class="line">    port: 53</span><br><span class="line">    protocol: UDP</span><br><span class="line">  - name: dns-tcp</span><br><span class="line">    port: 53</span><br><span class="line">  - name: metrics</span><br><span class="line">    port: 9153</span><br><span class="line">    protocol: TCP</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="2-3-创建资源并验证"><a href="#2-3-创建资源并验证" class="headerlink" title="2.3 创建资源并验证"></a>2.3 创建资源并验证</h3><p>在任意NODE节点执行配置都可以,先</p>
<h4 id="2-3-1-验证服务能够访问"><a href="#2-3-1-验证服务能够访问" class="headerlink" title="2.3.1 验证服务能够访问`"></a>2.3.1 验证服务能够访问`</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# dig -t A harbor.zq.com  +short</span><br><span class="line">10.4.7.200</span><br></pre></td></tr></table></figure>

<h4 id="2-3-2-创建资源"><a href="#2-3-2-创建资源" class="headerlink" title="2.3.2 创建资源:"></a>2.3.2 创建资源:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;coredns&#x2F;rbac.yaml</span><br><span class="line">kubectl create -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;coredns&#x2F;cm.yaml</span><br><span class="line">kubectl create -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;coredns&#x2F;dp.yaml</span><br><span class="line">kubectl create -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;coredns&#x2F;svc.yaml</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601203926151-64275fd4-1e6c-44dd-af62-ad614d3e775e.png" alt="image"></p>
<h4 id="2-3-3-查看创建情况"><a href="#2-3-3-查看创建情况" class="headerlink" title="2.3.3. 查看创建情况:"></a>2.3.3. 查看创建情况:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get all -n kube-system</span><br><span class="line">kubectl get svc -o wide -n kube-system</span><br><span class="line">dig -t A www.baidu.com @192.168.0.2 +short</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601203926177-82a3ab1f-8c4b-4442-9eeb-bf18c91a2ffd.png" alt="image"></p>
<h4 id="2-3-4-使用dig测试解析"><a href="#2-3-4-使用dig测试解析" class="headerlink" title="2.3.4 使用dig测试解析"></a>2.3.4 使用dig测试解析</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# dig -t A www.baidu.com @192.168.0.2 +short</span><br><span class="line">www.a.shifen.com.</span><br><span class="line">39.156.66.18</span><br><span class="line">39.156.66.14</span><br><span class="line">[root@hdss7-21 ~]# dig -t A harbor.zq.com @192.168.0.2 +short</span><br><span class="line">10.4.7.200</span><br></pre></td></tr></table></figure>

<p>coredns已经能解析外网域名了,因为coredns的配置中,写了他的上级DNS为<code>10.4.7.11</code>,如果它自己解析不出来域名,会通过递归查询一级级查找</p>
<p>但coredns我们不是用来做外网解析的,而是用来做service名和serviceIP的解析</p>
<h4 id="2-3-5-创建一个service资源来验证"><a href="#2-3-5-创建一个service资源来验证" class="headerlink" title="2.3.5 创建一个service资源来验证"></a>2.3.5 创建一个service资源来验证</h4><p>先查看<code>kube-public</code>名称空间有没有pod</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~]#  kubectl get pod  -n kube-public</span><br><span class="line">No resources found.</span><br><span class="line"># 之前我调试问题已经清理了所有的POD,所以没有</span><br></pre></td></tr></table></figure>

<p>如果没有则先创建pod</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl create deployment nginx-dp --image&#x3D;harbor.zq.com&#x2F;public&#x2F;nginx:v1.17.9 -n kube-public</span><br><span class="line">~]# kubectl get deployments -n kube-public </span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-dp   1&#x2F;1     1            1           35s</span><br><span class="line">~]#  kubectl get pod  -n kube-public</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-dp-568f8dc55-rxvx2   1&#x2F;1     Running   0          56s</span><br></pre></td></tr></table></figure>

<p>给pod创建一个service</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose deployment nginx-dp --port&#x3D;80 -n kube-public</span><br><span class="line">~]# kubectl -n kube-public get service</span><br><span class="line">NAME       TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">nginx-dp   ClusterIP   192.168.63.255   &lt;none&gt;        80&#x2F;TCP    11s</span><br></pre></td></tr></table></figure>

<p>验证是否可以解析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~]# dig -t A nginx-dp @192.168.0.2 +short</span><br><span class="line"># 发现无返回数据,难道解析不了</span><br><span class="line"># 其实是需要完整域名:服务名.名称空间.svc.cluster.local.</span><br><span class="line">~]# dig -t A nginx-dp.kube-public.svc.cluster.local. @192.168.0.2 +short</span><br><span class="line">192.168.63.255</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以看到我们没有手动添加任何解析记录，我们nginx-dp的service资源的IP，已经被解析了：</p>
</blockquote>
<p>进入到pod内部再次验证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~]# kubectl -n kube-public exec -it nginx-dp-568f8dc55-rxvx2 &#x2F;bin&#x2F;bash</span><br><span class="line">-qjwmz:&#x2F;# apt update &amp;&amp; apt install curl</span><br><span class="line">-qjwmz:&#x2F;# ping nginx-dp</span><br><span class="line">PING nginx-dp.kube-public.svc.cluster.local (192.168.191.232): 56 data bytes</span><br><span class="line">64 bytes from 192.168.191.232: icmp_seq&#x3D;0 ttl&#x3D;64 time&#x3D;0.184 ms</span><br><span class="line">64 bytes from 192.168.191.232: icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;0.225 ms</span><br></pre></td></tr></table></figure>

<p>为什么在容器中不用加全域名?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-qjwmz:&#x2F;# cat &#x2F;etc&#x2F;resolv.conf </span><br><span class="line">nameserver 192.168.0.2</span><br><span class="line">search kube-public.svc.cluster.local svc.cluster.local cluster.local host.com</span><br><span class="line">options ndots:5</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当我进入到pod内部以后，会发现我们的dns地址是我们的coredns地址，以及搜索域中已经添加了搜索域:<code>kube-public.svc.cluster.local</code></p>
</blockquote>
<p>我们解决了在集群内部解析的问题，要想在集群外部访问我们的服务还需要<code>igerss</code>服务暴露功能</p>
<p>现在，我们已经解决了在集群内部解析的问题，但是我们怎么做到在集群外部访问我们的服务呢？</p>
<p>转载自cnblog:<a href="https://www.cnblogs.com/noah-luo/p/13345194.html" target="_blank" rel="noopener">https://www.cnblogs.com/noah-luo/p/13345194.html</a></p>
<pre><code></code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/23/k8s/5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhangpengjie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/zpj.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zpj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/23/k8s/5/" itemprop="url">K8S(03)核心插件-Flannel网络插件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-23T16:59:08+08:00">
                2020-12-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index">
                    <span itemprop="name">k8s</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/12/23/k8s/5/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/12/23/k8s/5/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本系列文章,可以基本算是 老男孩2019年王硕的K8S周末班课程 笔记,根据视频来看本笔记最好,否则有些地方会看不明白</p>
<h1 id="K8S核心网络插件Flannel"><a href="#K8S核心网络插件Flannel" class="headerlink" title="K8S核心网络插件Flannel"></a>K8S核心网络插件Flannel</h1><p>目录</p>
<ul>
<li><p>系列文章说明</p>
</li>
<li><p>K8S核心网络插件Flannel</p>
</li>
<li><ul>
<li>1 flannel功能概述</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>1.1 flannel运转流程</li>
<li>1.2 flannel的网络模型</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>1.2.1 flannel支持3种网络模型</li>
<li>1.2.2 实际工作中的模型选择</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li>\2. 部署flannel插件</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>2.1 在etcd中写入网络信息</li>
<li>2.2 部署准备</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>2.2.1 下载软件</li>
<li>2.2.2 拷贝证书</li>
<li>2.2.3 配置子网信息</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>2.3 启动flannel服务</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>2.3.1 创建flannel启动脚本</li>
<li>2.3.2 创建supervisor启动脚本</li>
<li>2.3.3 启动flannel服务并验证</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li>3 优化iptables规则</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>3.1 前因后果</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>3.1.1 优化原因说明</li>
<li>3.1.2 问题复现</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>3.2 具体优化过程</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>3.2.1 先查看iptables规则</li>
<li>3.2.2 安装iptables并修改规则</li>
<li>3.2.3 注意docker重启后操作</li>
<li>3.2.4 结果验证</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>k8s虽然设计了网络模型,然后将实现方式交给了CNI网络插件,而CNI网络插件的主要目的,就是实现POD资源能够跨宿主机进行通信</p>
<p>常见的网络插件有<code>flannel</code>,<code>calico</code>,<code>canal</code>,但是最简单的<code>flannel</code>已经完全满足我们的要求,故不在考虑其他网络插件</p>
<p><strong>网络插件Flannel介绍：<a href="https://www.kubernetes.org.cn/3682.html" target="_blank" rel="noopener">https://www.kubernetes.org.cn/3682.html</a></strong></p>
<h2 id="1-flannel功能概述"><a href="#1-flannel功能概述" class="headerlink" title="1 flannel功能概述"></a>1 flannel功能概述</h2><h3 id="1-1-flannel运转流程"><a href="#1-1-flannel运转流程" class="headerlink" title="1.1 flannel运转流程"></a>1.1 flannel运转流程</h3><ol>
<li>首先<br>flannel利用Kubernetes API或者etcd用于存储整个集群的网络配置，其中最主要的内容为设置集群的网络地址空间。<br>例如，设定整个集群内所有容器的IP都取自网段“10.1.0.0/16”。</li>
<li>接着<br>flannel在每个主机中运行flanneld作为agent，它会为所在主机从集群的网络地址空间中，获取一个小的网段subnet，本主机内所有容器的IP地址都将从中分配。<br>例如，设定本主机内所有容器的IP地址网段“10.1.2.0/24”。</li>
<li>然后<br>flanneld再将本主机获取的subnet以及用于主机间通信的Public IP，同样通过kubernetes API或者etcd存储起来。</li>
<li>最后<br>flannel利用各种backend mechanism，例如udp，vxlan等等，跨主机转发容器间的网络流量，完成容器间的跨主机通信。</li>
</ol>
<h3 id="1-2-flannel的网络模型"><a href="#1-2-flannel的网络模型" class="headerlink" title="1.2 flannel的网络模型"></a>1.2 flannel的网络模型</h3><h4 id="1-2-1-flannel支持3种网络模型"><a href="#1-2-1-flannel支持3种网络模型" class="headerlink" title="1.2.1 flannel支持3种网络模型"></a>1.2.1 flannel支持3种网络模型</h4><ol>
<li><code>host-gw</code>网关模型</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;Network&quot;: &quot;xxx&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;host-gw&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>主要用于宿主机在同网段的情况下POD间的通信,即不跨网段通信.<br>此时flannel的功能很简单,就是在每个宿主机上创建了一条通网其他宿主机的网关路由<br>完全没有性能损耗,效率极高</li>
<li>vxlan隧道模型</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;Network&quot;: &quot;xxx&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;vxlan&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>主要用于宿主机不在同网段的情况下POD间通信,即跨网段通信.<br>此时flannel会在宿主机上创建一个<code>flannel.1</code>的虚拟网卡,用于和其他宿主机间建立VXLAN隧道<br>跨宿主机通信时,需要经由<code>flannel.1</code>设备封包、解包，因此效率不高</li>
<li>混合模型</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;Network&quot;: &quot;xxx&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;vxlan&quot;,&quot;Directrouting&quot;: true&#125;&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>在既有同网段宿主机，又有跨网段宿主机的情况下，选择混合模式<br>flannel会根据通信双方的网段情况，自动选择是走网关路由通信还是通过VXLAN隧道通信</li>
</ol>
<h4 id="1-2-2-实际工作中的模型选择"><a href="#1-2-2-实际工作中的模型选择" class="headerlink" title="1.2.2 实际工作中的模型选择"></a>1.2.2 实际工作中的模型选择</h4><p>很多人不推荐部署K8S的使用的flannel做网络插件,不推荐的原因是是flannel性能不高,然而</p>
<ol>
<li>flannel性能不高是指它的VXLAN隧道模型,而不是gw模型</li>
<li>规划K8S集群的时候,应规划多个K8S集群来管理不同的业务</li>
<li>同一个K8S集群的宿主机,就应该规划到同一个网段</li>
<li>既然是同一个网段的宿主机通信,使用的就应该是gw模型</li>
<li>gw模型只是创建了网关路由,通信效率极高</li>
<li>因此,建议工作中使用flannel,且用<code>gw</code>模型</li>
</ol>
<h2 id="2-部署flannel插件"><a href="#2-部署flannel插件" class="headerlink" title="2. 部署flannel插件"></a>2. 部署flannel插件</h2><h3 id="2-1-在etcd中写入网络信息"><a href="#2-1-在etcd中写入网络信息" class="headerlink" title="2.1 在etcd中写入网络信息"></a>2.1 在etcd中写入网络信息</h3><p>以下操作在任意etcd节点中执行都可以</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;etcd&#x2F;etcdctl set &#x2F;coreos.com&#x2F;network&#x2F;config &#39;&#123;&quot;Network&quot;: &quot;172.7.0.0&#x2F;16&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;host-gw&quot;&#125;&#125;&#39;</span><br><span class="line"># 查看结果</span><br><span class="line">[root@hdss7-12 ~]# &#x2F;opt&#x2F;etcd&#x2F;etcdctl get &#x2F;coreos.com&#x2F;network&#x2F;config</span><br><span class="line">&#123;&quot;Network&quot;: &quot;172.7.0.0&#x2F;16&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;host-gw&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-部署准备"><a href="#2-2-部署准备" class="headerlink" title="2.2 部署准备"></a>2.2 部署准备</h3><h4 id="2-2-1-下载软件"><a href="#2-2-1-下载软件" class="headerlink" title="2.2.1 下载软件"></a>2.2.1 下载软件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;coreos&#x2F;flannel&#x2F;releases&#x2F;download&#x2F;v0.11.0&#x2F;flannel-v0.11.0-linux-amd64.tar.gz</span><br><span class="line">mkdir &#x2F;opt&#x2F;flannel-v0.11.0</span><br><span class="line">tar xf flannel-v0.11.0-linux-amd64.tar.gz -C &#x2F;opt&#x2F;flannel-v0.11.0&#x2F;</span><br><span class="line">ln -s &#x2F;opt&#x2F;flannel-v0.11.0&#x2F; &#x2F;opt&#x2F;flannel</span><br></pre></td></tr></table></figure>

<h4 id="2-2-2-拷贝证书"><a href="#2-2-2-拷贝证书" class="headerlink" title="2.2.2 拷贝证书"></a>2.2.2 拷贝证书</h4><p>因为要和apiserver通信，所以要配置client证书,当然ca公钥自不必说</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;flannel</span><br><span class="line">mkdir cert</span><br><span class="line">scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;ca.pem         cert&#x2F; </span><br><span class="line">scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;client.pem     cert&#x2F; </span><br><span class="line">scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;client-key.pem cert&#x2F;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-3-配置子网信息"><a href="#2-2-3-配置子网信息" class="headerlink" title="2.2.3 配置子网信息"></a>2.2.3 配置子网信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;opt&#x2F;flannel&#x2F;subnet.env &lt;&lt;EOF</span><br><span class="line">FLANNEL_NETWORK&#x3D;172.7.0.0&#x2F;16</span><br><span class="line">FLANNEL_SUBNET&#x3D;172.7.21.1&#x2F;24</span><br><span class="line">FLANNEL_MTU&#x3D;1500</span><br><span class="line">FLANNEL_IPMASQ&#x3D;false</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意:subnet子网网段信息,每个宿主机都要修改</p>
</blockquote>
<h3 id="2-3-启动flannel服务"><a href="#2-3-启动flannel服务" class="headerlink" title="2.3 启动flannel服务"></a>2.3 启动flannel服务</h3><h4 id="2-3-1-创建flannel启动脚本"><a href="#2-3-1-创建flannel启动脚本" class="headerlink" title="2.3.1 创建flannel启动脚本"></a>2.3.1 创建flannel启动脚本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;opt&#x2F;flannel&#x2F;flanneld.sh &lt;&lt;&#39;EOF&#39;</span><br><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">.&#x2F;flanneld \</span><br><span class="line">  --public-ip&#x3D;10.4.7.21 \</span><br><span class="line">  --etcd-endpoints&#x3D;https:&#x2F;&#x2F;10.4.7.12:2379,https:&#x2F;&#x2F;10.4.7.21:2379,https:&#x2F;&#x2F;10.4.7.22:2379 \</span><br><span class="line">  --etcd-keyfile&#x3D;.&#x2F;cert&#x2F;client-key.pem \</span><br><span class="line">  --etcd-certfile&#x3D;.&#x2F;cert&#x2F;client.pem \</span><br><span class="line">  --etcd-cafile&#x3D;.&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">  --iface&#x3D;eth0 \</span><br><span class="line">  --subnet-file&#x3D;.&#x2F;subnet.env \</span><br><span class="line">  --healthz-port&#x3D;2401</span><br><span class="line">EOF</span><br><span class="line"># 授权</span><br><span class="line">chmod u+x flanneld.sh</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意:</p>
<p>public-ip为节点IP,注意按需修改</p>
<p>iface为网卡,若本机网卡不是eth0,注意修改</p>
</blockquote>
<h4 id="2-3-2-创建supervisor启动脚本"><a href="#2-3-2-创建supervisor启动脚本" class="headerlink" title="2.3.2 创建supervisor启动脚本"></a>2.3.2 创建supervisor启动脚本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;etc&#x2F;supervisord.d&#x2F;flannel.ini &lt;&lt;EOF</span><br><span class="line">[program:flanneld]</span><br><span class="line">command&#x3D;sh &#x2F;opt&#x2F;flannel&#x2F;flanneld.sh</span><br><span class="line">numprocs&#x3D;1</span><br><span class="line">directory&#x3D;&#x2F;opt&#x2F;flannel</span><br><span class="line">autostart&#x3D;true</span><br><span class="line">autorestart&#x3D;true</span><br><span class="line">startsecs&#x3D;30</span><br><span class="line">startretries&#x3D;3</span><br><span class="line">exitcodes&#x3D;0,2</span><br><span class="line">stopsignal&#x3D;QUIT</span><br><span class="line">stopwaitsecs&#x3D;10</span><br><span class="line">user&#x3D;root</span><br><span class="line">redirect_stderr&#x3D;true</span><br><span class="line">stdout_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;flanneld&#x2F;flanneld.stdout.log</span><br><span class="line">stdout_logfile_maxbytes&#x3D;64MB</span><br><span class="line">stdout_logfile_backups&#x3D;4</span><br><span class="line">stdout_capture_maxbytes&#x3D;1MB</span><br><span class="line">;子进程还有子进程,需要添加这个参数,避免产生孤儿进程</span><br><span class="line">killasgroup&#x3D;true</span><br><span class="line">stopasgroup&#x3D;true</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<p>supervisor的各项配置不再备注,有需要的看K8S二进制安装中的备注</p>
</blockquote>
<h4 id="2-3-3-启动flannel服务并验证"><a href="#2-3-3-启动flannel服务并验证" class="headerlink" title="2.3.3 启动flannel服务并验证"></a>2.3.3 启动flannel服务并验证</h4><p><strong>启动服务</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;data&#x2F;logs&#x2F;flanneld</span><br><span class="line">supervisorctl update</span><br><span class="line">supervisorctl status</span><br></pre></td></tr></table></figure>

<p><strong>验证路由</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-22 ~]# route -n|egrep -i &#39;172.7|des&#39;</span><br><span class="line">Destination   Gateway     Genmask         Flags Metric Ref   Use Iface</span><br><span class="line">172.7.21.0    10.4.7.21   255.255.255.0   UG    0      0       0 eth0</span><br><span class="line">172.7.22.0    0.0.0.0     255.255.255.0   U     0      0       0 docker0</span><br><span class="line">[root@hdss7-21 ~]# route -n|egrep -i &#39;172.7|des&#39;</span><br><span class="line">Destination   Gateway     Genmask         Flags Metric Ref   Use Iface</span><br><span class="line">172.7.21.0    0.0.0.0     255.255.255.0   U     0      0       0 docker0</span><br><span class="line">172.7.22.0    10.4.7.22   255.255.255.0   UG    0      0       0 eth0</span><br></pre></td></tr></table></figure>

<p><strong>验证通信结果</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# ping 172.7.22.2</span><br><span class="line">PING 172.7.22.2 (172.7.22.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.7.22.2: icmp_seq&#x3D;1 ttl&#x3D;63 time&#x3D;0.538 ms</span><br><span class="line">64 bytes from 172.7.22.2: icmp_seq&#x3D;2 ttl&#x3D;63 time&#x3D;0.896 ms</span><br><span class="line">[root@hdss7-22 ~]# ping 172.7.21.2</span><br><span class="line">PING 172.7.21.2 (172.7.21.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.7.21.2: icmp_seq&#x3D;1 ttl&#x3D;63 time&#x3D;0.805 ms</span><br><span class="line">64 bytes from 172.7.21.2: icmp_seq&#x3D;2 ttl&#x3D;63 time&#x3D;1.14 ms</span><br></pre></td></tr></table></figure>

<h2 id="3-优化iptables规则"><a href="#3-优化iptables规则" class="headerlink" title="3 优化iptables规则"></a>3 优化iptables规则</h2><h3 id="3-1-前因后果"><a href="#3-1-前因后果" class="headerlink" title="3.1 前因后果"></a>3.1 前因后果</h3><h4 id="3-1-1-优化原因说明"><a href="#3-1-1-优化原因说明" class="headerlink" title="3.1.1 优化原因说明"></a>3.1.1 优化原因说明</h4><p>我们使用的是<code>gw</code>网络模型,而这个网络模型只是创建了一条到其他宿主机下POD网络的路由信息.</p>
<p><strong>因而我们可以猜想:</strong></p>
<ol>
<li>从外网访问到B宿主机中的POD,源IP应该是外网IP</li>
<li>从A宿主机访问B宿主机中的POD,源IP应该是A宿主机的IP</li>
<li>从A的POD-A01中,访问B中的POD,源IP应该是POD-A01的容器IP<br>此情形可以想象是一个路由器下的2个不同网段的交换机下的设备通过路由器(gw)通信</li>
</ol>
<p><strong>然后遗憾的是:</strong></p>
<ul>
<li>前两条毫无疑问成立</li>
<li>第3条理应成立,但实际不成立</li>
</ul>
<p><strong>不成立的原因是:</strong></p>
<ol>
<li>Docker容器的跨网络隔离与通信，借助了iptables的机制</li>
<li>因此虽然K8S我们使用了ipvs调度,但是宿主机上还是有iptalbes规则</li>
<li>而docker默认生成的iptables规则为：<br>若数据出网前，先判断出网设备是不是本机<code>docker0</code>设备(容器网络)<br>如果不是的话，则进行SNAT转换后再出网，具体规则如下</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# iptables-save |grep -i postrouting|grep docker0</span><br><span class="line">-A POSTROUTING -s 172.7.21.0&#x2F;24 ! -o docker0 -j MASQUERADE</span><br></pre></td></tr></table></figure>

<ol>
<li>由于<code>gw</code>模式产生的数据,是从<code>eth0</code>流出,因而不在此规则过滤范围内</li>
<li>就导致此跨宿主机之间的POD通信,使用了该条SNAT规则</li>
</ol>
<p><strong>解决办法是:</strong></p>
<ul>
<li>修改此IPTABLES规则,增加过滤目标:<strong>过滤目的地是宿主机网段的流量</strong></li>
</ul>
<h4 id="3-1-2-问题复现"><a href="#3-1-2-问题复现" class="headerlink" title="3.1.2 问题复现"></a>3.1.2 问题复现</h4><ol>
<li>在<code>7-21</code>宿主机中,访问<code>172.7.22.2</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl 172.7.22.2</span><br></pre></td></tr></table></figure>

<ol>
<li>在<code>7-21</code>宿主机启动busybox容器,进入并访问<code>172.7.22.2</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull busybox</span><br><span class="line">docker run --rm -it busybox bash</span><br><span class="line">&#x2F; # wget 172.7.22.2</span><br></pre></td></tr></table></figure>

<ol>
<li>查看<code>7-22</code>宿主机上启动的nginx容器日志</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-22 ~]# kubectl logs nginx-ds-j777c --tail&#x3D;2</span><br><span class="line">10.4.7.21 - - [xxx] &quot;GET &#x2F; HTTP&#x2F;1.1&quot; 200 612 &quot;-&quot; &quot;curl&#x2F;7.29.0&quot; &quot;-&quot;</span><br><span class="line">10.4.7.21 - - [xxx] &quot;GET &#x2F; HTTP&#x2F;1.1&quot; 200 612 &quot;-&quot; &quot;Wget&quot; &quot;-&quot;</span><br></pre></td></tr></table></figure>

<ol>
<li>第一条日志为对端宿主机访问日志<br>第二条日志为对端容器访问日志<br>可以看出源IP都是宿主机的IP</li>
</ol>
<h3 id="3-2-具体优化过程"><a href="#3-2-具体优化过程" class="headerlink" title="3.2 具体优化过程"></a>3.2 具体优化过程</h3><h4 id="3-2-1-先查看iptables规则"><a href="#3-2-1-先查看iptables规则" class="headerlink" title="3.2.1 先查看iptables规则"></a>3.2.1 先查看iptables规则</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# iptables-save |grep -i postrouting|grep docker0</span><br><span class="line">-A POSTROUTING -s 172.7.21.0&#x2F;24 ! -o docker0 -j MASQUERADE</span><br></pre></td></tr></table></figure>

<h4 id="3-2-2-安装iptables并修改规则"><a href="#3-2-2-安装iptables并修改规则" class="headerlink" title="3.2.2 安装iptables并修改规则"></a>3.2.2 安装iptables并修改规则</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install iptables-services -y</span><br><span class="line">iptables -t nat -D POSTROUTING -s 172.7.21.0&#x2F;24 ! -o docker0 -j MASQUERADE</span><br><span class="line">iptables -t nat -I POSTROUTING -s 172.7.21.0&#x2F;24 ! -d 172.7.0.0&#x2F;16 ! -o docker0  -j MASQUERADE</span><br><span class="line"># 验证规则并保存配置</span><br><span class="line">[root@hdss7-21 ~]# iptables-save |grep -i postrouting|grep docker0</span><br><span class="line">-A POSTROUTING -s 172.7.21.0&#x2F;24 ! -d 172.7.0.0&#x2F;16 ! -o docker0 -j MASQUERADE</span><br><span class="line">[root@hdss7-21 ~]# iptables-save &gt; &#x2F;etc&#x2F;sysconfig&#x2F;iptables</span><br></pre></td></tr></table></figure>

<h4 id="3-2-3-注意docker重启后操作"><a href="#3-2-3-注意docker重启后操作" class="headerlink" title="3.2.3 注意docker重启后操作"></a>3.2.3 注意docker重启后操作</h4><p>docker服务重启后,会再次增加该规则,要注意在每次重启docker服务后,删除该规则</p>
<p>验证:</p>
<p>修改后会影响到docker原本的iptables链的规则，所以需要重启docker服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# systemctl restart docker</span><br><span class="line">[root@hdss7-21 ~]# iptables-save |grep -i postrouting|grep docker0</span><br><span class="line">-A POSTROUTING -s 172.7.21.0&#x2F;24 ! -o docker0 -j MASQUERADE</span><br><span class="line">-A POSTROUTING -s 172.7.21.0&#x2F;24 ! -d 172.7.0.0&#x2F;16 ! -o docker0 -j MASQUERADE</span><br><span class="line"># 可以用iptables-restore重新应用iptables规则,也可以直接再删</span><br><span class="line">[root@hdss7-21 ~]# iptables-restore &#x2F;etc&#x2F;sysconfig&#x2F;iptables</span><br><span class="line">[root@hdss7-21 ~]# iptables-save |grep -i postrouting|grep docker0</span><br><span class="line">-A POSTROUTING -s 172.7.21.0&#x2F;24 ! -d 172.7.0.0&#x2F;16 ! -o docker0 -j MASQUERADE</span><br></pre></td></tr></table></figure>

<h4 id="3-2-4-结果验证"><a href="#3-2-4-结果验证" class="headerlink" title="3.2.4 结果验证"></a>3.2.4 结果验证</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 对端启动容器并访问</span><br><span class="line">[root@hdss7-21 ~]# docker run --rm -it busybox  sh</span><br><span class="line">&#x2F; # wget 172.7.22.2</span><br><span class="line"># 本端验证日志</span><br><span class="line">[root@hdss7-22 ~]# kubectl logs nginx-ds-j777c --tail&#x3D;1</span><br><span class="line">172.7.21.3 - - [xxxx] &quot;GET &#x2F; HTTP&#x2F;1.1&quot; 200 612 &quot;-&quot; &quot;Wget&quot; &quot;-&quot;</span><br></pre></td></tr></table></figure>

<p>转载自cnblog:<a href="https://www.cnblogs.com/noah-luo/p/13345177.html" target="_blank" rel="noopener">https://www.cnblogs.com/noah-luo/p/13345177.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/23/k8s/4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhangpengjie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/zpj.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zpj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/23/k8s/4/" itemprop="url">K8S(02)管理核心资源的三种基本方法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-23T16:58:48+08:00">
                2020-12-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index">
                    <span itemprop="name">k8s</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/12/23/k8s/4/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/12/23/k8s/4/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>系列文章说明</p>
<p>本系列文章,可以基本算是 老男孩2019年王硕的K8S周末班课程 笔记,根据视频来看本笔记最好,否则有些地方会看不明白</p>
<h1 id="管理k8s核心资源的三种基本方法："><a href="#管理k8s核心资源的三种基本方法：" class="headerlink" title="管理k8s核心资源的三种基本方法："></a>管理k8s核心资源的三种基本方法：</h1><p>目录</p>
<ul>
<li><p>系列文章说明</p>
</li>
<li><p>管理k8s核心资源的三种基本方法：</p>
</li>
<li><ul>
<li>1 方法分类</li>
<li>2 kubectl命令行工具</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>2.0 增加kubectl自动补全</li>
<li>2.1 get 查</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>2.1.1 查看名称空间namespace</li>
<li>2.1.2 查看namespace中的资源</li>
<li>2.1.3 -o yaml查看资源配置清单详细信息</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>2.2 创建删除名称空间</li>
<li>2.3 管理POD控制器和POD</li>
<li>2.4 service资源管理</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>2.4.1 创建service资源</li>
<li>2.4.2 扩容POD看service怎么调度</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>2.5 explain查看属性的定义和用法</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li>3 统一资源配置清单</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>3.1 语法格式</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>3.1.1 学习方法</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>3.2 初略用法</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>3.2.1 查看已有资源的资源配置清单</li>
<li>3.2.2 创建并应用资源配置清单</li>
<li>3.2.3 修改资源配置清单</li>
<li>3.2.4 删除资源配置清单</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<h2 id="1-方法分类"><a href="#1-方法分类" class="headerlink" title="1 方法分类"></a>1 方法分类</h2></blockquote>
<ol>
<li>陈述式–主要依赖命令行工具<code>kubectl</code>进行管理</li>
</ol>
<ul>
<li><ul>
<li>优点<br>可以满足90%以上的使用场景<br>对资源的增、删、查操作比较容易</li>
<li>缺点<br>命令冗长，复杂，难以记忆<br>特定场景下，无法实现管理需求<br>对资源的修改麻烦，需要patch来使用json串更改。</li>
</ul>
</li>
</ul>
<ol>
<li>声明式-主要依赖统一资源配置清单进行管理</li>
<li>GUI式-主要依赖图形化操作界面进行管理</li>
</ol>
<h2 id="2-kubectl命令行工具"><a href="#2-kubectl命令行工具" class="headerlink" title="2 kubectl命令行工具"></a>2 kubectl命令行工具</h2><p><a href="http://docs.kubernetes.org.cn/683.html" target="_blank" rel="noopener">kubectl中文命令说明</a></p>
<h3 id="2-0-增加kubectl自动补全"><a href="#2-0-增加kubectl自动补全" class="headerlink" title="2.0 增加kubectl自动补全"></a>2.0 增加kubectl自动补全</h3><p>二进制安装的k8s,kubectl工具没有自动补全功能(其他方式安装的未验证),可以使用以下方式开启命令自动补全</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source &lt;(kubectl completion bash)</span><br></pre></td></tr></table></figure>

<h3 id="2-1-get-查"><a href="#2-1-get-查" class="headerlink" title="2.1 get 查"></a>2.1 get 查</h3><h4 id="2-1-1-查看名称空间namespace"><a href="#2-1-1-查看名称空间namespace" class="headerlink" title="2.1.1 查看名称空间namespace"></a>2.1.1 查看名称空间<code>namespace</code></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~]# kubectl get namespaces</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   4d11h</span><br><span class="line">kube-node-lease   Active   4d11h</span><br><span class="line">kube-public       Active   4d11h</span><br><span class="line">kube-system       Active   4d11h</span><br><span class="line"># namespaces可以简写为ns</span><br><span class="line">kubectl get ns</span><br><span class="line"># 但不是所有资源都可以简写,所以我还是习惯tab补全名</span><br></pre></td></tr></table></figure>

<h4 id="2-1-2-查看namespace中的资源"><a href="#2-1-2-查看namespace中的资源" class="headerlink" title="2.1.2 查看namespace中的资源"></a>2.1.2 查看namespace中的资源</h4><p><strong><code>get all</code>查询所有资源</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get all</span><br><span class="line"># 默认是查询default名称空间的资源,查询其他名称空间,需要加 -n namespaces</span><br><span class="line">kubectl get all -n kube-public</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601203113372-2a84b595-b904-4ae8-84c5-8e22cc7d68d8.png" alt="image"></p>
<blockquote>
<p>一般要养成习惯,<code>get</code>任何资源的时候,都要加上-n参数指定名称空间</p>
</blockquote>
<p><strong><code>get pods</code>查询所有pod</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">podsecuritypolicies.extensions  </span><br><span class="line">~]# kubectl get pods -n default </span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-ds-p66qh   1&#x2F;1     Running   0          2d10h</span><br></pre></td></tr></table></figure>

<p><strong><code>get nodes</code>查询所有node节点</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~]# kubectl get nodes -n default </span><br><span class="line">NAME                STATUS     ROLES         AGE     VERSION</span><br><span class="line">hdss7-21.host.com   Ready      master,node   2d12h   v1.15.5</span><br><span class="line">hdss7-22.host.com   NotReady   &lt;none&gt;        2d12h   v1.15.5</span><br></pre></td></tr></table></figure>

<h4 id="2-1-3-o-yaml查看资源配置清单详细信息"><a href="#2-1-3-o-yaml查看资源配置清单详细信息" class="headerlink" title="2.1.3 -o yaml查看资源配置清单详细信息"></a>2.1.3 <code>-o yaml</code>查看资源配置清单详细信息</h4><p><code>-o yaml</code> 可以查看yaml格式的资源配置清单详情</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 查看POD的清单</span><br><span class="line">~]# kubectl -n kube-public get pod nginx-dp-568f8dc55-jk6nb  -o yaml</span><br><span class="line"># 查看deploy的清单</span><br><span class="line">~]# kubectl -n kube-public get deploy nginx-dp -o yaml</span><br><span class="line"># 查看service的清单</span><br><span class="line">~]# kubectl -n kube-public get service -o yaml -n kube-public</span><br></pre></td></tr></table></figure>

<h3 id="2-2-创建删除名称空间"><a href="#2-2-创建删除名称空间" class="headerlink" title="2.2 创建删除名称空间"></a>2.2 创建删除名称空间</h3><p><strong><code>create namespace</code>创建名称空间</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~]# kubectl create namespace app</span><br><span class="line">namespace&#x2F;app created</span><br><span class="line">~]# kubectl get namespaces </span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">app               Active   16s</span><br><span class="line">default           Active   4d11h</span><br><span class="line">kube-node-lease   Active   4d11h</span><br><span class="line">kube-public       Active   4d11h</span><br><span class="line">kube-system       Active   4d11h</span><br></pre></td></tr></table></figure>

<p><strong><code>delete namespaces</code>删除名称空间</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~]# kubectl delete namespaces app</span><br><span class="line">namespace &quot;app&quot; deleted</span><br><span class="line">~]# kubectl get namespaces </span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   4d11h</span><br><span class="line">kube-node-lease   Active   4d11h</span><br><span class="line">kube-public       Active   4d11h</span><br><span class="line">kube-system       Active   4d11h</span><br></pre></td></tr></table></figure>

<h3 id="2-3-管理POD控制器和POD"><a href="#2-3-管理POD控制器和POD" class="headerlink" title="2.3 管理POD控制器和POD"></a>2.3 管理POD控制器和POD</h3><p>以<strong>deployment</strong>类型的POD控制为例,关于POD控制器类型,请参考官网</p>
<p><strong>创建POD控制器</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl create deployment nginx-dp --image&#x3D;harbor.zq.com&#x2F;public&#x2F;nginx:v1.17.9 -n kube-public</span><br><span class="line">~]# kubectl get deployments -n kube-public </span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-dp   1&#x2F;1     1            1           18s</span><br><span class="line">~]# kubectl get pod  -n kube-public </span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-dp-568f8dc55-9qt4j   1&#x2F;1     Running   0          7m50s</span><br></pre></td></tr></table></figure>

<p><strong><code>-o wide</code>查看扩展信息</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 查看POD控制器信息,比基础信息多出了镜像来源,选择器等</span><br><span class="line">kubectl get deployments -o wide -n kube-public</span><br><span class="line"># 查看POD信息,比基础信息多出了POD的IP地址,节点位置等,</span><br><span class="line">kubectl get pod -o wide -n kube-public</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601203113374-ce95bc70-6c49-4945-ba03-57dd24fca151.png" alt="image"></p>
<p><strong><code>describe</code>查看资源详细信息</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 查看POD控制器详细信息</span><br><span class="line">kubectl describe deployments nginx-dp -n kube-public</span><br><span class="line"># 查看POD详细信息</span><br><span class="line">kubectl describe pod nginx-dp-568f8dc55-9qt4j -n kube-public</span><br></pre></td></tr></table></figure>

<p><strong><code>exec</code>进入某个POD</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-public exec -it  nginx-dp-568f8dc55-9qt4j bash</span><br></pre></td></tr></table></figure>

<blockquote>
<p>用法与docker exec类似</p>
</blockquote>
<p><strong><code>scale</code> 扩容POD</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-public scale deployments nginx-dp --replicas&#x3D;2</span><br></pre></td></tr></table></figure>

<p><strong><code>delete</code>删除POD和POD控制器</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~]# kubectl -n kube-public delete pods nginx-dp-568f8dc55-9qt4j </span><br><span class="line">pod &quot;nginx-dp-568f8dc55-9qt4j&quot; deleted</span><br><span class="line">~]# kubectl -n kube-public get pods</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-dp-568f8dc55-hnrxr   1&#x2F;1     Running   0          13s</span><br><span class="line">~]# kubectl -n kube-public delete deployments nginx-dp </span><br><span class="line">deployment.extensions &quot;nginx-dp&quot; deleted</span><br><span class="line">~]# kubectl -n kube-public get pods</span><br><span class="line">No resources found.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在POD控制器存在的情况下,删除了POD,会由POD控制器再创建出新的POD</p>
<p>删除POD控制器后,对应的POD也会一并删除</p>
</blockquote>
<h3 id="2-4-service资源管理"><a href="#2-4-service资源管理" class="headerlink" title="2.4 service资源管理"></a>2.4 service资源管理</h3><p>从上面的POD删除重建的过程可知,虽然POD会被POD控制器拉起,但是存放的NODE或POD的IP都是不确定的,那怎么对外稳定的提供服务呢</p>
<p>这就需要引入<strong>service</strong>的功能了,它相当于一个反向代理,不管后端POD怎么变化,server提供的服务都不会变化,可以为pod资源提供稳定的接入点</p>
<h4 id="2-4-1-创建service资源"><a href="#2-4-1-创建service资源" class="headerlink" title="2.4.1 创建service资源"></a>2.4.1 创建service资源</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~]# kubectl -n kube-public create deployment nginx-dp --image&#x3D;harbor.zq.com&#x2F;public&#x2F;nginx:v1.17.9</span><br><span class="line">deployment.apps&#x2F;nginx-dp created</span><br><span class="line">~]# kubectl -n kube-public expose deployment nginx-dp --port&#x3D;80 </span><br><span class="line">service&#x2F;nginx-dp exposed</span><br><span class="line">~]# kubectl -n kube-public get service </span><br><span class="line">NAME       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">nginx-dp   ClusterIP   192.168.94.73   &lt;none&gt;        80&#x2F;TCP    45s</span><br></pre></td></tr></table></figure>

<p>可以看到创建了一个VIP<code>192.168.94.73</code>,查看LVS信息,可以看到转发条目</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size&#x3D;4096)</span><br><span class="line">......    </span><br><span class="line">TCP  192.168.94.73:80 nq</span><br><span class="line">  -&gt; 172.7.21.3:80                Masq    1      0          0</span><br></pre></td></tr></table></figure>

<h4 id="2-4-2-扩容POD看service怎么调度"><a href="#2-4-2-扩容POD看service怎么调度" class="headerlink" title="2.4.2 扩容POD看service怎么调度"></a>2.4.2 扩容POD看service怎么调度</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~]# kubectl -n kube-public scale deployment nginx-dp --replicas&#x3D;2</span><br><span class="line">deployment.extensions&#x2F;nginx-dp scaled</span><br><span class="line">~]# ipvsadm -Ln</span><br><span class="line">......</span><br><span class="line">TCP  192.168.94.73:80 nq</span><br><span class="line">  -&gt; 172.7.21.3:80                Masq    1      0          0         </span><br><span class="line">  -&gt; 172.7.22.4:80                Masq    1      0          0</span><br></pre></td></tr></table></figure>

<h3 id="2-5-explain查看属性的定义和用法"><a href="#2-5-explain查看属性的定义和用法" class="headerlink" title="2.5 explain查看属性的定义和用法"></a>2.5 explain查看属性的定义和用法</h3><p>查看service资源下metadata的定义及用法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl explain service.metadata</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601203113388-51e28ce2-a4a4-4bd9-be24-684d9921e6e7.png" alt="image"></p>
<h2 id="3-统一资源配置清单"><a href="#3-统一资源配置清单" class="headerlink" title="3 统一资源配置清单"></a>3 统一资源配置清单</h2><p>统一资源配置清单,就是一个yaml格式的文件,文件中按指定格式定义了所需内容,然后通过命令行工具<code>kubectl</code>应用即可</p>
<h3 id="3-1-语法格式"><a href="#3-1-语法格式" class="headerlink" title="3.1 语法格式"></a>3.1 语法格式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create&#x2F;apply&#x2F;delete -f &#x2F;path_to&#x2F;xxx.yaml</span><br></pre></td></tr></table></figure>

<h4 id="3-1-1-学习方法"><a href="#3-1-1-学习方法" class="headerlink" title="3.1.1 学习方法"></a>3.1.1 学习方法</h4><ol>
<li>忌一来就无中生有自己写,容易把自己憋死</li>
<li>先看官方或别人写的,能读懂即可</li>
<li>别人的读懂了能改改内容即可</li>
<li>遇到不懂的用<code>kubectl explain</code>查帮助</li>
</ol>
<h3 id="3-2-初略用法"><a href="#3-2-初略用法" class="headerlink" title="3.2 初略用法"></a>3.2 初略用法</h3><h4 id="3-2-1-查看已有资源的资源配置清单"><a href="#3-2-1-查看已有资源的资源配置清单" class="headerlink" title="3.2.1 查看已有资源的资源配置清单"></a>3.2.1 查看已有资源的资源配置清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubuctl get svc nginx-dp -o yaml -n kube-pubic</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601203113379-1967bb9e-6796-4e01-82a5-c07e5d7b15fd.png" alt="image"></p>
<blockquote>
<p>必须存在的四个部分为:</p>
<p>apiVersion</p>
<p>kind</p>
<p>metadata</p>
<p>spec</p>
</blockquote>
<p>资源配置清单中有许多项目,如果想查看资源配置清单中某一项的意义或该项下面可以配置的内容,可以使用<code>explain</code>来获取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl explain service.kind</span><br></pre></td></tr></table></figure>

<h4 id="3-2-2-创建并应用资源配置清单"><a href="#3-2-2-创建并应用资源配置清单" class="headerlink" title="3.2.2 创建并应用资源配置清单"></a>3.2.2 创建并应用资源配置清单</h4><p><strong>创建yaml配置文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;nginx-ds-svc.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">  type: ClusterIP</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><strong>应用配置创建资源</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f nginx-ds-svc.yaml</span><br><span class="line"># 或</span><br><span class="line">kubectl apply -f nginx-ds-svc.yaml</span><br><span class="line"># 查看结果</span><br><span class="line">[root@hdss7-21 ~]# kubectl  get -f nginx-ds-svc.yaml </span><br><span class="line">NAME       TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">nginx-ds   ClusterIP   192.168.48.225   &lt;none&gt;        80&#x2F;TCP    24s</span><br></pre></td></tr></table></figure>

<p><strong>create和apply的区别</strong></p>
<p>create命令和apply命令都会根据配置文件创建资源,但是:</p>
<ol>
<li>create命令只会新建,如果资源文件已使用过,则会提示错误</li>
<li>如果资源不存在,apply命令会新建,如果已存在,则会根据配置修改</li>
<li>如果是create命令新建的资源,使用apply修改时会提示</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f nginx-ds-svc.yaml </span><br><span class="line">Warning: kubectl apply should be used on resource created by either kubectl create --save-config or kubectl apply</span><br></pre></td></tr></table></figure>

<ol>
<li>意思是如果要用apply修改,就应该用apply命令创建,或者create创建时加<code>--save-config</code>参数</li>
<li>所以养成使用apply命令的习惯即可</li>
</ol>
<h4 id="3-2-3-修改资源配置清单"><a href="#3-2-3-修改资源配置清单" class="headerlink" title="3.2.3 修改资源配置清单"></a>3.2.3 修改资源配置清单</h4><p><strong>在线修改</strong></p>
<p>使用edit命令,会打开一个在线的yaml格式文档,直接修改该文档后,修改立即生效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit svc nginx-ds -n default</span><br><span class="line"># 查看结果</span><br><span class="line">[root@hdss7-21 ~]# kubectl get service nginx-ds </span><br><span class="line">NAME       TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">nginx-ds   ClusterIP   192.168.48.225   &lt;none&gt;        8080&#x2F;TCP   2m37s</span><br></pre></td></tr></table></figure>

<p><strong>离线修改</strong></p>
<p>离线修改就是修改原来的<code>yaml</code>文件,然后使用<code>apply</code>命令重新应用配置即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#将对外暴露的端口改为881</span><br><span class="line">sed -i &#39;s#port: 80#port: 881#g&#39; nginx-ds-svc.yaml</span><br><span class="line"># edit修改过资源,再用apply修改,会报错</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f nginx-ds-svc.yaml </span><br><span class="line">The Service &quot;nginx-ds&quot; is invalid: </span><br><span class="line">* spec.ports[0].name: Required value</span><br><span class="line">* spec.ports[1].name: Required value</span><br><span class="line"># 加上--force强制修改选项</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f nginx-ds-svc.yaml --force </span><br><span class="line">service&#x2F;nginx-ds configured</span><br><span class="line"># 查看结果</span><br><span class="line">[root@hdss7-21 ~]# kubectl get service nginx-ds </span><br><span class="line">NAME       TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">nginx-ds   ClusterIP   192.168.142.98   &lt;none&gt;        881&#x2F;TCP   8s</span><br></pre></td></tr></table></figure>

<h4 id="3-2-4-删除资源配置清单"><a href="#3-2-4-删除资源配置清单" class="headerlink" title="3.2.4 删除资源配置清单"></a>3.2.4 删除资源配置清单</h4><p><strong>陈述式删除</strong></p>
<p>即:直接删除创建好的资源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete svc nginx-ds -n default</span><br></pre></td></tr></table></figure>

<p><strong>声明式删除</strong></p>
<p>即:通过制定配置文件的方式,删除用该配置文件创建出的资源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f nginx-ds-svc.yaml</span><br></pre></td></tr></table></figure>



<p>转载自cnblog:<a href="https://www.cnblogs.com/noah-luo/p/13345173.html" target="_blank" rel="noopener">https://www.cnblogs.com/noah-luo/p/13345173.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/23/k8s/3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhangpengjie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/zpj.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zpj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/23/k8s/3/" itemprop="url">K8S(01)二进制部署实践-1.15.5</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-23T16:58:48+08:00">
                2020-12-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index">
                    <span itemprop="name">k8s</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/12/23/k8s/3/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/12/23/k8s/3/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="系列文章说明"><a href="#系列文章说明" class="headerlink" title="系列文章说明"></a>系列文章说明</h1><p>本系列文章是 老男孩2019年王硕的K8S周末班课程 笔记,根据视频来看本笔记最好,否则有些地方会看不明白</p>
<p>目录</p>
<ul>
<li><p>系列文章说明</p>
</li>
<li><ul>
<li>1 部署架构</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>1.1 架构图</li>
<li>1.2 安装方式选择</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li>2 部署准备</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>2.1 准备工作</li>
<li>2.2 部署DNS服务bind9</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>2.2.1 安装配置DNS服务</li>
<li>2.2.2 增加自定义域和对于配置</li>
<li>2.2.3 启动并验证DNS服务</li>
<li>2.2.4 所有主机修改网络配置</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>2.3 自签发证书环境准备</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>2.3.1 下载安装cfssl</li>
<li>2.3.2 生成ca证书文件</li>
<li>2.3.3 生成ca证书</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>2.4 docker环境准备</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>2.4.1 安装并配置docker</li>
<li>2.4.2 启动docker</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>2.5 部署harbor私有仓库</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>2.5.1 下载并解压</li>
<li>2.5.2 编辑配置文件</li>
<li>2.5.3 使用docker-compose启动harbor</li>
<li>2.5.4 使用dns解析harbor</li>
<li>2.5.5 使用nginx反向代理harbor</li>
<li>2.5.6 提前准备pauser/nginx基础镜像</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>2.6 准备nginx文件服务</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>2.6.1 创建文件访问</li>
<li>2.6.2 添加域名解析</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li>3 部署master节点-etcd服务</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>3.1 部署etcd集群</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>3.1.1 创建生成CA证书的JSON配置文件</li>
<li>3.1.3.创建生成自签发请求(csr)的json配置文件</li>
<li>3.1.4.生成etcd证书文件</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>3.2 安装启动etcd集群</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>3.2.1 创建etcd用户和安装软件</li>
<li>3.2.2 创建目录，拷贝证书文件</li>
<li>3.2.3 创建etcd服务启动脚本</li>
<li>3.2.4 使用supervisor启动etcd</li>
<li>3.2.5 部署启动集群其他机器</li>
<li>3.2.6 检查集群状态</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li>4 部署mater节点 kube-apiserver服务</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>4.1 签发client端证书</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>4.1.1 创建生成证书csr的json配置文件</li>
<li>4.1.2 生成client证书文件</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>4.2 签发kube-apiserver证书</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>4.2.1 创建生成证书csr的json配置文件</li>
<li>4.2.2 生成kube-apiserver证书文件</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>4.3 下载安装kube-apiserver</li>
<li>4.4 部署apiserver服务</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>4.4.1 拷贝证书文件</li>
<li>4.4.2 创建audit配置</li>
<li>4.4.3 创建apiserver启动脚本</li>
<li>4.4.4 创建supervisor启动apiserver的配置</li>
<li>4.4.5 启动apiserver服务并检查</li>
<li>4.4.6 部署启动所有apiserver机器</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>4.5 部署controller-manager服务</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>4.5.1 创建controller-manager启动脚本</li>
<li>4.5.2 创建supervisor配置</li>
<li>4.5.3 启动服务并检查</li>
<li>4.5.4 部署启动所有集群</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>4.6 部署kube-scheduler服务</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>4.6.1 创建启动脚本</li>
<li>4.6.2 创建supervisor配置</li>
<li>4.6.3 启动服务并检查</li>
<li>4.6.4 部署启动所有集群</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>4.7 检查master节点部署情况</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li>5 部署4层反代去代理apiserver</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>5.1 部署nginx四层反代</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>5.1.1 yum安装程序</li>
<li>5.1.2 配置NGINX</li>
<li>5.1.3 启动nginx</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>5.2 配置keepalived</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>5.2.1 创建端口监测脚本</li>
<li>5.2.2 创建keepalived主配置文件</li>
<li>5.2.3 创建keepalived从配置文件</li>
<li>5.3.4 启动keepalived并验证</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li>6 部署node节点</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>6.1 签发kubelet证书</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>6.1.1 创建生成证书csr的json配置文件</li>
<li>6.1.2 生成kubelet证书文件</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>6.2 创建kubelet服务</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>6.2.1 拷贝证书至node节点</li>
<li>6.2.2 创建kubelet配置</li>
<li>6.2.3 创建k8s-node.yaml配置文件</li>
<li>6.2.4 应用资源配置</li>
<li>6.2.5 创建kubelet启动脚本</li>
<li>6.2.6 创建supervisor配置</li>
<li>6.2.7 启动服务并检查</li>
<li>6.2.8 部署其他node节点</li>
<li>6.2.9 检查所有节点并给节点打上标签</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>6.3 创建kube-proxy服务</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>6.3.1 签发kube-proxy证书</li>
<li>6.3.2 拷贝证书文件至各节点</li>
<li>6.3.3 创建kube-proxy配置</li>
<li>6.3.4 加载ipvs模块以备kube-proxy启动用</li>
<li>6.3.5 创建kube-proxy启动脚本</li>
<li>6.3.6 创建kube-proxy的supervisor配置</li>
<li>6.3.7 启动服务并检查</li>
<li>6.3.8 部署所有节点</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li>7 验证kubernetes集群</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>7.1 在任意一个节点上创建一个资源配置清单</li>
<li>7.2 应用资源配置，并检查</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><ul>
<li>7.2.1 应用资源配置</li>
<li>7.2.2 在另一台node节点上检查</li>
<li>7.2.3 查看kubernetes是否搭建好</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="1-部署架构"><a href="#1-部署架构" class="headerlink" title="1 部署架构"></a>1 部署架构</h2><h3 id="1-1-架构图"><a href="#1-1-架构图" class="headerlink" title="1.1 架构图"></a>1.1 架构图</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601202918753-9b104b38-ebe7-43d3-ac98-d96e46123355.png" alt="image"></p>
<p>架构说明:</p>
<ol>
<li>etcd至少3台组成一个高可用集群</li>
<li>两台proxy组成高可用代理对外提供VIP</li>
<li>两台机器共同承担master和node节点功能</li>
<li>运维主机非K8S套件,但为K8S服务</li>
</ol>
<h3 id="1-2-安装方式选择"><a href="#1-2-安装方式选择" class="headerlink" title="1.2 安装方式选择"></a>1.2 安装方式选择</h3><ol>
<li>Minikube 预览使用,仅供学习</li>
<li>二进制安装(生产首选,新手推荐)</li>
<li>kubeadmin安装<br>简单,用k8s跑k8s自己,熟手推荐<br>新手不推荐的原因是容易知其然不知其所以然<br>出问题后找不到解决办法</li>
</ol>
<h2 id="2-部署准备"><a href="#2-部署准备" class="headerlink" title="2 部署准备"></a>2 部署准备</h2><h3 id="2-1-准备工作"><a href="#2-1-准备工作" class="headerlink" title="2.1 准备工作"></a>2.1 准备工作</h3><p>准备5台2C/2g/50g虚拟机,网络10.4.7.0/24</p>
<p>预装centos7.4,做完基础优化</p>
<p>安装部署bind9,部署自建DNS系统</p>
<p>准备自签证书环境</p>
<p>安装部署docker和harbor仓库</p>
<p>机器列表</p>
<table>
<thead>
<tr>
<th><strong>主机名</strong></th>
<th><strong>IP地址</strong></th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>hdss7-11</td>
<td>10.4.7.11</td>
<td>proxy1</td>
</tr>
<tr>
<td>hdss7-12</td>
<td>10.4.7.12</td>
<td>proxy2</td>
</tr>
<tr>
<td>hdss7-21</td>
<td>10.4.7.21</td>
<td>master1</td>
</tr>
<tr>
<td>hdss7-22</td>
<td>10.4.7.22</td>
<td>master2</td>
</tr>
<tr>
<td>hdss7-200</td>
<td>10.4.7.200</td>
<td>运维主机</td>
</tr>
</tbody></table>
<p>基本部署软件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# hostname</span><br><span class="line">hdss7-11</span><br><span class="line">[root@hdss7-11 ~]# getenforce </span><br><span class="line">Disabled</span><br><span class="line">[root@hdss7-11 ~]# cat &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-eth0 </span><br><span class="line">TYPE&#x3D;Ethernet</span><br><span class="line">BOOTPROTO&#x3D;none</span><br><span class="line">NAME&#x3D;eth0</span><br><span class="line">DEVICE&#x3D;eth0</span><br><span class="line">ONBOOT&#x3D;yes</span><br><span class="line">IPADDR&#x3D;10.4.7.11</span><br><span class="line">NETMASK&#x3D;255.255.255.0</span><br><span class="line">GATEWAY&#x3D;10.4.7.254</span><br><span class="line">DNS1&#x3D;10.4.7.254</span><br><span class="line">[root@hdss7-11 ~]# yum install wget net-tools telnet tree nmap sysstat lrzsz dos2unix -y</span><br></pre></td></tr></table></figure>

<h3 id="2-2-部署DNS服务bind9"><a href="#2-2-部署DNS服务bind9" class="headerlink" title="2.2 部署DNS服务bind9"></a>2.2 部署DNS服务bind9</h3><h4 id="2-2-1-安装配置DNS服务"><a href="#2-2-1-安装配置DNS服务" class="headerlink" title="2.2.1 安装配置DNS服务"></a>2.2.1 安装配置DNS服务</h4><p>在<code>7.11</code>上部署bind的DNS服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install bind bind-utils -y</span><br></pre></td></tr></table></figure>

<p>修改并校验配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# vim &#x2F;etc&#x2F;named.conf</span><br><span class="line">listen-on port 53 &#123; 10.4.7.11; &#125;; </span><br><span class="line">allow-query     &#123; any; &#125;;</span><br><span class="line">forwarders      &#123; 10.4.7.254; &#125;; #上一层DNS地址(网关或公网DNS)</span><br><span class="line">recursion yes;</span><br><span class="line">dnssec-enable no;</span><br><span class="line">dnssec-validation no</span><br><span class="line">[root@hdss7-11 ~]# named-checkconf</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601202918757-2e0c4fbf-1740-4787-884e-8ade28c911d1.png" alt="image"></p>
<h4 id="2-2-2-增加自定义域和对于配置"><a href="#2-2-2-增加自定义域和对于配置" class="headerlink" title="2.2.2 增加自定义域和对于配置"></a>2.2.2 增加自定义域和对于配置</h4><p>在域配置中增加自定义域</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt;&#x2F;etc&#x2F;named.rfc1912.zones &lt;&lt;&#39;EOF&#39;</span><br><span class="line"># 添加自定义主机域</span><br><span class="line">zone &quot;host.com&quot; IN &#123;</span><br><span class="line">        type  master;</span><br><span class="line">        file  &quot;host.com.zone&quot;;</span><br><span class="line">        allow-update &#123; 10.4.7.11; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"># 添加自定义业务域</span><br><span class="line">zone &quot;zq.com&quot; IN &#123;</span><br><span class="line">        type  master;</span><br><span class="line">        file  &quot;zq.com.zone&quot;;</span><br><span class="line">        allow-update &#123; 10.4.7.11; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<p>host.com和zq.com都是我们自定义的域名,一般用host.com做为主机域</p>
<p>zq.com为业务域,业务不同可以配置多个</p>
</blockquote>
<p>为自定义域<code>host.com</code>创建配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;var&#x2F;named&#x2F;host.com.zone &lt;&lt;&#39;EOF&#39;</span><br><span class="line">$ORIGIN host.com.</span><br><span class="line">$TTL 600    ; 10 minutes</span><br><span class="line">@       IN SOA  dns.host.com. dnsadmin.host.com. (</span><br><span class="line">                2020041601 ; serial</span><br><span class="line">                10800      ; refresh (3 hours)</span><br><span class="line">                900        ; retry (15 minutes)</span><br><span class="line">                604800     ; expire (1 week)</span><br><span class="line">                86400      ; minimum (1 day)</span><br><span class="line">                )</span><br><span class="line">            NS   dns.host.com.</span><br><span class="line">$TTL 60 ; 1 minute</span><br><span class="line">dns                A    10.4.7.11</span><br><span class="line">HDSS7-11           A    10.4.7.11</span><br><span class="line">HDSS7-12           A    10.4.7.12</span><br><span class="line">HDSS7-21           A    10.4.7.21</span><br><span class="line">HDSS7-22           A    10.4.7.22</span><br><span class="line">HDSS7-200          A    10.4.7.200</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>为自定义域<code>zq.com</code>创建配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;var&#x2F;named&#x2F;zq.com.zone &lt;&lt;&#39;EOF&#39;</span><br><span class="line">$ORIGIN zq.com.</span><br><span class="line">$TTL 600    ; 10 minutes</span><br><span class="line">@       IN SOA  dns.zq.com. dnsadmin.zq.com. (</span><br><span class="line">                2020041601 ; serial</span><br><span class="line">                10800      ; refresh (3 hours)</span><br><span class="line">                900        ; retry (15 minutes)</span><br><span class="line">                604800     ; expire (1 week)</span><br><span class="line">                86400      ; minimum (1 day)</span><br><span class="line">                )</span><br><span class="line">            NS   dns.zq.com.</span><br><span class="line">$TTL 60 ; 1 minute</span><br><span class="line">dns                A    10.4.7.11</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<p>host.com域用于主机之间通信,所以要先增加上所有主机</p>
<p>zq.com域用于后面的业务解析用,因此不需要先添加主机</p>
</blockquote>
<h4 id="2-2-3-启动并验证DNS服务"><a href="#2-2-3-启动并验证DNS服务" class="headerlink" title="2.2.3 启动并验证DNS服务"></a>2.2.3 启动并验证DNS服务</h4><p>再次检查配置并启动dns服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# named-checkconf </span><br><span class="line">[root@hdss7-11 ~]# systemctl start named</span><br><span class="line">[root@hdss7-11 ~]# ss -lntup|grep 53</span><br><span class="line">udp    UNCONN     0      0      10.4.7.11:53</span><br><span class="line">udp    UNCONN     0      0      :::53</span><br><span class="line">tcp    LISTEN     0      10     10.4.7.11:53</span><br><span class="line">tcp    LISTEN     0      128    127.0.0.1:953</span><br><span class="line">tcp    LISTEN     0      10     :::53</span><br><span class="line">tcp    LISTEN     0      128    ::1:953</span><br><span class="line"># 验证结果</span><br><span class="line">[root@hdss7-11 ~]# dig -t A hdss7-11.host.com @10.4.7.11 +short</span><br><span class="line">10.4.7.11</span><br><span class="line">[root@hdss7-11 ~]# dig -t A hdss7-21.host.com @10.4.7.11 +short</span><br><span class="line">10.4.7.21</span><br></pre></td></tr></table></figure>

<h4 id="2-2-4-所有主机修改网络配置"><a href="#2-2-4-所有主机修改网络配置" class="headerlink" title="2.2.4 所有主机修改网络配置"></a>2.2.4 所有主机修改网络配置</h4><p>5台K8S主机都需要按如下方式修改网络配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 修改dns并添加搜索域</span><br><span class="line">sed -i &#39;s#^DNS.*#DNS1&#x3D;10.4.7.11#g&#39; &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-eth0</span><br><span class="line">echo &quot;search&#x3D;host.com&quot; &gt;&gt;&#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-eth0 </span><br><span class="line">systemctl restart network</span><br><span class="line"># 检查DNS配置</span><br><span class="line">~]# cat &#x2F;etc&#x2F;resolv.conf</span><br><span class="line"># Generated by NetworkManager</span><br><span class="line">search host.com</span><br><span class="line">nameserver 10.4.7.11</span><br><span class="line">~]# dig -t A hdss7-21.host.com +short</span><br><span class="line">10.4.7.21</span><br><span class="line"># 一定记得检查dns配置文件中是否有search信息</span><br></pre></td></tr></table></figure>

<p>windows宿主机也要改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wmnet8网卡更改DNS：10.4.7.11</span><br><span class="line"># ping通才行,否则检查</span><br><span class="line">ping hdss7-200.host.com</span><br></pre></td></tr></table></figure>

<h3 id="2-3-自签发证书环境准备"><a href="#2-3-自签发证书环境准备" class="headerlink" title="2.3 自签发证书环境准备"></a>2.3 自签发证书环境准备</h3><p>操作在<code>7.200</code>这个运维机上完成</p>
<h4 id="2-3-1-下载安装cfssl"><a href="#2-3-1-下载安装cfssl" class="headerlink" title="2.3.1 下载安装cfssl"></a>2.3.1 下载安装cfssl</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;pkg.cfssl.org&#x2F;R1.2&#x2F;cfssl_linux-amd64 -O &#x2F;usr&#x2F;bin&#x2F;cfssl</span><br><span class="line">wget https:&#x2F;&#x2F;pkg.cfssl.org&#x2F;R1.2&#x2F;cfssljson_linux-amd64 -O &#x2F;usr&#x2F;bin&#x2F;cfssl-json</span><br><span class="line">wget https:&#x2F;&#x2F;pkg.cfssl.org&#x2F;R1.2&#x2F;cfssl-certinfo_linux-amd64 -O &#x2F;usr&#x2F;bin&#x2F;cfssl-certinfo</span><br><span class="line">chmod +x &#x2F;usr&#x2F;bin&#x2F;cfssl*</span><br></pre></td></tr></table></figure>

<h4 id="2-3-2-生成ca证书文件"><a href="#2-3-2-生成ca证书文件" class="headerlink" title="2.3.2 生成ca证书文件"></a>2.3.2 生成ca证书文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;opt&#x2F;certs</span><br><span class="line">cat &gt;&#x2F;opt&#x2F;certs&#x2F;ca-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;zqcd&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;chengdu&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;chengdu&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;zq&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;ca&quot;: &#123;</span><br><span class="line">        &quot;expiry&quot;: &quot;175200h&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<p>CN: Common Name，浏览器使用该字段验证网站是否合法，一般写的是域名。非常重要。浏览器使用该字段验证网站是否合法</p>
<p>C: Country， 国家</p>
<p>ST: State，州，省</p>
<p>L: Locality，地区，城市</p>
<p>O: Organization Name，组织名称，公司名称</p>
<p>OU: Organization Unit Name，组织单位名称，公司部门</p>
</blockquote>
<h4 id="2-3-3-生成ca证书"><a href="#2-3-3-生成ca证书" class="headerlink" title="2.3.3 生成ca证书"></a>2.3.3 生成ca证书</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;certs</span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssl-json -bare ca</span><br><span class="line">[root@hdss7-200 certs]# ll</span><br><span class="line">total 16</span><br><span class="line">-rw-r--r-- 1 root root  989 Apr 16 20:53 cacsr</span><br><span class="line">-rw-r--r-- 1 root root  324 Apr 16 20:52 ca-csr.json</span><br><span class="line">-rw------- 1 root root 1679 Apr 16 20:53 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1330 Apr 16 20:53 ca.pem</span><br></pre></td></tr></table></figure>

<h3 id="2-4-docker环境准备"><a href="#2-4-docker环境准备" class="headerlink" title="2.4 docker环境准备"></a>2.4 docker环境准备</h3><h4 id="2-4-1-安装并配置docker"><a href="#2-4-1-安装并配置docker" class="headerlink" title="2.4.1 安装并配置docker"></a>2.4.1 安装并配置docker</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https:&#x2F;&#x2F;get.docker.com | bash -s docker --mirror Aliyun</span><br><span class="line">mkdir &#x2F;etc&#x2F;docker&#x2F;</span><br><span class="line">cat &gt;&#x2F;etc&#x2F;docker&#x2F;daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;graph&quot;: &quot;&#x2F;data&#x2F;docker&quot;, </span><br><span class="line">  &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">  &quot;insecure-registries&quot;: [&quot;registry.access.redhat.com&quot;,&quot;quay.io&quot;,&quot;harbor.zq.com&quot;],</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https:&#x2F;&#x2F;q2gr04ke.mirror.aliyuncs.com&quot;],</span><br><span class="line">  &quot;bip&quot;: &quot;172.7.21.1&#x2F;24&quot;,</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver&#x3D;systemd&quot;],</span><br><span class="line">  &quot;live-restore&quot;: true</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意:bip要根据宿主机ip变化</p>
<p>hdss7-21.host.com bip 172.7.21.1/24</p>
<p>hdss7-22.host.com bip 172.7.22.1/24</p>
<p>hdss7-200.host.com bip 172.7.200.1/24</p>
</blockquote>
<h4 id="2-4-2-启动docker"><a href="#2-4-2-启动docker" class="headerlink" title="2.4.2 启动docker"></a>2.4.2 启动docker</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;data&#x2F;docker</span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl enable docker</span><br><span class="line">docker --version</span><br></pre></td></tr></table></figure>

<h3 id="2-5-部署harbor私有仓库"><a href="#2-5-部署harbor私有仓库" class="headerlink" title="2.5 部署harbor私有仓库"></a>2.5 部署harbor私有仓库</h3><p>下载地址:<a href="https://github.com/goharbor/harbor/releases/download/v1.8.5/harbor-offline-installer-v1.8.5.tgz" target="_blank" rel="noopener">https://github.com/goharbor/harbor/releases/download/v1.8.5/harbor-offline-installer-v1.8.5.tgz</a></p>
<h4 id="2-5-1-下载并解压"><a href="#2-5-1-下载并解压" class="headerlink" title="2.5.1 下载并解压"></a>2.5.1 下载并解压</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar xf harbor-offline-installer-v1.8.5.tgz -C &#x2F;opt&#x2F;</span><br><span class="line">cd &#x2F;opt&#x2F;</span><br><span class="line">mv harbor&#x2F; harbor-v1.8.5</span><br><span class="line">ln -s &#x2F;opt&#x2F;harbor-v1.8.5&#x2F; &#x2F;opt&#x2F;harbor</span><br></pre></td></tr></table></figure>

<h4 id="2-5-2-编辑配置文件"><a href="#2-5-2-编辑配置文件" class="headerlink" title="2.5.2 编辑配置文件"></a>2.5.2 编辑配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 opt]# vi &#x2F;opt&#x2F;harbor&#x2F;harbor.yml</span><br><span class="line"># 以下是修改项,手动在配置文件中更改</span><br><span class="line">hostname: harbor.zq.com</span><br><span class="line">http:</span><br><span class="line">  port: 180</span><br><span class="line"> harbor_admin_password:Harbor12345</span><br><span class="line">data_volume: &#x2F;data&#x2F;harbor</span><br><span class="line">log:</span><br><span class="line">    level:  info</span><br><span class="line">    rotate_count:  50</span><br><span class="line">    rotate_size:200M</span><br><span class="line">    location: &#x2F;data&#x2F;harbor&#x2F;logs</span><br><span class="line">[root@hdss7-200 opt]# mkdir -p &#x2F;data&#x2F;harbor&#x2F;logs</span><br></pre></td></tr></table></figure>

<h4 id="2-5-3-使用docker-compose启动harbor"><a href="#2-5-3-使用docker-compose启动harbor" class="headerlink" title="2.5.3 使用docker-compose启动harbor"></a>2.5.3 使用docker-compose启动harbor</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 opt]cd &#x2F;opt&#x2F;harbor&#x2F;</span><br><span class="line">yum install docker-compose -y</span><br><span class="line">sh &#x2F;opt&#x2F;harbor&#x2F;install.sh </span><br><span class="line">docker-compose ps</span><br><span class="line">docker ps -a</span><br></pre></td></tr></table></figure>

<h4 id="2-5-4-使用dns解析harbor"><a href="#2-5-4-使用dns解析harbor" class="headerlink" title="2.5.4 使用dns解析harbor"></a>2.5.4 使用dns解析harbor</h4><p>在<code>7.11</code>DNS服务上操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# vi &#x2F;var&#x2F;named&#x2F;zq.com.zone</span><br><span class="line">2020032002 ; serial   #每次修改DNS解析后,都要滚动此ID</span><br><span class="line">harbor             A    10.4.7.200</span><br><span class="line">[root@hdss7-11 ~]# systemctl restart named</span><br><span class="line">[root@hdss7-11 ~]# dig -t A harbor.zq.com +short</span><br><span class="line">10.4.7.200</span><br></pre></td></tr></table></figure>

<h4 id="2-5-5-使用nginx反向代理harbor"><a href="#2-5-5-使用nginx反向代理harbor" class="headerlink" title="2.5.5 使用nginx反向代理harbor"></a>2.5.5 使用nginx反向代理harbor</h4><p>回到<code>7.200</code>运维机上操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# yum install nginx -y</span><br><span class="line">[root@hdss7-200 harbor]# vi &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;harbor.zq.com.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  harbor.zq.com;</span><br><span class="line">    client_max_body_size 1000m;</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;127.0.0.1:180;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@hdss7-200 harbor]# nginx -t</span><br><span class="line">[root@hdss7-200 harbor]# systemctl start nginx</span><br><span class="line">[root@hdss7-200 harbor]# systemctl enable nginx</span><br></pre></td></tr></table></figure>

<blockquote>
<p>浏览器输入：harbor.zq.com</p>
<p>用户名：admin 密码：Harbor12345</p>
<p>新建项目：public 访问级别：公开</p>
</blockquote>
<h4 id="2-5-6-提前准备pauser-nginx基础镜像"><a href="#2-5-6-提前准备pauser-nginx基础镜像" class="headerlink" title="2.5.6 提前准备pauser/nginx基础镜像"></a>2.5.6 提前准备pauser/nginx基础镜像</h4><p>pauser镜像是k8s启动pod时,预先用来创建相关资源(如名称空间)的</p>
<p>nginx镜像是k8s部署好以后,我们测试pod创建所用的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker login harbor.zq.com -uadmin -pHarbor12345</span><br><span class="line">docker pull kubernetes&#x2F;pause</span><br><span class="line">docker pull nginx:1.17.9</span><br><span class="line">docker tag kubernetes&#x2F;pause:latest harbor.zq.com&#x2F;public&#x2F;pause:latest</span><br><span class="line">docker tag nginx:1.17.9 harbor.zq.com&#x2F;public&#x2F;nginx:v1.17.9</span><br><span class="line">docker push harbor.zq.com&#x2F;public&#x2F;pause:latest</span><br><span class="line">docker push harbor.zq.com&#x2F;public&#x2F;nginx:v1.17.9</span><br></pre></td></tr></table></figure>

<h3 id="2-6-准备nginx文件服务"><a href="#2-6-准备nginx文件服务" class="headerlink" title="2.6 准备nginx文件服务"></a>2.6 准备nginx文件服务</h3><p>创建一个nginx虚拟主机,用来提供文件访问访问,主要依赖nginx的<code>autoindex</code>属性</p>
<h4 id="2-6-1-创建文件访问"><a href="#2-6-1-创建文件访问" class="headerlink" title="2.6.1 创建文件访问"></a>2.6.1 创建文件访问</h4><p>在<code>7.200</code>上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 创建配置</span><br><span class="line">cat &gt;&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;k8s-yaml.zq.com.conf &lt;&lt;EOF</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  k8s-yaml.zq.com;</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        autoindex on;</span><br><span class="line">        default_type text&#x2F;plain;</span><br><span class="line">        root &#x2F;data&#x2F;k8s-yaml;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"># 启动nginx</span><br><span class="line">mkdir -p &#x2F;data&#x2F;k8s-yaml&#x2F;coredns</span><br><span class="line">nginx -t</span><br><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>

<h4 id="2-6-2-添加域名解析"><a href="#2-6-2-添加域名解析" class="headerlink" title="2.6.2 添加域名解析"></a>2.6.2 添加域名解析</h4><p>在<code>7.11</code>的<code>bind9</code>域名服务器上,增加DNS记录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;var&#x2F;named&#x2F;zq.com.zone</span><br><span class="line"># 在最后添加一条解析记录</span><br><span class="line">k8s-yaml           A    10.4.7.200</span><br><span class="line"># 同时滚动serial为</span><br><span class="line">@               IN SOA  dns.zq.com. dnsadmin.zq.com. (</span><br><span class="line">                                2019061803 ; serial</span><br></pre></td></tr></table></figure>

<p><strong>重启服务并验证:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart named</span><br><span class="line">[root@hdss7-11 ~]# dig -t A k8s-yaml.zq.com +short</span><br><span class="line">10.4.7.200</span><br></pre></td></tr></table></figure>

<h2 id="3-部署master节点-etcd服务"><a href="#3-部署master节点-etcd服务" class="headerlink" title="3 部署master节点-etcd服务"></a>3 部署master节点-etcd服务</h2><h3 id="3-1-部署etcd集群"><a href="#3-1-部署etcd集群" class="headerlink" title="3.1 部署etcd集群"></a>3.1 部署etcd集群</h3><p>分别在12/21/22 上安装ectd服务,11节点作为备选节点</p>
<h4 id="3-1-1-创建生成CA证书的JSON配置文件"><a href="#3-1-1-创建生成CA证书的JSON配置文件" class="headerlink" title="3.1.1 创建生成CA证书的JSON配置文件"></a>3.1.1 创建生成CA证书的JSON配置文件</h4><p>在<code>7.200上操作</code></p>
<p>一个配置里面包含了server端,clinet端和双向(peer)通信所需要的配置,后面创建证书的时候会传入不同的参数调用不同的配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;opt&#x2F;certs&#x2F;ca-config.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;signing&quot;: &#123;</span><br><span class="line">        &quot;default&quot;: &#123;</span><br><span class="line">            &quot;expiry&quot;: &quot;175200h&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;profiles&quot;: &#123;</span><br><span class="line">            &quot;server&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;175200h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;server auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;client&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;175200h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;client auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;peer&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;175200h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;server auth&quot;,</span><br><span class="line">                    &quot;client auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<p>证书时间统一为10年,不怕过期</p>
<p>证书类型</p>
<p>client certificate：客户端使用，用于服务端认证客户端,例如etcdctl、etcd proxy、fleetctl、docker客户端</p>
<p>server certificate：服务端使用，客户端以此验证服务端身份,例如docker服务端、kube-apiserver</p>
<p>peer certificate：双向证书，用于etcd集群成员间通信</p>
</blockquote>
<h4 id="3-1-3-创建生成自签发请求-csr-的json配置文件"><a href="#3-1-3-创建生成自签发请求-csr-的json配置文件" class="headerlink" title="3.1.3.创建生成自签发请求(csr)的json配置文件"></a>3.1.3.创建生成自签发请求(csr)的json配置文件</h4><p>注意:</p>
<p>需要将所有可能用来部署<code>etcd</code>的机器,都加入到hosts列表中</p>
<p>否则后期重新加入不在列表中的机器,需要更换所有etcd服务的证书</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;opt&#x2F;certs&#x2F;etcd-peer-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;k8s-etcd&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;10.4.7.11&quot;,</span><br><span class="line">        &quot;10.4.7.12&quot;,</span><br><span class="line">        &quot;10.4.7.21&quot;,</span><br><span class="line">        &quot;10.4.7.22&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;zq&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="3-1-4-生成etcd证书文件"><a href="#3-1-4-生成etcd证书文件" class="headerlink" title="3.1.4.生成etcd证书文件"></a>3.1.4.生成etcd证书文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;certs&#x2F;</span><br><span class="line">cfssl gencert -ca&#x3D;ca.pem -ca-key&#x3D;ca-key.pem \</span><br><span class="line">  -config&#x3D;ca-config.json -profile&#x3D;peer \</span><br><span class="line">  etcd-peer-csr.json |cfssl-json -bare etcd-peer</span><br><span class="line">[root@hdss7-200 certs]# ll</span><br><span class="line">total 36</span><br><span class="line">-rw-r--r-- 1 root root  837 Apr 19 15:35 ca-config.json</span><br><span class="line">-rw-r--r-- 1 root root  989 Apr 16 20:53 ca.csr</span><br><span class="line">-rw-r--r-- 1 root root  324 Apr 16 20:52 ca-csr.json</span><br><span class="line">-rw------- 1 root root 1679 Apr 16 20:53 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1330 Apr 16 20:53 ca.pem</span><br><span class="line">-rw-r--r-- 1 root root 1062 Apr 19 15:35 etcd-peer.csr</span><br><span class="line">-rw-r--r-- 1 root root  363 Apr 19 15:35 etcd-peer-csr.json</span><br><span class="line">-rw------- 1 root root 1679 Apr 19 15:35 etcd-peer-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1419 Apr 19 15:35 etcd-peer.pem</span><br></pre></td></tr></table></figure>

<h3 id="3-2-安装启动etcd集群"><a href="#3-2-安装启动etcd集群" class="headerlink" title="3.2 安装启动etcd集群"></a>3.2 安装启动etcd集群</h3><p>以<code>7.12</code>做为演示,另外2台机器大同小异,不相同的配置都会特别说明</p>
<h4 id="3-2-1-创建etcd用户和安装软件"><a href="#3-2-1-创建etcd用户和安装软件" class="headerlink" title="3.2.1 创建etcd用户和安装软件"></a>3.2.1 创建etcd用户和安装软件</h4><p>etcd地址:<a href="https://github.com/etcd-io/etcd/tags" target="_blank" rel="noopener">https://github.com/etcd-io/etcd/tags</a></p>
<p>建议使用3.1版本,更高版本有问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">useradd -s &#x2F;sbin&#x2F;nologin -M etcd</span><br><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;etcd-io&#x2F;etcd&#x2F;archive&#x2F;v3.1.20.tar.gz</span><br><span class="line">tar xf etcd-v3.1.20-linux-amd64.tar.gz -C &#x2F;opt&#x2F;</span><br><span class="line">cd &#x2F;opt&#x2F;</span><br><span class="line">mv etcd-v3.1.20-linux-amd64&#x2F; etcd-v3.1.20</span><br><span class="line">ln -s &#x2F;opt&#x2F;etcd-v3.1.20&#x2F; &#x2F;opt&#x2F;etcd</span><br></pre></td></tr></table></figure>

<h4 id="3-2-2-创建目录，拷贝证书文件"><a href="#3-2-2-创建目录，拷贝证书文件" class="headerlink" title="3.2.2 创建目录，拷贝证书文件"></a>3.2.2 创建目录，拷贝证书文件</h4><p><strong>创建证书目录、数据目录、日志目录</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;opt&#x2F;etcd&#x2F;certs &#x2F;data&#x2F;etcd &#x2F;data&#x2F;logs&#x2F;etcd-server</span><br><span class="line">chown -R etcd.etcd &#x2F;opt&#x2F;etcd-v3.1.20&#x2F;</span><br><span class="line">chown -R etcd.etcd &#x2F;data&#x2F;etcd&#x2F;</span><br><span class="line">chown -R etcd.etcd &#x2F;data&#x2F;logs&#x2F;etcd-server&#x2F;</span><br></pre></td></tr></table></figure>

<p><strong>拷贝生成的证书文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;etcd&#x2F;certs</span><br><span class="line">scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;ca.pem .</span><br><span class="line">scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;etcd-peer.pem .</span><br><span class="line">scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;etcd-peer-key.pem .</span><br><span class="line">chown -R etcd.etcd &#x2F;opt&#x2F;etcd&#x2F;certs</span><br></pre></td></tr></table></figure>

<p>也可以先创建一个NFS,直接从NFS中拷贝</p>
<h4 id="3-2-3-创建etcd服务启动脚本"><a href="#3-2-3-创建etcd服务启动脚本" class="headerlink" title="3.2.3 创建etcd服务启动脚本"></a>3.2.3 创建etcd服务启动脚本</h4><p>参数说明: <a href="https://blog.csdn.net/kmhysoft/article/details/71106995" target="_blank" rel="noopener">https://blog.csdn.net/kmhysoft/article/details/71106995</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;opt&#x2F;etcd&#x2F;etcd-server-startup.sh &lt;&lt;&#39;EOF&#39;</span><br><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">.&#x2F;etcd \</span><br><span class="line">    --name etcd-server-7-12 \</span><br><span class="line">    --data-dir &#x2F;data&#x2F;etcd&#x2F;etcd-server \</span><br><span class="line">    --listen-peer-urls https:&#x2F;&#x2F;10.4.7.12:2380 \</span><br><span class="line">    --listen-client-urls https:&#x2F;&#x2F;10.4.7.12:2379,http:&#x2F;&#x2F;127.0.0.1:2379 \</span><br><span class="line">    --quota-backend-bytes 8000000000 \</span><br><span class="line">    --initial-advertise-peer-urls https:&#x2F;&#x2F;10.4.7.12:2380 \</span><br><span class="line">    --advertise-client-urls https:&#x2F;&#x2F;10.4.7.12:2379,http:&#x2F;&#x2F;127.0.0.1:2379 \</span><br><span class="line">    --initial-cluster  etcd-server-7-12&#x3D;https:&#x2F;&#x2F;10.4.7.12:2380,etcd-server-7-21&#x3D;https:&#x2F;&#x2F;10.4.7.21:2380,etcd-server-7-22&#x3D;https:&#x2F;&#x2F;10.4.7.22:2380 \</span><br><span class="line">    --ca-file .&#x2F;certs&#x2F;ca.pem \</span><br><span class="line">    --cert-file .&#x2F;certs&#x2F;etcd-peer.pem \</span><br><span class="line">    --key-file .&#x2F;certs&#x2F;etcd-peer-key.pem \</span><br><span class="line">    --client-cert-auth  \</span><br><span class="line">    --trusted-ca-file .&#x2F;certs&#x2F;ca.pem \</span><br><span class="line">    --peer-ca-file .&#x2F;certs&#x2F;ca.pem \</span><br><span class="line">    --peer-cert-file .&#x2F;certs&#x2F;etcd-peer.pem \</span><br><span class="line">    --peer-key-file .&#x2F;certs&#x2F;etcd-peer-key.pem \</span><br><span class="line">    --peer-client-cert-auth \</span><br><span class="line">    --peer-trusted-ca-file .&#x2F;certs&#x2F;ca.pem \</span><br><span class="line">    --log-output stdout</span><br><span class="line">EOF</span><br><span class="line">[root@hdss7-12 ~]# chmod +x &#x2F;opt&#x2F;etcd&#x2F;etcd-server-startup.sh</span><br></pre></td></tr></table></figure>

<p>注意:以上启动脚本,有几个配置项在每个服务器都有所<strong>不同</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--name    #节点名字</span><br><span class="line">--listen-peer-urls      #监听其他节点所用的地址</span><br><span class="line">--listen-client-urls    #监听etcd客户端的地址</span><br><span class="line">--initial-advertise-peer-urls   #与其他节点交互信息的地址</span><br><span class="line">--advertise-client-urls #与etcd客户端交互信息的地址</span><br></pre></td></tr></table></figure>

<h4 id="3-2-4-使用supervisor启动etcd"><a href="#3-2-4-使用supervisor启动etcd" class="headerlink" title="3.2.4 使用supervisor启动etcd"></a>3.2.4 使用supervisor启动etcd</h4><p><strong>安装supervisor软件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install supervisor -y</span><br><span class="line">systemctl start supervisord</span><br><span class="line">systemctl enable supervisord</span><br></pre></td></tr></table></figure>

<p><strong>创建supervisor管理etcd的配置文件</strong></p>
<p>配置说明参考: <a href="https://www.jianshu.com/p/53b5737534e8" target="_blank" rel="noopener">https://www.jianshu.com/p/53b5737534e8</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;etc&#x2F;supervisord.d&#x2F;etcd-server.ini &lt;&lt;EOF</span><br><span class="line">[program:etcd-server]  ; 显示的程序名,类型my.cnf,可以有多个</span><br><span class="line">command&#x3D;sh &#x2F;opt&#x2F;etcd&#x2F;etcd-server-startup.sh</span><br><span class="line">numprocs&#x3D;1             ; 启动进程数 (def 1)</span><br><span class="line">directory&#x3D;&#x2F;opt&#x2F;etcd    ; 启动命令前切换的目录 (def no cwd)</span><br><span class="line">autostart&#x3D;true         ; 是否自启 (default: true)</span><br><span class="line">autorestart&#x3D;true       ; 是否自动重启 (default: true)</span><br><span class="line">startsecs&#x3D;30           ; 服务运行多久判断为成功(def. 1)</span><br><span class="line">startretries&#x3D;3         ; 启动重试次数 (default 3)</span><br><span class="line">exitcodes&#x3D;0,2          ; 退出状态码 (default 0,2)</span><br><span class="line">stopsignal&#x3D;QUIT        ; 退出信号 (default TERM)</span><br><span class="line">stopwaitsecs&#x3D;10        ; 退出延迟时间 (default 10)</span><br><span class="line">user&#x3D;etcd              ; 运行用户</span><br><span class="line">redirect_stderr&#x3D;true   ; 是否重定向错误输出到标准输出(def false)</span><br><span class="line">stdout_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;etcd-server&#x2F;etcd.stdout.log</span><br><span class="line">stdout_logfile_maxbytes&#x3D;64MB  ; 日志文件大小 (default 50MB)</span><br><span class="line">stdout_logfile_backups&#x3D;4      ; 日志文件滚动个数 (default 10)</span><br><span class="line">stdout_capture_maxbytes&#x3D;1MB   ; 设定capture管道的大小(default 0)</span><br><span class="line">;子进程还有子进程,需要添加这个参数,避免产生孤儿进程</span><br><span class="line">killasgroup&#x3D;true</span><br><span class="line">stopasgroup&#x3D;true</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>启动etcd服务并检查</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">supervisorctl update</span><br><span class="line">supervisorctl status</span><br><span class="line">netstat -lntup|grep etcd</span><br></pre></td></tr></table></figure>

<h4 id="3-2-5-部署启动集群其他机器"><a href="#3-2-5-部署启动集群其他机器" class="headerlink" title="3.2.5 部署启动集群其他机器"></a>3.2.5 部署启动集群其他机器</h4><p>略</p>
<h4 id="3-2-6-检查集群状态"><a href="#3-2-6-检查集群状态" class="headerlink" title="3.2.6 检查集群状态"></a>3.2.6 检查集群状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 certs]# &#x2F;opt&#x2F;etcd&#x2F;etcdctl cluster-health</span><br><span class="line">member 988139385f78284 is healthy: got healthy result from http:&#x2F;&#x2F;127.0.0.1:2379</span><br><span class="line">member 5a0ef2a004fc4349 is healthy: got healthy result from http:&#x2F;&#x2F;127.0.0.1:2379</span><br><span class="line">member f4a0cb0a765574a8 is healthy: got healthy result from http:&#x2F;&#x2F;127.0.0.1:2379</span><br><span class="line">[root@hdss7-12 certs]# &#x2F;opt&#x2F;etcd&#x2F;etcdctl member list</span><br><span class="line">988139385f78284: name&#x3D;etcd-server-7-22 peerURLs&#x3D;https:&#x2F;&#x2F;10.4.7.22:2380 clientURLs&#x3D;http:&#x2F;&#x2F;127.0.0.1:2379,https:&#x2F;&#x2F;10.4.7.22:2379 isLeader&#x3D;false</span><br><span class="line">5a0ef2a004fc4349: name&#x3D;etcd-server-7-21 peerURLs&#x3D;https:&#x2F;&#x2F;10.4.7.21:2380 clientURLs&#x3D;http:&#x2F;&#x2F;127.0.0.1:2379,https:&#x2F;&#x2F;10.4.7.21:2379 isLeader&#x3D;false</span><br><span class="line">f4a0cb0a765574a8: name&#x3D;etcd-server-7-12 peerURLs&#x3D;https:&#x2F;&#x2F;10.4.7.12:2380 clientURLs&#x3D;http:&#x2F;&#x2F;127.0.0.1:2379,https:&#x2F;&#x2F;10.4.7.12:2379 isLeader&#x3D;true</span><br></pre></td></tr></table></figure>

<h2 id="4-部署mater节点-kube-apiserver服务"><a href="#4-部署mater节点-kube-apiserver服务" class="headerlink" title="4 部署mater节点 kube-apiserver服务"></a>4 部署mater节点 kube-apiserver服务</h2><p>下载页面: <a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.15.md" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.15.md</a></p>
<p>下载地址:</p>
<p><a href="https://dl.k8s.io/v1.15.5/kubernetes-server-linux-amd64.tar.gz" target="_blank" rel="noopener">https://dl.k8s.io/v1.15.5/kubernetes-server-linux-amd64.tar.gz</a></p>
<p><a href="https://dl.k8s.io/v1.15.5/kubernetes-client-linux-amd64.tar.gz" target="_blank" rel="noopener">https://dl.k8s.io/v1.15.5/kubernetes-client-linux-amd64.tar.gz</a></p>
<p><a href="https://dl.k8s.io/v1.15.5/kubernetes-node-linux-amd64.tar.gz" target="_blank" rel="noopener">https://dl.k8s.io/v1.15.5/kubernetes-node-linux-amd64.tar.gz</a></p>
<h3 id="4-1-签发client端证书"><a href="#4-1-签发client端证书" class="headerlink" title="4.1 签发client端证书"></a>4.1 签发client端证书</h3><p>证书签发都在<code>7.200</code>上操作</p>
<p>此证书的用途是apiserver和etcd之间通信所用</p>
<h4 id="4-1-1-创建生成证书csr的json配置文件"><a href="#4-1-1-创建生成证书csr的json配置文件" class="headerlink" title="4.1.1 创建生成证书csr的json配置文件"></a>4.1.1 创建生成证书csr的json配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;opt&#x2F;certs&#x2F;client-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;k8s-node&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;zq&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="4-1-2-生成client证书文件"><a href="#4-1-2-生成client证书文件" class="headerlink" title="4.1.2 生成client证书文件"></a>4.1.2 生成client证书文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert \</span><br><span class="line">      -ca&#x3D;ca.pem \</span><br><span class="line">      -ca-key&#x3D;ca-key.pem \</span><br><span class="line">      -config&#x3D;ca-config.json \</span><br><span class="line">      -profile&#x3D;client \</span><br><span class="line">      client-csr.json |cfssl-json -bare client</span><br><span class="line">[root@hdss7-200 certs]# ll|grep client</span><br><span class="line">-rw-r--r-- 1 root root  993 Apr 20 21:30 client.csr</span><br><span class="line">-rw-r--r-- 1 root root  280 Apr 20 21:30 client-csr.json</span><br><span class="line">-rw------- 1 root root 1675 Apr 20 21:30 client-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1359 Apr 20 21:30 client.pem</span><br></pre></td></tr></table></figure>

<h3 id="4-2-签发kube-apiserver证书"><a href="#4-2-签发kube-apiserver证书" class="headerlink" title="4.2 签发kube-apiserver证书"></a>4.2 签发kube-apiserver证书</h3><p>此证书的用途是apiserver对外提供的服务的证书</p>
<h4 id="4-2-1-创建生成证书csr的json配置文件"><a href="#4-2-1-创建生成证书csr的json配置文件" class="headerlink" title="4.2.1 创建生成证书csr的json配置文件"></a>4.2.1 创建生成证书csr的json配置文件</h4><p>此配置中的<code>hosts</code>包含所有可能会部署apiserver的列表</p>
<p>其中<code>10.4.7.10</code>是反向代理的vip地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;opt&#x2F;certs&#x2F;apiserver-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;k8s-apiserver&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;127.0.0.1&quot;,</span><br><span class="line">        &quot;192.168.0.1&quot;,</span><br><span class="line">        &quot;kubernetes.default&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc.cluster.local&quot;,</span><br><span class="line">        &quot;10.4.7.10&quot;,</span><br><span class="line">        &quot;10.4.7.21&quot;,</span><br><span class="line">        &quot;10.4.7.22&quot;,</span><br><span class="line">        &quot;10.4.7.23&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;zq&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="4-2-2-生成kube-apiserver证书文件"><a href="#4-2-2-生成kube-apiserver证书文件" class="headerlink" title="4.2.2 生成kube-apiserver证书文件"></a>4.2.2 生成kube-apiserver证书文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert \</span><br><span class="line">      -ca&#x3D;ca.pem \</span><br><span class="line">      -ca-key&#x3D;ca-key.pem \</span><br><span class="line">      -config&#x3D;ca-config.json \</span><br><span class="line">      -profile&#x3D;server \</span><br><span class="line">      apiserver-csr.json |cfssl-json -bare apiserver</span><br><span class="line">[root@hdss7-200 certs]# ll|grep apiserver</span><br><span class="line">-rw-r--r-- 1 root root 1249 Apr 20 21:31 apiserver.csr</span><br><span class="line">-rw-r--r-- 1 root root  566 Apr 20 21:31 apiserver-csr.json</span><br><span class="line">-rw------- 1 root root 1675 Apr 20 21:31 apiserver-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1590 Apr 20 21:31 apiserver.pem</span><br></pre></td></tr></table></figure>

<h3 id="4-3-下载安装kube-apiserver"><a href="#4-3-下载安装kube-apiserver" class="headerlink" title="4.3 下载安装kube-apiserver"></a>4.3 下载安装kube-apiserver</h3><p>以<code>7.21</code>为例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 上传并解压缩</span><br><span class="line">tar xf kubernetes-server-linux-amd64-v1.15.2.tar.gz  -C &#x2F;opt</span><br><span class="line">cd &#x2F;opt</span><br><span class="line">mv kubernetes&#x2F; kubernetes-v1.15.2</span><br><span class="line">ln -s &#x2F;opt&#x2F;kubernetes-v1.15.2&#x2F; &#x2F;opt&#x2F;kubernetes</span><br><span class="line"># 清理源码包和docker镜像</span><br><span class="line">cd &#x2F;opt&#x2F;kubernetes</span><br><span class="line">rm -rf kubernetes-src.tar.gz</span><br><span class="line">cd server&#x2F;bin</span><br><span class="line">rm -f *.tar</span><br><span class="line">rm -f *_tag</span><br><span class="line"># 创建命令软连接到系统环境变量下</span><br><span class="line">ln -s &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kubectl &#x2F;usr&#x2F;bin&#x2F;kubectl</span><br></pre></td></tr></table></figure>

<h3 id="4-4-部署apiserver服务"><a href="#4-4-部署apiserver服务" class="headerlink" title="4.4 部署apiserver服务"></a>4.4 部署apiserver服务</h3><h4 id="4-4-1-拷贝证书文件"><a href="#4-4-1-拷贝证书文件" class="headerlink" title="4.4.1 拷贝证书文件"></a>4.4.1 拷贝证书文件</h4><p>拷贝证书文件到<code>/opt/kubernetes/server/bin/cert</code>目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 创建目录</span><br><span class="line">mkdir -p &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert</span><br><span class="line">cd &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert</span><br><span class="line"># 拷贝三套证书</span><br><span class="line">scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;ca.pem .</span><br><span class="line">scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;ca-key.pem .</span><br><span class="line">scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;client.pem .</span><br><span class="line">scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;client-key.pem .</span><br><span class="line">scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;apiserver.pem .</span><br><span class="line">scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;apiserver-key.pem .</span><br></pre></td></tr></table></figure>

<h4 id="4-4-2-创建audit配置"><a href="#4-4-2-创建audit配置" class="headerlink" title="4.4.2 创建audit配置"></a>4.4.2 创建audit配置</h4><p>audit日志审计规则配置是k8s要求必须要有得配置,可以不理解,直接用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;conf</span><br><span class="line">cat &gt;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;conf&#x2F;audit.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: audit.k8s.io&#x2F;v1beta1 # This is required.</span><br><span class="line">kind: Policy</span><br><span class="line"># Don&#39;t generate audit events for all requests in RequestReceived stage.</span><br><span class="line">omitStages:</span><br><span class="line">  - &quot;RequestReceived&quot;</span><br><span class="line">rules:</span><br><span class="line">  # Log pod changes at RequestResponse level</span><br><span class="line">  - level: RequestResponse</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      # Resource &quot;pods&quot; doesn&#39;t match requests to any subresource of pods,</span><br><span class="line">      # which is consistent with the RBAC policy.</span><br><span class="line">      resources: [&quot;pods&quot;]</span><br><span class="line">  # Log &quot;pods&#x2F;log&quot;, &quot;pods&#x2F;status&quot; at Metadata level</span><br><span class="line">  - level: Metadata</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      resources: [&quot;pods&#x2F;log&quot;, &quot;pods&#x2F;status&quot;]</span><br><span class="line">  # Don&#39;t log requests to a configmap called &quot;controller-leader&quot;</span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      resources: [&quot;configmaps&quot;]</span><br><span class="line">      resourceNames: [&quot;controller-leader&quot;]</span><br><span class="line">  # Don&#39;t log watch requests by the &quot;system:kube-proxy&quot; on endpoints or services</span><br><span class="line">  - level: None</span><br><span class="line">    users: [&quot;system:kube-proxy&quot;]</span><br><span class="line">    verbs: [&quot;watch&quot;]</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">      resources: [&quot;endpoints&quot;, &quot;services&quot;]</span><br><span class="line">  # Don&#39;t log authenticated requests to certain non-resource URL paths.</span><br><span class="line">  - level: None</span><br><span class="line">    userGroups: [&quot;system:authenticated&quot;]</span><br><span class="line">    nonResourceURLs:</span><br><span class="line">    - &quot;&#x2F;api*&quot; # Wildcard matching.</span><br><span class="line">    - &quot;&#x2F;version&quot;</span><br><span class="line">  # Log the request body of configmap changes in kube-system.</span><br><span class="line">  - level: Request</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">      resources: [&quot;configmaps&quot;]</span><br><span class="line">    # This rule only applies to resources in the &quot;kube-system&quot; namespace.</span><br><span class="line">    # The empty string &quot;&quot; can be used to select non-namespaced resources.</span><br><span class="line">    namespaces: [&quot;kube-system&quot;]</span><br><span class="line">  # Log configmap and secret changes in all other namespaces at the Metadata level.</span><br><span class="line">  - level: Metadata</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">      resources: [&quot;secrets&quot;, &quot;configmaps&quot;]</span><br><span class="line">  # Log all other resources in core and extensions at the Request level.</span><br><span class="line">  - level: Request</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">    - group: &quot;extensions&quot; # Version of group should NOT be included.</span><br><span class="line">  # A catch-all rule to log all other requests at the Metadata level.</span><br><span class="line">  - level: Metadata</span><br><span class="line">    # Long-running requests like watches that fall under this rule will not</span><br><span class="line">    # generate an audit event in RequestReceived.</span><br><span class="line">    omitStages:</span><br><span class="line">      - &quot;RequestReceived&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="4-4-3-创建apiserver启动脚本"><a href="#4-4-3-创建apiserver启动脚本" class="headerlink" title="4.4.3 创建apiserver启动脚本"></a>4.4.3 创建apiserver启动脚本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-apiserver.sh &lt;&lt;&#39;EOF&#39;</span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">.&#x2F;kube-apiserver \</span><br><span class="line">  --apiserver-count 2 \</span><br><span class="line">  --audit-log-path &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-apiserver&#x2F;audit-log \</span><br><span class="line">  --audit-policy-file ..&#x2F;conf&#x2F;audit.yaml \</span><br><span class="line">  --authorization-mode RBAC \</span><br><span class="line">  --client-ca-file .&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">  --requestheader-client-ca-file .&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">  --enable-admission-plugins NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota \</span><br><span class="line">  --etcd-cafile .&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">  --etcd-certfile .&#x2F;cert&#x2F;client.pem \</span><br><span class="line">  --etcd-keyfile .&#x2F;cert&#x2F;client-key.pem \</span><br><span class="line">  --etcd-servers https:&#x2F;&#x2F;10.4.7.12:2379,https:&#x2F;&#x2F;10.4.7.21:2379,https:&#x2F;&#x2F;10.4.7.22:2379 \</span><br><span class="line">  --service-account-key-file .&#x2F;cert&#x2F;ca-key.pem \</span><br><span class="line">  --service-cluster-ip-range 192.168.0.0&#x2F;16 \</span><br><span class="line">  --service-node-port-range 3000-29999 \</span><br><span class="line">  --target-ram-mb&#x3D;1024 \</span><br><span class="line">  --kubelet-client-certificate .&#x2F;cert&#x2F;client.pem \</span><br><span class="line">  --kubelet-client-key .&#x2F;cert&#x2F;client-key.pem \</span><br><span class="line">  --log-dir  &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-apiserver \</span><br><span class="line">  --tls-cert-file .&#x2F;cert&#x2F;apiserver.pem \</span><br><span class="line">  --tls-private-key-file .&#x2F;cert&#x2F;apiserver-key.pem \</span><br><span class="line">  --v 2</span><br><span class="line">EOF</span><br><span class="line"># 授权</span><br><span class="line">chmod +x &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-apiserver.sh</span><br></pre></td></tr></table></figure>

<h4 id="4-4-4-创建supervisor启动apiserver的配置"><a href="#4-4-4-创建supervisor启动apiserver的配置" class="headerlink" title="4.4.4 创建supervisor启动apiserver的配置"></a>4.4.4 创建supervisor启动apiserver的配置</h4><p><strong>安装supervisor软件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">yum install supervisor -y</span><br><span class="line">systemctl start supervisord</span><br><span class="line">systemctl enable supervisord</span><br><span class="line">cat &gt;&#x2F;etc&#x2F;supervisord.d&#x2F;kube-apiserver.ini &lt;&lt;EOF</span><br><span class="line">[program:kube-apiserver]      ; 显示的程序名,类似my.cnf,可以有多个</span><br><span class="line">command&#x3D;sh &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-apiserver.sh</span><br><span class="line">numprocs&#x3D;1                    ; 启动进程数 (def 1)</span><br><span class="line">directory&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin</span><br><span class="line">autostart&#x3D;true                ; 是否自启 (default: true)</span><br><span class="line">autorestart&#x3D;true              ; 是否自动重启 (default: true)</span><br><span class="line">startsecs&#x3D;30                  ; 服务运行多久判断为成功(def. 1)</span><br><span class="line">startretries&#x3D;3                ; 启动重试次数 (default 3)</span><br><span class="line">exitcodes&#x3D;0,2                 ; 退出状态码 (default 0,2)</span><br><span class="line">stopsignal&#x3D;QUIT               ; 退出信号 (default TERM)</span><br><span class="line">stopwaitsecs&#x3D;10               ; 退出延迟时间 (default 10)</span><br><span class="line">user&#x3D;root                     ; 运行用户</span><br><span class="line">redirect_stderr&#x3D;true          ; 重定向错误输出到标准输出(def false)</span><br><span class="line">stdout_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-apiserver&#x2F;apiserver.stdout.log</span><br><span class="line">stdout_logfile_maxbytes&#x3D;64MB  ; 日志文件大小 (default 50MB)</span><br><span class="line">stdout_logfile_backups&#x3D;4      ; 日志文件滚动个数 (default 10)</span><br><span class="line">stdout_capture_maxbytes&#x3D;1MB   ; 设定capture管道的大小(default 0)</span><br><span class="line">;子进程还有子进程,需要添加这个参数,避免产生孤儿进程</span><br><span class="line">killasgroup&#x3D;true</span><br><span class="line">stopasgroup&#x3D;true</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="4-4-5-启动apiserver服务并检查"><a href="#4-4-5-启动apiserver服务并检查" class="headerlink" title="4.4.5 启动apiserver服务并检查"></a>4.4.5 启动apiserver服务并检查</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-apiserver</span><br><span class="line">supervisorctl update</span><br><span class="line">supervisorctl status</span><br><span class="line">netstat -nltup|grep kube-api</span><br></pre></td></tr></table></figure>

<h4 id="4-4-6-部署启动所有apiserver机器"><a href="#4-4-6-部署启动所有apiserver机器" class="headerlink" title="4.4.6 部署启动所有apiserver机器"></a>4.4.6 部署启动所有apiserver机器</h4><p>集群其他机器的部署,没有不同的地方,所以略</p>
<h3 id="4-5-部署controller-manager服务"><a href="#4-5-部署controller-manager服务" class="headerlink" title="4.5 部署controller-manager服务"></a>4.5 部署controller-manager服务</h3><p>apiserve、controller-manager、kube-scheduler三个服务所需的软件在同一套压缩包里面的，因此后两个服务不需要在单独解包</p>
<p>而且这三个服务是在同一个主机上，互相之间通过<code>http://127.0.0.1</code>,也不需要证书</p>
<h4 id="4-5-1-创建controller-manager启动脚本"><a href="#4-5-1-创建controller-manager启动脚本" class="headerlink" title="4.5.1 创建controller-manager启动脚本"></a>4.5.1 创建controller-manager启动脚本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-controller-manager.sh &lt;&lt;&#39;EOF&#39;</span><br><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">.&#x2F;kube-controller-manager \</span><br><span class="line">  --cluster-cidr 172.7.0.0&#x2F;16 \</span><br><span class="line">  --leader-elect true \</span><br><span class="line">  --log-dir &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-controller-manager \</span><br><span class="line">  --master http:&#x2F;&#x2F;127.0.0.1:8080 \</span><br><span class="line">  --service-account-private-key-file .&#x2F;cert&#x2F;ca-key.pem \</span><br><span class="line">  --service-cluster-ip-range 192.168.0.0&#x2F;16 \</span><br><span class="line">  --root-ca-file .&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">  --v 2 </span><br><span class="line">EOF</span><br><span class="line"># 授权</span><br><span class="line">chmod +x &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-controller-manager.sh</span><br></pre></td></tr></table></figure>

<h4 id="4-5-2-创建supervisor配置"><a href="#4-5-2-创建supervisor配置" class="headerlink" title="4.5.2 创建supervisor配置"></a>4.5.2 创建supervisor配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;etc&#x2F;supervisord.d&#x2F;kube-conntroller-manager.ini &lt;&lt;EOF</span><br><span class="line">[program:kube-controller-manager] ; 显示的程序名</span><br><span class="line">command&#x3D;sh &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-controller-manager.sh</span><br><span class="line">numprocs&#x3D;1                    ; 启动进程数 (def 1)</span><br><span class="line">directory&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin</span><br><span class="line">autostart&#x3D;true                ; 是否自启 (default: true)</span><br><span class="line">autorestart&#x3D;true              ; 是否自动重启 (default: true)</span><br><span class="line">startsecs&#x3D;30                  ; 服务运行多久判断为成功(def. 1)</span><br><span class="line">startretries&#x3D;3                ; 启动重试次数 (default 3)</span><br><span class="line">exitcodes&#x3D;0,2                 ; 退出状态码 (default 0,2)</span><br><span class="line">stopsignal&#x3D;QUIT               ; 退出信号 (default TERM)</span><br><span class="line">stopwaitsecs&#x3D;10               ; 退出延迟时间 (default 10)</span><br><span class="line">user&#x3D;root                     ; 运行用户</span><br><span class="line">redirect_stderr&#x3D;true          ; 重定向错误输出到标准输出(def false)</span><br><span class="line">stdout_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-controller-manager&#x2F;controller.stdout.log</span><br><span class="line">stdout_logfile_maxbytes&#x3D;64MB  ; 日志文件大小 (default 50MB)</span><br><span class="line">stdout_logfile_backups&#x3D;4      ; 日志文件滚动个数 (default 10)</span><br><span class="line">stdout_capture_maxbytes&#x3D;1MB   ; 设定capture管道的大小(default 0)</span><br><span class="line">;子进程还有子进程,需要添加这个参数,避免产生孤儿进程</span><br><span class="line">killasgroup&#x3D;true</span><br><span class="line">stopasgroup&#x3D;true</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="4-5-3-启动服务并检查"><a href="#4-5-3-启动服务并检查" class="headerlink" title="4.5.3 启动服务并检查"></a>4.5.3 启动服务并检查</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-controller-manager</span><br><span class="line">supervisorctl update</span><br><span class="line">supervisorctl status</span><br></pre></td></tr></table></figure>

<h4 id="4-5-4-部署启动所有集群"><a href="#4-5-4-部署启动所有集群" class="headerlink" title="4.5.4 部署启动所有集群"></a>4.5.4 部署启动所有集群</h4><p>没有不同的地方,所以略</p>
<h3 id="4-6-部署kube-scheduler服务"><a href="#4-6-部署kube-scheduler服务" class="headerlink" title="4.6 部署kube-scheduler服务"></a>4.6 部署kube-scheduler服务</h3><h4 id="4-6-1-创建启动脚本"><a href="#4-6-1-创建启动脚本" class="headerlink" title="4.6.1 创建启动脚本"></a>4.6.1 创建启动脚本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-scheduler.sh &lt;&lt;&#39;EOF&#39;</span><br><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">.&#x2F;kube-scheduler \</span><br><span class="line">  --leader-elect  \</span><br><span class="line">  --log-dir &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-scheduler \</span><br><span class="line">  --master http:&#x2F;&#x2F;127.0.0.1:8080 \</span><br><span class="line">  --v 2</span><br><span class="line">EOF</span><br><span class="line"># 授权</span><br><span class="line">chmod +x  &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-scheduler.sh</span><br></pre></td></tr></table></figure>

<h4 id="4-6-2-创建supervisor配置"><a href="#4-6-2-创建supervisor配置" class="headerlink" title="4.6.2 创建supervisor配置"></a>4.6.2 创建supervisor配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;etc&#x2F;supervisord.d&#x2F;kube-scheduler.ini &lt;&lt;EOF</span><br><span class="line">[program:kube-scheduler]</span><br><span class="line">command&#x3D;sh &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-scheduler.sh</span><br><span class="line">numprocs&#x3D;1                    ; 启动进程数 (def 1)</span><br><span class="line">directory&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin</span><br><span class="line">autostart&#x3D;true                ; 是否自启 (default: true)</span><br><span class="line">autorestart&#x3D;true              ; 是否自动重启 (default: true)</span><br><span class="line">startsecs&#x3D;30                  ; 服务运行多久判断为成功(def. 1)</span><br><span class="line">startretries&#x3D;3                ; 启动重试次数 (default 3)</span><br><span class="line">exitcodes&#x3D;0,2                 ; 退出状态码 (default 0,2)</span><br><span class="line">stopsignal&#x3D;QUIT               ; 退出信号 (default TERM)</span><br><span class="line">stopwaitsecs&#x3D;10               ; 退出延迟时间 (default 10)</span><br><span class="line">user&#x3D;root                     ; 运行用户</span><br><span class="line">redirect_stderr&#x3D;true          ; 重定向错误输出到标准输出(def false)</span><br><span class="line">stdout_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-scheduler&#x2F;scheduler.stdout.log</span><br><span class="line">stdout_logfile_maxbytes&#x3D;64MB  ; 日志文件大小 (default 50MB)</span><br><span class="line">stdout_logfile_backups&#x3D;4      ; 日志文件滚动个数 (default 10)</span><br><span class="line">stdout_capture_maxbytes&#x3D;1MB   ; 设定capture管道的大小(default 0)</span><br><span class="line">;子进程还有子进程,需要添加这个参数,避免产生孤儿进程</span><br><span class="line">killasgroup&#x3D;true</span><br><span class="line">stopasgroup&#x3D;true</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="4-6-3-启动服务并检查"><a href="#4-6-3-启动服务并检查" class="headerlink" title="4.6.3 启动服务并检查"></a>4.6.3 启动服务并检查</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-scheduler</span><br><span class="line">supervisorctl update</span><br><span class="line">supervisorctl status</span><br></pre></td></tr></table></figure>

<h4 id="4-6-4-部署启动所有集群"><a href="#4-6-4-部署启动所有集群" class="headerlink" title="4.6.4 部署启动所有集群"></a>4.6.4 部署启动所有集群</h4><p>没有不同的地方,所以略</p>
<h3 id="4-7-检查master节点部署情况"><a href="#4-7-检查master节点部署情况" class="headerlink" title="4.7 检查master节点部署情况"></a>4.7 检查master节点部署情况</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# kubectl get cs</span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">controller-manager   Healthy   ok                   </span><br><span class="line">scheduler            Healthy   ok                   </span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-部署4层反代去代理apiserver"><a href="#5-部署4层反代去代理apiserver" class="headerlink" title="5 部署4层反代去代理apiserver"></a>5 部署4层反代去代理apiserver</h2><p>master节点上的3套服务部署完成后,需要使用反向代理去统一两个apiservser的对外端口</p>
<p>这里使用nginx+keepalived的高可用架构部署在<code>7.11</code>和<code>7.12</code>两台机器上</p>
<h3 id="5-1-部署nginx四层反代"><a href="#5-1-部署nginx四层反代" class="headerlink" title="5.1 部署nginx四层反代"></a>5.1 部署nginx四层反代</h3><p>使用7443端口代理apiserver的6443端口,使用keepalived管理VIP<code>10.4.7.10</code></p>
<h4 id="5-1-1-yum安装程序"><a href="#5-1-1-yum安装程序" class="headerlink" title="5.1.1 yum安装程序"></a>5.1.1 yum安装程序</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install nginx keepalived -y</span><br></pre></td></tr></table></figure>

<h4 id="5-1-2-配置NGINX"><a href="#5-1-2-配置NGINX" class="headerlink" title="5.1.2 配置NGINX"></a>5.1.2 配置NGINX</h4><p>四层代理不能写在默认的<code>conf.d</code>目录下,因为这个目录默认是数据http模块的include</p>
<p>所以要么把四层代理写到主配置文件最下面,要么模仿七层代理创建一个四层代理文件夹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 1. 在nginx配置文件中增加四层代理配置文件夹</span><br><span class="line">mkdir &#x2F;etc&#x2F;nginx&#x2F;tcp.d&#x2F;</span><br><span class="line">echo &#39;include &#x2F;etc&#x2F;nginx&#x2F;tcp.d&#x2F;*.conf;&#39; &gt;&gt;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line"># 写入代理配置</span><br><span class="line">cat &gt;&#x2F;etc&#x2F;nginx&#x2F;tcp.d&#x2F;apiserver.conf &lt;&lt;EOF</span><br><span class="line">stream &#123;</span><br><span class="line">    upstream kube-apiserver &#123;</span><br><span class="line">        server 10.4.7.21:6443     max_fails&#x3D;3 fail_timeout&#x3D;30s;</span><br><span class="line">        server 10.4.7.22:6443     max_fails&#x3D;3 fail_timeout&#x3D;30s;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 7443;</span><br><span class="line">        proxy_connect_timeout 2s;</span><br><span class="line">        proxy_timeout 900s;</span><br><span class="line">        proxy_pass kube-apiserver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="5-1-3-启动nginx"><a href="#5-1-3-启动nginx" class="headerlink" title="5.1.3 启动nginx"></a>5.1.3 启动nginx</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nginx -t</span><br><span class="line">systemctl start nginx</span><br><span class="line">systemctl enable nginx</span><br></pre></td></tr></table></figure>

<h3 id="5-2-配置keepalived"><a href="#5-2-配置keepalived" class="headerlink" title="5.2 配置keepalived"></a>5.2 配置keepalived</h3><h4 id="5-2-1-创建端口监测脚本"><a href="#5-2-1-创建端口监测脚本" class="headerlink" title="5.2.1 创建端口监测脚本"></a>5.2.1 创建端口监测脚本</h4><p>创建脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;etc&#x2F;keepalived&#x2F;check_port.sh &lt;&lt;&#39;EOF&#39;</span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">#keepalived 监控端口脚本</span><br><span class="line">#使用方法：等待keepalived传入端口参数,检查改端口是否存在并返回结果</span><br><span class="line">CHK_PORT&#x3D;$1</span><br><span class="line">if [ -n &quot;$CHK_PORT&quot; ];then</span><br><span class="line">        PORT_PROCESS&#x3D;&#96;ss -lnt|grep $CHK_PORT|wc -l&#96;</span><br><span class="line">        if [ $PORT_PROCESS -eq 0 ];then</span><br><span class="line">                echo &quot;Port $CHK_PORT Is Not Used,End.&quot;</span><br><span class="line">                exit 1</span><br><span class="line">        fi</span><br><span class="line">else</span><br><span class="line">        echo &quot;Check Port Cant Be Empty!&quot;</span><br><span class="line">fi</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>给与脚本执行权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x &#x2F;etc&#x2F;keepalived&#x2F;check_port.sh</span><br></pre></td></tr></table></figure>

<h4 id="5-2-2-创建keepalived主配置文件"><a href="#5-2-2-创建keepalived主配置文件" class="headerlink" title="5.2.2 创建keepalived主配置文件"></a>5.2.2 创建<code>keepalived主</code>配置文件</h4><p>主机定义为<code>10.4.7.11</code>,从机定义为<code>10.4.7.12</code></p>
<p>注意:主配置文件添加了<code>nopreempt</code>参数,非抢占式,意味着VIP发生漂移后,主重新启动后也不会夺回VIP,目的是为了稳定性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;etc&#x2F;keepalived&#x2F;keepalived.conf &lt;&lt;&#39;EOF&#39;</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id 10.4.7.11</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    script &quot;&#x2F;etc&#x2F;keepalived&#x2F;check_port.sh 7443&quot;</span><br><span class="line">    interval 2</span><br><span class="line">    weight -20</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 251</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    mcast_src_ip 10.4.7.11</span><br><span class="line">    nopreempt</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 11111111</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">         chk_nginx</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.4.7.10</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="5-2-3-创建keepalived从配置文件"><a href="#5-2-3-创建keepalived从配置文件" class="headerlink" title="5.2.3 创建keepalived从配置文件"></a>5.2.3 创建<code>keepalived从</code>配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;etc&#x2F;keepalived&#x2F;keepalived.conf &lt;&lt;&#39;EOF&#39;</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id 10.4.7.12</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    script &quot;&#x2F;etc&#x2F;keepalived&#x2F;check_port.sh 7443&quot;</span><br><span class="line">    interval 2</span><br><span class="line">    weight -20</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 251</span><br><span class="line">    mcast_src_ip 10.4.7.12</span><br><span class="line">    priority 90</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 11111111</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_nginx</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.4.7.10</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="5-3-4-启动keepalived并验证"><a href="#5-3-4-启动keepalived并验证" class="headerlink" title="5.3.4 启动keepalived并验证"></a>5.3.4 启动keepalived并验证</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start  keepalived</span><br><span class="line">systemctl enable keepalived</span><br><span class="line">ip addr|grep &#39;10.4.7.10&#39;</span><br></pre></td></tr></table></figure>

<h2 id="6-部署node节点"><a href="#6-部署node节点" class="headerlink" title="6 部署node节点"></a>6 部署node节点</h2><h3 id="6-1-签发kubelet证书"><a href="#6-1-签发kubelet证书" class="headerlink" title="6.1 签发kubelet证书"></a>6.1 签发kubelet证书</h3><p>签发证书,都在<code>7.200</code>上</p>
<h4 id="6-1-1-创建生成证书csr的json配置文件"><a href="#6-1-1-创建生成证书csr的json配置文件" class="headerlink" title="6.1.1 创建生成证书csr的json配置文件"></a>6.1.1 创建生成证书csr的json配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;certs&#x2F;</span><br><span class="line">cat &gt;&#x2F;opt&#x2F;certs&#x2F;kubelet-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;k8s-kubelet&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;10.4.7.10&quot;,</span><br><span class="line">    &quot;10.4.7.21&quot;,</span><br><span class="line">    &quot;10.4.7.22&quot;,</span><br><span class="line">    &quot;10.4.7.23&quot;,</span><br><span class="line">    &quot;10.4.7.24&quot;,</span><br><span class="line">    &quot;10.4.7.25&quot;,</span><br><span class="line">    &quot;10.4.7.26&quot;,</span><br><span class="line">    &quot;10.4.7.27&quot;,</span><br><span class="line">    &quot;10.4.7.28&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;zq&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="6-1-2-生成kubelet证书文件"><a href="#6-1-2-生成kubelet证书文件" class="headerlink" title="6.1.2 生成kubelet证书文件"></a>6.1.2 生成kubelet证书文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert \</span><br><span class="line">      -ca&#x3D;ca.pem \</span><br><span class="line">      -ca-key&#x3D;ca-key.pem \</span><br><span class="line">      -config&#x3D;ca-config.json \</span><br><span class="line">      -profile&#x3D;server \</span><br><span class="line">      kubelet-csr.json | cfssl-json -bare kubelet</span><br><span class="line">[root@hdss7-200 certs]# ll |grep kubelet</span><br><span class="line">-rw-r--r-- 1 root root 1115 Apr 22 22:17 kubelet.csr</span><br><span class="line">-rw-r--r-- 1 root root  452 Apr 22 22:17 kubelet-csr.json</span><br><span class="line">-rw------- 1 root root 1679 Apr 22 22:17 kubelet-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1460 Apr 22 22:17 kubelet.pem</span><br></pre></td></tr></table></figure>

<h3 id="6-2-创建kubelet服务"><a href="#6-2-创建kubelet服务" class="headerlink" title="6.2 创建kubelet服务"></a>6.2 创建kubelet服务</h3><h4 id="6-2-1-拷贝证书至node节点"><a href="#6-2-1-拷贝证书至node节点" class="headerlink" title="6.2.1 拷贝证书至node节点"></a>6.2.1 拷贝证书至node节点</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert</span><br><span class="line">scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;kubelet.pem .</span><br><span class="line">scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;kubelet-key.pem .</span><br></pre></td></tr></table></figure>

<h4 id="6-2-2-创建kubelet配置"><a href="#6-2-2-创建kubelet配置" class="headerlink" title="6.2.2 创建kubelet配置"></a>6.2.2 创建kubelet配置</h4><p>创建kubelet的配置文件<code>kubelet.kubeconfig</code>比较麻烦,需要四步操作才能完成</p>
<p>(1) set-cluster(<strong>设置集群参数</strong>)</p>
<p>使用ca证书创建集群<code>myk8s</code>,使用的apiserver信息是<code>10.4.7.10</code>这个VIP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;conf&#x2F;</span><br><span class="line">kubectl config set-cluster myk8s \</span><br><span class="line">    --certificate-authority&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">    --embed-certs&#x3D;true \</span><br><span class="line">    --server&#x3D;https:&#x2F;&#x2F;10.4.7.10:7443 \</span><br><span class="line">    --kubeconfig&#x3D;kubelet.kubeconfig</span><br></pre></td></tr></table></figure>

<p>(2) set-credentials(<strong>设置客户端认证参数</strong>)</p>
<p>使用client证书创建用户<code>k8s-node</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-credentials k8s-node \</span><br><span class="line">    --client-certificate&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;client.pem \</span><br><span class="line">    --client-key&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;client-key.pem \</span><br><span class="line">    --embed-certs&#x3D;true \</span><br><span class="line">    --kubeconfig&#x3D;kubelet.kubeconfig</span><br></pre></td></tr></table></figure>

<p>(3) set-context(<strong>绑定namespace</strong>)</p>
<p>创建<code>myk8s-context</code>,关联集群<code>myk8s</code>和用户<code>k8s-node</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-context myk8s-context \</span><br><span class="line">    --cluster&#x3D;myk8s \</span><br><span class="line">    --user&#x3D;k8s-node \</span><br><span class="line">    --kubeconfig&#x3D;kubelet.kubeconfig</span><br></pre></td></tr></table></figure>

<p>(4) use-context</p>
<p>使用生成的配置文件向apiserver注册,注册信息会写入etcd,所以只需要注册一次即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl config use-context myk8s-context --kubeconfig&#x3D;kubelet.kubeconfig</span><br></pre></td></tr></table></figure>

<p>(5) 查看生成的<code>kubelet.kubeconfig</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# cat kubelet.kubeconfig </span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: xxxxxxxx</span><br><span class="line">    server: https:&#x2F;&#x2F;10.4.7.10:7443</span><br><span class="line">  name: myk8s</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: myk8s</span><br><span class="line">    user: k8s-node</span><br><span class="line">  name: myk8s-context</span><br><span class="line">current-context: myk8s-context</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: k8s-node</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: xxxxxxxx</span><br><span class="line">    client-key-data: xxxxxxxx</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以看出来,这个配置文件里面包含了集群名字,用户名字,集群认证的公钥,用户的公私钥等</p>
</blockquote>
<h4 id="6-2-3-创建k8s-node-yaml配置文件"><a href="#6-2-3-创建k8s-node-yaml配置文件" class="headerlink" title="6.2.3 创建k8s-node.yaml配置文件"></a>6.2.3 创建k8s-node.yaml配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;conf&#x2F;k8s-node.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: k8s-node</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:node</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: User</span><br><span class="line">  name: k8s-node</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用RBAC鉴权规则,创建了一个<code>ClusterRoleBinding</code>的资源</p>
<p>此资源中定义了一个<code>user</code>叫<code>k8s-node</code></p>
<p>给<code>k8s-node</code>用户绑定了角色<code>ClusterRole</code>,角色名为<code>system:node</code></p>
<p>使这个用户具有成为集群运算节点角色的权限</p>
<p>由于这个用户名,同时也是<code>kubeconfig</code>中指定的用户,</p>
<p>所以通过<code>kubeconfig</code>配置启动的<code>kubelet</code>节点,就能够成为node节点</p>
</blockquote>
<h4 id="6-2-4-应用资源配置"><a href="#6-2-4-应用资源配置" class="headerlink" title="6.2.4 应用资源配置"></a>6.2.4 应用资源配置</h4><p>应用资源配置,并查看结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># 应用资源配置</span><br><span class="line">kubectl create -f &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;conf&#x2F;k8s-node.yaml</span><br><span class="line"># 查看集群角色和角色属性</span><br><span class="line">[root@hdss7-21 conf]# kubectl get clusterrolebinding k8s-node</span><br><span class="line">NAME       AGE</span><br><span class="line">k8s-node   13s</span><br><span class="line">[root@hdss7-21 conf]# kubectl get clusterrolebinding k8s-node -o yaml</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: &quot;2020-04-22T14:38:09Z&quot;</span><br><span class="line">  name: k8s-node</span><br><span class="line">  resourceVersion: &quot;21217&quot;</span><br><span class="line">  selfLink: &#x2F;apis&#x2F;rbac.authorization.k8s.io&#x2F;v1&#x2F;clusterrolebindings&#x2F;k8s-node</span><br><span class="line">  uid: 597ffb0f-f92d-4eb5-aca2-2fe73397e2e4</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:node</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: User</span><br><span class="line">  name: k8s-node</span><br><span class="line">  </span><br><span class="line">#此时只是创建了相应的资源,还没有具体的node,如下验证</span><br><span class="line">[root@hdss7-21 conf]# kubectl get nodes</span><br><span class="line">No resources found.</span><br></pre></td></tr></table></figure>

<h4 id="6-2-5-创建kubelet启动脚本"><a href="#6-2-5-创建kubelet启动脚本" class="headerlink" title="6.2.5 创建kubelet启动脚本"></a>6.2.5 创建kubelet启动脚本</h4><p><code>--hostname-override</code>参数每个node节点都一样,是节点的主机名,注意修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kubelet.sh &lt;&lt;&#39;EOF&#39;</span><br><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">.&#x2F;kubelet \</span><br><span class="line">  --hostname-override hdss7-21.host.com \</span><br><span class="line">  --anonymous-auth&#x3D;false \</span><br><span class="line">  --cgroup-driver systemd \</span><br><span class="line">  --cluster-dns 192.168.0.2 \</span><br><span class="line">  --cluster-domain cluster.local \</span><br><span class="line">  --runtime-cgroups&#x3D;&#x2F;systemd&#x2F;system.slice \</span><br><span class="line">  --kubelet-cgroups&#x3D;&#x2F;systemd&#x2F;system.slice \</span><br><span class="line">  --fail-swap-on&#x3D;&quot;false&quot; \</span><br><span class="line">  --client-ca-file .&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">  --tls-cert-file .&#x2F;cert&#x2F;kubelet.pem \</span><br><span class="line">  --tls-private-key-file .&#x2F;cert&#x2F;kubelet-key.pem \</span><br><span class="line">  --image-gc-high-threshold 20 \</span><br><span class="line">  --image-gc-low-threshold 10 \</span><br><span class="line">  --kubeconfig ..&#x2F;conf&#x2F;kubelet.kubeconfig \</span><br><span class="line">  --log-dir &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-kubelet \</span><br><span class="line">  --pod-infra-container-image harbor.zq.com&#x2F;public&#x2F;pause:latest \</span><br><span class="line">  --root-dir &#x2F;data&#x2F;kubelet</span><br><span class="line">EOF</span><br><span class="line"># 创建目录&amp;授权</span><br><span class="line">chmod +x &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kubelet.sh</span><br><span class="line">mkdir -p &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-kubelet</span><br><span class="line">mkdir -p &#x2F;data&#x2F;kubelet</span><br></pre></td></tr></table></figure>

<h4 id="6-2-6-创建supervisor配置"><a href="#6-2-6-创建supervisor配置" class="headerlink" title="6.2.6 创建supervisor配置"></a>6.2.6 创建supervisor配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;etc&#x2F;supervisord.d&#x2F;kube-kubelet.ini  &lt;&lt;EOF</span><br><span class="line">[program:kube-kubelet]</span><br><span class="line">command&#x3D;sh &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kubelet.sh</span><br><span class="line">numprocs&#x3D;1                    ; 启动进程数 (def 1)</span><br><span class="line">directory&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin    </span><br><span class="line">autostart&#x3D;true                ; 是否自启 (default: true)</span><br><span class="line">autorestart&#x3D;true              ; 是否自动重启 (default: true)</span><br><span class="line">startsecs&#x3D;30                  ; 服务运行多久判断为成功(def. 1)</span><br><span class="line">startretries&#x3D;3                ; 启动重试次数 (default 3)</span><br><span class="line">exitcodes&#x3D;0,2                 ; 退出状态码 (default 0,2)</span><br><span class="line">stopsignal&#x3D;QUIT               ; 退出信号 (default TERM)</span><br><span class="line">stopwaitsecs&#x3D;10               ; 退出延迟时间 (default 10)</span><br><span class="line">user&#x3D;root                     ; 运行用户</span><br><span class="line">redirect_stderr&#x3D;true          ; 重定向错误输出到标准输出(def false)</span><br><span class="line">stdout_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-kubelet&#x2F;kubelet.stdout.log</span><br><span class="line">stdout_logfile_maxbytes&#x3D;64MB  ; 日志文件大小 (default 50MB)</span><br><span class="line">stdout_logfile_backups&#x3D;4      ; 日志文件滚动个数 (default 10)</span><br><span class="line">stdout_capture_maxbytes&#x3D;1MB   ; 设定capture管道的大小(default 0)</span><br><span class="line">;子进程还有子进程,需要添加这个参数,避免产生孤儿进程</span><br><span class="line">killasgroup&#x3D;true</span><br><span class="line">stopasgroup&#x3D;true</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="6-2-7-启动服务并检查"><a href="#6-2-7-启动服务并检查" class="headerlink" title="6.2.7 启动服务并检查"></a>6.2.7 启动服务并检查</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">supervisorctl update</span><br><span class="line">supervisorctl status</span><br><span class="line">[root@hdss7-21 server]# kubectl get nodes</span><br><span class="line">NAME                STATUS   ROLES    AGE   VERSION</span><br><span class="line">hdss7-21.host.com   Ready    &lt;none&gt;   65s   v1.15.5</span><br></pre></td></tr></table></figure>

<h4 id="6-2-8-部署其他node节点"><a href="#6-2-8-部署其他node节点" class="headerlink" title="6.2.8 部署其他node节点"></a>6.2.8 部署其他node节点</h4><p>第一个节点部署完成后,其他节点就要简单很多,只需拷贝<code>kubelet.kubeconfig</code>配置到本地后,创建启动脚本并用`supervisord启动即可</p>
<p>也可以不拷贝配置文件,就需要手动再执行创建配置文件的四步</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 拷贝证书</span><br><span class="line">cd &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert</span><br><span class="line">scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;kubelet.pem .</span><br><span class="line">scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;kubelet-key.pem .</span><br><span class="line"># 拷贝配置文件</span><br><span class="line">cd &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;conf&#x2F;</span><br><span class="line">scp hdss7-21:&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;conf&#x2F;kubelet.kubeconfig .</span><br></pre></td></tr></table></figure>

<p>拷贝完配置后,剩下的步骤参考<code>6.2.5 创建kubelet启动脚本</code>,除脚本中<code>--hostname-override</code>不同外,其他都一样</p>
<h4 id="6-2-9-检查所有节点并给节点打上标签"><a href="#6-2-9-检查所有节点并给节点打上标签" class="headerlink" title="6.2.9 检查所有节点并给节点打上标签"></a>6.2.9 检查所有节点并给节点打上标签</h4><p>此操作非必须,因为只是打的一个标签,方便识别而已</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line">kubectl label node hdss7-21.host.com node-role.kubernetes.io&#x2F;master&#x3D;</span><br><span class="line">kubectl label node hdss7-21.host.com node-role.kubernetes.io&#x2F;node&#x3D;</span><br><span class="line">[root@hdss7-22 cert]# kubectl get nodes</span><br><span class="line">NAME                STATUS   ROLES         AGE   VERSION</span><br><span class="line">hdss7-21.host.com   Ready    master,node   9m    v1.15.5</span><br><span class="line">hdss7-22.host.com   Ready    &lt;none&gt;        64s   v1.15.5</span><br></pre></td></tr></table></figure>

<h3 id="6-3-创建kube-proxy服务"><a href="#6-3-创建kube-proxy服务" class="headerlink" title="6.3 创建kube-proxy服务"></a>6.3 创建kube-proxy服务</h3><p>签发证书在<code>7.200</code>上</p>
<h4 id="6-3-1-签发kube-proxy证书"><a href="#6-3-1-签发kube-proxy证书" class="headerlink" title="6.3.1 签发kube-proxy证书"></a>6.3.1 签发kube-proxy证书</h4><p>(1) 创建生成证书csr的json配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;certs&#x2F;</span><br><span class="line">cat &gt;&#x2F;opt&#x2F;certs&#x2F;kube-proxy-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;zq&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>(2) 生成kube-proxy证书文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert \</span><br><span class="line">      -ca&#x3D;ca.pem \</span><br><span class="line">      -ca-key&#x3D;ca-key.pem \</span><br><span class="line">      -config&#x3D;ca-config.json \</span><br><span class="line">      -profile&#x3D;client \</span><br><span class="line">      kube-proxy-csr.json |cfssl-json -bare kube-proxy-client</span><br></pre></td></tr></table></figure>

<p>(3) 检查生成的证书文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# ll |grep proxy</span><br><span class="line">-rw-r--r-- 1 root root 1005 Apr 22 22:54 kube-proxy-client.csr</span><br><span class="line">-rw------- 1 root root 1675 Apr 22 22:54 kube-proxy-client-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1371 Apr 22 22:54 kube-proxy-client.pem</span><br><span class="line">-rw-r--r-- 1 root root  267 Apr 22 22:54 kube-proxy-csr.json</span><br></pre></td></tr></table></figure>

<h4 id="6-3-2-拷贝证书文件至各节点"><a href="#6-3-2-拷贝证书文件至各节点" class="headerlink" title="6.3.2 拷贝证书文件至各节点"></a>6.3.2 拷贝证书文件至各节点</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert</span><br><span class="line">scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;kube-proxy-client.pem .</span><br><span class="line">scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;kube-proxy-client-key.pem .</span><br></pre></td></tr></table></figure>

<h4 id="6-3-3-创建kube-proxy配置"><a href="#6-3-3-创建kube-proxy配置" class="headerlink" title="6.3.3 创建kube-proxy配置"></a>6.3.3 创建kube-proxy配置</h4><p>同样是四步操作,类似kubelet</p>
<p>(1) set-cluster</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;conf&#x2F;</span><br><span class="line">kubectl config set-cluster myk8s \</span><br><span class="line">    --certificate-authority&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">    --embed-certs&#x3D;true \</span><br><span class="line">    --server&#x3D;https:&#x2F;&#x2F;10.4.7.10:7443 \</span><br><span class="line">    --kubeconfig&#x3D;kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<p>(2) set-credentials</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-credentials kube-proxy \</span><br><span class="line">    --client-certificate&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;kube-proxy-client.pem \</span><br><span class="line">    --client-key&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;kube-proxy-client-key.pem \</span><br><span class="line">    --embed-certs&#x3D;true \</span><br><span class="line">    --kubeconfig&#x3D;kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<p>(3) set-context</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-context myk8s-context \</span><br><span class="line">    --cluster&#x3D;myk8s \</span><br><span class="line">    --user&#x3D;kube-proxy \</span><br><span class="line">    --kubeconfig&#x3D;kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<p>(4) use-context</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl config use-context myk8s-context --kubeconfig&#x3D;kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<h4 id="6-3-4-加载ipvs模块以备kube-proxy启动用"><a href="#6-3-4-加载ipvs模块以备kube-proxy启动用" class="headerlink" title="6.3.4 加载ipvs模块以备kube-proxy启动用"></a>6.3.4 加载ipvs模块以备kube-proxy启动用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 创建开机ipvs脚本</span><br><span class="line">cat &gt;&#x2F;etc&#x2F;ipvs.sh &lt;&lt;&#39;EOF&#39;</span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">ipvs_mods_dir&#x3D;&quot;&#x2F;usr&#x2F;lib&#x2F;modules&#x2F;$(uname -r)&#x2F;kernel&#x2F;net&#x2F;netfilter&#x2F;ipvs&quot;</span><br><span class="line">for i in $(ls $ipvs_mods_dir|grep -o &quot;^[^.]*&quot;)</span><br><span class="line">do</span><br><span class="line">  &#x2F;sbin&#x2F;modinfo -F filename $i &amp;&gt;&#x2F;dev&#x2F;null</span><br><span class="line">  if [ $? -eq 0 ];then</span><br><span class="line">    &#x2F;sbin&#x2F;modprobe $i</span><br><span class="line">  fi</span><br><span class="line">done</span><br><span class="line">EOF</span><br><span class="line"># 执行脚本开启ipvs</span><br><span class="line">sh &#x2F;etc&#x2F;ipvs.sh </span><br><span class="line"># 验证开启结果</span><br><span class="line">[root@hdss7-21 conf]# lsmod |grep ip_vs</span><br><span class="line">ip_vs_wrr              12697  0 </span><br><span class="line">ip_vs_wlc              12519  0 </span><br><span class="line">......略</span><br></pre></td></tr></table></figure>

<h4 id="6-3-5-创建kube-proxy启动脚本"><a href="#6-3-5-创建kube-proxy启动脚本" class="headerlink" title="6.3.5 创建kube-proxy启动脚本"></a>6.3.5 创建kube-proxy启动脚本</h4><p>同上,<code>--hostname-override</code>参数在不同的node节点上不一样,需修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-proxy.sh &lt;&lt;&#39;EOF&#39;</span><br><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">.&#x2F;kube-proxy \</span><br><span class="line">  --hostname-override hdss7-21.host.com \</span><br><span class="line">  --cluster-cidr 172.7.0.0&#x2F;16 \</span><br><span class="line">  --proxy-mode&#x3D;ipvs \</span><br><span class="line">  --ipvs-scheduler&#x3D;nq \</span><br><span class="line">  --kubeconfig ..&#x2F;conf&#x2F;kube-proxy.kubeconfig</span><br><span class="line">EOF</span><br><span class="line"># 授权</span><br><span class="line">chmod +x &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-proxy.sh</span><br></pre></td></tr></table></figure>

<h4 id="6-3-6-创建kube-proxy的supervisor配置"><a href="#6-3-6-创建kube-proxy的supervisor配置" class="headerlink" title="6.3.6 创建kube-proxy的supervisor配置"></a>6.3.6 创建kube-proxy的supervisor配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;etc&#x2F;supervisord.d&#x2F;kube-proxy.ini &lt;&lt;&#39;EOF&#39;</span><br><span class="line">[program:kube-proxy]</span><br><span class="line">command&#x3D;sh &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-proxy.sh</span><br><span class="line">numprocs&#x3D;1                    ; 启动进程数 (def 1)</span><br><span class="line">directory&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin</span><br><span class="line">autostart&#x3D;true                ; 是否自启 (default: true)</span><br><span class="line">autorestart&#x3D;true              ; 是否自动重启 (default: true)</span><br><span class="line">startsecs&#x3D;30                  ; 服务运行多久判断为成功(def. 1)</span><br><span class="line">startretries&#x3D;3                ; 启动重试次数 (default 3)</span><br><span class="line">exitcodes&#x3D;0,2                 ; 退出状态码 (default 0,2)</span><br><span class="line">stopsignal&#x3D;QUIT               ; 退出信号 (default TERM)</span><br><span class="line">stopwaitsecs&#x3D;10               ; 退出延迟时间 (default 10)</span><br><span class="line">user&#x3D;root                     ; 运行用户</span><br><span class="line">redirect_stderr&#x3D;true          ; 重定向错误输出到标准输出(def false)</span><br><span class="line">stdout_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-proxy&#x2F;proxy.stdout.log</span><br><span class="line">stdout_logfile_maxbytes&#x3D;64MB  ; 日志文件大小 (default 50MB)</span><br><span class="line">stdout_logfile_backups&#x3D;4      ; 日志文件滚动个数 (default 10)</span><br><span class="line">stdout_capture_maxbytes&#x3D;1MB   ; 设定capture管道的大小(default 0)</span><br><span class="line">;子进程还有子进程,需要添加这个参数,避免产生孤儿进程</span><br><span class="line">killasgroup&#x3D;true</span><br><span class="line">stopasgroup&#x3D;true</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="6-3-7-启动服务并检查"><a href="#6-3-7-启动服务并检查" class="headerlink" title="6.3.7 启动服务并检查"></a>6.3.7 启动服务并检查</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-proxy</span><br><span class="line">supervisorctl update</span><br><span class="line">supervisorctl status</span><br><span class="line">[root@hdss7-21 conf]# kubectl get svc</span><br><span class="line">NAME         TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes   ClusterIP   192.168.0.1   &lt;none&gt;        443&#x2F;TCP   47h</span><br><span class="line"># 检查ipvs,是否新增了配置</span><br><span class="line">yum install ipvsadm -y</span><br><span class="line">[root@hdss7-21 conf]# ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size&#x3D;4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  192.168.0.1:443 nq</span><br><span class="line">  -&gt; 10.4.7.21:6443               Masq    1      0          0         </span><br><span class="line">  -&gt; 10.4.7.22:6443               Masq    1      0          0</span><br></pre></td></tr></table></figure>

<h4 id="6-3-8-部署所有节点"><a href="#6-3-8-部署所有节点" class="headerlink" title="6.3.8 部署所有节点"></a>6.3.8 部署所有节点</h4><p>首先需拷贝kube-proxy.kubeconfig 到 hdss7-22.host.com的conf目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 拷贝证书文件</span><br><span class="line">cd &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert</span><br><span class="line">scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;kube-proxy-client.pem .</span><br><span class="line">scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;kube-proxy-client-key.pem .</span><br><span class="line"># 拷贝配置文件</span><br><span class="line">cd &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;conf&#x2F;</span><br><span class="line">scp hdss7-21:&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;conf&#x2F;kube-proxy.kubeconfig .</span><br></pre></td></tr></table></figure>

<p>其他不同的地方就一个主机名,都已经在前面说明了,略</p>
<h2 id="7-验证kubernetes集群"><a href="#7-验证kubernetes集群" class="headerlink" title="7 验证kubernetes集群"></a>7 验证kubernetes集群</h2><h3 id="7-1-在任意一个节点上创建一个资源配置清单"><a href="#7-1-在任意一个节点上创建一个资源配置清单" class="headerlink" title="7.1 在任意一个节点上创建一个资源配置清单"></a>7.1 在任意一个节点上创建一个资源配置清单</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;root&#x2F;nginx-ds.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: harbor.zq.com&#x2F;public&#x2F;nginx:v1.17.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="7-2-应用资源配置，并检查"><a href="#7-2-应用资源配置，并检查" class="headerlink" title="7.2 应用资源配置，并检查"></a>7.2 应用资源配置，并检查</h3><h4 id="7-2-1-应用资源配置"><a href="#7-2-1-应用资源配置" class="headerlink" title="7.2.1 应用资源配置"></a>7.2.1 应用资源配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f &#x2F;root&#x2F;nginx-ds.yaml</span><br><span class="line">[root@hdss7-22 conf]# kubectl get pods</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-ds-j777c   1&#x2F;1     Running   0          8s</span><br><span class="line">nginx-ds-nwsd6   1&#x2F;1     Running   0          8s</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601202918741-2cc5b33b-ce36-4e44-b91f-e12e4c41dc01.png" alt="image"></p>
<h4 id="7-2-2-在另一台node节点上检查"><a href="#7-2-2-在另一台node节点上检查" class="headerlink" title="7.2.2 在另一台node节点上检查"></a>7.2.2 在另一台node节点上检查</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods</span><br><span class="line">kubectl get pods -o wide</span><br><span class="line">curl 172.7.22.2</span><br></pre></td></tr></table></figure>

<h4 id="7-2-3-查看kubernetes是否搭建好"><a href="#7-2-3-查看kubernetes是否搭建好" class="headerlink" title="7.2.3 查看kubernetes是否搭建好"></a>7.2.3 查看kubernetes是否搭建好</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-22 conf]# kubectl get cs</span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">controller-manager   Healthy   ok                   </span><br><span class="line">scheduler            Healthy   ok        </span><br><span class="line">[root@hdss7-21 ~]# kubectl get nodes </span><br><span class="line">NAME                STATUS   ROLES         AGE    VERSION</span><br><span class="line">hdss7-21.host.com   Ready    master,node   6d1h   v1.15.5</span><br><span class="line">hdss7-22.host.com   Ready    &lt;none&gt;        6d1h   v1.15.5</span><br><span class="line">[root@hdss7-22 ~]# kubectl get pods</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-ds-j777c   1&#x2F;1     Running   0          6m45s</span><br><span class="line">nginx-ds-nwsd6   1&#x2F;1     Running   0          6m45s</span><br></pre></td></tr></table></figure>

<p>转载自cnblog:<a href="https://www.cnblogs.com/noah-luo/p/13345164.html" target="_blank" rel="noopener">https://www.cnblogs.com/noah-luo/p/13345164.htm</a>l</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/23/k8s/2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhangpengjie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/zpj.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zpj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/23/k8s/2/" itemprop="url">k8s(00)入门知识介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-23T16:58:48+08:00">
                2020-12-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index">
                    <span itemprop="name">k8s</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/12/23/k8s/2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/12/23/k8s/2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="系列文章说明"><a href="#系列文章说明" class="headerlink" title="系列文章说明"></a>系列文章说明</h1><p>本系列文章是 老男孩2019年王硕的K8S周末班课程笔记,根据视频来看本笔记最好,否则有些地方会看不明白</p>
<h1 id="k8s概念入门"><a href="#k8s概念入门" class="headerlink" title="k8s概念入门"></a>k8s概念入门</h1><p>目录</p>
<ul>
<li><p>系列文章说明</p>
</li>
<li><p>k8s概念入门</p>
</li>
<li><ul>
<li>1 四组基本概念</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>1.1 POD和POD控制器</li>
<li>1.2 Name/Namespace</li>
<li>1.3 Lable/Label选择器</li>
<li>1.4 Service/Ingress</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li>2 核心组件与核心附件</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>2.1 核心组件功能</li>
<li>2.2 K8S的三条网络</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li>3 K8S流程图</li>
</ul>
</li>
</ul>
<p>[K8S中文社区](<a href="http://docs.kubernetes.org.cn/" target="_blank" rel="noopener">http://docs.kubernetes.org.cn/</a></p>
<h2 id="1-四组基本概念"><a href="#1-四组基本概念" class="headerlink" title="1 四组基本概念"></a>1 四组基本概念</h2><ol>
<li>Pod/Pod控制器</li>
<li>Name/Namespace</li>
<li>Lable/Label选择器</li>
<li>Service/Ingress</li>
</ol>
<h3 id="1-1-POD和POD控制器"><a href="#1-1-POD和POD控制器" class="headerlink" title="1.1 POD和POD控制器"></a>1.1 POD和POD控制器</h3><p><a href="https://www.cnblogs.com/both/p/9599841.html" target="_blank" rel="noopener">kubernetes 的pod控制器</a></p>
<ol>
<li>Pod<br>k8s里能够被运行的<strong>最小逻辑单元</strong><br>1个POD里面可以运行多个容器(SideCar 边车模式)<br>POD中的容器共享 UTS/NAT/IPC 名称空间<br>POD和容器颗粒理解为豌豆荚和豌豆</li>
<li>Pod控制器<br>Pod控制器是Pod启动的一种模板<br>用来保证在K8S里启动的Pod始终按预期运行<br>包括副本数\生命周期\健康检查等</li>
<li>常用的Pod控制器:</li>
</ol>
<table>
<thead>
<tr>
<th>控 度器名称</th>
<th>用途简述</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Deployment</strong></td>
<td>用于管理无状态应用,支持滚动更新和回滚</td>
</tr>
<tr>
<td><strong>DaemonSet</strong></td>
<td>确保集群中的每一个节点上只运行一个特定的pod副本</td>
</tr>
<tr>
<td>ReplicaSet</td>
<td>确保pod副本数量符合用户期望的数量状态</td>
</tr>
<tr>
<td>StatefulSet</td>
<td>管理有状态应用</td>
</tr>
<tr>
<td>Job</td>
<td>有状态，一次性任务</td>
</tr>
<tr>
<td>Cronjob(定时任务)</td>
<td>有状态，周期性任务</td>
</tr>
</tbody></table>
<h3 id="1-2-Name-Namespace"><a href="#1-2-Name-Namespace" class="headerlink" title="1.2 Name/Namespace"></a>1.2 Name/Namespace</h3><ol>
<li>NameK8S使用<strong>‘资源’</strong>来定义每一种逻辑概念(功能)每种<strong>‘资源’</strong>都应该有自己的’名称’<strong>‘名称’</strong>通常定义在<strong>‘资源’</strong>的元数据(metadata)信息中资源的配置信息包括</li>
</ol>
<ul>
<li><ul>
<li>API版本(apiVersion)</li>
<li>类别(kind)</li>
<li>元数据(metadata)</li>
<li>定义清单(spec)</li>
<li>状态(status)</li>
</ul>
</li>
</ul>
<ol>
<li>Namespace<br>名称空间用于隔离K8S内各种资源,类似K8S内部的虚拟分组<br>同一个名称空间中,相同资源的名称不能相同<br>默认的名称空间为<code>default</code>,<code>kube-system</code>,<code>kube-public</code><br>查询特定资源,要带上相应的名称空间</li>
</ol>
<h3 id="1-3-Lable-Label选择器"><a href="#1-3-Lable-Label选择器" class="headerlink" title="1.3 Lable/Label选择器"></a>1.3 Lable/Label选择器</h3><ol>
<li>Lable<br>标签的作用是便于分类管理资源对象<br>标签与资源之间是多对多的关系<br>给一个资源多个标签,可以实现不同维度的管理</li>
<li>Lable选择器<br>可以使用标签选择器过滤指定的标签<br>标签选择器有基于等值关系(等于,不等于)和基于集合关系(属于,存在)的两种<br>许多资源都支持内嵌标签选择器字段:<code>matchLables</code>或<code>matchExpressions</code></li>
</ol>
<h3 id="1-4-Service-Ingress"><a href="#1-4-Service-Ingress" class="headerlink" title="1.4 Service/Ingress"></a>1.4 Service/Ingress</h3><ol>
<li><strong>Service(重点)</strong><br>POD会分配IP地址,但IP会随着POD销毁而消失<br>多个同类型POD,IP或端口必然不同,但却相同的服务<br>Service用来提供相同服务POD的对外访问接口<br>Service通过标签选择器来确定作用于哪些POD<br>Service只能提供L4层的调度,即:IP+端口</li>
<li><strong>Ingress(重点)</strong><br>Igress也是用来暴露POD的对外访问接口<br>Igress提供L7层的调度,即http/https<br>Igress可以调度不同业务域,不同URL路径的流量</li>
</ol>
<h2 id="2-核心组件与核心附件"><a href="#2-核心组件与核心附件" class="headerlink" title="2 核心组件与核心附件"></a>2 核心组件与核心附件</h2><ol>
<li>核心组件配置存储中心</li>
</ol>
<ul>
<li><ul>
<li>etcd服务</li>
</ul>
</li>
</ul>
<ol>
<li>主控节点（master）</li>
</ol>
<ul>
<li><ul>
<li>kube-apiserver服务</li>
<li>kube-controller-manager服务</li>
<li>kube-scheduler服务</li>
</ul>
</li>
</ul>
<ol>
<li>运算节点（node）</li>
</ol>
<ul>
<li><ul>
<li>kube-kubelet服务</li>
<li>kube-proxy服务</li>
</ul>
</li>
</ul>
<ol>
<li>CLI客户端<br>kubectl命令行工具</li>
<li>核心附件<br>CNI网络插件（flannel/calico）<br>服务发现插件（coredns）<br>服务暴露插件（traefik）<br>GUI管理插件（daahboard）</li>
</ol>
<h3 id="2-1-核心组件功能"><a href="#2-1-核心组件功能" class="headerlink" title="2.1 核心组件功能"></a>2.1 核心组件功能</h3><ol>
<li>配置存储中心-etcd<br>etcd是一个非关系型数据库，作用类似于zookeeper注册中心<br>用于各种服务的注册和数据缓存</li>
<li>kube-apiserver(master)<br>提供季军管理的REST API接口，包括鉴权、数据校验、集群状态变更<br>负责其他模块之间的数据交互，承担通信枢纽的功能<br>和etcd通信，是资源配额控制的入口<br>提供玩备的集群控制机制</li>
<li>kube-controller-manager<br>由一系列控制器组成,通过apiserver监控整个集群的状态,确保集群处于预期的工作状态<br>是管理所有控制器的控制器</li>
<li>kube-scheduler<br>主要是接收调度POD到合适的node节点上<br>通过apiserver，从etcd中获取资源信息进行调度<br>只负责调度工作，启动工作是node节点上的kubelet负责<br>调度策略：预算策略（predict）、优选策略（priorities）</li>
<li>kube-kubelet<br>定时从apiserver获取节点上POD的期望状态（如副本数量、网络类型、存储空间、容器类型等）然后调用容器平台接口达到这个状态<br>提供POD节点具体使用的网络<br>定时汇报当前节点状态给apiserver，以供调度<br>复制镜像和容器的创建和清理工作</li>
<li>kube-proxy<br>是K8S在每个节点上运行网络的代理，service资源的载体<br>不直接为POD节点提供网络,而是提供POD间的集群网络<br>建立了POD网络和集群网络的关系（clusterIp-&gt;podIp)<br>负责建立、删除、更新调度规则<br>与apiserver通信，以更新自己和获取其他kube-proxy的的调度规则<br>常用的调度模式：Iptables(不推荐)、Ipvs(推荐)</li>
</ol>
<h3 id="2-2-K8S的三条网络"><a href="#2-2-K8S的三条网络" class="headerlink" title="2.2 K8S的三条网络"></a>2.2 K8S的三条网络</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601202724842-d01f3e6f-aff3-4e64-9b2c-dc6857279379.png" alt="image"></p>
<ol>
<li>节点网络<br>实际网络，就是宿主机网络<br>建议地址段：<code>10.4.7.0/24</code><br>建议通过不同的IP端,区分不同的业务、机房或数据中心</li>
<li>Pod 网络<br>实际网络，容器运行的网络<br>建议<code>172.7.21.0/24</code> ,并建议POD网段与节点IP绑定<br>如: 节点IP为<code>10.4.7.21</code>，则POD网络为<code>172.7.21.0/24</code></li>
<li>service网络<br>虚拟网络，也叫集群网络(cluster server),用于内部集群间通信<br>构建于POD网络之上, 主要是解决服务发现和负载均衡<br>通过kube-proxy连接POD网络和service网络<br>建议地址段为：<code>192.168.0.0/16</code></li>
</ol>
<h2 id="3-K8S流程图"><a href="#3-K8S流程图" class="headerlink" title="3 K8S流程图"></a>3 K8S流程图</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601202724821-252e6de7-990b-4e24-af32-6266205cfaf3.png" alt="image"></p>
<p>说明:</p>
<p>主控节点和node节点只是逻辑上的概念,物理上可以部署在一起</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/23/k8s/1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhangpengjie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/zpj.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zpj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/23/k8s/1/" itemprop="url">快速部署k8s集群</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-23T16:58:48+08:00">
                2020-12-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index">
                    <span itemprop="name">k8s</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/12/23/k8s/1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/12/23/k8s/1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="快速部署k8s集群"><a href="#快速部署k8s集群" class="headerlink" title="快速部署k8s集群"></a>快速部署k8s集群</h1><p>kubeadm是官方社区推出的一个用于快速部署kubernetes集群的工具。</p>
<p>这个工具能通过两条指令完成一个kubernetes集群的部署：</p>
<p># 创建一个 Master 节点</p>
<p>$ kubeadm init</p>
<p># 将一个 Node 节点加入到当前集群中</p>
<p>$ kubeadm join &lt;Master节点的IP和端口 &gt;</p>
<h2 id="1-安装要求"><a href="#1-安装要求" class="headerlink" title="1. 安装要求"></a>1. 安装要求</h2><p>在开始之前，部署Kubernetes集群机器需要满足以下几个条件：</p>
<ul>
<li>一台或多台机器，操作系统 CentOS7.x-86_x64</li>
<li>硬件配置：2GB或更多RAM，2个CPU或更多CPU，硬盘30GB或更多</li>
<li>可以访问外网，需要拉取镜像，如果服务器不能上网，需要提前下载镜像并导入节点</li>
<li>禁止swap分区</li>
</ul>
<h2 id="2-准备环境"><a href="#2-准备环境" class="headerlink" title="2. 准备环境"></a>2. 准备环境</h2><table>
<thead>
<tr>
<th>角色</th>
<th>IP</th>
</tr>
</thead>
<tbody><tr>
<td>master</td>
<td>192.168.1.11</td>
</tr>
<tr>
<td>node1</td>
<td>192.168.1.12</td>
</tr>
<tr>
<td>node2</td>
<td>192.168.1.13</td>
</tr>
</tbody></table>
<p># 关闭防火墙</p>
<p>systemctl stop firewalld</p>
<p>systemctl disable firewalld</p>
<p># 关闭selinux</p>
<p>sed -i ‘s/enforcing/disabled/‘ /etc/selinux/config  # 永久</p>
<p>setenforce 0  # 临时</p>
<p># 关闭swap</p>
<p>swapoff -a  # 临时</p>
<p>sed -ri ‘s/.<em>swap.</em>/#&amp;/‘ /etc/fstab   # 永久</p>
<p># 根据规划设置主机名</p>
<p>hostnamectl set-hostname <hostname></p>
<p># 在master添加hosts</p>
<p>cat &gt;&gt; /etc/hosts &lt;&lt; EOF</p>
<p>192.168.44.146 k8smaster</p>
<p>192.168.44.145 k8snode1</p>
<p>192.168.44.144 k8snode2</p>
<p>EOF</p>
<p># 将桥接的IPv4流量传递到iptables的链</p>
<p>cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF</p>
<p>net.bridge.bridge-nf-call-ip6tables = 1</p>
<p>net.bridge.bridge-nf-call-iptables = 1</p>
<p>EOF</p>
<p>sysctl –system  # 生效</p>
<p># 时间同步</p>
<p>yum install ntpdate -y</p>
<p>ntpdate time.windows.com</p>
<h2 id="3-所有节点安装Docker-kubeadm-kubelet"><a href="#3-所有节点安装Docker-kubeadm-kubelet" class="headerlink" title="3. 所有节点安装Docker/kubeadm/kubelet"></a>3. 所有节点安装Docker/kubeadm/kubelet</h2><p>Kubernetes默认CRI（容器运行时）为Docker，因此先安装Docker。</p>
<h3 id="3-1-安装Docker"><a href="#3-1-安装Docker" class="headerlink" title="3.1 安装Docker"></a>3.1 安装Docker</h3><p>$ wget <a href="https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo" target="_blank" rel="noopener">https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</a> -O /etc/yum.repos.d/docker-ce.repo</p>
<p>$ yum -y install docker-ce-18.06.1.ce-3.el7</p>
<p>$ systemctl enable docker &amp;&amp; systemctl start docker</p>
<p>$ docker –version</p>
<p>Docker version 18.06.1-ce, build e68fc7a</p>
<p>$ cat &gt; /etc/docker/daemon.json &lt;&lt; EOF</p>
<p>{</p>
<p>  “registry-mirrors”: [“<a href="https://b9pmyelo.mirror.aliyuncs.com&quot;]">https://b9pmyelo.mirror.aliyuncs.com&quot;]</a></p>
<p>}</p>
<p>EOF</p>
<h3 id="3-2-添加阿里云YUM软件源"><a href="#3-2-添加阿里云YUM软件源" class="headerlink" title="3.2 添加阿里云YUM软件源"></a>3.2 添加阿里云YUM软件源</h3><p>$ cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF</p>
<p>[kubernetes]</p>
<p>name=Kubernetes</p>
<p>baseurl=<a href="https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64" target="_blank" rel="noopener">https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</a></p>
<p>enabled=1</p>
<p>gpgcheck=0</p>
<p>repo_gpgcheck=0</p>
<p>gpgkey=<a href="https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg" target="_blank" rel="noopener">https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</a> <a href="https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg" target="_blank" rel="noopener">https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</a></p>
<p>EOF</p>
<h3 id="3-3-安装kubeadm，kubelet和kubectl"><a href="#3-3-安装kubeadm，kubelet和kubectl" class="headerlink" title="3.3 安装kubeadm，kubelet和kubectl"></a>3.3 安装kubeadm，kubelet和kubectl</h3><p>由于版本更新频繁，这里指定版本号部署：</p>
<p>$ yum install -y kubelet-1.18.0 kubeadm-1.18.0 kubectl-1.18.0</p>
<p>$ systemctl enable kubelet</p>
<h2 id="4-部署Kubernetes-Master"><a href="#4-部署Kubernetes-Master" class="headerlink" title="4. 部署Kubernetes Master"></a>4. 部署Kubernetes Master</h2><p>在192.168.1.11（Master）执行。</p>
<p>$ kubeadm init \</p>
<p>  –apiserver-advertise-address=192.168.31.61 \</p>
<p>  –image-repository registry.aliyuncs.com/google_containers \</p>
<p>  –kubernetes-version v1.18.0 \</p>
<p>  –service-cidr=10.96.0.0/12 \</p>
<p>  –pod-network-cidr=10.244.0.0/16</p>
<p>由于默认拉取镜像地址k8s.gcr.io国内无法访问，这里指定阿里云镜像仓库地址。</p>
<p>使用kubectl工具：</p>
<p>mkdir -p $HOME/.kube</p>
<p>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</p>
<p>sudo chown $(id -u):$(id -g) $HOME/.kube/config</p>
<p>$ kubectl get nodes</p>
<h2 id="5-加入Kubernetes-Node"><a href="#5-加入Kubernetes-Node" class="headerlink" title="5. 加入Kubernetes Node"></a>5. 加入Kubernetes Node</h2><p>在192.168.1.12/13（Node）执行。</p>
<p>向集群添加新节点，执行在kubeadm init输出的kubeadm join命令：</p>
<p>$ kubeadm join 192.168.1.11:6443 –token esce21.q6hetwm8si29qxwn \</p>
<p>   –discovery-token-ca-cert-hash sha256:00603a05805807501d7181c3d60b478788408cfe6cedefedb1f97569708be9c5</p>
<p>默认token有效期为24小时，当过期之后，该token就不可用了。这时就需要重新创建token，操作如下：</p>
<p>kubeadm token create –print-join-command</p>
<h2 id="6-部署CNI网络插件"><a href="#6-部署CNI网络插件" class="headerlink" title="6. 部署CNI网络插件"></a>6. 部署CNI网络插件</h2><p>wget <a href="https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml" target="_blank" rel="noopener">https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</a></p>
<p>默认镜像地址无法访问，sed命令修改为docker hub镜像仓库。</p>
<p>kubectl apply -f <a href="https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml" target="_blank" rel="noopener">https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</a></p>
<p>kubectl get pods -n kube-system</p>
<p>NAME              READY  STATUS   RESTARTS  AGE</p>
<p>kube-flannel-ds-amd64-2pc95  1/1   Running  0      72s</p>
<h2 id="7-测试kubernetes集群"><a href="#7-测试kubernetes集群" class="headerlink" title="7. 测试kubernetes集群"></a>7. 测试kubernetes集群</h2><p>在Kubernetes集群中创建一个pod，验证是否正常运行：</p>
<p>$ kubectl create deployment nginx –image=nginx</p>
<p>$ kubectl expose deployment nginx –port=80 –type=NodePort</p>
<p>$ kubectl get pod,svc</p>
<p>访问地址：<a href="http://NodeIP:Port">http://NodeIP:Port</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/16/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhangpengjie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/zpj.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zpj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/16/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/" itemprop="url">数据库二进制安装</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-16T17:30:50+08:00">
                2020-12-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/12/16/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/12/16/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="数据库二进制安装"><a href="#数据库二进制安装" class="headerlink" title="数据库二进制安装"></a>数据库二进制安装</h1><h1 id="1-YUM安装数据库"><a href="#1-YUM安装数据库" class="headerlink" title="1.YUM安装数据库"></a>1.YUM安装数据库</h1><p>MySQL Yum仓库提供了用于在Linux平台上安装MySQL服务器，客户端和其他组件的RPM包。<a href="https://dev.mysql.com/downloads/repo/yum/" target="_blank" rel="noopener">mysql-yum安装下载地址</a></p>
<p><img src="http://www.sunrisenan.com/uploads/mysql/images/m_f397fc71d88cf7f381987beaeda4b9df_r.png" alt="null"></p>
<p><img src="http://www.sunrisenan.com/uploads/mysql/images/m_99481f1c400cbfa8527bcfd6422f2b5c_r.png" alt="null"></p>
<blockquote>
<p>使用MySQL Yum仓库时，默认选择安装最新的MySQL版本。如果需要使用低版本请按如下操作。</p>
</blockquote>
<h2 id="1-安装MySQL仓库源"><a href="#1-安装MySQL仓库源" class="headerlink" title="1.安装MySQL仓库源"></a>1.安装MySQL仓库源</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@sql ~]# rpm -ivh https://dev.mysql.com/get/mysql80-community-release-el7-1.noarch.rpm</span><br></pre></td></tr></table></figure>

<h2 id="2-选择并启用适合当前平台的发行包"><a href="#2-选择并启用适合当前平台的发行包" class="headerlink" title="2.选择并启用适合当前平台的发行包"></a>2.选择并启用适合当前平台的发行包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//列出所有MySQL发行版仓库</span><br><span class="line">[root@sql ~]# yum repolist all|grep mysql</span><br><span class="line"></span><br><span class="line">//禁用8.0发行版仓库, 启用5.7发行版仓库</span><br><span class="line">[root@sql ~]# yum install yum-utils</span><br><span class="line">[root@sql ~]# yum-config-manager --disable mysql80-community</span><br><span class="line">[root@sql ~]# yum-config-manager --enable mysql57-community</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以手动编辑/etc/yum.repos.d/mysql-community.repo 文件配置仓库</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[mysql57-community]</span><br><span class="line">name=MySQL 5.7 Community Server</span><br><span class="line">baseurl=http://repo.mysql.com/yum/mysql-5.7-community/el/6/$basearch/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql</span><br></pre></td></tr></table></figure>

<h2 id="3-通过以下命令安装MySQL-并启动MySQL"><a href="#3-通过以下命令安装MySQL-并启动MySQL" class="headerlink" title="3.通过以下命令安装MySQL, 并启动MySQL"></a>3.通过以下命令安装MySQL, 并启动MySQL</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@sql ~]# yum install -y mysql-community-server</span><br><span class="line">[root@sql ~]# systemctl start mysqld</span><br><span class="line">[root@sql ~]# systemctl enable mysqld</span><br></pre></td></tr></table></figure>

<blockquote>
<p>MySQL服务器初始化（仅适用于MySQL 5.7）在服务器初始启动时，如果服务器的数据目录为空，则会发生以下情况：<br>• 服务器已初始化。<br>• 在数据目录中生成SSL证书和密钥文件。<br>• validate_password插件安装并启用。<br>• 超级用户帐户‘root‘@’localhost’已创建。</p>
</blockquote>
<p><strong>超级用户的密码被设置并存储在错误日志文件中。要显示它，请使用以下命令:</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@vm-70-160 ~]# grep "password" /var/log/mysqld.log </span><br><span class="line">2018-04-28T07:11:51.589629Z 1 [Note] A temporary password is generated for root@localhost: jHlRHucap3+7</span><br><span class="line">通过使用生成的临时密码登录并尽快更改root密码并为超级用户帐户设置自定义密码</span><br><span class="line">[root@vm-70-160 ~]# mysql -uroot -pjHlRHucap3+7</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> ALTER USER <span class="string">'root'</span>@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'Bgx123.com'</span>;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>MySQL的validate_password插件默认安装。将要求密码至少包含大写、小写、数字、特殊字符、并且总密码长度至少为8个字符。</p>
</blockquote>
<h1 id="2-通用安装数据库"><a href="#2-通用安装数据库" class="headerlink" title="2.通用安装数据库"></a>2.通用安装数据库</h1><p>采用二进制免编译方式安装MySQL, 不需要复杂的编译设置和编译时间等待,解压下载的软件包,初始化即可完成MySQL的安装和启动。<a href="https://dev.mysql.com/downloads/mysql/5.7.html#downloads" target="_blank" rel="noopener">MySQL二进制包下载地址</a></p>
<p><img src="http://www.sunrisenan.com/uploads/mysql/images/m_159b4adf66d43985338afe652d2c234b_r.png" alt="null"></p>
<p><a href="https://dev.mysql.com/doc/refman/5.7/en/binary-installation.html" target="_blank" rel="noopener">MySQL二进制包官方安装手册</a></p>
<h2 id="1-基础环境准备"><a href="#1-基础环境准备" class="headerlink" title="1.基础环境准备"></a>1.基础环境准备</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@sql ~]# systemctl stop firewalld</span><br><span class="line">[root@sql ~]# systemctl disable firewalld</span><br><span class="line">[root@sql ~]# setenforce 0</span><br><span class="line"></span><br><span class="line">//建立用户与相应目录</span><br><span class="line">[root@sql ~]# groupadd mysql</span><br><span class="line">[root@sql ~]# useradd -r -g mysql -s /sbin/nologin mysql</span><br><span class="line">[root@sql ~]# mkdir /soft/src -p &amp;&amp; cd /soft/src</span><br></pre></td></tr></table></figure>

<h2 id="2-下载MySQL并安装"><a href="#2-下载MySQL并安装" class="headerlink" title="2.下载MySQL并安装"></a>2.下载MySQL并安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@sql src]# wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz</span><br><span class="line">[root@sql src]# tar xf mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz -C /soft</span><br><span class="line">[root@sql src]# ln -s /soft/mysql-5.7.22-linux-glibc2.12-x86_64/ /soft/mysql</span><br></pre></td></tr></table></figure>

<h2 id="3-进行MySQL初始化"><a href="#3-进行MySQL初始化" class="headerlink" title="3.进行MySQL初始化"></a>3.进行MySQL初始化</h2><p>//创建初始化目录以及数据库数据目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@sql ~]# mkdir /soft/mysql/&#123;mysql-file,data&#125;</span><br><span class="line">[root@sql ~]# chown mysql.mysql /soft/mysql/</span><br><span class="line"></span><br><span class="line">//初始化数据库</span><br><span class="line">[root@sql ~]# /soft/mysql/bin/mysqld --initialize \</span><br><span class="line">--user=mysql --basedir=/soft/mysql \</span><br><span class="line">--datadir=/soft/mysql/data</span><br><span class="line">-------</span><br><span class="line"></span><br><span class="line">//初始化数据库会告诉默认登陆账户与密码</span><br><span class="line">2018-04-28T02:30:33.954980Z 1 [Note] A temporary password is generated for'root@localhost: I,isfqnx.0tO'</span><br><span class="line">-------</span><br><span class="line"></span><br><span class="line">//使用ssl连接, 初始化后重新授权目录权限[如不需要可忽略]</span><br><span class="line"></span><br><span class="line">[root@sql ~]# /soft/mysql/bin/mysql_ssl_rsa_setup \</span><br><span class="line">--datadir=/soft/mysql/data/</span><br><span class="line">[root@sql ~]# chown -R mysql.mysql /soft/mysql/</span><br></pre></td></tr></table></figure>

<h2 id="4-建立MySQL配置文件"><a href="#4-建立MySQL配置文件" class="headerlink" title="4.建立MySQL配置文件"></a>4.建立MySQL配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//mysql安装目录及mysql数据库目录</span><br><span class="line">[root@sql ~]# cp /etc/my.cnf /etc/my.cnf_bak</span><br><span class="line">[root@sql ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/soft/mysql</span><br><span class="line">datadir=/soft/mysql/data</span><br></pre></td></tr></table></figure>

<h2 id="5-启动MySQL数据库"><a href="#5-启动MySQL数据库" class="headerlink" title="5.启动MySQL数据库"></a>5.启动MySQL数据库</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//方式1,使用 mysqld_safe </span><br><span class="line">[root@sql ~]# /soft/mysql/bin/mysqld_safe --user=mysql &amp;</span><br><span class="line"></span><br><span class="line">//方式2, 使用(systemV)方式管理, [强烈推荐]</span><br><span class="line">[root@sql ~]# cp /soft/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line">[root@sql ~]# chkconfig --add mysqld</span><br><span class="line">[root@sql ~]# chkconfig mysqld on</span><br><span class="line"></span><br><span class="line">//修改安装目录与数据存放目录</span><br><span class="line">[root@sql ~]# sed -i '/^basedir=/cbasedir=\/soft\/mysql' /etc/init.d/mysqld </span><br><span class="line">[root@sql ~]# sed -i '/^datadir=/cdatadir=\/soft\/mysql\/data' /etc/init.d/mysqld</span><br><span class="line"></span><br><span class="line">//启动数据库</span><br><span class="line">[root@sql ~]# /etc/init.d/mysqld start</span><br><span class="line">Starting MySQL. SUCCESS!</span><br><span class="line"></span><br><span class="line">//检查进程</span><br><span class="line">[root@sql ~]# ps aux|grep mysql</span><br><span class="line"></span><br><span class="line">//检查端口</span><br><span class="line">[root@sql ~]# lsof -i :3306</span><br><span class="line">COMMAND  PID  USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">mysqld  2659 mysql   16u  IPv6  28431      0t0  TCP *:mysql (LISTEN)</span><br><span class="line">[root@sql ~]# ss -lntup|grep 3306</span><br><span class="line">tcp    LISTEN     0      80 :::3306  :::*   users:(("mysqld",pid=2659,fd=16))</span><br></pre></td></tr></table></figure>

<h2 id="6-连接数据库测试"><a href="#6-连接数据库测试" class="headerlink" title="6.连接数据库测试"></a>6.连接数据库测试</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">//默认情况没有mysql命令, 如果有可能使用过yum安装, 这样容易连错数据库(PATH路径存在命令执行优先级问题)</span><br><span class="line">[root@sql ~]# mysql</span><br><span class="line">-bash: mysql: command not found</span><br><span class="line"></span><br><span class="line">//可以选择添加路径至PATH中, 或者直接使用绝对路径执行</span><br><span class="line">[root@sql ~]# echo "export PATH=$PATH:/soft/mysql/bin" &gt;&gt; /etc/profile</span><br><span class="line">[root@sql ~]# source /etc/profile</span><br><span class="line"></span><br><span class="line">//登陆数据库</span><br><span class="line">[root@sql ~]# mysql -uroot -p"I,isfqnx.0tO"</span><br><span class="line"></span><br><span class="line">//默认系统配置数据库密码必须修改, 否则无法使用数据库</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show databases;</span></span><br><span class="line">ERROR 1820 (HY000): You must reset your password using ALTER USER statement before executing this statement.</span><br><span class="line"></span><br><span class="line">//修改系统默认密码</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> alter user root@<span class="string">'localhost'</span> identified by <span class="string">'bgx'</span>;</span></span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">exit</span>;</span></span><br><span class="line"></span><br><span class="line">//退出后使用新密码重新登录数据库</span><br><span class="line">[root@sql ~]# mysql -uroot -p"bgx"</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show databases;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows in set (0.02 sec)</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">exit</span>;</span></span><br><span class="line">注意: 如果需要重新初始化[可选]</span><br><span class="line"></span><br><span class="line">//如果重新初始化会导致数据全部丢失</span><br><span class="line">[root@sql ~]# yum install -y psmisc</span><br><span class="line">[root@sql ~]# killall mysqld</span><br><span class="line">[root@sql ~]# rm -rf /soft/mysql/data/*</span><br><span class="line">[root@sql ~]# /soft/mysql/bin/mysqld --initialize --user=mysql \</span><br><span class="line">--basedir=/soft/mysql --datadir=/soft/mysql/data</span><br><span class="line"><span class="meta">#</span><span class="bash">可不执行</span></span><br><span class="line">[root@sql ~]# /soft/mysql/bin/mysql_ssl_rsa_setup --datadir=/soft/mysql/data</span><br></pre></td></tr></table></figure>

<h1 id="3-源码安装数据库"><a href="#3-源码安装数据库" class="headerlink" title="3.源码安装数据库"></a>3.源码安装数据库</h1><h2 id="1-源码安装mysql需要依赖cmake、boost"><a href="#1-源码安装mysql需要依赖cmake、boost" class="headerlink" title="1.源码安装mysql需要依赖cmake、boost"></a>1.源码安装mysql需要依赖cmake、boost</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@sql ~]# yum install libaio-devel gcc gcc-c++ ncurses ncurses-devel cmake -y</span><br><span class="line">[root@sql ~]# useradd -M -s /sbin/nologin mysql</span><br><span class="line">[root@sql ~]# mkdir /soft/src/ -p</span><br></pre></td></tr></table></figure>

<h2 id="2-下载源码包并编译MySQL"><a href="#2-下载源码包并编译MySQL" class="headerlink" title="2.下载源码包并编译MySQL"></a>2.下载源码包并编译MySQL</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@sql ~]# wget http://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-boost-5.7.22.tar.gz</span><br><span class="line">[root@sql ~]# tar xf mysql-boost-5.7.22.tar.gz</span><br><span class="line">[root@sql ~]# cd mysql-5.7.22/</span><br><span class="line">[root@sql ~]# cmake -DCMAKE_INSTALL_PREFIX=/soft/mysql-5.7.22 \</span><br><span class="line">-DMYSQL_UNIX_ADDR=/soft/mysql-5.7.22/data/mysql.sock \</span><br><span class="line">-DMYSQL_DATADIR=/soft/mysql-5.7.22/data \</span><br><span class="line">-DSYSCONFDIR=/soft/mysql-5.7.22/conf \</span><br><span class="line">-DWITH_MYISAM_STORAGE_ENGINE=0 \</span><br><span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_MEMORY_STORAGE_ENGINE=0 \</span><br><span class="line">-DWITH_READLINE=1 \</span><br><span class="line">-DMYSQL_TCP_PORT=3306 \</span><br><span class="line">-DENABLED_LOCAL_INFILE=1 \</span><br><span class="line">-DWITH_PARTITION_STORAGE_ENGINE=1 \</span><br><span class="line">-DEXTRA_CHARSETS=all \</span><br><span class="line">-DDEFAULT_CHARSET=utf8 \</span><br><span class="line">-DDEFAULT_COLLATION=utf8_general_ci \</span><br><span class="line">-DWITH_BOOST=/soft/package/src/mysql-5.7.22/boost/boost_1_59_0</span><br><span class="line">[root@sql ~]# make</span><br><span class="line">[root@sql ~]# make install</span><br></pre></td></tr></table></figure>

<h2 id="3-完成后基本优化"><a href="#3-完成后基本优化" class="headerlink" title="3.完成后基本优化"></a>3.完成后基本优化</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@sql ~]# ln -s /soft/mysql-5.7.22 /soft/mysql</span><br><span class="line">[root@sql ~]# mkdir /soft/mysql/data</span><br><span class="line">[root@sql ~]# chown -R mysql.mysql /soft/mysql</span><br></pre></td></tr></table></figure>

<h2 id="4-准备MySQL基础配置文件"><a href="#4-准备MySQL基础配置文件" class="headerlink" title="4.准备MySQL基础配置文件"></a>4.准备MySQL基础配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@sql ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/soft/mysql</span><br><span class="line">datadir=/soft/mysql/data</span><br></pre></td></tr></table></figure>

<h2 id="5-拷贝MySQL程序启动文件"><a href="#5-拷贝MySQL程序启动文件" class="headerlink" title="5.拷贝MySQL程序启动文件"></a>5.拷贝MySQL程序启动文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//拷贝官方准备的启动脚本</span><br><span class="line">[root@sql ~]# cp /soft/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line"></span><br><span class="line">//添加为系统服务, 并设定开机自启动</span><br><span class="line">[root@sql ~]# chkconfig --add mysqld &amp;&amp; chkconfig mysqld on</span><br></pre></td></tr></table></figure>

<h2 id="6-初始化MySQL"><a href="#6-初始化MySQL" class="headerlink" title="6.初始化MySQL"></a>6.初始化MySQL</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@sql ~]# /soft/mysql/bin/mysqld --initialize-insecure --user=mysql --basedir=/soft/mysql --datadir=/soft/mysql/data</span><br><span class="line"></span><br><span class="line">//启动MySQL</span><br><span class="line">[root@sql ~]# /etc/init.d/mysqld start</span><br><span class="line"></span><br><span class="line">//为mysql命令添加环境变量,以便后续简化执行命令</span><br><span class="line">[root@sql ~]# echo &gt;&gt; "export PATH=/data/soft/mysql/bin:$PATH" /etc/profile</span><br><span class="line">[root@sql ~]# source /etc/profile</span><br><span class="line"></span><br><span class="line">//源码编译MySQL默认root没有密码</span><br><span class="line">[root@sql ~]# mysql</span><br></pre></td></tr></table></figure>

<h1 id="4-变更数据库密码"><a href="#4-变更数据库密码" class="headerlink" title="4.变更数据库密码"></a>4.变更数据库密码</h1><h2 id="1-更改root密码"><a href="#1-更改root密码" class="headerlink" title="1.更改root密码"></a>1.更改root密码</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//第一种方式, 需要知道密码</span><br><span class="line">[root@sql ~]# mysqladmin -uroot -pBgx123.com password 'Bgx111.com'</span><br><span class="line">Warning: Since password will be sent to server in plain text, use ssl connection to ensure password safety.</span><br><span class="line">[root@sql ~]# mysql -uroot -pBgx111.com</span><br><span class="line"><span class="meta">mysql&gt;</span></span><br><span class="line"></span><br><span class="line">//第二种方式, 登录MySQL, 修改相应表</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> update mysql.user <span class="built_in">set</span> authentication_string=password(<span class="string">'Bjtest123.com'</span>) <span class="built_in">where</span> user=<span class="string">'root'</span>;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> flush privileges;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-忘记mysql-root密码"><a href="#2-忘记mysql-root密码" class="headerlink" title="2.忘记mysql root密码"></a>2.忘记mysql root密码</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@sql ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">skip-grant-tables # 新增跳过授权表</span><br><span class="line"></span><br><span class="line">//重启数据库生效</span><br><span class="line">[root@sql ~]# systemctl restart mysqld</span><br><span class="line"></span><br><span class="line">//查看表字段</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select user,host,authentication_string from mysql.user;</span></span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| user          | host      | authentication_string                     |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| root          | localhost | *C786BB788F276CD53317C80C1957E5F5696751F0 |</span><br><span class="line">| mysql.session | localhost | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE |</span><br><span class="line">| mysql.sys     | localhost | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">//5.7.6版本后更新密码方式</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> update mysql.user <span class="built_in">set</span> authentication_string=password(<span class="string">'Bgx123.com'</span>) <span class="built_in">where</span> user=<span class="string">'root'</span>;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">exit</span></span></span><br><span class="line"></span><br><span class="line">//5.7.6版本前更新密码方式</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> update mysql.user <span class="built_in">set</span> password=password(<span class="string">'Bgx123.com'</span>) <span class="built_in">where</span> user=<span class="string">"root"</span> and host=<span class="string">"localhost"</span>;</span></span><br><span class="line">[root@sql ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line"><span class="meta">#</span><span class="bash">skip-grant-tables <span class="comment">#注释</span></span></span><br><span class="line"></span><br><span class="line">//重启数据库生效</span><br><span class="line">[root@sql ~]# systemctl restart mysqld</span><br><span class="line"></span><br><span class="line">//使用新密码登录数据库</span><br><span class="line">[root@sql ~]# mysql -uroot -pBgx123.com</span><br><span class="line"><span class="meta">mysql&gt;</span></span><br></pre></td></tr></table></figure>

<p>原文链接<a href="http://www.sunrisenan.com/docs/mysql/mysql-1aofhklc0is34" target="_blank" rel="noopener">http://www.sunrisenan.com/docs/mysql/mysql-1aofhklc0is34</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/15/%E7%94%B7%E4%BA%BA%E5%BF%83%E6%99%BA%E6%88%90%E7%86%9F%E7%9A%84%E4%B9%9D%E5%A4%A7%E8%A1%A8%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhangpengjie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/zpj.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zpj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/15/%E7%94%B7%E4%BA%BA%E5%BF%83%E6%99%BA%E6%88%90%E7%86%9F%E7%9A%84%E4%B9%9D%E5%A4%A7%E8%A1%A8%E7%8E%B0/" itemprop="url">男人心智成熟的九大表现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-15T13:24:08+08:00">
                2020-12-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9A%8F%E7%AC%94/" itemprop="url" rel="index">
                    <span itemprop="name">随笔</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/12/15/%E7%94%B7%E4%BA%BA%E5%BF%83%E6%99%BA%E6%88%90%E7%86%9F%E7%9A%84%E4%B9%9D%E5%A4%A7%E8%A1%A8%E7%8E%B0/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/12/15/%E7%94%B7%E4%BA%BA%E5%BF%83%E6%99%BA%E6%88%90%E7%86%9F%E7%9A%84%E4%B9%9D%E5%A4%A7%E8%A1%A8%E7%8E%B0/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p> 我国《婚姻法》规定，结婚年龄，男不得早于22周岁，女不得早于20周岁。</p>
<p>很多网友会调侃，说这是因为，男人普遍要比女人晚成熟，我在网上也搜索了一些相关的资料，并没有找到权威的信息来源渠道，以证明此观点的权威性。</p>
<p>一个男人的成熟与否，先要看其心智是否成熟，那么，男人心智成熟的表现有哪些呢？</p>
<p>1、建立原则</p>
<p>不论是在工作中，还是在生活中，又或是在两个人的热恋中，都能建立自己的原则。原则能让我们在一段恋爱过程中，更清晰地承担起对另一方的爱，同时，又能保证自己的独立性。</p>
<p>2、逻辑能力</p>
<p>有基本的分辨是非对错、社会中的黑白灰的逻辑思维能力。其实，目前社会中的大多数人，都是比较缺乏逻辑思维能力的，很多人话说了很多，但是，还是搞不清楚TA想要表达什么？说话没有主次之分的人，随处可见。</p>
<p>更严重点来说，遇到什么事件，或是听到什么事件，就会立即下结论，而不愿意动动大脑，理性地思考思考，再决定自己的下一步要怎么走。所以，逻辑能力，是一个男人心智成熟很重要的一点表现。</p>
<p>3、看淡某些事的能力</p>
<p>遇到一些让自己不开心的事，或是遇到一些跟自己想法相反的人，就想着一定要让TA人的想法转变，跟自己的想法一样。经常性地想着如何去改变别人的想法，这是男人心智不成熟的表现之一。</p>
<p>要知道，世界上的人各种各样，人最难做的一件事就是：去改变TA人的想法。就算是上帝，至今也没能完成这项伟业，你又谈何能行！</p>
<p>4、不卑不亢</p>
<p>当别人赞美自己的时候，自己仍然知道自己的能力边界在哪里，不高傲，不作作，还能很低调地应对。当别人恶意打击时，也能做到不自卑，相信自己。</p>
<p>当自己失败时，能够理性地坦然面对，并从失败中吸取教训，为下一次启航做准备，而不是失败了就从此一蹶不振。</p>
<p>5、懂得规划</p>
<p>不再盲目地生活、工作、学习，懂得给自己做相应的规划，并且，严格要求自己去执行自己制定的规划。</p>
<p>6、时间是命</p>
<p>懂得珍惜时间，明白时间的重要性，时间对于我们每人都一样的公平。不论是富人还是穷人，每天都是24小时，关键看我们每个人如何去使用时间。</p>
<p>7、控制情绪</p>
<p>这一点我知道很难，不论是几岁的孩子，还是几十岁的老人，始终都会有情绪，但是心智成熟的男人，会懂得更好地去控制自己的情绪，而不是只顾着发泄情绪。</p>
<p>8、理解父母</p>
<p>父母的唠叨，在父母一辈看来，就是对我们的爱，但是，对于我们看来，总会觉得很反感。但是，当你能换位思考，或是你有一天为人父母的时候，此情此景你会怎么做，就能对父母多点理解了。</p>
<p>9、做自己</p>
<p>做真正的自己，不用太刻意关注别人看待自己的眼光，因为，你的生活不是别人给的，那么，你又为何要那么在意别人如何看待你呢。</p>
<p>中国人最喜欢干的一件事就是“管别人”，但是，这些人其实没搞明白一点，别人的决定，之后产生的后果，只有当事人自己承担，而那些“管别人”的人却不承担任何风险，这难道不是很有问题吗？</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/07/nginx%E9%85%8D%E7%BD%AE%E6%95%99%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhangpengjie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/zpj.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zpj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/07/nginx%E9%85%8D%E7%BD%AE%E6%95%99%E7%A8%8B/" itemprop="url">nginx配置教程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-07T21:43:40+08:00">
                2020-12-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/nginx/" itemprop="url" rel="index">
                    <span itemprop="name">nginx</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/12/07/nginx%E9%85%8D%E7%BD%AE%E6%95%99%E7%A8%8B/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/12/07/nginx%E9%85%8D%E7%BD%AE%E6%95%99%E7%A8%8B/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Nginx配置教程"><a href="#Nginx配置教程" class="headerlink" title="Nginx配置教程"></a>Nginx配置教程</h1><p><a href="http://nginx.org/" target="_blank" rel="noopener"><br><img src="https://dictator.oss-cn-hongkong.aliyuncs.com/hexo/title/nginx.svg" alt="img">
</a></p>
<p>Nginx 是一款面向性能设计的 HTTP 服务器，能反向代理 HTTP，HTTPS 和邮件相关(SMTP，POP3，IMAP)的协议链接。并且提供了负载均衡以及 HTTP 缓存。它的设计充分使用异步事件模型，削减上下文调度的开销，提高服务器并发能力。采用了模块化设计，提供了丰富模块的第三方模块。</p>
<p>所以关于 Nginx，有这些标签：「异步」「事件」「模块化」「高性能」「高并发」「反向代理」「负载均衡」</p>
<p>Linux系统：<code>Centos 7 x64</code><br>Nginx版本：<code>1.11.5</code></p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><blockquote>
<p>prce(重定向支持)和openssl(https支持，如果不需要https可以不安装。)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">复制yum install -y pcre-devel </span><br><span class="line">yum -y install gcc make gcc-c++ wget</span><br><span class="line">yum -y install openssl openssl-devel</span><br></pre></td></tr></table></figure>

<p>CentOS 6.5 我安装的时候是选择的“基本服务器”，默认这两个包都没安装全，所以这两个都运行安装即可。</p>
<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p><a href="http://nginx.org/download/" target="_blank" rel="noopener">nginx的所有版本在这里</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">复制wget http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.13.3.tar.gz</span><br><span class="line">wget http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.13.7.tar.gz</span><br><span class="line"></span><br><span class="line"># 如果没有安装wget</span><br><span class="line"># 下载已编译版本</span><br><span class="line">$ yum install wget</span><br><span class="line"></span><br><span class="line"># 解压压缩包</span><br><span class="line">tar zxf nginx-1.13.3.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><p>然后进入目录编译安装，<a href="https://www.viayc.com/2019/03/13/Nginx配置教程/#参数说明" target="_blank" rel="noopener">configure参数说明</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">复制cd nginx-1.11.5</span><br><span class="line">.&#x2F;configure</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line">Configuration summary</span><br><span class="line">  + using system PCRE library</span><br><span class="line">  + OpenSSL library is not used</span><br><span class="line">  + using system zlib library</span><br><span class="line"></span><br><span class="line">  nginx path prefix: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&quot;</span><br><span class="line">  nginx binary file: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx&quot;</span><br><span class="line">  nginx modules path: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;modules&quot;</span><br><span class="line">  nginx configuration prefix: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&quot;</span><br><span class="line">  nginx configuration file: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf&quot;</span><br><span class="line">  nginx pid file: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;nginx.pid&quot;</span><br><span class="line">  nginx error log file: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;error.log&quot;</span><br><span class="line">  nginx http access log file: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;access.log&quot;</span><br><span class="line">  nginx http client request body temporary files: &quot;client_body_temp&quot;</span><br><span class="line">  nginx http proxy temporary files: &quot;proxy_temp&quot;</span><br><span class="line">  nginx http fastcgi temporary files: &quot;fastcgi_temp&quot;</span><br><span class="line">  nginx http uwsgi temporary files: &quot;uwsgi_temp&quot;</span><br><span class="line">  nginx http scgi temporary files: &quot;scgi_temp&quot;</span><br></pre></td></tr></table></figure>

<p>安装报错误的话比如：“C compiler cc is not found”，这个就是缺少编译环境，安装一下就可以了 <strong>yum -y install gcc make gcc-c++ openssl-devel</strong></p>
<p>如果没有error信息，就可以执行下边的安装了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">复制make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h3 id="nginx测试"><a href="#nginx测试" class="headerlink" title="nginx测试"></a>nginx测试</h3><p>运行下面命令会出现两个结果，一般情况nginx会安装在<code>/usr/local/nginx</code>目录中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">复制cd &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;</span><br><span class="line">.&#x2F;nginx -t</span><br><span class="line"></span><br><span class="line"># nginx: the configuration file &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf syntax is ok</span><br><span class="line"># nginx: configuration file &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf test is successful</span><br></pre></td></tr></table></figure>

<h3 id="设置全局nginx命令"><a href="#设置全局nginx命令" class="headerlink" title="设置全局nginx命令"></a>设置全局nginx命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">复制vi ~&#x2F;.bash_profile</span><br></pre></td></tr></table></figure>

<p>将下面内容添加到 <code>~/.bash_profile</code> 文件中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">复制PATH&#x3D;$PATH:$HOME&#x2F;bin:&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;</span><br><span class="line">export PATH</span><br></pre></td></tr></table></figure>

<p>运行命令 <strong><code>source ~/.bash_profile</code></strong> 让配置立即生效。你就可以全局运行 <code>nginx</code> 命令了。</p>
<h2 id="Mac-安装"><a href="#Mac-安装" class="headerlink" title="Mac 安装"></a>Mac 安装</h2><p>Mac OSX 安装特别简单，首先你需要安装 <a href="https://brew.sh/" target="_blank" rel="noopener">Brew</a>， 通过 <code>brew</code> 快速安装 <code>nginx</code>。</p>
<h3 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">复制brew install nginx</span><br><span class="line"># Updating Homebrew...</span><br><span class="line"># &#x3D;&#x3D;&gt; Auto-updated Homebrew!</span><br><span class="line"># Updated 2 taps (homebrew&#x2F;core, homebrew&#x2F;cask).</span><br><span class="line"># &#x3D;&#x3D;&gt; Updated Formulae</span><br><span class="line"># &#x3D;&#x3D;&gt; Installing dependencies for nginx: openssl, pcre</span><br><span class="line"># &#x3D;&#x3D;&gt; Installing nginx dependency: openssl</span><br><span class="line"># &#x3D;&#x3D;&gt; Downloading https:&#x2F;&#x2F;homebrew.bintray.com&#x2F;bottles&#x2F;openssl-1.0.2o_1.high_sierra.bottle.tar.gz</span><br><span class="line"># ######################################################################## 100.0%</span><br><span class="line"># &#x3D;&#x3D;&gt; Pouring openssl-1.0.2o_1.high_sierra.bottle.tar.gz</span><br><span class="line"># &#x3D;&#x3D;&gt; Caveats</span><br><span class="line"># A CA file has been bootstrapped using certificates from the SystemRoots</span><br><span class="line"># keychain. To add additional certificates (e.g. the certificates added in</span><br><span class="line"># the System keychain), place .pem files in</span><br><span class="line">#   &#x2F;usr&#x2F;local&#x2F;etc&#x2F;openssl&#x2F;certs</span><br><span class="line"># </span><br><span class="line"># and run</span><br><span class="line">#   &#x2F;usr&#x2F;local&#x2F;opt&#x2F;openssl&#x2F;bin&#x2F;c_rehash</span><br><span class="line"># </span><br><span class="line"># This formula is keg-only, which means it was not symlinked into &#x2F;usr&#x2F;local,</span><br><span class="line"># because Apple has deprecated use of OpenSSL in favor of its own TLS and crypto libraries.</span><br><span class="line"># </span><br><span class="line"># If you need to have this software first in your PATH run:</span><br><span class="line">#   echo &#39;export PATH&#x3D;&quot;&#x2F;usr&#x2F;local&#x2F;opt&#x2F;openssl&#x2F;bin:$PATH&quot;&#39; &gt;&gt; ~&#x2F;.zshrc</span><br><span class="line"># </span><br><span class="line"># For compilers to find this software you may need to set:</span><br><span class="line">#     LDFLAGS:  -L&#x2F;usr&#x2F;local&#x2F;opt&#x2F;openssl&#x2F;lib</span><br><span class="line">#     CPPFLAGS: -I&#x2F;usr&#x2F;local&#x2F;opt&#x2F;openssl&#x2F;include</span><br><span class="line"># For pkg-config to find this software you may need to set:</span><br><span class="line">#     PKG_CONFIG_PATH: &#x2F;usr&#x2F;local&#x2F;opt&#x2F;openssl&#x2F;lib&#x2F;pkgconfig</span><br><span class="line"># </span><br><span class="line"># &#x3D;&#x3D;&gt; Summary</span><br><span class="line"># 🍺  &#x2F;usr&#x2F;local&#x2F;Cellar&#x2F;openssl&#x2F;1.0.2o_1: 1,791 files, 12.3MB</span><br><span class="line"># &#x3D;&#x3D;&gt; Installing nginx dependency: pcre</span><br><span class="line"># &#x3D;&#x3D;&gt; Downloading https:&#x2F;&#x2F;homebrew.bintray.com&#x2F;bottles&#x2F;pcre-8.42.high_sierra.bottle.tar.gz</span><br><span class="line"># ######################################################################## 100.0%</span><br><span class="line"># &#x3D;&#x3D;&gt; Pouring pcre-8.42.high_sierra.bottle.tar.gz</span><br><span class="line"># 🍺  &#x2F;usr&#x2F;local&#x2F;Cellar&#x2F;pcre&#x2F;8.42: 204 files, 5.3MB</span><br><span class="line"># &#x3D;&#x3D;&gt; Installing nginx</span><br><span class="line"># &#x3D;&#x3D;&gt; Downloading https:&#x2F;&#x2F;homebrew.bintray.com&#x2F;bottles&#x2F;nginx-1.13.12.high_sierra.bottle.tar.gz</span><br><span class="line"># ######################################################################## 100.0%</span><br><span class="line"># &#x3D;&#x3D;&gt; Pouring nginx-1.13.12.high_sierra.bottle.tar.gz</span><br><span class="line"># &#x3D;&#x3D;&gt; Caveats</span><br><span class="line"># Docroot is: &#x2F;usr&#x2F;local&#x2F;var&#x2F;www</span><br><span class="line"># </span><br><span class="line"># The default port has been set in &#x2F;usr&#x2F;local&#x2F;etc&#x2F;nginx&#x2F;nginx.conf to 8080 so that</span><br><span class="line"># nginx can run without sudo.</span><br><span class="line"># </span><br><span class="line"># nginx will load all files in &#x2F;usr&#x2F;local&#x2F;etc&#x2F;nginx&#x2F;servers&#x2F;.</span><br><span class="line"># </span><br><span class="line"># To have launchd start nginx now and restart at login:</span><br><span class="line">#   brew services start nginx</span><br><span class="line"># Or, if you don&#39;t wacd &#x2F;usr&#x2F;local&#x2F;Cellar&#x2F;nginx&#x2F;1.13.12&#x2F;n just run:</span><br><span class="line"># cd &#x2F;usr&#x2F;local&#x2F;Cellar&#x2F;nginx&#x2F;1.13.12&#x2F;</span><br></pre></td></tr></table></figure>

<h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><p>注意默认端口不是 <code>8080</code> 查看确认端口是否被占用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">复制brew services start nginx</span><br><span class="line"># http:&#x2F;&#x2F;localhost:8080&#x2F;</span><br></pre></td></tr></table></figure>

<h2 id="开机自启动"><a href="#开机自启动" class="headerlink" title="开机自启动"></a>开机自启动</h2><p><strong>开机自启动方法一：</strong></p>
<p>编辑 <strong>vi /lib/systemd/system/nginx.service</strong> 文件，没有创建一个 <strong>touch nginx.service</strong> 然后将如下内容根据具体情况进行修改后，添加到nginx.service文件中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">复制[Unit]</span><br><span class="line">Description&#x3D;nginx</span><br><span class="line">After&#x3D;network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"></span><br><span class="line">Type&#x3D;forking</span><br><span class="line">PIDFile&#x3D;&#x2F;var&#x2F;run&#x2F;nginx.pid</span><br><span class="line">ExecStartPre&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -t -c &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -c &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</span><br><span class="line">ExecReload&#x3D;&#x2F;bin&#x2F;kill -s HUP $MAINPID</span><br><span class="line">ExecStop&#x3D;&#x2F;bin&#x2F;kill -s QUIT $MAINPID</span><br><span class="line">PrivateTmp&#x3D;true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br></pre></td></tr></table></figure>

<ul>
<li><code>[Unit]</code>:服务的说明</li>
<li><code>Description</code>:描述服务</li>
<li><code>After</code>:描述服务类别</li>
<li><code>[Service]</code>服务运行参数的设置</li>
<li><code>Type=forking</code>是后台运行的形式</li>
<li><code>ExecStart</code>为服务的具体运行命令</li>
<li><code>ExecReload</code>为重启命令</li>
<li><code>ExecStop</code>为停止命令</li>
<li><code>PrivateTmp=True</code>表示给服务分配独立的临时空间</li>
</ul>
<p>注意：<code>[Service]</code>的启动、重启、停止命令全部要求使用绝对路径。</p>
<p><code>[Install]</code>运行级别下服务安装的相关设置，可设置为多用户，即系统运行级别为<code>3</code>。</p>
<p>保存退出。</p>
<p>设置开机启动，使配置生效：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">复制# 启动nginx服务</span><br><span class="line">systemctl start nginx.service</span><br><span class="line"># 停止开机自启动</span><br><span class="line">systemctl disable nginx.service</span><br><span class="line"># 查看服务当前状态</span><br><span class="line">systemctl status nginx.service</span><br><span class="line"># 查看所有已启动的服务</span><br><span class="line">systemctl list-units --type&#x3D;service</span><br><span class="line"># 重新启动服务</span><br><span class="line">systemctl restart nginx.service</span><br><span class="line"># 设置开机自启动</span><br><span class="line">systemctl enable nginx.service</span><br><span class="line"># 输出下面内容表示成功了</span><br><span class="line">Created symlink from &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;multi-user.target.wants&#x2F;nginx.service to &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;nginx.service.</span><br><span class="line">复制systemctl is-enabled servicename.service # 查询服务是否开机启动</span><br><span class="line">systemctl enable *.service # 开机运行服务</span><br><span class="line">systemctl disable *.service # 取消开机运行</span><br><span class="line">systemctl start *.service # 启动服务</span><br><span class="line">systemctl stop *.service # 停止服务</span><br><span class="line">systemctl restart *.service # 重启服务</span><br><span class="line">systemctl reload *.service # 重新加载服务配置文件</span><br><span class="line">systemctl status *.service # 查询服务运行状态</span><br><span class="line">systemctl --failed # 显示启动失败的服务</span><br></pre></td></tr></table></figure>

<p>注：*代表某个服务的名字，如http的服务名为httpd</p>
<p><strong>开机自启动方法二：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">复制vi &#x2F;etc&#x2F;rc.local</span><br><span class="line"></span><br><span class="line"># 在 rc.local 文件中，添加下面这条命令</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx start</span><br></pre></td></tr></table></figure>

<p>如果开机后发现自启动脚本没有执行，你要去确认一下rc.local这个文件的访问权限是否是可执行的，因为rc.local默认是不可执行的。修改rc.local访问权限，增加可执行权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">复制# &#x2F;etc&#x2F;rc.local是&#x2F;etc&#x2F;rc.d&#x2F;rc.local的软连接，</span><br><span class="line">chmod +x &#x2F;etc&#x2F;rc.d&#x2F;rc.local</span><br></pre></td></tr></table></figure>

<p>官方脚本 <a href="https://www.nginx.com/resources/wiki/start/topics/examples/redhatnginxinit/" target="_blank" rel="noopener">ed Hat NGINX Init Script</a>。</p>
<h2 id="运维"><a href="#运维" class="headerlink" title="运维"></a>运维</h2><h3 id="服务管理"><a href="#服务管理" class="headerlink" title="服务管理"></a>服务管理</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">复制# 启动</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx</span><br><span class="line"></span><br><span class="line"># 重启</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -s reload</span><br><span class="line"></span><br><span class="line"># 关闭进程</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -s stop</span><br><span class="line"></span><br><span class="line"># 平滑关闭nginx</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -s quit</span><br><span class="line"></span><br><span class="line"># 查看nginx的安装状态，</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -V</span><br></pre></td></tr></table></figure>

<p><strong>关闭防火墙，或者添加防火墙规则就可以测试了</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">复制service iptables stop</span><br></pre></td></tr></table></figure>

<p>或者编辑配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">复制vi &#x2F;etc&#x2F;sysconfig&#x2F;iptables</span><br></pre></td></tr></table></figure>

<p>添加这样一条开放80端口的规则后保存：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">复制-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>重启服务即可:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">复制service iptables restart</span><br><span class="line"># 命令进行查看目前nat</span><br><span class="line">iptables -t nat -L</span><br></pre></td></tr></table></figure>

<h3 id="重启服务防火墙报错解决"><a href="#重启服务防火墙报错解决" class="headerlink" title="重启服务防火墙报错解决"></a>重启服务防火墙报错解决</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">复制service iptables restart</span><br><span class="line"># Redirecting to &#x2F;bin&#x2F;systemctl restart  iptables.service</span><br><span class="line"># Failed to restart iptables.service: Unit iptables.service failed to load: No such file or directory.</span><br></pre></td></tr></table></figure>

<p>在CentOS 7或RHEL 7或Fedora中防火墙由 <strong>firewalld</strong> 来管理，当然你可以还原传统的管理方式。或则使用新的命令进行管理。<br>假如采用传统请执行一下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">复制# 传统命令</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl mask firewalld</span><br><span class="line">复制# 安装命令</span><br><span class="line">yum install iptables-services</span><br><span class="line"></span><br><span class="line">systemctl enable iptables </span><br><span class="line">service iptables restart</span><br></pre></td></tr></table></figure>

<h2 id="nginx卸载"><a href="#nginx卸载" class="headerlink" title="nginx卸载"></a>nginx卸载</h2><p>如果通过yum安装，使用下面命令安装。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">复制yum remove nginx</span><br></pre></td></tr></table></figure>

<p>编译安装，删除/usr/local/nginx目录即可<br>如果配置了自启动脚本，也需要删除。</p>
<h2 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h2><table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">–prefix=<code>&lt;path&gt;</code></td>
<td align="left">Nginx安装路径。如果没有指定，默认为 /usr/local/nginx。</td>
</tr>
<tr>
<td align="left">–sbin-path=<code>&lt;path&gt;</code></td>
<td align="left">Nginx可执行文件安装路径。只能安装时指定，如果没有指定，默认为<code>&lt;prefix&gt;</code>/sbin/nginx。</td>
</tr>
<tr>
<td align="left">–conf-path=<code>&lt;path&gt;</code></td>
<td align="left">在没有给定-c选项下默认的nginx.conf的路径。如果没有指定，默认为<code>&lt;prefix&gt;</code>/conf/nginx.conf。</td>
</tr>
<tr>
<td align="left">–pid-path=<code>&lt;path&gt;</code></td>
<td align="left">在nginx.conf中没有指定pid指令的情况下，默认的nginx.pid的路径。如果没有指定，默认为 <code>&lt;prefix&gt;</code>/logs/nginx.pid。</td>
</tr>
<tr>
<td align="left">–lock-path=<code>&lt;path&gt;</code></td>
<td align="left">nginx.lock文件的路径。</td>
</tr>
<tr>
<td align="left">–error-log-path=<code>&lt;path&gt;</code></td>
<td align="left">在nginx.conf中没有指定error_log指令的情况下，默认的错误日志的路径。如果没有指定，默认为 <code>&lt;prefix&gt;</code>/- logs/error.log。</td>
</tr>
<tr>
<td align="left">–http-log-path=<code>&lt;path&gt;</code></td>
<td align="left">在nginx.conf中没有指定access_log指令的情况下，默认的访问日志的路径。如果没有指定，默认为 <code>&lt;prefix&gt;</code>/- logs/access.log。</td>
</tr>
<tr>
<td align="left">–user=<code>&lt;user&gt;</code></td>
<td align="left">在nginx.conf中没有指定user指令的情况下，默认的nginx使用的用户。如果没有指定，默认为 nobody。</td>
</tr>
<tr>
<td align="left">–group=<code>&lt;group&gt;</code></td>
<td align="left">在nginx.conf中没有指定user指令的情况下，默认的nginx使用的组。如果没有指定，默认为 nobody。</td>
</tr>
<tr>
<td align="left">–builddir=DIR</td>
<td align="left">指定编译的目录</td>
</tr>
<tr>
<td align="left">–with-rtsig_module</td>
<td align="left">启用 rtsig 模块</td>
</tr>
<tr>
<td align="left">–with-select_module –without-select_module</td>
<td align="left">允许或不允许开启SELECT模式，如果 configure 没有找到更合适的模式，比如：kqueue(sun os),epoll (linux kenel 2.6+), rtsig(- 实时信号)或者/dev/poll(一种类似select的模式，底层实现与SELECT基本相 同，都是采用轮训方法) SELECT模式将是默认安装模式</td>
</tr>
<tr>
<td align="left">–with-poll_module –without-poll_module</td>
<td align="left">Whether or not to enable the poll module. This module is enabled by, default if a more suitable method such as kqueue, epoll, rtsig or /dev/poll is not discovered by configure.</td>
</tr>
<tr>
<td align="left">–with-http_ssl_module</td>
<td align="left">Enable ngx_http_ssl_module. Enables SSL support and the ability to handle HTTPS requests. Requires OpenSSL. On Debian, this is libssl-dev. 开启HTTP SSL模块，使NGINX可以支持HTTPS请求。这个模块需要已经安装了OPENSSL，在DEBIAN上是libssl</td>
</tr>
<tr>
<td align="left">–with-http_realip_module</td>
<td align="left">启用 ngx_http_realip_module</td>
</tr>
<tr>
<td align="left">–with-http_addition_module</td>
<td align="left">启用 ngx_http_addition_module</td>
</tr>
<tr>
<td align="left">–with-http_sub_module</td>
<td align="left">启用 ngx_http_sub_module</td>
</tr>
<tr>
<td align="left">–with-http_dav_module</td>
<td align="left">启用 ngx_http_dav_module</td>
</tr>
<tr>
<td align="left">–with-http_flv_module</td>
<td align="left">启用 ngx_http_flv_module</td>
</tr>
<tr>
<td align="left">–with-http_stub_status_module</td>
<td align="left">启用 “server status” 页</td>
</tr>
<tr>
<td align="left">–without-http_charset_module</td>
<td align="left">禁用 ngx_http_charset_module</td>
</tr>
<tr>
<td align="left">–without-http_gzip_module</td>
<td align="left">禁用 ngx_http_gzip_module. 如果启用，需要 zlib 。</td>
</tr>
<tr>
<td align="left">–without-http_ssi_module</td>
<td align="left">禁用 ngx_http_ssi_module</td>
</tr>
<tr>
<td align="left">–without-http_userid_module</td>
<td align="left">禁用 ngx_http_userid_module</td>
</tr>
<tr>
<td align="left">–without-http_access_module</td>
<td align="left">禁用 ngx_http_access_module</td>
</tr>
<tr>
<td align="left">–without-http_auth_basic_module</td>
<td align="left">禁用 ngx_http_auth_basic_module</td>
</tr>
<tr>
<td align="left">–without-http_autoindex_module</td>
<td align="left">禁用 ngx_http_autoindex_module</td>
</tr>
<tr>
<td align="left">–without-http_geo_module</td>
<td align="left">禁用 ngx_http_geo_module</td>
</tr>
<tr>
<td align="left">–without-http_map_module</td>
<td align="left">禁用 ngx_http_map_module</td>
</tr>
<tr>
<td align="left">–without-http_referer_module</td>
<td align="left">禁用 ngx_http_referer_module</td>
</tr>
<tr>
<td align="left">–without-http_rewrite_module</td>
<td align="left">禁用 ngx_http_rewrite_module. 如果启用需要 PCRE 。</td>
</tr>
<tr>
<td align="left">–without-http_proxy_module</td>
<td align="left">禁用 ngx_http_proxy_module</td>
</tr>
<tr>
<td align="left">–without-http_fastcgi_module</td>
<td align="left">禁用 ngx_http_fastcgi_module</td>
</tr>
<tr>
<td align="left">–without-http_memcached_module</td>
<td align="left">禁用 ngx_http_memcached_module</td>
</tr>
<tr>
<td align="left">–without-http_limit_zone_module</td>
<td align="left">禁用 ngx_http_limit_zone_module</td>
</tr>
<tr>
<td align="left">–without-http_empty_gif_module</td>
<td align="left">禁用 ngx_http_empty_gif_module</td>
</tr>
<tr>
<td align="left">–without-http_browser_module</td>
<td align="left">禁用 ngx_http_browser_module</td>
</tr>
<tr>
<td align="left">–without-http_upstream_ip_hash_module</td>
<td align="left">禁用 ngx_http_upstream_ip_hash_module</td>
</tr>
<tr>
<td align="left">–with-http_perl_module</td>
<td align="left">启用 ngx_http_perl_module</td>
</tr>
<tr>
<td align="left">–with-perl_modules_path=PATH</td>
<td align="left">指定 perl 模块的路径</td>
</tr>
<tr>
<td align="left">–with-perl=PATH</td>
<td align="left">指定 perl 执行文件的路径</td>
</tr>
<tr>
<td align="left">–http-log-path=PATH</td>
<td align="left">Set path to the http access log</td>
</tr>
<tr>
<td align="left">–http-client-body-temp-path=PATH</td>
<td align="left">Set path to the http client request body temporary files</td>
</tr>
<tr>
<td align="left">–http-proxy-temp-path=PATH</td>
<td align="left">Set path to the http proxy temporary files</td>
</tr>
<tr>
<td align="left">–http-fastcgi-temp-path=PATH</td>
<td align="left">Set path to the http fastcgi temporary files</td>
</tr>
<tr>
<td align="left">–without-http</td>
<td align="left">禁用 HTTP server</td>
</tr>
<tr>
<td align="left">–with-mail</td>
<td align="left">启用 IMAP4/POP3/SMTP 代理模块</td>
</tr>
<tr>
<td align="left">–with-mail_ssl_module</td>
<td align="left">启用 ngx_mail_ssl_module</td>
</tr>
<tr>
<td align="left">–with-cc=PATH</td>
<td align="left">指定 C 编译器的路径</td>
</tr>
<tr>
<td align="left">–with-cpp=PATH</td>
<td align="left">指定 C 预处理器的路径</td>
</tr>
<tr>
<td align="left">–with-cc-opt=OPTIONS</td>
<td align="left">Additional parameters which will be added to the variable CFLAGS. With the use of the system library PCRE in FreeBSD, it is necessary to indicate –with-cc-opt=”-I /usr/local/include”. If we are using select() and it is necessary to increase the number of file descriptors, then this also can be assigned here: –with-cc-opt=”-D FD_SETSIZE=2048”.</td>
</tr>
<tr>
<td align="left">–with-ld-opt=OPTIONS</td>
<td align="left">Additional parameters passed to the linker. With the use of the system library PCRE in - FreeBSD, it is necessary to indicate –with-ld-opt=”-L /usr/local/lib”.</td>
</tr>
<tr>
<td align="left">–with-cpu-opt=CPU</td>
<td align="left">为特定的 CPU 编译，有效的值包括：pentium, pentiumpro, pentium3, pentium4, athlon, opteron, amd64, sparc32, sparc64, ppc64</td>
</tr>
<tr>
<td align="left">–without-pcre</td>
<td align="left">禁止 PCRE 库的使用。同时也会禁止 HTTP rewrite 模块。在 “location” 配置指令中的正则表达式也需要 PCRE 。</td>
</tr>
<tr>
<td align="left">–with-pcre=DIR</td>
<td align="left">指定 PCRE 库的源代码的路径。</td>
</tr>
<tr>
<td align="left">–with-pcre-opt=OPTIONS</td>
<td align="left">Set additional options for PCRE building.</td>
</tr>
<tr>
<td align="left">–with-md5=DIR</td>
<td align="left">Set path to md5 library sources.</td>
</tr>
<tr>
<td align="left">–with-md5-opt=OPTIONS</td>
<td align="left">Set additional options for md5 building.</td>
</tr>
<tr>
<td align="left">–with-md5-asm</td>
<td align="left">Use md5 assembler sources.</td>
</tr>
<tr>
<td align="left">–with-sha1=DIR</td>
<td align="left">Set path to sha1 library sources.</td>
</tr>
<tr>
<td align="left">–with-sha1-opt=OPTIONS</td>
<td align="left">Set additional options for sha1 building.</td>
</tr>
<tr>
<td align="left">–with-sha1-asm</td>
<td align="left">Use sha1 assembler sources.</td>
</tr>
<tr>
<td align="left">–with-zlib=DIR</td>
<td align="left">Set path to zlib library sources.</td>
</tr>
<tr>
<td align="left">–with-zlib-opt=OPTIONS</td>
<td align="left">Set additional options for zlib building.</td>
</tr>
<tr>
<td align="left">–with-zlib-asm=CPU</td>
<td align="left">Use zlib assembler sources optimized for specified CPU, valid values are: pentium, pentiumpro</td>
</tr>
<tr>
<td align="left">–with-openssl=DIR</td>
<td align="left">Set path to OpenSSL library sources</td>
</tr>
<tr>
<td align="left">–with-openssl-opt=OPTIONS</td>
<td align="left">Set additional options for OpenSSL building</td>
</tr>
<tr>
<td align="left">–with-debug</td>
<td align="left">启用调试日志</td>
</tr>
<tr>
<td align="left">–add-module=PATH</td>
<td align="left">Add in a third-party module found in directory PATH</td>
</tr>
</tbody></table>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>在Centos 默认配置文件在 <strong>/usr/local/nginx-1.5.1/conf/nginx.conf</strong> 我们要在这里配置一些文件。nginx.conf是主配置文件，由若干个部分组成，每个大括号<code>{}</code>表示一个部分。每一行指令都由分号结束<code>;</code>，标志着一行的结束。</p>
<h3 id="常用正则"><a href="#常用正则" class="headerlink" title="常用正则"></a>常用正则</h3><table>
<thead>
<tr>
<th align="left">正则</th>
<th align="left">说明</th>
<th align="left">正则</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>.</code></td>
<td align="left">匹配除换行符以外的任意字符</td>
<td align="left"><code>$</code></td>
<td align="left">匹配字符串的结束</td>
</tr>
<tr>
<td align="left"><code>?</code></td>
<td align="left">重复0次或1次</td>
<td align="left"><code>{n}</code></td>
<td align="left">重复n次</td>
</tr>
<tr>
<td align="left"><code>+</code></td>
<td align="left">重复1次或更多次</td>
<td align="left"><code>{n,}</code></td>
<td align="left">重复n次或更多次</td>
</tr>
<tr>
<td align="left"><code>*</code></td>
<td align="left">重复0次或更多次</td>
<td align="left"><code>[c]</code></td>
<td align="left">匹配单个字符c</td>
</tr>
<tr>
<td align="left"><code>\d</code></td>
<td align="left">匹配数字</td>
<td align="left"><code>[a-z]</code></td>
<td align="left">匹配a-z小写字母的任意一个</td>
</tr>
<tr>
<td align="left"><code>^</code></td>
<td align="left">匹配字符串的开始</td>
<td align="left">-</td>
<td align="left">-</td>
</tr>
</tbody></table>
<h3 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h3><table>
<thead>
<tr>
<th align="left">变量</th>
<th align="left">说明</th>
<th align="left">变量</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">$args</td>
<td align="left">这个变量等于请求行中的参数，同$query_string</td>
<td align="left">$remote_port</td>
<td align="left">客户端的端口。</td>
</tr>
<tr>
<td align="left">$content_length</td>
<td align="left">请求头中的Content-length字段。</td>
<td align="left">$remote_user</td>
<td align="left">已经经过Auth Basic Module验证的用户名。</td>
</tr>
<tr>
<td align="left">$content_type</td>
<td align="left">请求头中的Content-Type字段。</td>
<td align="left">$request_filename</td>
<td align="left">当前请求的文件路径，由root或alias指令与URI请求生成。</td>
</tr>
<tr>
<td align="left">$document_root</td>
<td align="left">当前请求在root指令中指定的值。</td>
<td align="left">$scheme</td>
<td align="left">HTTP方法（如http，https）。</td>
</tr>
<tr>
<td align="left">$host</td>
<td align="left">请求主机头字段，否则为服务器名称。</td>
<td align="left">$server_protocol</td>
<td align="left">请求使用的协议，通常是HTTP/1.0或HTTP/1.1。</td>
</tr>
<tr>
<td align="left">$http_user_agent</td>
<td align="left">客户端agent信息</td>
<td align="left">$server_addr</td>
<td align="left">服务器地址，在完成一次系统调用后可以确定这个值。</td>
</tr>
<tr>
<td align="left">$http_cookie</td>
<td align="left">客户端cookie信息</td>
<td align="left">$server_name</td>
<td align="left">服务器名称。</td>
</tr>
<tr>
<td align="left">$limit_rate</td>
<td align="left">这个变量可以限制连接速率。</td>
<td align="left">$server_port</td>
<td align="left">请求到达服务器的端口号。</td>
</tr>
<tr>
<td align="left">$request_method</td>
<td align="left">客户端请求的动作，通常为GET或POST。</td>
<td align="left">$request_uri</td>
<td align="left">包含请求参数的原始URI，不包含主机名，如：/foo/bar.php?arg=baz。</td>
</tr>
<tr>
<td align="left">$remote_addr</td>
<td align="left">客户端的IP地址。</td>
<td align="left">$uri</td>
<td align="left">不带请求参数的当前URI，$uri不包含主机名，如/foo/bar.html。</td>
</tr>
<tr>
<td align="left">$document_uri</td>
<td align="left">与$uri相同。</td>
<td align="left">-</td>
<td align="left">-</td>
</tr>
</tbody></table>
<p>例如请求：<code>http://localhost:3000/test1/test2/test.php</code></p>
<p>$host：localhost<br>$server_port：3000<br>$request_uri：/test1/test2/test.php<br>$document_uri：/test1/test2/test.php<br>$document_root：/var/www/html<br>$request_filename：/var/www/html/test1/test2/test.php</p>
<h3 id="符号参考"><a href="#符号参考" class="headerlink" title="符号参考"></a>符号参考</h3><table>
<thead>
<tr>
<th align="left">符号</th>
<th align="left">说明</th>
<th align="left">符号</th>
<th align="left">说明</th>
<th align="left">符号</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">k,K</td>
<td align="left">千字节</td>
<td align="left">m,M</td>
<td align="left">兆字节</td>
<td align="left">ms</td>
<td align="left">毫秒</td>
</tr>
<tr>
<td align="left">s</td>
<td align="left">秒</td>
<td align="left">m</td>
<td align="left">分钟</td>
<td align="left">h</td>
<td align="left">小时</td>
</tr>
<tr>
<td align="left">d</td>
<td align="left">日</td>
<td align="left">w</td>
<td align="left">周</td>
<td align="left">M</td>
<td align="left">一个月, 30天</td>
</tr>
</tbody></table>
<p>例如，”8k”，”1m” 代表字节数计量。<br>例如，”1h 30m”，”1y 6M”。代表 “1小时 30分”，”1年零6个月”。</p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>nginx 的配置系统由一个主配置文件和其他一些辅助的配置文件构成。这些配置文件均是纯文本文件，全部位于 nginx 安装目录下的 conf 目录下。</p>
<p>指令由 nginx 的各个模块提供，不同的模块会提供不同的指令来实现配置。<br>指令除了 Key-Value 的形式，还有作用域指令。</p>
<p>nginx.conf 中的配置信息，根据其逻辑上的意义，对它们进行了分类，也就是分成了多个作用域，或者称之为配置指令上下文。不同的作用域含有一个或者多个配置项。</p>
<p>下面的这些上下文指令是用的比较多：</p>
<table>
<thead>
<tr>
<th align="left">Directive</th>
<th align="left">Description</th>
<th align="left">Contains Directive</th>
</tr>
</thead>
<tbody><tr>
<td align="left">main</td>
<td align="left">nginx 在运行时与具体业务功能（比如 http 服务或者 email 服务代理）无关的一些参数，比如工作进程数，运行的身份等。</td>
<td align="left">user, worker_processes, error_log, events, http, mail</td>
</tr>
<tr>
<td align="left">http</td>
<td align="left">与提供 http 服务相关的一些配置参数。例如：是否使用 keepalive 啊，是否使用 gzip 进行压缩等。</td>
<td align="left">server</td>
</tr>
<tr>
<td align="left">server</td>
<td align="left">http 服务上支持若干虚拟主机。每个虚拟主机一个对应的 server 配置项，配置项里面包含该虚拟主机相关的配置。在提供 mail 服务的代理时，也可以建立若干 server. 每个 server 通过监听的地址来区分。</td>
<td align="left">listen, server_name, access_log, location, protocol, proxy, smtp_auth, xclient</td>
</tr>
<tr>
<td align="left">location</td>
<td align="left">http 服务中，某些特定的 URL 对应的一系列配置项。</td>
<td align="left">index, root</td>
</tr>
<tr>
<td align="left">mail</td>
<td align="left">实现 email 相关的 SMTP/IMAP/POP3 代理时，共享的一些配置项（因为可能实现多个代理，工作在多个监听地址上）。</td>
<td align="left">server, http, imap_capabilities</td>
</tr>
<tr>
<td align="left">include</td>
<td align="left">以便增强配置文件的可读性，使得部分配置文件可以重新使用。</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">valid_referers</td>
<td align="left">用来校验Http请求头Referer是否有效。</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">try_files</td>
<td align="left">用在server部分，不过最常见的还是用在location部分，它会按照给定的参数顺序进行尝试，第一个被匹配到的将会被使用。</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">if</td>
<td align="left">当在location块中使用if指令，在某些情况下它并不按照预期运行，一般来说避免使用if指令。</td>
<td align="left">-</td>
</tr>
</tbody></table>
<p>例如我们再 <strong>nginx.conf</strong> 里面引用两个配置 vhost/example.com.conf 和 vhost/gitlab.com.conf 它们都被放在一个我自己新建的目录 vhost 下面。nginx.conf 配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">复制worker_processes  1;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application&#x2F;octet-stream;</span><br><span class="line"></span><br><span class="line">    #log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span><br><span class="line">    #                  &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span><br><span class="line">    #                  &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;</span><br><span class="line"></span><br><span class="line">    #access_log  logs&#x2F;access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        error_page   500 502 503 504  &#x2F;50x.html;</span><br><span class="line">        location &#x3D; &#x2F;50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    include  vhost&#x2F;example.com.conf;</span><br><span class="line">    include  vhost&#x2F;gitlab.com.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单的配置: example.com.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">复制server &#123;</span><br><span class="line">    #侦听的80端口</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  baidu.com app.baidu.com; # 这里指定域名</span><br><span class="line">    index        index.html index.htm;    # 这里指定默认入口页面</span><br><span class="line">    root &#x2F;home&#x2F;www&#x2F;app.baidu.com;         # 这里指定目录</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="内置预定义变量"><a href="#内置预定义变量" class="headerlink" title="内置预定义变量"></a>内置预定义变量</h3><p>Nginx提供了许多预定义的变量，也可以通过使用set来设置变量。你可以在if中使用预定义变量，也可以将它们传递给代理服务器。以下是一些常见的预定义变量，<a href="http://nginx.org/en/docs/varindex.html" target="_blank" rel="noopener">更多详见</a></p>
<table>
<thead>
<tr>
<th align="left">变量名称</th>
<th align="left">值</th>
</tr>
</thead>
<tbody><tr>
<td align="left">$args_name</td>
<td align="left">在请求中的name参数</td>
</tr>
<tr>
<td align="left">$args</td>
<td align="left">所有请求参数</td>
</tr>
<tr>
<td align="left">$query_string</td>
<td align="left">$args的别名</td>
</tr>
<tr>
<td align="left">$content_length</td>
<td align="left">请求头Content-Length的值</td>
</tr>
<tr>
<td align="left">$content_type</td>
<td align="left">请求头Content-Type的值</td>
</tr>
<tr>
<td align="left">$host</td>
<td align="left">如果当前有Host，则为请求头Host的值；如果没有这个头，那么该值等于匹配该请求的server_name的值</td>
</tr>
<tr>
<td align="left">$remote_addr</td>
<td align="left">客户端的IP地址</td>
</tr>
<tr>
<td align="left">$request</td>
<td align="left">完整的请求，从客户端收到，包括Http请求方法、URI、Http协议、头、请求体</td>
</tr>
<tr>
<td align="left">$request_uri</td>
<td align="left">完整请求的URI，从客户端来的请求，包括参数</td>
</tr>
<tr>
<td align="left">$scheme</td>
<td align="left">当前请求的协议</td>
</tr>
<tr>
<td align="left">$uri</td>
<td align="left">当前请求的标准化URI</td>
</tr>
</tbody></table>
<h3 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h3><p>反向代理是一个Web服务器，它接受客户端的连接请求，然后将请求转发给上游服务器，并将从服务器得到的结果返回给连接的客户端。下面简单的反向代理的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">复制server &#123;  </span><br><span class="line">  listen       80;                                                        </span><br><span class="line">  server_name  localhost;                                              </span><br><span class="line">  client_max_body_size 1024M;  # 允许客户端请求的最大单文件字节数</span><br><span class="line"></span><br><span class="line">  location &#x2F; &#123;</span><br><span class="line">    proxy_pass                         http:&#x2F;&#x2F;localhost:8080;</span><br><span class="line">    proxy_set_header Host              $host:$server_port;</span><br><span class="line">    proxy_set_header X-Forwarded-For   $remote_addr; # HTTP的请求端真实的IP</span><br><span class="line">    proxy_set_header X-Forwarded-Proto $scheme;      # 为了正确地识别实际用户发出的协议是 http 还是 https</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>复杂的配置: gitlab.com.conf。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">复制server &#123;</span><br><span class="line">    #侦听的80端口</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  git.example.cn;</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        proxy_pass   http:&#x2F;&#x2F;localhost:3000;</span><br><span class="line">        #以下是一些反向代理的配置可删除</span><br><span class="line">        proxy_redirect             off;</span><br><span class="line">        #后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span><br><span class="line">        proxy_set_header           Host $host;</span><br><span class="line">        client_max_body_size       10m; #允许客户端请求的最大单文件字节数</span><br><span class="line">        client_body_buffer_size    128k; #缓冲区代理缓冲用户端请求的最大字节数</span><br><span class="line">        proxy_connect_timeout      300; #nginx跟后端服务器连接超时时间(代理连接超时)</span><br><span class="line">        proxy_send_timeout         300; #后端服务器数据回传时间(代理发送超时)</span><br><span class="line">        proxy_read_timeout         300; #连接成功后，后端服务器响应时间(代理接收超时)</span><br><span class="line">        proxy_buffer_size          4k; #设置代理服务器（nginx）保存用户头信息的缓冲区大小</span><br><span class="line">        proxy_buffers              4 32k; #proxy_buffers缓冲区，网页平均在32k以下的话，这样设置</span><br><span class="line">        proxy_busy_buffers_size    64k; #高负荷下缓冲大小（proxy_buffers*2）</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代理到上游服务器的配置中，最重要的是proxy_pass指令。以下是代理模块中的一些常用指令：</p>
<table>
<thead>
<tr>
<th align="left">指令</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">proxy_connect_timeout</td>
<td align="left">Nginx从接受请求至连接到上游服务器的最长等待时间</td>
</tr>
<tr>
<td align="left">proxy_send_timeout</td>
<td align="left">后端服务器数据回传时间(代理发送超时)</td>
</tr>
<tr>
<td align="left">proxy_read_timeout</td>
<td align="left">连接成功后，后端服务器响应时间(代理接收超时)</td>
</tr>
<tr>
<td align="left">proxy_cookie_domain</td>
<td align="left">替代从上游服务器来的Set-Cookie头的domain属性</td>
</tr>
<tr>
<td align="left">proxy_cookie_path</td>
<td align="left">替代从上游服务器来的Set-Cookie头的path属性</td>
</tr>
<tr>
<td align="left">proxy_buffer_size</td>
<td align="left">设置代理服务器（nginx）保存用户头信息的缓冲区大小</td>
</tr>
<tr>
<td align="left">proxy_buffers</td>
<td align="left">proxy_buffers缓冲区，网页平均在多少k以下</td>
</tr>
<tr>
<td align="left">proxy_set_header</td>
<td align="left">重写发送到上游服务器头的内容，也可以通过将某个头部的值设置为空字符串，而不发送某个头部的方法实现</td>
</tr>
<tr>
<td align="left">proxy_ignore_headers</td>
<td align="left">这个指令禁止处理来自代理服务器的应答。</td>
</tr>
<tr>
<td align="left">proxy_intercept_errors</td>
<td align="left">使nginx阻止HTTP应答代码为400或者更高的应答。</td>
</tr>
</tbody></table>
<h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><p>upstream指令启用一个新的配置区段，在该区段定义一组上游服务器。这些服务器可能被设置不同的权重，也可能出于对服务器进行维护，标记为down。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">复制upstream gitlab &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    # upstream的负载均衡，weight是权重，可以根据机器配置定义权重。weigth参数表示权值，权值越高被分配到的几率越大。</span><br><span class="line">    server 192.168.122.11:8081 ;</span><br><span class="line">    server 127.0.0.1:82 weight&#x3D;3;</span><br><span class="line">    server 127.0.0.1:83 weight&#x3D;3 down;</span><br><span class="line">    server 127.0.0.1:84 weight&#x3D;3; max_fails&#x3D;3  fail_timeout&#x3D;20s;</span><br><span class="line">    server 127.0.0.1:85 weight&#x3D;4;;</span><br><span class="line">    keepalive 32;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    #侦听的80端口</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  git.example.cn;</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        proxy_pass   http:&#x2F;&#x2F;gitlab;    #在这里设置一个代理，和upstream的名字一样</span><br><span class="line">        #以下是一些反向代理的配置可删除</span><br><span class="line">        proxy_redirect             off;</span><br><span class="line">        #后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span><br><span class="line">        proxy_set_header           Host $host;</span><br><span class="line">        proxy_set_header           X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header           X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        client_max_body_size       10m;  #允许客户端请求的最大单文件字节数</span><br><span class="line">        client_body_buffer_size    128k; #缓冲区代理缓冲用户端请求的最大字节数</span><br><span class="line">        proxy_connect_timeout      300;  #nginx跟后端服务器连接超时时间(代理连接超时)</span><br><span class="line">        proxy_send_timeout         300;  #后端服务器数据回传时间(代理发送超时)</span><br><span class="line">        proxy_read_timeout         300;  #连接成功后，后端服务器响应时间(代理接收超时)</span><br><span class="line">        proxy_buffer_size          4k; #设置代理服务器（nginx）保存用户头信息的缓冲区大小</span><br><span class="line">        proxy_buffers              4 32k;# 缓冲区，网页平均在32k以下的话，这样设置</span><br><span class="line">        proxy_busy_buffers_size    64k; #高负荷下缓冲大小（proxy_buffers*2）</span><br><span class="line">        proxy_temp_file_write_size 64k; #设定缓存文件夹大小，大于这个值，将从upstream服务器传</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。</p>
<p><strong>负载均衡：</strong></p>
<p>upstream模块能够使用3种负载均衡算法：轮询、IP哈希、最少连接数。</p>
<p><strong>轮询：</strong> 默认情况下使用轮询算法，不需要配置指令来激活它，它是基于在队列中谁是下一个的原理确保访问均匀地分布到每个上游服务器；<br><strong>IP哈希：</strong> 通过ip_hash指令来激活，Nginx通过IPv4地址的前3个字节或者整个IPv6地址作为哈希键来实现，同一个IP地址总是能被映射到同一个上游服务器；<br><strong>最少连接数：</strong> 通过least_conn指令来激活，该算法通过选择一个活跃数最少的上游服务器进行连接。如果上游服务器处理能力不同，可以通过给server配置weight权重来说明，该算法将考虑到不同服务器的加权最少连接数。</p>
<h4 id="RR"><a href="#RR" class="headerlink" title="RR"></a>RR</h4><p><strong>简单配置</strong> ，这里我配置了2台服务器，当然实际上是一台，只是端口不一样而已，而8081的服务器是不存在的，也就是说访问不到，但是我们访问 <code>http://localhost</code> 的时候，也不会有问题，会默认跳转到<code>http://localhost:8080</code>具体是因为Nginx会自动判断服务器的状态，如果服务器处于不能访问（服务器挂了），就不会跳转到这台服务器，所以也避免了一台服务器挂了影响使用的情况，由于Nginx默认是RR策略，所以我们不需要其他更多的设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">复制upstream test &#123;</span><br><span class="line">    server localhost:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       81;</span><br><span class="line">    server_name  localhost;</span><br><span class="line">    client_max_body_size 1024M;</span><br><span class="line"> </span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;test;</span><br><span class="line">        proxy_set_header Host $host:$server_port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>负载均衡的核心代码为</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">复制upstream test &#123;</span><br><span class="line">    server localhost:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="权重"><a href="#权重" class="headerlink" title="权重"></a>权重</h4><p>指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。 例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">复制upstream test &#123;</span><br><span class="line">    server localhost:8080 weight&#x3D;9;</span><br><span class="line">    server localhost:8081 weight&#x3D;1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么10次一般只会有1次会访问到8081，而有9次会访问到8080</p>
<h4 id="ip-hash"><a href="#ip-hash" class="headerlink" title="ip_hash"></a>ip_hash</h4><p>上面的2种方式都有一个问题，那就是下一个请求来的时候请求可能分发到另外一个服务器，当我们的程序不是无状态的时候（采用了session保存数据），这时候就有一个很大的很问题了，比如把登录信息保存到了session中，那么跳转到另外一台服务器的时候就需要重新登录了，所以很多时候我们需要一个客户只访问一个服务器，那么就需要用iphash了，iphash的每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">复制upstream test &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    server localhost:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="fair"><a href="#fair" class="headerlink" title="fair"></a>fair</h4><p>这是个第三方模块，按后端服务器的响应时间来分配请求，响应时间短的优先分配。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">复制upstream backend &#123;</span><br><span class="line">    fair;</span><br><span class="line">    server localhost:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="url-hash"><a href="#url-hash" class="headerlink" title="url_hash"></a>url_hash</h4><p>这是个第三方模块，按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务器为缓存时比较有效。 在upstream中加入hash语句，server语句中不能写入weight等其他的参数，hash_method是使用的hash算法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">复制upstream backend &#123;</span><br><span class="line">    hash $request_uri;</span><br><span class="line">    hash_method crc32;</span><br><span class="line">    server localhost:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上5种负载均衡各自适用不同情况下使用，所以可以根据实际情况选择使用哪种策略模式，不过fair和url_hash需要安装第三方模块才能使用</p>
<p><strong>server指令可选参数：</strong></p>
<ol>
<li>weight：设置一个服务器的访问权重，数值越高，收到的请求也越多；</li>
<li>fail_timeout：在这个指定的时间内服务器必须提供响应，如果在这个时间内没有收到响应，那么服务器将会被标记为down状态；</li>
<li>max_fails：设置在fail_timeout时间之内尝试对一个服务器连接的最大次数，如果超过这个次数，那么服务器将会被标记为down;</li>
<li>down：标记一个服务器不再接受任何请求；</li>
<li>backup：一旦其他服务器宕机，那么有该标记的机器将会接收请求。</li>
</ol>
<p><strong>keepalive指令：</strong></p>
<p>Nginx服务器将会为每一个worker进行保持同上游服务器的连接。</p>
<h3 id="屏蔽ip"><a href="#屏蔽ip" class="headerlink" title="屏蔽ip"></a>屏蔽ip</h3><p>在nginx的配置文件<code>nginx.conf</code>中加入如下配置，可以放到http, server, location, limit_except语句块，需要注意相对路径，本例当中<code>nginx.conf</code>，<code>blocksip.conf</code>在同一个目录中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">复制include blockip.conf;</span><br></pre></td></tr></table></figure>

<p>在blockip.conf里面输入内容，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">复制deny 165.91.122.67;</span><br><span class="line"></span><br><span class="line">deny IP;   # 屏蔽单个ip访问</span><br><span class="line">allow IP;  # 允许单个ip访问</span><br><span class="line">deny all;  # 屏蔽所有ip访问</span><br><span class="line">allow all; # 允许所有ip访问</span><br><span class="line">deny 123.0.0.0&#x2F;8   # 屏蔽整个段即从123.0.0.1到123.255.255.254访问的命令</span><br><span class="line">deny 124.45.0.0&#x2F;16 # 屏蔽IP段即从123.45.0.1到123.45.255.254访问的命令</span><br><span class="line">deny 123.45.6.0&#x2F;24 # 屏蔽IP段即从123.45.6.1到123.45.6.254访问的命令</span><br><span class="line"></span><br><span class="line"># 如果你想实现这样的应用，除了几个IP外，其他全部拒绝</span><br><span class="line">allow 1.1.1.1; </span><br><span class="line">allow 1.1.1.2;</span><br><span class="line">deny all;</span><br></pre></td></tr></table></figure>

<h2 id="第三方模块安装方法"><a href="#第三方模块安装方法" class="headerlink" title="第三方模块安装方法"></a>第三方模块安装方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">复制.&#x2F;configure --prefix&#x3D;&#x2F;你的安装目录  --add-module&#x3D;&#x2F;第三方模块目录</span><br></pre></td></tr></table></figure>

<h2 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h2><ul>
<li><code>permanent</code> 永久性重定向。请求日志中的状态码为301</li>
<li><code>redirect</code> 临时重定向。请求日志中的状态码为302</li>
</ul>
<h3 id="重定向整个网站"><a href="#重定向整个网站" class="headerlink" title="重定向整个网站"></a>重定向整个网站</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">复制server &#123;</span><br><span class="line">    server_name old-site.com</span><br><span class="line">    return 301 $scheme:&#x2F;&#x2F;new-site.com$request_uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="重定向单页"><a href="#重定向单页" class="headerlink" title="重定向单页"></a>重定向单页</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">复制server &#123;</span><br><span class="line">    location &#x3D; &#x2F;oldpage.html &#123;</span><br><span class="line">        return 301 http:&#x2F;&#x2F;example.org&#x2F;newpage.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="重定向整个子路径"><a href="#重定向整个子路径" class="headerlink" title="重定向整个子路径"></a>重定向整个子路径</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">复制location &#x2F;old-site &#123;</span><br><span class="line">    rewrite ^&#x2F;old-site&#x2F;(.*) http:&#x2F;&#x2F;example.org&#x2F;new-site&#x2F;$1 permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h2><h3 id="内容缓存"><a href="#内容缓存" class="headerlink" title="内容缓存"></a>内容缓存</h3><p>允许浏览器基本上永久地缓存静态内容。 Nginx将为您设置Expires和Cache-Control头信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">复制location &#x2F;static &#123;</span><br><span class="line">    root &#x2F;data;</span><br><span class="line">    expires max;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果要求浏览器永远不会缓存响应（例如用于跟踪请求），请使用-1。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">复制location &#x3D; &#x2F;empty.gif &#123;</span><br><span class="line">    empty_gif;</span><br><span class="line">    expires -1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Gzip压缩"><a href="#Gzip压缩" class="headerlink" title="Gzip压缩"></a>Gzip压缩</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">复制gzip  on;</span><br><span class="line">gzip_buffers 16 8k;</span><br><span class="line">gzip_comp_level 6;</span><br><span class="line">gzip_http_version 1.1;</span><br><span class="line">gzip_min_length 256;</span><br><span class="line">gzip_proxied any;</span><br><span class="line">gzip_vary on;</span><br><span class="line">gzip_types</span><br><span class="line">    text&#x2F;xml application&#x2F;xml application&#x2F;atom+xml application&#x2F;rss+xml application&#x2F;xhtml+xml image&#x2F;svg+xml</span><br><span class="line">    text&#x2F;javascript application&#x2F;javascript application&#x2F;x-javascript</span><br><span class="line">    text&#x2F;x-json application&#x2F;json application&#x2F;x-web-app-manifest+json</span><br><span class="line">    text&#x2F;css text&#x2F;plain text&#x2F;x-component</span><br><span class="line">    font&#x2F;opentype application&#x2F;x-font-ttf application&#x2F;vnd.ms-fontobject</span><br><span class="line">    image&#x2F;x-icon;</span><br><span class="line">gzip_disable  &quot;msie6&quot;;</span><br></pre></td></tr></table></figure>

<h3 id="打开文件缓存"><a href="#打开文件缓存" class="headerlink" title="打开文件缓存"></a>打开文件缓存</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">复制open_file_cache max&#x3D;1000 inactive&#x3D;20s;</span><br><span class="line">open_file_cache_valid 30s;</span><br><span class="line">open_file_cache_min_uses 2;</span><br><span class="line">open_file_cache_errors on;</span><br></pre></td></tr></table></figure>

<h3 id="SSL缓存"><a href="#SSL缓存" class="headerlink" title="SSL缓存"></a>SSL缓存</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">复制ssl_session_cache shared:SSL:10m;</span><br><span class="line">ssl_session_timeout 10m;</span><br></pre></td></tr></table></figure>

<h3 id="上游Keepalive"><a href="#上游Keepalive" class="headerlink" title="上游Keepalive"></a>上游Keepalive</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">复制upstream backend &#123;</span><br><span class="line">    server 127.0.0.1:8080;</span><br><span class="line">    keepalive 32;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    ...</span><br><span class="line">    location &#x2F;api&#x2F; &#123;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;backend;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connection &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h3><p>使用<code>ngxtop</code>实时解析nginx访问日志，并且将处理结果输出到终端，功能类似于系统命令top。所有示例都读取nginx配置文件的访问日志位置和格式。如果要指定访问日志文件和/或日志格式，请使用-f和-a选项。</p>
<p>注意：在nginx配置中<code>/usr/local/nginx/conf/nginx.conf</code>日志文件必须是绝对路径。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">复制# 安装 ngxtop</span><br><span class="line">pip install ngxtop</span><br><span class="line"></span><br><span class="line"># 实时状态</span><br><span class="line">ngxtop</span><br><span class="line"># 状态为404的前10个请求的路径：</span><br><span class="line">ngxtop top request_path --filter &#39;status &#x3D;&#x3D; 404&#39;</span><br><span class="line"></span><br><span class="line"># 发送总字节数最多的前10个请求</span><br><span class="line">ngxtop --order-by &#39;avg(bytes_sent) * count&#39;</span><br><span class="line"></span><br><span class="line"># 排名前十位的IP，例如，谁攻击你最多</span><br><span class="line">ngxtop --group-by remote_addr</span><br><span class="line"></span><br><span class="line"># 打印具有4xx或5xx状态的请求，以及status和http referer</span><br><span class="line">ngxtop -i &#39;status &gt;&#x3D; 400&#39; print request status http_referer</span><br><span class="line"></span><br><span class="line"># 由200个请求路径响应发送的平均正文字节以&#39;foo&#39;开始：</span><br><span class="line">ngxtop avg bytes_sent --filter &#39;status &#x3D;&#x3D; 200 and request_path.startswith(&quot;foo&quot;)&#39;</span><br><span class="line"></span><br><span class="line"># 使用“common”日志格式从远程机器分析apache访问日志</span><br><span class="line">ssh remote tail -f &#x2F;var&#x2F;log&#x2F;apache2&#x2F;access.log | ngxtop -f common</span><br></pre></td></tr></table></figure>

<h2 id="常见使用场景"><a href="#常见使用场景" class="headerlink" title="常见使用场景"></a>常见使用场景</h2><h3 id="跨域问题"><a href="#跨域问题" class="headerlink" title="跨域问题"></a>跨域问题</h3><p>在工作中，有时候会遇到一些接口不支持跨域，这时候可以简单的添加add_headers来支持cors跨域。配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">复制server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name api.xxx.com;</span><br><span class="line">    </span><br><span class="line">  add_header &#39;Access-Control-Allow-Origin&#39; &#39;*&#39;;</span><br><span class="line">  add_header &#39;Access-Control-Allow-Credentials&#39; &#39;true&#39;;</span><br><span class="line">  add_header &#39;Access-Control-Allow-Methods&#39; &#39;GET,POST,HEAD&#39;;</span><br><span class="line"></span><br><span class="line">  location &#x2F; &#123;</span><br><span class="line">    proxy_pass http:&#x2F;&#x2F;127.0.0.1:3000;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header Host  $http_host;    </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面更改头信息，还有一种，使用 <a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html" target="_blank" rel="noopener">rewrite</a> 指令重定向URI来解决跨域问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">复制upstream test &#123;</span><br><span class="line">  server 127.0.0.1:8080;</span><br><span class="line">  server localhost:8081;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name api.xxx.com;</span><br><span class="line">  location &#x2F; &#123; </span><br><span class="line">    root  html;                   #去请求..&#x2F;html文件夹里的文件</span><br><span class="line">    index  index.html index.htm;  #首页响应地址</span><br><span class="line">  &#125;</span><br><span class="line">  # 用于拦截请求，匹配任何以 &#x2F;api&#x2F;开头的地址，</span><br><span class="line">  # 匹配符合以后，停止往下搜索正则。</span><br><span class="line">  location ^~&#x2F;api&#x2F;&#123; </span><br><span class="line">    # 代表重写拦截进来的请求，并且只能对域名后边的除去传递的参数外的字符串起作用，</span><br><span class="line">    # 例如www.a.com&#x2F;proxy&#x2F;api&#x2F;msg?meth&#x3D;1&amp;par&#x3D;2重写，只对&#x2F;proxy&#x2F;api&#x2F;msg重写。</span><br><span class="line">    # rewrite后面的参数是一个简单的正则 ^&#x2F;api&#x2F;(.*)$，</span><br><span class="line">    # $1代表正则中的第一个()，$2代表第二个()的值，以此类推。</span><br><span class="line">    rewrite ^&#x2F;api&#x2F;(.*)$ &#x2F;$1 break;</span><br><span class="line">    </span><br><span class="line">    # 把请求代理到其他主机 </span><br><span class="line">    # 其中 http:&#x2F;&#x2F;www.b.com&#x2F; 写法和 http:&#x2F;&#x2F;www.b.com写法的区别如下</span><br><span class="line">    # 如果你的请求地址是他 http:&#x2F;&#x2F;server&#x2F;html&#x2F;test.jsp</span><br><span class="line">    # 配置一： http:&#x2F;&#x2F;www.b.com&#x2F; 后面有“&#x2F;” </span><br><span class="line">    #         将反向代理成 http:&#x2F;&#x2F;www.b.com&#x2F;html&#x2F;test.jsp 访问</span><br><span class="line">    # 配置一： http:&#x2F;&#x2F;www.b.com 后面没有有“&#x2F;” </span><br><span class="line">    #         将反向代理成 http:&#x2F;&#x2F;www.b.com&#x2F;test.jsp 访问</span><br><span class="line">    proxy_pass http:&#x2F;&#x2F;test;</span><br><span class="line"></span><br><span class="line">    # 如果 proxy_pass  URL 是 http:&#x2F;&#x2F;a.xx.com&#x2F;platform&#x2F; 这种情况</span><br><span class="line">    # proxy_cookie_path应该设置成 &#x2F;platform&#x2F; &#x2F; (注意两个斜杠之间有空格)。</span><br><span class="line">    proxy_cookie_path &#x2F;platfrom&#x2F; &#x2F;;</span><br><span class="line"></span><br><span class="line">    # http:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;docs&#x2F;http&#x2F;ngx_http_proxy_module.html#proxy_pass_header</span><br><span class="line">    # 设置 Cookie 头通过</span><br><span class="line">    proxy_pass_header Set-Cookie;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="跳转到带www的域上面"><a href="#跳转到带www的域上面" class="headerlink" title="跳转到带www的域上面"></a>跳转到带www的域上面</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">复制server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    # 配置正常的带www的域名</span><br><span class="line">    server_name www.wangchujiang.com;</span><br><span class="line">    root &#x2F;home&#x2F;www&#x2F;wabg&#x2F;download;</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        try_files $uri $uri&#x2F; &#x2F;index.html &#x3D;404;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    # 这个要放到下面，</span><br><span class="line">    # 将不带www的 wangchujiang.com 永久性重定向到  https:&#x2F;&#x2F;www.wangchujiang.com</span><br><span class="line">    server_name wangchujiang.com;</span><br><span class="line">    rewrite ^(.*) https:&#x2F;&#x2F;www.wangchujiang.com$1 permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="代理转发"><a href="#代理转发" class="headerlink" title="代理转发"></a>代理转发</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">复制upstream server-api&#123;</span><br><span class="line">    # api 代理服务地址</span><br><span class="line">    server 127.0.0.1:3110;    </span><br><span class="line">&#125;</span><br><span class="line">upstream server-resource&#123;</span><br><span class="line">    # 静态资源 代理服务地址</span><br><span class="line">    server 127.0.0.1:3120;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       3111;</span><br><span class="line">    server_name  localhost;      # 这里指定域名</span><br><span class="line">    root &#x2F;home&#x2F;www&#x2F;server-statics;</span><br><span class="line">    # 匹配 api 路由的反向代理到API服务</span><br><span class="line">    location ^~&#x2F;api&#x2F; &#123;</span><br><span class="line">        rewrite ^&#x2F;(.*)$ &#x2F;$1 break;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;server-api;</span><br><span class="line">    &#125;</span><br><span class="line">    # 假设这里验证码也在API服务中</span><br><span class="line">    location ^~&#x2F;captcha &#123;</span><br><span class="line">        rewrite ^&#x2F;(.*)$ &#x2F;$1 break;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;server-api;</span><br><span class="line">    &#125;</span><br><span class="line">    # 假设你的图片资源全部在另外一个服务上面</span><br><span class="line">    location ^~&#x2F;img&#x2F; &#123;</span><br><span class="line">        rewrite ^&#x2F;(.*)$ &#x2F;$1 break;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;server-resource;</span><br><span class="line">    &#125;</span><br><span class="line">    # 路由在前端，后端没有真实路由，在路由不存在的 404状态的页面返回 &#x2F;index.html</span><br><span class="line">    # 这个方式使用场景，你在写React或者Vue项目的时候，没有真实路由</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        try_files $uri $uri&#x2F; &#x2F;index.html &#x3D;404;</span><br><span class="line">        #                               ^ 空格很重要</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="监控状态信息"><a href="#监控状态信息" class="headerlink" title="监控状态信息"></a>监控状态信息</h3><p>通过 <code>nginx -V</code> 来查看是否有 <code>with-http_stub_status_module</code> 该模块。</p>
<blockquote>
<p><code>nginx -V</code> 这里 <code>V</code> 是大写的，如果是小写的 <code>v</code> 即 <code>nginx -v</code>，则不会出现有哪些模块，只会出现 <code>nginx</code> 的版本</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">复制location &#x2F;nginx_status &#123;</span><br><span class="line">    stub_status on;</span><br><span class="line">    access_log off;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 <a href="http://127.0.0.1/nginx_status" target="_blank" rel="noopener">http://127.0.0.1/nginx_status</a> 访问出现下面结果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">复制Active connections: 3</span><br><span class="line">server accepts handled requests</span><br><span class="line"> 7 7 5 </span><br><span class="line">Reading: 0 Writing: 1 Waiting: 2</span><br></pre></td></tr></table></figure>

<ol>
<li>主动连接(第 1 行)</li>
</ol>
<p>当前与http建立的连接数，包括等待的客户端连接：3</p>
<ol>
<li>服务器接受处理的请求(第 2~3 行)</li>
</ol>
<p>接受的客户端连接总数目：7<br>处理的客户端连接总数目：7<br>客户端总的请求数目：5</p>
<ol>
<li>读取其它信(第 4 行)</li>
</ol>
<p>当前，nginx读请求连接<br>当前，nginx写响应返回给客户端<br>目前有多少空闲客户端请求连接</p>
<h3 id="代理转发连接替换"><a href="#代理转发连接替换" class="headerlink" title="代理转发连接替换"></a>代理转发连接替换</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">复制location ^~&#x2F;api&#x2F;upload &#123;</span><br><span class="line">    rewrite ^&#x2F;(.*)$ &#x2F;wfs&#x2F;v1&#x2F;upload break;</span><br><span class="line">    proxy_pass http:&#x2F;&#x2F;wfs-api;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ssl配置"><a href="#ssl配置" class="headerlink" title="ssl配置"></a>ssl配置</h3><p>超文本传输安全协议（缩写：HTTPS，英语：Hypertext Transfer Protocol Secure）是超文本传输协议和SSL/TLS的组合，用以提供加密通讯及对网络服务器身份的鉴定。HTTPS连接经常被用于万维网上的交易支付和企业信息系统中敏感信息的传输。HTTPS不应与在RFC 2660中定义的安全超文本传输协议（S-HTTP）相混。HTTPS 目前已经是所有注重隐私和安全的网站的首选，随着技术的不断发展，HTTPS 网站已不再是大型网站的专利，所有普通的个人站长和博客均可以自己动手搭建一个安全的加密的网站。</p>
<p>创建SSL证书，如果你购买的证书，就可以直接下载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">复制sudo mkdir &#x2F;etc&#x2F;nginx&#x2F;ssl</span><br><span class="line"># 创建了有效期100年，加密强度为RSA2048的SSL密钥key和X509证书文件。</span><br><span class="line">sudo openssl req -x509 -nodes -days 36500 -newkey rsa:2048 -keyout &#x2F;etc&#x2F;nginx&#x2F;ssl&#x2F;nginx.key -out &#x2F;etc&#x2F;nginx&#x2F;ssl&#x2F;nginx.crt</span><br><span class="line"># 上面命令，会有下面需要填写内容</span><br><span class="line">Country Name (2 letter code) [AU]:US</span><br><span class="line">State or Province Name (full name) [Some-State]:New York</span><br><span class="line">Locality Name (eg, city) []:New York City</span><br><span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:Bouncy Castles, Inc.</span><br><span class="line">Organizational Unit Name (eg, section) []:Ministry of Water Slides</span><br><span class="line">Common Name (e.g. server FQDN or YOUR name) []:your_domain.com</span><br><span class="line">Email Address []:admin@your_domain.com</span><br></pre></td></tr></table></figure>

<p>创建自签证书</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">复制首先，创建证书和私钥的目录</span><br><span class="line"># mkdir -p &#x2F;etc&#x2F;nginx&#x2F;cert</span><br><span class="line"># cd &#x2F;etc&#x2F;nginx&#x2F;cert</span><br><span class="line">创建服务器私钥，命令会让你输入一个口令：</span><br><span class="line"># openssl genrsa -des3 -out nginx.key 2048</span><br><span class="line">创建签名请求的证书（CSR）：</span><br><span class="line"># openssl req -new -key nginx.key -out nginx.csr</span><br><span class="line">在加载SSL支持的Nginx并使用上述私钥时除去必须的口令：</span><br><span class="line"># cp nginx.key nginx.key.org</span><br><span class="line"># openssl rsa -in nginx.key.org -out nginx.key</span><br><span class="line">最后标记证书使用上述私钥和CSR：</span><br><span class="line"># openssl x509 -req -days 365 -in nginx.csr -signkey nginx.key -out nginx.crt</span><br></pre></td></tr></table></figure>

<p>查看目前nginx编译选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">复制sbin&#x2F;nginx -V</span><br></pre></td></tr></table></figure>

<p>输出下面内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">复制nginx version: nginx&#x2F;1.7.8</span><br><span class="line">built by gcc 4.4.7 20120313 (Red Hat 4.4.7-4) (GCC)</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx-1.7.8 --with-http_ssl_module --with-http_spdy_module --with-http_stub_status_module --with-pcre</span><br></pre></td></tr></table></figure>

<p>如果依赖的模块不存在，可以进入安装目录，输入下面命令重新编译安装。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">复制.&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx --with-http_stub_status_module --with-http_ssl_module</span><br></pre></td></tr></table></figure>

<p>运行完成之后还需要<code>make</code> (不用make install)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">复制# 备份nginx的二进制文件</span><br><span class="line">cp -rf &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx　 &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx.bak</span><br><span class="line"># 覆盖nginx的二进制文件</span><br><span class="line">cp -rf objs&#x2F;nginx   &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;</span><br></pre></td></tr></table></figure>

<p>HTTPS server</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">复制server &#123;</span><br><span class="line">    listen       443 ssl;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    ssl_certificate &#x2F;etc&#x2F;nginx&#x2F;ssl&#x2F;nginx.crt;</span><br><span class="line">    ssl_certificate_key &#x2F;etc&#x2F;nginx&#x2F;ssl&#x2F;nginx.key;</span><br><span class="line">    # 禁止在header中出现服务器版本，防止黑客利用版本漏洞攻击</span><br><span class="line">    server_tokens off;</span><br><span class="line">    # 设置ssl&#x2F;tls会话缓存的类型和大小。如果设置了这个参数一般是shared，buildin可能会参数内存碎片，默认是none，和off差不多，停用缓存。如shared:SSL:10m表示我所有的nginx工作进程共享ssl会话缓存，官网介绍说1M可以存放约4000个sessions。 </span><br><span class="line">    ssl_session_cache    shared:SSL:1m; </span><br><span class="line"></span><br><span class="line">    # 客户端可以重用会话缓存中ssl参数的过期时间，内网系统默认5分钟太短了，可以设成30m即30分钟甚至4h。</span><br><span class="line">    ssl_session_timeout  5m; </span><br><span class="line"></span><br><span class="line">    # 选择加密套件，不同的浏览器所支持的套件（和顺序）可能会不同。</span><br><span class="line">    # 这里指定的是OpenSSL库能够识别的写法，你可以通过 openssl -v cipher &#39;RC4:HIGH:!aNULL:!MD5&#39;（后面是你所指定的套件加密算法） 来看所支持算法。</span><br><span class="line">    ssl_ciphers  HIGH:!aNULL:!MD5;</span><br><span class="line"></span><br><span class="line">    # 设置协商加密算法时，优先使用我们服务端的加密套件，而不是客户端浏览器的加密套件。</span><br><span class="line">    ssl_prefer_server_ciphers  on;</span><br><span class="line"></span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        root   html;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="强制将http重定向到https"><a href="#强制将http重定向到https" class="headerlink" title="强制将http重定向到https"></a>强制将http重定向到https</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">复制server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  example.com;</span><br><span class="line">    rewrite ^ https:&#x2F;&#x2F;$http_host$request_uri? permanent;    # 强制将http重定向到https</span><br><span class="line">    # 在错误页面和“服务器”响应头字段中启用或禁用发射nginx版本。 防止黑客利用版本漏洞攻击</span><br><span class="line">    server_tokens off;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="两个虚拟主机"><a href="#两个虚拟主机" class="headerlink" title="两个虚拟主机"></a>两个虚拟主机</h3><p>纯静态-html 支持</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">复制http &#123;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen          80;</span><br><span class="line">        server_name     www.domain1.com;</span><br><span class="line">        access_log      logs&#x2F;domain1.access.log main;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            index index.html;</span><br><span class="line">            root  &#x2F;var&#x2F;www&#x2F;domain1.com&#x2F;htdocs;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen          80;</span><br><span class="line">        server_name     www.domain2.com;</span><br><span class="line">        access_log      logs&#x2F;domain2.access.log main;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            index index.html;</span><br><span class="line">            root  &#x2F;var&#x2F;www&#x2F;domain2.com&#x2F;htdocs;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="虚拟主机标准配置"><a href="#虚拟主机标准配置" class="headerlink" title="虚拟主机标准配置"></a>虚拟主机标准配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">复制http &#123;</span><br><span class="line">  server &#123;</span><br><span class="line">    listen          80 default;</span><br><span class="line">    server_name     _ *;</span><br><span class="line">    access_log      logs&#x2F;default.access.log main;</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">       index index.html;</span><br><span class="line">       root  &#x2F;var&#x2F;www&#x2F;default&#x2F;htdocs;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="爬虫过滤"><a href="#爬虫过滤" class="headerlink" title="爬虫过滤"></a>爬虫过滤</h3><p>根据 <code>User-Agent</code> 过滤请求，通过一个简单的正则表达式，就可以过滤不符合要求的爬虫请求(初级爬虫)。</p>
<blockquote>
<p><code>~*</code> 表示不区分大小写的正则匹配</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">复制location &#x2F; &#123;</span><br><span class="line">    if ($http_user_agent ~* &quot;python|curl|java|wget|httpclient|okhttp&quot;) &#123;</span><br><span class="line">        return 503;</span><br><span class="line">    &#125;</span><br><span class="line">    # 正常处理</span><br><span class="line">    # ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="防盗链"><a href="#防盗链" class="headerlink" title="防盗链"></a>防盗链</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">复制location ~* \.(gif|jpg|png|swf|flv)$ &#123;</span><br><span class="line">   root html</span><br><span class="line">   valid_referers none blocked *.nginxcn.com;</span><br><span class="line">   if ($invalid_referer) &#123;</span><br><span class="line">     rewrite ^&#x2F; www.nginx.cn</span><br><span class="line">     #return 404;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="虚拟目录配置"><a href="#虚拟目录配置" class="headerlink" title="虚拟目录配置"></a>虚拟目录配置</h3><p>alias指定的目录是准确的，root是指定目录的上级目录，并且该上级目录要含有location指定名称的同名目录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">复制location &#x2F;img&#x2F; &#123;</span><br><span class="line">    alias &#x2F;var&#x2F;www&#x2F;image&#x2F;;</span><br><span class="line">&#125;</span><br><span class="line"># 访问&#x2F;img&#x2F;目录里面的文件时，ningx会自动去&#x2F;var&#x2F;www&#x2F;image&#x2F;目录找文件</span><br><span class="line">location &#x2F;img&#x2F; &#123;</span><br><span class="line">    root &#x2F;var&#x2F;www&#x2F;image;</span><br><span class="line">&#125;</span><br><span class="line"># 访问&#x2F;img&#x2F;目录下的文件时，nginx会去&#x2F;var&#x2F;www&#x2F;image&#x2F;img&#x2F;目录下找文件。]</span><br></pre></td></tr></table></figure>

<h3 id="防盗图配置"><a href="#防盗图配置" class="headerlink" title="防盗图配置"></a>防盗图配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">复制location ~ \&#x2F;public\&#x2F;(css|js|img)\&#x2F;.*\.(js|css|gif|jpg|jpeg|png|bmp|swf) &#123;</span><br><span class="line">    valid_referers none blocked *.jslite.io;</span><br><span class="line">    if ($invalid_referer) &#123;</span><br><span class="line">        rewrite ^&#x2F;  http:&#x2F;&#x2F;wangchujiang.com&#x2F;piratesp.png;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="屏蔽-git等文件"><a href="#屏蔽-git等文件" class="headerlink" title="屏蔽.git等文件"></a>屏蔽.git等文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">复制location ~ (.git|.gitattributes|.gitignore|.svn) &#123;</span><br><span class="line">    deny all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="域名路径加不加需要都能正常访问"><a href="#域名路径加不加需要都能正常访问" class="headerlink" title="域名路径加不加需要都能正常访问"></a>域名路径加不加需要都能正常访问</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">复制http:&#x2F;&#x2F;wangchujiang.com&#x2F;api&#x2F;index.php?a&#x3D;1&amp;name&#x3D;wcj</span><br><span class="line">                                  ^ 有后缀</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;wangchujiang.com&#x2F;api&#x2F;index?a&#x3D;1&amp;name&#x3D;wcj</span><br><span class="line">                                 ^ 没有后缀</span><br></pre></td></tr></table></figure>

<p>nginx rewrite规则如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">复制rewrite ^&#x2F;(.*)&#x2F;$ &#x2F;index.php?&#x2F;$1 permanent;</span><br><span class="line">if (!-d $request_filename)&#123;</span><br><span class="line">        set $rule_1 1$rule_1;</span><br><span class="line">&#125;</span><br><span class="line">if (!-f $request_filename)&#123;</span><br><span class="line">        set $rule_1 2$rule_1;</span><br><span class="line">&#125;</span><br><span class="line">if ($rule_1 &#x3D; &quot;21&quot;)&#123;</span><br><span class="line">        rewrite ^&#x2F; &#x2F;index.php last;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="错误问题"><a href="#错误问题" class="headerlink" title="错误问题"></a>错误问题</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">复制The plain HTTP request was sent to HTTPS port</span><br></pre></td></tr></table></figure>

<p>解决办法，<code>fastcgi_param HTTPS $https if_not_empty</code> 添加这条规则，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">复制server &#123;</span><br><span class="line">    listen 443 ssl; # 注意这条规则</span><br><span class="line">    server_name  my.domain.com;</span><br><span class="line">    </span><br><span class="line">    fastcgi_param HTTPS $https if_not_empty;</span><br><span class="line">    fastcgi_param HTTPS on;</span><br><span class="line"></span><br><span class="line">    ssl_certificate &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;your.pem;</span><br><span class="line">    ssl_certificate_key &#x2F;etc&#x2F;ssl&#x2F;private&#x2F;your.key;</span><br><span class="line"></span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        # Your config here...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Nginx-模块"><a href="#Nginx-模块" class="headerlink" title="Nginx 模块"></a>Nginx 模块</h2><ul>
<li><a href="https://gitlab.com/rbdr/ngx_http_office_hours_filter_module" target="_blank" rel="noopener">Nginx Office Hours</a> 一个 nginx 模块，允许您仅在办公时间内提供访问访问网站。</li>
</ul>
<h2 id="精品文章参考"><a href="#精品文章参考" class="headerlink" title="精品文章参考"></a>精品文章参考</h2><ul>
<li><p><a href="https://my.oschina.net/u/3341316/blog/877206" target="_blank" rel="noopener">负载均衡原理的解析</a></p>
</li>
<li><p><a href="http://blog.githuber.cn/posts/73" target="_blank" rel="noopener">Nginx泛域名解析，实现多个二级域名</a></p>
</li>
<li><p><a href="https://www.nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/" target="_blank" rel="noopener">深入 NGINX: 我们如何设计性能和扩展</a></p>
</li>
<li><p><a href="https://www.nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/" target="_blank" rel="noopener">Inside NGINX: How We Designed for Performance &amp; Scale</a></p>
</li>
<li><p><a href="http://tengine.taobao.org/book/index.html" target="_blank" rel="noopener">Nginx开发从入门到精通</a></p>
</li>
<li><p><a href="http://os.51cto.com/art/201703/535326.htm#topx" target="_blank" rel="noopener">Nginx的优化与防盗链</a></p>
</li>
<li><p><a href="https://segmentfault.com/a/1190000009769143" target="_blank" rel="noopener">实战开发一个Nginx扩展 (Nginx Module)</a></p>
</li>
<li><p><a href="https://my.oschina.net/xshuai/blog/917097" target="_blank" rel="noopener">Nginx+Keepalived(双机热备)搭建高可用负载均衡环境(HA)</a></p>
</li>
<li><p><a href="http://www.huxd.org/articles/2017/07/24/1500890692329.html" target="_blank" rel="noopener">Nginx 平滑升级</a></p>
</li>
<li><p><a href="https://mp.weixin.qq.com/s?__biz=MzIxNzg5ODE0OA==&mid=2247483708&idx=1&sn=90b0b1dccd9c337922a0588245277666&chksm=97f38cf7a08405e1928e0b46d923d630e529e7db8ac7ca2a91310a075986f8bcb2cee5b4953d#rd" target="_blank" rel="noopener">Nginx最新模块—ngx_http_mirror_module分析可以做版本发布前的预先验证，进行流量放大后的压测等等</a></p>
<p>原文链接<a href="https://www.viayc.com/2019/03/13/Nginx%E9%85%8D%E7%BD%AE%E6%95%99%E7%A8%8B/" target="_blank" rel="noopener">https://www.viayc.com/2019/03/13/Nginx%E9%85%8D%E7%BD%AE%E6%95%99%E7%A8%8B/</a></p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/">上一页</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/">下一页</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/zpj.jpg"
                alt="zhangpengjie" />
            
              <p class="site-author-name" itemprop="name">zhangpengjie</p>
              <p class="site-description motion-element" itemprop="description">愿你在任何困难面前都足够坚强</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">33</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://cn.bing.com/" title="必应" target="_blank">必应</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhangpengjie</span>

  
</div>


  <div class="powered-by">爱分享爱自由</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'SFffbOWnbxhEhkvt0mSxlD0E-gzGzoHsz',
        appKey: 'gdvigtTA0Ux7TDRUmqRJMoTV',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
