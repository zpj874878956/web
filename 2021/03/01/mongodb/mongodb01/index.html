<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="mongodb," />





  <link rel="alternate" href="/atom.xml" title="zpj" type="application/atom+xml" />






<meta name="description" content="MongoDB(一)2020-09-12 1. MongoDB 相关概念1.1 业务应用场景传统的关系型数据库（如MySQL），在数据操作的“三高”需求以及应对Web2.0的网站需求面前，显得力不从心。 解释：“三高”需求：  High performance - 对数据库高并发读写的需求。 Huge Storage - 对海量数据的高效率存储和访问的需求。 High Scalability &amp;a">
<meta property="og:type" content="article">
<meta property="og:title" content="mongodb一">
<meta property="og:url" content="http://yoursite.com/2021/03/01/mongodb/mongodb01/index.html">
<meta property="og:site_name" content="zpj">
<meta property="og:description" content="MongoDB(一)2020-09-12 1. MongoDB 相关概念1.1 业务应用场景传统的关系型数据库（如MySQL），在数据操作的“三高”需求以及应对Web2.0的网站需求面前，显得力不从心。 解释：“三高”需求：  High performance - 对数据库高并发读写的需求。 Huge Storage - 对海量数据的高效率存储和访问的需求。 High Scalability &amp;a">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200912222258123.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200912222345916.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200912222408267.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200912222446304.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200912222502355.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200912222523315.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200912222541442.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200912222603862.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200912222620711.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200912222637894.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200912222653761.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200912222709789.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200912222735575.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200912222748699.png">
<meta property="article:published_time" content="2021-03-01T14:10:22.526Z">
<meta property="article:modified_time" content="2021-03-01T14:10:22.518Z">
<meta property="article:author" content="zhangpengjie">
<meta property="article:tag" content="mongodb">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/20200912222258123.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2021/03/01/mongodb/mongodb01/"/>





  <title>mongodb一 | zpj</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<!-- 加入APlayer音乐播放器 -->
<link rel="stylesheet" href="/dist/APlayer.min.css">
<div id="aplayer"></div>
<script type="text/javascript" src="/dist/APlayer.min.js"></script>
<script type="text/javascript" src="/dist/music.js"></script>

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zpj</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">好好学习天天向上</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/03/01/mongodb/mongodb01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhangpengjie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/zpj.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zpj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">mongodb一</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-03-01T22:10:22+08:00">
                2021-03-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mongodb/" itemprop="url" rel="index">
                    <span itemprop="name">mongodb</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/03/01/mongodb/mongodb01/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2021/03/01/mongodb/mongodb01/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="MongoDB-一"><a href="#MongoDB-一" class="headerlink" title="MongoDB(一)"></a>MongoDB(一)</h1><p><a href="https://wgy1993.gitee.io/archives/d69f1e.html" target="_blank" rel="noopener">2020-09-12</a></p>
<h1 id="1-MongoDB-相关概念"><a href="#1-MongoDB-相关概念" class="headerlink" title="1. MongoDB 相关概念"></a>1. MongoDB 相关概念</h1><h2 id="1-1-业务应用场景"><a href="#1-1-业务应用场景" class="headerlink" title="1.1 业务应用场景"></a>1.1 业务应用场景</h2><p>传统的关系型数据库（如MySQL），在数据操作的“三高”需求以及应对Web2.0的网站需求面前，显得力不从心。</p>
<p>解释：“三高”需求：</p>
<ul>
<li>High performance - 对数据库高并发读写的需求。</li>
<li>Huge Storage - 对海量数据的高效率存储和访问的需求。</li>
<li>High Scalability &amp;&amp; High Availability- 对数据库的高可扩展性和高可用性的需求。</li>
</ul>
<p><strong>而MongoDB可应对“三高”需求。</strong></p>
<p>具体的应用场景如：</p>
<ul>
<li>社交场景，使用 MongoDB 存储存储用户信息，以及用户发表的朋友圈信息，通过地理位置索引实现附近的人、地点等功能。</li>
<li>游戏场景，使用 MongoDB 存储游戏用户信息，用户的装备、积分等直接以内嵌文档的形式存储，方便查询、高效率存储和访问。</li>
<li>物流场景，使用 MongoDB 存储订单信息，订单状态在运送过程中会不断更新，以 MongoDB 内嵌数组的形式来存储，一次查询就能将订单所有的变更读取出来。</li>
<li>物联网场景，使用 MongoDB 存储所有接入的智能设备信息，以及设备汇报的日志信息，并对这些信息进行多维度的分析。</li>
<li>视频直播，使用 MongoDB 存储用户信息、点赞互动信息等。</li>
</ul>
<p>这些应用场景中，数据操作方面的共同特点是：</p>
<ul>
<li>数据量大</li>
<li>写入操作频繁（读写都很频繁）</li>
<li>价值较低的数据，对事务性要求不高</li>
</ul>
<p>对于这样的数据，我们更适合使用MongoDB来实现数据的存储。</p>
<p><strong>什么时候选择MongoDB</strong></p>
<p>在架构选型上，除了上述的三个特点外，如果你还犹豫是否要选择它？可以考虑以下的一些问题：</p>
<ul>
<li>应用不需要事务及复杂 join 支持</li>
<li>新应用，需求会变，数据模型无法确定，想快速迭代开发</li>
<li>应用需要2000-3000以上的读写QPS（更高也可以）</li>
<li>应用需要TB甚至 PB 级别数据存储</li>
<li>应用发展迅速，需要能快速水平扩展</li>
<li>应用要求存储的数据不丢失</li>
<li>应用需要99.999%高可用</li>
<li>应用需要大量的地理位置查询、文本查询</li>
</ul>
<p>如果上述有1个符合，可以考虑 MongoDB，2个及以上的符合，选择 MongoDB 绝不会后悔。</p>
<h2 id="1-2-MongoDB-简介"><a href="#1-2-MongoDB-简介" class="headerlink" title="1.2 MongoDB 简介"></a>1.2 MongoDB 简介</h2><p>MongoDB是一个开源、高性能、无模式的文档型数据库，当初的设计就是用于简化开发和方便扩展，是NoSQL数据库产品中的一种。是最像关系型数据库（MySQL）的非关系型数据库。</p>
<p>它支持的数据结构非常松散，是一种类似于 JSON 的 格式叫BSON，所以它既可以存储比较复杂的数据类型，又相当的灵活。</p>
<p>MongoDB中的记录是一个文档，它是一个由字段和值对（field:value）组成的数据结构。MongoDB文档类似于JSON对象，即一个文档认为就是一个对象。字段的数据类型是字符型，它的值除了使用基本的一些类型外，还可以包括其他文档、普通数组和文档数组。</p>
<h2 id="1-3-体系结构"><a href="#1-3-体系结构" class="headerlink" title="1.3 体系结构"></a>1.3 体系结构</h2><p>MySQL和MongoDB对比</p>
<p><img src="https://img-blog.csdnimg.cn/20200912222258123.png" alt="image-20200912105858071"></p>
<table>
<thead>
<tr>
<th>SQL 术语/概念</th>
<th>MongoDB术语/概念</th>
<th>解释/说明</th>
</tr>
</thead>
<tbody><tr>
<td>database</td>
<td>database</td>
<td>数据库</td>
</tr>
<tr>
<td>table</td>
<td>collection</td>
<td>数据库表/集合</td>
</tr>
<tr>
<td>row</td>
<td>document</td>
<td>数据记录行/文档</td>
</tr>
<tr>
<td>column</td>
<td>field</td>
<td>数据字段/域</td>
</tr>
<tr>
<td>index</td>
<td>index</td>
<td>索引</td>
</tr>
<tr>
<td>table joins</td>
<td></td>
<td>表连接,MongoDB不支持</td>
</tr>
<tr>
<td></td>
<td>嵌入文档</td>
<td>MongoDB通过嵌入式文档来替代多表连接</td>
</tr>
<tr>
<td>primary key</td>
<td>primary key</td>
<td>主键,MongoDB自动将_id字段设置为主键</td>
</tr>
</tbody></table>
<h2 id="1-4-数据模型"><a href="#1-4-数据模型" class="headerlink" title="1.4 数据模型"></a>1.4 数据模型</h2><p>MongoDB的最小存储单位就是文档(document)对象。文档(document)对象对应于关系型数据库的行。数据在MongoDB中以BSON（Binary-JSON）文档的格式存储在磁盘上。</p>
<p>BSON（Binary Serialized Document Format）是一种类json的一种二进制形式的存储格式，简称Binary JSON。BSON和JSON一样，支持内嵌的文档对象和数组对象，但是BSON有JSON没有的一些数据类型，如Date和BinData类型。</p>
<p>BSON采用了类似于 C 语言结构体的名称、对表示方法，支持内嵌的文档对象和数组对象，具有轻量性、可遍历性、高效性的三个特点，可以有效描述非结构化数据和结构化数据。这种格式的优点是灵活性高，但它的缺点是空间利用率不是很理想。</p>
<p>Bson中，除了基本的JSON类型：string,integer,boolean,double,null,array和object，mongo还使用了特殊的数据类型。这些类型包括date,object id,binary data,regular expression 和code。每一个驱动都以特定语言的方式实现了这些类型，查看你的驱动的文档来获取详细信息。</p>
<p>BSON数据类型参考列表：</p>
<table>
<thead>
<tr>
<th>数据类型</th>
<th>描述</th>
<th>举例</th>
</tr>
</thead>
<tbody><tr>
<td>字符串</td>
<td>UTF-8字符串都可表示为字符串类型的数据</td>
<td>{“x” : “foobar”}</td>
</tr>
<tr>
<td>对象id</td>
<td>对象id是文档的12字节的唯一 ID</td>
<td>{“X” :ObjectId() }</td>
</tr>
<tr>
<td>布尔值</td>
<td>真或者假：true或者false</td>
<td>{“x”:true}</td>
</tr>
<tr>
<td>数组</td>
<td>值的集合或者列表可以表示成数组</td>
<td>{“x” ： [“a”, “b”, “c”]}</td>
</tr>
<tr>
<td>32位整数</td>
<td>类型不可用。JavaScript仅支持64位浮点数，所以32位整数会被自动转换。</td>
<td>shell是不支持该类型的，shell中默认会转换成64位浮点数</td>
</tr>
<tr>
<td>64位整数</td>
<td>不支持这个类型。shell会使用一个特殊的内嵌文档来显示64位整数</td>
<td>shell是不支持该类型的，shell中默认会转换成64位浮点数</td>
</tr>
<tr>
<td>64位浮点数</td>
<td>shell中的数字就是这一种类型</td>
<td>{“x”：3.14159，”y”：3}</td>
</tr>
<tr>
<td>null</td>
<td>表示空值或者未定义的对象</td>
<td>{“x”:null}</td>
</tr>
<tr>
<td>undefined</td>
<td>文档中也可以使用未定义类型</td>
<td>{“x”:undefined}</td>
</tr>
<tr>
<td>符号</td>
<td>shell不支持，shell会将数据库中的符号类型的数据自动转换成字符串</td>
<td></td>
</tr>
<tr>
<td>正则表达式</td>
<td>文档中可以包含正则表达式，采用JavaScript的正则表达式语法</td>
<td>{“x” ： /foobar/i}</td>
</tr>
<tr>
<td>代码</td>
<td>文档中还可以包含JavaScript代码</td>
<td>{“x” ： function() { /* …… */ }}</td>
</tr>
<tr>
<td>二进制数据</td>
<td>二进制数据可以由任意字节的串组成，不过shell中无法使用</td>
<td></td>
</tr>
<tr>
<td>最大值/最小值</td>
<td>BSON包括一个特殊类型，表示可能的最大值。shell中没有这个类型。</td>
<td></td>
</tr>
</tbody></table>
<p>提示：</p>
<p>shell默认使用64位浮点型数值。{“x”：3.14}或{“x”：3}。对于整型值，可以使用NumberInt（4字节符号整数）或NumberLong（8字节符号整数），{“x”:NumberInt(“3”)}{“x”:NumberLong(“3”)}</p>
<h2 id="1-5-MongoDB-的特点"><a href="#1-5-MongoDB-的特点" class="headerlink" title="1.5 MongoDB 的特点"></a>1.5 MongoDB 的特点</h2><p>MongoDB主要有如下特点：</p>
<ul>
<li><p>高性能：</p>
<p>MongoDB提供高性能的数据持久性。特别是</p>
<p>对嵌入式数据模型的支持减少了数据库系统上的I/O活动。</p>
<p>索引支持更快的查询，并且可以包含来自嵌入式文档和数组的键。（文本索引解决搜索的需求、TTL索引解决历史数据自动过期的需求、地理位置索引可用于构建各种 O2O 应用）</p>
<p>mmapv1、wiredtiger、mongorocks（rocksdb）、in-memory 等多引擎支持满足各种场景需求。</p>
<p>Gridfs解决文件存储的需求。</p>
</li>
<li><p>高可用性：</p>
<p>MongoDB的复制工具称为副本集（replica set），它可提供自动故障转移和数据冗余。</p>
</li>
<li><p>高扩展性：</p>
<p>MongoDB提供了水平可扩展性作为其核心功能的一部分。</p>
<p>分片将数据分布在一组集群的机器上。（海量数据存储，服务能力水平扩展）</p>
<p>从3.4开始，MongoDB支持基于片键创建数据区域。在一个平衡的集群中，MongoDB将一个区域所覆盖的读写只定向到该区域内的那些片。</p>
</li>
<li><p>丰富的查询支持：</p>
<p>MongoDB支持丰富的查询语言，支持读和写操作(CRUD)，比如数据聚合、文本搜索和地理空间查询等。</p>
</li>
<li><p>其他特点：如无模式（动态模式）、灵活的文档模型、</p>
</li>
</ul>
<h1 id="2-单机部署"><a href="#2-单机部署" class="headerlink" title="2. 单机部署"></a>2. 单机部署</h1><h2 id="2-1-Windows-系统中的安装启动"><a href="#2-1-Windows-系统中的安装启动" class="headerlink" title="2.1 Windows 系统中的安装启动"></a>2.1 Windows 系统中的安装启动</h2><h3 id="2-1-1-下载安装包"><a href="#2-1-1-下载安装包" class="headerlink" title="2.1.1 下载安装包"></a>2.1.1 下载安装包</h3><p>MongoDB 提供了可用于 32 位和 64 位系统的预编译二进制包，你可以从MongoDB官网下载安装，MongoDB 预编译二进制包下地址：<a href="https://www.mongodb.com/download-center#community" target="_blank" rel="noopener">https://www.mongodb.com/download-center#community</a></p>
<p><img src="https://img-blog.csdnimg.cn/20200912222345916.png" alt="image-20200912113819545"></p>
<p>根据上图所示下载 zip 包。</p>
<p>提示：版本的选择：</p>
<p>MongoDB的版本命名规范如：x.y.z；</p>
<p>y为奇数时表示当前版本为开发版，如：1.5.2、4.1.13；</p>
<p>y为偶数时表示当前版本为稳定版，如：1.6.3、4.0.10；</p>
<p>z是修正版本号，数字越大越好。</p>
<p>详情： <a href="http://docs.mongodb.org/manual/release-notes/#release-version-numbers" target="_blank" rel="noopener">http://docs.mongodb.org/manual/release-notes/#release-version-numbers</a></p>
<h3 id="2-1-2-解压安装启动"><a href="#2-1-2-解压安装启动" class="headerlink" title="2.1.2 解压安装启动"></a>2.1.2 解压安装启动</h3><p>将压缩包解压到一个目录中。在解压目录中，手动建立一个目录用于存放数据文件，如 data/db</p>
<p><strong>方式1：命令行参数方式启动服务</strong></p>
<p>在 bin 目录中打开命令行提示符，输入如下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --dbpath&#x3D;..\data\db</span><br></pre></td></tr></table></figure>

<p>我们在启动信息中可以看到， mongoDB的默认端口是27017，如果我们想改变默认的启动端口，可以通过–port来指定端口。</p>
<p>为了方便我们每次启动，可以将安装目录的bin目录设置到环境变量的path中， bin 目录下是一些常用命令，比如 mongod 启动服务用的，mongo 客户端连接服务用的。</p>
<p><strong>方式2：配置文件方式启动服务</strong></p>
<p>在解压目录中新建 config 文件夹，该文件夹中新建配置文件 mongod.conf ，内如参考如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">storage:</span><br><span class="line">    #The directory where the mongod instance stores its data.Default Value is &quot;\data\db&quot; on Windows.</span><br><span class="line">    dbPath: D:\mongodb-win32-x86_64-2008plus-ssl-4.0.1\data</span><br></pre></td></tr></table></figure>

<p>详细配置项内容可以参考官方文档： <a href="https://docs.mongodb.com/manual/reference/configuration-options/" target="_blank" rel="noopener">https://docs.mongodb.com/manual/reference/configuration-options/</a></p>
<p><strong>【注意】</strong></p>
<ul>
<li><p>配置文件中如果使用双引号，比如路径地址，自动会将双引号的内容转义。如果不转义，则会报错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error-parsing-yaml-config-file-yaml-cpp-error-at-line-3-column-15-unknown-escape-character-d</span><br></pre></td></tr></table></figure>

<p>解决：</p>
<p>a. 对 \ 换成 / 或 \</p>
<p>b. 如果路径中没有空格，则无需加引号。</p>
</li>
<li><p>配置文件中不能以Tab分割字段</p>
<p>解决：</p>
<p>将其转换成空格。</p>
</li>
</ul>
<p>启动方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mongod -f ..&#x2F;config&#x2F;mongod.conf</span><br><span class="line">或</span><br><span class="line">mongod --config ..&#x2F;config&#x2F;mongod.conf</span><br></pre></td></tr></table></figure>

<p>更多参数配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">    destination: file</span><br><span class="line">    #The path of the log file to which mongod or mongos should send all diagnostic logging information</span><br><span class="line">    path: &quot;D:&#x2F;mongodb-win32-x86_64-2008plus-ssl-4.0.1&#x2F;log&#x2F;mongod.log&quot;</span><br><span class="line">    logAppend: true</span><br><span class="line">storage:</span><br><span class="line">    journal:</span><br><span class="line">      enabled: true</span><br><span class="line">    #The directory where the mongod instance stores its data.Default Value is &quot;&#x2F;data&#x2F;db&quot;.</span><br><span class="line">    dbPath: &quot;D:&#x2F;mongodb-win32-x86_64-2008plus-ssl-4.0.1&#x2F;data&quot;</span><br><span class="line">net:</span><br><span class="line">    #bindIp: 127.0.0.1</span><br><span class="line">    port: 27017</span><br><span class="line">setParameter:</span><br><span class="line">    enableLocalhostAuthBypass: false</span><br></pre></td></tr></table></figure>

<h2 id="2-2-Shell-连接-mongo命令"><a href="#2-2-Shell-连接-mongo命令" class="headerlink" title="2.2 Shell 连接(mongo命令)"></a>2.2 Shell 连接(mongo命令)</h2><p>在命令提示符输入以下shell命令即可完成登陆</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mongo</span><br><span class="line">或</span><br><span class="line">mongo --host&#x3D;127.0.0.1 --port&#x3D;27017</span><br></pre></td></tr></table></figure>

<h3 id="2-2-1-查看已经有的数据库"><a href="#2-2-1-查看已经有的数据库" class="headerlink" title="2.2.1 查看已经有的数据库"></a>2.2.1 查看已经有的数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show databases</span><br></pre></td></tr></table></figure>

<h3 id="2-2-2-退出-mongodb"><a href="#2-2-2-退出-mongodb" class="headerlink" title="2.2.2 退出 mongodb"></a>2.2.2 退出 mongodb</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br></pre></td></tr></table></figure>

<p>更多参数可以通过帮助查看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo --help</span><br></pre></td></tr></table></figure>

<p>提示：</p>
<p>MongoDB javascript shell是一个基于javascript的解释器，故是支持js程序的。</p>
<h2 id="2-3-Compass-图形化界面客户端"><a href="#2-3-Compass-图形化界面客户端" class="headerlink" title="2.3 Compass- 图形化界面客户端"></a>2.3 Compass- 图形化界面客户端</h2><p>到MongoDB官网下载MongoDB Compass，地址： <a href="https://www.mongodb.com/download-center/v2/compass?initial=true" target="_blank" rel="noopener">https://www.mongodb.com/download-center/v2/compass?initial=true</a></p>
<p>如果是下载安装版，则按照步骤安装；如果是下载加压缩版，直接解压，执行里面的MongoDBCompassCommunity.exe 文件即可。</p>
<p>在打开的界面中，输入主机地址、端口等相关信息，点击连接：</p>
<p><img src="https://img-blog.csdnimg.cn/20200912222408267.png" alt="image-20200912120121079"></p>
<h2 id="2-4-Linux-系统中的安装启动和连接"><a href="#2-4-Linux-系统中的安装启动和连接" class="headerlink" title="2.4 Linux 系统中的安装启动和连接"></a>2.4 Linux 系统中的安装启动和连接</h2><p>目标：在Linux中部署一个单机的MongoDB，作为生产环境下使用。</p>
<p>提示：和Windows下操作差不多。</p>
<p>步骤如下：</p>
<ul>
<li><p>先到官网下载压缩包 mongod -linux-x86_64-4.0.10.tgz 。</p>
</li>
<li><p>上传压缩包到Linux中，解压到当前目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf mongodb-linux-x86_64-4.0.10.tgz</span><br></pre></td></tr></table></figure>
</li>
<li><p>移动解压后的文件夹到指定的目录中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv mongodb-linux-x86_64-4.0.10 &#x2F;usr&#x2F;local&#x2F;mongodb</span><br></pre></td></tr></table></figure>
</li>
<li><p>新建几个目录，分别用来存储数据和日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#数据存储目录</span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;single&#x2F;data&#x2F;db</span><br><span class="line">#日志存储目录</span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;single&#x2F;log</span><br></pre></td></tr></table></figure>
</li>
<li><p>新建并修改配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;mongodb&#x2F;single&#x2F;mongod.conf</span><br></pre></td></tr></table></figure>

<p>配置文件的内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">      #MongoDB发送所有日志输出的目标指定为文件</span><br><span class="line">      # #The path of the log file to which mongod or mongos should send all diagnostic logging information</span><br><span class="line">      destination: file</span><br><span class="line">      #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span><br><span class="line">      path: &quot;&#x2F;mongodb&#x2F;single&#x2F;log&#x2F;mongod.log&quot;</span><br><span class="line">      #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span><br><span class="line">      logAppend: true</span><br><span class="line">storage:</span><br><span class="line">      #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span><br><span class="line">      ##The directory where the mongod instance stores its data.Default Value is &quot;&#x2F;data&#x2F;db&quot;.</span><br><span class="line">      dbPath: &quot;&#x2F;mongodb&#x2F;single&#x2F;data&#x2F;db&quot;</span><br><span class="line">      journal:</span><br><span class="line">          #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">          enabled: true</span><br><span class="line">processManagement:</span><br><span class="line">      #启用在后台运行mongos或mongod进程的守护进程模式。</span><br><span class="line">      fork: true</span><br><span class="line">net:</span><br><span class="line">      #服务实例绑定的IP，默认是localhost</span><br><span class="line">      bindIp: localhost,192.168.142.128</span><br><span class="line">      #bindIp</span><br><span class="line">      #绑定的端口，默认是27017</span><br><span class="line">      port: 27017</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动MongoDB服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;single&#x2F;mongod.conf</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<p>如果启动后不是 successfully ，则是启动失败了。原因基本上就是配置文件有问题。</p>
<p>通过进程来查看服务是否启动了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef |grep mongod</span><br></pre></td></tr></table></figure>
</li>
<li><p>分别使用mongo命令和compass工具来连接测试。</p>
<p>提示：如果远程连接不上，需要配置防火墙放行，或直接关闭linux防火墙</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#查看防火墙状态</span><br><span class="line">systemctl status firewalld</span><br><span class="line">#临时关闭防火墙</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">#开机禁止启动防火墙</span><br><span class="line">systemctl disable firewalld</span><br></pre></td></tr></table></figure>
</li>
<li><p>停止关闭服务</p>
<p>停止服务的方式有两种：快速关闭和标准关闭，下面依次说明：</p>
<p><strong>（一）快速关闭方法（快速，简单，数据可能会出错）</strong></p>
<p>目标：通过系统的kill命令直接杀死进程：</p>
<p>杀完要检查一下，避免有的没有杀掉。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#通过进程编号关闭节点</span><br><span class="line">kill -2 54410</span><br></pre></td></tr></table></figure>

<p>【补充】</p>
<p>如果一旦是因为数据损坏，则需要进行如下操作（了解）：</p>
<p>1）删除lock文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -f &#x2F;mongodb&#x2F;single&#x2F;data&#x2F;db&#x2F;*.lock</span><br></pre></td></tr></table></figure>

<p>2 ）修复数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;mongdb&#x2F;bin&#x2F;mongod --repair --dbpath&#x3D;&#x2F;mongodb&#x2F;single&#x2F;data&#x2F;db</span><br></pre></td></tr></table></figure>

<p><strong>（二）标准的关闭方法（数据不容易出错，但麻烦）：</strong></p>
<p>目标：通过mongo客户端中的shutdownServer命令来关闭服务</p>
<p>主要的操作步骤参考如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;客户端登录服务，注意，这里通过localhost登录，如果需要远程登录，必须先登录认证才行。</span><br><span class="line">mongo --port 27017</span><br><span class="line">&#x2F;&#x2F;#切换到admin库</span><br><span class="line">use admin</span><br><span class="line">&#x2F;&#x2F;关闭服务</span><br><span class="line">db.shutdownServer()</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="3-基本常用命令"><a href="#3-基本常用命令" class="headerlink" title="3. 基本常用命令"></a>3. 基本常用命令</h1><h2 id="3-1-案例需求"><a href="#3-1-案例需求" class="headerlink" title="3.1 案例需求"></a>3.1 案例需求</h2><p>存放文章评论的数据存放到MongoDB中，数据结构参考如下：</p>
<p>数据库：articledb</p>
<table>
<thead>
<tr>
<th>专栏文章评论</th>
<th>comment</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>字段名称</td>
<td>字段含义</td>
<td>字段类型</td>
<td>备注</td>
</tr>
<tr>
<td>_id</td>
<td>ID</td>
<td>ObjectId或String</td>
<td>Mongo的主键的字段</td>
</tr>
<tr>
<td>articleid</td>
<td>文章ID</td>
<td>String</td>
<td></td>
</tr>
<tr>
<td>content</td>
<td>评论内容</td>
<td>String</td>
<td></td>
</tr>
<tr>
<td>userid</td>
<td>评论人ID</td>
<td>String</td>
<td></td>
</tr>
<tr>
<td>nickname</td>
<td>评论人昵称</td>
<td>String</td>
<td></td>
</tr>
<tr>
<td>createdatetime</td>
<td>评论的日期时间</td>
<td>Date</td>
<td></td>
</tr>
<tr>
<td>likenum</td>
<td>点赞数</td>
<td>Int32</td>
<td></td>
</tr>
<tr>
<td>replynum</td>
<td>回复数</td>
<td>Int32</td>
<td></td>
</tr>
<tr>
<td>state</td>
<td>状态</td>
<td>String</td>
<td>0：不可见；1：可见；</td>
</tr>
<tr>
<td>parentid</td>
<td>上级ID</td>
<td>String</td>
<td>如果为0表示文章的顶级评论</td>
</tr>
</tbody></table>
<h2 id="3-2-数据库操作"><a href="#3-2-数据库操作" class="headerlink" title="3.2 数据库操作"></a>3.2 数据库操作</h2><h3 id="3-2-1-选择和创建数据库"><a href="#3-2-1-选择和创建数据库" class="headerlink" title="3.2.1 选择和创建数据库"></a>3.2.1 选择和创建数据库</h3><p>选择和创建数据库的语法格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use 数据库名称</span><br></pre></td></tr></table></figure>

<p>如果数据库不存在则自动创建，例如，以下语句创建 articledb 数据库：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use articledb</span><br></pre></td></tr></table></figure>

<p>查看有权限的所有的数据库命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show dbs</span><br><span class="line">或</span><br><span class="line">show databases</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意 : 在 MongoDB 中，集合只有在内容插入后才会创建! 就是说，创建集合(数据表)后要再插入一个文档(记录)，集合才会真正创建。</p>
</blockquote>
<p>查看当前正在使用的数据库命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db</span><br></pre></td></tr></table></figure>

<p>MongoDB 中默认的数据库为 test，如果你没有选择数据库，集合将存放在 test 数据库中。</p>
<p>另外：</p>
<p>数据库名可以是满足以下条件的任意UTF-8字符串。</p>
<ul>
<li>不能是空字符串（ “”)。</li>
<li>不得含有 ‘ ‘（空格)、.、$、/、\和\0 (空字符)。</li>
<li>应全部小写。</li>
<li>最多 64字节。</li>
</ul>
<p>有一些数据库名是保留的，可以直接访问这些有特殊作用的数据库。</p>
<ul>
<li>admin ： 从权限的角度来看，这是”root”数据库。要是将一个用户添加到这个数据库，这个用户自动继承所有数据库的权限。一些特定的服务器端命令也只能从这个数据库运行，比如列出所有的数据库或者关闭服务器。</li>
<li>local: 这个数据永远不会被复制，可以用来存储限于本地单台服务器的任意集合</li>
<li>config : 当Mongo用于分片设置时，config数据库在内部使用，用于保存分片的相关信息。</li>
</ul>
<h3 id="3-2-2-数据库的删除"><a href="#3-2-2-数据库的删除" class="headerlink" title="3.2.2 数据库的删除"></a>3.2.2 数据库的删除</h3><p>MongoDB 删除数据库的语法格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.dropDatabase()</span><br></pre></td></tr></table></figure>

<p>提示：主要用来删除已经持久化的数据库</p>
<h2 id="3-3-集合操作"><a href="#3-3-集合操作" class="headerlink" title="3.3 集合操作"></a>3.3 集合操作</h2><p>集合，类似关系型数据库中的表。</p>
<p>可以显示的创建，也可以隐式的创建。</p>
<h3 id="3-3-1-集合的显式创建"><a href="#3-3-1-集合的显式创建" class="headerlink" title="3.3.1 集合的显式创建"></a>3.3.1 集合的显式创建</h3><p>基本语法格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.createCollection(name)</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<ul>
<li>name: 要创建的集合名称</li>
</ul>
<p>例如：创建一个名为 mycollection 的普通集合。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.createCollection(&quot;mycollection&quot;)</span><br></pre></td></tr></table></figure>

<p>查看当前库中的表： show tables命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show collections</span><br><span class="line">或</span><br><span class="line">show tables</span><br></pre></td></tr></table></figure>

<p>集合的命名规范：</p>
<ul>
<li>集合名不能是空字符串 “”。</li>
<li>集合名不能含有 \0字符（空字符)，这个字符表示集合名的结尾。</li>
<li>集合名不能以 “system.”开头，这是为系统集合保留的前缀。</li>
<li>用户创建的集合名字不能含有保留字符。有些驱动程序的确支持在集合名里面包含，这是因为某些系统生成的集合中包含该字符。除非你要访问这种系统创建的集合，否则千万不要在名字里出现$。</li>
</ul>
<h3 id="3-3-2-集合的隐式创建"><a href="#3-3-2-集合的隐式创建" class="headerlink" title="3.3.2 集合的隐式创建"></a>3.3.2 集合的隐式创建</h3><p>当向一个集合中插入一个文档的时候，如果集合不存在，则会自动创建集合。</p>
<p>详见 文档的插入 章节。</p>
<p>提示：通常我们使用隐式创建文档即可。</p>
<h3 id="3-3-3-集合的删除"><a href="#3-3-3-集合的删除" class="headerlink" title="3.3.3 集合的删除"></a>3.3.3 集合的删除</h3><p>集合删除语法格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.collection.drop()</span><br><span class="line">或</span><br><span class="line">db.集合.drop()</span><br></pre></td></tr></table></figure>

<p>返回值</p>
<p>如果成功删除选定集合，则 drop() 方法返回 true，否则返回 false。</p>
<p>例如：要删除mycollection集合</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.mycollection.drop()</span><br></pre></td></tr></table></figure>

<h2 id="3-4-文档基本CRUD"><a href="#3-4-文档基本CRUD" class="headerlink" title="3.4 文档基本CRUD"></a>3.4 文档基本CRUD</h2><p>文档（document）的数据结构和 JSON 基本一样。</p>
<p>所有存储在集合中的数据都是 BSON 格式。</p>
<h3 id="3-4-1-文档的插入"><a href="#3-4-1-文档的插入" class="headerlink" title="3.4.1 文档的插入"></a>3.4.1 文档的插入</h3><h4 id="3-4-1-1-单个文档插入"><a href="#3-4-1-1-单个文档插入" class="headerlink" title="3.4.1.1 单个文档插入"></a>3.4.1.1 单个文档插入</h4><p>使用insert() 或 save() 方法向集合中插入文档，语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.collection.insert(</span><br><span class="line">    &lt;document or array of documents&gt;,</span><br><span class="line">    &#123;</span><br><span class="line">        writeConcern: &lt;document&gt;,</span><br><span class="line">        ordered: &lt;boolean&gt;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>document</td>
<td>document or array</td>
<td>要插入到集合中的文档或文档数组。（(json格式）</td>
</tr>
<tr>
<td>writeConcern</td>
<td>document</td>
<td>Optional. A document expressing the write concern . Omit to use the default write concern. See Write Concern .Do not explicitly set the write concern for the operation if run in a transaction. To use write concern with transactions, see Transactions and Write Concern</td>
</tr>
<tr>
<td>ordered</td>
<td>boolean</td>
<td>可选。如果为真，则按顺序插入数组中的文档，如果其中一个文档出现错误，MongoDB将返回而不处理数组中的其余文档。如果为假，则执行无序插入，如果其中一个文档出现错误，则继续处理数组中的主文档。在版本2.6+中默认为true</td>
</tr>
</tbody></table>
<p>【示例】</p>
<p>要向comment的集合(表)中插入一条测试数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.insert(&#123;&quot;articleid&quot;:&quot;100000&quot;,&quot;content&quot;:&quot;今天天气真好，阳光明媚&quot;,&quot;userid&quot;:&quot;1001&quot;,&quot;nickname&quot;:&quot;Rose&quot;,&quot;createdatetime&quot;:new Date(),&quot;likenum&quot;:NumberInt(10),&quot;state&quot;:null&#125;)</span><br></pre></td></tr></table></figure>

<p>提示：</p>
<ul>
<li>comment集合如果不存在，则会隐式创建</li>
<li>mongo中的数字，默认情况下是double类型，如果要存整型，必须使用函数NumberInt(整型数字)，否则取出来就有问题了。</li>
<li>插入当前日期使用 new Date()</li>
<li>插入的数据没有指定 _id ，会自动生成主键值</li>
<li>如果某字段没值，可以赋值为null，或不写该字段。</li>
</ul>
<p>执行后，如下，说明插入一个数据成功了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WriteResult(&#123; &quot;nInserted&quot; : 1 &#125;)</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<ul>
<li>文档中的键/值对是有序的。</li>
<li>文档中的值不仅可以是在双引号里面的字符串，还可以是其他几种数据类型（甚至可以是整个嵌入的文档)。</li>
<li>MongoDB区分类型和大小写。</li>
<li>MongoDB的文档不能有重复的键。</li>
<li>文档的键是字符串。除了少数例外情况，键可以使用任意UTF-8字符。</li>
</ul>
<p>文档键命名规范：</p>
<ul>
<li>键不能含有 \0 (空字符)。这个字符用来表示键的结尾。</li>
<li>. 和$有特别的意义，只有在特定环境下才能使用。</li>
<li>以下划线 “_”开头的键是保留的(不是严格要求的)。</li>
</ul>
<h4 id="3-4-1-2-批量插入"><a href="#3-4-1-2-批量插入" class="headerlink" title="3.4.1.2 批量插入"></a>3.4.1.2 批量插入</h4><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.collection.insertMany(</span><br><span class="line">     [ &lt;document 1&gt; , &lt;document 2&gt;, ... ],</span><br><span class="line">     &#123;</span><br><span class="line">         writeConcern: &lt;document&gt;,</span><br><span class="line">         ordered: &lt;boolean&gt;</span><br><span class="line">     &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>【示例】</p>
<p>批量插入多条文章评论：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.comment.insertMany([</span><br><span class="line">    &#123;&quot;_id&quot;:&quot;1&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。&quot;,&quot;userid&quot;:&quot;1002&quot;,&quot;nickname&quot;:&quot;相忘于江湖&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-05T22:08:15.522Z&quot;),&quot;likenum&quot;:NumberInt(1000),&quot;state&quot;:&quot;1&quot;&#125;,</span><br><span class="line">    &#123;&quot;_id&quot;:&quot;2&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我夏天空腹喝凉开水，冬天喝温开水&quot;,&quot;userid&quot;:&quot;1005&quot;,&quot;nickname&quot;:&quot;伊人憔悴&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-05T23:58:51.485Z&quot;),&quot;likenum&quot;:NumberInt(888),&quot;state&quot;:&quot;1&quot;&#125;,</span><br><span class="line">    &#123;&quot;_id&quot;:&quot;3&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我一直喝凉开水，冬天夏天都喝。&quot;,&quot;userid&quot;:&quot;1004&quot;,&quot;nickname&quot;:&quot;杰克船长&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-06T01:05:06.321Z&quot;),&quot;likenum&quot;:NumberInt(666),&quot;state&quot;:&quot;1&quot;&#125;,</span><br><span class="line">    &#123;&quot;_id&quot;:&quot;4&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;专家说不能空腹吃饭，影响健康。&quot;,&quot;userid&quot;:&quot;1003&quot;,&quot;nickname&quot;:&quot;凯撒&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-06T08:18:35.288Z&quot;),&quot;likenum&quot;:NumberInt(2000),&quot;state&quot;:&quot;1&quot;&#125;,</span><br><span class="line">    &#123;&quot;_id&quot;:&quot;5&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;研究表明，刚烧开的水千万不能喝，因为烫嘴。&quot;,&quot;userid&quot;:&quot;1003&quot;,&quot;nickname&quot;:&quot;凯撒&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-06T11:01:02.521Z&quot;),&quot;likenum&quot;:NumberInt(3000),&quot;state&quot;:&quot;1&quot;&#125;</span><br><span class="line"> </span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<p>提示：</p>
<p>插入时指定了 _id ，则主键就是该值。</p>
<p>如果某条数据插入失败，将会终止插入，但已经插入成功的数据不会回滚掉。</p>
<p>因为批量插入由于数据较多容易出现失败，因此，可以使用try catch进行异常捕捉处理，测试的时候可以不处理。如（了解）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">    db.comment.insertMany([</span><br><span class="line">        &#123;&quot;_id&quot;:&quot;1&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。&quot;,&quot;userid&quot;:&quot;1002&quot;,&quot;nickname&quot;:&quot;相忘于江湖&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-05T22:08:15.522Z&quot;),&quot;likenum&quot;:NumberInt(1000),&quot;state&quot;:&quot;1&quot;&#125;,</span><br><span class="line">        &#123;&quot;_id&quot;:&quot;2&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我夏天空腹喝凉开水，冬天喝温开水&quot;,&quot;userid&quot;:&quot;1005&quot;,&quot;nickname&quot;:&quot;伊人憔悴&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-05T23:58:51.485Z&quot;),&quot;likenum&quot;:NumberInt(888),&quot;state&quot;:&quot;1&quot;&#125;,</span><br><span class="line">        &#123;&quot;_id&quot;:&quot;3&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我一直喝凉开水，冬天夏天都喝。&quot;,&quot;userid&quot;:&quot;1004&quot;,&quot;nickname&quot;:&quot;杰克船长&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-06T01:05:06.321Z&quot;),&quot;likenum&quot;:NumberInt(666),&quot;state&quot;:&quot;1&quot;&#125;,</span><br><span class="line">        &#123;&quot;_id&quot;:&quot;4&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;专家说不能空腹吃饭，影响健康。&quot;,&quot;userid&quot;:&quot;1003&quot;,&quot;nickname&quot;:&quot;凯撒&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-06T08:18:35.288Z&quot;),&quot;likenum&quot;:NumberInt(2000),&quot;state&quot;:&quot;1&quot;&#125;,</span><br><span class="line">        &#123;&quot;_id&quot;:&quot;5&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;研究表明，刚烧开的水千万不能喝，因为烫嘴。&quot;,&quot;userid&quot;:&quot;1003&quot;,&quot;nickname&quot;:&quot;凯撒&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-06T11:01:02.521Z&quot;),&quot;likenum&quot;:NumberInt(3000),&quot;state&quot;:&quot;1&quot;&#125;</span><br><span class="line"></span><br><span class="line">    ]);</span><br><span class="line"> </span><br><span class="line">&#125; catch (e) &#123;</span><br><span class="line">    print (e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-2-文档的基本查询"><a href="#3-4-2-文档的基本查询" class="headerlink" title="3.4.2 文档的基本查询"></a>3.4.2 文档的基本查询</h3><p>查询数据的语法格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.find(&lt;query&gt;, [projection])</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>query</td>
<td>document</td>
<td>可选。使用查询运算符指定选择筛选器。若要返回集合中的所有文档，请省略此参数或传递空文档( {} )。</td>
</tr>
<tr>
<td>projection</td>
<td>document</td>
<td>可选。指定要在与查询筛选器匹配的文档中返回的字段（投影）。若要返回匹配文档中的所有字段，请省略此参数。</td>
</tr>
</tbody></table>
<p>【示例】</p>
<h4 id="3-4-2-1-查询所有"><a href="#3-4-2-1-查询所有" class="headerlink" title="3.4.2.1 查询所有"></a>3.4.2.1 查询所有</h4><p>如果我们要查询comment集合的所有文档，我们输入以下命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find()</span><br><span class="line">或</span><br><span class="line">db.comment.find(&#123;&#125;)</span><br></pre></td></tr></table></figure>

<p>这里你会发现每条文档会有一个叫 _id的字段，这个相当于我们原来关系数据库中表的主键，当你在插入文档记录时没有指定该字段，MongoDB会自动创建，其类型是ObjectID类型。</p>
<p>如果我们在插入文档记录时指定该字段也可以，其类型可以是ObjectID类型，也可以是MongoDB支持的任意类型。</p>
<p>如果我想按一定条件来查询，比如我想查询userid为1003的记录，怎么办？很简单！只 要在find()中添加参数即可，参数也是json格式，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;userid:&#39;1003&#39;&#125;)</span><br></pre></td></tr></table></figure>

<p>如果你只需要返回符合条件的第一条数据，我们可以使用findOne命令来实现，语法和find一样。</p>
<p>如：查询用户编号是1003的记录，但只最多返回符合条件的第一条记录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.findOne(&#123;userid:&#39;1003&#39;&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="3-4-2-2-投影查询（PROJECTION-QUERY）"><a href="#3-4-2-2-投影查询（PROJECTION-QUERY）" class="headerlink" title="3.4.2.2 投影查询（PROJECTION QUERY）"></a>3.4.2.2 投影查询（PROJECTION QUERY）</h4><p>如果要查询结果返回部分字段，则需要使用投影查询（不显示所有字段，只显示指定的字段）。</p>
<p>如：查询结果只显示 _id 、userid、nickname :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;userid:&quot;1003&quot;&#125;,&#123;userid:1,nickname:1&#125;)</span><br></pre></td></tr></table></figure>

<p>默认 _id 会显示。</p>
<p>如：查询结果只显示 、 userid、nickname ，不显示 _id ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;userid:&quot;1003&quot;&#125;,&#123;userid:1,nickname:1,_id:0&#125;)</span><br></pre></td></tr></table></figure>

<p>再例如：查询所有数据，但只显示 _id 、userid、nickname :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;&#125;,&#123;userid:1,nickname:1&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="3-4-3-文档的更新"><a href="#3-4-3-文档的更新" class="headerlink" title="3.4.3 文档的更新"></a>3.4.3 文档的更新</h3><p>更新文档的语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">db.collection.update(query, update, options)</span><br><span class="line">&#x2F;&#x2F;或</span><br><span class="line">db.collection.update(</span><br><span class="line">    &lt;query&gt;,</span><br><span class="line">    &lt;update&gt;,</span><br><span class="line">    &#123;</span><br><span class="line">        upsert: &lt;boolean&gt;,</span><br><span class="line">        multi: &lt;boolean&gt;,</span><br><span class="line">        writeConcern: &lt;document&gt;,</span><br><span class="line">        collation: &lt;document&gt;,</span><br><span class="line">        arrayFilters: [ &lt;filterdocument1&gt;, ... ],</span><br><span class="line">        hint:  &lt;document|string&gt;     &#x2F;&#x2F; Available starting in MongoDB 4.2</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>query</td>
<td>document</td>
<td>更新的选择条件。可以使用与find（）方法中相同的查询选择器，类似sql update查询内where后面的。。在3.0版中进行了更改：当使用upsert:true执行update（）时，如果查询使用点表示法在_id 字段上指定条件，则MongoDB将拒绝插入新文档。</td>
</tr>
<tr>
<td>multi</td>
<td>boolean</td>
<td>可选。如果设置为true，则更新符合查询条件的多个文档。如果设置为false，则更新一个文档。默认值为false。</td>
</tr>
</tbody></table>
<p>【示例】</p>
<h4 id="3-4-3-1-覆盖的修改"><a href="#3-4-3-1-覆盖的修改" class="headerlink" title="3.4.3.1 覆盖的修改"></a>3.4.3.1 覆盖的修改</h4><p>如果我们想修改_id为1的记录，点赞量为1001，输入以下语句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.update(&#123;_id:&quot;1&quot;&#125;,&#123;likenum:NumberInt(1001)&#125;)</span><br></pre></td></tr></table></figure>

<p>执行后，我们会发现，这条文档除了 likenum字段其它字段都不见了，</p>
<h4 id="3-4-3-2-局部修改"><a href="#3-4-3-2-局部修改" class="headerlink" title="3.4.3.2 局部修改"></a>3.4.3.2 局部修改</h4><p>为了解决这个问题，我们需要使用修改器$set来实现，命令如下：</p>
<p>我们想修改_id为2的记录，浏览量为889，输入以下语句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.update(&#123;_id:&quot;2&quot;&#125;,&#123;$set:&#123;likenum:NumberInt(889)&#125;&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="3-4-3-3-批量的修改"><a href="#3-4-3-3-批量的修改" class="headerlink" title="3.4.3.3 批量的修改"></a>3.4.3.3 批量的修改</h4><p>更新所有用户为 1003 的用户的昵称为 凯撒大帝 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;默认只修改第一条数据</span><br><span class="line">db.comment.update(&#123;userid:&quot;1003&quot;&#125;,&#123;$set:&#123;nickname:&quot;凯撒2&quot;&#125;&#125;)</span><br><span class="line">&#x2F;&#x2F;修改所有符合条件的数据</span><br><span class="line">db.comment.update(&#123;userid:&quot;1003&quot;&#125;,&#123;$set:&#123;nickname:&quot;凯撒大帝&quot;&#125;&#125;,&#123;multi:true&#125;)</span><br></pre></td></tr></table></figure>

<p>提示：如果不加后面的参数，则只更新符合条件的第一条记录</p>
<h4 id="3-4-3-4-列值增长的修改"><a href="#3-4-3-4-列值增长的修改" class="headerlink" title="3.4.3.4 列值增长的修改"></a>3.4.3.4 列值增长的修改</h4><p>如果我们想实现对某列值在原有值的基础上进行增加或减少，可以使用 $inc 运算符来实现。</p>
<p>需求：对3号数据的点赞数，每次递增1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.update(&#123;_id:&quot;3&quot;&#125;,&#123;$inc:&#123;likenum:NumberInt(1)&#125;&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="3-4-4-删除文档"><a href="#3-4-4-删除文档" class="headerlink" title="3.4.4 删除文档"></a>3.4.4 删除文档</h3><p>删除文档的语法结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.集合名称.remove(条件)</span><br></pre></td></tr></table></figure>

<p>以下语句可以将数据全部删除，请慎用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.remove(&#123;&#125;)</span><br></pre></td></tr></table></figure>

<p>如果删除 _id=1的记录，输入以下语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.remove(&#123;_id:&quot;1&quot;&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="3-5-文档的分页查询"><a href="#3-5-文档的分页查询" class="headerlink" title="3.5 文档的分页查询"></a>3.5 文档的分页查询</h2><h3 id="3-5-1-统计查询"><a href="#3-5-1-统计查询" class="headerlink" title="3.5.1 统计查询"></a>3.5.1 统计查询</h3><p>统计查询使用count()方法，语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.count(query, options)</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>query</td>
<td>document</td>
<td>查询选择条件</td>
</tr>
<tr>
<td>options</td>
<td>document</td>
<td>可选。用于修改计数的额外选项</td>
</tr>
</tbody></table>
<p>【示例】</p>
<h4 id="3-5-1-1-统计所有记录数"><a href="#3-5-1-1-统计所有记录数" class="headerlink" title="3.5.1.1 统计所有记录数"></a>3.5.1.1 统计所有记录数</h4><p>统计comment集合的所有的记录数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.count()</span><br></pre></td></tr></table></figure>

<h4 id="3-5-1-2-按条件统计记录数"><a href="#3-5-1-2-按条件统计记录数" class="headerlink" title="3.5.1.2 按条件统计记录数"></a>3.5.1.2 按条件统计记录数</h4><p>例如：统计userid为1003的记录条数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.count(&#123;userid:&quot;1003&quot;&#125;)</span><br></pre></td></tr></table></figure>

<p>提示：</p>
<p>默认情况下 count() 方法返回符合条件的全部记录条数。</p>
<h3 id="3-5-2-分页列表查询"><a href="#3-5-2-分页列表查询" class="headerlink" title="3.5.2 分页列表查询"></a>3.5.2 分页列表查询</h3><p>可以使用limit()方法来读取指定数量的数据，使用skip()方法来跳过指定数量的数据。</p>
<p>基本语法如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.find().limit(NUMBER).skip(NUMBER)</span><br></pre></td></tr></table></figure>

<p>如果你想返回指定条数的记录，可以在find方法后调用limit来返回结果(TopN)，默认值20，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find().limit(3)</span><br></pre></td></tr></table></figure>

<p>skip 方法同样接受一个数字参数作为跳过的记录条数。（前N个不要）,默认值是0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find().skip(3)</span><br></pre></td></tr></table></figure>

<p>分页查询：需求：每页2个，第二页开始：跳过前两条数据，接着值显示3和4条数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;第一页</span><br><span class="line">db.comment.find().skip(0).limit(2)</span><br><span class="line">&#x2F;&#x2F;第二页</span><br><span class="line">db.comment.find().skip(2).limit(2)</span><br><span class="line">&#x2F;&#x2F;第三页</span><br><span class="line">db.comment.find().skip(4).limit(2)</span><br></pre></td></tr></table></figure>

<h3 id="3-5-3-排序查询"><a href="#3-5-3-排序查询" class="headerlink" title="3.5.3 排序查询"></a>3.5.3 排序查询</h3><p>sort() 方法对数据进行排序，sort() 方法可以通过参数指定排序的字段，并使用 1 和 -1 来指定排序的方式，其中 1为升序排列，而 -1 是用于降序排列。</p>
<p>语法如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.find().sort(&#123;KEY:1&#125;)</span><br><span class="line">或</span><br><span class="line">db.集合名称.find().sort(排序方式)</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<p>对userid降序排列，并对访问量进行升序排列</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find().sort(&#123;userid:-1,likenum:1&#125;)</span><br></pre></td></tr></table></figure>

<p>提示：</p>
<p>skip(), limilt(), sort()三个放在一起执行的时候，执行的顺序是先 sort(), 然后是 skip()，最后是显示的 limit()，和命令编写顺序无关。</p>
<h2 id="3-6-文档的更多查询"><a href="#3-6-文档的更多查询" class="headerlink" title="3.6 文档的更多查询"></a>3.6 文档的更多查询</h2><h3 id="3-6-1-正则的复杂条件查询"><a href="#3-6-1-正则的复杂条件查询" class="headerlink" title="3.6.1 正则的复杂条件查询"></a>3.6.1 正则的复杂条件查询</h3><p>MongoDB的模糊查询是通过正则表达式的方式实现的。格式为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.collection.find(&#123;field:&#x2F;正则表达式&#x2F;&#125;)</span><br><span class="line">或</span><br><span class="line">db.集合.find(&#123;字段:&#x2F;正则表达式&#x2F;&#125;)</span><br></pre></td></tr></table></figure>

<p>提示：正则表达式是 js的语法，直接量的写法。</p>
<p>例如，我要查询评论内容包含“开水”的所有文档，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;content:&#x2F;开水&#x2F;&#125;)</span><br></pre></td></tr></table></figure>

<p>如果要查询评论的内容中以 “专家”开头的，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;content:&#x2F;^专家&#x2F;&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="3-6-2-比较查询"><a href="#3-6-2-比较查询" class="headerlink" title="3.6.2 比较查询"></a>3.6.2 比较查询</h3><p>&lt;, &lt;=, &gt;, &gt;= 这个操作符也是很常用的，格式如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $gt: value &#125;&#125;) &#x2F;&#x2F; 大于: field &gt; value</span><br><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $lt: value &#125;&#125;) &#x2F;&#x2F; 小于: field &lt; value</span><br><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $gte: value &#125;&#125;) &#x2F;&#x2F; 大于等于: field &gt;&#x3D; value</span><br><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $lte: value &#125;&#125;) &#x2F;&#x2F; 小于等于: field &lt;&#x3D; value</span><br><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $ne: value &#125;&#125;) &#x2F;&#x2F; 不等于: field !&#x3D; value</span><br></pre></td></tr></table></figure>

<p>示例：查询评论点赞数量大于 700的记录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;likenum:&#123;$gt:NumberInt(700)&#125;&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="3-6-3-包含查询"><a href="#3-6-3-包含查询" class="headerlink" title="3.6.3 包含查询"></a>3.6.3 包含查询</h3><p>包含使用$in操作符。 示例：查询评论的集合中userid字段包含1003或1004的文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;userid:&#123;$in:[&quot;1003&quot;,&quot;1004&quot;]&#125;&#125;)</span><br></pre></td></tr></table></figure>

<p>不包含使用 $nin操作符。 示例：查询评论集合中userid字段不包含1003和1004的文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;userid:&#123;$nin:[&quot;1003&quot;,&quot;1004&quot;]&#125;&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="3-6-4-条件连接查询"><a href="#3-6-4-条件连接查询" class="headerlink" title="3.6.4 条件连接查询"></a>3.6.4 条件连接查询</h3><p>我们如果需要查询同时满足两个以上条件，需要使用$and操作符将条件进行关联。（相当于SQL的and） 格式为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$and:[ &#123;  &#125;,&#123;  &#125;,&#123; &#125; ]</span><br></pre></td></tr></table></figure>

<p>示例：查询评论集合中 likenum大于等于700 并且小于2000的文档：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;$and:[&#123;likenum:&#123;$gte:NumberInt(700)&#125;&#125;,&#123;likenum:&#123;$lt:NumberInt(2000)&#125;&#125;]&#125;)</span><br></pre></td></tr></table></figure>

<p>如果两个以上条件之间是或者的关系，我们使用操作符进行关联，与前面 and的使用方式相同格式为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$or:[ &#123;  &#125;,&#123;  &#125;,&#123;   &#125; ]</span><br></pre></td></tr></table></figure>

<p>示例：查询评论集合中 userid为1003，或者点赞数小于1000的文档记录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;$or:[ &#123;userid:&quot;1003&quot;&#125; ,&#123;likenum:&#123;$lt:1000&#125; &#125;]&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="3-7-常用命令小结"><a href="#3-7-常用命令小结" class="headerlink" title="3.7 常用命令小结"></a>3.7 常用命令小结</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">选择切换数据库：use articledb</span><br><span class="line">插入数据：db.comment.insert(&#123;bson数据&#125;)</span><br><span class="line">查询所有数据：db.comment.find();</span><br><span class="line">条件查询数据：db.comment.find(&#123;条件&#125;)</span><br><span class="line">查询符合条件的第一条记录：db.comment.findOne(&#123;条件&#125;)</span><br><span class="line">查询符合条件的前几条记录：db.comment.find(&#123;条件&#125;).limit(条数)</span><br><span class="line">查询符合条件的跳过的记录：db.comment.find(&#123;条件&#125;).skip(条数)</span><br><span class="line">修改数据：db.comment.update(&#123;条件&#125;,&#123;修改后的数据&#125;) 或db.comment.update(&#123;条件&#125;,&#123;$set:&#123;要修改部分的字段:数据&#125;)</span><br><span class="line">修改数据并自增某字段值：db.comment.update(&#123;条件&#125;,&#123;$inc:&#123;自增的字段:步进值&#125;&#125;)</span><br><span class="line">删除数据：db.comment.remove(&#123;条件&#125;)</span><br><span class="line">统计查询：db.comment.count(&#123;条件&#125;)</span><br><span class="line">模糊查询：db.comment.find(&#123;字段名:&#x2F;正则表达式&#x2F;&#125;)</span><br><span class="line">条件比较运算：db.comment.find(&#123;字段名:&#123;$gt:值&#125;&#125;)</span><br><span class="line">包含查询：db.comment.find(&#123;字段名:&#123;$in:[值1，值2]&#125;&#125;)或db.comment.find(&#123;字段名:&#123;$nin:[值1，值2]&#125;&#125;)</span><br><span class="line">条件连接查询：db.comment.find(&#123;$and:[&#123;条件1&#125;,&#123;条件2&#125;]&#125;)或db.comment.find(&#123;$or:[&#123;条件1&#125;,&#123;条件2&#125;]&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="4-索引-Index"><a href="#4-索引-Index" class="headerlink" title="4. 索引-Index"></a>4. 索引-Index</h1><h2 id="4-1-概述"><a href="#4-1-概述" class="headerlink" title="4.1 概述"></a>4.1 概述</h2><p>索引支持在MongoDB中高效地执行查询。如果没有索引，MongoDB必须执行全集合扫描，即扫描集合中的每个文档，以选择与查询语句匹配的文档。这种扫描全集合的查询效率是非常低的，特别在处理大量的数据时，查询可以要花费几十秒甚至几分钟，这对网站的性能是非常致命的。</p>
<p>如果查询存在适当的索引，MongoDB可以使用该索引限制必须检查的文档数。</p>
<p>索引是特殊的数据结构，它以易于遍历的形式存储集合数据集的一小部分。索引存储特定字段或一组字段的值，按字段值排序。索引项的排序支持有效的相等匹配和基于范围的查询操作。此外，MongoDB还可以使用索引中的排序返回排序结果。</p>
<p>官网文档： <a href="https://docs.mongodb.com/manual/indexes/" target="_blank" rel="noopener">https://docs.mongodb.com/manual/indexes/</a></p>
<p>了解：</p>
<p>MongoDB索引使用B树数据结构（确切的说是B-Tree，MySQL是B+Tree）</p>
<h2 id="4-2-索引的类型"><a href="#4-2-索引的类型" class="headerlink" title="4.2 索引的类型"></a>4.2 索引的类型</h2><h3 id="4-2-1-单字段索引"><a href="#4-2-1-单字段索引" class="headerlink" title="4.2.1 单字段索引"></a>4.2.1 单字段索引</h3><p>MongoDB支持在文档的单个字段上创建用户定义的升序/降序索引，称为单字段索引（Single Field Index）。</p>
<p>对于单个字段索引和排序操作，索引键的排序顺序（即升序或降序）并不重要，因为MongoDB可以在任何方向上遍历索引。</p>
<p><img src="https://img-blog.csdnimg.cn/20200912222446304.png" alt="image-20200912175647643"></p>
<h3 id="4-2-2-复合索引"><a href="#4-2-2-复合索引" class="headerlink" title="4.2.2 复合索引"></a>4.2.2 复合索引</h3><p>MongoDB还支持多个字段的用户定义索引，即复合索引（Compound Index）。</p>
<p>复合索引中列出的字段顺序具有重要意义。例如，如果复合索引由 { userid: 1, score: -1 } 组成，则索引首先按userid正序排序，然后在每个userid的值内，再在按score倒序排序。</p>
<p><img src="https://img-blog.csdnimg.cn/20200912222502355.png" alt="image-20200912175808078"></p>
<h3 id="4-2-3-其他索引"><a href="#4-2-3-其他索引" class="headerlink" title="4.2.3 其他索引"></a>4.2.3 其他索引</h3><p>地理空间索引（Geospatial Index）、文本索引（Text Indexes）、哈希索引（Hashed Indexes）。</p>
<ul>
<li><p>地理空间索引（Geospatial Index）</p>
<p>为了支持对地理空间坐标数据的有效查询，MongoDB提供了两种特殊的索引：返回结果时使用平面几何的二维索引和返回结果时使用球面几何的二维球面索引。</p>
</li>
<li><p>文本索引（Text Indexes）</p>
<p>MongoDB提供了一种文本索引类型，支持在集合中搜索字符串内容。这些文本索引不存储特定于语言的停止词（例如“the”、“a”、“or”），而将集合中的词作为词干，只存储根词。</p>
</li>
<li><p>哈希索引（Hashed Indexes）</p>
<p>为了支持基于散列的分片，MongoDB提供了散列索引类型，它对字段值的散列进行索引。这些索引在其范围内的值分布更加随机，但只支持相等匹配，不支持基于范围的查询。</p>
</li>
</ul>
<h2 id="4-3-索引的管理操作"><a href="#4-3-索引的管理操作" class="headerlink" title="4.3 索引的管理操作"></a>4.3 索引的管理操作</h2><h3 id="4-3-1-索引的查看"><a href="#4-3-1-索引的查看" class="headerlink" title="4.3.1 索引的查看"></a>4.3.1 索引的查看</h3><p>说明：</p>
<p>返回一个集合中的所有索引的数组。</p>
<p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.getIndexes()</span><br></pre></td></tr></table></figure>

<p>提示：该语法命令运行要求是 MongoDB 3.0+</p>
<p>【示例】</p>
<p>查看comment集合中所有的索引情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.comment.getIndexes()</span><br><span class="line">[</span><br><span class="line">   &#123;</span><br><span class="line">        &quot;v&quot; : 2,</span><br><span class="line">        &quot;key&quot; : &#123;</span><br><span class="line">            &quot;_id&quot; : 1</span><br><span class="line">       &#125;,</span><br><span class="line">        &quot;name&quot; : &quot;_id_&quot;,</span><br><span class="line">        &quot;ns&quot; : &quot;articledb.comment&quot;</span><br><span class="line">   &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>结果中显示的是默认 <code>_id</code> 索引。</p>
<p>默认<code>_id</code>索引：</p>
<p>MongoDB在创建集合的过程中，在<code>_id</code> 字段上创建一个唯一的索引，默认名字为<code>_id_</code>，该索引可防止客户端插入两个具有相同值的文档，您不能在<code>_id</code>字段上删除此索引。</p>
<p>注意：该索引是唯一索引，因此值不能重复，即 <code>_id</code> 值不能重复的。在分片集群中，通常使用 <code>_id</code> 作为片键。</p>
<h3 id="4-3-2-索引的创建"><a href="#4-3-2-索引的创建" class="headerlink" title="4.3.2 索引的创建"></a>4.3.2 索引的创建</h3><p>说明：在集合上创建索引。</p>
<p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.createIndex(keys, options)</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>keys</td>
<td>document</td>
<td>包含字段和值对的文档，其中字段是索引键，值描述该字段的索引类型。对于字段上的升序索引，请 指定值1；对于降序索引，请指定值-1。比如： { 字段:1或-1} ，其中1 为指定按升序创建索引，如果你 想按降序来创建索引指定为 -1 即可。另外，MongoDB支持几种不同的索引类型，包括文本、地理空 间和哈希索引。</td>
</tr>
<tr>
<td>options</td>
<td>document</td>
<td>可选。包含一组控制索引创建的选项的文档。有关详细信息，请参见选项详情列表。</td>
</tr>
</tbody></table>
<p>options（更多选项）列表：</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>background</td>
<td>Boolean</td>
<td>建索引过程会阻塞其它数据库操作，background可指定以后台方式创建索引，即增加 “background” 可选参数。 “background” 默认值为false。</td>
</tr>
<tr>
<td>unique</td>
<td>Boolean</td>
<td>建立的索引是否唯一。指定为true创建唯一索引。默认值为false.</td>
</tr>
<tr>
<td>name</td>
<td>string</td>
<td>索引的名称。如果未指定，MongoDB的通过连接索引的字段名和排序顺序生成一个索引名 称。</td>
</tr>
<tr>
<td>dropDups</td>
<td>Boolean</td>
<td>3.0+版本已废弃。在建立唯一索引时是否删除重复记录,指定 true 创建唯一索引。默认值为 false.</td>
</tr>
<tr>
<td>sparse</td>
<td>Boolean</td>
<td>对文档中不存在的字段数据不启用索引；这个参数需要特别注意，如果设置为true的话，在索 引字段中不会查询出不包含对应字段的文档.。默认值为 false.</td>
</tr>
<tr>
<td>expireAfterSeconds</td>
<td>integer</td>
<td>指定一个以秒为单位的数值，完成 TTL设定，设定集合的生存时间。</td>
</tr>
<tr>
<td>v</td>
<td>index version</td>
<td>索引的版本号。默认的索引版本取决于mongod创建索引时运行的版本。</td>
</tr>
<tr>
<td>weights</td>
<td>document</td>
<td>索引权重值，数值在 1 到 99,999 之间，表示该索引相对于其他索引字段的得分权重。</td>
</tr>
<tr>
<td>default_language</td>
<td>string</td>
<td>对于文本索引，该参数决定了停用词及词干和词器的规则的列表。 默认为英语</td>
</tr>
<tr>
<td>language_override</td>
<td>string</td>
<td>对于文本索引，该参数指定了包含在文档中的字段名，语言覆盖默认的language，默认值为 language.</td>
</tr>
</tbody></table>
<p>提示：<br>注意在 3.0.0 版本前创建索引方法为 db.collection.ensureIndex() ，之后的版本使用了 db.collection.createIndex() 方法，ensureIndex() 还能用，但只是 createIndex() 的别名。</p>
<p>【示例】</p>
<h4 id="4-3-2-1-单字段索引"><a href="#4-3-2-1-单字段索引" class="headerlink" title="4.3.2.1 单字段索引"></a>4.3.2.1 单字段索引</h4><p>示例：对 userid 字段建立索引：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.createIndex(&#123;userid:1&#125;)</span><br></pre></td></tr></table></figure>

<p>参数 1：按升序创建索引</p>
<p>compass查看：</p>
<p><img src="https://img-blog.csdnimg.cn/20200912222523315.png" alt="image-20200912184832080"></p>
<h4 id="4-3-2-2-复合索引"><a href="#4-3-2-2-复合索引" class="headerlink" title="4.3.2.2 复合索引"></a>4.3.2.2 复合索引</h4><p>对 userid 和 nickname 同时建立复合（Compound）索引：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.createIndex(&#123;userid:1,nickname:-1&#125;)</span><br></pre></td></tr></table></figure>

<p>compass 中：</p>
<p><img src="https://img-blog.csdnimg.cn/20200912222541442.png" alt="image-20200912184915143"></p>
<h3 id="4-3-3-索引的移除"><a href="#4-3-3-索引的移除" class="headerlink" title="4.3.3 索引的移除"></a>4.3.3 索引的移除</h3><p>说明：可以移除指定的索引，或移除所有索引</p>
<h4 id="4-3-3-1-指定索引的移除"><a href="#4-3-3-1-指定索引的移除" class="headerlink" title="4.3.3.1 指定索引的移除"></a>4.3.3.1 指定索引的移除</h4><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.dropIndex(index)</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>index</td>
<td>string or document</td>
<td>指定要删除的索引。可以通过索引名称或索引规范文档指定索引。若要删除文本索引，请指定 索引名称。</td>
</tr>
</tbody></table>
<p>【示例】</p>
<p>删除 comment 集合中 userid 字段上的升序索引：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.dropIndex(&#123;userid:1&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="4-3-3-2-所有索引的移除"><a href="#4-3-3-2-所有索引的移除" class="headerlink" title="4.3.3.2 所有索引的移除"></a>4.3.3.2 所有索引的移除</h4><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.dropIndexes()</span><br></pre></td></tr></table></figure>

<p>【示例】</p>
<p>删除 comment 集合中所有索引。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.dropIndexes()</span><br></pre></td></tr></table></figure>

<p>提示： _id 的字段的索引是无法删除的，只能删除非 _id 字段的索引。</p>
<h2 id="4-4-索引的使用"><a href="#4-4-索引的使用" class="headerlink" title="4.4 索引的使用"></a>4.4 索引的使用</h2><h3 id="4-4-1-执行计划"><a href="#4-4-1-执行计划" class="headerlink" title="4.4.1 执行计划"></a>4.4.1 执行计划</h3><p>分析查询性能（Analyze Query Performance）通常使用执行计划（解释计划、Explain Plan）来查看查询的情况，如查询耗费的时间、是否基于索引查询等。</p>
<p>那么，通常，我们想知道，建立的索引是否有效，效果如何，都需要通过执行计划查看。</p>
<p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.find(query,options).explain(options)</span><br></pre></td></tr></table></figure>

<p>【示例】</p>
<p>查看根据userid查询数据的情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.comment.find(&#123;userid:&quot;1003&quot;&#125;).explain()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;queryPlanner&quot; : &#123;</span><br><span class="line">        &quot;plannerVersion&quot; : 1,</span><br><span class="line">        &quot;namespace&quot; : &quot;articledb.comment&quot;,</span><br><span class="line">        &quot;indexFilterSet&quot; : false,</span><br><span class="line">        &quot;parsedQuery&quot; : &#123;</span><br><span class="line">            &quot;userid&quot; : &#123;</span><br><span class="line">            	&quot;$eq&quot; : &quot;1003&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;winningPlan&quot; : &#123;</span><br><span class="line">            &quot;stage&quot; : &quot;COLLSCAN&quot;,</span><br><span class="line">            &quot;filter&quot; : &#123;</span><br><span class="line">                &quot;userid&quot; : &#123;</span><br><span class="line">                	&quot;$eq&quot; : &quot;1003&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;direction&quot; : &quot;forward&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;rejectedPlans&quot; : [ ]</span><br><span class="line">   &#125;,</span><br><span class="line">   &quot;serverInfo&quot; : &#123;</span><br><span class="line">       &quot;host&quot; : &quot;9ef3740277ad&quot;,</span><br><span class="line">       &quot;port&quot; : 27017,</span><br><span class="line">       &quot;version&quot; : &quot;4.0.10&quot;,</span><br><span class="line">       &quot;gitVersion&quot; : &quot;c389e7f69f637f7a1ac3cc9fae843b635f20b766&quot;</span><br><span class="line">   &#125;,</span><br><span class="line">   &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键点看： “stage” : “COLLSCAN”, 表示全集合扫描</p>
<p><img src="https://img-blog.csdnimg.cn/20200912222603862.png" alt="image-20200912185953559"></p>
<p>下面对userid建立索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.createIndex(&#123;userid:1&#125;)</span><br></pre></td></tr></table></figure>

<p>再次查看执行计划：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.comment.find(&#123;userid:&quot;1013&quot;&#125;).explain()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;queryPlanner&quot; : &#123;</span><br><span class="line">        &quot;plannerVersion&quot; : 1,</span><br><span class="line">        &quot;namespace&quot; : &quot;articledb.comment&quot;,</span><br><span class="line">        &quot;indexFilterSet&quot; : false,</span><br><span class="line">        &quot;parsedQuery&quot; : &#123;</span><br><span class="line">            &quot;userid&quot; : &#123;</span><br><span class="line">                &quot;$eq&quot; : &quot;1013&quot;</span><br><span class="line">            &#125;</span><br><span class="line">    	&#125;,</span><br><span class="line">        &quot;winningPlan&quot; : &#123;</span><br><span class="line">            &quot;stage&quot; : &quot;FETCH&quot;,</span><br><span class="line">            &quot;inputStage&quot; : &#123;</span><br><span class="line">                &quot;stage&quot; : &quot;IXSCAN&quot;,</span><br><span class="line">                &quot;keyPattern&quot; : &#123;</span><br><span class="line">                    &quot;userid&quot; : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;indexName&quot; : &quot;userid_1&quot;,</span><br><span class="line">                &quot;isMultiKey&quot; : false,</span><br><span class="line">                &quot;multiKeyPaths&quot; : &#123;</span><br><span class="line">                    &quot;userid&quot; : [ ]</span><br><span class="line">                 &#125;,</span><br><span class="line">                &quot;isUnique&quot; : false,</span><br><span class="line">                &quot;isSparse&quot; : false,</span><br><span class="line">                &quot;isPartial&quot; : false,</span><br><span class="line">                &quot;indexVersion&quot; : 2,</span><br><span class="line">                &quot;direction&quot; : &quot;forward&quot;,</span><br><span class="line">                &quot;indexBounds&quot; : &#123;</span><br><span class="line">                    &quot;userid&quot; : [</span><br><span class="line">                        &quot;[\&quot;1013\&quot;, \&quot;1013\&quot;]&quot;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;rejectedPlans&quot; : [ ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;serverInfo&quot; : &#123;</span><br><span class="line">        &quot;host&quot; : &quot;9ef3740277ad&quot;,</span><br><span class="line">        &quot;port&quot; : 27017,</span><br><span class="line">        &quot;version&quot; : &quot;4.0.10&quot;,</span><br><span class="line">        &quot;gitVersion&quot; : &quot;c389e7f69f637f7a1ac3cc9fae843b635f20b766&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键点看： “stage” : “IXSCAN” ,基于索引的扫描</p>
<p>compass查看：</p>
<p><img src="https://img-blog.csdnimg.cn/20200912222620711.png" alt="image-20200912190339355"></p>
<h3 id="4-4-2-涵盖的查询"><a href="#4-4-2-涵盖的查询" class="headerlink" title="4.4.2 涵盖的查询"></a>4.4.2 涵盖的查询</h3><p>Covered Queries</p>
<p>当查询条件和查询的投影仅包含索引字段时，MongoDB直接从索引返回结果，而不扫描任何文档或将文档带入内存。 这些覆盖的查询可以非常有效。</p>
<p><img src="https://img-blog.csdnimg.cn/20200912222637894.png" alt="image-20200912190507995"></p>
<p>更多：<a href="https://docs.mongodb.com/manual/core/query-optimization/#read-operations-covered-query" target="_blank" rel="noopener">https://docs.mongodb.com/manual/core/query-optimization/#read-operations-covered-query</a></p>
<p>【示例】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.comment.find(&#123;userid:&quot;1003&quot;&#125;,&#123;userid:1,_id:0&#125;)</span><br><span class="line">&#123; &quot;userid&quot; : &quot;1003&quot; &#125;</span><br><span class="line">&#123; &quot;userid&quot; : &quot;1003&quot; &#125;</span><br><span class="line">&gt; db.comment.find(&#123;userid:&quot;1003&quot;&#125;,&#123;userid:1,_id:0&#125;).explain()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;queryPlanner&quot; : &#123;</span><br><span class="line">        &quot;plannerVersion&quot; : 1,</span><br><span class="line">        &quot;namespace&quot; : &quot;articledb.comment&quot;,</span><br><span class="line">        &quot;indexFilterSet&quot; : false,</span><br><span class="line">        &quot;parsedQuery&quot; : &#123;</span><br><span class="line">            &quot;userid&quot; : &#123;</span><br><span class="line">                &quot;$eq&quot; : &quot;1003&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;winningPlan&quot; : &#123;</span><br><span class="line">            &quot;stage&quot; : &quot;PROJECTION&quot;,</span><br><span class="line">            &quot;transformBy&quot; : &#123;</span><br><span class="line">                &quot;userid&quot; : 1,</span><br><span class="line">                &quot;_id&quot; : 0</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;inputStage&quot; : &#123;</span><br><span class="line">                &quot;stage&quot; : &quot;IXSCAN&quot;,</span><br><span class="line">                &quot;keyPattern&quot; : &#123;</span><br><span class="line">                	&quot;userid&quot; : 1</span><br><span class="line">            	&#125;,</span><br><span class="line">                &quot;indexName&quot; : &quot;userid_1&quot;,</span><br><span class="line">                &quot;isMultiKey&quot; : false,</span><br><span class="line">                &quot;multiKeyPaths&quot; : &#123;</span><br><span class="line">                    &quot;userid&quot; : [ ]</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;isUnique&quot; : false,</span><br><span class="line">                &quot;isSparse&quot; : false,</span><br><span class="line">                &quot;isPartial&quot; : false,</span><br><span class="line">                &quot;indexVersion&quot; : 2,</span><br><span class="line">                &quot;direction&quot; : &quot;forward&quot;,</span><br><span class="line">                &quot;indexBounds&quot; : &#123;</span><br><span class="line">                    &quot;userid&quot; : [</span><br><span class="line">                        &quot;[\&quot;1003\&quot;, \&quot;1003\&quot;]&quot;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;rejectedPlans&quot; : [ ]</span><br><span class="line">	&#125;,</span><br><span class="line">    &quot;serverInfo&quot; : &#123;</span><br><span class="line">        &quot;host&quot; : &quot;bobohost.localdomain&quot;,</span><br><span class="line">        &quot;port&quot; : 27017,</span><br><span class="line">        &quot;version&quot; : &quot;4.0.10&quot;,</span><br><span class="line">        &quot;gitVersion&quot; : &quot;c389e7f69f637f7a1ac3cc9fae843b635f20b766&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Compass 中：</p>
<p><img src="https://img-blog.csdnimg.cn/20200912222653761.png" alt="image-20200912191627943"></p>
<h1 id="5-文章评论"><a href="#5-文章评论" class="headerlink" title="5. 文章评论"></a>5. 文章评论</h1><h2 id="5-1-需求分析"><a href="#5-1-需求分析" class="headerlink" title="5.1 需求分析"></a>5.1 需求分析</h2><p>某头条的文章评论业务如下：</p>
<p><img src="https://img-blog.csdnimg.cn/20200912222709789.png" alt="image-20200912191728761"></p>
<p>文章示例参考：早晨空腹喝水，是对还是错？ <a href="https://www.toutiao.com/a6721476546088927748/" target="_blank" rel="noopener">https://www.toutiao.com/a6721476546088927748/</a></p>
<p>需要实现以下功能：</p>
<ul>
<li>基本增删改查API</li>
<li>根据文章id查询评论</li>
<li>评论点赞</li>
</ul>
<h2 id="5-2-表结构分析"><a href="#5-2-表结构分析" class="headerlink" title="5.2 表结构分析"></a>5.2 表结构分析</h2><p>数据库：articledb</p>
<table>
<thead>
<tr>
<th>专栏文章评论</th>
<th>comment</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>字段名称</td>
<td>字段含义</td>
<td>字段类型</td>
<td>备注</td>
</tr>
<tr>
<td>_id</td>
<td>ID</td>
<td>ObjectId或String</td>
<td>Mongo的主键的字段</td>
</tr>
<tr>
<td>articleid</td>
<td>文章ID</td>
<td>String</td>
<td></td>
</tr>
<tr>
<td>content</td>
<td>评论内容</td>
<td>String</td>
<td></td>
</tr>
<tr>
<td>userid</td>
<td>评论人ID</td>
<td>String</td>
<td></td>
</tr>
<tr>
<td>nickname</td>
<td>评论人昵称</td>
<td>String</td>
<td></td>
</tr>
<tr>
<td>createdatetime</td>
<td>评论的日期时间</td>
<td>Date</td>
<td></td>
</tr>
<tr>
<td>likenum</td>
<td>点赞数</td>
<td>Int32</td>
<td></td>
</tr>
<tr>
<td>replynum</td>
<td>回复数</td>
<td>Int32</td>
<td></td>
</tr>
<tr>
<td>state</td>
<td>状态</td>
<td>String</td>
<td>0：不可见；1：可见；</td>
</tr>
<tr>
<td>parentid</td>
<td>上级ID</td>
<td>String</td>
<td>如果为0表示文章的顶级评论</td>
</tr>
</tbody></table>
<h2 id="5-3-技术选型"><a href="#5-3-技术选型" class="headerlink" title="5.3 技术选型"></a>5.3 技术选型</h2><h3 id="5-3-1-mongodb-driver"><a href="#5-3-1-mongodb-driver" class="headerlink" title="5.3.1 mongodb-driver"></a>5.3.1 mongodb-driver</h3><p>mongodb-driver是mongo官方推出的java连接mongoDB的驱动包，相当于JDBC驱动。我们通过一个入门的案例来了解mongodb-driver的基本使用。</p>
<p>官方驱动说明和下载： <a href="http://mongodb.github.io/mongo-java-driver/" target="_blank" rel="noopener">http://mongodb.github.io/mongo-java-driver/</a></p>
<p>官方驱动示例文档：<a href="http://mongodb.github.io/mongo-java-driver/3.8/driver/getting-started/quick-start/" target="_blank" rel="noopener">http://mongodb.github.io/mongo-java-driver/3.8/driver/getting-started/quick-start/</a></p>
<h3 id="5-3-2-SpringDataMongoDB"><a href="#5-3-2-SpringDataMongoDB" class="headerlink" title="5.3.2 SpringDataMongoDB"></a>5.3.2 SpringDataMongoDB</h3><p>SpringData家族成员之一，用于操作MongoDB的持久层框架，封装了底层的mongodb-driver。</p>
<p>官网主页： <a href="https://projects.spring.io/spring-data-mongodb/" target="_blank" rel="noopener">https://projects.spring.io/spring-data-mongodb/</a></p>
<p>我们十次方项目的吐槽微服务就采用SpringDataMongoDB框架。</p>
<h2 id="5-4-文章微服务模块搭建"><a href="#5-4-文章微服务模块搭建" class="headerlink" title="5.4 文章微服务模块搭建"></a>5.4 文章微服务模块搭建</h2><p>（1）搭建项目工程article，pom.xml引入依赖：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.1.6.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;relativePath&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line">    &lt;groupId&gt;com.wgy&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;article&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-data-mongodb&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>

<p>（ 2）创建application.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  #数据源配置</span><br><span class="line">  data:</span><br><span class="line">    mongodb:</span><br><span class="line">      # 主机地址</span><br><span class="line">      #host: 192.168.142.128</span><br><span class="line">      # 数据库</span><br><span class="line">      #database: articledb</span><br><span class="line">      # 默认端口是27017</span><br><span class="line">      #port: 27017</span><br><span class="line">      #也可以使用uri连接</span><br><span class="line">      uri: mongodb:&#x2F;&#x2F;192.168.142.128:27017&#x2F;articledb</span><br><span class="line">server:</span><br><span class="line">  # 端口</span><br><span class="line">  port: 80</span><br></pre></td></tr></table></figure>

<p>（ 3）创建启动类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">package com.wgy;</span><br><span class="line"></span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 启动类</span><br><span class="line"> *</span><br><span class="line"> * @author wgy</span><br><span class="line"> *&#x2F;</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class ArticleApplication &#123;</span><br><span class="line">    </span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(ArticleApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（4）启动项目，看是否能正常启动，控制台没有错误。</p>
<h2 id="5-5-文章评论实体类的编写"><a href="#5-5-文章评论实体类的编写" class="headerlink" title="5.5 文章评论实体类的编写"></a>5.5 文章评论实体类的编写</h2><p>创建实体类 创建包com.wgy.article，包下建包po用于存放实体类，创建实体类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 评论实体类</span><br><span class="line"> *</span><br><span class="line"> * @author wgy</span><br><span class="line"> *&#x2F;</span><br><span class="line">&#x2F;&#x2F;把一个java类声明为mongodb的文档，可以通过collection参数指定这个类对应的文档。</span><br><span class="line">&#x2F;&#x2F;@Document(collection&#x3D;&quot;mongodb 对应 collection 名&quot;)</span><br><span class="line">&#x2F;&#x2F; 若未加 @Document ，该 bean save 到 mongo 的 comment collection</span><br><span class="line">&#x2F;&#x2F; 若添加 @Document ，则 save 到 comment collection</span><br><span class="line">@Document(collection &#x3D; &quot;comment&quot;)&#x2F;&#x2F;可以省略，如果省略，则默认使用类名小写映射集合</span><br><span class="line">&#x2F;&#x2F;复合索引</span><br><span class="line">&#x2F;&#x2F; @CompoundIndex( def &#x3D; &quot;&#123;&#39;userid&#39;: 1, &#39;nickname&#39;: -1&#125;&quot;)</span><br><span class="line">public class Comment implements Serializable &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;主键标识，该属性的值会自动对应mongodb的主键字段&quot;_id&quot;，如果该属性名就叫“id”,则该注解可以省略，否则必须写</span><br><span class="line">    @Id</span><br><span class="line">    private String id;&#x2F;&#x2F;主键    &#x2F;&#x2F;该属性对应mongodb的字段的名字，如果一致，则无需该注解</span><br><span class="line">    @Field(&quot;content&quot;)</span><br><span class="line">    private String content;&#x2F;&#x2F;吐槽内容</span><br><span class="line">    private Date publishtime;&#x2F;&#x2F;发布日期    &#x2F;&#x2F;添加了一个单字段的索引</span><br><span class="line">    @Indexed</span><br><span class="line">    private String userid;&#x2F;&#x2F;发布人ID</span><br><span class="line">    private String nickname;&#x2F;&#x2F;昵称</span><br><span class="line">    private LocalDateTime createdatetime;&#x2F;&#x2F;评论的日期时间</span><br><span class="line">    private Integer likenum;&#x2F;&#x2F;点赞数</span><br><span class="line">    private Integer replynum;&#x2F;&#x2F;回复数</span><br><span class="line">    private String state;&#x2F;&#x2F;状态</span><br><span class="line">    private String parentid;&#x2F;&#x2F;上级ID</span><br><span class="line">    private String articleid;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;set&#x2F;get&#x2F;toString...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>索引可以大大提升查询效率，一般在查询字段上添加索引，索引的添加可以通过Mongo的命令来添加，也可以在Java的实体类中通过注解添加。</p>
<p>1）单字段索引注解@Indexed</p>
<p>org.springframework.data.mongodb.core.index.Indexed.class</p>
<p>声明该字段需要索引，建索引可以大大的提高查询效率。</p>
<p>Mongo命令参考：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.createIndex(&#123;&quot;userid&quot;:1&#125;)</span><br></pre></td></tr></table></figure>

<p>2 ）复合索引注解@CompoundIndex</p>
<p>org.springframework.data.mongodb.core.index.CompoundIndex.class</p>
<p>复合索引的声明，建复合索引可以有效地提高多字段的查询效率。</p>
<p>Mongo命令参考：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.createIndex(&#123;&quot;userid&quot;:1,&quot;nickname&quot;:-1&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="5-6-文章评论的基本增删改查"><a href="#5-6-文章评论的基本增删改查" class="headerlink" title="5.6 文章评论的基本增删改查"></a>5.6 文章评论的基本增删改查</h2><p>（1）创建数据访问接口 com.wgy.article包下创建dao包，包下创建接口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 评论的持久层接口</span><br><span class="line"> *</span><br><span class="line"> * @author wgy</span><br><span class="line"> *&#x2F;</span><br><span class="line">public interface CommentRepository extends MongoRepository&lt;Comment, String&gt; &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（ 2）创建业务逻辑类 com.wgy.article包下创建service包，包下创建类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 评论的业务层</span><br><span class="line"> *</span><br><span class="line"> * @author wgy</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Service</span><br><span class="line">public class CommentService &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;注入dao</span><br><span class="line">    @Autowired</span><br><span class="line">    private CommentRepository commentRepository;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 保存一个评论</span><br><span class="line">     *</span><br><span class="line">     * @param comment</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void saveComment(Comment comment) &#123;</span><br><span class="line">        &#x2F;&#x2F;如果需要自定义主键，可以在这里指定主键；如果不指定主键，MongoDB会自动生成主键</span><br><span class="line">        &#x2F;&#x2F;设置一些默认初始值。。。</span><br><span class="line">        &#x2F;&#x2F;调用dao</span><br><span class="line">        commentRepository.save(comment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 更新评论</span><br><span class="line">     *</span><br><span class="line">     * @param comment</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void updateComment(Comment comment) &#123;</span><br><span class="line">        &#x2F;&#x2F;调用dao</span><br><span class="line">        commentRepository.save(comment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 根据id删除评论</span><br><span class="line">     *</span><br><span class="line">     * @param id</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void deleteCommentById(String id) &#123;</span><br><span class="line">        &#x2F;&#x2F;调用dao</span><br><span class="line">        commentRepository.deleteById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 查询所有评论</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public List&lt;Comment&gt; findCommentList() &#123;</span><br><span class="line">        &#x2F;&#x2F;调用dao</span><br><span class="line">        return commentRepository.findAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 根据id查询评论</span><br><span class="line">     *</span><br><span class="line">     * @param id</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public Comment findCommentById(String id) &#123;</span><br><span class="line">        &#x2F;&#x2F;调用dao</span><br><span class="line">        return commentRepository.findById(id).get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（ 3）新建Junit测试类，测试保存和查询所有：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 评论测试类</span><br><span class="line"> *</span><br><span class="line"> * @author wgy</span><br><span class="line"> *&#x2F;</span><br><span class="line">@RunWith(SpringRunner.class)</span><br><span class="line">@SpringBootTest</span><br><span class="line">public class CommentServiceTest &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private CommentService commentService;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 查询所有数据</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Test</span><br><span class="line">    public void testFindCommentList() &#123;</span><br><span class="line">        List&lt;Comment&gt; commentList &#x3D; commentService.findCommentList();</span><br><span class="line">        System.out.println(commentList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 测试根据id查询</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Test</span><br><span class="line">    public void testFindCommentById() &#123;</span><br><span class="line">        Comment commentById &#x3D; commentService.findCommentById(&quot;1&quot;);</span><br><span class="line">        System.out.println(commentById);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 保存一个评论</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Test</span><br><span class="line">    public void testSaveComment() &#123;</span><br><span class="line">        Comment comment &#x3D; new Comment();</span><br><span class="line">        comment.setArticleid(&quot;100000&quot;);</span><br><span class="line">        comment.setContent(&quot;测试添加的数据&quot;);</span><br><span class="line">        comment.setCreatedatetime(LocalDateTime.now());</span><br><span class="line">        comment.setUserid(&quot;1003&quot;);</span><br><span class="line">        comment.setNickname(&quot;凯撒大帝&quot;);</span><br><span class="line">        comment.setState(&quot;1&quot;);</span><br><span class="line">        comment.setLikenum(0);</span><br><span class="line">        comment.setReplynum(0);</span><br><span class="line">        commentService.saveComment(comment);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-7-根据上级ID查询文章评论的分页列表"><a href="#5-7-根据上级ID查询文章评论的分页列表" class="headerlink" title="5.7 根据上级ID查询文章评论的分页列表"></a>5.7 根据上级ID查询文章评论的分页列表</h2><p>（1）CommentRepository新增方法定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 根据父id，查询子评论的分页列表</span><br><span class="line"> *</span><br><span class="line"> * @param parentid</span><br><span class="line"> * @param pageable</span><br><span class="line"> * @return</span><br><span class="line"> *&#x2F;</span><br><span class="line">Page&lt;Comment&gt; findByParentid(String parentid, Pageable pageable);</span><br></pre></td></tr></table></figure>

<p>（2）CommentService新增方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 根据父id查询分页列表</span><br><span class="line"> *</span><br><span class="line"> * @param parentid</span><br><span class="line"> * @param page</span><br><span class="line"> * @param size</span><br><span class="line"> * @return</span><br><span class="line"> *&#x2F;</span><br><span class="line">public Page&lt;Comment&gt; findCommentListByParentid(String parentid, int page, int size) &#123;</span><br><span class="line">    return commentRepository.findByParentid(parentid, PageRequest.of(page - 1, size));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（3）junit测试用例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 测试根据父id查询子评论的分页列表</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Test</span><br><span class="line">public void testFindCommentListByParentid() &#123;</span><br><span class="line">    Page&lt;Comment&gt; pageResponse &#x3D; commentService.findCommentListByParentid(&quot;3&quot;, 1, 2);</span><br><span class="line">    System.out.println(&quot;----总记录数：&quot; + pageResponse.getTotalElements());</span><br><span class="line">    System.out.println(&quot;----当前页数据：&quot; + pageResponse.getContent());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（4）测试</p>
<p>使用compass快速插入一条测试数据，数据的内容是对3号评论内容进行评论。</p>
<p><img src="https://img-blog.csdnimg.cn/20200912222735575.png" alt="image-20200912193206349"></p>
<p>执行测试，结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">----总记录数：1</span><br><span class="line">----当前页数据：[Comment&#123;id&#x3D;&#39;33&#39;, content&#x3D;&#39;你年轻，火力大&#39;, publishtime&#x3D;null, userid&#x3D;&#39;1003&#39;, nickname&#x3D;&#39;凯撒大帝&#39;,createdatetime&#x3D;null, likenum&#x3D;null, replynum&#x3D;null, state&#x3D;&#39;null&#39;, parentid&#x3D;&#39;3&#39;, articleid&#x3D;&#39;100001&#39;&#125;]</span><br></pre></td></tr></table></figure>

<h2 id="5-8-MongoTemplate-实现评论点赞"><a href="#5-8-MongoTemplate-实现评论点赞" class="headerlink" title="5.8 MongoTemplate 实现评论点赞"></a>5.8 MongoTemplate 实现评论点赞</h2><p>我们看一下以下点赞的临时示例代码： CommentService 新增updateThumbup方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 点赞-效率低</span><br><span class="line"> * @param id</span><br><span class="line"> *&#x2F;</span><br><span class="line">public void updateCommentThumbupToIncrementingOld(String id)&#123;</span><br><span class="line">    Comment comment &#x3D; CommentRepository.findById(id).get();</span><br><span class="line">    comment.setLikenum(comment.getLikenum()+1);</span><br><span class="line">    CommentRepository.save(comment);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上方法虽然实现起来比较简单，但是执行效率并不高，因为我只需要将点赞数加 1就可以了，没必要查询出所有字段修改后再更新所有字段。(蝴蝶效应)</p>
<p>我们可以使用MongoTemplate类来实现对某列的操作。 （1）修改CommentService</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;注入MongoTemplate</span><br><span class="line">@Autowired</span><br><span class="line">private MongoTemplate mongoTemplate;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 点赞数+1</span><br><span class="line"> *</span><br><span class="line"> * @param id</span><br><span class="line"> *&#x2F;</span><br><span class="line">public void updateCommentLikenum(String id) &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;  查询条件</span><br><span class="line">    Query query &#x3D; Query.query(Criteria.where(&quot;_id&quot;).is(id));</span><br><span class="line">    &#x2F;&#x2F;  更新条件</span><br><span class="line">    Update update &#x3D; new Update();</span><br><span class="line">    &#x2F;&#x2F;局部更新，相当于$set</span><br><span class="line">&#x2F;&#x2F;        update.set(key, value)</span><br><span class="line">    &#x2F;&#x2F;递增$inc</span><br><span class="line">    update.inc(&quot;likenum&quot;);</span><br><span class="line">    &#x2F;&#x2F;参数3：集合的名字或实体类的类型Comment.class</span><br><span class="line">    mongoTemplate.updateFirst(query, update, Comment.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（ 2）测试用例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 测试点赞数+1</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Test</span><br><span class="line">public void testUpdateCommentLikenum() &#123;</span><br><span class="line">    commentService.updateCommentLikenum(&quot;3&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行测试用例后，发现点赞数+1了：</p>
<p><img src="https://img-blog.csdnimg.cn/20200912222748699.png" alt="image-20200912193644179"></p>
<p>原文链接：<a href="https://wgy1993.gitee.io/archives/d69f1e.html" target="_blank" rel="noopener">https://wgy1993.gitee.io/archives/d69f1e.html</a></p>

      
    </div>
    
    
    

    
      <div>
        <div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/images/gongzhonghao.jpg" alt="zhangpengjie wechat" style="width: 200px; max-width: 100%;"/>
    <div>欢迎扫描二维码公众号一起成长~</div>
</div>

      </div>
    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>谢谢您的支持</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/weixin.jpg" alt="zhangpengjie 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/zhifubao.jpg" alt="zhangpengjie 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/mongodb/" rel="tag"># mongodb</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/12/26/k8s/20/" rel="next" title="rsync服务实现推送，拉取">
                <i class="fa fa-chevron-left"></i> rsync服务实现推送，拉取
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/03/01/mongodb/mongodb02/" rel="prev" title="mongodb二">
                mongodb二 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/zpj.jpg"
                alt="zhangpengjie" />
            
              <p class="site-author-name" itemprop="name">zhangpengjie</p>
              <p class="site-description motion-element" itemprop="description">愿你在任何困难面前都足够坚强</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">33</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://cn.bing.com/" title="必应" target="_blank">必应</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#MongoDB-一"><span class="nav-number">1.</span> <span class="nav-text">MongoDB(一)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-MongoDB-相关概念"><span class="nav-number">2.</span> <span class="nav-text">1. MongoDB 相关概念</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-业务应用场景"><span class="nav-number">2.1.</span> <span class="nav-text">1.1 业务应用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-MongoDB-简介"><span class="nav-number">2.2.</span> <span class="nav-text">1.2 MongoDB 简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-体系结构"><span class="nav-number">2.3.</span> <span class="nav-text">1.3 体系结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-数据模型"><span class="nav-number">2.4.</span> <span class="nav-text">1.4 数据模型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-MongoDB-的特点"><span class="nav-number">2.5.</span> <span class="nav-text">1.5 MongoDB 的特点</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-单机部署"><span class="nav-number">3.</span> <span class="nav-text">2. 单机部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-Windows-系统中的安装启动"><span class="nav-number">3.1.</span> <span class="nav-text">2.1 Windows 系统中的安装启动</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-1-下载安装包"><span class="nav-number">3.1.1.</span> <span class="nav-text">2.1.1 下载安装包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-2-解压安装启动"><span class="nav-number">3.1.2.</span> <span class="nav-text">2.1.2 解压安装启动</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-Shell-连接-mongo命令"><span class="nav-number">3.2.</span> <span class="nav-text">2.2 Shell 连接(mongo命令)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-1-查看已经有的数据库"><span class="nav-number">3.2.1.</span> <span class="nav-text">2.2.1 查看已经有的数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2-退出-mongodb"><span class="nav-number">3.2.2.</span> <span class="nav-text">2.2.2 退出 mongodb</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-Compass-图形化界面客户端"><span class="nav-number">3.3.</span> <span class="nav-text">2.3 Compass- 图形化界面客户端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-Linux-系统中的安装启动和连接"><span class="nav-number">3.4.</span> <span class="nav-text">2.4 Linux 系统中的安装启动和连接</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-基本常用命令"><span class="nav-number">4.</span> <span class="nav-text">3. 基本常用命令</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-案例需求"><span class="nav-number">4.1.</span> <span class="nav-text">3.1 案例需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-数据库操作"><span class="nav-number">4.2.</span> <span class="nav-text">3.2 数据库操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-1-选择和创建数据库"><span class="nav-number">4.2.1.</span> <span class="nav-text">3.2.1 选择和创建数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-2-数据库的删除"><span class="nav-number">4.2.2.</span> <span class="nav-text">3.2.2 数据库的删除</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-集合操作"><span class="nav-number">4.3.</span> <span class="nav-text">3.3 集合操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-1-集合的显式创建"><span class="nav-number">4.3.1.</span> <span class="nav-text">3.3.1 集合的显式创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-2-集合的隐式创建"><span class="nav-number">4.3.2.</span> <span class="nav-text">3.3.2 集合的隐式创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-3-集合的删除"><span class="nav-number">4.3.3.</span> <span class="nav-text">3.3.3 集合的删除</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-文档基本CRUD"><span class="nav-number">4.4.</span> <span class="nav-text">3.4 文档基本CRUD</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-1-文档的插入"><span class="nav-number">4.4.1.</span> <span class="nav-text">3.4.1 文档的插入</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-1-1-单个文档插入"><span class="nav-number">4.4.1.1.</span> <span class="nav-text">3.4.1.1 单个文档插入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-1-2-批量插入"><span class="nav-number">4.4.1.2.</span> <span class="nav-text">3.4.1.2 批量插入</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-2-文档的基本查询"><span class="nav-number">4.4.2.</span> <span class="nav-text">3.4.2 文档的基本查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-2-1-查询所有"><span class="nav-number">4.4.2.1.</span> <span class="nav-text">3.4.2.1 查询所有</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-2-2-投影查询（PROJECTION-QUERY）"><span class="nav-number">4.4.2.2.</span> <span class="nav-text">3.4.2.2 投影查询（PROJECTION QUERY）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-3-文档的更新"><span class="nav-number">4.4.3.</span> <span class="nav-text">3.4.3 文档的更新</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-3-1-覆盖的修改"><span class="nav-number">4.4.3.1.</span> <span class="nav-text">3.4.3.1 覆盖的修改</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-3-2-局部修改"><span class="nav-number">4.4.3.2.</span> <span class="nav-text">3.4.3.2 局部修改</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-3-3-批量的修改"><span class="nav-number">4.4.3.3.</span> <span class="nav-text">3.4.3.3 批量的修改</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-3-4-列值增长的修改"><span class="nav-number">4.4.3.4.</span> <span class="nav-text">3.4.3.4 列值增长的修改</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-4-删除文档"><span class="nav-number">4.4.4.</span> <span class="nav-text">3.4.4 删除文档</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-文档的分页查询"><span class="nav-number">4.5.</span> <span class="nav-text">3.5 文档的分页查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-1-统计查询"><span class="nav-number">4.5.1.</span> <span class="nav-text">3.5.1 统计查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-5-1-1-统计所有记录数"><span class="nav-number">4.5.1.1.</span> <span class="nav-text">3.5.1.1 统计所有记录数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-5-1-2-按条件统计记录数"><span class="nav-number">4.5.1.2.</span> <span class="nav-text">3.5.1.2 按条件统计记录数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-2-分页列表查询"><span class="nav-number">4.5.2.</span> <span class="nav-text">3.5.2 分页列表查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-3-排序查询"><span class="nav-number">4.5.3.</span> <span class="nav-text">3.5.3 排序查询</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-6-文档的更多查询"><span class="nav-number">4.6.</span> <span class="nav-text">3.6 文档的更多查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-1-正则的复杂条件查询"><span class="nav-number">4.6.1.</span> <span class="nav-text">3.6.1 正则的复杂条件查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-2-比较查询"><span class="nav-number">4.6.2.</span> <span class="nav-text">3.6.2 比较查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-3-包含查询"><span class="nav-number">4.6.3.</span> <span class="nav-text">3.6.3 包含查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-4-条件连接查询"><span class="nav-number">4.6.4.</span> <span class="nav-text">3.6.4 条件连接查询</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-7-常用命令小结"><span class="nav-number">4.7.</span> <span class="nav-text">3.7 常用命令小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-索引-Index"><span class="nav-number">5.</span> <span class="nav-text">4. 索引-Index</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-概述"><span class="nav-number">5.1.</span> <span class="nav-text">4.1 概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-索引的类型"><span class="nav-number">5.2.</span> <span class="nav-text">4.2 索引的类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-1-单字段索引"><span class="nav-number">5.2.1.</span> <span class="nav-text">4.2.1 单字段索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-2-复合索引"><span class="nav-number">5.2.2.</span> <span class="nav-text">4.2.2 复合索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-3-其他索引"><span class="nav-number">5.2.3.</span> <span class="nav-text">4.2.3 其他索引</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-索引的管理操作"><span class="nav-number">5.3.</span> <span class="nav-text">4.3 索引的管理操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-1-索引的查看"><span class="nav-number">5.3.1.</span> <span class="nav-text">4.3.1 索引的查看</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-2-索引的创建"><span class="nav-number">5.3.2.</span> <span class="nav-text">4.3.2 索引的创建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-2-1-单字段索引"><span class="nav-number">5.3.2.1.</span> <span class="nav-text">4.3.2.1 单字段索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-2-2-复合索引"><span class="nav-number">5.3.2.2.</span> <span class="nav-text">4.3.2.2 复合索引</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-3-索引的移除"><span class="nav-number">5.3.3.</span> <span class="nav-text">4.3.3 索引的移除</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-3-1-指定索引的移除"><span class="nav-number">5.3.3.1.</span> <span class="nav-text">4.3.3.1 指定索引的移除</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-3-2-所有索引的移除"><span class="nav-number">5.3.3.2.</span> <span class="nav-text">4.3.3.2 所有索引的移除</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-索引的使用"><span class="nav-number">5.4.</span> <span class="nav-text">4.4 索引的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-1-执行计划"><span class="nav-number">5.4.1.</span> <span class="nav-text">4.4.1 执行计划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-2-涵盖的查询"><span class="nav-number">5.4.2.</span> <span class="nav-text">4.4.2 涵盖的查询</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-文章评论"><span class="nav-number">6.</span> <span class="nav-text">5. 文章评论</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-需求分析"><span class="nav-number">6.1.</span> <span class="nav-text">5.1 需求分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-表结构分析"><span class="nav-number">6.2.</span> <span class="nav-text">5.2 表结构分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-技术选型"><span class="nav-number">6.3.</span> <span class="nav-text">5.3 技术选型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-1-mongodb-driver"><span class="nav-number">6.3.1.</span> <span class="nav-text">5.3.1 mongodb-driver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-2-SpringDataMongoDB"><span class="nav-number">6.3.2.</span> <span class="nav-text">5.3.2 SpringDataMongoDB</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-4-文章微服务模块搭建"><span class="nav-number">6.4.</span> <span class="nav-text">5.4 文章微服务模块搭建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-5-文章评论实体类的编写"><span class="nav-number">6.5.</span> <span class="nav-text">5.5 文章评论实体类的编写</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-6-文章评论的基本增删改查"><span class="nav-number">6.6.</span> <span class="nav-text">5.6 文章评论的基本增删改查</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-7-根据上级ID查询文章评论的分页列表"><span class="nav-number">6.7.</span> <span class="nav-text">5.7 根据上级ID查询文章评论的分页列表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-8-MongoTemplate-实现评论点赞"><span class="nav-number">6.8.</span> <span class="nav-text">5.8 MongoTemplate 实现评论点赞</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhangpengjie</span>

  
</div>


  <div class="powered-by">爱分享爱自由</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'SFffbOWnbxhEhkvt0mSxlD0E-gzGzoHsz',
        appKey: 'gdvigtTA0Ux7TDRUmqRJMoTV',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
