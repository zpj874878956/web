<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="nginx," />





  <link rel="alternate" href="/atom.xml" title="zpj" type="application/atom+xml" />






<meta name="description" content="Nginxé…ç½®æ•™ç¨‹  Nginx æ˜¯ä¸€æ¬¾é¢å‘æ€§èƒ½è®¾è®¡çš„ HTTP æœåŠ¡å™¨ï¼Œèƒ½åå‘ä»£ç† HTTPï¼ŒHTTPS å’Œé‚®ä»¶ç›¸å…³(SMTPï¼ŒPOP3ï¼ŒIMAP)çš„åè®®é“¾æ¥ã€‚å¹¶ä¸”æä¾›äº†è´Ÿè½½å‡è¡¡ä»¥åŠ HTTP ç¼“å­˜ã€‚å®ƒçš„è®¾è®¡å……åˆ†ä½¿ç”¨å¼‚æ­¥äº‹ä»¶æ¨¡å‹ï¼Œå‰Šå‡ä¸Šä¸‹æ–‡è°ƒåº¦çš„å¼€é”€ï¼Œæé«˜æœåŠ¡å™¨å¹¶å‘èƒ½åŠ›ã€‚é‡‡ç”¨äº†æ¨¡å—åŒ–è®¾è®¡ï¼Œæä¾›äº†ä¸°å¯Œæ¨¡å—çš„ç¬¬ä¸‰æ–¹æ¨¡å—ã€‚ æ‰€ä»¥å…³äº Nginxï¼Œæœ‰è¿™äº›æ ‡ç­¾ï¼šã€Œå¼‚æ­¥ã€ã€Œäº‹ä»¶ã€ã€Œæ¨¡å—åŒ–ã€ã€Œé«˜æ€§èƒ½ã€ã€Œé«˜å¹¶å‘">
<meta property="og:type" content="article">
<meta property="og:title" content="nginxé…ç½®æ•™ç¨‹">
<meta property="og:url" content="http://yoursite.com/2020/12/07/nginx%E9%85%8D%E7%BD%AE%E6%95%99%E7%A8%8B/index.html">
<meta property="og:site_name" content="zpj">
<meta property="og:description" content="Nginxé…ç½®æ•™ç¨‹  Nginx æ˜¯ä¸€æ¬¾é¢å‘æ€§èƒ½è®¾è®¡çš„ HTTP æœåŠ¡å™¨ï¼Œèƒ½åå‘ä»£ç† HTTPï¼ŒHTTPS å’Œé‚®ä»¶ç›¸å…³(SMTPï¼ŒPOP3ï¼ŒIMAP)çš„åè®®é“¾æ¥ã€‚å¹¶ä¸”æä¾›äº†è´Ÿè½½å‡è¡¡ä»¥åŠ HTTP ç¼“å­˜ã€‚å®ƒçš„è®¾è®¡å……åˆ†ä½¿ç”¨å¼‚æ­¥äº‹ä»¶æ¨¡å‹ï¼Œå‰Šå‡ä¸Šä¸‹æ–‡è°ƒåº¦çš„å¼€é”€ï¼Œæé«˜æœåŠ¡å™¨å¹¶å‘èƒ½åŠ›ã€‚é‡‡ç”¨äº†æ¨¡å—åŒ–è®¾è®¡ï¼Œæä¾›äº†ä¸°å¯Œæ¨¡å—çš„ç¬¬ä¸‰æ–¹æ¨¡å—ã€‚ æ‰€ä»¥å…³äº Nginxï¼Œæœ‰è¿™äº›æ ‡ç­¾ï¼šã€Œå¼‚æ­¥ã€ã€Œäº‹ä»¶ã€ã€Œæ¨¡å—åŒ–ã€ã€Œé«˜æ€§èƒ½ã€ã€Œé«˜å¹¶å‘">
<meta property="og:image" content="https://dictator.oss-cn-hongkong.aliyuncs.com/hexo/title/nginx.svg">
<meta property="article:published_time" content="2020-12-07T13:43:40.795Z">
<meta property="article:modified_time" content="2020-12-07T13:43:40.787Z">
<meta property="article:author" content="zhangpengjie">
<meta property="article:tag" content="nginx">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://dictator.oss-cn-hongkong.aliyuncs.com/hexo/title/nginx.svg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/12/07/nginxé…ç½®æ•™ç¨‹/"/>





  <title>nginxé…ç½®æ•™ç¨‹ | zpj</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<!-- åŠ å…¥APlayeréŸ³ä¹æ’­æ”¾å™¨ -->
<link rel="stylesheet" href="/dist/APlayer.min.css">
<div id="aplayer"></div>
<script type="text/javascript" src="/dist/APlayer.min.js"></script>
<script type="text/javascript" src="/dist/music.js"></script>

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zpj</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">å¥½å¥½å­¦ä¹ å¤©å¤©å‘ä¸Š</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            å…³äº
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            æœç´¢
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="æœç´¢..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/07/nginx%E9%85%8D%E7%BD%AE%E6%95%99%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhangpengjie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/zpj.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zpj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">nginxé…ç½®æ•™ç¨‹</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-12-07T21:43:40+08:00">
                2020-12-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/nginx/" itemprop="url" rel="index">
                    <span itemprop="name">nginx</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/12/07/nginx%E9%85%8D%E7%BD%AE%E6%95%99%E7%A8%8B/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/12/07/nginx%E9%85%8D%E7%BD%AE%E6%95%99%E7%A8%8B/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Nginxé…ç½®æ•™ç¨‹"><a href="#Nginxé…ç½®æ•™ç¨‹" class="headerlink" title="Nginxé…ç½®æ•™ç¨‹"></a>Nginxé…ç½®æ•™ç¨‹</h1><p><a href="http://nginx.org/" target="_blank" rel="noopener"><br><img src="https://dictator.oss-cn-hongkong.aliyuncs.com/hexo/title/nginx.svg" alt="img">
</a></p>
<p>Nginx æ˜¯ä¸€æ¬¾é¢å‘æ€§èƒ½è®¾è®¡çš„ HTTP æœåŠ¡å™¨ï¼Œèƒ½åå‘ä»£ç† HTTPï¼ŒHTTPS å’Œé‚®ä»¶ç›¸å…³(SMTPï¼ŒPOP3ï¼ŒIMAP)çš„åè®®é“¾æ¥ã€‚å¹¶ä¸”æä¾›äº†è´Ÿè½½å‡è¡¡ä»¥åŠ HTTP ç¼“å­˜ã€‚å®ƒçš„è®¾è®¡å……åˆ†ä½¿ç”¨å¼‚æ­¥äº‹ä»¶æ¨¡å‹ï¼Œå‰Šå‡ä¸Šä¸‹æ–‡è°ƒåº¦çš„å¼€é”€ï¼Œæé«˜æœåŠ¡å™¨å¹¶å‘èƒ½åŠ›ã€‚é‡‡ç”¨äº†æ¨¡å—åŒ–è®¾è®¡ï¼Œæä¾›äº†ä¸°å¯Œæ¨¡å—çš„ç¬¬ä¸‰æ–¹æ¨¡å—ã€‚</p>
<p>æ‰€ä»¥å…³äº Nginxï¼Œæœ‰è¿™äº›æ ‡ç­¾ï¼šã€Œå¼‚æ­¥ã€ã€Œäº‹ä»¶ã€ã€Œæ¨¡å—åŒ–ã€ã€Œé«˜æ€§èƒ½ã€ã€Œé«˜å¹¶å‘ã€ã€Œåå‘ä»£ç†ã€ã€Œè´Ÿè½½å‡è¡¡ã€</p>
<p>Linuxç³»ç»Ÿï¼š<code>Centos 7 x64</code><br>Nginxç‰ˆæœ¬ï¼š<code>1.11.5</code></p>
<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><h3 id="å®‰è£…ä¾èµ–"><a href="#å®‰è£…ä¾èµ–" class="headerlink" title="å®‰è£…ä¾èµ–"></a>å®‰è£…ä¾èµ–</h3><blockquote>
<p>prce(é‡å®šå‘æ”¯æŒ)å’Œopenssl(httpsæ”¯æŒï¼Œå¦‚æœä¸éœ€è¦httpså¯ä»¥ä¸å®‰è£…ã€‚)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶yum install -y pcre-devel </span><br><span class="line">yum -y install gcc make gcc-c++ wget</span><br><span class="line">yum -y install openssl openssl-devel</span><br></pre></td></tr></table></figure>

<p>CentOS 6.5 æˆ‘å®‰è£…çš„æ—¶å€™æ˜¯é€‰æ‹©çš„â€œåŸºæœ¬æœåŠ¡å™¨â€ï¼Œé»˜è®¤è¿™ä¸¤ä¸ªåŒ…éƒ½æ²¡å®‰è£…å…¨ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªéƒ½è¿è¡Œå®‰è£…å³å¯ã€‚</p>
<h3 id="ä¸‹è½½"><a href="#ä¸‹è½½" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h3><p><a href="http://nginx.org/download/" target="_blank" rel="noopener">nginxçš„æ‰€æœ‰ç‰ˆæœ¬åœ¨è¿™é‡Œ</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶wget http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.13.3.tar.gz</span><br><span class="line">wget http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.13.7.tar.gz</span><br><span class="line"></span><br><span class="line"># å¦‚æœæ²¡æœ‰å®‰è£…wget</span><br><span class="line"># ä¸‹è½½å·²ç¼–è¯‘ç‰ˆæœ¬</span><br><span class="line">$ yum install wget</span><br><span class="line"></span><br><span class="line"># è§£å‹å‹ç¼©åŒ…</span><br><span class="line">tar zxf nginx-1.13.3.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="ç¼–è¯‘å®‰è£…"><a href="#ç¼–è¯‘å®‰è£…" class="headerlink" title="ç¼–è¯‘å®‰è£…"></a>ç¼–è¯‘å®‰è£…</h3><p>ç„¶åè¿›å…¥ç›®å½•ç¼–è¯‘å®‰è£…ï¼Œ<a href="https://www.viayc.com/2019/03/13/Nginxé…ç½®æ•™ç¨‹/#å‚æ•°è¯´æ˜" target="_blank" rel="noopener">configureå‚æ•°è¯´æ˜</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶cd nginx-1.11.5</span><br><span class="line">.&#x2F;configure</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line">Configuration summary</span><br><span class="line">  + using system PCRE library</span><br><span class="line">  + OpenSSL library is not used</span><br><span class="line">  + using system zlib library</span><br><span class="line"></span><br><span class="line">  nginx path prefix: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&quot;</span><br><span class="line">  nginx binary file: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx&quot;</span><br><span class="line">  nginx modules path: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;modules&quot;</span><br><span class="line">  nginx configuration prefix: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&quot;</span><br><span class="line">  nginx configuration file: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf&quot;</span><br><span class="line">  nginx pid file: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;nginx.pid&quot;</span><br><span class="line">  nginx error log file: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;error.log&quot;</span><br><span class="line">  nginx http access log file: &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;access.log&quot;</span><br><span class="line">  nginx http client request body temporary files: &quot;client_body_temp&quot;</span><br><span class="line">  nginx http proxy temporary files: &quot;proxy_temp&quot;</span><br><span class="line">  nginx http fastcgi temporary files: &quot;fastcgi_temp&quot;</span><br><span class="line">  nginx http uwsgi temporary files: &quot;uwsgi_temp&quot;</span><br><span class="line">  nginx http scgi temporary files: &quot;scgi_temp&quot;</span><br></pre></td></tr></table></figure>

<p>å®‰è£…æŠ¥é”™è¯¯çš„è¯æ¯”å¦‚ï¼šâ€œC compiler cc is not foundâ€ï¼Œè¿™ä¸ªå°±æ˜¯ç¼ºå°‘ç¼–è¯‘ç¯å¢ƒï¼Œå®‰è£…ä¸€ä¸‹å°±å¯ä»¥äº† <strong>yum -y install gcc make gcc-c++ openssl-devel</strong></p>
<p>å¦‚æœæ²¡æœ‰errorä¿¡æ¯ï¼Œå°±å¯ä»¥æ‰§è¡Œä¸‹è¾¹çš„å®‰è£…äº†ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h3 id="nginxæµ‹è¯•"><a href="#nginxæµ‹è¯•" class="headerlink" title="nginxæµ‹è¯•"></a>nginxæµ‹è¯•</h3><p>è¿è¡Œä¸‹é¢å‘½ä»¤ä¼šå‡ºç°ä¸¤ä¸ªç»“æœï¼Œä¸€èˆ¬æƒ…å†µnginxä¼šå®‰è£…åœ¨<code>/usr/local/nginx</code>ç›®å½•ä¸­</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶cd &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;</span><br><span class="line">.&#x2F;nginx -t</span><br><span class="line"></span><br><span class="line"># nginx: the configuration file &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf syntax is ok</span><br><span class="line"># nginx: configuration file &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf test is successful</span><br></pre></td></tr></table></figure>

<h3 id="è®¾ç½®å…¨å±€nginxå‘½ä»¤"><a href="#è®¾ç½®å…¨å±€nginxå‘½ä»¤" class="headerlink" title="è®¾ç½®å…¨å±€nginxå‘½ä»¤"></a>è®¾ç½®å…¨å±€nginxå‘½ä»¤</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶vi ~&#x2F;.bash_profile</span><br></pre></td></tr></table></figure>

<p>å°†ä¸‹é¢å†…å®¹æ·»åŠ åˆ° <code>~/.bash_profile</code> æ–‡ä»¶ä¸­</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶PATH&#x3D;$PATH:$HOME&#x2F;bin:&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;</span><br><span class="line">export PATH</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå‘½ä»¤ <strong><code>source ~/.bash_profile</code></strong> è®©é…ç½®ç«‹å³ç”Ÿæ•ˆã€‚ä½ å°±å¯ä»¥å…¨å±€è¿è¡Œ <code>nginx</code> å‘½ä»¤äº†ã€‚</p>
<h2 id="Mac-å®‰è£…"><a href="#Mac-å®‰è£…" class="headerlink" title="Mac å®‰è£…"></a>Mac å®‰è£…</h2><p>Mac OSX å®‰è£…ç‰¹åˆ«ç®€å•ï¼Œé¦–å…ˆä½ éœ€è¦å®‰è£… <a href="https://brew.sh/" target="_blank" rel="noopener">Brew</a>ï¼Œ é€šè¿‡ <code>brew</code> å¿«é€Ÿå®‰è£… <code>nginx</code>ã€‚</p>
<h3 id="å®‰è£…nginx"><a href="#å®‰è£…nginx" class="headerlink" title="å®‰è£…nginx"></a>å®‰è£…nginx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶brew install nginx</span><br><span class="line"># Updating Homebrew...</span><br><span class="line"># &#x3D;&#x3D;&gt; Auto-updated Homebrew!</span><br><span class="line"># Updated 2 taps (homebrew&#x2F;core, homebrew&#x2F;cask).</span><br><span class="line"># &#x3D;&#x3D;&gt; Updated Formulae</span><br><span class="line"># &#x3D;&#x3D;&gt; Installing dependencies for nginx: openssl, pcre</span><br><span class="line"># &#x3D;&#x3D;&gt; Installing nginx dependency: openssl</span><br><span class="line"># &#x3D;&#x3D;&gt; Downloading https:&#x2F;&#x2F;homebrew.bintray.com&#x2F;bottles&#x2F;openssl-1.0.2o_1.high_sierra.bottle.tar.gz</span><br><span class="line"># ######################################################################## 100.0%</span><br><span class="line"># &#x3D;&#x3D;&gt; Pouring openssl-1.0.2o_1.high_sierra.bottle.tar.gz</span><br><span class="line"># &#x3D;&#x3D;&gt; Caveats</span><br><span class="line"># A CA file has been bootstrapped using certificates from the SystemRoots</span><br><span class="line"># keychain. To add additional certificates (e.g. the certificates added in</span><br><span class="line"># the System keychain), place .pem files in</span><br><span class="line">#   &#x2F;usr&#x2F;local&#x2F;etc&#x2F;openssl&#x2F;certs</span><br><span class="line"># </span><br><span class="line"># and run</span><br><span class="line">#   &#x2F;usr&#x2F;local&#x2F;opt&#x2F;openssl&#x2F;bin&#x2F;c_rehash</span><br><span class="line"># </span><br><span class="line"># This formula is keg-only, which means it was not symlinked into &#x2F;usr&#x2F;local,</span><br><span class="line"># because Apple has deprecated use of OpenSSL in favor of its own TLS and crypto libraries.</span><br><span class="line"># </span><br><span class="line"># If you need to have this software first in your PATH run:</span><br><span class="line">#   echo &#39;export PATH&#x3D;&quot;&#x2F;usr&#x2F;local&#x2F;opt&#x2F;openssl&#x2F;bin:$PATH&quot;&#39; &gt;&gt; ~&#x2F;.zshrc</span><br><span class="line"># </span><br><span class="line"># For compilers to find this software you may need to set:</span><br><span class="line">#     LDFLAGS:  -L&#x2F;usr&#x2F;local&#x2F;opt&#x2F;openssl&#x2F;lib</span><br><span class="line">#     CPPFLAGS: -I&#x2F;usr&#x2F;local&#x2F;opt&#x2F;openssl&#x2F;include</span><br><span class="line"># For pkg-config to find this software you may need to set:</span><br><span class="line">#     PKG_CONFIG_PATH: &#x2F;usr&#x2F;local&#x2F;opt&#x2F;openssl&#x2F;lib&#x2F;pkgconfig</span><br><span class="line"># </span><br><span class="line"># &#x3D;&#x3D;&gt; Summary</span><br><span class="line"># ğŸº  &#x2F;usr&#x2F;local&#x2F;Cellar&#x2F;openssl&#x2F;1.0.2o_1: 1,791 files, 12.3MB</span><br><span class="line"># &#x3D;&#x3D;&gt; Installing nginx dependency: pcre</span><br><span class="line"># &#x3D;&#x3D;&gt; Downloading https:&#x2F;&#x2F;homebrew.bintray.com&#x2F;bottles&#x2F;pcre-8.42.high_sierra.bottle.tar.gz</span><br><span class="line"># ######################################################################## 100.0%</span><br><span class="line"># &#x3D;&#x3D;&gt; Pouring pcre-8.42.high_sierra.bottle.tar.gz</span><br><span class="line"># ğŸº  &#x2F;usr&#x2F;local&#x2F;Cellar&#x2F;pcre&#x2F;8.42: 204 files, 5.3MB</span><br><span class="line"># &#x3D;&#x3D;&gt; Installing nginx</span><br><span class="line"># &#x3D;&#x3D;&gt; Downloading https:&#x2F;&#x2F;homebrew.bintray.com&#x2F;bottles&#x2F;nginx-1.13.12.high_sierra.bottle.tar.gz</span><br><span class="line"># ######################################################################## 100.0%</span><br><span class="line"># &#x3D;&#x3D;&gt; Pouring nginx-1.13.12.high_sierra.bottle.tar.gz</span><br><span class="line"># &#x3D;&#x3D;&gt; Caveats</span><br><span class="line"># Docroot is: &#x2F;usr&#x2F;local&#x2F;var&#x2F;www</span><br><span class="line"># </span><br><span class="line"># The default port has been set in &#x2F;usr&#x2F;local&#x2F;etc&#x2F;nginx&#x2F;nginx.conf to 8080 so that</span><br><span class="line"># nginx can run without sudo.</span><br><span class="line"># </span><br><span class="line"># nginx will load all files in &#x2F;usr&#x2F;local&#x2F;etc&#x2F;nginx&#x2F;servers&#x2F;.</span><br><span class="line"># </span><br><span class="line"># To have launchd start nginx now and restart at login:</span><br><span class="line">#   brew services start nginx</span><br><span class="line"># Or, if you don&#39;t wacd &#x2F;usr&#x2F;local&#x2F;Cellar&#x2F;nginx&#x2F;1.13.12&#x2F;n just run:</span><br><span class="line"># cd &#x2F;usr&#x2F;local&#x2F;Cellar&#x2F;nginx&#x2F;1.13.12&#x2F;</span><br></pre></td></tr></table></figure>

<h3 id="å¯åŠ¨æœåŠ¡"><a href="#å¯åŠ¨æœåŠ¡" class="headerlink" title="å¯åŠ¨æœåŠ¡"></a>å¯åŠ¨æœåŠ¡</h3><p>æ³¨æ„é»˜è®¤ç«¯å£ä¸æ˜¯ <code>8080</code> æŸ¥çœ‹ç¡®è®¤ç«¯å£æ˜¯å¦è¢«å ç”¨ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶brew services start nginx</span><br><span class="line"># http:&#x2F;&#x2F;localhost:8080&#x2F;</span><br></pre></td></tr></table></figure>

<h2 id="å¼€æœºè‡ªå¯åŠ¨"><a href="#å¼€æœºè‡ªå¯åŠ¨" class="headerlink" title="å¼€æœºè‡ªå¯åŠ¨"></a>å¼€æœºè‡ªå¯åŠ¨</h2><p><strong>å¼€æœºè‡ªå¯åŠ¨æ–¹æ³•ä¸€ï¼š</strong></p>
<p>ç¼–è¾‘ <strong>vi /lib/systemd/system/nginx.service</strong> æ–‡ä»¶ï¼Œæ²¡æœ‰åˆ›å»ºä¸€ä¸ª <strong>touch nginx.service</strong> ç„¶åå°†å¦‚ä¸‹å†…å®¹æ ¹æ®å…·ä½“æƒ…å†µè¿›è¡Œä¿®æ”¹åï¼Œæ·»åŠ åˆ°nginx.serviceæ–‡ä»¶ä¸­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶[Unit]</span><br><span class="line">Description&#x3D;nginx</span><br><span class="line">After&#x3D;network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"></span><br><span class="line">Type&#x3D;forking</span><br><span class="line">PIDFile&#x3D;&#x2F;var&#x2F;run&#x2F;nginx.pid</span><br><span class="line">ExecStartPre&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -t -c &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -c &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</span><br><span class="line">ExecReload&#x3D;&#x2F;bin&#x2F;kill -s HUP $MAINPID</span><br><span class="line">ExecStop&#x3D;&#x2F;bin&#x2F;kill -s QUIT $MAINPID</span><br><span class="line">PrivateTmp&#x3D;true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br></pre></td></tr></table></figure>

<ul>
<li><code>[Unit]</code>:æœåŠ¡çš„è¯´æ˜</li>
<li><code>Description</code>:æè¿°æœåŠ¡</li>
<li><code>After</code>:æè¿°æœåŠ¡ç±»åˆ«</li>
<li><code>[Service]</code>æœåŠ¡è¿è¡Œå‚æ•°çš„è®¾ç½®</li>
<li><code>Type=forking</code>æ˜¯åå°è¿è¡Œçš„å½¢å¼</li>
<li><code>ExecStart</code>ä¸ºæœåŠ¡çš„å…·ä½“è¿è¡Œå‘½ä»¤</li>
<li><code>ExecReload</code>ä¸ºé‡å¯å‘½ä»¤</li>
<li><code>ExecStop</code>ä¸ºåœæ­¢å‘½ä»¤</li>
<li><code>PrivateTmp=True</code>è¡¨ç¤ºç»™æœåŠ¡åˆ†é…ç‹¬ç«‹çš„ä¸´æ—¶ç©ºé—´</li>
</ul>
<p>æ³¨æ„ï¼š<code>[Service]</code>çš„å¯åŠ¨ã€é‡å¯ã€åœæ­¢å‘½ä»¤å…¨éƒ¨è¦æ±‚ä½¿ç”¨ç»å¯¹è·¯å¾„ã€‚</p>
<p><code>[Install]</code>è¿è¡Œçº§åˆ«ä¸‹æœåŠ¡å®‰è£…çš„ç›¸å…³è®¾ç½®ï¼Œå¯è®¾ç½®ä¸ºå¤šç”¨æˆ·ï¼Œå³ç³»ç»Ÿè¿è¡Œçº§åˆ«ä¸º<code>3</code>ã€‚</p>
<p>ä¿å­˜é€€å‡ºã€‚</p>
<p>è®¾ç½®å¼€æœºå¯åŠ¨ï¼Œä½¿é…ç½®ç”Ÿæ•ˆï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶# å¯åŠ¨nginxæœåŠ¡</span><br><span class="line">systemctl start nginx.service</span><br><span class="line"># åœæ­¢å¼€æœºè‡ªå¯åŠ¨</span><br><span class="line">systemctl disable nginx.service</span><br><span class="line"># æŸ¥çœ‹æœåŠ¡å½“å‰çŠ¶æ€</span><br><span class="line">systemctl status nginx.service</span><br><span class="line"># æŸ¥çœ‹æ‰€æœ‰å·²å¯åŠ¨çš„æœåŠ¡</span><br><span class="line">systemctl list-units --type&#x3D;service</span><br><span class="line"># é‡æ–°å¯åŠ¨æœåŠ¡</span><br><span class="line">systemctl restart nginx.service</span><br><span class="line"># è®¾ç½®å¼€æœºè‡ªå¯åŠ¨</span><br><span class="line">systemctl enable nginx.service</span><br><span class="line"># è¾“å‡ºä¸‹é¢å†…å®¹è¡¨ç¤ºæˆåŠŸäº†</span><br><span class="line">Created symlink from &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;multi-user.target.wants&#x2F;nginx.service to &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;nginx.service.</span><br><span class="line">å¤åˆ¶systemctl is-enabled servicename.service # æŸ¥è¯¢æœåŠ¡æ˜¯å¦å¼€æœºå¯åŠ¨</span><br><span class="line">systemctl enable *.service # å¼€æœºè¿è¡ŒæœåŠ¡</span><br><span class="line">systemctl disable *.service # å–æ¶ˆå¼€æœºè¿è¡Œ</span><br><span class="line">systemctl start *.service # å¯åŠ¨æœåŠ¡</span><br><span class="line">systemctl stop *.service # åœæ­¢æœåŠ¡</span><br><span class="line">systemctl restart *.service # é‡å¯æœåŠ¡</span><br><span class="line">systemctl reload *.service # é‡æ–°åŠ è½½æœåŠ¡é…ç½®æ–‡ä»¶</span><br><span class="line">systemctl status *.service # æŸ¥è¯¢æœåŠ¡è¿è¡ŒçŠ¶æ€</span><br><span class="line">systemctl --failed # æ˜¾ç¤ºå¯åŠ¨å¤±è´¥çš„æœåŠ¡</span><br></pre></td></tr></table></figure>

<p>æ³¨ï¼š*ä»£è¡¨æŸä¸ªæœåŠ¡çš„åå­—ï¼Œå¦‚httpçš„æœåŠ¡åä¸ºhttpd</p>
<p><strong>å¼€æœºè‡ªå¯åŠ¨æ–¹æ³•äºŒï¼š</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶vi &#x2F;etc&#x2F;rc.local</span><br><span class="line"></span><br><span class="line"># åœ¨ rc.local æ–‡ä»¶ä¸­ï¼Œæ·»åŠ ä¸‹é¢è¿™æ¡å‘½ä»¤</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx start</span><br></pre></td></tr></table></figure>

<p>å¦‚æœå¼€æœºåå‘ç°è‡ªå¯åŠ¨è„šæœ¬æ²¡æœ‰æ‰§è¡Œï¼Œä½ è¦å»ç¡®è®¤ä¸€ä¸‹rc.localè¿™ä¸ªæ–‡ä»¶çš„è®¿é—®æƒé™æ˜¯å¦æ˜¯å¯æ‰§è¡Œçš„ï¼Œå› ä¸ºrc.localé»˜è®¤æ˜¯ä¸å¯æ‰§è¡Œçš„ã€‚ä¿®æ”¹rc.localè®¿é—®æƒé™ï¼Œå¢åŠ å¯æ‰§è¡Œæƒé™ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶# &#x2F;etc&#x2F;rc.localæ˜¯&#x2F;etc&#x2F;rc.d&#x2F;rc.localçš„è½¯è¿æ¥ï¼Œ</span><br><span class="line">chmod +x &#x2F;etc&#x2F;rc.d&#x2F;rc.local</span><br></pre></td></tr></table></figure>

<p>å®˜æ–¹è„šæœ¬ <a href="https://www.nginx.com/resources/wiki/start/topics/examples/redhatnginxinit/" target="_blank" rel="noopener">ed Hat NGINX Init Script</a>ã€‚</p>
<h2 id="è¿ç»´"><a href="#è¿ç»´" class="headerlink" title="è¿ç»´"></a>è¿ç»´</h2><h3 id="æœåŠ¡ç®¡ç†"><a href="#æœåŠ¡ç®¡ç†" class="headerlink" title="æœåŠ¡ç®¡ç†"></a>æœåŠ¡ç®¡ç†</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶# å¯åŠ¨</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx</span><br><span class="line"></span><br><span class="line"># é‡å¯</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -s reload</span><br><span class="line"></span><br><span class="line"># å…³é—­è¿›ç¨‹</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -s stop</span><br><span class="line"></span><br><span class="line"># å¹³æ»‘å…³é—­nginx</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -s quit</span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹nginxçš„å®‰è£…çŠ¶æ€ï¼Œ</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -V</span><br></pre></td></tr></table></figure>

<p><strong>å…³é—­é˜²ç«å¢™ï¼Œæˆ–è€…æ·»åŠ é˜²ç«å¢™è§„åˆ™å°±å¯ä»¥æµ‹è¯•äº†</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶service iptables stop</span><br></pre></td></tr></table></figure>

<p>æˆ–è€…ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶vi &#x2F;etc&#x2F;sysconfig&#x2F;iptables</span><br></pre></td></tr></table></figure>

<p>æ·»åŠ è¿™æ ·ä¸€æ¡å¼€æ”¾80ç«¯å£çš„è§„åˆ™åä¿å­˜ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>é‡å¯æœåŠ¡å³å¯:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶service iptables restart</span><br><span class="line"># å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹ç›®å‰nat</span><br><span class="line">iptables -t nat -L</span><br></pre></td></tr></table></figure>

<h3 id="é‡å¯æœåŠ¡é˜²ç«å¢™æŠ¥é”™è§£å†³"><a href="#é‡å¯æœåŠ¡é˜²ç«å¢™æŠ¥é”™è§£å†³" class="headerlink" title="é‡å¯æœåŠ¡é˜²ç«å¢™æŠ¥é”™è§£å†³"></a>é‡å¯æœåŠ¡é˜²ç«å¢™æŠ¥é”™è§£å†³</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶service iptables restart</span><br><span class="line"># Redirecting to &#x2F;bin&#x2F;systemctl restart  iptables.service</span><br><span class="line"># Failed to restart iptables.service: Unit iptables.service failed to load: No such file or directory.</span><br></pre></td></tr></table></figure>

<p>åœ¨CentOS 7æˆ–RHEL 7æˆ–Fedoraä¸­é˜²ç«å¢™ç”± <strong>firewalld</strong> æ¥ç®¡ç†ï¼Œå½“ç„¶ä½ å¯ä»¥è¿˜åŸä¼ ç»Ÿçš„ç®¡ç†æ–¹å¼ã€‚æˆ–åˆ™ä½¿ç”¨æ–°çš„å‘½ä»¤è¿›è¡Œç®¡ç†ã€‚<br>å‡å¦‚é‡‡ç”¨ä¼ ç»Ÿè¯·æ‰§è¡Œä¸€ä¸‹å‘½ä»¤ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶# ä¼ ç»Ÿå‘½ä»¤</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl mask firewalld</span><br><span class="line">å¤åˆ¶# å®‰è£…å‘½ä»¤</span><br><span class="line">yum install iptables-services</span><br><span class="line"></span><br><span class="line">systemctl enable iptables </span><br><span class="line">service iptables restart</span><br></pre></td></tr></table></figure>

<h2 id="nginxå¸è½½"><a href="#nginxå¸è½½" class="headerlink" title="nginxå¸è½½"></a>nginxå¸è½½</h2><p>å¦‚æœé€šè¿‡yumå®‰è£…ï¼Œä½¿ç”¨ä¸‹é¢å‘½ä»¤å®‰è£…ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶yum remove nginx</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘å®‰è£…ï¼Œåˆ é™¤/usr/local/nginxç›®å½•å³å¯<br>å¦‚æœé…ç½®äº†è‡ªå¯åŠ¨è„šæœ¬ï¼Œä¹Ÿéœ€è¦åˆ é™¤ã€‚</p>
<h2 id="å‚æ•°è¯´æ˜"><a href="#å‚æ•°è¯´æ˜" class="headerlink" title="å‚æ•°è¯´æ˜"></a>å‚æ•°è¯´æ˜</h2><table>
<thead>
<tr>
<th align="left">å‚æ•°</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">â€“prefix=<code>&lt;path&gt;</code></td>
<td align="left">Nginxå®‰è£…è·¯å¾„ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤ä¸º /usr/local/nginxã€‚</td>
</tr>
<tr>
<td align="left">â€“sbin-path=<code>&lt;path&gt;</code></td>
<td align="left">Nginxå¯æ‰§è¡Œæ–‡ä»¶å®‰è£…è·¯å¾„ã€‚åªèƒ½å®‰è£…æ—¶æŒ‡å®šï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤ä¸º<code>&lt;prefix&gt;</code>/sbin/nginxã€‚</td>
</tr>
<tr>
<td align="left">â€“conf-path=<code>&lt;path&gt;</code></td>
<td align="left">åœ¨æ²¡æœ‰ç»™å®š-cé€‰é¡¹ä¸‹é»˜è®¤çš„nginx.confçš„è·¯å¾„ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤ä¸º<code>&lt;prefix&gt;</code>/conf/nginx.confã€‚</td>
</tr>
<tr>
<td align="left">â€“pid-path=<code>&lt;path&gt;</code></td>
<td align="left">åœ¨nginx.confä¸­æ²¡æœ‰æŒ‡å®špidæŒ‡ä»¤çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤çš„nginx.pidçš„è·¯å¾„ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤ä¸º <code>&lt;prefix&gt;</code>/logs/nginx.pidã€‚</td>
</tr>
<tr>
<td align="left">â€“lock-path=<code>&lt;path&gt;</code></td>
<td align="left">nginx.lockæ–‡ä»¶çš„è·¯å¾„ã€‚</td>
</tr>
<tr>
<td align="left">â€“error-log-path=<code>&lt;path&gt;</code></td>
<td align="left">åœ¨nginx.confä¸­æ²¡æœ‰æŒ‡å®šerror_logæŒ‡ä»¤çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤çš„é”™è¯¯æ—¥å¿—çš„è·¯å¾„ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤ä¸º <code>&lt;prefix&gt;</code>/- logs/error.logã€‚</td>
</tr>
<tr>
<td align="left">â€“http-log-path=<code>&lt;path&gt;</code></td>
<td align="left">åœ¨nginx.confä¸­æ²¡æœ‰æŒ‡å®šaccess_logæŒ‡ä»¤çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤çš„è®¿é—®æ—¥å¿—çš„è·¯å¾„ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤ä¸º <code>&lt;prefix&gt;</code>/- logs/access.logã€‚</td>
</tr>
<tr>
<td align="left">â€“user=<code>&lt;user&gt;</code></td>
<td align="left">åœ¨nginx.confä¸­æ²¡æœ‰æŒ‡å®šuseræŒ‡ä»¤çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤çš„nginxä½¿ç”¨çš„ç”¨æˆ·ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤ä¸º nobodyã€‚</td>
</tr>
<tr>
<td align="left">â€“group=<code>&lt;group&gt;</code></td>
<td align="left">åœ¨nginx.confä¸­æ²¡æœ‰æŒ‡å®šuseræŒ‡ä»¤çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤çš„nginxä½¿ç”¨çš„ç»„ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤ä¸º nobodyã€‚</td>
</tr>
<tr>
<td align="left">â€“builddir=DIR</td>
<td align="left">æŒ‡å®šç¼–è¯‘çš„ç›®å½•</td>
</tr>
<tr>
<td align="left">â€“with-rtsig_module</td>
<td align="left">å¯ç”¨ rtsig æ¨¡å—</td>
</tr>
<tr>
<td align="left">â€“with-select_module â€“without-select_module</td>
<td align="left">å…è®¸æˆ–ä¸å…è®¸å¼€å¯SELECTæ¨¡å¼ï¼Œå¦‚æœ configure æ²¡æœ‰æ‰¾åˆ°æ›´åˆé€‚çš„æ¨¡å¼ï¼Œæ¯”å¦‚ï¼škqueue(sun os),epoll (linux kenel 2.6+), rtsig(- å®æ—¶ä¿¡å·)æˆ–è€…/dev/poll(ä¸€ç§ç±»ä¼¼selectçš„æ¨¡å¼ï¼Œåº•å±‚å®ç°ä¸SELECTåŸºæœ¬ç›¸ åŒï¼Œéƒ½æ˜¯é‡‡ç”¨è½®è®­æ–¹æ³•) SELECTæ¨¡å¼å°†æ˜¯é»˜è®¤å®‰è£…æ¨¡å¼</td>
</tr>
<tr>
<td align="left">â€“with-poll_module â€“without-poll_module</td>
<td align="left">Whether or not to enable the poll module. This module is enabled by, default if a more suitable method such as kqueue, epoll, rtsig or /dev/poll is not discovered by configure.</td>
</tr>
<tr>
<td align="left">â€“with-http_ssl_module</td>
<td align="left">Enable ngx_http_ssl_module. Enables SSL support and the ability to handle HTTPS requests. Requires OpenSSL. On Debian, this is libssl-dev. å¼€å¯HTTP SSLæ¨¡å—ï¼Œä½¿NGINXå¯ä»¥æ”¯æŒHTTPSè¯·æ±‚ã€‚è¿™ä¸ªæ¨¡å—éœ€è¦å·²ç»å®‰è£…äº†OPENSSLï¼Œåœ¨DEBIANä¸Šæ˜¯libssl</td>
</tr>
<tr>
<td align="left">â€“with-http_realip_module</td>
<td align="left">å¯ç”¨ ngx_http_realip_module</td>
</tr>
<tr>
<td align="left">â€“with-http_addition_module</td>
<td align="left">å¯ç”¨ ngx_http_addition_module</td>
</tr>
<tr>
<td align="left">â€“with-http_sub_module</td>
<td align="left">å¯ç”¨ ngx_http_sub_module</td>
</tr>
<tr>
<td align="left">â€“with-http_dav_module</td>
<td align="left">å¯ç”¨ ngx_http_dav_module</td>
</tr>
<tr>
<td align="left">â€“with-http_flv_module</td>
<td align="left">å¯ç”¨ ngx_http_flv_module</td>
</tr>
<tr>
<td align="left">â€“with-http_stub_status_module</td>
<td align="left">å¯ç”¨ â€œserver statusâ€ é¡µ</td>
</tr>
<tr>
<td align="left">â€“without-http_charset_module</td>
<td align="left">ç¦ç”¨ ngx_http_charset_module</td>
</tr>
<tr>
<td align="left">â€“without-http_gzip_module</td>
<td align="left">ç¦ç”¨ ngx_http_gzip_module. å¦‚æœå¯ç”¨ï¼Œéœ€è¦ zlib ã€‚</td>
</tr>
<tr>
<td align="left">â€“without-http_ssi_module</td>
<td align="left">ç¦ç”¨ ngx_http_ssi_module</td>
</tr>
<tr>
<td align="left">â€“without-http_userid_module</td>
<td align="left">ç¦ç”¨ ngx_http_userid_module</td>
</tr>
<tr>
<td align="left">â€“without-http_access_module</td>
<td align="left">ç¦ç”¨ ngx_http_access_module</td>
</tr>
<tr>
<td align="left">â€“without-http_auth_basic_module</td>
<td align="left">ç¦ç”¨ ngx_http_auth_basic_module</td>
</tr>
<tr>
<td align="left">â€“without-http_autoindex_module</td>
<td align="left">ç¦ç”¨ ngx_http_autoindex_module</td>
</tr>
<tr>
<td align="left">â€“without-http_geo_module</td>
<td align="left">ç¦ç”¨ ngx_http_geo_module</td>
</tr>
<tr>
<td align="left">â€“without-http_map_module</td>
<td align="left">ç¦ç”¨ ngx_http_map_module</td>
</tr>
<tr>
<td align="left">â€“without-http_referer_module</td>
<td align="left">ç¦ç”¨ ngx_http_referer_module</td>
</tr>
<tr>
<td align="left">â€“without-http_rewrite_module</td>
<td align="left">ç¦ç”¨ ngx_http_rewrite_module. å¦‚æœå¯ç”¨éœ€è¦ PCRE ã€‚</td>
</tr>
<tr>
<td align="left">â€“without-http_proxy_module</td>
<td align="left">ç¦ç”¨ ngx_http_proxy_module</td>
</tr>
<tr>
<td align="left">â€“without-http_fastcgi_module</td>
<td align="left">ç¦ç”¨ ngx_http_fastcgi_module</td>
</tr>
<tr>
<td align="left">â€“without-http_memcached_module</td>
<td align="left">ç¦ç”¨ ngx_http_memcached_module</td>
</tr>
<tr>
<td align="left">â€“without-http_limit_zone_module</td>
<td align="left">ç¦ç”¨ ngx_http_limit_zone_module</td>
</tr>
<tr>
<td align="left">â€“without-http_empty_gif_module</td>
<td align="left">ç¦ç”¨ ngx_http_empty_gif_module</td>
</tr>
<tr>
<td align="left">â€“without-http_browser_module</td>
<td align="left">ç¦ç”¨ ngx_http_browser_module</td>
</tr>
<tr>
<td align="left">â€“without-http_upstream_ip_hash_module</td>
<td align="left">ç¦ç”¨ ngx_http_upstream_ip_hash_module</td>
</tr>
<tr>
<td align="left">â€“with-http_perl_module</td>
<td align="left">å¯ç”¨ ngx_http_perl_module</td>
</tr>
<tr>
<td align="left">â€“with-perl_modules_path=PATH</td>
<td align="left">æŒ‡å®š perl æ¨¡å—çš„è·¯å¾„</td>
</tr>
<tr>
<td align="left">â€“with-perl=PATH</td>
<td align="left">æŒ‡å®š perl æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„</td>
</tr>
<tr>
<td align="left">â€“http-log-path=PATH</td>
<td align="left">Set path to the http access log</td>
</tr>
<tr>
<td align="left">â€“http-client-body-temp-path=PATH</td>
<td align="left">Set path to the http client request body temporary files</td>
</tr>
<tr>
<td align="left">â€“http-proxy-temp-path=PATH</td>
<td align="left">Set path to the http proxy temporary files</td>
</tr>
<tr>
<td align="left">â€“http-fastcgi-temp-path=PATH</td>
<td align="left">Set path to the http fastcgi temporary files</td>
</tr>
<tr>
<td align="left">â€“without-http</td>
<td align="left">ç¦ç”¨ HTTP server</td>
</tr>
<tr>
<td align="left">â€“with-mail</td>
<td align="left">å¯ç”¨ IMAP4/POP3/SMTP ä»£ç†æ¨¡å—</td>
</tr>
<tr>
<td align="left">â€“with-mail_ssl_module</td>
<td align="left">å¯ç”¨ ngx_mail_ssl_module</td>
</tr>
<tr>
<td align="left">â€“with-cc=PATH</td>
<td align="left">æŒ‡å®š C ç¼–è¯‘å™¨çš„è·¯å¾„</td>
</tr>
<tr>
<td align="left">â€“with-cpp=PATH</td>
<td align="left">æŒ‡å®š C é¢„å¤„ç†å™¨çš„è·¯å¾„</td>
</tr>
<tr>
<td align="left">â€“with-cc-opt=OPTIONS</td>
<td align="left">Additional parameters which will be added to the variable CFLAGS. With the use of the system library PCRE in FreeBSD, it is necessary to indicate â€“with-cc-opt=â€-I /usr/local/includeâ€. If we are using select() and it is necessary to increase the number of file descriptors, then this also can be assigned here: â€“with-cc-opt=â€-D FD_SETSIZE=2048â€.</td>
</tr>
<tr>
<td align="left">â€“with-ld-opt=OPTIONS</td>
<td align="left">Additional parameters passed to the linker. With the use of the system library PCRE in - FreeBSD, it is necessary to indicate â€“with-ld-opt=â€-L /usr/local/libâ€.</td>
</tr>
<tr>
<td align="left">â€“with-cpu-opt=CPU</td>
<td align="left">ä¸ºç‰¹å®šçš„ CPU ç¼–è¯‘ï¼Œæœ‰æ•ˆçš„å€¼åŒ…æ‹¬ï¼špentium, pentiumpro, pentium3, pentium4, athlon, opteron, amd64, sparc32, sparc64, ppc64</td>
</tr>
<tr>
<td align="left">â€“without-pcre</td>
<td align="left">ç¦æ­¢ PCRE åº“çš„ä½¿ç”¨ã€‚åŒæ—¶ä¹Ÿä¼šç¦æ­¢ HTTP rewrite æ¨¡å—ã€‚åœ¨ â€œlocationâ€ é…ç½®æŒ‡ä»¤ä¸­çš„æ­£åˆ™è¡¨è¾¾å¼ä¹Ÿéœ€è¦ PCRE ã€‚</td>
</tr>
<tr>
<td align="left">â€“with-pcre=DIR</td>
<td align="left">æŒ‡å®š PCRE åº“çš„æºä»£ç çš„è·¯å¾„ã€‚</td>
</tr>
<tr>
<td align="left">â€“with-pcre-opt=OPTIONS</td>
<td align="left">Set additional options for PCRE building.</td>
</tr>
<tr>
<td align="left">â€“with-md5=DIR</td>
<td align="left">Set path to md5 library sources.</td>
</tr>
<tr>
<td align="left">â€“with-md5-opt=OPTIONS</td>
<td align="left">Set additional options for md5 building.</td>
</tr>
<tr>
<td align="left">â€“with-md5-asm</td>
<td align="left">Use md5 assembler sources.</td>
</tr>
<tr>
<td align="left">â€“with-sha1=DIR</td>
<td align="left">Set path to sha1 library sources.</td>
</tr>
<tr>
<td align="left">â€“with-sha1-opt=OPTIONS</td>
<td align="left">Set additional options for sha1 building.</td>
</tr>
<tr>
<td align="left">â€“with-sha1-asm</td>
<td align="left">Use sha1 assembler sources.</td>
</tr>
<tr>
<td align="left">â€“with-zlib=DIR</td>
<td align="left">Set path to zlib library sources.</td>
</tr>
<tr>
<td align="left">â€“with-zlib-opt=OPTIONS</td>
<td align="left">Set additional options for zlib building.</td>
</tr>
<tr>
<td align="left">â€“with-zlib-asm=CPU</td>
<td align="left">Use zlib assembler sources optimized for specified CPU, valid values are: pentium, pentiumpro</td>
</tr>
<tr>
<td align="left">â€“with-openssl=DIR</td>
<td align="left">Set path to OpenSSL library sources</td>
</tr>
<tr>
<td align="left">â€“with-openssl-opt=OPTIONS</td>
<td align="left">Set additional options for OpenSSL building</td>
</tr>
<tr>
<td align="left">â€“with-debug</td>
<td align="left">å¯ç”¨è°ƒè¯•æ—¥å¿—</td>
</tr>
<tr>
<td align="left">â€“add-module=PATH</td>
<td align="left">Add in a third-party module found in directory PATH</td>
</tr>
</tbody></table>
<h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><p>åœ¨Centos é»˜è®¤é…ç½®æ–‡ä»¶åœ¨ <strong>/usr/local/nginx-1.5.1/conf/nginx.conf</strong> æˆ‘ä»¬è¦åœ¨è¿™é‡Œé…ç½®ä¸€äº›æ–‡ä»¶ã€‚nginx.confæ˜¯ä¸»é…ç½®æ–‡ä»¶ï¼Œç”±è‹¥å¹²ä¸ªéƒ¨åˆ†ç»„æˆï¼Œæ¯ä¸ªå¤§æ‹¬å·<code>{}</code>è¡¨ç¤ºä¸€ä¸ªéƒ¨åˆ†ã€‚æ¯ä¸€è¡ŒæŒ‡ä»¤éƒ½ç”±åˆ†å·ç»“æŸ<code>;</code>ï¼Œæ ‡å¿—ç€ä¸€è¡Œçš„ç»“æŸã€‚</p>
<h3 id="å¸¸ç”¨æ­£åˆ™"><a href="#å¸¸ç”¨æ­£åˆ™" class="headerlink" title="å¸¸ç”¨æ­£åˆ™"></a>å¸¸ç”¨æ­£åˆ™</h3><table>
<thead>
<tr>
<th align="left">æ­£åˆ™</th>
<th align="left">è¯´æ˜</th>
<th align="left">æ­£åˆ™</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>.</code></td>
<td align="left">åŒ¹é…é™¤æ¢è¡Œç¬¦ä»¥å¤–çš„ä»»æ„å­—ç¬¦</td>
<td align="left"><code>$</code></td>
<td align="left">åŒ¹é…å­—ç¬¦ä¸²çš„ç»“æŸ</td>
</tr>
<tr>
<td align="left"><code>?</code></td>
<td align="left">é‡å¤0æ¬¡æˆ–1æ¬¡</td>
<td align="left"><code>{n}</code></td>
<td align="left">é‡å¤næ¬¡</td>
</tr>
<tr>
<td align="left"><code>+</code></td>
<td align="left">é‡å¤1æ¬¡æˆ–æ›´å¤šæ¬¡</td>
<td align="left"><code>{n,}</code></td>
<td align="left">é‡å¤næ¬¡æˆ–æ›´å¤šæ¬¡</td>
</tr>
<tr>
<td align="left"><code>*</code></td>
<td align="left">é‡å¤0æ¬¡æˆ–æ›´å¤šæ¬¡</td>
<td align="left"><code>[c]</code></td>
<td align="left">åŒ¹é…å•ä¸ªå­—ç¬¦c</td>
</tr>
<tr>
<td align="left"><code>\d</code></td>
<td align="left">åŒ¹é…æ•°å­—</td>
<td align="left"><code>[a-z]</code></td>
<td align="left">åŒ¹é…a-zå°å†™å­—æ¯çš„ä»»æ„ä¸€ä¸ª</td>
</tr>
<tr>
<td align="left"><code>^</code></td>
<td align="left">åŒ¹é…å­—ç¬¦ä¸²çš„å¼€å§‹</td>
<td align="left">-</td>
<td align="left">-</td>
</tr>
</tbody></table>
<h3 id="å…¨å±€å˜é‡"><a href="#å…¨å±€å˜é‡" class="headerlink" title="å…¨å±€å˜é‡"></a>å…¨å±€å˜é‡</h3><table>
<thead>
<tr>
<th align="left">å˜é‡</th>
<th align="left">è¯´æ˜</th>
<th align="left">å˜é‡</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">$args</td>
<td align="left">è¿™ä¸ªå˜é‡ç­‰äºè¯·æ±‚è¡Œä¸­çš„å‚æ•°ï¼ŒåŒ$query_string</td>
<td align="left">$remote_port</td>
<td align="left">å®¢æˆ·ç«¯çš„ç«¯å£ã€‚</td>
</tr>
<tr>
<td align="left">$content_length</td>
<td align="left">è¯·æ±‚å¤´ä¸­çš„Content-lengthå­—æ®µã€‚</td>
<td align="left">$remote_user</td>
<td align="left">å·²ç»ç»è¿‡Auth Basic ModuleéªŒè¯çš„ç”¨æˆ·åã€‚</td>
</tr>
<tr>
<td align="left">$content_type</td>
<td align="left">è¯·æ±‚å¤´ä¸­çš„Content-Typeå­—æ®µã€‚</td>
<td align="left">$request_filename</td>
<td align="left">å½“å‰è¯·æ±‚çš„æ–‡ä»¶è·¯å¾„ï¼Œç”±rootæˆ–aliasæŒ‡ä»¤ä¸URIè¯·æ±‚ç”Ÿæˆã€‚</td>
</tr>
<tr>
<td align="left">$document_root</td>
<td align="left">å½“å‰è¯·æ±‚åœ¨rootæŒ‡ä»¤ä¸­æŒ‡å®šçš„å€¼ã€‚</td>
<td align="left">$scheme</td>
<td align="left">HTTPæ–¹æ³•ï¼ˆå¦‚httpï¼Œhttpsï¼‰ã€‚</td>
</tr>
<tr>
<td align="left">$host</td>
<td align="left">è¯·æ±‚ä¸»æœºå¤´å­—æ®µï¼Œå¦åˆ™ä¸ºæœåŠ¡å™¨åç§°ã€‚</td>
<td align="left">$server_protocol</td>
<td align="left">è¯·æ±‚ä½¿ç”¨çš„åè®®ï¼Œé€šå¸¸æ˜¯HTTP/1.0æˆ–HTTP/1.1ã€‚</td>
</tr>
<tr>
<td align="left">$http_user_agent</td>
<td align="left">å®¢æˆ·ç«¯agentä¿¡æ¯</td>
<td align="left">$server_addr</td>
<td align="left">æœåŠ¡å™¨åœ°å€ï¼Œåœ¨å®Œæˆä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨åå¯ä»¥ç¡®å®šè¿™ä¸ªå€¼ã€‚</td>
</tr>
<tr>
<td align="left">$http_cookie</td>
<td align="left">å®¢æˆ·ç«¯cookieä¿¡æ¯</td>
<td align="left">$server_name</td>
<td align="left">æœåŠ¡å™¨åç§°ã€‚</td>
</tr>
<tr>
<td align="left">$limit_rate</td>
<td align="left">è¿™ä¸ªå˜é‡å¯ä»¥é™åˆ¶è¿æ¥é€Ÿç‡ã€‚</td>
<td align="left">$server_port</td>
<td align="left">è¯·æ±‚åˆ°è¾¾æœåŠ¡å™¨çš„ç«¯å£å·ã€‚</td>
</tr>
<tr>
<td align="left">$request_method</td>
<td align="left">å®¢æˆ·ç«¯è¯·æ±‚çš„åŠ¨ä½œï¼Œé€šå¸¸ä¸ºGETæˆ–POSTã€‚</td>
<td align="left">$request_uri</td>
<td align="left">åŒ…å«è¯·æ±‚å‚æ•°çš„åŸå§‹URIï¼Œä¸åŒ…å«ä¸»æœºåï¼Œå¦‚ï¼š/foo/bar.php?arg=bazã€‚</td>
</tr>
<tr>
<td align="left">$remote_addr</td>
<td align="left">å®¢æˆ·ç«¯çš„IPåœ°å€ã€‚</td>
<td align="left">$uri</td>
<td align="left">ä¸å¸¦è¯·æ±‚å‚æ•°çš„å½“å‰URIï¼Œ$uriä¸åŒ…å«ä¸»æœºåï¼Œå¦‚/foo/bar.htmlã€‚</td>
</tr>
<tr>
<td align="left">$document_uri</td>
<td align="left">ä¸$uriç›¸åŒã€‚</td>
<td align="left">-</td>
<td align="left">-</td>
</tr>
</tbody></table>
<p>ä¾‹å¦‚è¯·æ±‚ï¼š<code>http://localhost:3000/test1/test2/test.php</code></p>
<p>$hostï¼šlocalhost<br>$server_portï¼š3000<br>$request_uriï¼š/test1/test2/test.php<br>$document_uriï¼š/test1/test2/test.php<br>$document_rootï¼š/var/www/html<br>$request_filenameï¼š/var/www/html/test1/test2/test.php</p>
<h3 id="ç¬¦å·å‚è€ƒ"><a href="#ç¬¦å·å‚è€ƒ" class="headerlink" title="ç¬¦å·å‚è€ƒ"></a>ç¬¦å·å‚è€ƒ</h3><table>
<thead>
<tr>
<th align="left">ç¬¦å·</th>
<th align="left">è¯´æ˜</th>
<th align="left">ç¬¦å·</th>
<th align="left">è¯´æ˜</th>
<th align="left">ç¬¦å·</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">k,K</td>
<td align="left">åƒå­—èŠ‚</td>
<td align="left">m,M</td>
<td align="left">å…†å­—èŠ‚</td>
<td align="left">ms</td>
<td align="left">æ¯«ç§’</td>
</tr>
<tr>
<td align="left">s</td>
<td align="left">ç§’</td>
<td align="left">m</td>
<td align="left">åˆ†é’Ÿ</td>
<td align="left">h</td>
<td align="left">å°æ—¶</td>
</tr>
<tr>
<td align="left">d</td>
<td align="left">æ—¥</td>
<td align="left">w</td>
<td align="left">å‘¨</td>
<td align="left">M</td>
<td align="left">ä¸€ä¸ªæœˆ, 30å¤©</td>
</tr>
</tbody></table>
<p>ä¾‹å¦‚ï¼Œâ€8kâ€ï¼Œâ€1mâ€ ä»£è¡¨å­—èŠ‚æ•°è®¡é‡ã€‚<br>ä¾‹å¦‚ï¼Œâ€1h 30mâ€ï¼Œâ€1y 6Mâ€ã€‚ä»£è¡¨ â€œ1å°æ—¶ 30åˆ†â€ï¼Œâ€1å¹´é›¶6ä¸ªæœˆâ€ã€‚</p>
<h3 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><p>nginx çš„é…ç½®ç³»ç»Ÿç”±ä¸€ä¸ªä¸»é…ç½®æ–‡ä»¶å’Œå…¶ä»–ä¸€äº›è¾…åŠ©çš„é…ç½®æ–‡ä»¶æ„æˆã€‚è¿™äº›é…ç½®æ–‡ä»¶å‡æ˜¯çº¯æ–‡æœ¬æ–‡ä»¶ï¼Œå…¨éƒ¨ä½äº nginx å®‰è£…ç›®å½•ä¸‹çš„ conf ç›®å½•ä¸‹ã€‚</p>
<p>æŒ‡ä»¤ç”± nginx çš„å„ä¸ªæ¨¡å—æä¾›ï¼Œä¸åŒçš„æ¨¡å—ä¼šæä¾›ä¸åŒçš„æŒ‡ä»¤æ¥å®ç°é…ç½®ã€‚<br>æŒ‡ä»¤é™¤äº† Key-Value çš„å½¢å¼ï¼Œè¿˜æœ‰ä½œç”¨åŸŸæŒ‡ä»¤ã€‚</p>
<p>nginx.conf ä¸­çš„é…ç½®ä¿¡æ¯ï¼Œæ ¹æ®å…¶é€»è¾‘ä¸Šçš„æ„ä¹‰ï¼Œå¯¹å®ƒä»¬è¿›è¡Œäº†åˆ†ç±»ï¼Œä¹Ÿå°±æ˜¯åˆ†æˆäº†å¤šä¸ªä½œç”¨åŸŸï¼Œæˆ–è€…ç§°ä¹‹ä¸ºé…ç½®æŒ‡ä»¤ä¸Šä¸‹æ–‡ã€‚ä¸åŒçš„ä½œç”¨åŸŸå«æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªé…ç½®é¡¹ã€‚</p>
<p>ä¸‹é¢çš„è¿™äº›ä¸Šä¸‹æ–‡æŒ‡ä»¤æ˜¯ç”¨çš„æ¯”è¾ƒå¤šï¼š</p>
<table>
<thead>
<tr>
<th align="left">Directive</th>
<th align="left">Description</th>
<th align="left">Contains Directive</th>
</tr>
</thead>
<tbody><tr>
<td align="left">main</td>
<td align="left">nginx åœ¨è¿è¡Œæ—¶ä¸å…·ä½“ä¸šåŠ¡åŠŸèƒ½ï¼ˆæ¯”å¦‚ http æœåŠ¡æˆ–è€… email æœåŠ¡ä»£ç†ï¼‰æ— å…³çš„ä¸€äº›å‚æ•°ï¼Œæ¯”å¦‚å·¥ä½œè¿›ç¨‹æ•°ï¼Œè¿è¡Œçš„èº«ä»½ç­‰ã€‚</td>
<td align="left">user, worker_processes, error_log, events, http, mail</td>
</tr>
<tr>
<td align="left">http</td>
<td align="left">ä¸æä¾› http æœåŠ¡ç›¸å…³çš„ä¸€äº›é…ç½®å‚æ•°ã€‚ä¾‹å¦‚ï¼šæ˜¯å¦ä½¿ç”¨ keepalive å•Šï¼Œæ˜¯å¦ä½¿ç”¨ gzip è¿›è¡Œå‹ç¼©ç­‰ã€‚</td>
<td align="left">server</td>
</tr>
<tr>
<td align="left">server</td>
<td align="left">http æœåŠ¡ä¸Šæ”¯æŒè‹¥å¹²è™šæ‹Ÿä¸»æœºã€‚æ¯ä¸ªè™šæ‹Ÿä¸»æœºä¸€ä¸ªå¯¹åº”çš„ server é…ç½®é¡¹ï¼Œé…ç½®é¡¹é‡Œé¢åŒ…å«è¯¥è™šæ‹Ÿä¸»æœºç›¸å…³çš„é…ç½®ã€‚åœ¨æä¾› mail æœåŠ¡çš„ä»£ç†æ—¶ï¼Œä¹Ÿå¯ä»¥å»ºç«‹è‹¥å¹² server. æ¯ä¸ª server é€šè¿‡ç›‘å¬çš„åœ°å€æ¥åŒºåˆ†ã€‚</td>
<td align="left">listen, server_name, access_log, location, protocol, proxy, smtp_auth, xclient</td>
</tr>
<tr>
<td align="left">location</td>
<td align="left">http æœåŠ¡ä¸­ï¼ŒæŸäº›ç‰¹å®šçš„ URL å¯¹åº”çš„ä¸€ç³»åˆ—é…ç½®é¡¹ã€‚</td>
<td align="left">index, root</td>
</tr>
<tr>
<td align="left">mail</td>
<td align="left">å®ç° email ç›¸å…³çš„ SMTP/IMAP/POP3 ä»£ç†æ—¶ï¼Œå…±äº«çš„ä¸€äº›é…ç½®é¡¹ï¼ˆå› ä¸ºå¯èƒ½å®ç°å¤šä¸ªä»£ç†ï¼Œå·¥ä½œåœ¨å¤šä¸ªç›‘å¬åœ°å€ä¸Šï¼‰ã€‚</td>
<td align="left">server, http, imap_capabilities</td>
</tr>
<tr>
<td align="left">include</td>
<td align="left">ä»¥ä¾¿å¢å¼ºé…ç½®æ–‡ä»¶çš„å¯è¯»æ€§ï¼Œä½¿å¾—éƒ¨åˆ†é…ç½®æ–‡ä»¶å¯ä»¥é‡æ–°ä½¿ç”¨ã€‚</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">valid_referers</td>
<td align="left">ç”¨æ¥æ ¡éªŒHttpè¯·æ±‚å¤´Refereræ˜¯å¦æœ‰æ•ˆã€‚</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">try_files</td>
<td align="left">ç”¨åœ¨serveréƒ¨åˆ†ï¼Œä¸è¿‡æœ€å¸¸è§çš„è¿˜æ˜¯ç”¨åœ¨locationéƒ¨åˆ†ï¼Œå®ƒä¼šæŒ‰ç…§ç»™å®šçš„å‚æ•°é¡ºåºè¿›è¡Œå°è¯•ï¼Œç¬¬ä¸€ä¸ªè¢«åŒ¹é…åˆ°çš„å°†ä¼šè¢«ä½¿ç”¨ã€‚</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">if</td>
<td align="left">å½“åœ¨locationå—ä¸­ä½¿ç”¨ifæŒ‡ä»¤ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹å®ƒå¹¶ä¸æŒ‰ç…§é¢„æœŸè¿è¡Œï¼Œä¸€èˆ¬æ¥è¯´é¿å…ä½¿ç”¨ifæŒ‡ä»¤ã€‚</td>
<td align="left">-</td>
</tr>
</tbody></table>
<p>ä¾‹å¦‚æˆ‘ä»¬å† <strong>nginx.conf</strong> é‡Œé¢å¼•ç”¨ä¸¤ä¸ªé…ç½® vhost/example.com.conf å’Œ vhost/gitlab.com.conf å®ƒä»¬éƒ½è¢«æ”¾åœ¨ä¸€ä¸ªæˆ‘è‡ªå·±æ–°å»ºçš„ç›®å½• vhost ä¸‹é¢ã€‚nginx.conf é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶worker_processes  1;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application&#x2F;octet-stream;</span><br><span class="line"></span><br><span class="line">    #log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span><br><span class="line">    #                  &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span><br><span class="line">    #                  &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;</span><br><span class="line"></span><br><span class="line">    #access_log  logs&#x2F;access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        error_page   500 502 503 504  &#x2F;50x.html;</span><br><span class="line">        location &#x3D; &#x2F;50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    include  vhost&#x2F;example.com.conf;</span><br><span class="line">    include  vhost&#x2F;gitlab.com.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç®€å•çš„é…ç½®: example.com.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶server &#123;</span><br><span class="line">    #ä¾¦å¬çš„80ç«¯å£</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  baidu.com app.baidu.com; # è¿™é‡ŒæŒ‡å®šåŸŸå</span><br><span class="line">    index        index.html index.htm;    # è¿™é‡ŒæŒ‡å®šé»˜è®¤å…¥å£é¡µé¢</span><br><span class="line">    root &#x2F;home&#x2F;www&#x2F;app.baidu.com;         # è¿™é‡ŒæŒ‡å®šç›®å½•</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å†…ç½®é¢„å®šä¹‰å˜é‡"><a href="#å†…ç½®é¢„å®šä¹‰å˜é‡" class="headerlink" title="å†…ç½®é¢„å®šä¹‰å˜é‡"></a>å†…ç½®é¢„å®šä¹‰å˜é‡</h3><p>Nginxæä¾›äº†è®¸å¤šé¢„å®šä¹‰çš„å˜é‡ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä½¿ç”¨setæ¥è®¾ç½®å˜é‡ã€‚ä½ å¯ä»¥åœ¨ifä¸­ä½¿ç”¨é¢„å®šä¹‰å˜é‡ï¼Œä¹Ÿå¯ä»¥å°†å®ƒä»¬ä¼ é€’ç»™ä»£ç†æœåŠ¡å™¨ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„é¢„å®šä¹‰å˜é‡ï¼Œ<a href="http://nginx.org/en/docs/varindex.html" target="_blank" rel="noopener">æ›´å¤šè¯¦è§</a></p>
<table>
<thead>
<tr>
<th align="left">å˜é‡åç§°</th>
<th align="left">å€¼</th>
</tr>
</thead>
<tbody><tr>
<td align="left">$args_name</td>
<td align="left">åœ¨è¯·æ±‚ä¸­çš„nameå‚æ•°</td>
</tr>
<tr>
<td align="left">$args</td>
<td align="left">æ‰€æœ‰è¯·æ±‚å‚æ•°</td>
</tr>
<tr>
<td align="left">$query_string</td>
<td align="left">$argsçš„åˆ«å</td>
</tr>
<tr>
<td align="left">$content_length</td>
<td align="left">è¯·æ±‚å¤´Content-Lengthçš„å€¼</td>
</tr>
<tr>
<td align="left">$content_type</td>
<td align="left">è¯·æ±‚å¤´Content-Typeçš„å€¼</td>
</tr>
<tr>
<td align="left">$host</td>
<td align="left">å¦‚æœå½“å‰æœ‰Hostï¼Œåˆ™ä¸ºè¯·æ±‚å¤´Hostçš„å€¼ï¼›å¦‚æœæ²¡æœ‰è¿™ä¸ªå¤´ï¼Œé‚£ä¹ˆè¯¥å€¼ç­‰äºåŒ¹é…è¯¥è¯·æ±‚çš„server_nameçš„å€¼</td>
</tr>
<tr>
<td align="left">$remote_addr</td>
<td align="left">å®¢æˆ·ç«¯çš„IPåœ°å€</td>
</tr>
<tr>
<td align="left">$request</td>
<td align="left">å®Œæ•´çš„è¯·æ±‚ï¼Œä»å®¢æˆ·ç«¯æ”¶åˆ°ï¼ŒåŒ…æ‹¬Httpè¯·æ±‚æ–¹æ³•ã€URIã€Httpåè®®ã€å¤´ã€è¯·æ±‚ä½“</td>
</tr>
<tr>
<td align="left">$request_uri</td>
<td align="left">å®Œæ•´è¯·æ±‚çš„URIï¼Œä»å®¢æˆ·ç«¯æ¥çš„è¯·æ±‚ï¼ŒåŒ…æ‹¬å‚æ•°</td>
</tr>
<tr>
<td align="left">$scheme</td>
<td align="left">å½“å‰è¯·æ±‚çš„åè®®</td>
</tr>
<tr>
<td align="left">$uri</td>
<td align="left">å½“å‰è¯·æ±‚çš„æ ‡å‡†åŒ–URI</td>
</tr>
</tbody></table>
<h3 id="åå‘ä»£ç†"><a href="#åå‘ä»£ç†" class="headerlink" title="åå‘ä»£ç†"></a>åå‘ä»£ç†</h3><p>åå‘ä»£ç†æ˜¯ä¸€ä¸ªWebæœåŠ¡å™¨ï¼Œå®ƒæ¥å—å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ï¼Œç„¶åå°†è¯·æ±‚è½¬å‘ç»™ä¸Šæ¸¸æœåŠ¡å™¨ï¼Œå¹¶å°†ä»æœåŠ¡å™¨å¾—åˆ°çš„ç»“æœè¿”å›ç»™è¿æ¥çš„å®¢æˆ·ç«¯ã€‚ä¸‹é¢ç®€å•çš„åå‘ä»£ç†çš„ä¾‹å­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶server &#123;  </span><br><span class="line">  listen       80;                                                        </span><br><span class="line">  server_name  localhost;                                              </span><br><span class="line">  client_max_body_size 1024M;  # å…è®¸å®¢æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å•æ–‡ä»¶å­—èŠ‚æ•°</span><br><span class="line"></span><br><span class="line">  location &#x2F; &#123;</span><br><span class="line">    proxy_pass                         http:&#x2F;&#x2F;localhost:8080;</span><br><span class="line">    proxy_set_header Host              $host:$server_port;</span><br><span class="line">    proxy_set_header X-Forwarded-For   $remote_addr; # HTTPçš„è¯·æ±‚ç«¯çœŸå®çš„IP</span><br><span class="line">    proxy_set_header X-Forwarded-Proto $scheme;      # ä¸ºäº†æ­£ç¡®åœ°è¯†åˆ«å®é™…ç”¨æˆ·å‘å‡ºçš„åè®®æ˜¯ http è¿˜æ˜¯ https</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¤æ‚çš„é…ç½®: gitlab.com.confã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶server &#123;</span><br><span class="line">    #ä¾¦å¬çš„80ç«¯å£</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  git.example.cn;</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        proxy_pass   http:&#x2F;&#x2F;localhost:3000;</span><br><span class="line">        #ä»¥ä¸‹æ˜¯ä¸€äº›åå‘ä»£ç†çš„é…ç½®å¯åˆ é™¤</span><br><span class="line">        proxy_redirect             off;</span><br><span class="line">        #åç«¯çš„WebæœåŠ¡å™¨å¯ä»¥é€šè¿‡X-Forwarded-Forè·å–ç”¨æˆ·çœŸå®IP</span><br><span class="line">        proxy_set_header           Host $host;</span><br><span class="line">        client_max_body_size       10m; #å…è®¸å®¢æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å•æ–‡ä»¶å­—èŠ‚æ•°</span><br><span class="line">        client_body_buffer_size    128k; #ç¼“å†²åŒºä»£ç†ç¼“å†²ç”¨æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å­—èŠ‚æ•°</span><br><span class="line">        proxy_connect_timeout      300; #nginxè·Ÿåç«¯æœåŠ¡å™¨è¿æ¥è¶…æ—¶æ—¶é—´(ä»£ç†è¿æ¥è¶…æ—¶)</span><br><span class="line">        proxy_send_timeout         300; #åç«¯æœåŠ¡å™¨æ•°æ®å›ä¼ æ—¶é—´(ä»£ç†å‘é€è¶…æ—¶)</span><br><span class="line">        proxy_read_timeout         300; #è¿æ¥æˆåŠŸåï¼Œåç«¯æœåŠ¡å™¨å“åº”æ—¶é—´(ä»£ç†æ¥æ”¶è¶…æ—¶)</span><br><span class="line">        proxy_buffer_size          4k; #è®¾ç½®ä»£ç†æœåŠ¡å™¨ï¼ˆnginxï¼‰ä¿å­˜ç”¨æˆ·å¤´ä¿¡æ¯çš„ç¼“å†²åŒºå¤§å°</span><br><span class="line">        proxy_buffers              4 32k; #proxy_buffersç¼“å†²åŒºï¼Œç½‘é¡µå¹³å‡åœ¨32kä»¥ä¸‹çš„è¯ï¼Œè¿™æ ·è®¾ç½®</span><br><span class="line">        proxy_busy_buffers_size    64k; #é«˜è´Ÿè·ä¸‹ç¼“å†²å¤§å°ï¼ˆproxy_buffers*2ï¼‰</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»£ç†åˆ°ä¸Šæ¸¸æœåŠ¡å™¨çš„é…ç½®ä¸­ï¼Œæœ€é‡è¦çš„æ˜¯proxy_passæŒ‡ä»¤ã€‚ä»¥ä¸‹æ˜¯ä»£ç†æ¨¡å—ä¸­çš„ä¸€äº›å¸¸ç”¨æŒ‡ä»¤ï¼š</p>
<table>
<thead>
<tr>
<th align="left">æŒ‡ä»¤</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">proxy_connect_timeout</td>
<td align="left">Nginxä»æ¥å—è¯·æ±‚è‡³è¿æ¥åˆ°ä¸Šæ¸¸æœåŠ¡å™¨çš„æœ€é•¿ç­‰å¾…æ—¶é—´</td>
</tr>
<tr>
<td align="left">proxy_send_timeout</td>
<td align="left">åç«¯æœåŠ¡å™¨æ•°æ®å›ä¼ æ—¶é—´(ä»£ç†å‘é€è¶…æ—¶)</td>
</tr>
<tr>
<td align="left">proxy_read_timeout</td>
<td align="left">è¿æ¥æˆåŠŸåï¼Œåç«¯æœåŠ¡å™¨å“åº”æ—¶é—´(ä»£ç†æ¥æ”¶è¶…æ—¶)</td>
</tr>
<tr>
<td align="left">proxy_cookie_domain</td>
<td align="left">æ›¿ä»£ä»ä¸Šæ¸¸æœåŠ¡å™¨æ¥çš„Set-Cookieå¤´çš„domainå±æ€§</td>
</tr>
<tr>
<td align="left">proxy_cookie_path</td>
<td align="left">æ›¿ä»£ä»ä¸Šæ¸¸æœåŠ¡å™¨æ¥çš„Set-Cookieå¤´çš„pathå±æ€§</td>
</tr>
<tr>
<td align="left">proxy_buffer_size</td>
<td align="left">è®¾ç½®ä»£ç†æœåŠ¡å™¨ï¼ˆnginxï¼‰ä¿å­˜ç”¨æˆ·å¤´ä¿¡æ¯çš„ç¼“å†²åŒºå¤§å°</td>
</tr>
<tr>
<td align="left">proxy_buffers</td>
<td align="left">proxy_buffersç¼“å†²åŒºï¼Œç½‘é¡µå¹³å‡åœ¨å¤šå°‘kä»¥ä¸‹</td>
</tr>
<tr>
<td align="left">proxy_set_header</td>
<td align="left">é‡å†™å‘é€åˆ°ä¸Šæ¸¸æœåŠ¡å™¨å¤´çš„å†…å®¹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å°†æŸä¸ªå¤´éƒ¨çš„å€¼è®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œè€Œä¸å‘é€æŸä¸ªå¤´éƒ¨çš„æ–¹æ³•å®ç°</td>
</tr>
<tr>
<td align="left">proxy_ignore_headers</td>
<td align="left">è¿™ä¸ªæŒ‡ä»¤ç¦æ­¢å¤„ç†æ¥è‡ªä»£ç†æœåŠ¡å™¨çš„åº”ç­”ã€‚</td>
</tr>
<tr>
<td align="left">proxy_intercept_errors</td>
<td align="left">ä½¿nginxé˜»æ­¢HTTPåº”ç­”ä»£ç ä¸º400æˆ–è€…æ›´é«˜çš„åº”ç­”ã€‚</td>
</tr>
</tbody></table>
<h3 id="è´Ÿè½½å‡è¡¡"><a href="#è´Ÿè½½å‡è¡¡" class="headerlink" title="è´Ÿè½½å‡è¡¡"></a>è´Ÿè½½å‡è¡¡</h3><p>upstreamæŒ‡ä»¤å¯ç”¨ä¸€ä¸ªæ–°çš„é…ç½®åŒºæ®µï¼Œåœ¨è¯¥åŒºæ®µå®šä¹‰ä¸€ç»„ä¸Šæ¸¸æœåŠ¡å™¨ã€‚è¿™äº›æœåŠ¡å™¨å¯èƒ½è¢«è®¾ç½®ä¸åŒçš„æƒé‡ï¼Œä¹Ÿå¯èƒ½å‡ºäºå¯¹æœåŠ¡å™¨è¿›è¡Œç»´æŠ¤ï¼Œæ ‡è®°ä¸ºdownã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶upstream gitlab &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    # upstreamçš„è´Ÿè½½å‡è¡¡ï¼Œweightæ˜¯æƒé‡ï¼Œå¯ä»¥æ ¹æ®æœºå™¨é…ç½®å®šä¹‰æƒé‡ã€‚weigthå‚æ•°è¡¨ç¤ºæƒå€¼ï¼Œæƒå€¼è¶Šé«˜è¢«åˆ†é…åˆ°çš„å‡ ç‡è¶Šå¤§ã€‚</span><br><span class="line">    server 192.168.122.11:8081 ;</span><br><span class="line">    server 127.0.0.1:82 weight&#x3D;3;</span><br><span class="line">    server 127.0.0.1:83 weight&#x3D;3 down;</span><br><span class="line">    server 127.0.0.1:84 weight&#x3D;3; max_fails&#x3D;3  fail_timeout&#x3D;20s;</span><br><span class="line">    server 127.0.0.1:85 weight&#x3D;4;;</span><br><span class="line">    keepalive 32;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    #ä¾¦å¬çš„80ç«¯å£</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  git.example.cn;</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        proxy_pass   http:&#x2F;&#x2F;gitlab;    #åœ¨è¿™é‡Œè®¾ç½®ä¸€ä¸ªä»£ç†ï¼Œå’Œupstreamçš„åå­—ä¸€æ ·</span><br><span class="line">        #ä»¥ä¸‹æ˜¯ä¸€äº›åå‘ä»£ç†çš„é…ç½®å¯åˆ é™¤</span><br><span class="line">        proxy_redirect             off;</span><br><span class="line">        #åç«¯çš„WebæœåŠ¡å™¨å¯ä»¥é€šè¿‡X-Forwarded-Forè·å–ç”¨æˆ·çœŸå®IP</span><br><span class="line">        proxy_set_header           Host $host;</span><br><span class="line">        proxy_set_header           X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header           X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        client_max_body_size       10m;  #å…è®¸å®¢æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å•æ–‡ä»¶å­—èŠ‚æ•°</span><br><span class="line">        client_body_buffer_size    128k; #ç¼“å†²åŒºä»£ç†ç¼“å†²ç”¨æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å­—èŠ‚æ•°</span><br><span class="line">        proxy_connect_timeout      300;  #nginxè·Ÿåç«¯æœåŠ¡å™¨è¿æ¥è¶…æ—¶æ—¶é—´(ä»£ç†è¿æ¥è¶…æ—¶)</span><br><span class="line">        proxy_send_timeout         300;  #åç«¯æœåŠ¡å™¨æ•°æ®å›ä¼ æ—¶é—´(ä»£ç†å‘é€è¶…æ—¶)</span><br><span class="line">        proxy_read_timeout         300;  #è¿æ¥æˆåŠŸåï¼Œåç«¯æœåŠ¡å™¨å“åº”æ—¶é—´(ä»£ç†æ¥æ”¶è¶…æ—¶)</span><br><span class="line">        proxy_buffer_size          4k; #è®¾ç½®ä»£ç†æœåŠ¡å™¨ï¼ˆnginxï¼‰ä¿å­˜ç”¨æˆ·å¤´ä¿¡æ¯çš„ç¼“å†²åŒºå¤§å°</span><br><span class="line">        proxy_buffers              4 32k;# ç¼“å†²åŒºï¼Œç½‘é¡µå¹³å‡åœ¨32kä»¥ä¸‹çš„è¯ï¼Œè¿™æ ·è®¾ç½®</span><br><span class="line">        proxy_busy_buffers_size    64k; #é«˜è´Ÿè·ä¸‹ç¼“å†²å¤§å°ï¼ˆproxy_buffers*2ï¼‰</span><br><span class="line">        proxy_temp_file_write_size 64k; #è®¾å®šç¼“å­˜æ–‡ä»¶å¤¹å¤§å°ï¼Œå¤§äºè¿™ä¸ªå€¼ï¼Œå°†ä»upstreamæœåŠ¡å™¨ä¼ </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¯ä¸ªè¯·æ±‚æŒ‰æ—¶é—´é¡ºåºé€ä¸€åˆ†é…åˆ°ä¸åŒçš„åç«¯æœåŠ¡å™¨ï¼Œå¦‚æœåç«¯æœåŠ¡å™¨downæ‰ï¼Œèƒ½è‡ªåŠ¨å‰”é™¤ã€‚</p>
<p><strong>è´Ÿè½½å‡è¡¡ï¼š</strong></p>
<p>upstreamæ¨¡å—èƒ½å¤Ÿä½¿ç”¨3ç§è´Ÿè½½å‡è¡¡ç®—æ³•ï¼šè½®è¯¢ã€IPå“ˆå¸Œã€æœ€å°‘è¿æ¥æ•°ã€‚</p>
<p><strong>è½®è¯¢ï¼š</strong> é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨è½®è¯¢ç®—æ³•ï¼Œä¸éœ€è¦é…ç½®æŒ‡ä»¤æ¥æ¿€æ´»å®ƒï¼Œå®ƒæ˜¯åŸºäºåœ¨é˜Ÿåˆ—ä¸­è°æ˜¯ä¸‹ä¸€ä¸ªçš„åŸç†ç¡®ä¿è®¿é—®å‡åŒ€åœ°åˆ†å¸ƒåˆ°æ¯ä¸ªä¸Šæ¸¸æœåŠ¡å™¨ï¼›<br><strong>IPå“ˆå¸Œï¼š</strong> é€šè¿‡ip_hashæŒ‡ä»¤æ¥æ¿€æ´»ï¼ŒNginxé€šè¿‡IPv4åœ°å€çš„å‰3ä¸ªå­—èŠ‚æˆ–è€…æ•´ä¸ªIPv6åœ°å€ä½œä¸ºå“ˆå¸Œé”®æ¥å®ç°ï¼ŒåŒä¸€ä¸ªIPåœ°å€æ€»æ˜¯èƒ½è¢«æ˜ å°„åˆ°åŒä¸€ä¸ªä¸Šæ¸¸æœåŠ¡å™¨ï¼›<br><strong>æœ€å°‘è¿æ¥æ•°ï¼š</strong> é€šè¿‡least_connæŒ‡ä»¤æ¥æ¿€æ´»ï¼Œè¯¥ç®—æ³•é€šè¿‡é€‰æ‹©ä¸€ä¸ªæ´»è·ƒæ•°æœ€å°‘çš„ä¸Šæ¸¸æœåŠ¡å™¨è¿›è¡Œè¿æ¥ã€‚å¦‚æœä¸Šæ¸¸æœåŠ¡å™¨å¤„ç†èƒ½åŠ›ä¸åŒï¼Œå¯ä»¥é€šè¿‡ç»™serveré…ç½®weightæƒé‡æ¥è¯´æ˜ï¼Œè¯¥ç®—æ³•å°†è€ƒè™‘åˆ°ä¸åŒæœåŠ¡å™¨çš„åŠ æƒæœ€å°‘è¿æ¥æ•°ã€‚</p>
<h4 id="RR"><a href="#RR" class="headerlink" title="RR"></a>RR</h4><p><strong>ç®€å•é…ç½®</strong> ï¼Œè¿™é‡Œæˆ‘é…ç½®äº†2å°æœåŠ¡å™¨ï¼Œå½“ç„¶å®é™…ä¸Šæ˜¯ä¸€å°ï¼Œåªæ˜¯ç«¯å£ä¸ä¸€æ ·è€Œå·²ï¼Œè€Œ8081çš„æœåŠ¡å™¨æ˜¯ä¸å­˜åœ¨çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è®¿é—®ä¸åˆ°ï¼Œä½†æ˜¯æˆ‘ä»¬è®¿é—® <code>http://localhost</code> çš„æ—¶å€™ï¼Œä¹Ÿä¸ä¼šæœ‰é—®é¢˜ï¼Œä¼šé»˜è®¤è·³è½¬åˆ°<code>http://localhost:8080</code>å…·ä½“æ˜¯å› ä¸ºNginxä¼šè‡ªåŠ¨åˆ¤æ–­æœåŠ¡å™¨çš„çŠ¶æ€ï¼Œå¦‚æœæœåŠ¡å™¨å¤„äºä¸èƒ½è®¿é—®ï¼ˆæœåŠ¡å™¨æŒ‚äº†ï¼‰ï¼Œå°±ä¸ä¼šè·³è½¬åˆ°è¿™å°æœåŠ¡å™¨ï¼Œæ‰€ä»¥ä¹Ÿé¿å…äº†ä¸€å°æœåŠ¡å™¨æŒ‚äº†å½±å“ä½¿ç”¨çš„æƒ…å†µï¼Œç”±äºNginxé»˜è®¤æ˜¯RRç­–ç•¥ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦å…¶ä»–æ›´å¤šçš„è®¾ç½®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶upstream test &#123;</span><br><span class="line">    server localhost:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       81;</span><br><span class="line">    server_name  localhost;</span><br><span class="line">    client_max_body_size 1024M;</span><br><span class="line"> </span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;test;</span><br><span class="line">        proxy_set_header Host $host:$server_port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è´Ÿè½½å‡è¡¡çš„æ ¸å¿ƒä»£ç ä¸º</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶upstream test &#123;</span><br><span class="line">    server localhost:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="æƒé‡"><a href="#æƒé‡" class="headerlink" title="æƒé‡"></a>æƒé‡</h4><p>æŒ‡å®šè½®è¯¢å‡ ç‡ï¼Œweightå’Œè®¿é—®æ¯”ç‡æˆæ­£æ¯”ï¼Œç”¨äºåç«¯æœåŠ¡å™¨æ€§èƒ½ä¸å‡çš„æƒ…å†µã€‚ ä¾‹å¦‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶upstream test &#123;</span><br><span class="line">    server localhost:8080 weight&#x3D;9;</span><br><span class="line">    server localhost:8081 weight&#x3D;1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆ10æ¬¡ä¸€èˆ¬åªä¼šæœ‰1æ¬¡ä¼šè®¿é—®åˆ°8081ï¼Œè€Œæœ‰9æ¬¡ä¼šè®¿é—®åˆ°8080</p>
<h4 id="ip-hash"><a href="#ip-hash" class="headerlink" title="ip_hash"></a>ip_hash</h4><p>ä¸Šé¢çš„2ç§æ–¹å¼éƒ½æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯ä¸‹ä¸€ä¸ªè¯·æ±‚æ¥çš„æ—¶å€™è¯·æ±‚å¯èƒ½åˆ†å‘åˆ°å¦å¤–ä¸€ä¸ªæœåŠ¡å™¨ï¼Œå½“æˆ‘ä»¬çš„ç¨‹åºä¸æ˜¯æ— çŠ¶æ€çš„æ—¶å€™ï¼ˆé‡‡ç”¨äº†sessionä¿å­˜æ•°æ®ï¼‰ï¼Œè¿™æ—¶å€™å°±æœ‰ä¸€ä¸ªå¾ˆå¤§çš„å¾ˆé—®é¢˜äº†ï¼Œæ¯”å¦‚æŠŠç™»å½•ä¿¡æ¯ä¿å­˜åˆ°äº†sessionä¸­ï¼Œé‚£ä¹ˆè·³è½¬åˆ°å¦å¤–ä¸€å°æœåŠ¡å™¨çš„æ—¶å€™å°±éœ€è¦é‡æ–°ç™»å½•äº†ï¼Œæ‰€ä»¥å¾ˆå¤šæ—¶å€™æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå®¢æˆ·åªè®¿é—®ä¸€ä¸ªæœåŠ¡å™¨ï¼Œé‚£ä¹ˆå°±éœ€è¦ç”¨iphashäº†ï¼Œiphashçš„æ¯ä¸ªè¯·æ±‚æŒ‰è®¿é—®ipçš„hashç»“æœåˆ†é…ï¼Œè¿™æ ·æ¯ä¸ªè®¿å®¢å›ºå®šè®¿é—®ä¸€ä¸ªåç«¯æœåŠ¡å™¨ï¼Œå¯ä»¥è§£å†³sessionçš„é—®é¢˜ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶upstream test &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    server localhost:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="fair"><a href="#fair" class="headerlink" title="fair"></a>fair</h4><p>è¿™æ˜¯ä¸ªç¬¬ä¸‰æ–¹æ¨¡å—ï¼ŒæŒ‰åç«¯æœåŠ¡å™¨çš„å“åº”æ—¶é—´æ¥åˆ†é…è¯·æ±‚ï¼Œå“åº”æ—¶é—´çŸ­çš„ä¼˜å…ˆåˆ†é…ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶upstream backend &#123;</span><br><span class="line">    fair;</span><br><span class="line">    server localhost:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="url-hash"><a href="#url-hash" class="headerlink" title="url_hash"></a>url_hash</h4><p>è¿™æ˜¯ä¸ªç¬¬ä¸‰æ–¹æ¨¡å—ï¼ŒæŒ‰è®¿é—®urlçš„hashç»“æœæ¥åˆ†é…è¯·æ±‚ï¼Œä½¿æ¯ä¸ªurlå®šå‘åˆ°åŒä¸€ä¸ªåç«¯æœåŠ¡å™¨ï¼Œåç«¯æœåŠ¡å™¨ä¸ºç¼“å­˜æ—¶æ¯”è¾ƒæœ‰æ•ˆã€‚ åœ¨upstreamä¸­åŠ å…¥hashè¯­å¥ï¼Œserverè¯­å¥ä¸­ä¸èƒ½å†™å…¥weightç­‰å…¶ä»–çš„å‚æ•°ï¼Œhash_methodæ˜¯ä½¿ç”¨çš„hashç®—æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶upstream backend &#123;</span><br><span class="line">    hash $request_uri;</span><br><span class="line">    hash_method crc32;</span><br><span class="line">    server localhost:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Š5ç§è´Ÿè½½å‡è¡¡å„è‡ªé€‚ç”¨ä¸åŒæƒ…å†µä¸‹ä½¿ç”¨ï¼Œæ‰€ä»¥å¯ä»¥æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©ä½¿ç”¨å“ªç§ç­–ç•¥æ¨¡å¼ï¼Œä¸è¿‡fairå’Œurl_hashéœ€è¦å®‰è£…ç¬¬ä¸‰æ–¹æ¨¡å—æ‰èƒ½ä½¿ç”¨</p>
<p><strong>serveræŒ‡ä»¤å¯é€‰å‚æ•°ï¼š</strong></p>
<ol>
<li>weightï¼šè®¾ç½®ä¸€ä¸ªæœåŠ¡å™¨çš„è®¿é—®æƒé‡ï¼Œæ•°å€¼è¶Šé«˜ï¼Œæ”¶åˆ°çš„è¯·æ±‚ä¹Ÿè¶Šå¤šï¼›</li>
<li>fail_timeoutï¼šåœ¨è¿™ä¸ªæŒ‡å®šçš„æ—¶é—´å†…æœåŠ¡å™¨å¿…é¡»æä¾›å“åº”ï¼Œå¦‚æœåœ¨è¿™ä¸ªæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°å“åº”ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å°†ä¼šè¢«æ ‡è®°ä¸ºdownçŠ¶æ€ï¼›</li>
<li>max_failsï¼šè®¾ç½®åœ¨fail_timeoutæ—¶é—´ä¹‹å†…å°è¯•å¯¹ä¸€ä¸ªæœåŠ¡å™¨è¿æ¥çš„æœ€å¤§æ¬¡æ•°ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªæ¬¡æ•°ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å°†ä¼šè¢«æ ‡è®°ä¸ºdown;</li>
<li>downï¼šæ ‡è®°ä¸€ä¸ªæœåŠ¡å™¨ä¸å†æ¥å—ä»»ä½•è¯·æ±‚ï¼›</li>
<li>backupï¼šä¸€æ—¦å…¶ä»–æœåŠ¡å™¨å®•æœºï¼Œé‚£ä¹ˆæœ‰è¯¥æ ‡è®°çš„æœºå™¨å°†ä¼šæ¥æ”¶è¯·æ±‚ã€‚</li>
</ol>
<p><strong>keepaliveæŒ‡ä»¤ï¼š</strong></p>
<p>NginxæœåŠ¡å™¨å°†ä¼šä¸ºæ¯ä¸€ä¸ªworkerè¿›è¡Œä¿æŒåŒä¸Šæ¸¸æœåŠ¡å™¨çš„è¿æ¥ã€‚</p>
<h3 id="å±è”½ip"><a href="#å±è”½ip" class="headerlink" title="å±è”½ip"></a>å±è”½ip</h3><p>åœ¨nginxçš„é…ç½®æ–‡ä»¶<code>nginx.conf</code>ä¸­åŠ å…¥å¦‚ä¸‹é…ç½®ï¼Œå¯ä»¥æ”¾åˆ°http, server, location, limit_exceptè¯­å¥å—ï¼Œéœ€è¦æ³¨æ„ç›¸å¯¹è·¯å¾„ï¼Œæœ¬ä¾‹å½“ä¸­<code>nginx.conf</code>ï¼Œ<code>blocksip.conf</code>åœ¨åŒä¸€ä¸ªç›®å½•ä¸­ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶include blockip.conf;</span><br></pre></td></tr></table></figure>

<p>åœ¨blockip.confé‡Œé¢è¾“å…¥å†…å®¹ï¼Œå¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶deny 165.91.122.67;</span><br><span class="line"></span><br><span class="line">deny IP;   # å±è”½å•ä¸ªipè®¿é—®</span><br><span class="line">allow IP;  # å…è®¸å•ä¸ªipè®¿é—®</span><br><span class="line">deny all;  # å±è”½æ‰€æœ‰ipè®¿é—®</span><br><span class="line">allow all; # å…è®¸æ‰€æœ‰ipè®¿é—®</span><br><span class="line">deny 123.0.0.0&#x2F;8   # å±è”½æ•´ä¸ªæ®µå³ä»123.0.0.1åˆ°123.255.255.254è®¿é—®çš„å‘½ä»¤</span><br><span class="line">deny 124.45.0.0&#x2F;16 # å±è”½IPæ®µå³ä»123.45.0.1åˆ°123.45.255.254è®¿é—®çš„å‘½ä»¤</span><br><span class="line">deny 123.45.6.0&#x2F;24 # å±è”½IPæ®µå³ä»123.45.6.1åˆ°123.45.6.254è®¿é—®çš„å‘½ä»¤</span><br><span class="line"></span><br><span class="line"># å¦‚æœä½ æƒ³å®ç°è¿™æ ·çš„åº”ç”¨ï¼Œé™¤äº†å‡ ä¸ªIPå¤–ï¼Œå…¶ä»–å…¨éƒ¨æ‹’ç»</span><br><span class="line">allow 1.1.1.1; </span><br><span class="line">allow 1.1.1.2;</span><br><span class="line">deny all;</span><br></pre></td></tr></table></figure>

<h2 id="ç¬¬ä¸‰æ–¹æ¨¡å—å®‰è£…æ–¹æ³•"><a href="#ç¬¬ä¸‰æ–¹æ¨¡å—å®‰è£…æ–¹æ³•" class="headerlink" title="ç¬¬ä¸‰æ–¹æ¨¡å—å®‰è£…æ–¹æ³•"></a>ç¬¬ä¸‰æ–¹æ¨¡å—å®‰è£…æ–¹æ³•</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶.&#x2F;configure --prefix&#x3D;&#x2F;ä½ çš„å®‰è£…ç›®å½•  --add-module&#x3D;&#x2F;ç¬¬ä¸‰æ–¹æ¨¡å—ç›®å½•</span><br></pre></td></tr></table></figure>

<h2 id="é‡å®šå‘"><a href="#é‡å®šå‘" class="headerlink" title="é‡å®šå‘"></a>é‡å®šå‘</h2><ul>
<li><code>permanent</code> æ°¸ä¹…æ€§é‡å®šå‘ã€‚è¯·æ±‚æ—¥å¿—ä¸­çš„çŠ¶æ€ç ä¸º301</li>
<li><code>redirect</code> ä¸´æ—¶é‡å®šå‘ã€‚è¯·æ±‚æ—¥å¿—ä¸­çš„çŠ¶æ€ç ä¸º302</li>
</ul>
<h3 id="é‡å®šå‘æ•´ä¸ªç½‘ç«™"><a href="#é‡å®šå‘æ•´ä¸ªç½‘ç«™" class="headerlink" title="é‡å®šå‘æ•´ä¸ªç½‘ç«™"></a>é‡å®šå‘æ•´ä¸ªç½‘ç«™</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶server &#123;</span><br><span class="line">    server_name old-site.com</span><br><span class="line">    return 301 $scheme:&#x2F;&#x2F;new-site.com$request_uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="é‡å®šå‘å•é¡µ"><a href="#é‡å®šå‘å•é¡µ" class="headerlink" title="é‡å®šå‘å•é¡µ"></a>é‡å®šå‘å•é¡µ</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶server &#123;</span><br><span class="line">    location &#x3D; &#x2F;oldpage.html &#123;</span><br><span class="line">        return 301 http:&#x2F;&#x2F;example.org&#x2F;newpage.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="é‡å®šå‘æ•´ä¸ªå­è·¯å¾„"><a href="#é‡å®šå‘æ•´ä¸ªå­è·¯å¾„" class="headerlink" title="é‡å®šå‘æ•´ä¸ªå­è·¯å¾„"></a>é‡å®šå‘æ•´ä¸ªå­è·¯å¾„</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶location &#x2F;old-site &#123;</span><br><span class="line">    rewrite ^&#x2F;old-site&#x2F;(.*) http:&#x2F;&#x2F;example.org&#x2F;new-site&#x2F;$1 permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ€§èƒ½"><a href="#æ€§èƒ½" class="headerlink" title="æ€§èƒ½"></a>æ€§èƒ½</h2><h3 id="å†…å®¹ç¼“å­˜"><a href="#å†…å®¹ç¼“å­˜" class="headerlink" title="å†…å®¹ç¼“å­˜"></a>å†…å®¹ç¼“å­˜</h3><p>å…è®¸æµè§ˆå™¨åŸºæœ¬ä¸Šæ°¸ä¹…åœ°ç¼“å­˜é™æ€å†…å®¹ã€‚ Nginxå°†ä¸ºæ‚¨è®¾ç½®Expireså’ŒCache-Controlå¤´ä¿¡æ¯ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶location &#x2F;static &#123;</span><br><span class="line">    root &#x2F;data;</span><br><span class="line">    expires max;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¦æ±‚æµè§ˆå™¨æ°¸è¿œä¸ä¼šç¼“å­˜å“åº”ï¼ˆä¾‹å¦‚ç”¨äºè·Ÿè¸ªè¯·æ±‚ï¼‰ï¼Œè¯·ä½¿ç”¨-1ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶location &#x3D; &#x2F;empty.gif &#123;</span><br><span class="line">    empty_gif;</span><br><span class="line">    expires -1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Gzipå‹ç¼©"><a href="#Gzipå‹ç¼©" class="headerlink" title="Gzipå‹ç¼©"></a>Gzipå‹ç¼©</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶gzip  on;</span><br><span class="line">gzip_buffers 16 8k;</span><br><span class="line">gzip_comp_level 6;</span><br><span class="line">gzip_http_version 1.1;</span><br><span class="line">gzip_min_length 256;</span><br><span class="line">gzip_proxied any;</span><br><span class="line">gzip_vary on;</span><br><span class="line">gzip_types</span><br><span class="line">    text&#x2F;xml application&#x2F;xml application&#x2F;atom+xml application&#x2F;rss+xml application&#x2F;xhtml+xml image&#x2F;svg+xml</span><br><span class="line">    text&#x2F;javascript application&#x2F;javascript application&#x2F;x-javascript</span><br><span class="line">    text&#x2F;x-json application&#x2F;json application&#x2F;x-web-app-manifest+json</span><br><span class="line">    text&#x2F;css text&#x2F;plain text&#x2F;x-component</span><br><span class="line">    font&#x2F;opentype application&#x2F;x-font-ttf application&#x2F;vnd.ms-fontobject</span><br><span class="line">    image&#x2F;x-icon;</span><br><span class="line">gzip_disable  &quot;msie6&quot;;</span><br></pre></td></tr></table></figure>

<h3 id="æ‰“å¼€æ–‡ä»¶ç¼“å­˜"><a href="#æ‰“å¼€æ–‡ä»¶ç¼“å­˜" class="headerlink" title="æ‰“å¼€æ–‡ä»¶ç¼“å­˜"></a>æ‰“å¼€æ–‡ä»¶ç¼“å­˜</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶open_file_cache max&#x3D;1000 inactive&#x3D;20s;</span><br><span class="line">open_file_cache_valid 30s;</span><br><span class="line">open_file_cache_min_uses 2;</span><br><span class="line">open_file_cache_errors on;</span><br></pre></td></tr></table></figure>

<h3 id="SSLç¼“å­˜"><a href="#SSLç¼“å­˜" class="headerlink" title="SSLç¼“å­˜"></a>SSLç¼“å­˜</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶ssl_session_cache shared:SSL:10m;</span><br><span class="line">ssl_session_timeout 10m;</span><br></pre></td></tr></table></figure>

<h3 id="ä¸Šæ¸¸Keepalive"><a href="#ä¸Šæ¸¸Keepalive" class="headerlink" title="ä¸Šæ¸¸Keepalive"></a>ä¸Šæ¸¸Keepalive</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶upstream backend &#123;</span><br><span class="line">    server 127.0.0.1:8080;</span><br><span class="line">    keepalive 32;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    ...</span><br><span class="line">    location &#x2F;api&#x2F; &#123;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;backend;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connection &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç›‘æ§"><a href="#ç›‘æ§" class="headerlink" title="ç›‘æ§"></a>ç›‘æ§</h3><p>ä½¿ç”¨<code>ngxtop</code>å®æ—¶è§£ænginxè®¿é—®æ—¥å¿—ï¼Œå¹¶ä¸”å°†å¤„ç†ç»“æœè¾“å‡ºåˆ°ç»ˆç«¯ï¼ŒåŠŸèƒ½ç±»ä¼¼äºç³»ç»Ÿå‘½ä»¤topã€‚æ‰€æœ‰ç¤ºä¾‹éƒ½è¯»å–nginxé…ç½®æ–‡ä»¶çš„è®¿é—®æ—¥å¿—ä½ç½®å’Œæ ¼å¼ã€‚å¦‚æœè¦æŒ‡å®šè®¿é—®æ—¥å¿—æ–‡ä»¶å’Œ/æˆ–æ—¥å¿—æ ¼å¼ï¼Œè¯·ä½¿ç”¨-få’Œ-aé€‰é¡¹ã€‚</p>
<p>æ³¨æ„ï¼šåœ¨nginxé…ç½®ä¸­<code>/usr/local/nginx/conf/nginx.conf</code>æ—¥å¿—æ–‡ä»¶å¿…é¡»æ˜¯ç»å¯¹è·¯å¾„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶# å®‰è£… ngxtop</span><br><span class="line">pip install ngxtop</span><br><span class="line"></span><br><span class="line"># å®æ—¶çŠ¶æ€</span><br><span class="line">ngxtop</span><br><span class="line"># çŠ¶æ€ä¸º404çš„å‰10ä¸ªè¯·æ±‚çš„è·¯å¾„ï¼š</span><br><span class="line">ngxtop top request_path --filter &#39;status &#x3D;&#x3D; 404&#39;</span><br><span class="line"></span><br><span class="line"># å‘é€æ€»å­—èŠ‚æ•°æœ€å¤šçš„å‰10ä¸ªè¯·æ±‚</span><br><span class="line">ngxtop --order-by &#39;avg(bytes_sent) * count&#39;</span><br><span class="line"></span><br><span class="line"># æ’åå‰åä½çš„IPï¼Œä¾‹å¦‚ï¼Œè°æ”»å‡»ä½ æœ€å¤š</span><br><span class="line">ngxtop --group-by remote_addr</span><br><span class="line"></span><br><span class="line"># æ‰“å°å…·æœ‰4xxæˆ–5xxçŠ¶æ€çš„è¯·æ±‚ï¼Œä»¥åŠstatuså’Œhttp referer</span><br><span class="line">ngxtop -i &#39;status &gt;&#x3D; 400&#39; print request status http_referer</span><br><span class="line"></span><br><span class="line"># ç”±200ä¸ªè¯·æ±‚è·¯å¾„å“åº”å‘é€çš„å¹³å‡æ­£æ–‡å­—èŠ‚ä»¥&#39;foo&#39;å¼€å§‹ï¼š</span><br><span class="line">ngxtop avg bytes_sent --filter &#39;status &#x3D;&#x3D; 200 and request_path.startswith(&quot;foo&quot;)&#39;</span><br><span class="line"></span><br><span class="line"># ä½¿ç”¨â€œcommonâ€æ—¥å¿—æ ¼å¼ä»è¿œç¨‹æœºå™¨åˆ†æapacheè®¿é—®æ—¥å¿—</span><br><span class="line">ssh remote tail -f &#x2F;var&#x2F;log&#x2F;apache2&#x2F;access.log | ngxtop -f common</span><br></pre></td></tr></table></figure>

<h2 id="å¸¸è§ä½¿ç”¨åœºæ™¯"><a href="#å¸¸è§ä½¿ç”¨åœºæ™¯" class="headerlink" title="å¸¸è§ä½¿ç”¨åœºæ™¯"></a>å¸¸è§ä½¿ç”¨åœºæ™¯</h2><h3 id="è·¨åŸŸé—®é¢˜"><a href="#è·¨åŸŸé—®é¢˜" class="headerlink" title="è·¨åŸŸé—®é¢˜"></a>è·¨åŸŸé—®é¢˜</h3><p>åœ¨å·¥ä½œä¸­ï¼Œæœ‰æ—¶å€™ä¼šé‡åˆ°ä¸€äº›æ¥å£ä¸æ”¯æŒè·¨åŸŸï¼Œè¿™æ—¶å€™å¯ä»¥ç®€å•çš„æ·»åŠ add_headersæ¥æ”¯æŒcorsè·¨åŸŸã€‚é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name api.xxx.com;</span><br><span class="line">    </span><br><span class="line">  add_header &#39;Access-Control-Allow-Origin&#39; &#39;*&#39;;</span><br><span class="line">  add_header &#39;Access-Control-Allow-Credentials&#39; &#39;true&#39;;</span><br><span class="line">  add_header &#39;Access-Control-Allow-Methods&#39; &#39;GET,POST,HEAD&#39;;</span><br><span class="line"></span><br><span class="line">  location &#x2F; &#123;</span><br><span class="line">    proxy_pass http:&#x2F;&#x2F;127.0.0.1:3000;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header Host  $http_host;    </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æ›´æ”¹å¤´ä¿¡æ¯ï¼Œè¿˜æœ‰ä¸€ç§ï¼Œä½¿ç”¨ <a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html" target="_blank" rel="noopener">rewrite</a> æŒ‡ä»¤é‡å®šå‘URIæ¥è§£å†³è·¨åŸŸé—®é¢˜ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶upstream test &#123;</span><br><span class="line">  server 127.0.0.1:8080;</span><br><span class="line">  server localhost:8081;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name api.xxx.com;</span><br><span class="line">  location &#x2F; &#123; </span><br><span class="line">    root  html;                   #å»è¯·æ±‚..&#x2F;htmlæ–‡ä»¶å¤¹é‡Œçš„æ–‡ä»¶</span><br><span class="line">    index  index.html index.htm;  #é¦–é¡µå“åº”åœ°å€</span><br><span class="line">  &#125;</span><br><span class="line">  # ç”¨äºæ‹¦æˆªè¯·æ±‚ï¼ŒåŒ¹é…ä»»ä½•ä»¥ &#x2F;api&#x2F;å¼€å¤´çš„åœ°å€ï¼Œ</span><br><span class="line">  # åŒ¹é…ç¬¦åˆä»¥åï¼Œåœæ­¢å¾€ä¸‹æœç´¢æ­£åˆ™ã€‚</span><br><span class="line">  location ^~&#x2F;api&#x2F;&#123; </span><br><span class="line">    # ä»£è¡¨é‡å†™æ‹¦æˆªè¿›æ¥çš„è¯·æ±‚ï¼Œå¹¶ä¸”åªèƒ½å¯¹åŸŸååè¾¹çš„é™¤å»ä¼ é€’çš„å‚æ•°å¤–çš„å­—ç¬¦ä¸²èµ·ä½œç”¨ï¼Œ</span><br><span class="line">    # ä¾‹å¦‚www.a.com&#x2F;proxy&#x2F;api&#x2F;msg?meth&#x3D;1&amp;par&#x3D;2é‡å†™ï¼Œåªå¯¹&#x2F;proxy&#x2F;api&#x2F;msgé‡å†™ã€‚</span><br><span class="line">    # rewriteåé¢çš„å‚æ•°æ˜¯ä¸€ä¸ªç®€å•çš„æ­£åˆ™ ^&#x2F;api&#x2F;(.*)$ï¼Œ</span><br><span class="line">    # $1ä»£è¡¨æ­£åˆ™ä¸­çš„ç¬¬ä¸€ä¸ª()ï¼Œ$2ä»£è¡¨ç¬¬äºŒä¸ª()çš„å€¼ï¼Œä»¥æ­¤ç±»æ¨ã€‚</span><br><span class="line">    rewrite ^&#x2F;api&#x2F;(.*)$ &#x2F;$1 break;</span><br><span class="line">    </span><br><span class="line">    # æŠŠè¯·æ±‚ä»£ç†åˆ°å…¶ä»–ä¸»æœº </span><br><span class="line">    # å…¶ä¸­ http:&#x2F;&#x2F;www.b.com&#x2F; å†™æ³•å’Œ http:&#x2F;&#x2F;www.b.comå†™æ³•çš„åŒºåˆ«å¦‚ä¸‹</span><br><span class="line">    # å¦‚æœä½ çš„è¯·æ±‚åœ°å€æ˜¯ä»– http:&#x2F;&#x2F;server&#x2F;html&#x2F;test.jsp</span><br><span class="line">    # é…ç½®ä¸€ï¼š http:&#x2F;&#x2F;www.b.com&#x2F; åé¢æœ‰â€œ&#x2F;â€ </span><br><span class="line">    #         å°†åå‘ä»£ç†æˆ http:&#x2F;&#x2F;www.b.com&#x2F;html&#x2F;test.jsp è®¿é—®</span><br><span class="line">    # é…ç½®ä¸€ï¼š http:&#x2F;&#x2F;www.b.com åé¢æ²¡æœ‰æœ‰â€œ&#x2F;â€ </span><br><span class="line">    #         å°†åå‘ä»£ç†æˆ http:&#x2F;&#x2F;www.b.com&#x2F;test.jsp è®¿é—®</span><br><span class="line">    proxy_pass http:&#x2F;&#x2F;test;</span><br><span class="line"></span><br><span class="line">    # å¦‚æœ proxy_pass  URL æ˜¯ http:&#x2F;&#x2F;a.xx.com&#x2F;platform&#x2F; è¿™ç§æƒ…å†µ</span><br><span class="line">    # proxy_cookie_pathåº”è¯¥è®¾ç½®æˆ &#x2F;platform&#x2F; &#x2F; (æ³¨æ„ä¸¤ä¸ªæ–œæ ä¹‹é—´æœ‰ç©ºæ ¼)ã€‚</span><br><span class="line">    proxy_cookie_path &#x2F;platfrom&#x2F; &#x2F;;</span><br><span class="line"></span><br><span class="line">    # http:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;docs&#x2F;http&#x2F;ngx_http_proxy_module.html#proxy_pass_header</span><br><span class="line">    # è®¾ç½® Cookie å¤´é€šè¿‡</span><br><span class="line">    proxy_pass_header Set-Cookie;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="è·³è½¬åˆ°å¸¦wwwçš„åŸŸä¸Šé¢"><a href="#è·³è½¬åˆ°å¸¦wwwçš„åŸŸä¸Šé¢" class="headerlink" title="è·³è½¬åˆ°å¸¦wwwçš„åŸŸä¸Šé¢"></a>è·³è½¬åˆ°å¸¦wwwçš„åŸŸä¸Šé¢</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    # é…ç½®æ­£å¸¸çš„å¸¦wwwçš„åŸŸå</span><br><span class="line">    server_name www.wangchujiang.com;</span><br><span class="line">    root &#x2F;home&#x2F;www&#x2F;wabg&#x2F;download;</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        try_files $uri $uri&#x2F; &#x2F;index.html &#x3D;404;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    # è¿™ä¸ªè¦æ”¾åˆ°ä¸‹é¢ï¼Œ</span><br><span class="line">    # å°†ä¸å¸¦wwwçš„ wangchujiang.com æ°¸ä¹…æ€§é‡å®šå‘åˆ°  https:&#x2F;&#x2F;www.wangchujiang.com</span><br><span class="line">    server_name wangchujiang.com;</span><br><span class="line">    rewrite ^(.*) https:&#x2F;&#x2F;www.wangchujiang.com$1 permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ä»£ç†è½¬å‘"><a href="#ä»£ç†è½¬å‘" class="headerlink" title="ä»£ç†è½¬å‘"></a>ä»£ç†è½¬å‘</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶upstream server-api&#123;</span><br><span class="line">    # api ä»£ç†æœåŠ¡åœ°å€</span><br><span class="line">    server 127.0.0.1:3110;    </span><br><span class="line">&#125;</span><br><span class="line">upstream server-resource&#123;</span><br><span class="line">    # é™æ€èµ„æº ä»£ç†æœåŠ¡åœ°å€</span><br><span class="line">    server 127.0.0.1:3120;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       3111;</span><br><span class="line">    server_name  localhost;      # è¿™é‡ŒæŒ‡å®šåŸŸå</span><br><span class="line">    root &#x2F;home&#x2F;www&#x2F;server-statics;</span><br><span class="line">    # åŒ¹é… api è·¯ç”±çš„åå‘ä»£ç†åˆ°APIæœåŠ¡</span><br><span class="line">    location ^~&#x2F;api&#x2F; &#123;</span><br><span class="line">        rewrite ^&#x2F;(.*)$ &#x2F;$1 break;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;server-api;</span><br><span class="line">    &#125;</span><br><span class="line">    # å‡è®¾è¿™é‡ŒéªŒè¯ç ä¹Ÿåœ¨APIæœåŠ¡ä¸­</span><br><span class="line">    location ^~&#x2F;captcha &#123;</span><br><span class="line">        rewrite ^&#x2F;(.*)$ &#x2F;$1 break;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;server-api;</span><br><span class="line">    &#125;</span><br><span class="line">    # å‡è®¾ä½ çš„å›¾ç‰‡èµ„æºå…¨éƒ¨åœ¨å¦å¤–ä¸€ä¸ªæœåŠ¡ä¸Šé¢</span><br><span class="line">    location ^~&#x2F;img&#x2F; &#123;</span><br><span class="line">        rewrite ^&#x2F;(.*)$ &#x2F;$1 break;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;server-resource;</span><br><span class="line">    &#125;</span><br><span class="line">    # è·¯ç”±åœ¨å‰ç«¯ï¼Œåç«¯æ²¡æœ‰çœŸå®è·¯ç”±ï¼Œåœ¨è·¯ç”±ä¸å­˜åœ¨çš„ 404çŠ¶æ€çš„é¡µé¢è¿”å› &#x2F;index.html</span><br><span class="line">    # è¿™ä¸ªæ–¹å¼ä½¿ç”¨åœºæ™¯ï¼Œä½ åœ¨å†™Reactæˆ–è€…Vueé¡¹ç›®çš„æ—¶å€™ï¼Œæ²¡æœ‰çœŸå®è·¯ç”±</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        try_files $uri $uri&#x2F; &#x2F;index.html &#x3D;404;</span><br><span class="line">        #                               ^ ç©ºæ ¼å¾ˆé‡è¦</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç›‘æ§çŠ¶æ€ä¿¡æ¯"><a href="#ç›‘æ§çŠ¶æ€ä¿¡æ¯" class="headerlink" title="ç›‘æ§çŠ¶æ€ä¿¡æ¯"></a>ç›‘æ§çŠ¶æ€ä¿¡æ¯</h3><p>é€šè¿‡ <code>nginx -V</code> æ¥æŸ¥çœ‹æ˜¯å¦æœ‰ <code>with-http_stub_status_module</code> è¯¥æ¨¡å—ã€‚</p>
<blockquote>
<p><code>nginx -V</code> è¿™é‡Œ <code>V</code> æ˜¯å¤§å†™çš„ï¼Œå¦‚æœæ˜¯å°å†™çš„ <code>v</code> å³ <code>nginx -v</code>ï¼Œåˆ™ä¸ä¼šå‡ºç°æœ‰å“ªäº›æ¨¡å—ï¼Œåªä¼šå‡ºç° <code>nginx</code> çš„ç‰ˆæœ¬</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶location &#x2F;nginx_status &#123;</span><br><span class="line">    stub_status on;</span><br><span class="line">    access_log off;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ <a href="http://127.0.0.1/nginx_status" target="_blank" rel="noopener">http://127.0.0.1/nginx_status</a> è®¿é—®å‡ºç°ä¸‹é¢ç»“æœã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶Active connections: 3</span><br><span class="line">server accepts handled requests</span><br><span class="line"> 7 7 5 </span><br><span class="line">Reading: 0 Writing: 1 Waiting: 2</span><br></pre></td></tr></table></figure>

<ol>
<li>ä¸»åŠ¨è¿æ¥(ç¬¬ 1 è¡Œ)</li>
</ol>
<p>å½“å‰ä¸httpå»ºç«‹çš„è¿æ¥æ•°ï¼ŒåŒ…æ‹¬ç­‰å¾…çš„å®¢æˆ·ç«¯è¿æ¥ï¼š3</p>
<ol>
<li>æœåŠ¡å™¨æ¥å—å¤„ç†çš„è¯·æ±‚(ç¬¬ 2~3 è¡Œ)</li>
</ol>
<p>æ¥å—çš„å®¢æˆ·ç«¯è¿æ¥æ€»æ•°ç›®ï¼š7<br>å¤„ç†çš„å®¢æˆ·ç«¯è¿æ¥æ€»æ•°ç›®ï¼š7<br>å®¢æˆ·ç«¯æ€»çš„è¯·æ±‚æ•°ç›®ï¼š5</p>
<ol>
<li>è¯»å–å…¶å®ƒä¿¡(ç¬¬ 4 è¡Œ)</li>
</ol>
<p>å½“å‰ï¼Œnginxè¯»è¯·æ±‚è¿æ¥<br>å½“å‰ï¼Œnginxå†™å“åº”è¿”å›ç»™å®¢æˆ·ç«¯<br>ç›®å‰æœ‰å¤šå°‘ç©ºé—²å®¢æˆ·ç«¯è¯·æ±‚è¿æ¥</p>
<h3 id="ä»£ç†è½¬å‘è¿æ¥æ›¿æ¢"><a href="#ä»£ç†è½¬å‘è¿æ¥æ›¿æ¢" class="headerlink" title="ä»£ç†è½¬å‘è¿æ¥æ›¿æ¢"></a>ä»£ç†è½¬å‘è¿æ¥æ›¿æ¢</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶location ^~&#x2F;api&#x2F;upload &#123;</span><br><span class="line">    rewrite ^&#x2F;(.*)$ &#x2F;wfs&#x2F;v1&#x2F;upload break;</span><br><span class="line">    proxy_pass http:&#x2F;&#x2F;wfs-api;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="sslé…ç½®"><a href="#sslé…ç½®" class="headerlink" title="sslé…ç½®"></a>sslé…ç½®</h3><p>è¶…æ–‡æœ¬ä¼ è¾“å®‰å…¨åè®®ï¼ˆç¼©å†™ï¼šHTTPSï¼Œè‹±è¯­ï¼šHypertext Transfer Protocol Secureï¼‰æ˜¯è¶…æ–‡æœ¬ä¼ è¾“åè®®å’ŒSSL/TLSçš„ç»„åˆï¼Œç”¨ä»¥æä¾›åŠ å¯†é€šè®¯åŠå¯¹ç½‘ç»œæœåŠ¡å™¨èº«ä»½çš„é‰´å®šã€‚HTTPSè¿æ¥ç»å¸¸è¢«ç”¨äºä¸‡ç»´ç½‘ä¸Šçš„äº¤æ˜“æ”¯ä»˜å’Œä¼ä¸šä¿¡æ¯ç³»ç»Ÿä¸­æ•æ„Ÿä¿¡æ¯çš„ä¼ è¾“ã€‚HTTPSä¸åº”ä¸åœ¨RFC 2660ä¸­å®šä¹‰çš„å®‰å…¨è¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼ˆS-HTTPï¼‰ç›¸æ··ã€‚HTTPS ç›®å‰å·²ç»æ˜¯æ‰€æœ‰æ³¨é‡éšç§å’Œå®‰å…¨çš„ç½‘ç«™çš„é¦–é€‰ï¼Œéšç€æŠ€æœ¯çš„ä¸æ–­å‘å±•ï¼ŒHTTPS ç½‘ç«™å·²ä¸å†æ˜¯å¤§å‹ç½‘ç«™çš„ä¸“åˆ©ï¼Œæ‰€æœ‰æ™®é€šçš„ä¸ªäººç«™é•¿å’Œåšå®¢å‡å¯ä»¥è‡ªå·±åŠ¨æ‰‹æ­å»ºä¸€ä¸ªå®‰å…¨çš„åŠ å¯†çš„ç½‘ç«™ã€‚</p>
<p>åˆ›å»ºSSLè¯ä¹¦ï¼Œå¦‚æœä½ è´­ä¹°çš„è¯ä¹¦ï¼Œå°±å¯ä»¥ç›´æ¥ä¸‹è½½</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶sudo mkdir &#x2F;etc&#x2F;nginx&#x2F;ssl</span><br><span class="line"># åˆ›å»ºäº†æœ‰æ•ˆæœŸ100å¹´ï¼ŒåŠ å¯†å¼ºåº¦ä¸ºRSA2048çš„SSLå¯†é’¥keyå’ŒX509è¯ä¹¦æ–‡ä»¶ã€‚</span><br><span class="line">sudo openssl req -x509 -nodes -days 36500 -newkey rsa:2048 -keyout &#x2F;etc&#x2F;nginx&#x2F;ssl&#x2F;nginx.key -out &#x2F;etc&#x2F;nginx&#x2F;ssl&#x2F;nginx.crt</span><br><span class="line"># ä¸Šé¢å‘½ä»¤ï¼Œä¼šæœ‰ä¸‹é¢éœ€è¦å¡«å†™å†…å®¹</span><br><span class="line">Country Name (2 letter code) [AU]:US</span><br><span class="line">State or Province Name (full name) [Some-State]:New York</span><br><span class="line">Locality Name (eg, city) []:New York City</span><br><span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:Bouncy Castles, Inc.</span><br><span class="line">Organizational Unit Name (eg, section) []:Ministry of Water Slides</span><br><span class="line">Common Name (e.g. server FQDN or YOUR name) []:your_domain.com</span><br><span class="line">Email Address []:admin@your_domain.com</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºè‡ªç­¾è¯ä¹¦</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶é¦–å…ˆï¼Œåˆ›å»ºè¯ä¹¦å’Œç§é’¥çš„ç›®å½•</span><br><span class="line"># mkdir -p &#x2F;etc&#x2F;nginx&#x2F;cert</span><br><span class="line"># cd &#x2F;etc&#x2F;nginx&#x2F;cert</span><br><span class="line">åˆ›å»ºæœåŠ¡å™¨ç§é’¥ï¼Œå‘½ä»¤ä¼šè®©ä½ è¾“å…¥ä¸€ä¸ªå£ä»¤ï¼š</span><br><span class="line"># openssl genrsa -des3 -out nginx.key 2048</span><br><span class="line">åˆ›å»ºç­¾åè¯·æ±‚çš„è¯ä¹¦ï¼ˆCSRï¼‰ï¼š</span><br><span class="line"># openssl req -new -key nginx.key -out nginx.csr</span><br><span class="line">åœ¨åŠ è½½SSLæ”¯æŒçš„Nginxå¹¶ä½¿ç”¨ä¸Šè¿°ç§é’¥æ—¶é™¤å»å¿…é¡»çš„å£ä»¤ï¼š</span><br><span class="line"># cp nginx.key nginx.key.org</span><br><span class="line"># openssl rsa -in nginx.key.org -out nginx.key</span><br><span class="line">æœ€åæ ‡è®°è¯ä¹¦ä½¿ç”¨ä¸Šè¿°ç§é’¥å’ŒCSRï¼š</span><br><span class="line"># openssl x509 -req -days 365 -in nginx.csr -signkey nginx.key -out nginx.crt</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹ç›®å‰nginxç¼–è¯‘é€‰é¡¹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶sbin&#x2F;nginx -V</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºä¸‹é¢å†…å®¹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶nginx version: nginx&#x2F;1.7.8</span><br><span class="line">built by gcc 4.4.7 20120313 (Red Hat 4.4.7-4) (GCC)</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx-1.7.8 --with-http_ssl_module --with-http_spdy_module --with-http_stub_status_module --with-pcre</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä¾èµ–çš„æ¨¡å—ä¸å­˜åœ¨ï¼Œå¯ä»¥è¿›å…¥å®‰è£…ç›®å½•ï¼Œè¾“å…¥ä¸‹é¢å‘½ä»¤é‡æ–°ç¼–è¯‘å®‰è£…ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶.&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx --with-http_stub_status_module --with-http_ssl_module</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå®Œæˆä¹‹åè¿˜éœ€è¦<code>make</code> (ä¸ç”¨make install)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶# å¤‡ä»½nginxçš„äºŒè¿›åˆ¶æ–‡ä»¶</span><br><span class="line">cp -rf &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginxã€€ &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx.bak</span><br><span class="line"># è¦†ç›–nginxçš„äºŒè¿›åˆ¶æ–‡ä»¶</span><br><span class="line">cp -rf objs&#x2F;nginx   &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;</span><br></pre></td></tr></table></figure>

<p>HTTPS server</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶server &#123;</span><br><span class="line">    listen       443 ssl;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    ssl_certificate &#x2F;etc&#x2F;nginx&#x2F;ssl&#x2F;nginx.crt;</span><br><span class="line">    ssl_certificate_key &#x2F;etc&#x2F;nginx&#x2F;ssl&#x2F;nginx.key;</span><br><span class="line">    # ç¦æ­¢åœ¨headerä¸­å‡ºç°æœåŠ¡å™¨ç‰ˆæœ¬ï¼Œé˜²æ­¢é»‘å®¢åˆ©ç”¨ç‰ˆæœ¬æ¼æ´æ”»å‡»</span><br><span class="line">    server_tokens off;</span><br><span class="line">    # è®¾ç½®ssl&#x2F;tlsä¼šè¯ç¼“å­˜çš„ç±»å‹å’Œå¤§å°ã€‚å¦‚æœè®¾ç½®äº†è¿™ä¸ªå‚æ•°ä¸€èˆ¬æ˜¯sharedï¼Œbuildinå¯èƒ½ä¼šå‚æ•°å†…å­˜ç¢ç‰‡ï¼Œé»˜è®¤æ˜¯noneï¼Œå’Œoffå·®ä¸å¤šï¼Œåœç”¨ç¼“å­˜ã€‚å¦‚shared:SSL:10mè¡¨ç¤ºæˆ‘æ‰€æœ‰çš„nginxå·¥ä½œè¿›ç¨‹å…±äº«sslä¼šè¯ç¼“å­˜ï¼Œå®˜ç½‘ä»‹ç»è¯´1Må¯ä»¥å­˜æ”¾çº¦4000ä¸ªsessionsã€‚ </span><br><span class="line">    ssl_session_cache    shared:SSL:1m; </span><br><span class="line"></span><br><span class="line">    # å®¢æˆ·ç«¯å¯ä»¥é‡ç”¨ä¼šè¯ç¼“å­˜ä¸­sslå‚æ•°çš„è¿‡æœŸæ—¶é—´ï¼Œå†…ç½‘ç³»ç»Ÿé»˜è®¤5åˆ†é’Ÿå¤ªçŸ­äº†ï¼Œå¯ä»¥è®¾æˆ30må³30åˆ†é’Ÿç”šè‡³4hã€‚</span><br><span class="line">    ssl_session_timeout  5m; </span><br><span class="line"></span><br><span class="line">    # é€‰æ‹©åŠ å¯†å¥—ä»¶ï¼Œä¸åŒçš„æµè§ˆå™¨æ‰€æ”¯æŒçš„å¥—ä»¶ï¼ˆå’Œé¡ºåºï¼‰å¯èƒ½ä¼šä¸åŒã€‚</span><br><span class="line">    # è¿™é‡ŒæŒ‡å®šçš„æ˜¯OpenSSLåº“èƒ½å¤Ÿè¯†åˆ«çš„å†™æ³•ï¼Œä½ å¯ä»¥é€šè¿‡ openssl -v cipher &#39;RC4:HIGH:!aNULL:!MD5&#39;ï¼ˆåé¢æ˜¯ä½ æ‰€æŒ‡å®šçš„å¥—ä»¶åŠ å¯†ç®—æ³•ï¼‰ æ¥çœ‹æ‰€æ”¯æŒç®—æ³•ã€‚</span><br><span class="line">    ssl_ciphers  HIGH:!aNULL:!MD5;</span><br><span class="line"></span><br><span class="line">    # è®¾ç½®åå•†åŠ å¯†ç®—æ³•æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨æˆ‘ä»¬æœåŠ¡ç«¯çš„åŠ å¯†å¥—ä»¶ï¼Œè€Œä¸æ˜¯å®¢æˆ·ç«¯æµè§ˆå™¨çš„åŠ å¯†å¥—ä»¶ã€‚</span><br><span class="line">    ssl_prefer_server_ciphers  on;</span><br><span class="line"></span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        root   html;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å¼ºåˆ¶å°†httpé‡å®šå‘åˆ°https"><a href="#å¼ºåˆ¶å°†httpé‡å®šå‘åˆ°https" class="headerlink" title="å¼ºåˆ¶å°†httpé‡å®šå‘åˆ°https"></a>å¼ºåˆ¶å°†httpé‡å®šå‘åˆ°https</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  example.com;</span><br><span class="line">    rewrite ^ https:&#x2F;&#x2F;$http_host$request_uri? permanent;    # å¼ºåˆ¶å°†httpé‡å®šå‘åˆ°https</span><br><span class="line">    # åœ¨é”™è¯¯é¡µé¢å’Œâ€œæœåŠ¡å™¨â€å“åº”å¤´å­—æ®µä¸­å¯ç”¨æˆ–ç¦ç”¨å‘å°„nginxç‰ˆæœ¬ã€‚ é˜²æ­¢é»‘å®¢åˆ©ç”¨ç‰ˆæœ¬æ¼æ´æ”»å‡»</span><br><span class="line">    server_tokens off;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ä¸¤ä¸ªè™šæ‹Ÿä¸»æœº"><a href="#ä¸¤ä¸ªè™šæ‹Ÿä¸»æœº" class="headerlink" title="ä¸¤ä¸ªè™šæ‹Ÿä¸»æœº"></a>ä¸¤ä¸ªè™šæ‹Ÿä¸»æœº</h3><p>çº¯é™æ€-html æ”¯æŒ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶http &#123;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen          80;</span><br><span class="line">        server_name     www.domain1.com;</span><br><span class="line">        access_log      logs&#x2F;domain1.access.log main;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            index index.html;</span><br><span class="line">            root  &#x2F;var&#x2F;www&#x2F;domain1.com&#x2F;htdocs;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen          80;</span><br><span class="line">        server_name     www.domain2.com;</span><br><span class="line">        access_log      logs&#x2F;domain2.access.log main;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            index index.html;</span><br><span class="line">            root  &#x2F;var&#x2F;www&#x2F;domain2.com&#x2F;htdocs;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="è™šæ‹Ÿä¸»æœºæ ‡å‡†é…ç½®"><a href="#è™šæ‹Ÿä¸»æœºæ ‡å‡†é…ç½®" class="headerlink" title="è™šæ‹Ÿä¸»æœºæ ‡å‡†é…ç½®"></a>è™šæ‹Ÿä¸»æœºæ ‡å‡†é…ç½®</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶http &#123;</span><br><span class="line">  server &#123;</span><br><span class="line">    listen          80 default;</span><br><span class="line">    server_name     _ *;</span><br><span class="line">    access_log      logs&#x2F;default.access.log main;</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">       index index.html;</span><br><span class="line">       root  &#x2F;var&#x2F;www&#x2F;default&#x2F;htdocs;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="çˆ¬è™«è¿‡æ»¤"><a href="#çˆ¬è™«è¿‡æ»¤" class="headerlink" title="çˆ¬è™«è¿‡æ»¤"></a>çˆ¬è™«è¿‡æ»¤</h3><p>æ ¹æ® <code>User-Agent</code> è¿‡æ»¤è¯·æ±‚ï¼Œé€šè¿‡ä¸€ä¸ªç®€å•çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œå°±å¯ä»¥è¿‡æ»¤ä¸ç¬¦åˆè¦æ±‚çš„çˆ¬è™«è¯·æ±‚(åˆçº§çˆ¬è™«)ã€‚</p>
<blockquote>
<p><code>~*</code> è¡¨ç¤ºä¸åŒºåˆ†å¤§å°å†™çš„æ­£åˆ™åŒ¹é…</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶location &#x2F; &#123;</span><br><span class="line">    if ($http_user_agent ~* &quot;python|curl|java|wget|httpclient|okhttp&quot;) &#123;</span><br><span class="line">        return 503;</span><br><span class="line">    &#125;</span><br><span class="line">    # æ­£å¸¸å¤„ç†</span><br><span class="line">    # ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="é˜²ç›—é“¾"><a href="#é˜²ç›—é“¾" class="headerlink" title="é˜²ç›—é“¾"></a>é˜²ç›—é“¾</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶location ~* \.(gif|jpg|png|swf|flv)$ &#123;</span><br><span class="line">   root html</span><br><span class="line">   valid_referers none blocked *.nginxcn.com;</span><br><span class="line">   if ($invalid_referer) &#123;</span><br><span class="line">     rewrite ^&#x2F; www.nginx.cn</span><br><span class="line">     #return 404;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="è™šæ‹Ÿç›®å½•é…ç½®"><a href="#è™šæ‹Ÿç›®å½•é…ç½®" class="headerlink" title="è™šæ‹Ÿç›®å½•é…ç½®"></a>è™šæ‹Ÿç›®å½•é…ç½®</h3><p>aliasæŒ‡å®šçš„ç›®å½•æ˜¯å‡†ç¡®çš„ï¼Œrootæ˜¯æŒ‡å®šç›®å½•çš„ä¸Šçº§ç›®å½•ï¼Œå¹¶ä¸”è¯¥ä¸Šçº§ç›®å½•è¦å«æœ‰locationæŒ‡å®šåç§°çš„åŒåç›®å½•ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶location &#x2F;img&#x2F; &#123;</span><br><span class="line">    alias &#x2F;var&#x2F;www&#x2F;image&#x2F;;</span><br><span class="line">&#125;</span><br><span class="line"># è®¿é—®&#x2F;img&#x2F;ç›®å½•é‡Œé¢çš„æ–‡ä»¶æ—¶ï¼Œningxä¼šè‡ªåŠ¨å»&#x2F;var&#x2F;www&#x2F;image&#x2F;ç›®å½•æ‰¾æ–‡ä»¶</span><br><span class="line">location &#x2F;img&#x2F; &#123;</span><br><span class="line">    root &#x2F;var&#x2F;www&#x2F;image;</span><br><span class="line">&#125;</span><br><span class="line"># è®¿é—®&#x2F;img&#x2F;ç›®å½•ä¸‹çš„æ–‡ä»¶æ—¶ï¼Œnginxä¼šå»&#x2F;var&#x2F;www&#x2F;image&#x2F;img&#x2F;ç›®å½•ä¸‹æ‰¾æ–‡ä»¶ã€‚]</span><br></pre></td></tr></table></figure>

<h3 id="é˜²ç›—å›¾é…ç½®"><a href="#é˜²ç›—å›¾é…ç½®" class="headerlink" title="é˜²ç›—å›¾é…ç½®"></a>é˜²ç›—å›¾é…ç½®</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶location ~ \&#x2F;public\&#x2F;(css|js|img)\&#x2F;.*\.(js|css|gif|jpg|jpeg|png|bmp|swf) &#123;</span><br><span class="line">    valid_referers none blocked *.jslite.io;</span><br><span class="line">    if ($invalid_referer) &#123;</span><br><span class="line">        rewrite ^&#x2F;  http:&#x2F;&#x2F;wangchujiang.com&#x2F;piratesp.png;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å±è”½-gitç­‰æ–‡ä»¶"><a href="#å±è”½-gitç­‰æ–‡ä»¶" class="headerlink" title="å±è”½.gitç­‰æ–‡ä»¶"></a>å±è”½.gitç­‰æ–‡ä»¶</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶location ~ (.git|.gitattributes|.gitignore|.svn) &#123;</span><br><span class="line">    deny all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="åŸŸåè·¯å¾„åŠ ä¸åŠ éœ€è¦éƒ½èƒ½æ­£å¸¸è®¿é—®"><a href="#åŸŸåè·¯å¾„åŠ ä¸åŠ éœ€è¦éƒ½èƒ½æ­£å¸¸è®¿é—®" class="headerlink" title="åŸŸåè·¯å¾„åŠ ä¸åŠ éœ€è¦éƒ½èƒ½æ­£å¸¸è®¿é—®"></a>åŸŸåè·¯å¾„åŠ ä¸åŠ éœ€è¦éƒ½èƒ½æ­£å¸¸è®¿é—®</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶http:&#x2F;&#x2F;wangchujiang.com&#x2F;api&#x2F;index.php?a&#x3D;1&amp;name&#x3D;wcj</span><br><span class="line">                                  ^ æœ‰åç¼€</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;wangchujiang.com&#x2F;api&#x2F;index?a&#x3D;1&amp;name&#x3D;wcj</span><br><span class="line">                                 ^ æ²¡æœ‰åç¼€</span><br></pre></td></tr></table></figure>

<p>nginx rewriteè§„åˆ™å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶rewrite ^&#x2F;(.*)&#x2F;$ &#x2F;index.php?&#x2F;$1 permanent;</span><br><span class="line">if (!-d $request_filename)&#123;</span><br><span class="line">        set $rule_1 1$rule_1;</span><br><span class="line">&#125;</span><br><span class="line">if (!-f $request_filename)&#123;</span><br><span class="line">        set $rule_1 2$rule_1;</span><br><span class="line">&#125;</span><br><span class="line">if ($rule_1 &#x3D; &quot;21&quot;)&#123;</span><br><span class="line">        rewrite ^&#x2F; &#x2F;index.php last;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="é”™è¯¯é—®é¢˜"><a href="#é”™è¯¯é—®é¢˜" class="headerlink" title="é”™è¯¯é—®é¢˜"></a>é”™è¯¯é—®é¢˜</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶The plain HTTP request was sent to HTTPS port</span><br></pre></td></tr></table></figure>

<p>è§£å†³åŠæ³•ï¼Œ<code>fastcgi_param HTTPS $https if_not_empty</code> æ·»åŠ è¿™æ¡è§„åˆ™ï¼Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">å¤åˆ¶server &#123;</span><br><span class="line">    listen 443 ssl; # æ³¨æ„è¿™æ¡è§„åˆ™</span><br><span class="line">    server_name  my.domain.com;</span><br><span class="line">    </span><br><span class="line">    fastcgi_param HTTPS $https if_not_empty;</span><br><span class="line">    fastcgi_param HTTPS on;</span><br><span class="line"></span><br><span class="line">    ssl_certificate &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;your.pem;</span><br><span class="line">    ssl_certificate_key &#x2F;etc&#x2F;ssl&#x2F;private&#x2F;your.key;</span><br><span class="line"></span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        # Your config here...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Nginx-æ¨¡å—"><a href="#Nginx-æ¨¡å—" class="headerlink" title="Nginx æ¨¡å—"></a>Nginx æ¨¡å—</h2><ul>
<li><a href="https://gitlab.com/rbdr/ngx_http_office_hours_filter_module" target="_blank" rel="noopener">Nginx Office Hours</a> ä¸€ä¸ª nginx æ¨¡å—ï¼Œå…è®¸æ‚¨ä»…åœ¨åŠå…¬æ—¶é—´å†…æä¾›è®¿é—®è®¿é—®ç½‘ç«™ã€‚</li>
</ul>
<h2 id="ç²¾å“æ–‡ç« å‚è€ƒ"><a href="#ç²¾å“æ–‡ç« å‚è€ƒ" class="headerlink" title="ç²¾å“æ–‡ç« å‚è€ƒ"></a>ç²¾å“æ–‡ç« å‚è€ƒ</h2><ul>
<li><p><a href="https://my.oschina.net/u/3341316/blog/877206" target="_blank" rel="noopener">è´Ÿè½½å‡è¡¡åŸç†çš„è§£æ</a></p>
</li>
<li><p><a href="http://blog.githuber.cn/posts/73" target="_blank" rel="noopener">Nginxæ³›åŸŸåè§£æï¼Œå®ç°å¤šä¸ªäºŒçº§åŸŸå</a></p>
</li>
<li><p><a href="https://www.nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/" target="_blank" rel="noopener">æ·±å…¥ NGINX: æˆ‘ä»¬å¦‚ä½•è®¾è®¡æ€§èƒ½å’Œæ‰©å±•</a></p>
</li>
<li><p><a href="https://www.nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/" target="_blank" rel="noopener">Inside NGINX: How We Designed for Performance &amp; Scale</a></p>
</li>
<li><p><a href="http://tengine.taobao.org/book/index.html" target="_blank" rel="noopener">Nginxå¼€å‘ä»å…¥é—¨åˆ°ç²¾é€š</a></p>
</li>
<li><p><a href="http://os.51cto.com/art/201703/535326.htm#topx" target="_blank" rel="noopener">Nginxçš„ä¼˜åŒ–ä¸é˜²ç›—é“¾</a></p>
</li>
<li><p><a href="https://segmentfault.com/a/1190000009769143" target="_blank" rel="noopener">å®æˆ˜å¼€å‘ä¸€ä¸ªNginxæ‰©å±• (Nginx Module)</a></p>
</li>
<li><p><a href="https://my.oschina.net/xshuai/blog/917097" target="_blank" rel="noopener">Nginx+Keepalived(åŒæœºçƒ­å¤‡)æ­å»ºé«˜å¯ç”¨è´Ÿè½½å‡è¡¡ç¯å¢ƒ(HA)</a></p>
</li>
<li><p><a href="http://www.huxd.org/articles/2017/07/24/1500890692329.html" target="_blank" rel="noopener">Nginx å¹³æ»‘å‡çº§</a></p>
</li>
<li><p><a href="https://mp.weixin.qq.com/s?__biz=MzIxNzg5ODE0OA==&mid=2247483708&idx=1&sn=90b0b1dccd9c337922a0588245277666&chksm=97f38cf7a08405e1928e0b46d923d630e529e7db8ac7ca2a91310a075986f8bcb2cee5b4953d#rd" target="_blank" rel="noopener">Nginxæœ€æ–°æ¨¡å—â€”ngx_http_mirror_moduleåˆ†æå¯ä»¥åšç‰ˆæœ¬å‘å¸ƒå‰çš„é¢„å…ˆéªŒè¯ï¼Œè¿›è¡Œæµé‡æ”¾å¤§åçš„å‹æµ‹ç­‰ç­‰</a></p>
<p>åŸæ–‡é“¾æ¥<a href="https://www.viayc.com/2019/03/13/Nginx%E9%85%8D%E7%BD%AE%E6%95%99%E7%A8%8B/" target="_blank" rel="noopener">https://www.viayc.com/2019/03/13/Nginx%E9%85%8D%E7%BD%AE%E6%95%99%E7%A8%8B/</a></p>
</li>
</ul>

      
    </div>
    
    
    

    
      <div>
        <div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/images/gongzhonghao.jpg" alt="zhangpengjie wechat" style="width: 200px; max-width: 100%;"/>
    <div>æ¬¢è¿æ‰«æäºŒç»´ç å…¬ä¼—å·ä¸€èµ·æˆé•¿~</div>
</div>

      </div>
    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>è°¢è°¢æ‚¨çš„æ”¯æŒ</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>æ‰“èµ</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/weixin.jpg" alt="zhangpengjie å¾®ä¿¡æ”¯ä»˜"/>
        <p>å¾®ä¿¡æ”¯ä»˜</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/zhifubao.jpg" alt="zhangpengjie æ”¯ä»˜å®"/>
        <p>æ”¯ä»˜å®</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/nginx/" rel="tag"># nginx</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/01/13/%E9%9D%A2%E8%AF%95%E9%A2%98%E4%B8%80/" rel="next" title="é¢è¯•é¢˜ä¸€">
                <i class="fa fa-chevron-left"></i> é¢è¯•é¢˜ä¸€
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/12/15/%E7%94%B7%E4%BA%BA%E5%BF%83%E6%99%BA%E6%88%90%E7%86%9F%E7%9A%84%E4%B9%9D%E5%A4%A7%E8%A1%A8%E7%8E%B0/" rel="prev" title="ç”·äººå¿ƒæ™ºæˆç†Ÿçš„ä¹å¤§è¡¨ç°">
                ç”·äººå¿ƒæ™ºæˆç†Ÿçš„ä¹å¤§è¡¨ç° <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/zpj.jpg"
                alt="zhangpengjie" />
            
              <p class="site-author-name" itemprop="name">zhangpengjie</p>
              <p class="site-description motion-element" itemprop="description">æ„¿ä½ åœ¨ä»»ä½•å›°éš¾é¢å‰éƒ½è¶³å¤Ÿåšå¼º</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">33</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">åˆ†ç±»</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">æ ‡ç­¾</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://cn.bing.com/" title="å¿…åº”" target="_blank">å¿…åº”</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginxé…ç½®æ•™ç¨‹"><span class="nav-number">1.</span> <span class="nav-text">Nginxé…ç½®æ•™ç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#å®‰è£…"><span class="nav-number">1.1.</span> <span class="nav-text">å®‰è£…</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#å®‰è£…ä¾èµ–"><span class="nav-number">1.1.1.</span> <span class="nav-text">å®‰è£…ä¾èµ–</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¸‹è½½"><span class="nav-number">1.1.2.</span> <span class="nav-text">ä¸‹è½½</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç¼–è¯‘å®‰è£…"><span class="nav-number">1.1.3.</span> <span class="nav-text">ç¼–è¯‘å®‰è£…</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nginxæµ‹è¯•"><span class="nav-number">1.1.4.</span> <span class="nav-text">nginxæµ‹è¯•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#è®¾ç½®å…¨å±€nginxå‘½ä»¤"><span class="nav-number">1.1.5.</span> <span class="nav-text">è®¾ç½®å…¨å±€nginxå‘½ä»¤</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mac-å®‰è£…"><span class="nav-number">1.2.</span> <span class="nav-text">Mac å®‰è£…</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#å®‰è£…nginx"><span class="nav-number">1.2.1.</span> <span class="nav-text">å®‰è£…nginx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å¯åŠ¨æœåŠ¡"><span class="nav-number">1.2.2.</span> <span class="nav-text">å¯åŠ¨æœåŠ¡</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å¼€æœºè‡ªå¯åŠ¨"><span class="nav-number">1.3.</span> <span class="nav-text">å¼€æœºè‡ªå¯åŠ¨</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#è¿ç»´"><span class="nav-number">1.4.</span> <span class="nav-text">è¿ç»´</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#æœåŠ¡ç®¡ç†"><span class="nav-number">1.4.1.</span> <span class="nav-text">æœåŠ¡ç®¡ç†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#é‡å¯æœåŠ¡é˜²ç«å¢™æŠ¥é”™è§£å†³"><span class="nav-number">1.4.2.</span> <span class="nav-text">é‡å¯æœåŠ¡é˜²ç«å¢™æŠ¥é”™è§£å†³</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nginxå¸è½½"><span class="nav-number">1.5.</span> <span class="nav-text">nginxå¸è½½</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å‚æ•°è¯´æ˜"><span class="nav-number">1.6.</span> <span class="nav-text">å‚æ•°è¯´æ˜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#é…ç½®"><span class="nav-number">1.7.</span> <span class="nav-text">é…ç½®</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#å¸¸ç”¨æ­£åˆ™"><span class="nav-number">1.7.1.</span> <span class="nav-text">å¸¸ç”¨æ­£åˆ™</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å…¨å±€å˜é‡"><span class="nav-number">1.7.2.</span> <span class="nav-text">å…¨å±€å˜é‡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç¬¦å·å‚è€ƒ"><span class="nav-number">1.7.3.</span> <span class="nav-text">ç¬¦å·å‚è€ƒ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#é…ç½®æ–‡ä»¶"><span class="nav-number">1.7.4.</span> <span class="nav-text">é…ç½®æ–‡ä»¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å†…ç½®é¢„å®šä¹‰å˜é‡"><span class="nav-number">1.7.5.</span> <span class="nav-text">å†…ç½®é¢„å®šä¹‰å˜é‡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åå‘ä»£ç†"><span class="nav-number">1.7.6.</span> <span class="nav-text">åå‘ä»£ç†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#è´Ÿè½½å‡è¡¡"><span class="nav-number">1.7.7.</span> <span class="nav-text">è´Ÿè½½å‡è¡¡</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#RR"><span class="nav-number">1.7.7.1.</span> <span class="nav-text">RR</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#æƒé‡"><span class="nav-number">1.7.7.2.</span> <span class="nav-text">æƒé‡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ip-hash"><span class="nav-number">1.7.7.3.</span> <span class="nav-text">ip_hash</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fair"><span class="nav-number">1.7.7.4.</span> <span class="nav-text">fair</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#url-hash"><span class="nav-number">1.7.7.5.</span> <span class="nav-text">url_hash</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å±è”½ip"><span class="nav-number">1.7.8.</span> <span class="nav-text">å±è”½ip</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç¬¬ä¸‰æ–¹æ¨¡å—å®‰è£…æ–¹æ³•"><span class="nav-number">1.8.</span> <span class="nav-text">ç¬¬ä¸‰æ–¹æ¨¡å—å®‰è£…æ–¹æ³•</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#é‡å®šå‘"><span class="nav-number">1.9.</span> <span class="nav-text">é‡å®šå‘</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#é‡å®šå‘æ•´ä¸ªç½‘ç«™"><span class="nav-number">1.9.1.</span> <span class="nav-text">é‡å®šå‘æ•´ä¸ªç½‘ç«™</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#é‡å®šå‘å•é¡µ"><span class="nav-number">1.9.2.</span> <span class="nav-text">é‡å®šå‘å•é¡µ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#é‡å®šå‘æ•´ä¸ªå­è·¯å¾„"><span class="nav-number">1.9.3.</span> <span class="nav-text">é‡å®šå‘æ•´ä¸ªå­è·¯å¾„</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ€§èƒ½"><span class="nav-number">1.10.</span> <span class="nav-text">æ€§èƒ½</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#å†…å®¹ç¼“å­˜"><span class="nav-number">1.10.1.</span> <span class="nav-text">å†…å®¹ç¼“å­˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Gzipå‹ç¼©"><span class="nav-number">1.10.2.</span> <span class="nav-text">Gzipå‹ç¼©</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ‰“å¼€æ–‡ä»¶ç¼“å­˜"><span class="nav-number">1.10.3.</span> <span class="nav-text">æ‰“å¼€æ–‡ä»¶ç¼“å­˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SSLç¼“å­˜"><span class="nav-number">1.10.4.</span> <span class="nav-text">SSLç¼“å­˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¸Šæ¸¸Keepalive"><span class="nav-number">1.10.5.</span> <span class="nav-text">ä¸Šæ¸¸Keepalive</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç›‘æ§"><span class="nav-number">1.10.6.</span> <span class="nav-text">ç›‘æ§</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å¸¸è§ä½¿ç”¨åœºæ™¯"><span class="nav-number">1.11.</span> <span class="nav-text">å¸¸è§ä½¿ç”¨åœºæ™¯</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#è·¨åŸŸé—®é¢˜"><span class="nav-number">1.11.1.</span> <span class="nav-text">è·¨åŸŸé—®é¢˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#è·³è½¬åˆ°å¸¦wwwçš„åŸŸä¸Šé¢"><span class="nav-number">1.11.2.</span> <span class="nav-text">è·³è½¬åˆ°å¸¦wwwçš„åŸŸä¸Šé¢</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä»£ç†è½¬å‘"><span class="nav-number">1.11.3.</span> <span class="nav-text">ä»£ç†è½¬å‘</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç›‘æ§çŠ¶æ€ä¿¡æ¯"><span class="nav-number">1.11.4.</span> <span class="nav-text">ç›‘æ§çŠ¶æ€ä¿¡æ¯</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä»£ç†è½¬å‘è¿æ¥æ›¿æ¢"><span class="nav-number">1.11.5.</span> <span class="nav-text">ä»£ç†è½¬å‘è¿æ¥æ›¿æ¢</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sslé…ç½®"><span class="nav-number">1.11.6.</span> <span class="nav-text">sslé…ç½®</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å¼ºåˆ¶å°†httpé‡å®šå‘åˆ°https"><span class="nav-number">1.11.7.</span> <span class="nav-text">å¼ºåˆ¶å°†httpé‡å®šå‘åˆ°https</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¸¤ä¸ªè™šæ‹Ÿä¸»æœº"><span class="nav-number">1.11.8.</span> <span class="nav-text">ä¸¤ä¸ªè™šæ‹Ÿä¸»æœº</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#è™šæ‹Ÿä¸»æœºæ ‡å‡†é…ç½®"><span class="nav-number">1.11.9.</span> <span class="nav-text">è™šæ‹Ÿä¸»æœºæ ‡å‡†é…ç½®</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#çˆ¬è™«è¿‡æ»¤"><span class="nav-number">1.11.10.</span> <span class="nav-text">çˆ¬è™«è¿‡æ»¤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#é˜²ç›—é“¾"><span class="nav-number">1.11.11.</span> <span class="nav-text">é˜²ç›—é“¾</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#è™šæ‹Ÿç›®å½•é…ç½®"><span class="nav-number">1.11.12.</span> <span class="nav-text">è™šæ‹Ÿç›®å½•é…ç½®</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#é˜²ç›—å›¾é…ç½®"><span class="nav-number">1.11.13.</span> <span class="nav-text">é˜²ç›—å›¾é…ç½®</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å±è”½-gitç­‰æ–‡ä»¶"><span class="nav-number">1.11.14.</span> <span class="nav-text">å±è”½.gitç­‰æ–‡ä»¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åŸŸåè·¯å¾„åŠ ä¸åŠ éœ€è¦éƒ½èƒ½æ­£å¸¸è®¿é—®"><span class="nav-number">1.11.15.</span> <span class="nav-text">åŸŸåè·¯å¾„åŠ ä¸åŠ éœ€è¦éƒ½èƒ½æ­£å¸¸è®¿é—®</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#é”™è¯¯é—®é¢˜"><span class="nav-number">1.12.</span> <span class="nav-text">é”™è¯¯é—®é¢˜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-æ¨¡å—"><span class="nav-number">1.13.</span> <span class="nav-text">Nginx æ¨¡å—</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç²¾å“æ–‡ç« å‚è€ƒ"><span class="nav-number">1.14.</span> <span class="nav-text">ç²¾å“æ–‡ç« å‚è€ƒ</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhangpengjie</span>

  
</div>


  <div class="powered-by">çˆ±åˆ†äº«çˆ±è‡ªç”±</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'SFffbOWnbxhEhkvt0mSxlD0E-gzGzoHsz',
        appKey: 'gdvigtTA0Ux7TDRUmqRJMoTV',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
