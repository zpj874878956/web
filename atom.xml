<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>zpj</title>
  
  <subtitle>好好学习天天向上</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2021-06-18T09:47:53.000Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>zhangpengjie</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>elk安装</title>
    <link href="http://yoursite.com/2021/06/18/elk%E5%AE%89%E8%A3%85/"/>
    <id>http://yoursite.com/2021/06/18/elk%E5%AE%89%E8%A3%85/</id>
    <published>2021-06-18T09:50:00.813Z</published>
    <updated>2021-06-18T09:47:53.000Z</updated>
    
    <content type="html"><![CDATA[<p>ELK服务部署</p><ol><li>官网下载对应版本的二进制压缩包</li></ol><p>elasticsearch 官网下载地址：<br><a href="https://www.elastic.co/cn/downloads/elasticsearch" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/elasticsearch</a><br>elasticsearch 历史版本下载地址：<br> <a href="https://www.elastic.co/cn/downloads/past-releases#elasticsearch" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/past-releases#elasticsearch</a></p><p>kinbana 官网下载地址：<br><a href="https://www.elastic.co/cn/downloads/kibana" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/kibana</a><br>kinbana 历史版本下载地址：<br><a href="https://www.elastic.co/cn/downloads/past-releases#kibana" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/past-releases#kibana</a></p><p>logstash 官网下载地址：<br><a href="https://www.elastic.co/cn/downloads/logstash" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/logstash</a><br>logstash 历史版本下载地址：<br><a href="https://www.elastic.co/cn/downloads/past-releases" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/past-releases</a></p><ol start="2"><li>解压、准备工作、启动ELK</li></ol><p>elasticsearch.tar.gz文件解压</p><p>tar -zxvf 就可以啦<br>太基础的废话命令就不罗列啦，主要是提几个关键的细节的点<br>比如elasticsearch部署的时候需要注意：</p><ol><li>使用普通用户</li><li>开启max_map_count</li><li>设置对应普通用户limit.conf</li><li>useradd -d /data/es es &amp;&amp;echo es | passwd –stdin es</li><li>echo “vm.max_map_count=655360” &gt;&gt; /etc/sysctl.conf</li><li>echo “es soft nofile 655350” &gt;&gt; /etc/security/limits.conf &amp;&amp; echo “es hard nofile 655350” &gt;&gt; /etc/security/limits.conf<br>sysctl -p 刷新一下另其生效</li></ol><p>然后准备个对应的jdk配置个全局的环境变量：<br>JAVA_HOME=/opt/jdk1.8.0_65<br>PATH=$JAVA_HOME/bin:$PATH<br>CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar<br>追加至系统环境变量文件尾部即可或者普通用户的<br>/etc/profile<br>.bash_profile<br>.bashrc<br>然后给刷新一下环境变量或者exit退出用户重新登录即可刷新<br>登录普通用户记得带上杠表示带着普通用户的环境变量呢 su - es<br>source /etc/profile<br>当我使用elasticsearch-no-jdk-7.9.6.tar.gz版本包时,启动提示要找本地普通用户家目录下面的java<br>例如上面的es用户 elastic为解压包<br>/data/es/elastic/jdk/bin/java<br>配置了全局的环境变量 指定目录的opt jdk java都不行还要去找上面目录的java<br>此时我们可以懒得理他直接根据启动log错误信息解决即可啦<br>使用“小大招”直接软连接射过去就好啦<br>当然前提对应的elastic解压包目录要创建对应的log提示的路劲目录 不然软连接找不到上一层目录无法创建哒<br>mkdir -p /data/es/elastic/jdk/bin/<br>ln -sf /opt/jdk/java/bin/java /data/es/elastic/jdk/bin/</p><p>然后配置改吧改吧修改修改elasticsearch.yml文件<br>cat elasticsearch/config/elasticsearch.yml<br>cluster.name: pengge<br>#bootstrap.mlockall: true<br>thread_pool.search.size: 10<br>thread_pool.search.queue_size: 3000<br>thread_pool.bulk.size: 5<br>thread_pool.bulk.queue_size: 2000<br>thread_pool.index.size: 5<br>thread_pool.index.queue_size: 1500<br>node.name: node-pengge<br>cluster.initial_master_nodes: [“node-pengge”]<br>path.data: /data/es/elastic/data<br>path.logs: /data/elastic/logs<br>network.host: 192.168.108.8<br>http.port: 9200<br>transport.tcp.port: 9300<br>transport.tcp.compress: false<br>discovery.zen.ping.unicast.hosts: [“192.168.108.8”, “192.168.108.9”, “192.168.108.10”]</p><p>然后就可以启动es节点啦，上面实例yml配置文件是配置的三节点集群，多节点集群也是一样的道理逗号添加集群节点ip即可啦，简简单单部署那是十分的轻松啦<br> ./elasticsearch &amp;&gt; esstart.log &amp; &amp;&amp; tail -f esstart.log<br>直接sh或者./启动二进制脚本&amp;&gt;将屏幕标准正确错误输出输出至本地目录的esstart.log命名的启动日志文件内，同时使用tail -f 观察es服务启动情况即可</p><p>下面附上一些基础的es查询语句：<br>命令行get方式查询，pengge为示例索引名称<br>curl 192.168.108.8:9200/_cat/indices<br>curl 192.168.108.8:9200/_cat/health<br>curl 192.168.108.8:9200/_cat/nodes<br>curl 192.168.108.8:9200/_cat/shards<br>curl 192.168.108.8:9200/_cat/allocation<br>curl 192.168.108.8:9200/pengge/_count<br>curl 192.168.108.8:9200/pengge/_search<br>kibana页面方式查询：<br>GET _cat/indices<br>GET _cat/health<br>GET _cat/nodes<br>GET _cat/shards<br>GET _cat/allocation<br>GET /pengge/_count<br>GET /pengge/_search</p><p>删除索引<br>DELETE pengge*<br>删除索引内的指定字段，一定注意删除字段是这个动作参数哦：_update_by_query<br>删除字段：@timestamp<br>POST /pengge/_update_by_query<br>{<br>  “script”: {<br>    “inline”: “ctx._source.remove(‘@timestamp’)”,<br>    “lang”: “painless”<br>  },<br>  “query”: {<br>    “bool”: {<br>      “must”: [<br>        {<br>          “exists”: {<br>            “field”: “@timestamp”<br>          }<br>        }<br>      ]<br>    }<br>  }<br>}</p><p>至此elasticsearch服务就简简单单的启动成功啦</p><p>至于kibana、logstash一样的道理简单解压./启动即可啦<br>不在废话叙述啦<br>简单配置个es 9200读取的节点就可以了如下：<br>[root@zabbix config]# egrep -v “#|^$” kibana.yml<br>server.port: 5601<br>server.host: “192.168.108.143”<br>elasticsearch.hosts: [“<a href="http://192.168.108.9:9200&quot;]">http://192.168.108.9:9200&quot;]</a></p><p>./kibana &amp;&gt; start.log &amp; &amp;&amp; tail -f start.log<br>logstash的话主要就是为了针对log日志文件或者txt csv等源数据文件进行整理汇总切割推送给es从而在kibana展示，细节东西下篇文章进行讲解，本期内容就简简单单写写部署启动完事啦<br>logstash配置的job conf文件可以使用-t参数简单配置的字段语法是否正确如下：<br>[root@zabbix bin]# ./logstash -f job/csv-es-debug.conf -t<br>Sending Logstash logs to /data/kinbana/logstash7.8.1/logstash-7.8.1/logs which is now configured via log4j2.properties<br>[2021-03-09T15:24:03,282][WARN ][logstash.config.source.multilocal] Ignoring the ‘pipelines.yml’ file because modules or command line options are specified<br>[2021-03-09T15:24:05,485][INFO ][org.reflections.Reflections] Reflections took 46 ms to scan 1 urls, producing 21 keys and 41 values<br>Configuration OK<br>[2021-03-09T15:24:06,291][INFO ][logstash.runner          ] Using config.test_and_exit mode. Config Validation Result: OK. Exiting Logstash<br>完事就可以-f指定 &amp; 放入后台进行运行使用可爱的logstash啦~</p><p>原文链接：<a href="https://blog.csdn.net/pengge2/article/details/114533789" target="_blank" rel="noopener">https://blog.csdn.net/pengge2/article/details/114533789</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ELK服务部署&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;官网下载对应版本的二进制压缩包&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;elasticsearch 官网下载地址：&lt;br&gt;&lt;a href=&quot;https://www.elastic.co/cn/downloads/elasticsearch&quot; t
      
    
    </summary>
    
    
      <category term="elk" scheme="http://yoursite.com/categories/elk/"/>
    
    
      <category term="elk" scheme="http://yoursite.com/tags/elk/"/>
    
  </entry>
  
  <entry>
    <title>playbook详解</title>
    <link href="http://yoursite.com/2021/05/14/ansible/Ansible%E4%B8%AD%E7%9A%84playbook%20%E8%AF%A6%E8%A7%A3/"/>
    <id>http://yoursite.com/2021/05/14/ansible/Ansible%E4%B8%AD%E7%9A%84playbook%20%E8%AF%A6%E8%A7%A3/</id>
    <published>2021-05-14T04:50:34.093Z</published>
    <updated>2021-05-14T04:50:34.081Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Ansible-中的-playbook-详解"><a href="#Ansible-中的-playbook-详解" class="headerlink" title="Ansible 中的 playbook 详解"></a><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html" target="_blank" rel="noopener">Ansible 中的 playbook 详解</a></h1><p>目录</p><ul><li>一、playbook<ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#11-playbook是什么" target="_blank" rel="noopener">1.1 playbook是什么</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#12-playbook的语法结构" target="_blank" rel="noopener">1.2 playbook的语法结构</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#13-限定主机范围执行" target="_blank" rel="noopener">1.3 限定主机范围执行</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#14-ansible-palybook的小技巧" target="_blank" rel="noopener">1.4 ansible-palybook的小技巧</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#15-ansible-playbook中的handlers" target="_blank" rel="noopener">1.5 ansible-playbook中的handlers</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#16-使用handlers的注意事项" target="_blank" rel="noopener">1.6 使用handlers的注意事项</a></li></ul></li><li>二、变量<ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#21-playbook中的变量" target="_blank" rel="noopener">2.1 playbook中的变量</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#22-playbook中使用vars代码块定义变量" target="_blank" rel="noopener">2.2 playbook中使用vars代码块定义变量</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#23-使用独立的文件来定义playbook变量" target="_blank" rel="noopener">2.3 使用独立的文件来定义playbook变量</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#24-inventory文件中的变量" target="_blank" rel="noopener">2.4 inventory文件中的变量</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#25-主机变量和组变量" target="_blank" rel="noopener">2.5 主机变量和组变量</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#26-巧用主机变量和组变量" target="_blank" rel="noopener">2.6 巧用主机变量和组变量</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#27-注册变量" target="_blank" rel="noopener">2.7 注册变量</a></li></ul></li><li>三、高阶变量<ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#31-fasts变量信息" target="_blank" rel="noopener">3.1 fasts变量信息</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#32-本地facts变量" target="_blank" rel="noopener">3.2 本地facts变量</a></li></ul></li><li>四、if/when/while流程控制语句<ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#41-when条件判断" target="_blank" rel="noopener">4.1 when条件判断</a></li></ul></li><li>五、任务间的流程控制<ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#51-任务委托" target="_blank" rel="noopener">5.1 任务委托</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#52-任务暂停" target="_blank" rel="noopener">5.2 任务暂停</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#53-交互式提示" target="_blank" rel="noopener">5.3 交互式提示</a></li></ul></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#六、tags标签" target="_blank" rel="noopener">六、tags标签</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#七、block块" target="_blank" rel="noopener">七、Block块</a></li></ul><h3 id="一、playbook"><a href="#一、playbook" class="headerlink" title="一、playbook"></a>一、playbook</h3><h4 id="1-1-playbook是什么"><a href="#1-1-playbook是什么" class="headerlink" title="1.1 playbook是什么"></a>1.1 playbook是什么</h4><p>根本上说playbook和shell脚本没有任何的区别，playbook就像shell一样，也是把一堆的命令组合起来，然后加入对应条件判断等等，在shell脚本中是一条一条的命令，而在playbook中是一个一个的task任务构成，每个task任务可以看做shell中的一条命令；shell脚本一般只是在当前服务器上执行，而playbook则是在不止一个服务器上执行，因此playbook需要在其中指定运行该playbook的服务器名。</p><h4 id="1-2-playbook的语法结构"><a href="#1-2-playbook的语法结构" class="headerlink" title="1.2 playbook的语法结构"></a>1.2 playbook的语法结构</h4><p>playbook使用yml标记语言，这是一种标记语言，这种标记语言在文件的最开始需要使用三个“-”来说明文件开始，然后使用缩进来说明代码块的范围。下面通过一个简易的实例，来说明playbook的语法。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">---</span>      <span class="comment"># 标记文件的开始</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span>   <span class="comment"># 指定该playbook在哪个服务器上执行</span></span><br><span class="line">  <span class="attr">vars:</span>         <span class="comment"># 表示下面是定义的变量，</span></span><br><span class="line">    <span class="attr">http_port:</span> <span class="number">80</span>    <span class="comment"># 变量的形式，key: value，这里http_port是变量名，80是值</span></span><br><span class="line">    <span class="attr">max_clients:</span> <span class="number">200</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span>  <span class="comment"># 指定远程的用户名，这里缩进和vars保持了一致，说明变量的代码块已经结束。</span></span><br><span class="line">  <span class="attr">tasks:</span>  <span class="comment"># 下面构成playbook的tasks，每个task都有 - name: 开始，name指定该任务的名称。</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">at</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span>  <span class="comment"># 指定该任务的名称。</span></span><br><span class="line">    <span class="attr">yum:</span> <span class="string">pkg=httpd</span> <span class="string">state=latest</span>  <span class="comment"># yum说明要是用的模板名称，后面指定对应的参数，这两行结合起来就相当于一个shell命令。</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">write</span> <span class="string">the</span> <span class="string">apache</span> <span class="string">config</span> <span class="string">file</span>      <span class="comment"># 每个task之间可以使用空行来做区分。</span></span><br><span class="line">    <span class="attr">template:</span> <span class="string">src=/srv/httpd.j2</span> <span class="string">dest=/etc/httpd.conf</span></span><br></pre></td></tr></table></figure><p>需要说明的是缩进的意义和python中缩进的意义是一样，是来区分代码块的。</p><p><strong>一个简单的实例：检查MySQL的运行状态</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">   <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">   <span class="attr">gather_facts:</span> <span class="literal">no</span>   <span class="comment"># 不收集对应主机的信息，这样运行会快点。</span></span><br><span class="line">   <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">check</span> <span class="string">the</span> <span class="string">mysql</span> <span class="string">stauts</span></span><br><span class="line">       <span class="attr">service:</span> <span class="string">name=mysqld</span> <span class="string">state=running</span></span><br></pre></td></tr></table></figure><p>运行playbook：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">TASK: [check the mysql stauts] ************************************************</span><br><span class="line">ok: [10.0.102.200]</span><br><span class="line">ok: [10.0.102.162]</span><br><span class="line">ok: [10.0.102.212]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=1    changed=0    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=1    changed=0    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=1    changed=0    unreachable=0    failed=0</span><br></pre></td></tr></table></figure><h4 id="1-3-限定主机范围执行"><a href="#1-3-限定主机范围执行" class="headerlink" title="1.3 限定主机范围执行"></a>1.3 限定主机范围执行</h4><p>虽然playbook中定义了执行的主机，但是有时候我们可能仅想在定义的主机中的部分机器上执行，这时候怎么办？修改playbook中的hosts的范围，但是每次改变主机就修改一次，比较麻烦，我们可以使用–limit参数，指定该playbook在指定的主机上执行。有以下inventory文件，我们想在dbservers上执行上面测试用的playbook内容。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[all]</span><br><span class="line">10.0.102.212</span><br><span class="line">10.0.102.200</span><br><span class="line">10.0.102.162</span><br><span class="line"></span><br><span class="line">[dbservers]</span><br><span class="line">10.0.102.162</span><br></pre></td></tr></table></figure><p><strong>上面测试的playbook中hosts定义all，我们想仅在dbservers上执行。</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml --<span class="built_in">limit</span> dbservers</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">TASK: [check the mysql stauts] ************************************************</span><br><span class="line">ok: [10.0.102.162]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=1    changed=0    unreachable=0    failed=0</span><br></pre></td></tr></table></figure><p><strong>查看当前playbook在哪些主机上执行</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml --list-hosts</span></span><br><span class="line"></span><br><span class="line">playbook: test.yml</span><br><span class="line"></span><br><span class="line">  play              # 1 (all): host count=3</span><br><span class="line">    10.0.102.162</span><br><span class="line">    10.0.102.212</span><br><span class="line">    10.0.102.200</span><br></pre></td></tr></table></figure><h4 id="1-4-ansible-palybook的小技巧"><a href="#1-4-ansible-palybook的小技巧" class="headerlink" title="1.4 ansible-palybook的小技巧"></a>1.4 ansible-palybook的小技巧</h4><ul><li><code>--inventory=path</code>，指定inventory文件，默认是在/etc/ansible/hosts下面。</li><li><code>--verbose</code>，显示详细的输出，使用-vvvv显示精确到每分钟的输出。</li><li><code>--extra-vars=vars</code>：定义在playbook使用的变量。</li><li><code>--forks</code>：指定并发的线程数，默认是5.</li><li><code>--connection=type</code>:指定远程连接主机的方式，默认是ssh，设置为local时，则只在本地执行playbook、</li><li><code>--check</code>:检测模式，playbook中定义的所有任务将在每台主机上检测，但是并不执行。</li></ul><h4 id="1-5-ansible-playbook中的handlers"><a href="#1-5-ansible-playbook中的handlers" class="headerlink" title="1.5 ansible-playbook中的handlers"></a>1.5 ansible-playbook中的handlers</h4><p>在系统中，我们修改了服务器的配置文件，这时候就需要重启操作服务，就可以使用到handlers。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">handlers:</span>             <span class="comment"># 定义两个handlers</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">memcached</span></span><br><span class="line">      <span class="attr">service:</span>  <span class="string">name=memcached</span> <span class="string">state=restarted</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=apache</span> <span class="string">state=restarted</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">template</span> <span class="string">configuration</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">template:</span> <span class="string">src=template.j2</span> <span class="string">dest=/etc/foo.conf</span>  <span class="comment"># 修改了配置文件然后依次启动memcached和apache服务。</span></span><br><span class="line">  <span class="attr">notify:</span>        <span class="comment"># 使用notify来声明引用handlers。</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">restart</span> <span class="string">memcached</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">restart</span> <span class="string">apache</span></span><br></pre></td></tr></table></figure><h4 id="1-6-使用handlers的注意事项"><a href="#1-6-使用handlers的注意事项" class="headerlink" title="1.6 使用handlers的注意事项"></a>1.6 使用handlers的注意事项</h4><ul><li>Handlers只有在其所在的任务被执行时，才会被运行；如果一个任务中定义了notify调用Handlers，但是由于条件判断等原因，该任务未被执行，那么Handlers同样不会被执行。</li><li>Handlers只会在每一个play的末尾运行一次；如果想在一个playbook中间运行Handlers，则需要使用meta模块来实现。例如：<code>-meta: flush_handlers</code>.</li><li>如果一个play在运行到调用Handlers的语句之前失败了，那么这个Handlers将不会被执行。我们可以使用meta模块的<code>--force-handlers</code>选项来强制执行Handlers，即使Handlers所在的play中途运行失败也能执行。</li></ul><h3 id="二、变量"><a href="#二、变量" class="headerlink" title="二、变量"></a>二、变量</h3><p>这个变量我们来说明ansible中变量（不包含role中的变量）用法。</p><h4 id="2-1-playbook中的变量"><a href="#2-1-playbook中的变量" class="headerlink" title="2.1 playbook中的变量"></a>2.1 playbook中的变量</h4><p>在运行playbook的时候使用<code>--extra-vars</code>来指定变量</p><p>有如下playbook脚本：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">   <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">   <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">   <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">playbook</span> <span class="string">variables</span></span><br><span class="line">       <span class="attr">command:</span> <span class="string">echo</span> <span class="string">&#123;&#123;</span> <span class="string">test_var</span> <span class="string">&#125;&#125;</span>   <span class="comment"># 打印出变量test_var的值。</span></span><br></pre></td></tr></table></figure><p>运行playbook：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml --extra-vars <span class="string">"test_var=test"</span> -v    </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 加上-v选项，会显示详细的信息</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">TASK: [test playbook variables] ***********************************************</span><br><span class="line">changed: [10.0.102.212] =&gt; &#123;"changed": true, "cmd": ["echo", "test"], "delta": "0:00:00.006045", "end": "2019-02-15 23:04:49.789452", "rc": 0, "start": "2019-02-15 23:04:49.783407", "stderr": "", "stdout": "test"&#125;</span><br><span class="line">changed: [10.0.102.200] =&gt; &#123;"changed": true, "cmd": ["echo", "test"], "delta": "0:00:00.005318", "end": "2019-02-15 23:04:52.976471", "rc": 0, "start": "2019-02-15 23:04:52.971153", "stderr": "", "stdout": "test"&#125;</span><br><span class="line">changed: [10.0.102.162] =&gt; &#123;"changed": true, "cmd": ["echo", "test"], "delta": "0:00:00.005082", "end": "2019-02-15 23:04:52.424959", "rc": 0, "start": "2019-02-15 23:04:52.419877", "stderr": "", "stdout": "test"&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=1    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=1    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=1    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure><p>上面详细信息的标准输出为test，说明变量的值已经传递了。</p><h4 id="2-2-playbook中使用vars代码块定义变量"><a href="#2-2-playbook中使用vars代码块定义变量" class="headerlink" title="2.2 playbook中使用vars代码块定义变量"></a>2.2 playbook中使用vars代码块定义变量</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">---</span><br><span class="line"> - hosts: all</span><br><span class="line">   remote_user: root</span><br><span class="line">   gather_facts: no</span><br><span class="line">   vars:                  # 在这里使用了vars代码块来定义变量</span><br><span class="line">       test_var: Hello World</span><br><span class="line">   tasks:</span><br><span class="line">     - name: test playbook variables</span><br><span class="line">       command: echo &#123;&#123; test_var &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml  -v</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">TASK: [test playbook variables] ***********************************************</span><br><span class="line">changed: [10.0.102.162] =&gt; &#123;"changed": true, "cmd": ["echo", "Hello", "World"], "delta": "0:00:00.004940", "end": "2019-02-15 23:20:06.541672", "rc": 0, "start": "2019-02-15 23:20:06.536732", "stderr": "", "stdout": "Hello World"&#125;</span><br><span class="line">changed: [10.0.102.212] =&gt; &#123;"changed": true, "cmd": ["echo", "Hello", "World"], "delta": "0:00:00.004843", "end": "2019-02-15 23:20:03.957950", "rc": 0, "start": "2019-02-15 23:20:03.953107", "stderr": "", "stdout": "Hello World"&#125;</span><br><span class="line">changed: [10.0.102.200] =&gt; &#123;"changed": true, "cmd": ["echo", "Hello", "World"], "delta": "0:00:00.004219", "end": "2019-02-15 23:20:07.166900", "rc": 0, "start": "2019-02-15 23:20:07.162681", "stderr": "", "stdout": "Hello World"&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=1    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=1    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=1    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure><h4 id="2-3-使用独立的文件来定义playbook变量"><a href="#2-3-使用独立的文件来定义playbook变量" class="headerlink" title="2.3 使用独立的文件来定义playbook变量"></a>2.3 使用独立的文件来定义playbook变量</h4><p>playbook的内容：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">   <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">   <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">   <span class="attr">vars_files:</span>       <span class="comment"># 这里使用了vars_files来引入变量文件</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">vars.yml</span></span><br><span class="line">   <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">playbook</span> <span class="string">variables</span></span><br><span class="line">       <span class="attr">command:</span> <span class="string">echo</span> <span class="string">&#123;&#123;</span> <span class="string">test_var</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>变量文件的定义：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">vars.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line">  <span class="attr">test_var:</span> <span class="string">Hello</span> <span class="string">World</span></span><br></pre></td></tr></table></figure><p>执行的结果：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml  -v</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">TASK: [test playbook variables] ***********************************************</span><br><span class="line">changed: [10.0.102.212] =&gt; &#123;"changed": true, "cmd": ["echo", "Hello", "World"], "delta": "0:00:00.005198", "end": "2019-02-15 23:23:16.397557", "rc": 0, "start": "2019-02-15 23:23:16.392359", "stderr": "", "stdout": "Hello World"&#125;</span><br><span class="line">changed: [10.0.102.200] =&gt; &#123;"changed": true, "cmd": ["echo", "Hello", "World"], "delta": "0:00:00.004359", "end": "2019-02-15 23:23:19.629804", "rc": 0, "start": "2019-02-15 23:23:19.625445", "stderr": "", "stdout": "Hello World"&#125;</span><br><span class="line">changed: [10.0.102.162] =&gt; &#123;"changed": true, "cmd": ["echo", "Hello", "World"], "delta": "0:00:01.006185", "end": "2019-02-15 23:23:20.039320", "rc": 0, "start": "2019-02-15 23:23:19.033135", "stderr": "", "stdout": "Hello World"&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=1    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=1    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=1    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure><h4 id="2-4-inventory文件中的变量"><a href="#2-4-inventory文件中的变量" class="headerlink" title="2.4 inventory文件中的变量"></a>2.4 inventory文件中的变量</h4><p>在ansible中，inventory文件通常是指ansible的主机和组定义文件hosts。在hosts文件中，变量会被定义在主机名后面或组名的下方。</p><p><strong>为特定的主机定义变量，变量名跟在对应主机的后边。</strong></p><p>inventory文件如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat /etc/ansible/hosts</span></span><br><span class="line">[all]</span><br><span class="line">10.0.102.212 test_var=212</span><br><span class="line">10.0.102.200 test_var=200</span><br><span class="line">10.0.102.162 test_var=162</span><br><span class="line"><span class="meta">#</span><span class="bash"> 为三个主机定义了同名的变量，但是变量值却不一样。</span></span><br></pre></td></tr></table></figure><p>playbook的内容如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">   <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">   <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">   <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">playbook</span> <span class="string">variables</span></span><br><span class="line">       <span class="attr">command:</span> <span class="string">echo</span> <span class="string">&#123;&#123;</span> <span class="string">test_var</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>执行这个playbook，结果如下（对应的主机显示了各自对应的变量值）：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml -v</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">TASK: [test playbook variables] ***********************************************</span><br><span class="line">changed: [10.0.102.212] =&gt; &#123;"changed": true, "cmd": ["echo", "212"], "delta": "0:00:00.004399", "end": "2019-02-15 23:31:20.648111", "rc": 0, "start": "2019-02-15 23:31:20.643712", "stderr": "", "stdout": "212"&#125;</span><br><span class="line">changed: [10.0.102.200] =&gt; &#123;"changed": true, "cmd": ["echo", "200"], "delta": "0:00:00.005932", "end": "2019-02-15 23:31:23.873082", "rc": 0, "start": "2019-02-15 23:31:23.867150", "stderr": "", "stdout": "200"&#125;</span><br><span class="line">changed: [10.0.102.162] =&gt; &#123;"changed": true, "cmd": ["echo", "162"], "delta": "0:00:00.006723", "end": "2019-02-15 23:31:23.287861", "rc": 0, "start": "2019-02-15 23:31:23.281138", "stderr": "", "stdout": "162"&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=1    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=1    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=1    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure><p><strong>给主机组定义变量，作用范围为整个主机组。</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat /etc/ansible/hosts</span></span><br><span class="line">[all]</span><br><span class="line">10.0.102.212</span><br><span class="line">10.0.102.200</span><br><span class="line">10.0.102.162</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[all:vars]                            #给主机组定义变量</span><br><span class="line">test_var=Hello World</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml -v</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">TASK: [test playbook variables] ***********************************************</span><br><span class="line">changed: [10.0.102.212] =&gt; &#123;"changed": true, "cmd": ["echo", "Hello", "World"], "delta": "0:00:00.003923", "end": "2019-02-15 23:37:29.322158", "rc": 0, "start": "2019-02-15 23:37:29.318235", "stderr": "", "stdout": "Hello World"&#125;</span><br><span class="line">changed: [10.0.102.200] =&gt; &#123;"changed": true, "cmd": ["echo", "Hello", "World"], "delta": "0:00:00.004161", "end": "2019-02-15 23:37:32.548947", "rc": 0, "start": "2019-02-15 23:37:32.544786", "stderr": "", "stdout": "Hello World"&#125;</span><br><span class="line">changed: [10.0.102.162] =&gt; &#123;"changed": true, "cmd": ["echo", "Hello", "World"], "delta": "0:00:00.006090", "end": "2019-02-15 23:37:32.005067", "rc": 0, "start": "2019-02-15 23:37:31.998977", "stderr": "", "stdout": "Hello World"&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=1    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=1    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=1    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure><p>回想一下，这种方法定义变量虽然简单直观，但是若是变量特别多的情况下，会怎么样？特别是给对应的主机定义变量，若是变量太多，则管理起来会很不方便的，因此引入了主机变量和组变量。</p><h4 id="2-5-主机变量和组变量"><a href="#2-5-主机变量和组变量" class="headerlink" title="2.5 主机变量和组变量"></a>2.5 主机变量和组变量</h4><p><strong>inventory文件仍然使用上面的文件！</strong></p><p>在执行ansbile命令时，ansible默认会从<code>/etc/ansible/host_vars/</code>和<code>/etc/amsible/group_vars/</code>两个目录下读取变量定义，如果<code>/etc/ansible</code>下面没有这两个目录，可以直接手动创建，并且可以在这两个目录中创建与<code>hosts</code>（这里是指<code>inventory</code>文件）文件中主机名或组名同名的文件来定义变量。</p><p><strong>先来看主机变量</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> tree /etc/ansible/</span></span><br><span class="line">.</span><br><span class="line">├── group_vars</span><br><span class="line">├── hosts</span><br><span class="line">└── host_vars                 # 定义与主机名同名的文件</span><br><span class="line">    ├── 10.0.102.162</span><br><span class="line">    ├── 10.0.102.200</span><br><span class="line">    └── 10.0.102.212</span><br><span class="line"></span><br><span class="line">2 directories, 4 files</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 文件中的内容如下：</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat host_vars/10.0.102.162</span></span><br><span class="line">---</span><br><span class="line">test_var: 162</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat host_vars/10.0.102.200</span></span><br><span class="line">---</span><br><span class="line">  test_var: 200</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat host_vars/10.0.102.212</span></span><br><span class="line">---</span><br><span class="line">  test_var: 212</span><br></pre></td></tr></table></figure><p>playbook的内容如下，执行结果如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">---</span><br><span class="line"> - hosts: all</span><br><span class="line">   remote_user: root</span><br><span class="line">   gather_facts: no</span><br><span class="line">   tasks:</span><br><span class="line">     - name: test playbook variables</span><br><span class="line">       command: echo &#123;&#123; test_var &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml -v</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">TASK: [test playbook variables] ***********************************************</span><br><span class="line">changed: [10.0.102.212] =&gt; &#123;"changed": true, "cmd": ["echo", "212"], "delta": "0:00:00.003767", "end": "2019-02-15 23:55:58.595282", "rc": 0, "start": "2019-02-15 23:55:58.591515", "stderr": "", "stdout": "212"&#125;</span><br><span class="line">changed: [10.0.102.162] =&gt; &#123;"changed": true, "cmd": ["echo", "162"], "delta": "0:00:00.006254", "end": "2019-02-15 23:56:01.235307", "rc": 0, "start": "2019-02-15 23:56:01.229053", "stderr": "", "stdout": "162"&#125;</span><br><span class="line">changed: [10.0.102.200] =&gt; &#123;"changed": true, "cmd": ["echo", "200"], "delta": "0:00:01.004509", "end": "2019-02-15 23:56:02.775410", "rc": 0, "start": "2019-02-15 23:56:01.770901", "stderr": "", "stdout": "200"&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=1    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=1    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=1    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure><p>再来说明一下主机组变量！</p><p>创建与组名同名的文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> tree</span></span><br><span class="line">.</span><br><span class="line">├── group_vars</span><br><span class="line">│   └── all               #创建与组名同名的文件</span><br><span class="line">├── hosts</span><br><span class="line">└── host_vars</span><br><span class="line">    ├── 10.0.102.162</span><br><span class="line">    ├── 10.0.102.200</span><br><span class="line">    └── 10.0.102.212</span><br><span class="line"></span><br><span class="line">2 directories, 5 files</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat group_vars/all</span></span><br><span class="line">---</span><br><span class="line">  test_group_var: from group</span><br></pre></td></tr></table></figure><p>执行结果如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">---</span><br><span class="line"> - hosts: all</span><br><span class="line">   remote_user: root</span><br><span class="line">   gather_facts: no</span><br><span class="line">   tasks:</span><br><span class="line">     - name: test the host variables</span><br><span class="line">       command: echo &#123;&#123; test_var &#125;&#125;</span><br><span class="line"></span><br><span class="line">     - name: test host group variables           #写入测试组变量的task</span><br><span class="line">       command: echo &#123;&#123; test_group_var &#125;&#125;</span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml -v</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">TASK: [test the host variables] ***********************************************</span><br><span class="line">changed: [10.0.102.212] =&gt; &#123;"changed": true, "cmd": ["echo", "212"], "delta": "0:00:00.004613", "end": "2019-02-15 23:59:23.227722", "rc": 0, "start": "2019-02-15 23:59:23.223109", "stderr": "", "stdout": "212"&#125;</span><br><span class="line">changed: [10.0.102.200] =&gt; &#123;"changed": true, "cmd": ["echo", "200"], "delta": "0:00:00.006490", "end": "2019-02-15 23:59:26.422682", "rc": 0, "start": "2019-02-15 23:59:26.416192", "stderr": "", "stdout": "200"&#125;</span><br><span class="line">changed: [10.0.102.162] =&gt; &#123;"changed": true, "cmd": ["echo", "162"], "delta": "0:00:00.004709", "end": "2019-02-15 23:59:25.812786", "rc": 0, "start": "2019-02-15 23:59:25.808077", "stderr": "", "stdout": "162"&#125;</span><br><span class="line"></span><br><span class="line">TASK: [test host group variables] *********************************************</span><br><span class="line">changed: [10.0.102.212] =&gt; &#123;"changed": true, "cmd": ["echo", "from", "group"], "delta": "0:00:00.003759", "end": "2019-02-15 23:59:23.519180", "rc": 0, "start": "2019-02-15 23:59:23.515421", "stderr": "", "stdout": "from group"&#125;</span><br><span class="line">changed: [10.0.102.162] =&gt; &#123;"changed": true, "cmd": ["echo", "from", "group"], "delta": "0:00:00.003748", "end": "2019-02-15 23:59:26.109337", "rc": 0, "start": "2019-02-15 23:59:26.105589", "stderr": "", "stdout": "from group"&#125;</span><br><span class="line">changed: [10.0.102.200] =&gt; &#123;"changed": true, "cmd": ["echo", "from", "group"], "delta": "0:00:00.004339", "end": "2019-02-15 23:59:26.724525", "rc": 0, "start": "2019-02-15 23:59:26.720186", "stderr": "", "stdout": "from group"&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=2    changed=2    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=2    changed=2    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=2    changed=2    unreachable=0    failed=0</span><br></pre></td></tr></table></figure><h4 id="2-6-巧用主机变量和组变量"><a href="#2-6-巧用主机变量和组变量" class="headerlink" title="2.6 巧用主机变量和组变量"></a>2.6 巧用主机变量和组变量</h4><p>有时候在执行ansbile任务时，可能需要从一台远程主机上获取另一台远程主机的变量信息，这时候可以使用hostvars变量，这个变量包含了指定主机上所定义的所有变量。</p><p>譬如，若是想获取host1上变量admin_user的内容，在任意主机上直接上使用下面代码即可。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;  hostvars['host1']['admin_user']&#125;&#125;</span><br></pre></td></tr></table></figure><p>ansible提供了一些非常有用的内置变量，几个常用的如下：</p><ul><li><code>grorps</code>：包含了所有hosts文件里的主机组的一个列表。</li><li><code>group_names</code>: 包含了当前主机所在的所有主机组名的一个列表。</li><li><code>inventory_hostname</code>: 通过hosts文件定义的主机名。（与<code>ansible_home</code>意义不同）</li><li><code>inventory_hostname_short</code>：变量<code>inventory_hostname</code>的第一部分。譬如<code>inventory_hostname</code>的值为<code>books.ansible.com</code>，那么<code>inventory_hostname_short</code>的值就是books。</li><li><code>play_hosts</code>: 将执行当前任务的所有主机</li></ul><h4 id="2-7-注册变量"><a href="#2-7-注册变量" class="headerlink" title="2.7 注册变量"></a>2.7 注册变量</h4><p>注册变量，其实就是将操作结果，包括标准输出和标准错误输出，保存到变量中，然后再根据这个变量的内容来决定下一步的操作，在这个过程中用来保存操作结果的变量就叫注册变量。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">   <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">   <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">   <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">the</span> <span class="string">register</span> <span class="string">variables</span></span><br><span class="line">       <span class="attr">shell:</span> <span class="string">uptime</span></span><br><span class="line">       <span class="attr">register:</span> <span class="string">results</span>     <span class="comment"># 使用关键字register声明注册变量，上面uptime命令产生的结果，存入到results中。结果是字典形式。</span></span><br><span class="line"></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">print</span> <span class="string">the</span> <span class="string">register</span> <span class="string">result</span></span><br><span class="line">       <span class="attr">debug:</span> <span class="string">msg="&#123;&#123;</span> <span class="string">results.stdout</span> <span class="string">&#125;&#125;"</span>   <span class="comment"># 使用debug模块，打印出上面命令的输出结果。</span></span><br></pre></td></tr></table></figure><p>上面的playbook执行结果如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">TASK: [test the register variables] *******************************************</span><br><span class="line">changed: [10.0.102.212]</span><br><span class="line">changed: [10.0.102.200]</span><br><span class="line">changed: [10.0.102.162]</span><br><span class="line"></span><br><span class="line">TASK: [print the register result] *********************************************</span><br><span class="line">ok: [10.0.102.212] =&gt; &#123;</span><br><span class="line">    "msg": " 00:18:01 up 3 days,  2:56,  3 users,  load average: 0.02, 0.03, 0.05"          #msg的结果就是注册变量的标准输出</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.0.102.200] =&gt; &#123;</span><br><span class="line">    "msg": " 00:18:04 up 4 days,  7:45,  3 users,  load average: 0.03, 0.06, 0.05"</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.0.102.162] =&gt; &#123;</span><br><span class="line">    "msg": " 00:18:04 up 4 days,  7:45,  3 users,  load average: 0.01, 0.02, 0.05"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=2    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure><p>一个注册变量通常会有以下4个属性：</p><ul><li><code>changed</code>：任务是否对远程主机造成的变更。</li><li><code>delta</code>：任务运行所用的时间。</li><li><code>stdout</code>：正常的输出信息。</li><li><code>stderr</code>：错误信息。</li></ul><h3 id="三、高阶变量"><a href="#三、高阶变量" class="headerlink" title="三、高阶变量"></a>三、高阶变量</h3><p>对于普通变量，在ansible命令行设定的，在hosts文件中定义的，或者在playbook中定义的等，这些都是普通变量，在引用时，可以使用使用<code></code>的形式。ansible是用python语言写的，因此也支持一种叫做列表的变量，形式如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">   <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">   <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">   <span class="attr">vars:</span></span><br><span class="line">      <span class="attr">var_list:</span>     <span class="comment"># 注意形式，定义了var_list列表，取值方法和列表取值一样，不推荐使用jinja2的方法取值。</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">one</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">two</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">three</span></span><br><span class="line">   <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">the</span> <span class="string">list</span> <span class="string">variables</span></span><br><span class="line">       <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">&#123;&#123;</span> <span class="string">var_list[0]</span> <span class="string">&#125;&#125;</span>   <span class="comment"># 取列表中的第一个字，也就是one</span></span><br><span class="line">       <span class="attr">register:</span> <span class="string">results</span></span><br><span class="line"></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">print</span> <span class="string">the</span> <span class="string">register</span> <span class="string">result</span></span><br><span class="line">       <span class="attr">debug:</span> <span class="string">msg="&#123;&#123;</span> <span class="string">results.stdout</span> <span class="string">&#125;&#125;"</span></span><br></pre></td></tr></table></figure><p>执行结果如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">TASK: [test the list variables] ***********************************************</span><br><span class="line">changed: [10.0.102.212]</span><br><span class="line">changed: [10.0.102.200]</span><br><span class="line">changed: [10.0.102.162]</span><br><span class="line"></span><br><span class="line">TASK: [print the register result] *********************************************</span><br><span class="line">ok: [10.0.102.212] =&gt; &#123;</span><br><span class="line">    "msg": "one"</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.0.102.200] =&gt; &#123;</span><br><span class="line">    "msg": "one"</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.0.102.162] =&gt; &#123;</span><br><span class="line">    "msg": "one"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=2    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure><h4 id="3-1-fasts变量信息"><a href="#3-1-fasts变量信息" class="headerlink" title="3.1 fasts变量信息"></a>3.1 fasts变量信息</h4><p>在上面的测试中，我们的playbook都执行了一条命令叫<code>gater_facts:no</code>，加入了这条命令后，playbook脚本的执行速度会快很多，这是因为默认情况下，ansible是会手机远程服务器的主机信息，这些信息包含了服务器的一些基本设置。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GATHERING FACTS ***************************************************************</span><br><span class="line">ok: [10.0.102.200]</span><br><span class="line">ok: [10.0.102.212]</span><br><span class="line">ok: [10.0.102.162]</span><br></pre></td></tr></table></figure><p>收集的主机信息可以使用setup模块查看，一个主机的收集信息如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line">ansible 10.0.102.162 -m setup</span><br><span class="line">10.0.102.162 | success &gt;&gt; &#123;</span><br><span class="line">    "ansible_facts": &#123;</span><br><span class="line">        "ansible_all_ipv4_addresses": [</span><br><span class="line">            "10.0.102.162"</span><br><span class="line">        ],</span><br><span class="line">        "ansible_all_ipv6_addresses": [</span><br><span class="line">            "fe80::1392:ecd3:5adf:c3ae"</span><br><span class="line">        ],</span><br><span class="line">        "ansible_architecture": "x86_64",</span><br><span class="line">        "ansible_bios_date": "04/01/2014",</span><br><span class="line">        "ansible_bios_version": "1.9.1-5.el7.centos",</span><br><span class="line">        "ansible_cmdline": &#123;</span><br><span class="line">            "BOOT_IMAGE": "/vmlinuz-3.10.0-514.el7.x86_64",</span><br><span class="line">            "LANG": "en_US.UTF-8",</span><br><span class="line">            "crashkernel": "auto",</span><br><span class="line">            "quiet": true,</span><br><span class="line">            "rd.lvm.lv": "cl/swap",</span><br><span class="line">            "rhgb": true,</span><br><span class="line">            "ro": true,</span><br><span class="line">            "root": "/dev/mapper/cl-root"</span><br><span class="line">        &#125;,</span><br><span class="line">        "ansible_date_time": &#123;</span><br><span class="line">            "date": "2019-02-16",</span><br><span class="line">            "day": "16",</span><br><span class="line">            "epoch": "1550248590",</span><br><span class="line">            "hour": "00",</span><br><span class="line">            "iso8601": "2019-02-15T16:36:30Z",</span><br><span class="line">            "iso8601_micro": "2019-02-15T16:36:30.311222Z",</span><br><span class="line">            "minute": "36",</span><br><span class="line">            "month": "02",</span><br><span class="line">            "second": "30",</span><br><span class="line">            "time": "00:36:30",</span><br><span class="line">            "tz": "CST",</span><br><span class="line">            "tz_offset": "+0800",</span><br><span class="line">            "weekday": "Saturday",</span><br><span class="line">            "year": "2019"</span><br><span class="line">        &#125;,</span><br><span class="line">        "ansible_default_ipv4": &#123;</span><br><span class="line">            "address": "10.0.102.162",</span><br><span class="line">            "alias": "eth0",</span><br><span class="line">            "gateway": "10.0.100.1",</span><br><span class="line">            "interface": "eth0",</span><br><span class="line">            "macaddress": "fa:0a:e3:54:a6:00",</span><br><span class="line">            "mtu": 1500,</span><br><span class="line">            "netmask": "255.255.252.0",</span><br><span class="line">            "network": "10.0.100.0",</span><br><span class="line">            "type": "ether"</span><br><span class="line">        &#125;,</span><br><span class="line">        "ansible_default_ipv6": &#123;&#125;,</span><br><span class="line">        "ansible_devices": &#123;</span><br><span class="line">            "sr0": &#123;</span><br><span class="line">                "holders": [],</span><br><span class="line">                "host": "IDE interface: Intel Corporation 82371SB PIIX3 IDE [Natoma/Triton II]",</span><br><span class="line">                "model": "QEMU DVD-ROM",</span><br><span class="line">                "partitions": &#123;&#125;,</span><br><span class="line">                "removable": "1",</span><br><span class="line">                "rotational": "1",</span><br><span class="line">                "scheduler_mode": "cfq",</span><br><span class="line">                "sectors": "2097151",</span><br><span class="line">                "sectorsize": "512",</span><br><span class="line">                "size": "1024.00 MB",</span><br><span class="line">                "support_discard": "0",</span><br><span class="line">                "vendor": "QEMU"</span><br><span class="line">            &#125;,</span><br><span class="line">            "vda": &#123;</span><br><span class="line">                "holders": [],</span><br><span class="line">                "host": "SCSI storage controller: Red Hat, Inc Virtio block device",</span><br><span class="line">                "model": null,</span><br><span class="line">                "partitions": &#123;</span><br><span class="line">                    "vda1": &#123;</span><br><span class="line">                        "sectors": "2097152",</span><br><span class="line">                        "sectorsize": 512,</span><br><span class="line">                        "size": "1.00 GB",</span><br><span class="line">                        "start": "2048"</span><br><span class="line">                    &#125;,</span><br><span class="line">                    "vda2": &#123;</span><br><span class="line">                        "sectors": "81786880",</span><br><span class="line">                        "sectorsize": 512,</span><br><span class="line">                        "size": "39.00 GB",</span><br><span class="line">                        "start": "2099200"</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                "removable": "0",</span><br><span class="line">                "rotational": "1",</span><br><span class="line">                "scheduler_mode": "",</span><br><span class="line">                "sectors": "83886080",</span><br><span class="line">                "sectorsize": "512",</span><br><span class="line">                "size": "40.00 GB",</span><br><span class="line">                "support_discard": "0",</span><br><span class="line">                "vendor": "0x1af4"</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        "ansible_distribution": "CentOS",</span><br><span class="line">        "ansible_distribution_major_version": "7",</span><br><span class="line">        "ansible_distribution_release": "Core",</span><br><span class="line">        "ansible_distribution_version": "7.3.1611",</span><br><span class="line">        "ansible_domain": "",</span><br><span class="line">        "ansible_env": &#123;</span><br><span class="line">            "HOME": "/root",</span><br><span class="line">            "LANG": "en_US.UTF-8",</span><br><span class="line">            "LC_CTYPE": "en_US.UTF-8",</span><br><span class="line">            "LESSOPEN": "||/usr/bin/lesspipe.sh %s",</span><br><span class="line">            "LOGNAME": "root",</span><br><span class="line">            "LS_COLORS": "rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=01;05;37;41:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc=01;31:*.arj=01;31:*.taz=01;31:*.lha=01;31:*.lz4=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.tzo=01;31:*.t7z=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.dz=01;31:*.gz=01;31:*.lrz=01;31:*.lz=01;31:*.lzo=01;31:*.xz=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.alz=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.cab=01;31:*.jpg=01;35:*.jpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.axv=01;35:*.anx=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=01;36:*.au=01;36:*.flac=01;36:*.mid=01;36:*.midi=01;36:*.mka=01;36:*.mp3=01;36:*.mpc=01;36:*.ogg=01;36:*.ra=01;36:*.wav=01;36:*.axa=01;36:*.oga=01;36:*.spx=01;36:*.xspf=01;36:",</span><br><span class="line">            "MAIL": "/var/mail/root",</span><br><span class="line">            "PATH": "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin",</span><br><span class="line">            "PWD": "/root",</span><br><span class="line">            "SELINUX_LEVEL_REQUESTED": "",</span><br><span class="line">            "SELINUX_ROLE_REQUESTED": "",</span><br><span class="line">            "SELINUX_USE_CURRENT_RANGE": "",</span><br><span class="line">            "SHELL": "/bin/bash",</span><br><span class="line">            "SHLVL": "2",</span><br><span class="line">            "SSH_CLIENT": "10.0.102.204 4242 22",</span><br><span class="line">            "SSH_CONNECTION": "10.0.102.204 4242 10.0.102.162 22",</span><br><span class="line">            "SSH_TTY": "/dev/pts/1",</span><br><span class="line">            "TERM": "xterm",</span><br><span class="line">            "USER": "root",</span><br><span class="line">            "XDG_RUNTIME_DIR": "/run/user/0",</span><br><span class="line">            "XDG_SESSION_ID": "168",</span><br><span class="line">            "_": "/usr/bin/python"</span><br><span class="line">        &#125;,</span><br><span class="line">        "ansible_eth0": &#123;</span><br><span class="line">            "active": true,</span><br><span class="line">            "device": "eth0",</span><br><span class="line">            "ipv4": &#123;</span><br><span class="line">                "address": "10.0.102.162",</span><br><span class="line">                "netmask": "255.255.252.0",</span><br><span class="line">                "network": "10.0.100.0"</span><br><span class="line">            &#125;,</span><br><span class="line">            "ipv6": [</span><br><span class="line">                &#123;</span><br><span class="line">                    "address": "fe80::1392:ecd3:5adf:c3ae",</span><br><span class="line">                    "prefix": "64",</span><br><span class="line">                    "scope": "link"</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            "macaddress": "fa:0a:e3:54:a6:00",</span><br><span class="line">            "module": "virtio_net",</span><br><span class="line">            "mtu": 1500,</span><br><span class="line">            "promisc": false,</span><br><span class="line">            "type": "ether"</span><br><span class="line">        &#125;,</span><br><span class="line">        "ansible_form_factor": "Other",</span><br><span class="line">        "ansible_fqdn": "docker4",</span><br><span class="line">        "ansible_hostname": "docker4",</span><br><span class="line">        "ansible_interfaces": [</span><br><span class="line">            "lo",</span><br><span class="line">            "eth0"</span><br><span class="line">        ],</span><br><span class="line">        "ansible_kernel": "3.10.0-514.el7.x86_64",</span><br><span class="line">        "ansible_lo": &#123;</span><br><span class="line">            "active": true,</span><br><span class="line">            "device": "lo",</span><br><span class="line">            "ipv4": &#123;</span><br><span class="line">                "address": "127.0.0.1",</span><br><span class="line">                "netmask": "255.0.0.0",</span><br><span class="line">                "network": "127.0.0.0"</span><br><span class="line">            &#125;,</span><br><span class="line">            "ipv6": [</span><br><span class="line">                &#123;</span><br><span class="line">                    "address": "::1",</span><br><span class="line">                    "prefix": "128",</span><br><span class="line">                    "scope": "host"</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            "mtu": 65536,</span><br><span class="line">            "promisc": false,</span><br><span class="line">            "type": "loopback"</span><br><span class="line">        &#125;,</span><br><span class="line">        "ansible_machine": "x86_64",</span><br><span class="line">        "ansible_memfree_mb": 881,</span><br><span class="line">        "ansible_memtotal_mb": 1839,</span><br><span class="line">        "ansible_mounts": [</span><br><span class="line">            &#123;</span><br><span class="line">                "device": "/dev/mapper/cl-root",</span><br><span class="line">                "fstype": "xfs",</span><br><span class="line">                "mount": "/",</span><br><span class="line">                "options": "rw,seclabel,relatime,attr2,inode64,noquota",</span><br><span class="line">                "size_available": 34615087104,</span><br><span class="line">                "size_total": 39700664320</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                "device": "/dev/vda1",</span><br><span class="line">                "fstype": "xfs",</span><br><span class="line">                "mount": "/boot",</span><br><span class="line">                "options": "rw,seclabel,relatime,attr2,inode64,noquota",</span><br><span class="line">                "size_available": 918556672,</span><br><span class="line">                "size_total": 1063256064</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        "ansible_nodename": "docker4",</span><br><span class="line">        "ansible_os_family": "RedHat",</span><br><span class="line">        "ansible_pkg_mgr": "yum",</span><br><span class="line">        "ansible_processor": [</span><br><span class="line">            "QEMU Virtual CPU version 2.5+",</span><br><span class="line">            "QEMU Virtual CPU version 2.5+"</span><br><span class="line">        ],</span><br><span class="line">        "ansible_processor_cores": 2,</span><br><span class="line">        "ansible_processor_count": 1,</span><br><span class="line">        "ansible_processor_threads_per_core": 1,</span><br><span class="line">        "ansible_processor_vcpus": 2,</span><br><span class="line">        "ansible_product_name": "KVM",</span><br><span class="line">        "ansible_product_serial": "NA",</span><br><span class="line">        "ansible_product_uuid": "E5E1D5E6-1A4D-4E0D-98C3-B8AD422B10CC",</span><br><span class="line">        "ansible_product_version": "RHEL 7.3.0 PC (i440FX + PIIX, 1996)",</span><br><span class="line">        "ansible_python_version": "2.7.5",</span><br><span class="line">        "ansible_selinux": &#123;</span><br><span class="line">            "config_mode": "enforcing",</span><br><span class="line">            "mode": "enforcing",</span><br><span class="line">            "policyvers": 28,</span><br><span class="line">            "status": "enabled",</span><br><span class="line">            "type": "targeted"</span><br><span class="line">        &#125;,</span><br><span class="line">        "ansible_ssh_host_key_ecdsa_public": "AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBEp5iF/lAqB9Q9FNKfnsi3mLJSVvvooVhRRcuGTBHEJs+TaM36oBaIr764IX1zdn2sWFLdYgmcuaAeiPu3fK+UU=",</span><br><span class="line">        "ansible_ssh_host_key_rsa_public": "AAAAB3NzaC1yc2EAAAADAQABAAABAQC6yHI2+V64EMW3jDISBrzKmWurP7uF4IqemJgowpqC3mVlFsPOSqerDoJN9hE34fViXcbLUj9wIi0kc3QzxxNwTefwJCdPSL17ns9eIEDKJqrHswts7OXYC1948bdyhyGnaW57BEfVUJ+Vt8OI1JSKkKsi3aCumaZDz9tNGCVYiqW4PMUQFaT/yEnPqKhSp8mDX/SL/unpVsctB0w37o38ZVApKPaNkHW25uiwroStLGqY4VgoZHTqHUdvqk4EZQOD0+JmBcYKVj2ABBl1sMiH8mmrc2W2Gi0gJx31Ky/t5SWQtXTdMRB3D7N9yRd1pPcnh0zebS/OPnX4G5UWX/aP",</span><br><span class="line">        "ansible_swapfree_mb": 0,</span><br><span class="line">        "ansible_swaptotal_mb": 0,</span><br><span class="line">        "ansible_system": "Linux",</span><br><span class="line">        "ansible_system_vendor": "Red Hat",</span><br><span class="line">        "ansible_user_id": "root",</span><br><span class="line">        "ansible_userspace_architecture": "x86_64",</span><br><span class="line">        "ansible_userspace_bits": "64",</span><br><span class="line">        "ansible_virtualization_role": "guest",</span><br><span class="line">        "ansible_virtualization_type": "kvm",</span><br><span class="line">        "module_setup": true</span><br><span class="line">    &#125;,</span><br><span class="line">    "changed": false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在实际应用中，运用的比较多的facts变量有<code>ansible_os_family</code>，<code>ansible_hostname</code>等，这些变量通常会被拿来作为when条件语句的判断条件，来决定下一步的操作。一个简单的实例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">   <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">   <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">the</span> <span class="string">list</span> <span class="string">variables</span></span><br><span class="line">       <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">&#123;&#123;</span> <span class="string">ansible_os_family</span> <span class="string">&#125;&#125;</span></span><br><span class="line">       <span class="attr">register:</span> <span class="string">results</span></span><br><span class="line"></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">print</span> <span class="string">the</span> <span class="string">register</span> <span class="string">result</span></span><br><span class="line">       <span class="attr">debug:</span> <span class="string">msg="&#123;&#123;</span> <span class="string">results.stdout</span> <span class="string">&#125;&#125;"</span></span><br></pre></td></tr></table></figure><p>执行结果如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook test.yml</span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">GATHERING FACTS ***************************************************************</span><br><span class="line">ok: [10.0.102.162]</span><br><span class="line">ok: [10.0.102.212]</span><br><span class="line">ok: [10.0.102.200]</span><br><span class="line"></span><br><span class="line">TASK: [test the list variables] ***********************************************</span><br><span class="line">changed: [10.0.102.162]</span><br><span class="line">changed: [10.0.102.212]</span><br><span class="line">changed: [10.0.102.200]</span><br><span class="line"></span><br><span class="line">TASK: [print the register result] *********************************************</span><br><span class="line">ok: [10.0.102.212] =&gt; &#123;</span><br><span class="line">    "msg": "RedHat"                   #对应变量的结果</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.0.102.200] =&gt; &#123;</span><br><span class="line">    "msg": "RedHat"</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.0.102.162] =&gt; &#123;</span><br><span class="line">    "msg": "RedHat"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=3    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=3    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=3    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure><h4 id="3-2-本地facts变量"><a href="#3-2-本地facts变量" class="headerlink" title="3.2 本地facts变量"></a>3.2 本地facts变量</h4><p>我们可以自己定义facts变量，把这个变量写入一个以<code>.fact</code>结尾的文件中，这个文件可以是json文件或ini文件，或者是一个可以返回json代码的可执行文件。然后将其放在远程主机的<code>/etc/ansible/facts.d</code>文件夹中，ansible在执行的任务时会自动到这个文件夹中读取变量的信息。</p><p>在远程主机上做如下操作：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 自定义fact信息</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p /etc/ansible/facts.d &amp;&amp; <span class="built_in">cd</span> /etc/ansible/facts.d</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat test.fact</span></span><br><span class="line">[test_fact]</span><br><span class="line">admin=hongkong</span><br></pre></td></tr></table></figure><p>然后再ansible主机上获取自定义的信息。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible 10.0.102.162 -m setup -a <span class="string">"filter=ansible_local"</span></span></span><br><span class="line">10.0.102.162 | success &gt;&gt; &#123;</span><br><span class="line">    "ansible_facts": &#123;</span><br><span class="line">        "ansible_local": &#123;</span><br><span class="line">            "test": &#123;</span><br><span class="line">                "test_fact": &#123;</span><br><span class="line">                    "admin": "hongkong"</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "changed": false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="四、if-when-while流程控制语句"><a href="#四、if-when-while流程控制语句" class="headerlink" title="四、if/when/while流程控制语句"></a>四、if/when/while流程控制语句</h3><p>条件判断在ansible任务中的使用频率非常高。我们可以根据一些条件的不一样执行不同的task。</p><h4 id="4-1-when条件判断"><a href="#4-1-when条件判断" class="headerlink" title="4.1 when条件判断"></a>4.1 when条件判断</h4><p>很多任务只有在特定条件下才能执行，这就是when语句发挥作用的地方。</p><p>一个简单的实例，关闭掉ip地址为10.0.102.162服务器上的mysql服务，如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@test2 playbook]# cat test.yml</span><br><span class="line">---</span><br><span class="line"> - hosts: all</span><br><span class="line">   remote_user: root</span><br><span class="line">   tasks:</span><br><span class="line">     - name: shut down the db server</span><br><span class="line">       service: name=mysqld state=stopped</span><br><span class="line">       when: ansible_eth0.ipv4.address  == "10.0.102.162"  # 这里使用了when条件语句</span><br></pre></td></tr></table></figure><p>执行的结果如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">GATHERING FACTS ***************************************************************</span><br><span class="line">ok: [10.0.102.212]</span><br><span class="line">ok: [10.0.102.200]</span><br><span class="line">ok: [10.0.102.162]</span><br><span class="line"></span><br><span class="line">TASK: [shut down the db server] ***********************************************</span><br><span class="line">skipping: [10.0.102.200]</span><br><span class="line">skipping: [10.0.102.212]</span><br><span class="line">changed: [10.0.102.162]                      #162的服务状态已经改变</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=1    changed=0    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=1    changed=0    unreachable=0    failed=0</span><br></pre></td></tr></table></figure><p>这个就是when条件语句的用法很简单。需要注意when语句的作用于paly的作用时间，当when的条件满足时，然后才会执行play中的任务。ansible还提供了另外两个与when相关的语句<code>changed_when</code>和<code>failed_when</code>条件判断。</p><h3 id="五、任务间的流程控制"><a href="#五、任务间的流程控制" class="headerlink" title="五、任务间的流程控制"></a>五、任务间的流程控制</h3><h4 id="5-1-任务委托"><a href="#5-1-任务委托" class="headerlink" title="5.1 任务委托"></a>5.1 任务委托</h4><p>默认情况下，ansible所有任务都是在我们指定的机器上面运行的，当在一个独立的集群环境配置时，这并没有什么问题。而在有些情况下，比如给某台服务器发送通知或者向监控服务器中添加被监控的主机，这个时候任务就需要在特定的主机上运行，而非一开始指定的所有主机，此时就需要ansible的委托任务。</p><p>使用<code>delegate_to</code>关键字可以配置任务在指定的服务器上执行，而其他任务还是在hosts关键字配置的所有机器上执行，当到了这个关键字所在的任务时，就使用委托的机器运行。</p><p>查看MySQL是否在运行状态，因此在检查之前首先关掉162上的mysql服务。（为了方便查看状态）</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">   <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">   <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">stop</span> <span class="string">the</span> <span class="string">db</span> <span class="string">server</span></span><br><span class="line">       <span class="attr">service:</span> <span class="string">name=mysqld</span> <span class="string">state=stopped</span></span><br><span class="line">       <span class="attr">delegate_to:</span> <span class="number">10.0</span><span class="number">.102</span><span class="number">.162</span>       <span class="comment"># 这里使用了委托，仅关闭162这台服务器上，这个play仅在162这台服务器上执行。</span></span><br><span class="line"></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">check</span> <span class="string">mysql</span> <span class="string">status</span></span><br><span class="line">       <span class="attr">service:</span> <span class="string">name=mysqld</span> <span class="string">state=running</span></span><br></pre></td></tr></table></figure><p>这里委托是在指定的机器上执行，若是想在本地服务器上执行，可以把ip地址换为127.0.0.1即可。也可以使用<code>local_action</code>方法。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">   <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">   <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">the</span> <span class="string">test</span> <span class="string">file</span></span><br><span class="line">       <span class="attr">local_action:</span> <span class="string">shell</span> <span class="string">touch</span> <span class="string">test1111</span> <span class="comment"># 在本地创建一个测试文件</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">check</span> <span class="string">mysql</span> <span class="string">status</span></span><br><span class="line">       <span class="attr">service:</span> <span class="string">name=mysqld</span> <span class="string">state=running</span></span><br></pre></td></tr></table></figure><p>结果如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">GATHERING FACTS ***************************************************************</span><br><span class="line">ok: [10.0.102.212]</span><br><span class="line">ok: [10.0.102.200]</span><br><span class="line">ok: [10.0.102.162]</span><br><span class="line"></span><br><span class="line">TASK: [create the test file] **************************************************</span><br><span class="line">changed: [10.0.102.212 -&gt; 127.0.0.1]</span><br><span class="line">changed: [10.0.102.200 -&gt; 127.0.0.1]</span><br><span class="line">changed: [10.0.102.162 -&gt; 127.0.0.1]</span><br><span class="line"></span><br><span class="line">TASK: [check mysql status] ****************************************************</span><br><span class="line">ok: [10.0.102.200]</span><br><span class="line">ok: [10.0.102.212]</span><br><span class="line">ok: [10.0.102.162]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=3    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=3    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=3    changed=1    unreachable=0    failed=0</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls                     <span class="comment"># 默认会在当前目录创建对应的文件</span></span></span><br><span class="line">test1111  test.yml  vars.yml</span><br></pre></td></tr></table></figure><h4 id="5-2-任务暂停"><a href="#5-2-任务暂停" class="headerlink" title="5.2 任务暂停"></a>5.2 任务暂停</h4><p>有些情况下，一些任务的运行需要等待一些状态的恢复，比如某一台主机或者应用刚刚重启，我们需要等待它上面的某个端口开启，此时我们就不得不将正在运行的任务暂停，直到其状态满足我们的需求。</p><p>下一个实例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wait</span> <span class="string">for</span> <span class="string">webserver</span> <span class="string">to</span> <span class="string">start</span></span><br><span class="line">   <span class="attr">local_action:</span></span><br><span class="line">        <span class="attr">module:</span> <span class="string">wait_for</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">webserver1</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">timeout:</span> <span class="number">300</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">startted</span></span><br><span class="line"><span class="comment"># 这个实例中，这个任务将会每10s检查一次主机webserver1上面的80端口是否开启，如果超过了300s则失败</span></span><br></pre></td></tr></table></figure><h4 id="5-3-交互式提示"><a href="#5-3-交互式提示" class="headerlink" title="5.3 交互式提示"></a>5.3 交互式提示</h4><p>在少数情况下，ansible任务运行的过程中需要用户输入一些数据，这些数据要么比较秘密不方便，或者数据是动态的，不同的用户有不同的需求，比如输入用户自己的账户和密码或者输入不同的版本号会触发不同的后续操作等。ansible的<code>vars_prompt</code>关键字就是用来处理上述这种与用户交互的情况的。下面是一个简单的实例。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">   <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">   <span class="attr">vars_prompt:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">share_user</span></span><br><span class="line">        <span class="attr">prompt:</span> <span class="string">"what is your network username?"</span></span><br><span class="line">        <span class="attr">private:</span> <span class="literal">no</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">share_pass</span></span><br><span class="line">        <span class="attr">prompt:</span> <span class="string">"what is your network password"</span></span><br><span class="line">        <span class="attr">private:</span> <span class="literal">no</span></span><br></pre></td></tr></table></figure><p>然后执行上面的playbook，因为我们只是测试，只需要在一台机器上执行，因此加入了<code>--limit</code>参数。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml --<span class="built_in">limit</span> 10.0.102.162</span></span><br><span class="line">what is your network username?: test        # 需要手动交互输入</span><br><span class="line">what is your network password: 123456       # 手动输入</span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">GATHERING FACTS ***************************************************************</span><br><span class="line">ok: [10.0.102.162]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=1    changed=0    unreachable=0    failed=0</span><br></pre></td></tr></table></figure><p>手动输入的变量值，在后面的play中仍然可以用<code></code>的形式调用。</p><p>关键字<code>vars_prompt</code>几个常用的选项总结如下：</p><ul><li><code>private</code>：默认值为yes，表示用户输入的值在命令行不可见；将值设为no时，用户输入可见。</li><li><code>default</code>：为变量设置默认值，以节省用户输入时间。</li><li><code>confirm</code>：特别适合输入密码的情况，如果将其设置为yes，则会要求用户输入两次，以增加输入的安全性。</li></ul><h3 id="六、tags标签"><a href="#六、tags标签" class="headerlink" title="六、tags标签"></a>六、tags标签</h3><p>默认情况下，ansible在执行一个playbook时，会执行playbook中定义的所有任务。ansible的标签功能可以给角色，文件，单独的任务甚至整个playbook打上标签，然后利用这些标签来指定要运行playbook中的个别任务，或不执行指定的任务，并且它的语法非常简单。</p><p>通过一段代码来说明tags的用法：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 可以给整个playbook的所有任务打一个标签。</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">deploy</span></span><br><span class="line">    <span class="attr">roles:</span></span><br><span class="line">     <span class="comment"># 给角色打的标签将会应用与角色下所有的任务。</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">&#123;role:</span> <span class="string">tomcat,</span> <span class="attr">tags :</span> <span class="string">["tomcat",</span> <span class="string">"app"</span><span class="string">]&#125;</span>        <span class="comment"># 一个对象添加多个tag的写法之一</span></span><br><span class="line">    <span class="attr">tasks:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Notify</span> <span class="string">on</span> <span class="string">completion</span></span><br><span class="line">         <span class="attr">local_action:</span></span><br><span class="line">            <span class="attr">module:</span> <span class="string">osx_say</span></span><br><span class="line">            <span class="attr">msg:</span> <span class="string">"<span class="template-variable">&#123;&#123;inventory_hostname&#125;&#125;</span> is finished"</span></span><br><span class="line">            <span class="attr">voice:</span> <span class="string">Zarvox</span></span><br><span class="line">         <span class="attr">tags:</span>      <span class="comment"># 一个对象添加多个tag写法之二</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">notifications</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">say</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">include:</span> <span class="string">foo.yml</span></span><br><span class="line">         <span class="string">tags:</span>　<span class="string">foo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 缩进可能不太对</span></span><br></pre></td></tr></table></figure><p>将上述代码保存，可以通过以下命令来只执行<code>Notify on completion</code>任务。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml --tags <span class="string">"say"</span></span></span><br></pre></td></tr></table></figure><p>如果想忽略掉某个任务，可以使用<code>--skip-tags</code>关键字指定。</p><h3 id="七、Block块"><a href="#七、Block块" class="headerlink" title="七、Block块"></a>七、Block块</h3><p>ansible从2.0.0版本开始引入了块功能。块功能可以将任务进行分组，并且可以在块级别上应用任务变量。同时，块功能还可以使用类似于其他编程语言处理异常那样的方法，来处理块内部的任务异常。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">   <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line">   <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">block:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=no</span></span><br><span class="line">       <span class="attr">when:</span>  <span class="string">ansible_eth0.ipv4.address</span>  <span class="string">==</span> <span class="string">"10.0.102.162"</span></span><br><span class="line"></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">block:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">yum:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=started</span> <span class="string">enabled=no</span></span><br><span class="line">       <span class="attr">when:</span>  <span class="string">ansible_eth0.ipv4.address</span>  <span class="string">==</span> <span class="string">"10.0.102.200"</span></span><br></pre></td></tr></table></figure><p>运行结果如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook -i hosts test.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [all] **************************************************************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **************************************************************************************************************************************************************************</span><br><span class="line">ok: [10.0.102.162]</span><br><span class="line">ok: [10.0.102.200]</span><br><span class="line"></span><br><span class="line">TASK [yum] **************************************************************************************************************************************************************************************</span><br><span class="line">skipping: [10.0.102.200]          # 因为在inventory文件中注释了这一台服务器，因此这里忽略了。</span><br><span class="line">ok: [10.0.102.162]</span><br><span class="line"></span><br><span class="line">TASK [service] **********************************************************************************************************************************************************************************</span><br><span class="line">skipping: [10.0.102.200]</span><br><span class="line">changed: [10.0.102.162]</span><br><span class="line"></span><br><span class="line">TASK [yum] **************************************************************************************************************************************************************************************</span><br><span class="line">skipping: [10.0.102.162]</span><br><span class="line">ok: [10.0.102.200]</span><br><span class="line"></span><br><span class="line">TASK [service] **********************************************************************************************************************************************************************************</span><br><span class="line">skipping: [10.0.102.162]</span><br><span class="line">changed: [10.0.102.200]</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************************************************************************</span><br><span class="line">10.0.102.162               : ok=3    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=3    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure><p>上面的playbook和之前的并没有什么不同，只是假如了block之后，代码更容易查看。</p><p>块功能可以用来处理任务的异常。比如一个ansible任务时监控一个并不太重要的应用，这个应用的正常运行与否对后续的任务并不产生影响，这时候我们就可以通过块功能来处理这个应用的报错。如下代码：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">block:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shell</span> <span class="string">script</span> <span class="string">to</span> <span class="string">connect</span> <span class="string">the</span> <span class="string">app</span> <span class="string">ti</span> <span class="string">a</span> <span class="string">mointoring</span> <span class="string">service.</span></span><br><span class="line">          <span class="attr">script:</span> <span class="string">mointoring-connect.sh</span></span><br><span class="line">          <span class="attr">rescue:</span></span><br><span class="line">             <span class="bullet">-</span> <span class="string">name:只有脚本报错时才执行</span></span><br><span class="line">　　　　　　　　 <span class="string">debug：msg="There</span> <span class="string">was</span> <span class="string">an</span> <span class="string">error</span> <span class="string">in</span> <span class="string">the</span> <span class="string">block"</span></span><br><span class="line">          <span class="attr">always:</span></span><br><span class="line">             <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">无论结果如何都执行</span></span><br><span class="line">               <span class="attr">debug:</span> <span class="string">msg="This</span> <span class="string">always</span> <span class="string">executes"</span></span><br></pre></td></tr></table></figure><p>当块中任意任务出错时，rescue关键字对应的代码块就会被执行，而always关键字对应的代码块无论如何都会被执行。</p><p><strong><strong><strong>***</strong></strong></strong> 当你发现自己的才华撑不起野心时，就请安静下来学习吧！<strong><strong><strong>***</strong></strong></strong></p><p>原文链接：<a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html" target="_blank" rel="noopener">https://www.cnblogs.com/lvzhenjiang/p/14198755.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Ansible-中的-playbook-详解&quot;&gt;&lt;a href=&quot;#Ansible-中的-playbook-详解&quot; class=&quot;headerlink&quot; title=&quot;Ansible 中的 playbook 详解&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://www
      
    
    </summary>
    
    
      <category term="ansible" scheme="http://yoursite.com/categories/ansible/"/>
    
    
      <category term="ansible" scheme="http://yoursite.com/tags/ansible/"/>
    
  </entry>
  
  <entry>
    <title>ansible-playbook中的变量</title>
    <link href="http://yoursite.com/2021/05/14/ansible/ansible-playbook%E4%B8%AD%E7%9A%84%E5%8F%98%E9%87%8F/"/>
    <id>http://yoursite.com/2021/05/14/ansible/ansible-playbook%E4%B8%AD%E7%9A%84%E5%8F%98%E9%87%8F/</id>
    <published>2021-05-14T04:49:42.065Z</published>
    <updated>2021-05-14T04:49:42.055Z</updated>
    
    <content type="html"><![CDATA[<p>原文链接：<a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html" target="_blank" rel="noopener">https://www.cnblogs.com/lvzhenjiang/p/14385777.html</a></p><h1 id="ansible-playbook中的变量"><a href="#ansible-playbook中的变量" class="headerlink" title="ansible playbook中的变量"></a><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html" target="_blank" rel="noopener">ansible playbook中的变量</a></h1><p>目录</p><ul><li>一、变量的优先级<ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html#11-yaml陷阱" target="_blank" rel="noopener">1.1 YAML陷阱</a></li></ul></li><li>二、 Ansbile-playbook变量配置方法<ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html#21-在inventory主机清单文件中定义变量" target="_blank" rel="noopener">2.1 在inventory主机清单文件中定义变量</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html#22-通过host_vars和group_vars目录来定义变量" target="_blank" rel="noopener">2.2 通过host_vars和group_vars目录来定义变量</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html#23-通过var_files定义变量" target="_blank" rel="noopener">2.3 通过var_files定义变量</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html#24-通过vars_prompt交互式传入变量" target="_blank" rel="noopener">2.4 通过vars_prompt交互式传入变量</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html#25-通过ansible-playbook命令行定义变量！即参数传入变量" target="_blank" rel="noopener">2.5 通过ansible-playbook命令行定义变量！即参数传入变量</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html#26-在playbook剧本中定义变量" target="_blank" rel="noopener">2.6 在playbook剧本中定义变量</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html#27-通过roles角色定义变量" target="_blank" rel="noopener">2.7 通过roles角色定义变量</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html#28-使用facts获取的信息" target="_blank" rel="noopener">2.8 使用Facts获取的信息</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html#29-register注册变量" target="_blank" rel="noopener">2.9 register注册变量</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html#210-hostvars-变量" target="_blank" rel="noopener">2.10 hostvars 变量</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html#211-列表变量、循环变量、字典变量" target="_blank" rel="noopener">2.11 列表变量、循环变量、字典变量</a></li></ul></li></ul><h3 id="一、变量的优先级"><a href="#一、变量的优先级" class="headerlink" title="一、变量的优先级"></a>一、变量的优先级</h3><ul><li><code>extra vars</code>变量（在命令行中使用 <code>-e</code>）；优先级最高；</li><li>在inventory中定义的连接变量（比如<code>ansible_ssh_user</code>）；优先级第二；</li><li>大多数的其他变量（命令行转换，play中的变量，include的变量，role的变量等）；优先级第三；</li><li>在<code>inventory</code>定义的其他变量；优先级第四；</li><li>有系统发现的<code>facts</code>；优先级第五；</li><li>“role默认变量”，这个是最默认的值，很容易丧失优先权。优先级最小；</li></ul><p>另外：在inventory清单列表里定义的变量：<strong>单个主机定义的变量优先级高于主机组定义的变量</strong><br>经过实验，ansible使用inventory定义变量的优先级顺序从高到低为：<br>host_vars下定义变量 —&gt; inventory中单个主机定义变量 —&gt; group_vars下定义变量 —&gt; inventory中组定义变量</p><h4 id="1-1-YAML陷阱"><a href="#1-1-YAML陷阱" class="headerlink" title="1.1 YAML陷阱"></a>1.1 YAML陷阱</h4><p>YAML语法要求如果值以开头的话，那么就需要将整行用双引号包起来，这是为了确认你不是想声明一个YAML字典。<br>如下面配置是不行的！！！</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">app_servers</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">app_path:</span> <span class="string">&#123;&#123;</span> <span class="string">base_path</span> <span class="string">&#125;&#125;/data/web</span></span><br></pre></td></tr></table></figure><p>应该改成下面这样：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">app_servers</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">app_path:</span> <span class="string">"<span class="template-variable">&#123;&#123; base_path &#125;&#125;</span>/data/web"</span></span><br></pre></td></tr></table></figure><h3 id="二、-Ansbile-playbook变量配置方法"><a href="#二、-Ansbile-playbook变量配置方法" class="headerlink" title="二、 Ansbile-playbook变量配置方法"></a>二、 Ansbile-playbook变量配置方法</h3><h4 id="2-1-在inventory主机清单文件中定义变量"><a href="#2-1-在inventory主机清单文件中定义变量" class="headerlink" title="2.1 在inventory主机清单文件中定义变量"></a>2.1 在inventory主机清单文件中定义变量</h4><p>可以直接定义在主机清单文件<code>/etc/ansible/hosts</code>中，表明该变量只对对应的主机或者组有效，对其余的主机和组无效。</p><p><strong>示例：</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> egrep -v <span class="string">"^#|^$"</span> /etc/ansible/hosts </span></span><br><span class="line">10.4.7.101 key=20180101</span><br><span class="line">10.4.7.102 key="niubility"</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim ansi.yml </span></span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  gather_facts: False</span><br><span class="line">  tasks:</span><br><span class="line">    - name: haha</span><br><span class="line">      debug: msg="the &#123;&#123; inventory_hostname &#125;&#125; value is &#123;&#123; key &#125;&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行结果（注意inventory_hostname代表inventory列表列表里被控节点的主机名）：</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook ansi.yml </span></span><br><span class="line"></span><br><span class="line">PLAY [all] **************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [haha] *************************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; &#123;</span><br><span class="line">    "msg": "the 10.4.7.101 value is 20180101"</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.4.7.102] =&gt; &#123;</span><br><span class="line">    "msg": "the 10.4.7.102 value is niubility"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">10.4.7.102                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure><h4 id="2-2-通过host-vars和group-vars目录来定义变量"><a href="#2-2-通过host-vars和group-vars目录来定义变量" class="headerlink" title="2.2 通过host_vars和group_vars目录来定义变量"></a>2.2 通过host_vars和group_vars目录来定义变量</h4><p><code>/etc/ansible/</code>目录是linux系统上ansible默认的配置文件目录（Mac系统上的话，其默认配置目录是在<code>/usr/local/etc/ansible/</code>），在该目录下创建<code>host_vars</code>和<code>group_vars</code>两个目录用来存放定义变量的文件。</p><p><strong>针对单个主机的变量</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat /etc/ansible/host_vars/10.4.7.101</span></span><br><span class="line">---</span><br><span class="line">user: root</span><br><span class="line">pass: root@123</span><br></pre></td></tr></table></figure><p><strong>针对test组的变量</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat /etc/ansible/group_vars/<span class="built_in">test</span></span></span><br><span class="line">---</span><br><span class="line">user: work</span><br><span class="line">pass: work@123</span><br></pre></td></tr></table></figure><p><strong>在inventory清单列表文件里，单个主机定义的变量优先级高于主机组定义的变量</strong></p><h4 id="2-3-通过var-files定义变量"><a href="#2-3-通过var-files定义变量" class="headerlink" title="2.3 通过var_files定义变量"></a>2.3 通过var_files定义变量</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat vars.yml </span></span><br><span class="line">---</span><br><span class="line">key: jiayou</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat bo.yml </span></span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  gather_facts: False</span><br><span class="line">  vars_files:</span><br><span class="line">      - vars.yml</span><br><span class="line">  tasks:</span><br><span class="line">    - name: display</span><br><span class="line">      debug: msg="the &#123;&#123; inventory_hostname &#125;&#125; valus is &#123;&#123; key &#125;&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook bo.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [all] **************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [display] **********************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; &#123;</span><br><span class="line">    "msg": "the 10.4.7.101 valus is jiayou"</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.4.7.102] =&gt; &#123;</span><br><span class="line">    "msg": "the 10.4.7.102 valus is jiayou"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">10.4.7.102                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure><h4 id="2-4-通过vars-prompt交互式传入变量"><a href="#2-4-通过vars-prompt交互式传入变量" class="headerlink" title="2.4 通过vars_prompt交互式传入变量"></a>2.4 通过vars_prompt交互式传入变量</h4><p>在playbook中定义<code>vars_prompt</code>的变量名和交互式提示信息，就可以实现在运行playbook时，通过交互的传入变量值。<br><strong>private字段</strong>：用来定义交互时是否回显输入的值，默认private为yes；<br><strong>default字段</strong>：用来定义变量的默认值。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat prom.yml </span></span><br><span class="line">---</span><br><span class="line">- hosts: test</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars_prompt:</span><br><span class="line">      - name: "var1"</span><br><span class="line">        prompt: "please input you name"</span><br><span class="line">        private: no</span><br><span class="line">      - name: "var2"</span><br><span class="line">        prompt: "please input you age"</span><br><span class="line">        private: yes</span><br><span class="line">        default: 18</span><br><span class="line">  tasks:</span><br><span class="line">      - name: display var1</span><br><span class="line">        debug: msg="your name of var1 is &#123;&#123; var1 &#125;&#125;"</span><br><span class="line">      - name: display var2</span><br><span class="line">        debug: msg="you age of var2 is &#123;&#123; var2 &#125;&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook prom.yml </span></span><br><span class="line">please input you name: lvzhenjiang    # 把输入的内容传递给变量var1。输入的值显示出来！</span><br><span class="line">please input you age [18]:           # playbook中定义默认值是18，如果不输入便是18，但是输入的值不显示出来！比如这里输入的23</span><br><span class="line"></span><br><span class="line">PLAY [test] *************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">TASK [display var1] *****************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; &#123;</span><br><span class="line">    "msg": "your name of var1 is lvzhenjiang"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [display var2] *****************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; &#123;</span><br><span class="line">    "msg": "you age of var2 is 23"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure><h4 id="2-5-通过ansible-playbook命令行定义变量！即参数传入变量"><a href="#2-5-通过ansible-playbook命令行定义变量！即参数传入变量" class="headerlink" title="2.5 通过ansible-playbook命令行定义变量！即参数传入变量"></a>2.5 通过ansible-playbook命令行定义变量！即参数传入变量</h4><p>除了<code>vars_prompt</code>和<code>vars_files</code>，也可以通过Ansible命令行发送变量。如果想要编写一个通用的发布playbook时则特别有用！你可以传递应用的版本以便部署。例如下面命令（注意： <code>--extra-vars</code> 相等于 -e）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat exap.yml </span></span><br><span class="line">---</span><br><span class="line">- hosts: '&#123;&#123;hosts&#125;&#125;'</span><br><span class="line">  remote_user: '&#123;&#123;user&#125;&#125;'</span><br><span class="line">  tasks:</span><br><span class="line">    - name: "一个测试"</span><br><span class="line">      debug: msg="your hosts is &#123;&#123;hosts&#125;&#125;, user is &#123;&#123;user&#125;&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">  ansible-playbook exap.yml -e <span class="string">"hosts=test user=root"</span> </span></span><br><span class="line">[WARNING]: Found variable using reserved name: hosts</span><br><span class="line"></span><br><span class="line">PLAY [test] *************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">TASK [一个测试] *************************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; &#123;</span><br><span class="line">    "msg": "your hosts is test, user is root"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure><p><strong>也可以将参数放在文件里面进行传递（注意命令行里要是用<code>&quot;@文件名&quot;</code>）：</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 同样使用上面的例子</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat anhui.yml </span></span><br><span class="line">---</span><br><span class="line">hosts: test</span><br><span class="line">user: root</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook exap.yml -e <span class="string">"@anhui.yml"</span></span></span><br><span class="line">[WARNING]: Found variable using reserved name: hosts</span><br><span class="line"></span><br><span class="line">PLAY [test] *************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">TASK [一个测试] *************************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; &#123;</span><br><span class="line">    "msg": "your hosts is test, user is root"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure><h4 id="2-6-在playbook剧本中定义变量"><a href="#2-6-在playbook剧本中定义变量" class="headerlink" title="2.6 在playbook剧本中定义变量"></a>2.6 在playbook剧本中定义变量</h4><p>在playbook中定义变量需要用到Ansible的vars模块，可以将所有需要用到的变量统一在vars模块下定义，定义格式需要遵循YAML语言格式：</p><p>语法格式：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vars:</span><br><span class="line">  - var1: value1</span><br><span class="line">  - var2: value2</span><br><span class="line">  - var3: value3</span><br><span class="line">  - ....: .....</span><br></pre></td></tr></table></figure><p>示例如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat playbook.yml </span></span><br><span class="line">---</span><br><span class="line">- hosts: test</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    - dir1: /root/Ansible</span><br><span class="line">    - dir2: /root/Ansible/test1</span><br><span class="line">    - dir3: /root/Ansible/test2</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Create New Folder</span><br><span class="line">      file: name=&#123;&#123; dir1 &#125;&#125; state=directory</span><br><span class="line">    - name: Create New Folder</span><br><span class="line">      file: name=&#123;&#123; dir2 &#125;&#125; state=directory</span><br><span class="line">    - name: Create New Folder</span><br><span class="line">      file: name=&#123;&#123; dir3 &#125;&#125; state=directory</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook playbook.yml </span></span><br><span class="line"></span><br><span class="line">PLAY [test] *************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">TASK [Create New Folder] ************************************************************************************************************************</span><br><span class="line">changed: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">TASK [Create New Folder] ************************************************************************************************************************</span><br><span class="line">changed: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">TASK [Create New Folder] ************************************************************************************************************************</span><br><span class="line">changed: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=4    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure><h4 id="2-7-通过roles角色定义变量"><a href="#2-7-通过roles角色定义变量" class="headerlink" title="2.7 通过roles角色定义变量"></a>2.7 通过roles角色定义变量</h4><p>在Ansible的roles中定义变量，需要将变量及值的键值对形式写到roles的vars目录下的main.yml文件中，同样适用YAML语言格式，格式如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var1: value1</span><br><span class="line">var2: value2</span><br><span class="line">var3: value3</span><br></pre></td></tr></table></figure><p>但是请注意：通过Roles定义的变量只适用于当前roles。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> roles目录结构</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tree .</span></span><br><span class="line">.</span><br><span class="line">├── hosts</span><br><span class="line">├── playbook.yml</span><br><span class="line">└── test</span><br><span class="line">    ├── files</span><br><span class="line">    ├── tasks</span><br><span class="line">    │   └── main.yml</span><br><span class="line">    ├── templates</span><br><span class="line">    └── vars</span><br><span class="line">        └── main.yml</span><br><span class="line"></span><br><span class="line">5 directories, 4 files</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat <span class="built_in">test</span>/tasks/main.yml </span></span><br><span class="line">- name: create directory</span><br><span class="line">  file: name=&#123;&#123; dir &#125;&#125; state=directory</span><br><span class="line">- name: Get IP Address</span><br><span class="line">  shell: echo `&#123;&#123; cmd &#125;&#125;` &gt;&gt; &#123;&#123; dir &#125;&#125;/&#123;&#123; file &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat <span class="built_in">test</span>/vars/main.yml </span></span><br><span class="line">cmd: hostname -I</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat playbook.yml </span></span><br><span class="line">---</span><br><span class="line">- hosts: test</span><br><span class="line">  remote_user: root</span><br><span class="line">  roles:</span><br><span class="line">    - test</span><br><span class="line">    </span><br><span class="line"><span class="meta">$</span><span class="bash"> cat hosts </span></span><br><span class="line">[test]</span><br><span class="line">10.4.7.101 dir=/root/node2</span><br><span class="line">10.4.7.102 dir=/root/node1</span><br><span class="line"></span><br><span class="line">[node1]</span><br><span class="line">10.4.7.100</span><br><span class="line"></span><br><span class="line">[test:vars]</span><br><span class="line">file=hostname.txt</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook -i hosts  playbook.yml </span></span><br><span class="line"></span><br><span class="line">PLAY [test] *************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101]</span><br><span class="line">ok: [10.4.7.102]</span><br><span class="line"></span><br><span class="line">TASK [test : create directory] ******************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101]</span><br><span class="line">ok: [10.4.7.102]</span><br><span class="line"></span><br><span class="line">TASK [test : Get IP Address] ********************************************************************************************************************</span><br><span class="line">changed: [10.4.7.102]</span><br><span class="line">changed: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">10.4.7.102                 : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure><h4 id="2-8-使用Facts获取的信息"><a href="#2-8-使用Facts获取的信息" class="headerlink" title="2.8 使用Facts获取的信息"></a>2.8 使用Facts获取的信息</h4><p>还有其它地方可以获取变量, 这些变量是自动发现的，而不是用户自己设置的。Facts通过访问远程系统获取相应的信息，一个很好的例子就是远程主机的IP地址或者操作系统是什么。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible <span class="built_in">test</span> -m setup</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用以下命令可以查看哪些信息是可用的（<span class="built_in">test</span>是上面在/etc/ansible/hosts列表文件中配置的主机群组）</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible <span class="built_in">test</span> -m setup|grep <span class="string">"ansible_python_version"</span></span></span><br><span class="line">        "ansible_python_version": "2.7.5", </span><br><span class="line"><span class="meta">#</span><span class="bash"> 在playbook中这样引用上面被控制主机的python版本: &#123;&#123; ansible_python_version &#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible <span class="built_in">test</span> -m setup|grep <span class="string">"ansible_nodename"</span></span></span><br><span class="line">        "ansible_nodename": "template", </span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以在playbook中这样引用上面被控制主机的主机名: &#123;&#123; ansible_nodename &#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible <span class="built_in">test</span> -m setup | grep <span class="string">"ansible_hostname"</span></span></span><br><span class="line">        "ansible_hostname": "template",</span><br><span class="line"><span class="meta">#</span><span class="bash"> 被控制主机的主机名变量还可以是: &#123;&#123; ansible_hostname &#125;&#125;</span></span><br></pre></td></tr></table></figure><p>如果关闭Facts，可以大大提高ansible的执行速度 ，关闭方法如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat anhui.yml</span></span><br><span class="line">---</span><br><span class="line">- hosts: test</span><br><span class="line">  gather_facts: no</span><br></pre></td></tr></table></figure><h4 id="2-9-register注册变量"><a href="#2-9-register注册变量" class="headerlink" title="2.9 register注册变量"></a>2.9 register注册变量</h4><p>变量的另一个主要用途是在运行命令时，把命令结果存储到一个变量中，不同模块的执行结果是不同的。运行playbook时使用-v选项可以看到可能的结果值，ansible执行任务的结果值可以保存在变量中，以便稍后使用它。register方式主要用于在task之间传递变量。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat /etc/ansible/hosts</span></span><br><span class="line">[test]</span><br><span class="line">10.4.7.101</span><br><span class="line">10.4.7.102</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat register.yml</span></span><br><span class="line">---</span><br><span class="line">- hosts: test</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">      - name: register bo_test</span><br><span class="line">        shell: hostname -I</span><br><span class="line">        register: info</span><br><span class="line">      - name: display info</span><br><span class="line">        debug: msg="this host ip is &#123;&#123; info['stdout'] &#125;&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook register.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [test] *************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **************************************************************************************************</span><br><span class="line">ok: [10.4.7.102]</span><br><span class="line">ok: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">TASK [register bo_test] *************************************************************************************************</span><br><span class="line">changed: [10.4.7.102]</span><br><span class="line">changed: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">TASK [display info] *****************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; &#123;</span><br><span class="line">    "msg": "this host ip is 10.4.7.101 "</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.4.7.102] =&gt; &#123;</span><br><span class="line">    "msg": "this host ip is 10.4.7.102 "</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line">10.4.7.102                 : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure><h4 id="2-10-hostvars-变量"><a href="#2-10-hostvars-变量" class="headerlink" title="2.10 hostvars 变量"></a>2.10 hostvars 变量</h4><p>该变量用于引用其他主机上收集的facts中的数据，或者引用其他主机的主机变量、主机组变量。即从一台远程主机获取另一台远程主机的变量。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat /etc/ansible/hosts</span></span><br><span class="line">[test]</span><br><span class="line">10.4.7.101 addr=beijing</span><br><span class="line">10.4.7.102 user=shibo age=39</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">---</span><br><span class="line">- hosts: test</span><br><span class="line">  remote_user: root</span><br><span class="line">  gather_facts: False</span><br><span class="line">  tasks:</span><br><span class="line">    - name: this is test1</span><br><span class="line">      debug: msg="She is come from &#123;&#123; hostvars['10.4.7.101']['addr'] &#125;&#125;"</span><br><span class="line">    - name: this is test2</span><br><span class="line">      debug: msg="I am &#123;&#123; hostvars['10.4.7.102']['user'] &#125;&#125;, and age is &#123;&#123; hostvars['10.4.7.102']['age'] &#125;&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [test] *************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [this is test1] ****************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; &#123;</span><br><span class="line">    "msg": "She is come from beijing"</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.4.7.102] =&gt; &#123;</span><br><span class="line">    "msg": "She is come from beijing"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [this is test2] ****************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; &#123;</span><br><span class="line">    "msg": "I am shibo, and age is 39"</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.4.7.102] =&gt; &#123;</span><br><span class="line">    "msg": "I am shibo, and age is 39"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line">10.4.7.102                 : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure><h4 id="2-11-列表变量、循环变量、字典变量"><a href="#2-11-列表变量、循环变量、字典变量" class="headerlink" title="2.11 列表变量、循环变量、字典变量"></a>2.11 列表变量、循环变量、字典变量</h4><p><strong>1）ansible的变量不仅可以是单个的值，也可以为列表，即ansible传列表作为变量</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">---</span><br><span class="line">- hosts: test</span><br><span class="line">  remote_user: root</span><br><span class="line">  gather_facts: False</span><br><span class="line">  vars:</span><br><span class="line">    - list: [1,2,3]</span><br><span class="line">  tasks:</span><br><span class="line">    - name: echo</span><br><span class="line">      debug: msg="&#123;&#123; list &#125;&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [test] *************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [echo] *************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; &#123;</span><br><span class="line">    "msg": [</span><br><span class="line">        1,</span><br><span class="line">        2,</span><br><span class="line">        3</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.4.7.102] =&gt; &#123;</span><br><span class="line">    "msg": [</span><br><span class="line">        1,</span><br><span class="line">        2,</span><br><span class="line">        3</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line">10.4.7.102                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=</span><br></pre></td></tr></table></figure><p><strong>2）循环列表</strong></p><p>结合循环，这个特性就变得很有用；以参数传递列表给playbook，不用在playbook中固定循环的次数与内容。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">---</span><br><span class="line">- hosts: 10.4.7.101</span><br><span class="line">  remote_user: root</span><br><span class="line">  gather_facts: False</span><br><span class="line">  vars:</span><br><span class="line">    - list: [1,2,3]</span><br><span class="line">  tasks:</span><br><span class="line">    - name: this is loop</span><br><span class="line">      debug: msg="&#123;&#123; item &#125;&#125;"</span><br><span class="line">      with_items: '&#123;&#123;list&#125;&#125;'</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [10.4.7.101] *******************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [this is loop] *****************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; (item=1) =&gt; &#123;</span><br><span class="line">    "msg": 1</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.4.7.101] =&gt; (item=2) =&gt; &#123;</span><br><span class="line">    "msg": 2</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.4.7.101] =&gt; (item=3) =&gt; &#123;</span><br><span class="line">    "msg": 3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure><p><strong><strong><strong>***</strong></strong></strong> 当你发现自己的才华撑不起野心时，就请安静下来学习吧！<strong><strong><strong>***</strong></strong></strong></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;原文链接：&lt;a href=&quot;https://www.cnblogs.com/lvzhenjiang/p/14385777.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.cnblogs.com/lvzhenjiang/p/1
      
    
    </summary>
    
    
      <category term="ansible" scheme="http://yoursite.com/categories/ansible/"/>
    
    
      <category term="ansible" scheme="http://yoursite.com/tags/ansible/"/>
    
  </entry>
  
  <entry>
    <title>ansible中template简单使用</title>
    <link href="http://yoursite.com/2021/05/14/ansible/ansible%E4%B8%ADtemplate%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/"/>
    <id>http://yoursite.com/2021/05/14/ansible/ansible%E4%B8%ADtemplate%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/</id>
    <published>2021-05-14T04:45:10.569Z</published>
    <updated>2021-05-14T04:45:10.562Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ansible中template简单使用"><a href="#ansible中template简单使用" class="headerlink" title="ansible中template简单使用"></a><a href="https://www.cnblogs.com/lvzhenjiang/p/14199384.html" target="_blank" rel="noopener">ansible中template简单使用</a></h1><p>目录</p><ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199384.html#一、模板（template）简介" target="_blank" rel="noopener">一、模板（template）简介</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199384.html#二、使用template部署nginx" target="_blank" rel="noopener">二、使用template部署nginx</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199384.html#三、playbook中when简单使用" target="_blank" rel="noopener">三、playbook中when简单使用</a></li><li>四、playbook中with_items简单使用<ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199384.html#41-迭代：with_items" target="_blank" rel="noopener">4.1 迭代：with_items</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199384.html#42-迭代嵌套子变量" target="_blank" rel="noopener">4.2 迭代嵌套子变量</a></li></ul></li><li>五、template循环示例<ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199384.html#51-第一种写法" target="_blank" rel="noopener">5.1 第一种写法</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199384.html#52-第二种写法" target="_blank" rel="noopener">5.2 第二种写法</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199384.html#53-第三种写法" target="_blank" rel="noopener">5.3 第三种写法</a></li></ul></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199384.html#六、playbook中if简单使用" target="_blank" rel="noopener">六、playbook中if简单使用</a></li></ul><h3 id="一、模板（template）简介"><a href="#一、模板（template）简介" class="headerlink" title="一、模板（template）简介"></a>一、模板（template）简介</h3><ul><li>文件文件，嵌套有脚本（使用模板编程语言编写）；</li><li>jinja2语言，使用字面量，有以下形式：<ul><li>字符串：使用单引号或双引号；</li><li>数字：整数，浮点数；</li><li>列表：[ item1,item2,……]</li><li>元组：(item1,item2,……)</li><li>字典：{key1:value1,key2,value2,……}</li><li>布尔型：true/false</li></ul></li><li>算术运算：+，-，<em>，/，//，%，*</em></li><li>比较操作：==，!=，&gt;，&gt;=，&lt;，&lt;=</li><li>逻辑运算：and，or，not</li><li>流表达式：for，if，when</li></ul><h3 id="二、使用template部署nginx"><a href="#二、使用template部署nginx" class="headerlink" title="二、使用template部署nginx"></a>二、使用template部署nginx</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ls     //建议，安装nginx的yaml和templates目录在同一目录下</span></span><br><span class="line">install_nginx.yaml  templates</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat install_nginx.yaml </span></span><br><span class="line">---</span><br><span class="line">- hosts: webservers</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:         #创建变量信息</span><br><span class="line">    - http_port: 8888</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: install package</span><br><span class="line">      yum: name=nginx</span><br><span class="line">    - name: template copy</span><br><span class="line">      template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf   #由于模板文件在tmplate下，所以src后的路径就可以只写配置文件名称</span><br><span class="line">      notify: restart service    #定义notify便于修改文件重启服务</span><br><span class="line">    - name: start service</span><br><span class="line">      service: name=nginx state=started enabled=yes</span><br><span class="line"></span><br><span class="line">  handlers:    #定义重启服务策略</span><br><span class="line">    - name: restart service</span><br><span class="line">      service: name=nginx state=restarted</span><br><span class="line"><span class="meta">$</span><span class="bash"> ls templates/     <span class="comment">#注意模板的文件名称有一定的要求</span></span></span><br><span class="line">nginx.conf.j2</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat templates/nginx.conf.j2    <span class="comment">#该文件就是nginx的配置文件复制而成的</span></span></span><br><span class="line">…………      #省略部分内容</span><br><span class="line">worker_processes &#123;&#123; ansible_processor_vcpus**2 &#125;&#125;;    #使用变量是cpu核心数的2次方</span><br><span class="line">listen       &#123;&#123; http_port &#125;&#125; default_server;</span><br><span class="line">listen       [::]:&#123;&#123; http_port &#125;&#125; default_server;</span><br><span class="line"><span class="meta">#</span><span class="bash">使用playbook中定义的变量信息</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook install_nginx.yaml</span></span><br><span class="line"><span class="meta">#</span><span class="bash">运行playbook文件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible webservers -m shell -a <span class="string">'rpm -q nginx'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">nginx确实已经安装成功</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible webservers -m shell -a <span class="string">'ss -lnt | grep 8888'</span> </span></span><br><span class="line"><span class="meta">#</span><span class="bash">端口已经正常开启</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible webservers -m shell -a <span class="string">'ps aux | grep nginx'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">确认工作进程数是预期设定的值</span></span><br></pre></td></tr></table></figure><p>至此template批量部署nginx已经实现！</p><h3 id="三、playbook中when简单使用"><a href="#三、playbook中when简单使用" class="headerlink" title="三、playbook中when简单使用"></a>三、playbook中when简单使用</h3><p><strong>when</strong>：可以简单理解为一个条件判断，类似于shell脚本中的if语句！</p><p>因为ansible管理的主机可能不是一个系统版本的，那么就需要区别部署了！</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible all -m setup -a <span class="string">'filter=*distribution*'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">查看ansible默认支持的变量</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat install_nginx.yaml </span></span><br><span class="line">---</span><br><span class="line">- hosts: all     #针对所有主机</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    - http_port: 8888</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: install package</span><br><span class="line">      yum: name=nginx</span><br><span class="line">    - name: template copy for centos7</span><br><span class="line">      template: src=nginx.conf7.j2 dest=/etc/nginx/nginx.conf</span><br><span class="line">      when: ansible_distribution_major_version == "7"    #当检测到系统版本为7才执行本模块的操作</span><br><span class="line">      notify: restart service</span><br><span class="line">    - name: template copy for centos6</span><br><span class="line">      template: src=nginx.conf6.j2 dest=/etc/nginx/nginx.conf</span><br><span class="line">      when: ansible_distribution_major_version == "6"</span><br><span class="line">      notify: restart service</span><br><span class="line">    - name: start service</span><br><span class="line">      service: name=nginx state=started enabled=yes</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">    - name: restart service</span><br><span class="line">      service: name=nginx state=restarted</span><br><span class="line"><span class="meta">$</span><span class="bash"> ls templates/   <span class="comment">#注意一个是nginx6的配置文件，一个nginx7的配置文件</span></span></span><br><span class="line">nginx.conf6.j2  nginx.conf7.j2</span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook install_nginx.yaml</span></span><br><span class="line"><span class="meta">#</span><span class="bash">执行playbook文件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible all -m shell -a <span class="string">'ss -lntp | grep nginx'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">确认centos 6系统的nginx已经启动</span></span><br></pre></td></tr></table></figure><h3 id="四、playbook中with-items简单使用"><a href="#四、playbook中with-items简单使用" class="headerlink" title="四、playbook中with_items简单使用"></a>四、playbook中with_items简单使用</h3><h4 id="4-1-迭代：with-items"><a href="#4-1-迭代：with-items" class="headerlink" title="4.1 迭代：with_items"></a>4.1 迭代：with_items</h4><p><strong>迭代：with_items</strong>：当有需要重复性执行任务是，可以使用迭代机制！</p><ul><li>带迭代项的引用，固定变量为“item”；</li><li>在task中使用with_items定义需要迭代的元素列表；</li><li>列表格式：<ul><li>字符串；</li><li>字典；</li></ul></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test.yaml </span></span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: touch some file</span><br><span class="line">      file: name=/data/&#123;&#123; item &#125;&#125; state=touch   #文件名定义为列表元素</span><br><span class="line">      when: ansible_distribution_major_version == "7"</span><br><span class="line">      with_items:      #定义列表元素</span><br><span class="line">        - file1</span><br><span class="line">        - file2</span><br><span class="line">        - file3</span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible all -m shell -a <span class="string">'ls -l /data'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">当满足条件的主机都创建了文件</span></span><br></pre></td></tr></table></figure><h4 id="4-2-迭代嵌套子变量"><a href="#4-2-迭代嵌套子变量" class="headerlink" title="4.2 迭代嵌套子变量"></a>4.2 迭代嵌套子变量</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test1.yaml </span></span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: create some group</span><br><span class="line">      group: name=&#123;&#123; item &#125;&#125;</span><br><span class="line">      with_items:</span><br><span class="line">        - g1</span><br><span class="line">        - g2</span><br><span class="line">        - g3</span><br><span class="line">    - name: create some users</span><br><span class="line">      user: name=&#123;&#123; item.name &#125;&#125; group=&#123;&#123; item.group &#125;&#125;</span><br><span class="line">      with_items:</span><br><span class="line">        - &#123; name: 'user1', group: 'g1'&#125;</span><br><span class="line">        - &#123; name: 'user2', group: 'g2'&#125;</span><br><span class="line">        - &#123; name: 'user3', group: 'g3'&#125;</span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test1.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible all -m shell -a <span class="string">'getent group'</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible all -m shell -a <span class="string">'getent passwd'</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible all -m shell -a <span class="string">'id user1'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">进行验证</span></span><br></pre></td></tr></table></figure><h3 id="五、template循环示例"><a href="#五、template循环示例" class="headerlink" title="五、template循环示例"></a>五、template循环示例</h3><h4 id="5-1-第一种写法"><a href="#5-1-第一种写法" class="headerlink" title="5.1 第一种写法"></a>5.1 第一种写法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test2.yaml </span></span><br><span class="line">---</span><br><span class="line">- hosts: webservers</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    ports:</span><br><span class="line">      - 81</span><br><span class="line">      - 82</span><br><span class="line">      - 83</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: copy conf</span><br><span class="line">      template: src=for2.conf.j2 dest=/data/for2.conf</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat templates/for2.conf.j2 </span></span><br><span class="line">&#123;% for port in ports %&#125;</span><br><span class="line">server &#123;</span><br><span class="line">listen &#123;&#123; port &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test2.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible webservers -m shell -a <span class="string">'cat /data/for2.conf'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">进行验证</span></span><br></pre></td></tr></table></figure><h4 id="5-2-第二种写法"><a href="#5-2-第二种写法" class="headerlink" title="5.2 第二种写法"></a>5.2 第二种写法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test3.yaml </span></span><br><span class="line">---</span><br><span class="line">- hosts: webservers</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    ports:</span><br><span class="line">      - listen_port: 81</span><br><span class="line">      - listen_port: 82</span><br><span class="line">      - listen_port: 83</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: copy conf</span><br><span class="line">      template: src=for3.conf.j2 dest=/data/for3.conf</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat templates/for3.conf.j2 </span></span><br><span class="line">&#123;% for port in ports %&#125;</span><br><span class="line">server &#123;</span><br><span class="line">listen &#123;&#123; port.listen_port &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test3.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible webservers -m shell -a <span class="string">'cat /data/for3.conf'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">进行验证</span></span><br></pre></td></tr></table></figure><h4 id="5-3-第三种写法"><a href="#5-3-第三种写法" class="headerlink" title="5.3 第三种写法"></a>5.3 第三种写法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test4.yaml </span></span><br><span class="line">---</span><br><span class="line">- hosts: webservers</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    ports:</span><br><span class="line">      - web1:</span><br><span class="line">        port: 81</span><br><span class="line">        name: web1.lzj.com</span><br><span class="line">        rootdir: /data/web1</span><br><span class="line">      - web2:</span><br><span class="line">        port: 82</span><br><span class="line">        name: web2.lzj.com</span><br><span class="line">        rootdir: /data/web2</span><br><span class="line">      - web1:</span><br><span class="line">        port: 83</span><br><span class="line">        name: web3.lzj.com</span><br><span class="line">        rootdir: /data/web3</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: copy conf</span><br><span class="line">      template: src=for4.conf.j2 dest=/data/for4.conf</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat templates/for4.conf.j2 </span></span><br><span class="line">&#123;% for p in ports %&#125;</span><br><span class="line">server &#123;</span><br><span class="line">listen &#123;&#123; p.port &#125;&#125;</span><br><span class="line">servername &#123;&#123; p.name &#125;&#125;</span><br><span class="line">documentroot &#123;&#123; p.rootdir &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test4.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible webservers -m shell -a <span class="string">'cat /data/for4.conf'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">进行验证</span></span><br></pre></td></tr></table></figure><h3 id="六、playbook中if简单使用"><a href="#六、playbook中if简单使用" class="headerlink" title="六、playbook中if简单使用"></a>六、playbook中if简单使用</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test5.yaml </span></span><br><span class="line">---</span><br><span class="line">- hosts: webservers</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    ports:</span><br><span class="line">      - web1:</span><br><span class="line">        port: 81</span><br><span class="line">        rootdir: /data/web1</span><br><span class="line">      - web2:</span><br><span class="line">        port: 82</span><br><span class="line">        name: web2.lzj.com</span><br><span class="line">        rootdir: /data/web2</span><br><span class="line">      - web1:</span><br><span class="line">        port: 83</span><br><span class="line">        rootdir: /data/web3</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: copy conf</span><br><span class="line">      template: src=for5.conf.j2 dest=/data/for5.conf</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat templates/for5.conf.j2 </span></span><br><span class="line">&#123;% for p in ports %&#125;</span><br><span class="line">server &#123;</span><br><span class="line">listen &#123;&#123; p.port &#125;&#125;</span><br><span class="line">&#123;% if p.name is defined%&#125;    #如果名称被定义了才给名字赋值</span><br><span class="line">servername &#123;&#123; p.name &#125;&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">documentroot &#123;&#123; p.rootdir &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test5.yaml  </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible webservers -m shell -a <span class="string">'cat /data/for5.conf'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">进行验证</span></span><br></pre></td></tr></table></figure><p><strong><strong><strong>***</strong></strong></strong> 当你发现自己的才华撑不起野心时，就请安静下来学习吧！<strong><strong><strong>***</strong></strong></strong></p><p>原文链接：<a href="https://www.cnblogs.com/lvzhenjiang/p/14199384.html" target="_blank" rel="noopener">https://www.cnblogs.com/lvzhenjiang/p/14199384.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;ansible中template简单使用&quot;&gt;&lt;a href=&quot;#ansible中template简单使用&quot; class=&quot;headerlink&quot; title=&quot;ansible中template简单使用&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://www.cnblo
      
    
    </summary>
    
    
      <category term="ansible" scheme="http://yoursite.com/categories/ansible/"/>
    
    
      <category term="ansible" scheme="http://yoursite.com/tags/ansible/"/>
    
  </entry>
  
  <entry>
    <title>ansible之roles简单使用</title>
    <link href="http://yoursite.com/2021/05/14/ansible/ansible%E4%B9%8Broles%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/"/>
    <id>http://yoursite.com/2021/05/14/ansible/ansible%E4%B9%8Broles%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/</id>
    <published>2021-05-14T04:44:28.119Z</published>
    <updated>2021-05-14T04:44:28.111Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ansible之roles简单使用"><a href="#ansible之roles简单使用" class="headerlink" title="ansible之roles简单使用"></a><a href="https://www.cnblogs.com/lvzhenjiang/p/14199463.html" target="_blank" rel="noopener">ansible之roles简单使用</a></h1><p>目录</p><ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199463.html#一、roles简介" target="_blank" rel="noopener">一、roles简介</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199463.html#二、简单的roles示例" target="_blank" rel="noopener">二、简单的roles示例</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199463.html#三、roles示例二" target="_blank" rel="noopener">三、roles示例二</a></li></ul><h3 id="一、roles简介"><a href="#一、roles简介" class="headerlink" title="一、roles简介"></a>一、roles简介</h3><p>将多种不同的tasks的文件集中存储在某个目录下，则该目录就是角色，角色一般存放在/etc/ansible/roles/目录下，可通过ansible的配置文件来调整默认的角色目录，/etc/ansible/roles/目录下有很多子目录，其中每一个子目录对应一个角色，每个角色也有自己的目录结构，如图：</p><p><img src="https://gitee.com/lvzhenjiang/document/raw/master/%E5%B0%8F%E4%B9%A6%E5%8C%A0/20200322142808.png" alt="20200322142808"></p><p>每个角色的定义，以特定的层级目录结构进行组织。比如：</p><ul><li>files：存放有copy或script等模块调用的文件；</li><li>templates：存放template模块查找所需要的模板文件的目录；</li><li>tasks：任务存放的目录；</li><li>handlers：存放相关触发执行器的目录；</li><li>vars：变量存放的目录；</li><li>meta：用于存放此角色元数据；</li><li>default：默认变量存放的目录，文件中定义了此角色使用的默认变量；</li></ul><p>上述目录中，tasks、handlers、vars、meta、default至少应该包含一个main.yaml文件，该目录下也可由其他.yaml文件，但是需要在main.yml文件中用include指令将其他.yml文件包含起来。</p><h3 id="二、简单的roles示例"><a href="#二、简单的roles示例" class="headerlink" title="二、简单的roles示例"></a>二、简单的roles示例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir roles   </span></span><br><span class="line"><span class="meta">#</span><span class="bash">创建一个目录，名称为roles。官方推荐在/etc/ansible/roles/这个目录，不过在哪里都是可以的</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir roles/nginx</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> roles/nginx/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir tasks templates</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> tasks/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat user.yaml </span></span><br><span class="line">- name: create user</span><br><span class="line">  user: name=nginx uid=80 group=nginx system=yes shell=/sbin/nologin</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat group.yaml </span></span><br><span class="line">- name: create group</span><br><span class="line">  group: name=nginx gid=80</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat yum.yaml </span></span><br><span class="line">- name: install package</span><br><span class="line">  yum: name=nginx</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat templ.yaml </span></span><br><span class="line">- name: copy conf</span><br><span class="line">  template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf </span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat stservice.yaml </span></span><br><span class="line">- name: start service</span><br><span class="line">  service: name=nginx state=started enabled=yes</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat main.yaml </span></span><br><span class="line">- include: group.yaml</span><br><span class="line">- include: user.yaml</span><br><span class="line">- include: yum.yaml</span><br><span class="line">- include: templ.yaml</span><br><span class="line">- include: stservice.yaml</span><br><span class="line"><span class="meta">#</span><span class="bash">如果需要调用别的角色的yaml文件，也可以这样写，比如：- include：roles/httpd/tasks/copyfile.yaml</span></span><br><span class="line">注意：copyfiile.yaml文件中的源路径必须是绝对路径</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls</span></span><br><span class="line">nginx.conf.j2</span><br><span class="line"><span class="meta">#</span><span class="bash">该文件就是nginx的配置文件改名了而已</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ../../../</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat nginx.yaml </span></span><br><span class="line">- hosts: webservers</span><br><span class="line">  remote_user: root</span><br><span class="line">  roles:</span><br><span class="line">    - role: nginx    </span><br><span class="line"><span class="meta">#</span><span class="bash">定义了多个角色，也可在接着写，每行调用一个角色</span></span><br><span class="line"><span class="meta">#</span><span class="bash">也可以定义tags标签，比如：- &#123; roles： httpd ，tags：[<span class="string">'web'</span>,<span class="string">'httpd'</span>]&#125;或- &#123; roles： httpd ，tags：<span class="string">'web'</span>  如果需要加when语句，在此处添加 &#125;都可以</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls</span></span><br><span class="line">nginx.yaml  roles</span><br><span class="line"><span class="meta">#</span><span class="bash">确保调用nginx的yaml文件是和roles是在同一目录下的</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tree</span></span><br><span class="line">.</span><br><span class="line">├── nginx.yaml</span><br><span class="line">└── roles</span><br><span class="line">    └── nginx</span><br><span class="line">        ├── tasks</span><br><span class="line">        │   ├── group.yaml</span><br><span class="line">        │   ├── main.yaml</span><br><span class="line">        │   ├── reservice.yaml</span><br><span class="line">        │   ├── stservice.yaml</span><br><span class="line">        │   ├── templ.yaml</span><br><span class="line">        │   ├── user.yaml</span><br><span class="line">        │   └── yum.yaml</span><br><span class="line">        └── templates</span><br><span class="line">            └── nginx.conf.j2</span><br><span class="line"><span class="meta">#</span><span class="bash">确保目录的层次效果是这样的</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook nginx.yaml </span></span><br><span class="line"><span class="meta">#</span><span class="bash">如果定义了标签，就可对标签进行操作（比如：web或httpd）</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible webservers -m shell -a <span class="string">'ss -lntp | grep nginx'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">确认被控端的主机nginx已经启动</span></span><br></pre></td></tr></table></figure><p>一个简单的nginx的roles已经编写完成了！</p><h3 id="三、roles示例二"><a href="#三、roles示例二" class="headerlink" title="三、roles示例二"></a>三、roles示例二</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir app</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> app/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir tasks templates vars handlers files</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> tasks/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat group.yaml </span></span><br><span class="line">- name: create group</span><br><span class="line">  group: name=apache system=yes</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat user.yaml </span></span><br><span class="line">- name: create user</span><br><span class="line">  user: name=apache group=apache system=yes shell=/sbin/nologin</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat yum.yaml </span></span><br><span class="line">- name: install package</span><br><span class="line">  yum: name=httpd</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat templ.yaml </span></span><br><span class="line">- name: copy file</span><br><span class="line">  template: src=httpd.conf.j2 dest=/etc/httpd/httpd.conf</span><br><span class="line">  notify: restart service</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat copyfile.yaml </span></span><br><span class="line">- name: copy config</span><br><span class="line">  copy: src=vhosts.conf dest=/etc/httpd/conf.d/ owner=apache</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat start.yaml </span></span><br><span class="line">- name: start service</span><br><span class="line">  service: name=httpd state=started</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat main.yaml </span></span><br><span class="line">- include: group.yaml</span><br><span class="line">- include: user.yaml</span><br><span class="line">- include: yum.yaml</span><br><span class="line">- include: templ.yaml</span><br><span class="line">- include: copyfile.yaml</span><br><span class="line">- include: start.yaml</span><br><span class="line"><span class="meta">$</span><span class="bash"> ls files/vhosts.conf </span></span><br><span class="line">files/vhosts.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">空文件用于测试</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat handlers/main.yaml </span></span><br><span class="line">- name: restart service</span><br><span class="line">  service: name=httpd state=restarted</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat templates/httpd.conf.j2 </span></span><br><span class="line"><span class="meta">#</span><span class="bash">httpd的配置文件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat vars/main.yaml </span></span><br><span class="line">username: apache</span><br><span class="line">groupname: apache</span><br><span class="line"><span class="meta">$</span><span class="bash"> tree</span></span><br><span class="line">.</span><br><span class="line">├── files</span><br><span class="line">│   └── vhosts.conf</span><br><span class="line">├── handlers</span><br><span class="line">│   └── main.yaml</span><br><span class="line">├── tasks</span><br><span class="line">│   ├── copyfile.yaml</span><br><span class="line">│   ├── group.yaml</span><br><span class="line">│   ├── main.yaml</span><br><span class="line">│   ├── start.yaml</span><br><span class="line">│   ├── templ.yaml</span><br><span class="line">│   ├── user.yaml</span><br><span class="line">│   └── yum.yaml</span><br><span class="line">├── templates</span><br><span class="line">│   └── httpd.conf.j2</span><br><span class="line">└── vars</span><br><span class="line">    └── main.yaml</span><br><span class="line"><span class="meta">#</span><span class="bash">目录结构</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat httpd.yaml </span></span><br><span class="line">---</span><br><span class="line">- hosts: webservers</span><br><span class="line">  remote_user: root</span><br><span class="line">  roles:</span><br><span class="line">    - httpd</span><br><span class="line"><span class="meta">$</span><span class="bash"> ls</span></span><br><span class="line">httpd.yaml  nginx.yaml  roles</span><br><span class="line"><span class="meta">#</span><span class="bash">确保与roles目录在同一目录下</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook httpd.yaml </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible all -m shell -a <span class="string">'ps -ef | grep apache'</span></span></span><br><span class="line">//根据配置文件中修改的内容自行进行修改</span><br></pre></td></tr></table></figure><p><strong><strong><strong>***</strong></strong></strong> 当你发现自己的才华撑不起野心时，就请安静下来学习吧！<strong><strong><strong>***</strong></strong></strong></p><p>原文链接：<a href="https://www.cnblogs.com/lvzhenjiang/p/14199463.html" target="_blank" rel="noopener">https://www.cnblogs.com/lvzhenjiang/p/14199463.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;ansible之roles简单使用&quot;&gt;&lt;a href=&quot;#ansible之roles简单使用&quot; class=&quot;headerlink&quot; title=&quot;ansible之roles简单使用&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://www.cnblogs.com/lv
      
    
    </summary>
    
    
      <category term="ansible" scheme="http://yoursite.com/categories/ansible/"/>
    
    
      <category term="ansible" scheme="http://yoursite.com/tags/ansible/"/>
    
  </entry>
  
  <entry>
    <title>Ansible性能优化——提升ansible执行效率</title>
    <link href="http://yoursite.com/2021/05/14/ansible/Ansible%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E2%80%94%E2%80%94%E6%8F%90%E5%8D%87ansible%E6%89%A7%E8%A1%8C%E6%95%88%E7%8E%87/"/>
    <id>http://yoursite.com/2021/05/14/ansible/Ansible%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E2%80%94%E2%80%94%E6%8F%90%E5%8D%87ansible%E6%89%A7%E8%A1%8C%E6%95%88%E7%8E%87/</id>
    <published>2021-05-14T04:43:01.781Z</published>
    <updated>2021-05-14T04:43:01.775Z</updated>
    
    <content type="html"><![CDATA[<p>原文链接：<a href="https://www.cnblogs.com/lvzhenjiang/p/14386197.html" target="_blank" rel="noopener">https://www.cnblogs.com/lvzhenjiang/p/14386197.html</a></p><h1 id="Ansible性能优化——提升ansible执行效率"><a href="#Ansible性能优化——提升ansible执行效率" class="headerlink" title="Ansible性能优化——提升ansible执行效率"></a><a href="https://www.cnblogs.com/lvzhenjiang/p/14386197.html" target="_blank" rel="noopener">Ansible性能优化——提升ansible执行效率</a></h1><p>目录</p><ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14386197.html#一、关闭gathering-facts功能" target="_blank" rel="noopener">一、关闭gathering facts功能</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14386197.html#二、开启ssh-pipelining" target="_blank" rel="noopener">二、开启SSH pipelining</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14386197.html#三、开启ssh长连接" target="_blank" rel="noopener">三、开启SSH长连接</a></li><li>三、设置facts缓存<ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14386197.html#31-使用json文件缓存" target="_blank" rel="noopener">3.1 使用json文件缓存</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14386197.html#32-使用redis存储facts文件需安装redis，还需要安装python库" target="_blank" rel="noopener">3.2 使用redis存储facts文件需安装redis，还需要安装python库</a></li></ul></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14386197.html#四、ansible取消交互" target="_blank" rel="noopener">四、Ansible取消交互</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14386197.html#五、ansible的-t选项，提高ansible执行效率" target="_blank" rel="noopener">五、Ansible的-t选项，提高ansible执行效率</a></li></ul><p>最初，ansible的执行效率和saltstack(基于zeromq消息队列的方式)相比要慢的多的多，特别是被控节点量很大的时候。但是ansible发展到现在，它的效率得到了极大的改善。在被控节点不太多的时候，默认的设置已经够快。即使被控节点数量巨大的时候，也可以通过一些优化去极大的提高ansible的执行效率。所以在使用 Ansible 的过程中，当管理的服务器数量增加时，不得不面对一个无法避免的问题执行效率慢，这里列出一些解决办法。</p><h3 id="一、关闭gathering-facts功能"><a href="#一、关闭gathering-facts功能" class="headerlink" title="一、关闭gathering facts功能"></a>一、关闭gathering facts功能</h3><p>如果观察过ansible-playbook的执行过程，就会发现ansible-playbook的第1个步骤总是执行gather facts，不论你有没有在playbook设定这个tasks。<br>如果你不需要获取被控机器的fact数据的话，就可以关闭获取fact数据功能。关闭之后，可以加快ansible-playbook的执行效率，尤其是你管理很大量的机器时，这非常明显。<br>关闭获取facts很简单，只需要在playbook文件中加上<code>&quot;gather_facts: False&quot;</code> 或者 <code>&quot;gather_facts: No&quot;</code>即可（False和No都为小写也可以）。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">- hosts: test_server</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: this is a test</span><br><span class="line">      shell: echo "haha"</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行这个paly，会发现第一个执行的是gather facts，因为默认是打开gather facts功能的！！！！</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [test_server] ******************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **************************************************************************************************</span><br><span class="line">ok: [10.4.7.102]</span><br><span class="line">ok: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">TASK [this is a test] ***************************************************************************************************</span><br><span class="line">changed: [10.4.7.102]</span><br><span class="line">changed: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line">10.4.7.102                 : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure><p><strong>现在关闭gathering facts功能</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">- hosts: test_server</span><br><span class="line">  remote_user: root</span><br><span class="line">  gather_facts: False</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: this is a test</span><br><span class="line">      shell: echo "haha"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 再执行这个play，就会发现没有了gathering facts执行过程，整个执行速度也快了！</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [test_server] ******************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [this is a test] ***************************************************************************************************</span><br><span class="line">changed: [10.4.7.102]</span><br><span class="line">changed: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line">10.4.7.102                 : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure><h3 id="二、开启SSH-pipelining"><a href="#二、开启SSH-pipelining" class="headerlink" title="二、开启SSH pipelining"></a>二、开启SSH pipelining</h3><p>pipeline是openssh的一个特性，<code>ssh pipelining</code> 是一个加速Ansible执行速度的简单方法。</p><p>在ansible执行每个任务的整个流程中，有一个过程是将临时任务文件put到远程的ansible客户机上，然后通过<code>ssh</code>连接过去远程执行这个任务。<br>如果开启了pipelining，一个任务的所有动作都在一个<code>ssh</code>会话中完成，也会省去<code>sftp</code>到远端的过程，它会直接将要执行的任务在<code>ssh</code>会话中进行。</p><p>ssh``pipelining 默认是关闭!!!!之所以默认关闭是为了兼容不同的<code>sudo</code>配置，主要是 requiretty 选项。如果不使用<code>sudo</code>，建议开启！！！<br>打开此选项可以减少ansible执行没有传输时<code>ssh</code>在被控机器上执行任务的连接数。<br>不过，如果使用<code>sudo</code>，必须关闭requiretty选项。修改<code>/etc/ansible/ansible.cfg</code> 文件可以开启pipelining</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim /etc/ansible/ansible.cfg</span></span><br><span class="line">........</span><br><span class="line">pipelining = True</span><br></pre></td></tr></table></figure><p>这样开启了pipelining之后, ansible执行的整个流程就少了一个PUT脚本去远程服务端的流程，然后就可以批量对机器执行命令试下，可以明显感受到速度的提升。</p><hr><p>但是要注意的是：<br><strong>如果在ansible中使用<code>sudo</code>命令的话(<code>ssh user@host sudo cmd</code>)，需要在被控节点的<code>/etc/sudoers</code>中禁用<code>&quot;requiretty&quot;</code>!!!!</strong></p><p>之所以要设置<code>/etc/sudoers</code>中的requiretty，是因为<code>ssh</code>远程执行命令时，它的环境是非登录式非交互式shell，默认不会分配<code>tty</code>，没有<code>tty</code>，<code>ssh</code>的<code>sudo</code>就无法关闭密码回显(使用<br>“-tt”选项强制SSH分配<code>tty</code>)。所以出于安全考虑，<code>/etc/sudoers</code>中默认是开启requiretty的，它要求只有拥有<code>tty</code>的用户才能使用<code>sudo</code>，也就是说<code>ssh</code>连接过去不允许执行<code>sudo</code>。<br>可以通过visudo编辑配置文件，注释该选项来禁用它。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> grep requiretty /etc/sudoers　　</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Defaults  requiretty</span></span><br></pre></td></tr></table></figure><h3 id="三、开启SSH长连接"><a href="#三、开启SSH长连接" class="headerlink" title="三、开启SSH长连接"></a>三、开启SSH长连接</h3><p>ansible天然支持openssh，默认连接方式下，它对<code>ssh</code>的依赖性非常强。所以优化<code>ssh</code>连接，在一定程度上也在优化ansible。其中一点是开启<code>ssh</code>的长连接，即长时间保持连接状态。</p><p>Ansible模式是使用SSH和远程主机进行通信, 所以Ansible对SSH的依赖性非常强, 在OpenSSH 5.6版本以后SSH就支持了Multiplexing（多路复用）。<br>所以如果Ansible中控机的SSH -V版本高于5.6时, 就可以使用ControlPersist来提高<code>ssh</code>连接速度，从而提高ansible执行效率。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat /etc/redhat-release </span></span><br><span class="line">CentOS Linux release 7.6.1810 (Core) </span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ssh -V</span></span><br><span class="line">OpenSSH_7.4p1, OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim /etc/ansible/ansible.cfg</span></span><br><span class="line">..........</span><br><span class="line">ssh_args = -C -o ControlMaster=auto -o ControlPersist=5d</span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意：ConrolPersist=5d, 这个参数是设置整个长连接保持时间为5天。</span></span><br></pre></td></tr></table></figure><p>开启此参数的<code>ssh</code>长连接功能后，在会话过期前会一直建立连接，在<code>netstat</code>的结果中会看到<code>ssh</code>连接是一直established状态，且通过SSH连接过的设备都会在当前用户家目录的<br><code>&quot;.ansible/cp&quot;</code>目录下生成一个socket文件，每个会话对应生成一个socket文件。也可以通过<code>netstat</code>命令查看, 会发现有一个ESTABLISHED状态的连接一直与远程设备进行着TCP连接。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ps -ef|grep ssh|grep ansible</span></span><br><span class="line">root      26064      1  0 17:32 ?        00:00:00 ssh: /root/.ansible/cp/cb9972d2a5 [mux]</span><br><span class="line">root      26067      1  0 17:32 ?        00:00:00 ssh: /root/.ansible/cp/baefa88ac8 [mux]</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ps -ef|grep ssh|grep /root</span></span><br><span class="line">root      26064      1  0 17:32 ?        00:00:00 ssh: /root/.ansible/cp/cb9972d2a5 [mux]</span><br><span class="line">root      26067      1  0 17:32 ?        00:00:00 ssh: /root/.ansible/cp/baefa88ac8 [mux]</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls /root/.ansible/cp/</span></span><br><span class="line">baefa88ac8  cb9972d2a5</span><br></pre></td></tr></table></figure><p>需要注意：<br>ControlPersist 特性需要高版本的SSH才支持，CentOS 6默认是不支持的，如果需要使用，需要自行升级openssh（确保SSH -V版本高于5.6）。<br>ControlPersist即持久化socket，一次验证，多次通信。并且只需要修改 <code>ssh</code> 客户端就行，也就是 Ansible 机器即可。</p><h3 id="三、设置facts缓存"><a href="#三、设置facts缓存" class="headerlink" title="三、设置facts缓存"></a>三、设置facts缓存</h3><p>如果细心的话, 就会发现执行playbook的时候, 默认第一个task都是GATHERING FACTS, 这个过程就是Ansible在收集每台主机的facts信息。<br>方便我们在playbook中直接饮用facts里的信息，当然如果你的playbook中不需要facts信息, 可以在playbook中设置<code>&quot;gather_facts: False&quot;</code>来提高playbook效率.</p><p>但是如果我们既想在每次执行playbook的时候都能收集facts, 又想加速这个收集过程, 那么就需要配置facts缓存了。</p><h4 id="3-1-使用json文件缓存"><a href="#3-1-使用json文件缓存" class="headerlink" title="3.1 使用json文件缓存"></a>3.1 使用json文件缓存</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim /etc/ansible/ansible.cfg</span></span><br><span class="line">.........</span><br><span class="line">gathering = smart</span><br><span class="line">fact_caching_timeout = 86400</span><br><span class="line">fact_caching = jsonfile</span><br><span class="line">fact_caching_connection = /dev/shm/ansible_fact_cache</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 正常配置palybook，不需要关闭gathering facts功能</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml </span></span><br><span class="line">---</span><br><span class="line">- hosts: 10.4.7.101</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    - list: [1,2,3]</span><br><span class="line">  tasks:</span><br><span class="line">    - name: this is loop</span><br><span class="line">      debug: msg="&#123;&#123; item &#125;&#125;"</span><br><span class="line">      with_items: '&#123;&#123;list&#125;&#125;'</span><br><span class="line"></span><br><span class="line">查看这个playbook过程，用时6.699s（第一次可能稍微慢点，缓存之后，后面执行就很快了）</span><br><span class="line"><span class="meta">$</span><span class="bash"> time ansible-playbook test.yml </span></span><br><span class="line"></span><br><span class="line">PLAY [10.4.7.101] *******************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">TASK [this is loop] *****************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; (item=1) =&gt; &#123;</span><br><span class="line">    "msg": 1</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.4.7.101] =&gt; (item=2) =&gt; &#123;</span><br><span class="line">    "msg": 2</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.4.7.101] =&gt; (item=3) =&gt; &#123;</span><br><span class="line">    "msg": 3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">real0m6.699s</span><br><span class="line">user0m1.301s</span><br><span class="line">sys     0m0.250s</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果去掉上面的facts缓存的四行配置，再次执行上面的playbok，发现用时10s左右！！！</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看缓存文件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls /dev/shm/ansible_fact_cache/</span></span><br><span class="line">10.4.7.101</span><br></pre></td></tr></table></figure><h4 id="3-2-使用redis存储facts文件需安装redis，还需要安装python库"><a href="#3-2-使用redis存储facts文件需安装redis，还需要安装python库" class="headerlink" title="3.2 使用redis存储facts文件需安装redis，还需要安装python库"></a>3.2 使用redis存储facts文件需安装redis，还需要安装python库</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> yum install redis</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yum -y install epel-release</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yum install python-pip</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pip install redis</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim /etc/ansible/ansible.cfg</span></span><br><span class="line">........</span><br><span class="line">gathering = smart</span><br><span class="line">facts_caching_timeout = 86400      #设置缓存过期时间86400秒</span><br><span class="line">facts_caching = redis              # 使用redis或者 (或者使用memcached，即"facts_caching = memcached")</span><br><span class="line">fact_caching_connection = 127.0.0.1:6379</span><br><span class="line"><span class="meta">#</span><span class="bash">若redis设置了密码,比如密码为<span class="string">"admin"</span>，则配置修改如下：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> fact_caching_connection = localhost:6379:0:admin</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl start redis</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> lsof -i:6379</span></span><br><span class="line">COMMAND     PID  USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">redis-ser 26593 redis    4u  IPv4 125427      0t0  TCP localhost:6379 (LISTEN)</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> time ansible-playbook test.yml </span></span><br><span class="line"></span><br><span class="line">PLAY [10.4.7.101] *******************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">TASK [this is loop] *****************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; (item=1) =&gt; &#123;</span><br><span class="line">    "msg": 1</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.4.7.101] =&gt; (item=2) =&gt; &#123;</span><br><span class="line">    "msg": 2</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.4.7.101] =&gt; (item=3) =&gt; &#123;</span><br><span class="line">    "msg": 3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">real0m6.720s</span><br><span class="line">user0m1.219s</span><br><span class="line">sys    0m0.338s</span><br><span class="line"></span><br><span class="line">需要注意：</span><br><span class="line">在使用redis缓存后，如果出现异常（若未出现，请忽略）：TypeError: the JSON object must be str, not 'bytes'。</span><br><span class="line">解决办法：</span><br><span class="line"><span class="meta">$</span><span class="bash"> find / -name ansible</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim /usr/lib/python2.7/site-packages/ansible/plugins/cache/redis.py</span></span><br><span class="line">..........</span><br><span class="line">self._cache[key] = json.loads(value.decode('utf-8'))     # 修改为这个</span><br><span class="line">    </span><br><span class="line">查看redis存储情况</span><br><span class="line"><span class="meta">$</span><span class="bash"> redis-cli</span></span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) "ansible_facts10.4.7.101"</span><br><span class="line">2) "ansible_cache_keys"</span><br></pre></td></tr></table></figure><p>总之：不同网络环境下的耗时肯定是不同的，但是设置缓存是肯定可以加快 Ansible 运行速度的，特别是 playbook 的运行。</p><h3 id="四、Ansible取消交互"><a href="#四、Ansible取消交互" class="headerlink" title="四、Ansible取消交互"></a>四、Ansible取消交互</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim /etc/ansible/ansible.cfg</span></span><br><span class="line">........</span><br><span class="line">host_key_checking = False          # 打开注释即可</span><br><span class="line">    </span><br><span class="line"><span class="meta">#</span><span class="bash"> 取消ssh的yes和no的交互：</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim /root/.ssh/config</span></span><br><span class="line">UserKnownHostsFile /dev/null</span><br><span class="line">ConnectTimeout 15</span><br><span class="line">StrictHostKeyChecking no</span><br><span class="line">    </span><br><span class="line">或者直接ssh时增加一个参数</span><br><span class="line"><span class="meta">$</span><span class="bash"> ssh -o StrictHostKeyChecking=no -p22 root@10.4.7.101</span></span><br></pre></td></tr></table></figure><h3 id="五、Ansible的-t选项，提高ansible执行效率"><a href="#五、Ansible的-t选项，提高ansible执行效率" class="headerlink" title="五、Ansible的-t选项，提高ansible执行效率"></a>五、Ansible的-t选项，提高ansible执行效率</h3><p>ansible的<code>&quot;-t&quot;</code>或<code>&quot;--tree&quot;</code>选项是将ansible的执行结果按主机名保存在指定目录下的文件中。</p><p>有些时候，ansible执行起来的速度会非常慢，这种慢体现在即使执行的是一个立即返回的简单命令(如<code>ping</code>模块)，也会耗时很久，且不是因为<code>ssh</code>连接慢导致的。<br>如果使用-t选项，将第一次执行得到的结果按inventory中定义的主机名保存在文件中，下次执行到同一台主机时速度将会变快很多，即使之后不再加上-t选项，<br>也可以在一定时间内保持迅速执行。即使执行速度正常（如执行一个Ping命令0.7秒左右），使用-t选项也可以在此基础上变得更快。</p><p>除了使用-t选项，使用重定向将结果重定向到某个文件中也是一样的效果。<br>这也算是一种ansible提速方式，但在centos6上使用低版本ansible时，有时会出现执行很慢的现象，但不是每次都这样，且centos7执行速度正常<br>所以这也是一种<code>&quot;bug&quot;</code>式问题，故这种方式没有通用性。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> time ansible test_server -m <span class="built_in">command</span> -a <span class="string">"hostname"</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> time ansible test_server -m <span class="built_in">command</span> -a <span class="string">"hostname"</span> -t /tmp/<span class="built_in">test</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">$</span><span class="bash"> ll /tmp/<span class="built_in">test</span>/</span></span><br><span class="line">总用量 8</span><br><span class="line">-rw-r--r--. 1 root root 236 2月   7 17:59 10.4.7.101</span><br><span class="line">-rw-r--r--. 1 root root 307 2月   7 17:59 10.4.7.102</span><br></pre></td></tr></table></figure><p>上面做了对比，发现使用-t或重定向方式，将ansible的执行结果按主机名保存在指定目录下的文件中，ansible执行效率会有所提升。</p><p><strong><strong><strong>***</strong></strong></strong> 当你发现自己的才华撑不起野心时，就请安静下来学习吧！<strong><strong><strong>***</strong></strong></strong></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;原文链接：&lt;a href=&quot;https://www.cnblogs.com/lvzhenjiang/p/14386197.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.cnblogs.com/lvzhenjiang/p/1
      
    
    </summary>
    
    
      <category term="ansible" scheme="http://yoursite.com/categories/ansible/"/>
    
    
      <category term="ansible" scheme="http://yoursite.com/tags/ansible/"/>
    
  </entry>
  
  <entry>
    <title>anisble批量安装node_exporter</title>
    <link href="http://yoursite.com/2021/05/14/ansible/anisble%E6%89%B9%E9%87%8F%E5%AE%89%E8%A3%85node_exporter/"/>
    <id>http://yoursite.com/2021/05/14/ansible/anisble%E6%89%B9%E9%87%8F%E5%AE%89%E8%A3%85node_exporter/</id>
    <published>2021-05-14T04:40:47.863Z</published>
    <updated>2021-05-14T04:40:47.846Z</updated>
    
    <content type="html"><![CDATA[<p>原文链接：<a href="https://www.cnblogs.com/lvzhenjiang/p/14374243.html" target="_blank" rel="noopener">https://www.cnblogs.com/lvzhenjiang/p/14374243.html</a></p><h1 id="anisble批量安装node-exporter"><a href="#anisble批量安装node-exporter" class="headerlink" title="anisble批量安装node_exporter"></a><a href="https://www.cnblogs.com/lvzhenjiang/p/14374243.html" target="_blank" rel="noopener">anisble批量安装node_exporter</a></h1><p>目录</p><ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14374243.html#一、目录结构" target="_blank" rel="noopener">一、目录结构</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14374243.html#二、playbook文件" target="_blank" rel="noopener">二、playbook文件</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14374243.html#三、服务文件" target="_blank" rel="noopener">三、服务文件</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14374243.html#四、任务文件" target="_blank" rel="noopener">四、任务文件</a></li></ul><h3 id="一、目录结构"><a href="#一、目录结构" class="headerlink" title="一、目录结构"></a>一、目录结构</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> tree .</span></span><br><span class="line">.</span><br><span class="line">|-- hosts</span><br><span class="line">|-- node_exporter</span><br><span class="line">|   |-- files</span><br><span class="line">|   |   |-- node_exporter-1.0.1.linux-amd64.tar.gz</span><br><span class="line">|   |   `-- node_exporter.service</span><br><span class="line">|   `-- tasks</span><br><span class="line">|       `-- main.yml</span><br><span class="line">`-- node_exporter.yml</span><br></pre></td></tr></table></figure><h3 id="二、playbook文件"><a href="#二、playbook文件" class="headerlink" title="二、playbook文件"></a>二、playbook文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat node_exporter.yml </span></span><br><span class="line"><span class="meta">#</span><span class="bash">!/usr/bin/env ansible-playbook</span></span><br><span class="line">- hosts: all</span><br><span class="line">  remote_user: root</span><br><span class="line">  gather_facts: false</span><br><span class="line">  roles:</span><br><span class="line">  - role: node_exporter</span><br></pre></td></tr></table></figure><h3 id="三、服务文件"><a href="#三、服务文件" class="headerlink" title="三、服务文件"></a>三、服务文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat node_exporter/files/node_exporter.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Prometheus node_exporter</span><br><span class="line">Requires=network.target remote-fs.target</span><br><span class="line">After=network.target remote-fs.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=root</span><br><span class="line">Group=root</span><br><span class="line">ExecStart=/usr/local/node_exporter/node_exporter --web.listen-address=0.0.0.0:9100</span><br><span class="line">ExecReload=/bin/kill -HUP $MAINPID</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h3 id="四、任务文件"><a href="#四、任务文件" class="headerlink" title="四、任务文件"></a>四、任务文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat node_exporter/tasks/main.yml </span></span><br><span class="line">- name: 安装node_exporter</span><br><span class="line">  unarchive: </span><br><span class="line">    src: node_exporter-1.0.1.linux-amd64.tar.gz</span><br><span class="line">    dest: /usr/local/</span><br><span class="line"></span><br><span class="line">- name: 创建软链接</span><br><span class="line">  file:</span><br><span class="line">    src: /usr/local/node_exporter-1.0.1.linux-amd64</span><br><span class="line">    dest: /usr/local/node_exporter</span><br><span class="line">    state: link</span><br><span class="line"></span><br><span class="line">- name: 添加node_exporter服务</span><br><span class="line">  copy: </span><br><span class="line">    src: node_exporter.service</span><br><span class="line">    dest: /usr/lib/systemd/system/</span><br><span class="line"></span><br><span class="line">- name: daemon-reload</span><br><span class="line">  systemd: </span><br><span class="line">    daemon_reload: yes</span><br><span class="line"></span><br><span class="line">- name: 设置开机自动启动</span><br><span class="line">  systemd: </span><br><span class="line">    name: node_exporter</span><br><span class="line">    state: started</span><br><span class="line">    enabled: True</span><br><span class="line"></span><br><span class="line">- name: 确定端口在监听</span><br><span class="line">  wait_for:</span><br><span class="line">    host: 0.0.0.0</span><br><span class="line">    port: 9100</span><br><span class="line">    delay: 2</span><br></pre></td></tr></table></figure><p><strong><strong><strong>***</strong></strong></strong> 当你发现自己的才华撑不起野心时，就请安静下来学习吧！<strong><strong><strong>***</strong></strong></strong></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;原文链接：&lt;a href=&quot;https://www.cnblogs.com/lvzhenjiang/p/14374243.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.cnblogs.com/lvzhenjiang/p/1
      
    
    </summary>
    
    
      <category term="ansible" scheme="http://yoursite.com/categories/ansible/"/>
    
    
      <category term="ansible" scheme="http://yoursite.com/tags/ansible/"/>
    
  </entry>
  
  <entry>
    <title>ansible入门</title>
    <link href="http://yoursite.com/2021/05/14/ansible/ansible%E5%85%A5%E9%97%A8/"/>
    <id>http://yoursite.com/2021/05/14/ansible/ansible%E5%85%A5%E9%97%A8/</id>
    <published>2021-05-14T04:39:05.094Z</published>
    <updated>2021-05-14T04:39:05.085Z</updated>
    
    <content type="html"><![CDATA[<p>原文链接：<a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html" target="_blank" rel="noopener">https://www.cnblogs.com/lvzhenjiang/p/14199445.html</a></p><h1 id="ansible入门"><a href="#ansible入门" class="headerlink" title="ansible入门"></a><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html" target="_blank" rel="noopener">ansible入门</a></h1><p>目录</p><ul><li>一、Ansible基础概述<ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#11--什么是ansible" target="_blank" rel="noopener">1.1 什么是Ansible</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#12-ansible-可以完成哪些功能" target="_blank" rel="noopener">1.2 Ansible 可以完成哪些功能</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#13-ansible特点" target="_blank" rel="noopener">1.3 Ansible特点</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#14-ansible的架构中的控制节点、被控制节点、inventory、ad-hoc、playbook、连接协议这些是什么？" target="_blank" rel="noopener">1.4 Ansible的架构中的控制节点、被控制节点、inventory、ad-hoc、playbook、连接协议这些是什么？</a></li></ul></li><li>二、Ansible安装配置<ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#21-ansible安装" target="_blank" rel="noopener">2.1 ansible安装</a></li></ul></li><li>三、Ansible inventory<ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#31-场景一：基于密码连接" target="_blank" rel="noopener">3.1 场景一：基于密码连接</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#32-场景二：基于秘钥连接" target="_blank" rel="noopener">3.2 场景二：基于秘钥连接</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#33-场景三：主机组使用方式" target="_blank" rel="noopener">3.3 场景三：主机组使用方式</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#34-列出每个主机组下面的主机情况" target="_blank" rel="noopener">3.4 列出每个主机组下面的主机情况</a></li></ul></li><li>四、Ansible ad-hoc<ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#41-什么是ad-hoc" target="_blank" rel="noopener">4.1 什么是ad-hoc</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#42-ad-hocm模式的使用场景" target="_blank" rel="noopener">4.2 ad-hocm模式的使用场景</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#43-ad-hoc模式的命令使用" target="_blank" rel="noopener">4.3 ad-hoc模式的命令使用</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#44-使用ad-doc指定一次远程命令，注意观察返回结果的颜色" target="_blank" rel="noopener">4.4 使用ad-doc指定一次远程命令，注意观察返回结果的颜色</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#45-ad-hoc常用的模块" target="_blank" rel="noopener">4.5 ad-hoc常用的模块</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#46-使用过程中需要先了解anisble-doc帮助手册" target="_blank" rel="noopener">4.6 使用过程中需要先了解anisble-doc帮助手册</a></li></ul></li><li>五、ansibel 模块<ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#51-yum模块" target="_blank" rel="noopener">5.1 yum模块</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#52-copy模块" target="_blank" rel="noopener">5.2 copy模块</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#53-file模块" target="_blank" rel="noopener">5.3 file模块</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#54-get_url模块" target="_blank" rel="noopener">5.4 get_url模块</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#55-service模块" target="_blank" rel="noopener">5.5 service模块</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#56-group模块" target="_blank" rel="noopener">5.6 group模块</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#57-user模块" target="_blank" rel="noopener">5.7 user模块</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#58-cron模块" target="_blank" rel="noopener">5.8 cron模块</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#59-mount" target="_blank" rel="noopener">5.9 mount</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#510-firewalld" target="_blank" rel="noopener">5.10 firewalld</a></li></ul></li><li>六、Ansible playbook<ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#61-什么是playbook" target="_blank" rel="noopener">6.1 什么是playbook</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#62-ansible-playbook与ad-hoc的关系" target="_blank" rel="noopener">6.2 Ansible playbook与ad-hoc的关系</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#63-ansible-playbook书写格式" target="_blank" rel="noopener">6.3 Ansible playbook书写格式</a></li></ul></li><li>七、变量<ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#71-变量概述" target="_blank" rel="noopener">7.1 变量概述</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#72-变量定义" target="_blank" rel="noopener">7.2 变量定义</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#73-变量注册" target="_blank" rel="noopener">7.3 变量注册</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#74-facts变量" target="_blank" rel="noopener">7.4 facts变量</a></li></ul></li><li>八、Ansible Task 任务控制<ul><li>8.1 piaybook条件语句<ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#案例一：根据不同操作系统，安装相同的软件包" target="_blank" rel="noopener">案例一：根据不同操作系统，安装相同的软件包</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#案例二：为所有web主机名的添加nginx仓库，其余的都跳过添加" target="_blank" rel="noopener">案例二：为所有web主机名的添加nginx仓库，其余的都跳过添加</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#案例三：根据命令执行的结果进行判断" target="_blank" rel="noopener">案例三：根据命令执行的结果进行判断</a></li></ul></li><li>8.2 playbook循环语句<ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#案例一：-使用循环启动多个服务" target="_blank" rel="noopener">案例一： 使用循环启动多个服务</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#案例二：-使用字典批量创建用户" target="_blank" rel="noopener">案例二： 使用字典批量创建用户</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#案例三：-使用变量字典循环的方式拷贝文件" target="_blank" rel="noopener">案例三： 使用变量字典循环的方式拷贝文件</a></li></ul></li><li>8.3 playbook handlers<ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#案例：playbook安装nginx" target="_blank" rel="noopener">案例：playbook安装nginx</a></li></ul></li><li>8.4 playbook tag<ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#案例：" target="_blank" rel="noopener">案例：</a></li></ul></li><li>8.5 playbook include<ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#案例：" target="_blank" rel="noopener">案例：</a></li></ul></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#86-ignore_errors忽略错误" target="_blank" rel="noopener">8.6 ignore_errors忽略错误</a></li><li>8.7 playbook错误处理<ul><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#案例一：task执行失败强制调用handlers" target="_blank" rel="noopener">案例一：task执行失败强制调用handlers</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#案例二：-关闭change的状态（确定不会对被控端主机进行任何的修改和变更）" target="_blank" rel="noopener">案例二： 关闭change的状态（确定不会对被控端主机进行任何的修改和变更）</a></li><li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#案例三：-使用changed_when检查tasksrre任务返回结果" target="_blank" rel="noopener">案例三： 使用changed_when检查tasksrre任务返回结果</a></li></ul></li></ul></li></ul><h3 id="一、Ansible基础概述"><a href="#一、Ansible基础概述" class="headerlink" title="一、Ansible基础概述"></a>一、Ansible基础概述</h3><h4 id="1-1-什么是Ansible"><a href="#1-1-什么是Ansible" class="headerlink" title="1.1 什么是Ansible"></a>1.1 什么是Ansible</h4><p>Ansible是一个IT自动化的配置管理工具，自动化主要体现在Ansible集成了丰富模块、丰富的功能组件，可以通过一个命令完成一系列的操作。进而减少我们重复性的工作和维护成本，以提高工作效率！</p><h4 id="1-2-Ansible-可以完成哪些功能"><a href="#1-2-Ansible-可以完成哪些功能" class="headerlink" title="1.2 Ansible 可以完成哪些功能"></a>1.2 Ansible 可以完成哪些功能</h4><ul><li>批量执行远程命令，可以对N多台主机同时进行命令的执行；</li><li>批量配置软件服务，可以进行自动化的方式配置和管理服务；</li><li>实现软件开发功能，Jumpserver底层使用ansible来实现的自动化管理；</li><li>编排高级的IT任务，Ansible的Playbook是一门编程语言，可以用来描绘一套IT架构；</li></ul><h4 id="1-3-Ansible特点"><a href="#1-3-Ansible特点" class="headerlink" title="1.3 Ansible特点"></a>1.3 Ansible特点</h4><ul><li>容易学习，无代理模式，不像saltstack既要学习客户端与服务端，还要学习客户端与服务端中间通信协议；</li><li>操作灵活，体现在Ansible有较多的模块，提供了丰富的功能、playbook则提供类似于编程语言的复杂功能；</li><li>简单复用，体现在Ansible一个命令可以完成很多事情；</li><li>安全可靠，因为Ansible使用了SSH协议进行通信，既稳定也安全；</li><li>移植性高，可以将写好的playbook拷贝任意机器进行执行；</li></ul><h4 id="1-4-Ansible的架构中的控制节点、被控制节点、inventory、ad-hoc、playbook、连接协议这些是什么？"><a href="#1-4-Ansible的架构中的控制节点、被控制节点、inventory、ad-hoc、playbook、连接协议这些是什么？" class="headerlink" title="1.4 Ansible的架构中的控制节点、被控制节点、inventory、ad-hoc、playbook、连接协议这些是什么？"></a>1.4 Ansible的架构中的控制节点、被控制节点、inventory、ad-hoc、playbook、连接协议这些是什么？</h4><p><img src="https://gitee.com/lvzhenjiang/document/raw/master/%E5%B0%8F%E4%B9%A6%E5%8C%A0/20200925223530.png" alt="20200925223530"></p><h3 id="二、Ansible安装配置"><a href="#二、Ansible安装配置" class="headerlink" title="二、Ansible安装配置"></a>二、Ansible安装配置</h3><h4 id="2-1-ansible安装"><a href="#2-1-ansible安装" class="headerlink" title="2.1 ansible安装"></a>2.1 ansible安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yum install ansible -y</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible --version</span></span><br><span class="line">ansible 2.9.10</span><br><span class="line">  config file = /etc/ansible/ansible.cfg</span><br><span class="line">  configured module search path = [u'/root/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules']</span><br><span class="line">  ansible python module location = /usr/lib/python2.7/site-packages/ansible</span><br><span class="line">  executable location = /usr/bin/ansible</span><br><span class="line">  python version = 2.7.5 (default, Nov 20 2015, 02:00:19) [GCC 4.8.5 20150623 (Red Hat 4.8.5-4)]</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible &lt;host-pattern&gt; [option]</span></span><br><span class="line">--version: # ansible版本信息</span><br><span class="line">-v：显示详细信息</span><br><span class="line">-i：主机清单文件路径，默认是/etc/ansibel/hosts</span><br><span class="line">-m：使用的模块的名称，默认使用command模块</span><br><span class="line">-a：使用的模块参数，模块的具体工作</span><br><span class="line">-k：提示输入ssh密码，而不使用基于ssh的秘钥认证</span><br><span class="line">-C：模拟执行测试，但不会真的执行</span><br><span class="line">-T：指定命令的超时时间</span><br></pre></td></tr></table></figure><p><strong>ansible配置文件优先级顺序：</strong></p><ul><li>最先查找$ANSIBLE_CONFIG变量；</li><li>其次查找当前目录下ansible.cfg</li><li>然后查找用户家目录下的.ansible.cfg</li><li>最后查找/etc/ansible/ansible.cfg（默认）</li></ul><h3 id="三、Ansible-inventory"><a href="#三、Ansible-inventory" class="headerlink" title="三、Ansible inventory"></a>三、Ansible inventory</h3><p><code>Inventory</code>文件中填写需要被管理主机与主机组信息（逻辑上定义）。默认<code>Inventory</code>文件在<code>/etc/ansible/hosts</code>。当然也可以自定义，然后使用<code>-i</code>指定<code>Inventory</code>文件位置：示例：</p><h4 id="3-1-场景一：基于密码连接"><a href="#3-1-场景一：基于密码连接" class="headerlink" title="3.1 场景一：基于密码连接"></a>3.1 场景一：基于密码连接</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat /etc/ansible/hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 方法一</span></span><br><span class="line">[webservers]</span><br><span class="line">192.168.100.225 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass='123456'</span><br><span class="line">192.168.100.226 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass='123456'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 方法二</span></span><br><span class="line">[webservers]</span><br><span class="line">web[1:2].lzj.com ansible_ssh_pass='123456'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 方法三</span></span><br><span class="line">[webservers]</span><br><span class="line">web[1:2].lzj.com</span><br><span class="line">[webservers：vars]</span><br><span class="line">ansible_ssh_pass='123456'</span><br></pre></td></tr></table></figure><h4 id="3-2-场景二：基于秘钥连接"><a href="#3-2-场景二：基于秘钥连接" class="headerlink" title="3.2 场景二：基于秘钥连接"></a>3.2 场景二：基于秘钥连接</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ssh-keygen</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ssh-copy-id 192.168.100.225</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ssh-copy-id 192.168.100.226</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir project1/ &amp;&amp; <span class="built_in">cd</span> project1/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim hosts</span></span><br><span class="line">[web]</span><br><span class="line">192.168.100.225</span><br><span class="line">192.168.100.226</span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m ping -i hosts</span></span><br></pre></td></tr></table></figure><h4 id="3-3-场景三：主机组使用方式"><a href="#3-3-场景三：主机组使用方式" class="headerlink" title="3.3 场景三：主机组使用方式"></a>3.3 场景三：主机组使用方式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[lbservers]</span><br><span class="line">192.168.100.221</span><br><span class="line">192.168.100.222</span><br><span class="line"></span><br><span class="line">[webservers]</span><br><span class="line">192.168.100.223</span><br><span class="line">192.168.100.224</span><br><span class="line"></span><br><span class="line">[servers:children]    # 定义servers组包含两个子组（lbservers、webservers）</span><br><span class="line">lbservers</span><br><span class="line">webservers</span><br></pre></td></tr></table></figure><h4 id="3-4-列出每个主机组下面的主机情况"><a href="#3-4-列出每个主机组下面的主机情况" class="headerlink" title="3.4 列出每个主机组下面的主机情况"></a>3.4 列出每个主机组下面的主机情况</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible all -i hosts --list-hosts</span></span><br><span class="line">  hosts (2):</span><br><span class="line">    192.168.100.225</span><br><span class="line">    192.168.100.226</span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -i hosts --list-hosts</span></span><br><span class="line">  hosts (2):</span><br><span class="line">    192.168.100.225</span><br><span class="line">    192.168.100.226</span><br></pre></td></tr></table></figure><h3 id="四、Ansible-ad-hoc"><a href="#四、Ansible-ad-hoc" class="headerlink" title="四、Ansible ad-hoc"></a>四、Ansible ad-hoc</h3><h4 id="4-1-什么是ad-hoc"><a href="#4-1-什么是ad-hoc" class="headerlink" title="4.1 什么是ad-hoc"></a>4.1 什么是ad-hoc</h4><p><code>ad-hoc</code>就是临时命令，执行完成后就结束，并不会保存！</p><h4 id="4-2-ad-hocm模式的使用场景"><a href="#4-2-ad-hocm模式的使用场景" class="headerlink" title="4.2 ad-hocm模式的使用场景"></a>4.2 ad-hocm模式的使用场景</h4><p>比如在多台机器上查看某个进程是否启动，或拷贝指定文件到本地，等等！</p><h4 id="4-3-ad-hoc模式的命令使用"><a href="#4-3-ad-hoc模式的命令使用" class="headerlink" title="4.3 ad-hoc模式的命令使用"></a>4.3 ad-hoc模式的命令使用</h4><p><img src="https://gitee.com/lvzhenjiang/document/raw/master/%E5%B0%8F%E4%B9%A6%E5%8C%A0/20200926003906.png" alt="20200926003906"></p><h4 id="4-4-使用ad-doc指定一次远程命令，注意观察返回结果的颜色"><a href="#4-4-使用ad-doc指定一次远程命令，注意观察返回结果的颜色" class="headerlink" title="4.4 使用ad-doc指定一次远程命令，注意观察返回结果的颜色"></a>4.4 使用ad-doc指定一次远程命令，注意观察返回结果的颜色</h4><ul><li>绿色：表示被管理主机没有被修改；</li><li>黄色：表示被管理端主机发现变更；</li><li>红色：表示出现了故障，注意查看提示；</li></ul><h4 id="4-5-ad-hoc常用的模块"><a href="#4-5-ad-hoc常用的模块" class="headerlink" title="4.5 ad-hoc常用的模块"></a>4.5 ad-hoc常用的模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">command# 指定shell命令（不支持管道等特殊字符）</span><br><span class="line">shell# 执行shell命令</span><br><span class="line">scripts# 执行shell脚本</span><br><span class="line">yum_repository# 配置yum仓库</span><br><span class="line">yum# 安装软件</span><br><span class="line">copy# 变更配置文件</span><br><span class="line">file# 建立目录或文件</span><br><span class="line">service# 启动、停止服务</span><br><span class="line">mount# 挂载设备</span><br><span class="line">cron# 定时任务</span><br><span class="line">firewalld# 防火墙</span><br><span class="line">get_url# 下载软件</span><br></pre></td></tr></table></figure><h4 id="4-6-使用过程中需要先了解anisble-doc帮助手册"><a href="#4-6-使用过程中需要先了解anisble-doc帮助手册" class="headerlink" title="4.6 使用过程中需要先了解anisble-doc帮助手册"></a>4.6 使用过程中需要先了解anisble-doc帮助手册</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-doc -l<span class="comment"># 查看所有模块说明</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-doc copy<span class="comment"># 表示指定模块方法</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-doc -s copy<span class="comment"># 表示指定模块参数</span></span></span><br></pre></td></tr></table></figure><h3 id="五、ansibel-模块"><a href="#五、ansibel-模块" class="headerlink" title="五、ansibel 模块"></a>五、ansibel 模块</h3><h4 id="5-1-yum模块"><a href="#5-1-yum模块" class="headerlink" title="5.1 yum模块"></a>5.1 yum模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 示例一： 安装当前最新的Apache软件，如果存在则更新</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m yum -a <span class="string">"name=httpd state=latest"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例二： 安装当前最新的Apache软件，通过epel安装</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m yum -a <span class="string">"name=httpd state=present enablerepo=epel"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例三： 通过公网URL安装rpm软件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m yum -a <span class="string">"name=https://mirrors4.tuna.tsinghua.edu.cn/zabbix/zabbix/4.0/rhel/7/x86_64/zabbix-agent-4.0.0-2.el7.x86_64.rpm state=present"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例四：更新所有的软件包，但排除和kernel相关的</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m yum -a <span class="string">"name="</span>*<span class="string">" state=present exclude="</span>kernel*<span class="string">" -i hosts</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例五： 删除Apache软件</span></span><br><span class="line"><span class="meta">$</span><span class="bash">  ansible web -m yum -a <span class="string">"name=httpd state=absent"</span> -i hosts</span></span><br></pre></td></tr></table></figure><h4 id="5-2-copy模块"><a href="#5-2-copy模块" class="headerlink" title="5.2 copy模块"></a>5.2 copy模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 示例一： 将本地的httpd.conf文件Listen 端口修改为9999，然后推送到远程主机</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sed -i <span class="string">'s/Listen 80/Listen 9999/g'</span> httpd.conf</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m copy -a <span class="string">"src=httpd.conf dest=/etc/httpd/conf/httpd.conf owner=root group=root mode-644"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例二： 将本地的httpd.conf文件Listen端口修改为9988，然后推送到远端，检查远端是否存在上次备份的文件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sed -i <span class="string">'s/Listen 9999/Listen 9988/g'</span> httpd.conf</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m copy -a <span class="string">"src=httpd.conf dest=/etc/httpd/conf/httpd.conf owner=root group=root mode=644 backup=yes"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例三： 往远程的主机文件写入内容</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m copy -a <span class="string">"content=123456........ dest=/var/www/html/index.html"</span> -i hosts</span></span><br></pre></td></tr></table></figure><h4 id="5-3-file模块"><a href="#5-3-file模块" class="headerlink" title="5.3 file模块"></a>5.3 file模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 示例一： 创建文件，并设置属主、属组、权限</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m file -a <span class="string">"path=/var/www/html/t1.html state=touch owner=apache group=apache mode=644"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例二： 创建目录，并设置属主、属组、权限</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m file -a <span class="string">"path=/var/www/html/dd state=directory owner=apache group=apache mode=755"</span> -i hosts</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例三：递归授权目录的方式</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m file -a <span class="string">"path=/var/www/html state=directory owner=apache group=apache recurse=yes"</span> -i hosts</span></span><br></pre></td></tr></table></figure><h4 id="5-4-get-url模块"><a href="#5-4-get-url模块" class="headerlink" title="5.4 get_url模块"></a>5.4 get_url模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 示例一： 下载互联网的软件到本地</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m get_url -a <span class="string">"url=http://192.168.99.181:12138/document/Ansible.docx dest=/root/"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例二： 下载互联网文件并进行mds校验</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> md5sum Ansible.docx      <span class="comment"># 获取文件md5值</span></span></span><br><span class="line">7b1a6fe7af7252005987e16ce64e1e1a  Ansible.docx</span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m get_url -a <span class="string">"url=http://192.168.99.181:12138/document/Ansible.docx dest=/root/ checksum=md5:7b1a6fe7af7252005987e16ce64e1e1a"</span> -i hosts</span></span><br></pre></td></tr></table></figure><h4 id="5-5-service模块"><a href="#5-5-service模块" class="headerlink" title="5.5 service模块"></a>5.5 service模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 示例一： 启动httpd服务</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m service -a <span class="string">"name=httpd state=started"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例二： 重载httpd服务</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m service -a <span class="string">"name=httpd state=reloaded"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例三： 重启httpd服务</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m service -a <span class="string">"name=httpd state=restarted"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例四： 停止httpd服务</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m service -a <span class="string">"name=httpd state=stopped"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例五： 启动httpd服务，并加入开机自启</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m service -a <span class="string">"name=httpd state=started enabled=yes"</span> -i hosts</span></span><br></pre></td></tr></table></figure><h4 id="5-6-group模块"><a href="#5-6-group模块" class="headerlink" title="5.6 group模块"></a>5.6 group模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 示例一： 创建news基本组，指定gid为9999</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m group -a <span class="string">"name=news gid=9999 state=present"</span></span></span><br><span class="line"> -i hosts</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例二： 创建http系统组，指定gid为8888</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m group -a <span class="string">"name=http gid=8888  state=present</span></span></span><br><span class="line"> system=yes" -i hosts</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例三： 删除<span class="built_in">test</span>基本组</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m group -a <span class="string">"name=test state=absent"</span> -i hosts</span></span><br></pre></td></tr></table></figure><h4 id="5-7-user模块"><a href="#5-7-user模块" class="headerlink" title="5.7 user模块"></a>5.7 user模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 示例一： 创建job用户，uid是1040，主要组是adm</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m user -a <span class="string">"name=job uid=1040 group=adm"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例二： 创建joh用户，登录shell是/sbin/nologin，追加bin、sys两个组</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m user -a <span class="string">"name=joh groups=bin,sys shell=/sbin/nologin"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例三： 创建jsm用户，为其添加123作为登录密码，并创建家目录</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible localhost -m debug -a <span class="string">"msg=&#123;&#123; '123' | password_hash('sha512','salt') &#125;&#125;"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取123加密后的字符串</span></span><br><span class="line"><span class="meta">$</span><span class="bash">6<span class="variable">$salt</span><span class="variable">$jkHSO0tOjmLW0S1NFlw5veSIDRAVsiQQMTrkOKy4xdCCLPNIsHhZkIRlzfzIvKyXeGdOfCBoW1wJZPLyQ9Qx</span>/1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m user -a <span class="string">'name=jsm password=$6$salt$jkHSO0tOjmLW0S1NFlw5veSIDRAVsiQQMTrkOKy4xdCCLPNIsHhZkIRlzfzIvKyXeGdOfCBoW1wJZPLyQ9Qx/1 create_home=yes'</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例四： 移除job用户</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m user -a <span class="string">"name=job state=absent remove=yes"</span> -i hosts</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> remove=yes删除普通用户家目录</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例五： 创建http用户，并为该用户创建2048字节的私钥，存放在~/http/.ssh/id_rsa</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m user -a <span class="string">"name=http generate_ssh_key=yes ssh_key_bits=2048 ssh_key_file=.ssh/id_rsa"</span> -i hosts</span></span><br></pre></td></tr></table></figure><h4 id="5-8-cron模块"><a href="#5-8-cron模块" class="headerlink" title="5.8 cron模块"></a>5.8 cron模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 示例一： 添加定时任务，每分钟执行一次ls</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m cron -a <span class="string">"name=job1 job='ls &gt; /dev/null'"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例二： 添加定时任务，每天的凌晨2点和凌晨5点执行一次ls</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m cron -a <span class="string">"name=job2 job='ls &gt; /dev/null' minute=0 hour=2,5"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例三： 关闭定时任务，使定时任务失败</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m cron -a <span class="string">"name=job2 job='ls &gt; /dev/null' minute=0 hour=2,5 disabled=yes"</span> -i hosts</span></span><br></pre></td></tr></table></figure><h4 id="5-9-mount"><a href="#5-9-mount" class="headerlink" title="5.9 mount"></a>5.9 mount</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 环境准备：</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible localhost -m yum -a <span class="string">"name=nfs-utils state=present"</span> </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible localhost -m file -a <span class="string">"path=/ops state=directory"</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible localhost -m copy -a <span class="string">'content="/ops 192.168.100.1/24(rw,sync)" dest=/etc/exports'</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible localhost -m service -a <span class="string">"name=nfs state=restarted"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例一： 挂载nfs存储到本地的/opt目录，并实现开机自动挂载</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m mount -a <span class="string">"src=192.168.99.181:/ops path=/opt fstype=nfs opts=defaults state=mounted"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例二： 临时卸载nfs的挂载，但不会清理/etc/fstab</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m mount -a <span class="string">"src=192.168.99.181:/ops path=/opt fstype=nfs opts=defaults state=unmounted"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例三： 永久卸载ns的挂载，清理/etc/fstab</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m mount -a <span class="string">"src=192.168.99.181:/ops path=/opt fstype=nfs opts=defaults state=absent"</span> -i hosts</span></span><br></pre></td></tr></table></figure><h4 id="5-10-firewalld"><a href="#5-10-firewalld" class="headerlink" title="5.10 firewalld"></a>5.10 firewalld</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 示例一： 永久放行https的流量，只有重启才生效</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m firewalld -a <span class="string">"zone=public service=https permanent=yes state=enabled"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例二： 永久放行8081端口的流量，只有重启才生效</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m firewalld -a <span class="string">"zone=public port=8081/tcp permanent=yes state=enabled"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例三： 放行8080-8090的所有的tcp端口流量，临时和永久都生效</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m firewalld -a <span class="string">"zone=public port=8080-8090/tcp immediate=yes permanent=yes state=enabled"</span> -i hosts</span></span><br></pre></td></tr></table></figure><h3 id="六、Ansible-playbook"><a href="#六、Ansible-playbook" class="headerlink" title="六、Ansible playbook"></a>六、Ansible playbook</h3><h4 id="6-1-什么是playbook"><a href="#6-1-什么是playbook" class="headerlink" title="6.1 什么是playbook"></a>6.1 什么是playbook</h4><ul><li>playbook：定义了一个文本文件，以.yml为后缀结尾；</li><li>play：定义的是主机的角色；</li><li>task：定义的是具体执行的任务；</li></ul><p>总结：playbook是由一个多个多个play组成，一个play可以包含多个task任务。可以理解为：使用不同的模块来共同完成一件事情！</p><p><img src="https://gitee.com/lvzhenjiang/document/raw/master/%E5%B0%8F%E4%B9%A6%E5%8C%A0/20200926140848.png" alt="20200926140848"></p><h4 id="6-2-Ansible-playbook与ad-hoc的关系"><a href="#6-2-Ansible-playbook与ad-hoc的关系" class="headerlink" title="6.2 Ansible playbook与ad-hoc的关系"></a>6.2 Ansible playbook与ad-hoc的关系</h4><ul><li>playbook是对ad-hoc的一种编排方式；</li><li>playbook可以持久运行，而ad-hoc只能临时运行；</li><li>playbook适合复杂的任务，而ad-hoc适合做快速简单的任务；</li><li>playbook能控制任务执行的先后顺序；</li></ul><h4 id="6-3-Ansible-playbook书写格式"><a href="#6-3-Ansible-playbook书写格式" class="headerlink" title="6.3 Ansible playbook书写格式"></a>6.3 Ansible playbook书写格式</h4><p>playbook是由yaml语法书写，结构清晰、可读性强。所以必须掌握yaml基础语法！</p><table><thead><tr><th>语法</th><th>概述</th></tr></thead><tbody><tr><td>缩进</td><td>YAML使用固定的缩进风格表示层级结构，每个缩进由两个空格组成，不能使用ta键</td></tr><tr><td>冒号</td><td>以冒号结尾的除外，其他所有冒号后面所有必须有空格</td></tr><tr><td>短横线</td><td>表示列表项，使用一个短横杠加一个空格。多个项使用同样的缩进级别作为统一列表</td></tr></tbody></table><h3 id="七、变量"><a href="#七、变量" class="headerlink" title="七、变量"></a>七、变量</h3><h4 id="7-1-变量概述"><a href="#7-1-变量概述" class="headerlink" title="7.1 变量概述"></a>7.1 变量概述</h4><p>变量提供了便捷的方式来管理ansible项目中的动态值，比如：nginx-1.12，可能后期会反复的使用这个版本的值，那么如果将此值设置为变量，后续使用和修改都将变得非常方便。这样可以简化项目的创建和维护。</p><p>那么在ansible中定义变量分为以下三种方式：</p><ul><li>通过命令行进行变量定义；</li><li>在play文件中进行定义变量；</li><li>通过Inventory在主机组或单个主机中设置变量；</li></ul><p>如果定义的变量出现重复，且造成冲突，怎么办？谁说了算？</p><h4 id="7-2-变量定义"><a href="#7-2-变量定义" class="headerlink" title="7.2 变量定义"></a>7.2 变量定义</h4><p>1、在playbook的文件开头通过vars关键字进行变量定义</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">web_packages:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ftp_packages:</span> <span class="string">vsftpd</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Rpm</span> <span class="string">Packages</span> <span class="string">"<span class="template-variable">&#123;&#123; web_packages &#125;&#125;</span>"</span> <span class="string">"<span class="template-variable">&#123;&#123; ftp_packages &#125;&#125;</span>"</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">"<span class="template-variable">&#123;&#123; web_packages &#125;&#125;</span>"</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">"<span class="template-variable">&#123;&#123; ftp_packages &#125;&#125;</span>"</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br></pre></td></tr></table></figure><p>2、可以在playbook中使用<code>vars_files</code>指定文件作为变量文件，好处就是其他的playbook也可以调用</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1）准备一个变量的文件，建议使用yml格式</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat vars.yml</span></span><br><span class="line">web_packages: httpd</span><br><span class="line">ftp_packages: vsftpd</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2）准备playbook进行调用</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">- hosts: web</span><br><span class="line">  vars_files:</span><br><span class="line">    - vars.yml</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Rpm Packages "&#123;&#123; web_packages &#125;&#125;" "&#123;&#123; ftp_packages &#125;&#125;"</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - "&#123;&#123; web_packages &#125;&#125;"</span><br><span class="line">          - "&#123;&#123; ftp_packages &#125;&#125;"</span><br><span class="line">        state: present</span><br></pre></td></tr></table></figure><p>3、在Inventory主机清单中定义变量，但是注意：主机变量优先级高于主机组变量</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1）在Inventory主机清单中对主机组进行定义变量</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat hosts</span></span><br><span class="line">[web]</span><br><span class="line">192.168.100.225</span><br><span class="line">192.168.100.226</span><br><span class="line"></span><br><span class="line">[web:vars]</span><br><span class="line">filename=group_vars</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2）playbook中直接调用变量</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">- hosts: web</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Create File</span><br><span class="line">      file:</span><br><span class="line">        name: /tmp/&#123;&#123; filename&#125;&#125;</span><br><span class="line">        state: touch</span><br></pre></td></tr></table></figure><p>4、官方建议是在ansible项目目录中创建两个额外的变量目录，分别是<code>host_vars</code>和<code>group_vars</code></p><ul><li>测试<code>group_vars</code>定义变量方式</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat hosts</span></span><br><span class="line">[web]</span><br><span class="line">192.168.100.225</span><br><span class="line">192.168.100.226</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1）在当前的项目目录中创建两个变量的目录</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir &#123;group,host&#125;_vars</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2）在group_vars目录中创建一个文件，文件名与Inventory清单中的主机组名称要保持一致</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat group_vars/web</span></span><br><span class="line">web_packages: wget</span><br><span class="line">ftp_packages: tree</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3）编写playbook，只需在playbook中使用变量即可</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">- hosts: web</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Rpm Packages "&#123;&#123; web_packages &#125;&#125;" "&#123;&#123; ftp_packages &#125;&#125;"</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - "&#123;&#123; web_packages &#125;&#125;"</span><br><span class="line">          - "&#123;&#123; ftp_packages &#125;&#125;"</span><br><span class="line">        state: present</span><br></pre></td></tr></table></figure><p><strong>测试test组能否使用web组定义的变量，无法使用！但是系统提供了特殊的all组，也就是说<code>group_vars</code>目录下创建一个all文件，定义变量对所有的主机都生效！</strong></p><ul><li>测试<code>host_vars</code>定义变量方式</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1）在host_vars目录创建一个文件，文件名与Inventory清单中的主机名称要保持一致，如果是IP地址，则创建相同的IP</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat hosts</span></span><br><span class="line">[web]</span><br><span class="line">192.168.100.225</span><br><span class="line">192.168.100.226</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2）在host_vars目录中创建文件，给192.168.100.225主机定义变量</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat host_vars/192.168.100.225</span></span><br><span class="line">web_packages: zlib-static</span><br><span class="line">ftp_packages: zmap</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3）转别一个playbook文件调用host主机变量</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">- hosts: 192.168.100.225</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Rpm Packages "&#123;&#123; web_packages &#125;&#125;" "&#123;&#123; ftp_packages &#125;&#125;"</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - "&#123;&#123; web_packages &#125;&#125;"</span><br><span class="line">          - "&#123;&#123; ftp_packages &#125;&#125;"</span><br><span class="line">        state: present</span><br></pre></td></tr></table></figure><p>5、通过命令行<code>-extra-vars</code>或<code>-e</code>外置穿餐设定变量</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1）准备playbook文件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">- hosts: "&#123;&#123; host &#125;&#125;"</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Rpm Packages "&#123;&#123; web_packages &#125;&#125;" "&#123;&#123; ftp_packages &#125;&#125;"</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - "&#123;&#123; web_packages &#125;&#125;"</span><br><span class="line">          - "&#123;&#123; ftp_packages &#125;&#125;"</span><br><span class="line">        state: present</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2）执行playbook时进行变量的传递</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook -i hosts test.yml -e <span class="string">"host=web"</span></span></span><br></pre></td></tr></table></figure><p>6、变量的优先级顺序：</p><p>命令行变量——&gt;paly中的vars_files——&gt;paly中的vars——&gt;host_vars——&gt;group_vars/all</p><h4 id="7-3-变量注册"><a href="#7-3-变量注册" class="headerlink" title="7.3 变量注册"></a>7.3 变量注册</h4><p><code>register</code>关键字可以将某个task任务结果存储至变量中，最后使用debug输出变量内容，可以用于后续排查故障！</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">system</span> <span class="string">status</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">netstat</span> <span class="string">-lntp</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">System_Status</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">System</span> <span class="string">Status</span></span><br><span class="line">      <span class="attr">debug:</span> <span class="string">msg="&#123;&#123;</span> <span class="string">System_Status.stdout_lines</span> <span class="string">&#125;&#125;"</span></span><br></pre></td></tr></table></figure><h4 id="7-4-facts变量"><a href="#7-4-facts变量" class="headerlink" title="7.4 facts变量"></a>7.4 facts变量</h4><p>Ansible facts是在被管理主机上通过ansible自动采集发现的变量。facts包含每台特定的主机信息。比如：被控端主机的主机名、IP地址、系统版本、CPU数量、内存状态、磁盘状态等等。</p><p>默认情况的facts变量名都已经预先定义好了，只需要采集被控端的信息，然后传递至facts变量即可！</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m setup -i hosts &gt; facts.txt</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取所有的facts变量</span></span><br></pre></td></tr></table></figure><p>facts变量使用场景：</p><ul><li><p>通过facts变量检查被控端主机硬件CPU信息，从而生成不同的Nginx配置文件；</p></li><li><p>通过facts变量检查被控端主机名称信息，从而生成不同的zabbix配置文件；</p></li><li><p>通过facts变量检查被控端主机内存状态信息，从而生成不同的memcached配置文件；</p><p>………………</p></li></ul><p>1、facts基本用法：比如获取被控端的主机名和IP地址，然后通过debug输出</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OutPut</span> <span class="string">variables</span> <span class="string">ansible</span> <span class="string">facts</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">this</span> <span class="string">default</span> <span class="string">IPv4</span> <span class="string">address</span> <span class="string">"<span class="template-variable">&#123;&#123; ansible_fqdn &#125;&#125;</span>"</span> <span class="string">is</span> <span class="string">"<span class="template-variable">&#123;&#123; ansible_default_ipv4.address &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure><p>2、facts开启后会影响Ansible主机的性能，如果没有采集被控端主机需求可选择关闭</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span>    <span class="comment"># 关闭信息采集</span></span><br></pre></td></tr></table></figure><h3 id="八、Ansible-Task-任务控制"><a href="#八、Ansible-Task-任务控制" class="headerlink" title="八、Ansible Task 任务控制"></a>八、Ansible Task 任务控制</h3><h4 id="8-1-piaybook条件语句"><a href="#8-1-piaybook条件语句" class="headerlink" title="8.1 piaybook条件语句"></a>8.1 piaybook条件语句</h4><p>判断在Ansible任务中的使用频率非常高，比如yum模块可以检测软件包是否已经被安装，而在这个过程中我们不用做太多的人工干预。但是也有部分任务需要进行判断。</p><h5 id="案例一：根据不同操作系统，安装相同的软件包"><a href="#案例一：根据不同操作系统，安装相同的软件包" class="headerlink" title="案例一：根据不同操作系统，安装相同的软件包"></a>案例一：根据不同操作系统，安装相同的软件包</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Centos</span> <span class="string">Install</span> <span class="string">Httpd</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">(</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">"CentOS"</span> <span class="string">)</span></span><br></pre></td></tr></table></figure><h5 id="案例二：为所有web主机名的添加nginx仓库，其余的都跳过添加"><a href="#案例二：为所有web主机名的添加nginx仓库，其余的都跳过添加" class="headerlink" title="案例二：为所有web主机名的添加nginx仓库，其余的都跳过添加"></a>案例二：为所有web主机名的添加nginx仓库，其余的都跳过添加</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">YUM</span> <span class="string">Repo</span></span><br><span class="line">      <span class="attr">yum_repository:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">ansible_nginx</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">ansible_test</span></span><br><span class="line">        <span class="attr">baseurl:</span> <span class="string">http://nginx.org/packages/centos/$releasever/$basearch/</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="attr">gpgcheck:</span> <span class="literal">no</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">(</span> <span class="string">ansible_fqdn</span> <span class="string">is</span> <span class="string">match("web*")</span> <span class="string">)</span></span><br><span class="line">      </span><br><span class="line"><span class="comment"># 当然when也可以使用and与or方式</span></span><br><span class="line"><span class="comment"># when： ( ansible_fqdn is match("web*") ) or</span></span><br><span class="line"><span class="comment"># ( ansible_fqdn is match("lb*") )</span></span><br></pre></td></tr></table></figure><h5 id="案例三：根据命令执行的结果进行判断"><a href="#案例三：根据命令执行的结果进行判断" class="headerlink" title="案例三：根据命令执行的结果进行判断"></a>案例三：根据命令执行的结果进行判断</h5><p>通过register将命令执行结果保存至变量，然后通过when语句进行判断</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">Httpd</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">systemctl</span> <span class="string">is-active</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">ignore_errors:</span> <span class="literal">yes</span>        <span class="comment"># 忽略错误</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">check_httpd</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Httpd</span> <span class="string">Restart</span>        <span class="comment"># 如果check_httpd执行命令结果等于0，则重启httpd,否则跳过</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">check_httpd.rc</span> <span class="string">==</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><h4 id="8-2-playbook循环语句"><a href="#8-2-playbook循环语句" class="headerlink" title="8.2 playbook循环语句"></a>8.2 playbook循环语句</h4><p>有时候我们写playbook的时候会发现了很多task都要重复引用某个模块，比如一次启动10个服务，或者一个拷贝10个文件。如果安装传统的写法最少要写10次，这样会显得playbook很臃肿。如果使用循环的方式来编写playbokk，这样可以减少重复使用某个模块！</p><h5 id="案例一：-使用循环启动多个服务"><a href="#案例一：-使用循环启动多个服务" class="headerlink" title="案例一： 使用循环启动多个服务"></a>案例一： 使用循环启动多个服务</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Service</span> <span class="string">Start</span></span><br><span class="line">      <span class="attr">service:</span> </span><br><span class="line">        <span class="attr">name:</span> <span class="string">"<span class="template-variable">&#123;&#123; item &#125;&#125;</span>"</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">httpd</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">sshd</span></span><br></pre></td></tr></table></figure><h5 id="案例二：-使用字典批量创建用户"><a href="#案例二：-使用字典批量创建用户" class="headerlink" title="案例二： 使用字典批量创建用户"></a>案例二： 使用字典批量创建用户</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Add</span> <span class="string">Users</span></span><br><span class="line">      <span class="attr">user:</span> </span><br><span class="line">        <span class="attr">name:</span> <span class="string">"<span class="template-variable">&#123;&#123; item.name &#125;&#125;</span>"</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">"<span class="template-variable">&#123;&#123;item.group &#125;&#125;</span>"</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'test01'</span><span class="string">,group:</span> <span class="string">'bin'</span> <span class="string">&#125;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'test02'</span><span class="string">,group:</span> <span class="string">'root'</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h5 id="案例三：-使用变量字典循环的方式拷贝文件"><a href="#案例三：-使用变量字典循环的方式拷贝文件" class="headerlink" title="案例三： 使用变量字典循环的方式拷贝文件"></a>案例三： 使用变量字典循环的方式拷贝文件</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">"<span class="template-variable">&#123;&#123; item.src &#125;&#125;</span>"</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">"<span class="template-variable">&#123;&#123; item.dest &#125;&#125;</span>"</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">"<span class="template-variable">&#123;&#123; item.mode &#125;&#125;</span>"</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">src:</span> <span class="string">'rsync.conf'</span> <span class="string">,</span> <span class="attr">dest:</span> <span class="string">'/tmp/rsync.conf'</span> <span class="string">,</span> <span class="attr">mode:</span> <span class="number">644</span> <span class="string">&#125;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">src:</span> <span class="string">'rsync.pass'</span> <span class="string">,</span> <span class="attr">dest:</span> <span class="string">'/tmp/rsync.pass'</span> <span class="string">,</span> <span class="attr">mode:</span> <span class="number">600</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>高级写法(变量套变量)：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">Path:</span> <span class="string">/tmp</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">"<span class="template-variable">&#123;&#123; item.src &#125;&#125;</span>"</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">"<span class="template-variable">&#123;&#123; item.dest &#125;&#125;</span>"</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">"<span class="template-variable">&#123;&#123; item.mode &#125;&#125;</span>"</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">src:</span> <span class="string">'rsync.conf'</span> <span class="string">,</span> <span class="attr">dest:</span> <span class="string">'<span class="template-variable">&#123;&#123; Path &#125;&#125;</span>/rsync.conf'</span> <span class="string">,</span> <span class="attr">mode:</span> <span class="number">644</span> <span class="string">&#125;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">src:</span> <span class="string">'rsync.pass'</span> <span class="string">,</span> <span class="attr">dest:</span> <span class="string">'<span class="template-variable">&#123;&#123; Path &#125;&#125;</span>/rsync.pass'</span> <span class="string">,</span> <span class="attr">mode:</span> <span class="number">600</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="8-3-playbook-handlers"><a href="#8-3-playbook-handlers" class="headerlink" title="8.3 playbook handlers"></a>8.3 playbook handlers</h4><p>handlers是一个触发器，也是一个tasks，只不过是一个特殊的tasks，它是需要被tasks触发才会执行。只要配置文件发生变更，则会触发handlers执行重启服务操作，如果配置文件不发生任何变化，则不会重启！<br>notify监控——&gt;通知——&gt;handlers触发</p><h5 id="案例：playbook安装nginx"><a href="#案例：playbook安装nginx" class="headerlink" title="案例：playbook安装nginx"></a>案例：playbook安装nginx</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Instll</span> <span class="string">Nginx</span></span><br><span class="line">    <span class="attr">yum:</span> </span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">Nignx.conf</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">src:</span> <span class="string">nginx.conf.j2</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Nignx</span> <span class="string">Service</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nignx</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure><p><strong>handlers注意事项：</strong></p><ul><li>无论多少个task通知相同的handlers，handlers仅会在所有task结束后执行一次；</li><li>只有task发生变化后才会通知handlers，没有改变则不会触发handlers；</li><li>不能使用handlers代替task，因为handlers是一个特殊的task；</li></ul><h4 id="8-4-playbook-tag"><a href="#8-4-playbook-tag" class="headerlink" title="8.4 playbook tag"></a>8.4 playbook tag</h4><p>默认情况下，Ansible在执行一个playbook时，会执行playbook中的定义的所有任务。Ansible的标签（Tags）功能可以给单独任务甚至整个playbook打上tag标签，然后利用tag标签指定要运行的个别任务，或跳过个别的任务！</p><h6 id="案例："><a href="#案例：" class="headerlink" title="案例："></a>案例：</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Instll</span> <span class="string">Nginx</span></span><br><span class="line">    <span class="attr">yum:</span> </span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">install</span> <span class="string">nginx</span>            <span class="comment"># 添加tag标签</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">Nignx.conf</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">src:</span> <span class="string">nginx.conf.j2</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Nignx</span> <span class="string">Service</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">Nginx</span> </span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">start</span> <span class="string">nginx</span>          <span class="comment"># 添加tag标签</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nignx</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line"><span class="string">$</span> <span class="string">ansible-playbook</span> <span class="string">-i</span> <span class="string">hosts</span> <span class="string">test.yml</span>  <span class="string">-t</span> <span class="string">'install nginx'</span></span><br><span class="line"><span class="comment"># 仅仅执行playbook中的某个tag标签</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">$</span> <span class="string">ansible-playbook</span> <span class="string">-i</span> <span class="string">hosts</span> <span class="string">test.yml</span>  <span class="string">--skip-tags</span> <span class="string">'install nginx'</span></span><br><span class="line"><span class="comment"># 跳过playbook中的特定的tag标签</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">ansible-playbook</span> <span class="string">-i</span> <span class="string">hosts</span> <span class="string">test.yml</span>  <span class="string">-t</span> <span class="string">'install nginx'</span> <span class="string">-t</span> <span class="string">'start nginx'</span></span><br><span class="line"><span class="comment"># 指定多个tag标签</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">ansible-playbook</span> <span class="string">-i</span> <span class="string">hosts</span> <span class="string">test.yml</span>  <span class="string">--skip-tags</span> <span class="string">'install nginx'</span> <span class="string">--skip-tags</span> <span class="string">'start nginx'</span></span><br><span class="line"><span class="comment"># 跳过多个tag标签</span></span><br></pre></td></tr></table></figure><h4 id="8-5-playbook-include"><a href="#8-5-playbook-include" class="headerlink" title="8.5 playbook include"></a>8.5 playbook include</h4><p>有时发现大量的playbook内容要重复编写，与tasks之间贡呢需相互调用才能完成各自贡呢。playbook庞大到维护困难，这是就需要使用include！</p><h6 id="案例：-1"><a href="#案例：-1" class="headerlink" title="案例："></a>案例：</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat restart_httpd.yml </span></span><br><span class="line">- name: Restart Httpd Service</span><br><span class="line">  service:</span><br><span class="line">    name: httpd</span><br><span class="line">    state: restarted</span><br></pre></td></tr></table></figure><p>A Project的yaml文件：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">A</span> <span class="string">Project</span> <span class="string">command</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">echo</span> <span class="string">"A"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Httpd</span></span><br><span class="line">      <span class="attr">include:</span> <span class="string">restart_httpd.yml</span></span><br></pre></td></tr></table></figure><p>A Project的yaml文件：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">B</span> <span class="string">Project</span> <span class="string">command</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">echo</span> <span class="string">"B"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Httpd</span></span><br><span class="line">      <span class="attr">include:</span> <span class="string">restart_httpd.yml</span></span><br></pre></td></tr></table></figure><p><strong>高级用法：</strong></p><p>一次执行的多个playbook文件！</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat tasks_total.yml </span></span><br><span class="line">- import_playbook: test.yml</span><br><span class="line">- import_playbook: test01.yml</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook -i hosts  tasks_total.yml</span></span><br></pre></td></tr></table></figure><h4 id="8-6-ignore-errors忽略错误"><a href="#8-6-ignore-errors忽略错误" class="headerlink" title="8.6 ignore_errors忽略错误"></a>8.6 ignore_errors忽略错误</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Command</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/false</span></span><br><span class="line">      <span class="attr">ignore_errors:</span> <span class="literal">yes</span></span><br><span class="line">  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/tmp/file</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">touch</span></span><br></pre></td></tr></table></figure><h4 id="8-7-playbook错误处理"><a href="#8-7-playbook错误处理" class="headerlink" title="8.7 playbook错误处理"></a>8.7 playbook错误处理</h4><p>通常情况下，当task失败后，play将会终止，任何在前面已经被tasks notify的handlers都不会被执行。如果在play中设置<code>force_handlers</code>，被通知的handlers就会被强制执行。</p><h5 id="案例一：task执行失败强制调用handlers"><a href="#案例一：task执行失败强制调用handlers" class="headerlink" title="案例一：task执行失败强制调用handlers"></a>案例一：task执行失败强制调用handlers</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">force_handlers:</span> <span class="literal">yes</span>     <span class="comment"># 强制调用handlers</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Touch</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/tmp/test</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">touch</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Httpd</span> <span class="string">Service</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Packages</span></span><br><span class="line">      <span class="attr">yum:</span> </span><br><span class="line">        <span class="attr">name:</span> <span class="string">sb</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Httpd</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure><h5 id="案例二：-关闭change的状态（确定不会对被控端主机进行任何的修改和变更）"><a href="#案例二：-关闭change的状态（确定不会对被控端主机进行任何的修改和变更）" class="headerlink" title="案例二： 关闭change的状态（确定不会对被控端主机进行任何的修改和变更）"></a>案例二： 关闭change的状态（确定不会对被控端主机进行任何的修改和变更）</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Httpd</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">yum:</span> </span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Service</span> <span class="string">Httpd</span> <span class="string">Started</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">Httpd</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">ps</span> <span class="string">aux</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">check_httpd</span></span><br><span class="line">      <span class="attr">changed_when:</span> <span class="literal">false</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OutPut</span> <span class="string">Variables</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">&#123;&#123; check_httpd.stdout_lines &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure><h5 id="案例三：-使用changed-when检查tasksrre任务返回结果"><a href="#案例三：-使用changed-when检查tasksrre任务返回结果" class="headerlink" title="案例三： 使用changed_when检查tasksrre任务返回结果"></a>案例三： 使用changed_when检查tasksrre任务返回结果</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Nginx</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">nginx.conf.j2</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">Server</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">Httpd</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">/usr/sbin/nginx</span> <span class="string">-t</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">nginx_check</span></span><br><span class="line">      <span class="attr">changed_when:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">(nginx_check.stdout.find('successful'))</span></span><br><span class="line">        <span class="bullet">-</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">Httpd</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">handlers:</span> <span class="string">Restart</span> <span class="string">Httpd</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure><p><strong><strong><strong>***</strong></strong></strong> 当你发现自己的才华撑不起野心时，就请安静下来学习吧！<strong><strong><strong>***</strong></strong></strong></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;原文链接：&lt;a href=&quot;https://www.cnblogs.com/lvzhenjiang/p/14199445.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.cnblogs.com/lvzhenjiang/p/1
      
    
    </summary>
    
    
      <category term="ansible" scheme="http://yoursite.com/categories/ansible/"/>
    
    
      <category term="ansible" scheme="http://yoursite.com/tags/ansible/"/>
    
  </entry>
  
  <entry>
    <title>fastdfs</title>
    <link href="http://yoursite.com/2021/04/04/fastdfs/"/>
    <id>http://yoursite.com/2021/04/04/fastdfs/</id>
    <published>2021-04-04T03:47:17.984Z</published>
    <updated>2021-04-04T03:47:17.977Z</updated>
    
    <content type="html"><![CDATA[<h1 id="用FastDFS一步步搭建文件管理系统"><a href="#用FastDFS一步步搭建文件管理系统" class="headerlink" title="用FastDFS一步步搭建文件管理系统"></a><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html" target="_blank" rel="noopener">用FastDFS一步步搭建文件管理系统</a></h1><p><strong>目录</strong></p><ul><li>一、FastDFS介绍<ul><li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label0_0" target="_blank" rel="noopener">1、简介</a></li><li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label0_1" target="_blank" rel="noopener">2、FastDFS的存储策略</a></li><li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label0_2" target="_blank" rel="noopener">3、FastDFS的上传过程</a></li><li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label0_3" target="_blank" rel="noopener">4、FastDFS的文件同步</a></li><li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label0_4" target="_blank" rel="noopener">5、FastDFS的文件下载</a></li></ul></li><li>二、安装FastDFS环境<ul><li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label1_0" target="_blank" rel="noopener">0、前言</a></li><li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label1_1" target="_blank" rel="noopener">1、下载安装 libfastcommon</a></li><li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label1_2" target="_blank" rel="noopener">2、下载安装FastDFS</a></li><li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label1_3" target="_blank" rel="noopener">3、配置FastDFS跟踪器(Tracker)</a></li><li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label1_4" target="_blank" rel="noopener">4、配置 FastDFS 存储 (Storage)</a></li><li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label1_5" target="_blank" rel="noopener">5、文件上传测试</a></li></ul></li><li>三、安装Nginx<ul><li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label2_0" target="_blank" rel="noopener">1、安装nginx所需环境　　</a></li><li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label2_1" target="_blank" rel="noopener">2、安装Nginx</a></li><li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label2_2" target="_blank" rel="noopener">3、访问文件</a></li></ul></li><li>四、FastDFS 配置 Nginx 模块<ul><li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label3_0" target="_blank" rel="noopener">1、安装配置Nginx模块</a></li></ul></li><li>五、Java客户端<ul><li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label4_0" target="_blank" rel="noopener">1、首先需要搭建 FastDFS 客户端Java开发环境</a></li><li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label4_1" target="_blank" rel="noopener">2、客户端API</a></li><li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label4_2" target="_blank" rel="noopener">六、权限控制</a></li></ul></li></ul><hr><p><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_labelTop" target="_blank" rel="noopener">回到顶部</a></p><h2 id="一、FastDFS介绍"><a href="#一、FastDFS介绍" class="headerlink" title="一、FastDFS介绍"></a>一、FastDFS介绍</h2><p>FastDFS开源地址：<a href="https://github.com/happyfish100" target="_blank" rel="noopener">https://github.com/happyfish100</a></p><p>参考：<a href="http://blog.chinaunix.net/uid-20196318-id-4058561.html" target="_blank" rel="noopener">分布式文件系统FastDFS设计原理</a> </p><p>参考：<a href="http://www.cnblogs.com/Leo_wl/p/6731647.html" target="_blank" rel="noopener">FastDFS分布式文件系统</a></p><p>个人封装的FastDFS Java API：<a href="https://github.com/bojiangzhou/lyyzoo-fastdfs-java" target="_blank" rel="noopener">https://github.com/bojiangzhou/lyyzoo-fastdfs-java</a></p><h3 id="1、简介"><a href="#1、简介" class="headerlink" title="1、简介"></a>1、简介</h3><p>FastDFS 是一个开源的高性能分布式文件系统（DFS）。 它的主要功能包括：文件存储，文件同步和文件访问，以及高容量和负载平衡。主要解决了海量数据存储问题，特别适合以中小文件（建议范围：4KB &lt; file_size &lt;500MB）为载体的在线服务。</p><p>FastDFS 系统有三个角色：跟踪服务器(Tracker Server)、存储服务器(Storage Server)和客户端(Client)。</p><p>　　<strong>Tracker Server</strong>：跟踪服务器，主要做调度工作，起到均衡的作用；负责管理所有的 storage server和 group，每个 storage 在启动后会连接 Tracker，告知自己所属 group 等信息，并保持周期性心跳。</p><p>　　<strong>Storage Server</strong>：存储服务器，主要提供容量和备份服务；以 group 为单位，每个 group 内可以有多台 storage server，数据互为备份。</p><p>　　<strong>Client</strong>：客户端，上传下载数据的服务器，也就是我们自己的项目所部署在的服务器。</p><p> <img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011144153840-1185141903.png" alt="img"></p><h3 id="2、FastDFS的存储策略"><a href="#2、FastDFS的存储策略" class="headerlink" title="2、FastDFS的存储策略"></a><strong>2、FastDFS的存储策略</strong></h3><p>为了支持大容量，存储节点（服务器）采用了分卷（或分组）的组织方式。存储系统由一个或多个卷组成，卷与卷之间的文件是相互独立的，所有卷的文件容量累加就是整个存储系统中的文件容量。一个卷可以由一台或多台存储服务器组成，一个卷下的存储服务器中的文件都是相同的，卷中的多台存储服务器起到了冗余备份和负载均衡的作用。</p><p>在卷中增加服务器时，同步已有的文件由系统自动完成，同步完成后，系统自动将新增服务器切换到线上提供服务。当存储空间不足或即将耗尽时，可以动态添加卷。只需要增加一台或多台服务器，并将它们配置为一个新的卷，这样就扩大了存储系统的容量。</p><h3 id="3、FastDFS的上传过程"><a href="#3、FastDFS的上传过程" class="headerlink" title="3、FastDFS的上传过程"></a><strong>3、FastDFS的上传过程</strong></h3><p>FastDFS向使用者提供基本文件访问接口，比如upload、download、append、delete等，以客户端库的方式提供给用户使用。</p><p>Storage Server会定期的向Tracker Server发送自己的存储信息。当Tracker Server Cluster中的Tracker Server不止一个时，各个Tracker之间的关系是对等的，所以客户端上传时可以选择任意一个Tracker。</p><p>当Tracker收到客户端上传文件的请求时，会为该文件分配一个可以存储文件的group，当选定了group后就要决定给客户端分配group中的哪一个storage server。当分配好storage server后，客户端向storage发送写文件请求，storage将会为文件分配一个数据存储目录。然后为文件分配一个fileid，最后根据以上的信息生成文件名存储文件。</p><p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171012121639387-1574147926.png" alt="img"></p><h3 id="4、FastDFS的文件同步"><a href="#4、FastDFS的文件同步" class="headerlink" title="4、FastDFS的文件同步"></a><strong>4、FastDFS的文件同步</strong></h3><p>写文件时，客户端将文件写至group内一个storage server即认为写文件成功，storage server写完文件后，会由后台线程将文件同步至同group内其他的storage server。</p><p>每个storage写文件后，同时会写一份binlog，binlog里不包含文件数据，只包含文件名等元信息，这份binlog用于后台同步，storage会记录向group内其他storage同步的进度，以便重启后能接上次的进度继续同步；进度以时间戳的方式进行记录，所以最好能保证集群内所有server的时钟保持同步。</p><p>storage的同步进度会作为元数据的一部分汇报到tracker上，tracke在选择读storage的时候会以同步进度作为参考。</p><h3 id="5、FastDFS的文件下载"><a href="#5、FastDFS的文件下载" class="headerlink" title="5、FastDFS的文件下载"></a><strong>5、FastDFS的文件下载</strong></h3><p>客户端uploadfile成功后，会拿到一个storage生成的文件名，接下来客户端根据这个文件名即可访问到该文件。</p><p><img src="https://images2015.cnblogs.com/blog/380252/201704/380252-20170415090611017-204910775.png" alt="img"></p><p>跟upload file一样，在downloadfile时客户端可以选择任意tracker server。tracker发送download请求给某个tracker，必须带上文件名信息，tracke从文件名中解析出文件的group、大小、创建时间等信息，然后为该请求选择一个storage用来服务读请求。</p><p><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_labelTop" target="_blank" rel="noopener">回到顶部</a></p><h2 id="二、安装FastDFS环境"><a href="#二、安装FastDFS环境" class="headerlink" title="二、安装FastDFS环境"></a>二、安装FastDFS环境</h2><h3 id="0、前言"><a href="#0、前言" class="headerlink" title="0、前言"></a>0、前言</h3><p>操作环境：CentOS7 X64，以下操作都是单机环境。</p><p>我把所有的安装包下载到/softpackages/下，解压到当前目录。</p><p>先做一件事，修改hosts，将文件服务器的ip与域名映射(单机TrackerServer环境)，因为后面很多配置里面都需要去配置服务器地址，ip变了，就只需要修改hosts即可。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># vim &#x2F;etc&#x2F;hosts</span><br><span class="line"></span><br><span class="line">增加如下一行，这是我的IP</span><br><span class="line">192.168.51.128 file.ljzsg.com</span><br><span class="line"></span><br><span class="line">如果要本机访问虚拟机，在C:\Windows\System32\drivers\etc\hosts中同样增加一行</span><br></pre></td></tr></table></figure><h3 id="1、下载安装-libfastcommon"><a href="#1、下载安装-libfastcommon" class="headerlink" title="1、下载安装 libfastcommon"></a>1、下载安装 libfastcommon</h3><p>libfastcommon是从 FastDFS 和 FastDHT 中提取出来的公共 C 函数库，基础环境，安装即可 。</p><p>① 下载libfastcommon</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># wget https:&#x2F;&#x2F;github.com&#x2F;happyfish100&#x2F;libfastcommon&#x2F;archive&#x2F;V1.0.7.tar.gz</span><br></pre></td></tr></table></figure><p>② 解压</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># tar -zxvf V1.0.7.tar.gz</span><br><span class="line"># cd libfastcommon-1.0.7</span><br></pre></td></tr></table></figure><p>③ 编译、安装</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># .&#x2F;make.sh</span><br><span class="line"># .&#x2F;make.sh install</span><br></pre></td></tr></table></figure><p>④ libfastcommon.so 安装到了/usr/lib64/libfastcommon.so，但是FastDFS主程序设置的lib目录是/usr/local/lib，所以需要创建软链接。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># ln -s &#x2F;usr&#x2F;lib64&#x2F;libfastcommon.so &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libfastcommon.so</span><br><span class="line"># ln -s &#x2F;usr&#x2F;lib64&#x2F;libfastcommon.so &#x2F;usr&#x2F;lib&#x2F;libfastcommon.so</span><br><span class="line"># ln -s &#x2F;usr&#x2F;lib64&#x2F;libfdfsclient.so &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libfdfsclient.so</span><br><span class="line"># ln -s &#x2F;usr&#x2F;lib64&#x2F;libfdfsclient.so &#x2F;usr&#x2F;lib&#x2F;libfdfsclient.so</span><br></pre></td></tr></table></figure><h3 id="2、下载安装FastDFS"><a href="#2、下载安装FastDFS" class="headerlink" title="2、下载安装FastDFS"></a>2、下载安装FastDFS</h3><p>① 下载FastDFS</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># wget https:&#x2F;&#x2F;github.com&#x2F;happyfish100&#x2F;fastdfs&#x2F;archive&#x2F;V5.05.tar.gz</span><br></pre></td></tr></table></figure><p>② 解压</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># tar -zxvf V5.05.tar.gz</span><br><span class="line"># cd fastdfs-5.05</span><br></pre></td></tr></table></figure><p>③ 编译、安装</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># .&#x2F;make.sh</span><br><span class="line"># .&#x2F;make.sh install</span><br></pre></td></tr></table></figure><p>④ 默认安装方式安装后的相应文件与目录<br>　　A、服务脚本：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;init.d&#x2F;fdfs_storaged</span><br><span class="line">&#x2F;etc&#x2F;init.d&#x2F;fdfs_tracker</span><br></pre></td></tr></table></figure><p>　　B、配置文件（这三个是作者给的样例配置文件） :</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;fdfs&#x2F;client.conf.sample</span><br><span class="line">&#x2F;etc&#x2F;fdfs&#x2F;storage.conf.sample</span><br><span class="line">&#x2F;etc&#x2F;fdfs&#x2F;tracker.conf.sample</span><br></pre></td></tr></table></figure><p>　　C、命令工具在 /usr/bin/ 目录下：</p><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">fdfs_appender_test</span><br><span class="line">fdfs_appender_test1</span><br><span class="line">fdfs_append_file</span><br><span class="line">fdfs_crc32</span><br><span class="line">fdfs_delete_file</span><br><span class="line">fdfs_download_file</span><br><span class="line">fdfs_file_info</span><br><span class="line">fdfs_monitor</span><br><span class="line">fdfs_storaged</span><br><span class="line">fdfs_test</span><br><span class="line">fdfs_test1</span><br><span class="line">fdfs_trackerd</span><br><span class="line">fdfs_upload_appender</span><br><span class="line">fdfs_upload_file</span><br><span class="line">stop.sh</span><br><span class="line">restart.sh</span><br></pre></td></tr></table></figure><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><p>⑤ FastDFS 服务脚本设置的 bin 目录是 /usr/local/bin， 但实际命令安装在 /usr/bin/ 下。</p><p>　　两种方式：</p><p>　　》 一是修改FastDFS 服务脚本中相应的命令路径，也就是把 /etc/init.d/fdfs_storaged 和 /etc/init.d/fdfs_tracker 两个脚本中的 /usr/local/bin 修改成 /usr/bin。</p><p> 　　　# vim fdfs_trackerd<br>　　　　使用查找替换命令进统一修改:%s+/usr/local/bin+/usr/bin<br>　　　　# vim fdfs_storaged<br>　　　　使用查找替换命令进统一修改:%s+/usr/local/bin+/usr/bin</p><p>　　　　<img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011104718043-576731412.png" alt="img"></p><p>　　》 二是建立 /usr/bin 到 /usr/local/bin 的软链接，我是用这种方式。　　</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># ln -s &#x2F;usr&#x2F;bin&#x2F;fdfs_trackerd   &#x2F;usr&#x2F;local&#x2F;bin</span><br><span class="line"># ln -s &#x2F;usr&#x2F;bin&#x2F;fdfs_storaged   &#x2F;usr&#x2F;local&#x2F;bin</span><br><span class="line"># ln -s &#x2F;usr&#x2F;bin&#x2F;stop.sh         &#x2F;usr&#x2F;local&#x2F;bin</span><br><span class="line"># ln -s &#x2F;usr&#x2F;bin&#x2F;restart.sh      &#x2F;usr&#x2F;local&#x2F;bin</span><br></pre></td></tr></table></figure><h3 id="3、配置FastDFS跟踪器-Tracker"><a href="#3、配置FastDFS跟踪器-Tracker" class="headerlink" title="3、配置FastDFS跟踪器(Tracker)"></a>3、配置FastDFS跟踪器(Tracker)</h3><p>配置文件详细说明参考：<a href="http://bbs.chinaunix.net/forum.php?mod=viewthread&tid=1941456&extra=page%3D1%26filter%3Ddigest%26digest%3D1" target="_blank" rel="noopener">FastDFS 配置文件详解</a></p><p>① 进入 /etc/fdfs，复制 FastDFS 跟踪器样例配置文件 tracker.conf.sample，并重命名为 tracker.conf。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;etc&#x2F;fdfs</span><br><span class="line"># cp tracker.conf.sample tracker.conf</span><br><span class="line"># vim tracker.conf</span><br></pre></td></tr></table></figure><p>② 编辑tracker.conf ，标红的需要修改下，其它的默认即可。</p><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 配置文件是否不生效，false 为生效</span><br><span class="line">disabled&#x3D;false</span><br><span class="line"># 提供服务的端口</span><br><span class="line">port&#x3D;22122</span><br><span class="line"># Tracker 数据和日志目录地址(根目录必须存在,子目录会自动创建)</span><br><span class="line">base_path&#x3D;&#x2F;ljzsg&#x2F;fastdfs&#x2F;tracker</span><br><span class="line"># HTTP 服务端口</span><br><span class="line">http.server_port&#x3D;80</span><br></pre></td></tr></table></figure><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><p>③ 创建tracker基础数据目录，即base_path对应的目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p &#x2F;ljzsg&#x2F;fastdfs&#x2F;tracker</span><br></pre></td></tr></table></figure><p>④ 防火墙中打开跟踪端口（默认的22122）</p><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># vim &#x2F;etc&#x2F;sysconfig&#x2F;iptables</span><br><span class="line">添加如下端口行：</span><br><span class="line">-A INPUT -m state --state NEW -m tcp -p tcp --dport 22122 -j ACCEPT</span><br><span class="line">重启防火墙：</span><br><span class="line"># service iptables restart</span><br></pre></td></tr></table></figure><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><p>⑤ 启动Tracker</p><p>初次成功启动，会在 /ljzsg/fdfsdfs/tracker/ (配置的base_path)下创建 data、logs 两个目录。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">可以用这种方式启动</span><br><span class="line"># &#x2F;etc&#x2F;init.d&#x2F;fdfs_trackerd start</span><br><span class="line"></span><br><span class="line">也可以用这种方式启动，前提是上面创建了软链接，后面都用这种方式</span><br><span class="line"># service fdfs_trackerd start</span><br></pre></td></tr></table></figure><p>查看 FastDFS Tracker 是否已成功启动 ，22122端口正在被监听，则算是Tracker服务安装成功。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># netstat -unltp|grep fdfs</span><br></pre></td></tr></table></figure><p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011121344184-1089101646.png" alt="img"></p><p>关闭Tracker命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># service fdfs_trackerd stop</span><br></pre></td></tr></table></figure><p>⑥ 设置Tracker开机启动</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># chkconfig fdfs_trackerd on</span><br><span class="line"></span><br><span class="line">或者：</span><br><span class="line"># vim &#x2F;etc&#x2F;rc.d&#x2F;rc.local</span><br><span class="line">加入配置：</span><br><span class="line">&#x2F;etc&#x2F;init.d&#x2F;fdfs_trackerd start</span><br></pre></td></tr></table></figure><p>⑦ tracker server 目录及文件结构</p><p>Tracker服务启动成功后，会在base_path下创建data、logs两个目录。目录结构如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$&#123;base_path&#125;</span><br><span class="line">  |__data</span><br><span class="line">  |   |__storage_groups.dat：存储分组信息</span><br><span class="line">  |   |__storage_servers.dat：存储服务器列表</span><br><span class="line">  |__logs</span><br><span class="line">  |   |__trackerd.log： tracker server 日志文件</span><br></pre></td></tr></table></figure><h3 id="4、配置-FastDFS-存储-Storage"><a href="#4、配置-FastDFS-存储-Storage" class="headerlink" title="4、配置 FastDFS 存储 (Storage)"></a>4、配置 FastDFS 存储 (Storage)</h3><p>① 进入 /etc/fdfs 目录，复制 FastDFS 存储器样例配置文件 storage.conf.sample，并重命名为 storage.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;etc&#x2F;fdfs</span><br><span class="line"># cp storage.conf.sample storage.conf# vim storage.conf</span><br></pre></td></tr></table></figure><p>② 编辑storage.conf</p><p>标红的需要修改，其它的默认即可。</p><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># 配置文件是否不生效，false 为生效</span><br><span class="line">disabled&#x3D;false </span><br><span class="line"></span><br><span class="line"># 指定此 storage server 所在 组(卷)</span><br><span class="line">group_name&#x3D;group1</span><br><span class="line"></span><br><span class="line"># storage server 服务端口</span><br><span class="line">port&#x3D;23000</span><br><span class="line"></span><br><span class="line"># 心跳间隔时间，单位为秒 (这里是指主动向 tracker server 发送心跳)</span><br><span class="line">heart_beat_interval&#x3D;30</span><br><span class="line"></span><br><span class="line"># Storage 数据和日志目录地址(根目录必须存在，子目录会自动生成)</span><br><span class="line">base_path&#x3D;&#x2F;ljzsg&#x2F;fastdfs&#x2F;storage</span><br><span class="line"></span><br><span class="line"># 存放文件时 storage server 支持多个路径。这里配置存放文件的基路径数目，通常只配一个目录。</span><br><span class="line">store_path_count&#x3D;1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 逐一配置 store_path_count 个路径，索引号基于 0。</span><br><span class="line"># 如果不配置 store_path0，那它就和 base_path 对应的路径一样。</span><br><span class="line">store_path0&#x3D;&#x2F;ljzsg&#x2F;fastdfs&#x2F;file</span><br><span class="line"></span><br><span class="line"># FastDFS 存储文件时，采用了两级目录。这里配置存放文件的目录个数。 </span><br><span class="line"># 如果本参数只为 N（如： 256），那么 storage server 在初次运行时，会在 store_path 下自动创建 N * N 个存放文件的子目录。</span><br><span class="line">subdir_count_per_path&#x3D;256</span><br><span class="line"></span><br><span class="line"># tracker_server 的列表 ，会主动连接 tracker_server</span><br><span class="line"># 有多个 tracker server 时，每个 tracker server 写一行</span><br><span class="line">tracker_server&#x3D;file.ljzsg.com:22122# 允许系统同步的时间段 (默认是全天) 。一般用于避免高峰同步产生一些问题而设定。sync_start_time&#x3D;00:00sync_end_time&#x3D;23:59</span><br><span class="line"># 访问端口</span><br><span class="line">http.server_port&#x3D;80</span><br></pre></td></tr></table></figure><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><p>③ 创建Storage基础数据目录，对应base_path目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p &#x2F;ljzsg&#x2F;fastdfs&#x2F;storage</span><br><span class="line"></span><br><span class="line"># 这是配置的store_path0路径</span><br><span class="line"># mkdir -p &#x2F;ljzsg&#x2F;fastdfs&#x2F;file</span><br></pre></td></tr></table></figure><p>④ 防火墙中打开存储器端口（默认的 23000）</p><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># vim &#x2F;etc&#x2F;sysconfig&#x2F;iptables</span><br><span class="line"></span><br><span class="line">添加如下端口行：</span><br><span class="line">-A INPUT -m state --state NEW -m tcp -p tcp --dport 23000 -j ACCEPT</span><br><span class="line"></span><br><span class="line">重启防火墙：</span><br><span class="line"># service iptables restart</span><br></pre></td></tr></table></figure><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011133233777-1903096242.png" alt="img"></p><p>⑤ 启动 Storage</p><p>启动Storage前确保Tracker是启动的。初次启动成功，会在 /ljzsg/fastdfs/storage 目录下创建 data、 logs 两个目录。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">可以用这种方式启动</span><br><span class="line"># &#x2F;etc&#x2F;init.d&#x2F;fdfs_storaged start</span><br><span class="line"></span><br><span class="line">也可以用这种方式，后面都用这种</span><br><span class="line"># service fdfs_storaged start</span><br></pre></td></tr></table></figure><p>查看 Storage 是否成功启动，23000 端口正在被监听，就算 Storage 启动成功。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># netstat -unltp|grep fdfs</span><br></pre></td></tr></table></figure><p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011134723387-604894314.png" alt="img"></p><p>关闭Storage命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># service fdfs_storaged stop</span><br></pre></td></tr></table></figure><p>查看Storage和Tracker是否在通信：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;bin&#x2F;fdfs_monitor &#x2F;etc&#x2F;fdfs&#x2F;storage.conf</span><br></pre></td></tr></table></figure><p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171016093815615-757608481.png" alt="img"></p><p>⑥ 设置 Storage 开机启动</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># chkconfig fdfs_storaged on</span><br><span class="line">或者：</span><br><span class="line"># vim &#x2F;etc&#x2F;rc.d&#x2F;rc.local</span><br><span class="line">加入配置：</span><br><span class="line">&#x2F;etc&#x2F;init.d&#x2F;fdfs_storaged start</span><br></pre></td></tr></table></figure><p>⑦ Storage 目录</p><p>同 Tracker，Storage 启动成功后，在base_path 下创建了data、logs目录，记录着 Storage Server 的信息。</p><p>在 store_path0 目录下，创建了N*N个子目录：</p><p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011135658074-1715166829.png" alt="img"></p><h3 id="5、文件上传测试"><a href="#5、文件上传测试" class="headerlink" title="5、文件上传测试"></a>5、文件上传测试</h3><p>① 修改 Tracker 服务器中的客户端配置文件 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;etc&#x2F;fdfs</span><br><span class="line"># cp client.conf.sample client.conf</span><br><span class="line"># vim client.conf</span><br></pre></td></tr></table></figure><p>修改如下配置即可，其它默认。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Client 的数据和日志目录</span><br><span class="line">base_path&#x3D;&#x2F;ljzsg&#x2F;fastdfs&#x2F;client</span><br><span class="line"></span><br><span class="line"># Tracker端口</span><br><span class="line">tracker_server&#x3D;file.ljzsg.com:22122</span><br></pre></td></tr></table></figure><p>② 上传测试</p><p> 在linux内部执行如下命令上传 namei.jpeg 图片</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># &#x2F;usr&#x2F;bin&#x2F;fdfs_upload_file &#x2F;etc&#x2F;fdfs&#x2F;client.conf namei.jpeg</span><br></pre></td></tr></table></figure><p>上传成功后返回文件ID号：group1/M00/00/00/wKgz6lnduTeAMdrcAAEoRmXZPp870.jpeg</p><p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011142634105-1857091563.png" alt="img"></p><p>返回的文件ID由group、存储目录、两级子目录、fileid、文件后缀名（由客户端指定，主要用于区分文件类型）拼接而成。</p><p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011151728965-914197096.png" alt="img"></p><p><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_labelTop" target="_blank" rel="noopener">回到顶部</a></p><h2 id="三、安装Nginx"><a href="#三、安装Nginx" class="headerlink" title="三、安装Nginx"></a>三、安装Nginx</h2><p>上面将文件上传成功了，但我们无法下载。因此安装Nginx作为服务器以支持Http方式访问文件。同时，后面安装FastDFS的Nginx模块也需要Nginx环境。</p><p>Nginx只需要安装到StorageServer所在的服务器即可，用于访问文件。我这里由于是单机，TrackerServer和StorageServer在一台服务器上。</p><h3 id="1、安装nginx所需环境"><a href="#1、安装nginx所需环境" class="headerlink" title="1、安装nginx所需环境　　"></a>1、安装nginx所需环境　　</h3><p>① gcc 安装</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># yum install gcc-c++</span><br></pre></td></tr></table></figure><p>② PCRE pcre-devel 安装</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># yum install -y pcre pcre-devel</span><br></pre></td></tr></table></figure><p>③ zlib 安装</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># yum install -y zlib zlib-devel</span><br></pre></td></tr></table></figure><p>④ OpenSSL 安装</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># yum install -y openssl openssl-devel</span><br></pre></td></tr></table></figure><h3 id="2、安装Nginx"><a href="#2、安装Nginx" class="headerlink" title="2、安装Nginx"></a>2、安装Nginx</h3><p>① 下载nginx</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># wget -c https:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.12.1.tar.gz</span><br></pre></td></tr></table></figure><p>② 解压</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># tar -zxvf nginx-1.12.1.tar.gz</span><br><span class="line"># cd nginx-1.12.1</span><br></pre></td></tr></table></figure><p>③ 使用默认配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># .&#x2F;configure</span><br></pre></td></tr></table></figure><p>④ 编译、安装</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># make</span><br><span class="line"># make install</span><br></pre></td></tr></table></figure><p>⑤ 启动nginx</p><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;</span><br><span class="line"># .&#x2F;nginx </span><br><span class="line"></span><br><span class="line">其它命令</span><br><span class="line"># .&#x2F;nginx -s stop</span><br><span class="line"># .&#x2F;nginx -s quit</span><br><span class="line"># .&#x2F;nginx -s reload</span><br></pre></td></tr></table></figure><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><p>⑥ 设置开机启动</p><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># vim &#x2F;etc&#x2F;rc.local</span><br><span class="line"></span><br><span class="line">添加一行：</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx# 设置执行权限# chmod 755 rc.local</span><br></pre></td></tr></table></figure><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><p>⑦ 查看nginx的版本及模块</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -V</span><br></pre></td></tr></table></figure><p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011165300730-1693050013.png" alt="img"></p><p>⑧ 防火墙中打开Nginx端口（默认的 80） </p><p>添加后就能在本机使用80端口访问了。</p><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># vim &#x2F;etc&#x2F;sysconfig&#x2F;iptables</span><br><span class="line"></span><br><span class="line">添加如下端口行：</span><br><span class="line">-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT</span><br><span class="line"></span><br><span class="line">重启防火墙：</span><br><span class="line"># service iptables restart</span><br></pre></td></tr></table></figure><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011172121746-2118138931.png" alt="img"></p><h3 id="3、访问文件"><a href="#3、访问文件" class="headerlink" title="3、访问文件"></a>3、访问文件</h3><p>简单的测试访问文件</p><p>① 修改nginx.conf</p><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># vim &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</span><br><span class="line"></span><br><span class="line">添加如下行，将 &#x2F;group1&#x2F;M00 映射到 &#x2F;ljzsg&#x2F;fastdfs&#x2F;file&#x2F;data</span><br><span class="line">location &#x2F;group1&#x2F;M00 &#123;</span><br><span class="line">    alias &#x2F;ljzsg&#x2F;fastdfs&#x2F;file&#x2F;data;</span><br><span class="line">&#125;# 重启nginx# &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -s reload</span><br></pre></td></tr></table></figure><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011180543746-937678567.png" alt="img"></p><p>② 在浏览器访问之前上传的图片、成功。</p><p><a href="http://file.ljzsg.com/group1/M00/00/00/wKgz6lnduTeAMdrcAAEoRmXZPp870.jpeg" target="_blank" rel="noopener">http://file.ljzsg.com/group1/M00/00/00/wKgz6lnduTeAMdrcAAEoRmXZPp870.jpeg</a></p><p><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_labelTop" target="_blank" rel="noopener">回到顶部</a></p><h2 id="四、FastDFS-配置-Nginx-模块"><a href="#四、FastDFS-配置-Nginx-模块" class="headerlink" title="四、FastDFS 配置 Nginx 模块"></a>四、FastDFS 配置 Nginx 模块</h2><h3 id="1、安装配置Nginx模块"><a href="#1、安装配置Nginx模块" class="headerlink" title="1、安装配置Nginx模块"></a>1、安装配置Nginx模块</h3><p>① fastdfs-nginx-module 模块说明</p><p>　　FastDFS 通过 Tracker 服务器，将文件放在 Storage 服务器存储， 但是同组存储服务器之间需要进行文件复制， 有同步延迟的问题。</p><p>　　假设 Tracker 服务器将文件上传到了 192.168.51.128，上传成功后文件 ID已经返回给客户端。</p><p>　　此时 FastDFS 存储集群机制会将这个文件同步到同组存储 192.168.51.129，在文件还没有复制完成的情况下，客户端如果用这个文件 ID 在 192.168.51.129 上取文件,就会出现文件无法访问的错误。</p><p>　　而 fastdfs-nginx-module 可以重定向文件链接到源服务器取文件，避免客户端由于复制延迟导致的文件无法访问错误。</p><p>② 下载 fastdfs-nginx-module、解压</p><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 这里为啥这么长一串呢，因为最新版的master与当前nginx有些版本问题。</span><br><span class="line"># wget https:&#x2F;&#x2F;github.com&#x2F;happyfish100&#x2F;fastdfs-nginx-module&#x2F;archive&#x2F;5e5f3566bbfa57418b5506aaefbe107a42c9fcb1.zip</span><br><span class="line"></span><br><span class="line"># 解压</span><br><span class="line"># unzip 5e5f3566bbfa57418b5506aaefbe107a42c9fcb1.zip</span><br><span class="line"></span><br><span class="line"># 重命名</span><br><span class="line"># mv fastdfs-nginx-module-5e5f3566bbfa57418b5506aaefbe107a42c9fcb1  fastdfs-nginx-module-master</span><br></pre></td></tr></table></figure><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><p>③ 配置Nginx</p><p>在nginx中添加模块</p><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 先停掉nginx服务# &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -s stop进入解压包目录</span><br><span class="line"># cd &#x2F;softpackages&#x2F;nginx-1.12.1&#x2F;</span><br><span class="line"></span><br><span class="line"># 添加模块</span><br><span class="line"># .&#x2F;configure --add-module&#x3D;..&#x2F;fastdfs-nginx-module-master&#x2F;src</span><br><span class="line"></span><br><span class="line">重新编译、安装</span><br><span class="line"># make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><p> ④ 查看Nginx的模块</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -V</span><br></pre></td></tr></table></figure><p>有下面这个就说明添加模块成功</p><p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011224125574-1739252073.png" alt="img"></p><p>⑤ 复制 fastdfs-nginx-module 源码中的配置文件到/etc/fdfs 目录， 并修改</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;softpackages&#x2F;fastdfs-nginx-module-master&#x2F;src</span><br><span class="line"></span><br><span class="line"># cp mod_fastdfs.conf &#x2F;etc&#x2F;fdfs&#x2F;</span><br></pre></td></tr></table></figure><p>修改如下配置，其它默认</p><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 连接超时时间connect_timeout&#x3D;10</span><br><span class="line"></span><br><span class="line"># Tracker Server</span><br><span class="line">tracker_server&#x3D;file.ljzsg.com:22122</span><br><span class="line"># StorageServer 默认端口</span><br><span class="line">storage_server_port&#x3D;23000</span><br><span class="line"></span><br><span class="line"># 如果文件ID的uri中包含&#x2F;group**，则要设置为true</span><br><span class="line">url_have_group_name &#x3D; true</span><br><span class="line"></span><br><span class="line"># Storage 配置的store_path0路径，必须和storage.conf中的一致</span><br><span class="line">store_path0&#x3D;&#x2F;ljzsg&#x2F;fastdfs&#x2F;file</span><br></pre></td></tr></table></figure><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><p>⑥ 复制 FastDFS 的部分配置文件到/etc/fdfs 目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;softpackages&#x2F;fastdfs-5.05&#x2F;conf&#x2F;</span><br><span class="line"></span><br><span class="line"># cp anti-steal.jpg http.conf mime.types &#x2F;etc&#x2F;fdfs&#x2F;</span><br></pre></td></tr></table></figure><p> ⑦ 配置nginx，修改nginx.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vim &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</span><br></pre></td></tr></table></figure><p>修改配置，其它的默认</p><p>在80端口下添加fastdfs-nginx模块</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location ~&#x2F;group([0-9])&#x2F;M00 &#123;</span><br><span class="line">    ngx_fastdfs_module;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011184247777-40074297.png" alt="img"></p><p>注意：</p><p>　　listen 80 端口值是要与 /etc/fdfs/storage.conf 中的 http.server_port=80 (前面改成80了)相对应。如果改成其它端口，则需要统一，同时在防火墙中打开该端口。</p><p>　　location 的配置，如果有多个group则配置location ~/group([0-9])/M00 ，没有则不用配group。</p><p>⑧ 在/ljzsg/fastdfs/file 文件存储目录下创建软连接，将其链接到实际存放数据的目录，这一步可以省略。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ln -s &#x2F;ljzsg&#x2F;fastdfs&#x2F;file&#x2F;data&#x2F; &#x2F;ljzsg&#x2F;fastdfs&#x2F;file&#x2F;data&#x2F;M00</span><br></pre></td></tr></table></figure><p>⑨ 启动nginx</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx</span><br></pre></td></tr></table></figure><p>打印处如下就算配置成功</p><p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011230509512-654301113.png" alt="img"></p><p>⑩ 在地址栏访问。</p><p>能下载文件就算安装成功。注意和第三点中直接使用nginx路由访问不同的是，这里配置 fastdfs-nginx-module 模块，可以重定向文件链接到源服务器取文件。</p><p><a href="http://file.ljzsg.com/group1/M00/00/00/wKgz6lnduTeAMdrcAAEoRmXZPp870.jpeg" target="_blank" rel="noopener">http://file.ljzsg.com/group1/M00/00/00/wKgz6lnduTeAMdrcAAEoRmXZPp870.jpeg</a></p><p>最终部署结构图(盗的图)：可以按照下面的结构搭建环境。</p><p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171012180511480-692747720.png" alt="img"></p><p><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_labelTop" target="_blank" rel="noopener">回到顶部</a></p><h2 id="五、Java客户端"><a href="#五、Java客户端" class="headerlink" title="五、Java客户端"></a>五、Java客户端</h2><p>前面文件系统平台搭建好了，现在就要写客户端代码在系统中实现上传下载，这里只是简单的测试代码。</p><h3 id="1、首先需要搭建-FastDFS-客户端Java开发环境"><a href="#1、首先需要搭建-FastDFS-客户端Java开发环境" class="headerlink" title="1、首先需要搭建 FastDFS 客户端Java开发环境"></a>1、首先需要搭建 FastDFS 客户端Java开发环境</h3><p>① 项目中使用maven进行依赖管理，可以在pom.xml中引入如下依赖即可：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">   &lt;groupId&gt;net.oschina.zcx7878&lt;&#x2F;groupId&gt;</span><br><span class="line">   &lt;artifactId&gt;fastdfs-client-java&lt;&#x2F;artifactId&gt;</span><br><span class="line">   &lt;version&gt;1.27.0.0&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure><p>其它的方式，参考官方文档：<a href="https://github.com/happyfish100/fastdfs-client-java" target="_blank" rel="noopener">https://github.com/happyfish100/fastdfs-client-java</a></p><p>② 引入配置文件</p><p>可直接复制包下的 fastdfs-client.properties.sample 或者 fdfs_client.conf.sample，到你的项目中，去掉.sample。</p><p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171012112805371-395330483.png" alt="img"></p><p>我这里直接复制 fastdfs-client.properties.sample 中的配置到项目配置文件 config.properties 中，修改tracker_servers。只需要加载这个配置文件即可</p><p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171012120004199-247798219.png" alt="img"></p><h3 id="2、客户端API"><a href="#2、客户端API" class="headerlink" title="2、客户端API"></a>2、客户端API</h3><p>个人封装的FastDFS Java API以同步到github：<a href="https://github.com/bojiangzhou/lyyzoo-fastdfs-java.git" target="_blank" rel="noopener">https://github.com/bojiangzhou/lyyzoo-fastdfs-java.git</a></p><h3 id="六、权限控制"><a href="#六、权限控制" class="headerlink" title="六、权限控制"></a>六、权限控制</h3><p>前面使用nginx支持http方式访问文件，但所有人都能直接访问这个文件服务器了，所以做一下权限控制。</p><p>FastDFS的权限控制是在服务端开启token验证，客户端根据文件名、当前unix时间戳、秘钥获取token，在地址中带上token参数即可通过http方式访问文件。</p><p>① 服务端开启token验证</p><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">修改http.conf</span><br><span class="line"># vim &#x2F;etc&#x2F;fdfs&#x2F;http.conf</span><br><span class="line"></span><br><span class="line">设置为true表示开启token验证</span><br><span class="line">http.anti_steal.check_token&#x3D;true设置token失效的时间单位为秒(s)http.anti_steal.token_ttl&#x3D;1800</span><br><span class="line">密钥，跟客户端配置文件的fastdfs.http_secret_key保持一致</span><br><span class="line">http.anti_steal.secret_key&#x3D;FASTDFS1234567890</span><br><span class="line"></span><br><span class="line">如果token检查失败，返回的页面</span><br><span class="line">http.anti_steal.token_check_fail&#x3D;&#x2F;ljzsg&#x2F;fastdfs&#x2F;page&#x2F;403.html</span><br></pre></td></tr></table></figure><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><p>记得重启服务。</p><p>② 配置客户端</p><p>客户端只需要设置如下两个参数即可，两边的密钥保持一致。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># token 防盗链功能</span><br><span class="line">fastdfs.http_anti_steal_token&#x3D;true</span><br><span class="line"># 密钥</span><br><span class="line">fastdfs.http_secret_key&#x3D;FASTDFS1234567890</span><br></pre></td></tr></table></figure><p>③ 客户端生成token</p><p>访问文件需要带上生成的token以及unix时间戳，所以返回的token是token和时间戳的拼接。</p><p>之后，将token拼接在地址后即可访问：file.ljzsg.com/group1/M00/00/00/wKgzgFnkaXqAIfXyAAEoRmXZPp878.jpeg?token=078d370098b03e9020b82c829c205e1f&amp;ts=1508141521</p><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> 1     &#x2F;**</span><br><span class="line"> 2      * 获取访问服务器的token，拼接到地址后面</span><br><span class="line"> 3      *</span><br><span class="line"> 4      * @param filepath 文件路径 group1&#x2F;M00&#x2F;00&#x2F;00&#x2F;wKgzgFnkTPyAIAUGAAEoRmXZPp876.jpeg</span><br><span class="line"> 5      * @param httpSecretKey 密钥</span><br><span class="line"> 6      * @return 返回token，如： token&#x3D;078d370098b03e9020b82c829c205e1f&amp;ts&#x3D;1508141521</span><br><span class="line"> 7      *&#x2F;</span><br><span class="line"> 8     public static String getToken(String filepath, String httpSecretKey)&#123;</span><br><span class="line"> 9         &#x2F;&#x2F; unix seconds</span><br><span class="line">10         int ts &#x3D; (int) Instant.now().getEpochSecond();</span><br><span class="line">11         &#x2F;&#x2F; token</span><br><span class="line">12         String token &#x3D; &quot;null&quot;;</span><br><span class="line">13         try &#123;</span><br><span class="line">14             token &#x3D; ProtoCommon.getToken(getFilename(filepath), ts, httpSecretKey);</span><br><span class="line">15         &#125; catch (UnsupportedEncodingException e) &#123;</span><br><span class="line">16             e.printStackTrace();</span><br><span class="line">17         &#125; catch (NoSuchAlgorithmException e) &#123;</span><br><span class="line">18             e.printStackTrace();</span><br><span class="line">19         &#125; catch (MyException e) &#123;</span><br><span class="line">20             e.printStackTrace();</span><br><span class="line">21         &#125;</span><br><span class="line">22 </span><br><span class="line">23         StringBuilder sb &#x3D; new StringBuilder();</span><br><span class="line">24         sb.append(&quot;token&#x3D;&quot;).append(token);</span><br><span class="line">25         sb.append(&quot;&amp;ts&#x3D;&quot;).append(ts);</span><br><span class="line">26 </span><br><span class="line">27         return sb.toString();</span><br><span class="line">28     &#125;</span><br></pre></td></tr></table></figure><p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p><p>④ 注意事项</p><p>如果生成的token验证无法通过，请进行如下两项检查：<br>　　A. 确认调用token生成函数(ProtoCommon.getToken)，传递的文件ID中没有包含group name。传递的文件ID格式形如：M00/00/00/wKgzgFnkTPyAIAUGAAEoRmXZPp876.jpeg</p><p>　　B. 确认服务器时间基本是一致的，注意服务器时间不能相差太多，不要相差到分钟级别。</p><p>⑤ 对比下发现，如果系统文件隐私性较高，可以直接通过fastdfs-client提供的API去访问即可，不用再配置Nginx走http访问。配置Nginx的主要目的是为了快速访问服务器的文件(如图片)，如果还要加权限验证，则需要客户端生成token，其实已经没有多大意义。</p><p>关键是，这里我没找到FastDFS如何对部分资源加token验证，部分开放。有知道的还请留言。</p><hr><p>OK，以上就是单机中使用FastDFS搭建文件系统并上传下载的过程。</p><p>完！！！</p><p>原文链接：<a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html" target="_blank" rel="noopener">https://www.cnblogs.com/chiangchou/p/fastdfs.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;用FastDFS一步步搭建文件管理系统&quot;&gt;&lt;a href=&quot;#用FastDFS一步步搭建文件管理系统&quot; class=&quot;headerlink&quot; title=&quot;用FastDFS一步步搭建文件管理系统&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://www.cnblogs.
      
    
    </summary>
    
    
      <category term="fastdfs" scheme="http://yoursite.com/categories/fastdfs/"/>
    
    
      <category term="分布式文件系统" scheme="http://yoursite.com/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
  <entry>
    <title>glusterfs</title>
    <link href="http://yoursite.com/2021/04/04/glusterfs/"/>
    <id>http://yoursite.com/2021/04/04/glusterfs/</id>
    <published>2021-04-04T03:46:38.065Z</published>
    <updated>2021-04-04T03:46:38.056Z</updated>
    
    <content type="html"><![CDATA[<p>GlusterFS文件存储介绍</p><p>原文链接：<a href="https://www.viayc.com/categories/GlusterFS/" target="_blank" rel="noopener">https://www.viayc.com/categories/GlusterFS/</a></p><p><strong>说明</strong></p><p><strong>简介</strong></p><table><thead><tr><th>1234567891011</th><th>GlusterFS 是 Scale-Out 存储解决方案 Gluster 的核心，它是一个开源的分布式文件系统， 具有强大的横向扩展能力，通过扩展能够支持数 PB 存储容量和处理数千客户端。 GlusterFS 借助 TCP/IP 或 InfiniBand RDMA 网络将物理分布的存储资源聚集在一起，使用单一全局命名空间来管理数据。 GlusterFS 基于可堆叠的用户空间设计，可为各种不同的数据负载提供优异的性能。 GlusterFS 支持运行在任何 IP 网络上的标准应用程序的标准客户端，用户可以在全局统一的命名空间中使用 NFS/CIFS 等标准协议来访问应用数据。 GlusterFS 使得用户可摆脱原有的独立、高成本的封闭存储系统，能够利用普通廉价的存储设备来部署可集中管理、横向扩展、虚拟化的存储池，存储容量可扩展至 TB/PB 级。 目前 GlusterFS 已被 Red Hat 收购，它的官网是：<a href="https://www.gluster.org/" target="_blank" rel="noopener">https://www.gluster.org/</a></th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p><strong>GlusterFS 在企业中的应用场景</strong></p><p>理论和实践上分析，GlusterFS 目前主要适用于大文件存储场景，对于小文件尤其是海量小文件，存储效率和访问性能都表现不佳。建议存放文件大小大于 1MB</p><p><strong>GlusterFS 安装</strong></p><p><strong>环境说明</strong></p><ul><li>CentOS 7</li><li>GlusterFS</li></ul><p>3 台机器安装 GlusterFS 组成一个集群。</p><table><thead><tr><th>12345678910111213</th><th>服务器：10.1.0.1110.1.0.1210.1.0.13 配置 hosts 10.1.0.11 manager10.1.0.12 node-110.1.0.13 node-2 client:10.1.0.10 client</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p><strong>安装 GlusterFS</strong></p><p>CentOS 安装 GlusterFS 非常的简单</p><p>在三个节点都安装 GlusterFS</p><table><thead><tr><th>12345</th><th># 安装 GlusterFS yum 源文件#yum install centos-release-gluster # 安装 GlusterFS 软件yum install -y glusterfs glusterfs-server glusterfs-fuse glusterfs-rdma</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p>启动 GlusterFS</p><table><thead><tr><th>1234567891011121314</th><th>[root@manager ~]#systemctl start glusterd.service[root@manager ~]#systemctl enable glusterd.service[root@manager ~]#systemctl status glusterd.service● glusterd.service - GlusterFS, a clustered file-system server  Loaded: loaded (/usr/lib/systemd/system/glusterd.service; disabled; vendor preset: disabled)  Active: active (running) since 一 2017-02-27 17:55:56 CST; 11s ago Process: 5476 ExecStart=/usr/sbin/glusterd -p /var/run/glusterd.pid –log-level $LOG_LEVEL $GLUSTERD_OPTIONS (code=exited, status=0/SUCCESS)Main PID: 5477 (glusterd) Memory: 15.0M CGroup: /system.slice/glusterd.service        └─5477 /usr/sbin/glusterd -p /var/run/glusterd.pid –log-level INFO 2 月 27 17:55:56 meetbill systemd[1]: Starting GlusterFS, a clustered file-system server…2 月 27 17:55:56 meetbill systemd[1]: Started GlusterFS, a clustered file-system server.</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p><strong>配置 GlusterFS</strong></p><p>在 manager 节点上配置，将 节点 加入到 集群中。</p><table><thead><tr><th>12345678</th><th>[root@manager ~]#gluster peer probe managerpeer probe: success. Probe on localhost not needed [root@manager ~]#gluster peer probe node-1peer probe: success. [root@manager ~]#gluster peer probe node-2peer probe: success.</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p>查看集群状态：</p><table><thead><tr><th>12345678910</th><th>[root@manager ~]#gluster peer statusNumber of Peers: 2 Hostname: node-1Uuid: 41573e8b-eb00-4802-84f0-f923a2c7be79State: Peer in Cluster (Connected) Hostname: node-2Uuid: da068e0b-eada-4a50-94ff-623f630986d7State: Peer in Cluster (Connected)</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p>创建数据存储目录：</p><table><thead><tr><th>123</th><th>[root@manager ~]#mkdir -p /opt/gluster/data[root@node-1 ~]# mkdir -p /opt/gluster/data[root@node-2 ~]# mkdir -p /opt/gluster/data</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p>查看 volume 状态：</p><table><thead><tr><th>12</th><th>[root@manager ~]#gluster volume infoNo volumes present</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p><strong>volume 模式说明</strong></p><p>一、 默认模式，既 DHT, 也叫 分布卷：将文件已 hash 算法随机分布到 一台服务器节点中存储。</p><table><thead><tr><th>1</th><th>gluster volume create test-volume server1:/exp1 server2:/exp2</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p>二、 复制模式，既 AFR, 创建 volume 时带 replica x 数量：将文件复制到 replica x 个节点中。</p><table><thead><tr><th>1</th><th>gluster volume create test-volume replica 2 transport tcp server1:/exp1 server2:/exp2</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p>三、 条带模式，既 Striped, 创建 volume 时带 stripe x 数量： 将文件切割成数据块，分别存储到 stripe x 个节点中 ( 类似 raid 0 )。</p><table><thead><tr><th>1</th><th>gluster volume create test-volume stripe 2 transport tcp server1:/exp1 server2:/exp2</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p>四、 分布式条带模式（组合型），最少需要 4 台服务器才能创建。 创建 volume 时 stripe 2 server = 4 个节点： 是 DHT 与 Striped 的组合型。</p><table><thead><tr><th>1</th><th>gluster volume create test-volume stripe 2 transport tcp server1:/exp1 server2:/exp2 server3:/exp3 server4:/exp4</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p>五、 分布式复制模式（组合型）, 最少需要 4 台服务器才能创建。 创建 volume 时 replica 2 server = 4 个节点：是 DHT 与 AFR 的组合型。</p><table><thead><tr><th>1</th><th>gluster volume create test-volume replica 2 transport tcp server1:/exp1 server2:/exp2　server3:/exp3 server4:/exp4</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p>六、 条带复制卷模式（组合型）, 最少需要 4 台服务器才能创建。 创建 volume 时 stripe 2 replica 2 server = 4 个节点： 是 Striped 与 AFR 的组合型。</p><table><thead><tr><th>1</th><th>gluster volume create test-volume stripe 2 replica 2 transport tcp server1:/exp1 server2:/exp2 server3:/exp3 server4:/exp4</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p>七、 三种模式混合，至少需要 8 台 服务器才能创建。 stripe 2 replica 2 , 每 4 个节点 组成一个 组。</p><table><thead><tr><th>1</th><th>gluster volume create test-volume stripe 2 replica 2 transport tcp server1:/exp1 server2:/exp2 server3:/exp3 server4:/exp4 server5:/exp5 server6:/exp6 server7:/exp7 server8:/exp8</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p><strong>创建 GlusterFS 磁盘</strong></p><table><thead><tr><th>12</th><th>[root@manager ~]#gluster volume create models replica 3 manager:/opt/gluster/data node-1:/opt/gluster/data node-2:/opt/gluster/data forcevolume create: models: success: please start the volume to access data</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p>再查看 volume 状态：</p><table><thead><tr><th>1234567891011121314</th><th>[root@manager ~]#gluster volume info Volume Name: modelsType: ReplicateVolume ID: e539ff3b-2278-4f3f-a594-1f101eabbf1eStatus: CreatedNumber of Bricks: 1 x 3 = 3Transport-type: tcpBricks:Brick1: manager:/opt/gluster/dataBrick2: node-1:/opt/gluster/dataBrick3: node-2:/opt/gluster/dataOptions Reconfigured:performance.readdir-ahead: on</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p>启动 models</p><table><thead><tr><th>12</th><th>[root@manager ~]#gluster volume start modelsvolume start: models: success</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p><strong>GlusterFS 客户端</strong></p><p>部署 GlusterFS 客户端并 mount GlusterFS 文件系统</p><table><thead><tr><th>123</th><th>[root@client ~]#yum install -y glusterfs glusterfs-fuse[root@client ~]#mkdir -p /opt/gfsmnt[root@client ~]#mount -t glusterfs manager:models /opt/gfsmnt/</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><table><thead><tr><th>1234567891011</th><th>[root@node-94 ~]#df -h文件系统 容量 已用 可用 已用 % 挂载点/dev/mapper/vg001-root 98G 1.2G 97G 2% /devtmpfs 32G 0 32G 0% /devtmpfs 32G 0 32G 0% /dev/shmtmpfs 32G 130M 32G 1% /runtmpfs 32G 0 32G 0% /sys/fs/cgroup/dev/mapper/vg001-opt 441G 71G 370G 17% /opt/dev/sda2 497M 153M 344M 31% /boottmpfs 6.3G 0 6.3G 0% /run/user/0manager:models 441G 18G 424G 4% /opt/gfsmnt</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p><strong>维护</strong></p><ol><li>查看 GlusterFS 中所有的 volume:</li></ol><table><thead><tr><th>1</th><th>[root@manager ~]#gluster volume list</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><ol><li>删除 GlusterFS 磁盘：</li></ol><table><thead><tr><th>12</th><th>[root@manager ~]#gluster volume stop models   #停止名字为 models 的磁盘[root@manager ~]#gluster volume delete models #删除名字为 models 的磁盘</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p>注： 删除 磁盘 以后，必须删除 磁盘 ( /opt/gluster/data ) 中的 （ .glusterfs/ .trashcan/ ）目录。</p><p>否则创建新 volume 相同的 磁盘 会出现文件 不分布，或者 类型 错乱 的问题。</p><ol><li>卸载某个节点 GlusterFS 磁盘</li></ol><table><thead><tr><th>1</th><th>[root@manager ~]#gluster peer detach node-2</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><ol><li>设置访问限制，按照每个 volume 来限制</li></ol><table><thead><tr><th>1</th><th>[root@manager ~]#gluster volume set models auth.allow 10.6.0.<em>,10.7.0.</em></th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><ol><li>添加 GlusterFS 节点：</li></ol><table><thead><tr><th>12</th><th>[root@manager ~]#gluster peer probe node-3[root@manager ~]#gluster volume add-brick models node-3:/opt/gluster/data</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p>注：如果是复制卷或者条带卷，则每次添加的 Brick 数必须是 replica 或者 stripe 的整数倍</p><ol><li>配置卷</li></ol><table><thead><tr><th>1</th><th>[root@manager ~]# gluster volume set</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><ol><li>缩容 volume:</li></ol><p>先将数据迁移到其它可用的 Brick，迁移结束后才将该 Brick 移除：</p><table><thead><tr><th>1</th><th>[root@manager ~]#gluster volume remove-brick models node-2:/opt/gluster/data node-3:/opt/gluster/data start</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p>在执行了 start 之后，可以使用 status 命令查看移除进度：</p><table><thead><tr><th>1</th><th>[root@manager ~]#gluster volume remove-brick models node-2:/opt/gluster/data node-3:/opt/gluster/data status</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p>不进行数据迁移，直接删除该 Brick：</p><table><thead><tr><th>1</th><th>[root@manager ~]#gluster volume remove-brick models node-2:/opt/gluster/data node-3:/opt/gluster/data commit</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p>注意，如果是复制卷或者条带卷，则每次移除的 Brick 数必须是 replica 或者 stripe 的整数倍。</p><p>扩容：</p><table><thead><tr><th>1</th><th>gluster volume add-brick models node-2:/opt/gluster/data</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><ol><li>修复命令：</li></ol><table><thead><tr><th>1</th><th>[root@manager ~]#gluster volume replace-brick models node-2:/opt/gluster/data node-3:/opt/gluster/data commit -force</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><ol><li>迁移 volume:</li></ol><table><thead><tr><th>1</th><th>[root@manager ~]#gluster volume replace-brick models node-2:/opt/gluster/data node-3:/opt/gluster/data start</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p>pause 为暂停迁移</p><table><thead><tr><th>1</th><th>[root@manager ~]#gluster volume replace-brick models node-2:/opt/gluster/data node-3:/opt/gluster/data pause</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p>abort 为终止迁移</p><table><thead><tr><th>1</th><th>[root@manager ~]#gluster volume replace-brick models node-2:/opt/gluster/data node-3:/opt/gluster/data abort</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p>status 查看迁移状态</p><table><thead><tr><th>1</th><th>[root@manager ~]#gluster volume replace-brick models node-2:/opt/gluster/data node-3:/opt/gluster/data status</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p>迁移结束后使用 commit 来生效</p><table><thead><tr><th>1</th><th>[root@manager ~]#gluster volume replace-brick models node-2:/opt/gluster/data node-3:/opt/gluster/data commit</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><ol><li>均衡 volume:</li></ol><table><thead><tr><th>12345</th><th>[root@manager ~]#gluster volume models lay-outstart[root@manager ~]#gluster volume models start[root@manager ~]#gluster volume models startforce[root@manager ~]#gluster volume models status[root@manager ~]#gluster volume models stop</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;GlusterFS文件存储介绍&lt;/p&gt;
&lt;p&gt;原文链接：&lt;a href=&quot;https://www.viayc.com/categories/GlusterFS/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.viayc.com/ca
      
    
    </summary>
    
    
      <category term="glusterfs" scheme="http://yoursite.com/categories/glusterfs/"/>
    
    
      <category term="分布式文件系统" scheme="http://yoursite.com/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
  <entry>
    <title>压力测试</title>
    <link href="http://yoursite.com/2021/04/04/%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/"/>
    <id>http://yoursite.com/2021/04/04/%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/</id>
    <published>2021-04-04T03:31:42.317Z</published>
    <updated>2021-04-04T03:31:42.305Z</updated>
    
    <content type="html"><![CDATA[<h1 id="压测工具—ab、webbench、siege"><a href="#压测工具—ab、webbench、siege" class="headerlink" title="压测工具—ab、webbench、siege"></a>压测工具—ab、webbench、siege</h1><p>原文链接：<a href="https://liwengo.top/2020/03/20/pressure-test-tools/" target="_blank" rel="noopener">https://liwengo.top/2020/03/20/pressure-test-tools/</a></p><h4 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h4><h5 id="吞吐率（Requests-per-second）"><a href="#吞吐率（Requests-per-second）" class="headerlink" title="吞吐率（Requests per second）"></a>吞吐率（Requests per second）</h5><ul><li>概念：服务并发处理能力的量化描述，单位是 reqs/s，指的是<strong>某个并发用户数下单位时间内处理的请求数</strong>。某个并发用户数下单位时间内能处理的最大请求数，称之为<strong>最大吞吐率</strong>。</li><li>计算公式：总请求数 / 处理完成这些请求数所花费的时间，即：<br><code>Request per second = Complete requests / Time taken for tests</code></li></ul><h5 id="并发连接数（The-number-of-concurrent-connections）"><a href="#并发连接数（The-number-of-concurrent-connections）" class="headerlink" title="并发连接数（The number of concurrent connections）"></a>并发连接数（The number of concurrent connections）</h5><ul><li>概念：某个时刻服务器所接受的请求数目，简单的将，就是一个会话。</li></ul><h5 id="并发用户数（The-number-of-concurrent-users，Concurrency-Level）"><a href="#并发用户数（The-number-of-concurrent-users，Concurrency-Level）" class="headerlink" title="并发用户数（The number of concurrent users，Concurrency Level）"></a>并发用户数（The number of concurrent users，Concurrency Level）</h5><ul><li>概念：要注意区分这个概念和并发连接数之间的区别，一个用户可能同时会产生多个会话，也即连接数。</li></ul><h5 id="用户平均请求等待时间（Time-per-request）"><a href="#用户平均请求等待时间（Time-per-request）" class="headerlink" title="用户平均请求等待时间（Time per request）"></a>用户平均请求等待时间（Time per request）</h5><ul><li>计算公式：处理完成所有请求数所花费的时间/ （总请求数 / 并发用户数），即：<br><code>Time per request = Time taken for tests /（ Complete requests / Concurrency Level）</code></li></ul><h5 id="服务器平均请求等待时间（Time-per-request-across-all-concurrent-requests）"><a href="#服务器平均请求等待时间（Time-per-request-across-all-concurrent-requests）" class="headerlink" title="服务器平均请求等待时间（Time per request: across all concurrent requests）"></a>服务器平均请求等待时间（Time per request: across all concurrent requests）</h5><ul><li>计算公式：处理完成所有请求数所花费的时间 / 总请求数，即：<br><code>Time taken for / testsComplete requests</code><br>可以看到，它是吞吐率的倒数。<br>同时，它也=用户平均请求等待时间/并发用户数，即<br><code>Time per request / Concurrency Level</code></li></ul><h4 id="Apache-Bench"><a href="#Apache-Bench" class="headerlink" title="Apache Bench"></a>Apache Bench</h4><blockquote><p><a href="http://httpd.apache.org/docs/2.4/programs/ab.html" target="_blank" rel="noopener">ab</a>是Apache的超文本传输协议（HTTP）的性能测试工具，可以测试apache、IIs、tomcat、nginx 等服务器。但是 ab 没有 Jmeter、Loadrunner 那样有各种场景设计、各种图形报告和监控，只需一个命令即可，有输出描述，可以简单的进行一些压力测试。</p></blockquote><h5 id="查看Apache版本"><a href="#查看Apache版本" class="headerlink" title="查看Apache版本"></a>查看Apache版本</h5><p>Mac系统下自带 Apache，可以使用<code>apachectl -v</code>命令查看 Apache 版本：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ apachectl -v</span><br><span class="line">Server version: Apache&#x2F;2.4.41 (Unix)</span><br><span class="line">Server built:   Dec 13 2019 19:06:00</span><br></pre></td></tr></table></figure><h5 id="查看ab版本"><a href="#查看ab版本" class="headerlink" title="查看ab版本"></a>查看ab版本</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ab -V</span><br><span class="line">This is ApacheBench, Version 2.3 &lt;$Revision: 1843412 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http:&#x2F;&#x2F;www.zeustech.net&#x2F;</span><br><span class="line">Licensed to The Apache Software Foundation, http:&#x2F;&#x2F;www.apache.org&#x2F;</span><br></pre></td></tr></table></figure><h5 id="查看当前系统的默认文件打开数"><a href="#查看当前系统的默认文件打开数" class="headerlink" title="查看当前系统的默认文件打开数"></a>查看当前系统的默认文件打开数</h5><p>在压测开始前，你需要确保你的<code>open files</code>足够大，否则会报<code>TOO MANY FILES OPEN</code>错误，可以通过<code>ulimit -a</code>查看</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ ulimit -a</span><br><span class="line">core file size          (blocks, -c) 0</span><br><span class="line">data seg size           (kbytes, -d) unlimited</span><br><span class="line">file size               (blocks, -f) unlimited</span><br><span class="line">max locked memory       (kbytes, -l) unlimited</span><br><span class="line">max memory size         (kbytes, -m) unlimited</span><br><span class="line">open files                      (-n) 256</span><br><span class="line">pipe size            (512 bytes, -p) 1</span><br><span class="line">stack size              (kbytes, -s) 8192</span><br><span class="line">cpu time               (seconds, -t) unlimited</span><br><span class="line">max user processes              (-u) 1392</span><br><span class="line">virtual memory          (kbytes, -v) unlimited</span><br></pre></td></tr></table></figure><p>设置打开文件数限制为 2560：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ulimit -n 2560</span><br></pre></td></tr></table></figure><blockquote><p>这只是临时修改，关闭终端会话后会复原。</p></blockquote><h5 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h5><table><thead><tr><th align="left">命令参数</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">-n</td><td align="left">请求次数</td></tr><tr><td align="left">-c</td><td align="left">并发数</td></tr><tr><td align="left">-r</td><td align="left">当接收到错误时，不要退出套接字（socket）</td></tr></tbody></table><h5 id="关于登陆的问题"><a href="#关于登陆的问题" class="headerlink" title="关于登陆的问题"></a>关于登陆的问题</h5><p>有时候进行压力测试需要用户登录，怎么办？<br>请参考以下步骤：</p><ol><li>先用账户和密码登录后，用开发者工具找到标识这个会话的 Cookie 值（Session ID）记下来</li><li>如果只用到一个 Cookie，那么只需键入命令：<br><code>ab －n 100 －C key＝value http://test.com/</code></li><li>如果需要多个 Cookie，就直接设 Header：<br><code>ab -n 100 -H “Cookie: Key1=Value1; Key2=Value2” http://test.com/</code></li></ol><h4 id="webbench"><a href="#webbench" class="headerlink" title="webbench"></a>webbench</h4><p>webbench是一枚强大得可以的压力测试工具，它最多可以模拟3万个并发连接去测试网站的负载能力，个人感觉要比Apache自带的ab压力测试工具好，安装使用也特别方便。</p><h5 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">brew install ctags # 依赖安装</span><br><span class="line"></span><br><span class="line">wget http:&#x2F;&#x2F;blog.zyan.cc&#x2F;soft&#x2F;linux&#x2F;webbench&#x2F;webbench-1.5.tar.gz</span><br><span class="line">tar -zxvf webbench-1.5.tar.gz</span><br><span class="line">cd webbench-1.5</span><br><span class="line"></span><br><span class="line">mkdir -pv &#x2F;usr&#x2F;local&#x2F;man&#x2F;man1 # 必须</span><br><span class="line"></span><br><span class="line">sudo make &amp;&amp; sudo make install</span><br></pre></td></tr></table></figure><h5 id="命令-1"><a href="#命令-1" class="headerlink" title="命令"></a>命令</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 10 秒内向 http:&#x2F;&#x2F;127.0.0.1:3001&#x2F;admin 发送 500 次请求</span><br><span class="line">webbench -c 500 -t 10 http:&#x2F;&#x2F;127.0.0.1:3001&#x2F;admin</span><br></pre></td></tr></table></figure><h4 id="siege"><a href="#siege" class="headerlink" title="siege"></a>siege</h4><p>siege是我解决ab该死的<code>apr_socket_recv: Connection reset by peer (54)</code>错误时发现的一个好工具，不得不说这工具真心好，用法和webbench一样，但是信息全面很多。</p><h5 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install siege</span><br></pre></td></tr></table></figure><h5 id="命令-2"><a href="#命令-2" class="headerlink" title="命令"></a>命令</h5><table><thead><tr><th align="left">压测参数</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">-C</td><td align="left">在屏幕上打印显示出当前的配置,配置是包括在他的配置文件$HOME/.siegerc中,可以编辑里面的参数,这样每次siege 都会按照它运行</td></tr><tr><td align="left">-v</td><td align="left">运行时能看到详细的运行信息</td></tr><tr><td align="left">-c</td><td align="left">模拟有n个用户在同时访问,n不要设得太大,因为越大,siege消耗本地机器的资源越多</td></tr><tr><td align="left">-r</td><td align="left">重复运行测试n次,不能与-t同时存在</td></tr><tr><td align="left">-t</td><td align="left">持续运行siege ‘n’秒(如10S),分钟(10M),小时(10H)</td></tr><tr><td align="left">-d</td><td align="left">每个url之间的延迟,在0-n之间</td></tr><tr><td align="left">-b</td><td align="left">请求无需等待 delay=0</td></tr><tr><td align="left">-i</td><td align="left">随机访问urls.txt中的url列表项</td></tr><tr><td align="left">-f</td><td align="left">指定用特定的urls文件运行 ,默认为<code>urls.txt</code>,位于siege安装目录下的<code>etc/urls.txt</code></td></tr><tr><td align="left">-R</td><td align="left">指定用特定的siege 配置文件来运行,默认的为<code>$HOME/.siegerc</code></td></tr><tr><td align="left">-l</td><td align="left">运行结束,将统计数据保存到日志文件中<code>siege.log</code>,一般位于<code>/usr/local/var/siege.log</code>中,也可在.siegerc中自定义</td></tr></tbody></table><h5 id="压测结果"><a href="#压测结果" class="headerlink" title="压测结果"></a>压测结果</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;并发10个,发生5次,共50个请求</span><br><span class="line">siege -c 10 -r 5 http:&#x2F;&#x2F;www.jd.com</span><br><span class="line"></span><br><span class="line">Transactions: 350 hits &#x2F;&#x2F;总共测试次数</span><br><span class="line">Availability: 100.00 % &#x2F;&#x2F;成功次数百分比</span><br><span class="line">Elapsed time: 4.27 secs &#x2F;&#x2F;总共耗时多少秒</span><br><span class="line">Data transferred: 7.08 MB &#x2F;&#x2F;总共数据传输</span><br><span class="line">Response time: 0.07 secs &#x2F;&#x2F;等到响应耗时</span><br><span class="line">Transaction rate: 81.97 trans&#x2F;sec &#x2F;&#x2F;平均每秒处理请求数</span><br><span class="line">Throughput: 1.66 MB&#x2F;sec &#x2F;&#x2F;吞吐率</span><br><span class="line">Concurrency: 6.06 &#x2F;&#x2F;最高并发</span><br><span class="line">Successful transactions: 350 &#x2F;&#x2F;成功的请求数</span><br><span class="line">Failed transactions: 0 &#x2F;&#x2F;失败的请求数</span><br><span class="line">Longest transaction: 0.24 &#x2F;&#x2F;每次传输所花最长时间</span><br><span class="line">Shortest transaction: 0.01 &#x2F;&#x2F;每次传输所花最短时间</span><br></pre></td></tr></table></figure><h5 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 200个并发对http:&#x2F;&#x2F;www.google.com发送请求100次</span><br><span class="line">siege -c 200 -r 100 http:&#x2F;&#x2F;www.google.com</span><br><span class="line"></span><br><span class="line"># 在urls.txt中列出所有的网址</span><br><span class="line">siege -c 200 -r 100 -f urls.txt</span><br><span class="line"></span><br><span class="line"># 随机选取urls.txt中列出所有的网址</span><br><span class="line">siege -c 200 -r 100 -f urls.txt -i</span><br><span class="line"></span><br><span class="line"># delay&#x3D;0，更准确的压力测试，而不是功能测试</span><br><span class="line">siege -c 200 -r 100 -f urls.txt -i -b</span><br><span class="line"></span><br><span class="line"># 指定http请求头 文档类型</span><br><span class="line">siege -H &quot;Content-Type:application&#x2F;json&quot; -c 200 -r 100 -f urls.txt -i -b</span><br></pre></td></tr></table></figure><h5 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h5><ol><li>发送post请求时，url格式为<code>http://www.xxxx.com/ POST p1=v1&amp;p2=v2</code></li><li>如果url中含有空格和中文，要先进行url编码，否则siege发送的请求url不准确。</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;压测工具—ab、webbench、siege&quot;&gt;&lt;a href=&quot;#压测工具—ab、webbench、siege&quot; class=&quot;headerlink&quot; title=&quot;压测工具—ab、webbench、siege&quot;&gt;&lt;/a&gt;压测工具—ab、webbench、sie
      
    
    </summary>
    
    
      <category term="工具" scheme="http://yoursite.com/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
      <category term="工具" scheme="http://yoursite.com/tags/%E5%B7%A5%E5%85%B7/"/>
    
  </entry>
  
  <entry>
    <title>mongodb二</title>
    <link href="http://yoursite.com/2021/03/01/mongodb/mongodb02/"/>
    <id>http://yoursite.com/2021/03/01/mongodb/mongodb02/</id>
    <published>2021-03-01T14:10:34.256Z</published>
    <updated>2021-03-01T14:10:34.244Z</updated>
    
    <content type="html"><![CDATA[<h1 id="MongoDB-二"><a href="#MongoDB-二" class="headerlink" title="MongoDB(二)"></a>MongoDB(二)</h1><p><a href="https://wgy1993.gitee.io/archives/afe7047c.html" target="_blank" rel="noopener">2020-09-18</a></p><h1 id="1-副本集-Replica-Sets"><a href="#1-副本集-Replica-Sets" class="headerlink" title="1. 副本集-Replica Sets"></a>1. 副本集-Replica Sets</h1><h2 id="1-1-简介"><a href="#1-1-简介" class="headerlink" title="1.1 简介"></a>1.1 简介</h2><p>MongoDB中的副本集（Replica Set）是一组维护相同数据集的mongod服务。 副本集可提供冗余和高可用性，是所有生产部署的基础。</p><p>也可以说，副本集类似于有自动故障恢复功能的主从集群。通俗的讲就是用多台机器进行同一数据的异步同步，从而使多台机器拥有同一数据的多个副本，并且当主库当掉时在不需要用户干预的情况下自动切换其他备份服务器做主库。而且还可以利用副本服务器做只读服务器，实现读写分离，提高负载。</p><p>（1）冗余和数据可用性</p><p>复制提供冗余并提高数据可用性。 通过在不同数据库服务器上提供多个数据副本，复制可提供一定级别的容错功能，以防止丢失单个数据库服务器。</p><p>在某些情况下，复制可以提供增加的读取性能，因为客户端可以将读取操作发送到不同的服务上， 在不同数据中心维护数据副本可以增加分布式应用程序的数据位置和可用性。 您还可以为专用目的维护其他副本，例如灾难恢复，报告或备份。</p><p>（2）MongoDB中的复制</p><p>副本集是一组维护相同数据集的mongod实例。 副本集包含多个数据承载节点和可选的一个仲裁节点。在承载数据的节点中，一个且仅一个成员被视为主节点，而其他节点被视为次要（从）节点。</p><p>主节点接收所有写操作。 副本集只能有一个主要能够确认具有{w：“most”}写入关注的写入; 虽然在某些情况下，另一个mongod实例可能暂时认为自己也是主要的。主要记录其操作日志中的数据集的所有更改，即oplog。</p><p><img src="https://img-blog.csdnimg.cn/20200918164831238.png" alt="image-20200918092648938"></p><p>辅助(副本)节点复制主节点的oplog并将操作应用于其数据集，以使辅助节点的数据集反映主节点的数据集。 如果主要人员不在，则符合条件的中学将举行选举以选出新的主要人员。</p><p>（3）主从复制和副本集区别</p><p>主从集群和副本集最大的区别就是副本集没有固定的“主节点”；整个集群会选出一个“主节点”，当其挂掉后，又在剩下的从节点中选中其他节点为“主节点”，副本集总有一个活跃点(主、primary)和一个或多个备份节点(从、secondary)。</p><h2 id="1-2-副本集的三个角色"><a href="#1-2-副本集的三个角色" class="headerlink" title="1.2 副本集的三个角色"></a>1.2 副本集的三个角色</h2><p>副本集有两种类型三种角色</p><p>两种类型：</p><ul><li>主节点（ Primary）类型：数据操作的主要连接点，可读写。</li><li>次要（辅助、从）节点（ Secondaries）类型：数据冗余备份节点，可以读或选举。</li></ul><p>三种角色：</p><ul><li>主要成员（Primary）：主要接收所有写操作。就是主节点。</li><li>副本成员（Replicate）：从主节点通过复制操作以维护相同的数据集，即备份数据，不可写操作，但可以读操作（但需要配置）。是默认的一种从节点类型。</li><li>仲裁者（ Arbiter）：不保留任何数据的副本，只具有投票选举作用。当然也可以将仲裁服务器维护为副本集的一部分，即副本成员同时也可以是仲裁者。也是一种从节点类型。</li></ul><p><img src="https://img-blog.csdnimg.cn/20200918164912986.png" alt="image-20200918092959669"></p><p>关于仲裁者的额外说明：</p><p>您可以将额外的mongod实例添加到副本集作为仲裁者。 仲裁者不维护数据集。 仲裁者的目的是通过响应其他副本集成员的心跳和选举请求来维护副本集中的仲裁。 因为它们不存储数据集，所以仲裁器可以是提供副本集仲裁功能的好方法，其资源成本比具有数据集的全功能副本集成员更便宜。</p><p>如果您的副本集具有偶数个成员，请添加仲裁者以获得主要选举中的“大多数”投票。 仲裁者不需要专用硬件。</p><p>仲裁者将永远是仲裁者，而主要人员可能会退出并成为次要人员，而次要人员可能成为选举期间的主要人员。</p><p>如果你的副本+主节点的个数是偶数，建议加一个仲裁者，形成奇数，容易满足大多数的投票。</p><p>如果你的副本+主节点的个数是奇数，可以不加仲裁者。</p><h2 id="1-3-副本集架构目标"><a href="#1-3-副本集架构目标" class="headerlink" title="1.3 副本集架构目标"></a>1.3 副本集架构目标</h2><p>一主一副本一仲裁</p><p><img src="https://img-blog.csdnimg.cn/20200918164931592.png" alt="image-20200918093150930"></p><h2 id="1-4-副本集的创建"><a href="#1-4-副本集的创建" class="headerlink" title="1.4 副本集的创建"></a>1.4 副本集的创建</h2><h3 id="1-4-1-第一步：创建主节点"><a href="#1-4-1-第一步：创建主节点" class="headerlink" title="1.4.1 第一步：创建主节点"></a>1.4.1 第一步：创建主节点</h3><p>建立存放数据和日志的目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#-----------myrs</span><br><span class="line">#主节点</span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27017&#x2F;log \ &amp;</span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27017&#x2F;data&#x2F;db</span><br></pre></td></tr></table></figure><p>新建或修改配置文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27017&#x2F;mongod.conf</span><br></pre></td></tr></table></figure><p>myrs_27017 ：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">    #MongoDB发送所有日志输出的目标指定为文件</span><br><span class="line">    destination: file</span><br><span class="line">    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span><br><span class="line">    path: &quot;&#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27017&#x2F;log&#x2F;mongod.log&quot;</span><br><span class="line">    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span><br><span class="line">    logAppend: true</span><br><span class="line">storage:</span><br><span class="line">    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span><br><span class="line">    dbPath: &quot;&#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27017&#x2F;data&#x2F;db&quot;</span><br><span class="line">    journal:</span><br><span class="line">        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">        enabled: true</span><br><span class="line">processManagement:</span><br><span class="line">    #启用在后台运行mongos或mongod进程的守护进程模式。</span><br><span class="line">    fork: true</span><br><span class="line">    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span><br><span class="line">    pidFilePath: &quot;&#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27017&#x2F;log&#x2F;mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line">    #服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span><br><span class="line">    #bindIpAll: true</span><br><span class="line">    #服务实例绑定的IP</span><br><span class="line">    bindIp: localhost,192.168.0.2</span><br><span class="line">    #bindIp</span><br><span class="line">    #绑定的端口</span><br><span class="line">    port: 27017</span><br><span class="line">replication:</span><br><span class="line">    #副本集的名称</span><br><span class="line">    replSetName: myrs</span><br></pre></td></tr></table></figure><p>启动节点服务：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost replica_sets]# &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27017&#x2F;mongod.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 54257</span><br><span class="line">child process started successfully, parent exiting</span><br></pre></td></tr></table></figure><h3 id="1-4-2-第二步：创建副本节点"><a href="#1-4-2-第二步：创建副本节点" class="headerlink" title="1.4.2 第二步：创建副本节点"></a>1.4.2 第二步：创建副本节点</h3><p>建立存放数据和日志的目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#-----------myrs</span><br><span class="line">#副本节点</span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27018&#x2F;log \ &amp;</span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27018&#x2F;data&#x2F;db</span><br></pre></td></tr></table></figure><p>新建或修改配置文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27018&#x2F;mongod.conf</span><br></pre></td></tr></table></figure><p>myrs_27018 ：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">    #MongoDB发送所有日志输出的目标指定为文件</span><br><span class="line">    destination: file</span><br><span class="line">    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span><br><span class="line">    path: &quot;&#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27018&#x2F;log&#x2F;mongod.log&quot;</span><br><span class="line">    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span><br><span class="line">    logAppend: true</span><br><span class="line">storage:</span><br><span class="line">    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span><br><span class="line">    dbPath: &quot;&#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27018&#x2F;data&#x2F;db&quot;</span><br><span class="line">    journal:</span><br><span class="line">        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">        enabled: true</span><br><span class="line">processManagement:</span><br><span class="line">    #启用在后台运行mongos或mongod进程的守护进程模式。</span><br><span class="line">    fork: true</span><br><span class="line">    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span><br><span class="line">    pidFilePath: &quot;&#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27018&#x2F;log&#x2F;mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line">    #服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span><br><span class="line">    #bindIpAll: true</span><br><span class="line">    #服务实例绑定的IP</span><br><span class="line">    bindIp: localhost,192.168.0.2</span><br><span class="line">    #bindIp</span><br><span class="line">    #绑定的端口</span><br><span class="line">    port: 27018</span><br><span class="line">replication:</span><br><span class="line">    #副本集的名称</span><br><span class="line">    replSetName: myrs</span><br></pre></td></tr></table></figure><p>启动节点服务：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost replica_sets]# &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27018&#x2F;mongod.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 54361</span><br><span class="line">child process started successfully, parent exiting</span><br></pre></td></tr></table></figure><h3 id="1-4-3-第三步：创建仲裁节点"><a href="#1-4-3-第三步：创建仲裁节点" class="headerlink" title="1.4.3 第三步：创建仲裁节点"></a>1.4.3 第三步：创建仲裁节点</h3><p>建立存放数据和日志的目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#-----------myrs</span><br><span class="line">#仲裁节点</span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27019&#x2F;log \ &amp;</span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27019&#x2F;data&#x2F;db</span><br></pre></td></tr></table></figure><p>新建或修改配置文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27019&#x2F;mongod.conf</span><br></pre></td></tr></table></figure><p>myrs_27019 ：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">    #MongoDB发送所有日志输出的目标指定为文件</span><br><span class="line">    destination: file</span><br><span class="line">    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span><br><span class="line">    path: &quot;&#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27019&#x2F;log&#x2F;mongod.log&quot;</span><br><span class="line">    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span><br><span class="line">    logAppend: true</span><br><span class="line">storage:</span><br><span class="line">    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span><br><span class="line">    dbPath: &quot;&#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27019&#x2F;data&#x2F;db&quot;</span><br><span class="line">    journal:</span><br><span class="line">        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">        enabled: true</span><br><span class="line">processManagement:</span><br><span class="line">    #启用在后台运行mongos或mongod进程的守护进程模式。</span><br><span class="line">    fork: true</span><br><span class="line">    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span><br><span class="line">    pidFilePath: &quot;&#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27019&#x2F;log&#x2F;mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line">    #服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span><br><span class="line">    #bindIpAll: true</span><br><span class="line">    #服务实例绑定的IP</span><br><span class="line">    bindIp: localhost,192.168.0.2</span><br><span class="line">    #bindIp</span><br><span class="line">    #绑定的端口</span><br><span class="line">    port: 27019</span><br><span class="line">replication:</span><br><span class="line">    #副本集的名称</span><br><span class="line">    replSetName: myrs</span><br></pre></td></tr></table></figure><p>启动节点服务：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost replica_sets]# &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27019&#x2F;mongod.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 54410</span><br><span class="line">child process started successfully, parent exiting</span><br></pre></td></tr></table></figure><h3 id="1-4-4-第四步：初始化配置副本集和主节点"><a href="#1-4-4-第四步：初始化配置副本集和主节点" class="headerlink" title="1.4.4 第四步：初始化配置副本集和主节点"></a>1.4.4 第四步：初始化配置副本集和主节点</h3><p>使用客户端命令连接任意一个节点，但这里尽量要连接主节点(27017节点)：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongo --host&#x3D;180.76.159.126 --port&#x3D;27017</span><br></pre></td></tr></table></figure><p>结果，连接上之后，很多命令无法使用，，比如 show dbs 等，必须初始化副本集才行</p><p>准备初始化新的副本集：</p><p>语法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.initiate(configuration)</span><br></pre></td></tr></table></figure><p>【示例】</p><p>使用默认的配置来初始化副本集：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.initiate()</span><br></pre></td></tr></table></figure><p>执行结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; rs.initiate()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;info2&quot; : &quot;no configuration specified. Using a default configuration for the set&quot;,</span><br><span class="line">    &quot;me&quot; : &quot;180.76.159.126:27017&quot;,</span><br><span class="line">    &quot;ok&quot; : 1,</span><br><span class="line">    &quot;operationTime&quot; : Timestamp(1565760476, 1),</span><br><span class="line">    &quot;$clusterTime&quot; : &#123;</span><br><span class="line">        &quot;clusterTime&quot; : Timestamp(1565760476, 1),</span><br><span class="line">        &quot;signature&quot; : &#123;</span><br><span class="line">            &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA&#x3D;&quot;),</span><br><span class="line">            &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">myrs:SECONDARY&gt;</span><br><span class="line">myrs:PRIMARY&gt;</span><br></pre></td></tr></table></figure><p>提示：</p><ul><li>“ok”的值为1，说明创建成功。</li><li>命令行提示符发生变化，变成了一个从节点角色，此时默认不能读写。稍等片刻，回车，变成主节点。</li></ul><h3 id="1-4-5-第五步：查看副本集的配置内容"><a href="#1-4-5-第五步：查看副本集的配置内容" class="headerlink" title="1.4.5 第五步：查看副本集的配置内容"></a>1.4.5 第五步：查看副本集的配置内容</h3><p>返回包含当前副本集配置的文档。</p><p>语法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.conf(configuration)</span><br></pre></td></tr></table></figure><p>提示：</p><p><code>rs.config()</code> 是该方法的别名。</p><p>configuration：可选，如果没有配置，则使用默认主节点配置。</p><p>【示例】</p><p>在27017上执行副本集中当前节点的默认节点配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">myrs:PRIMARY&gt; rs.conf()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;_id&quot; : &quot;myrs&quot;,</span><br><span class="line">    &quot;version&quot; : 1,</span><br><span class="line">    &quot;protocolVersion&quot; : NumberLong(1),</span><br><span class="line">    &quot;writeConcernMajorityJournalDefault&quot; : true,</span><br><span class="line">    &quot;members&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_id&quot; : 0,</span><br><span class="line">            &quot;host&quot; : &quot;180.76.159.126:27017&quot;,</span><br><span class="line">            &quot;arbiterOnly&quot; : false,</span><br><span class="line">            &quot;buildIndexes&quot; : true,</span><br><span class="line">            &quot;hidden&quot; : false,</span><br><span class="line">            &quot;priority&quot; : 1,</span><br><span class="line">            &quot;tags&quot; : &#123;</span><br><span class="line"></span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;slaveDelay&quot; : NumberLong(0),</span><br><span class="line">            &quot;votes&quot; : 1</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">        &quot;chainingAllowed&quot; : true,</span><br><span class="line">        &quot;heartbeatIntervalMillis&quot; : 2000,</span><br><span class="line">        &quot;heartbeatTimeoutSecs&quot; : 10,</span><br><span class="line">        &quot;electionTimeoutMillis&quot; : 10000,</span><br><span class="line">        &quot;catchUpTimeoutMillis&quot; : -1,</span><br><span class="line">        &quot;catchUpTakeoverDelayMillis&quot; : 30000,</span><br><span class="line">        &quot;getLastErrorModes&quot; : &#123;</span><br><span class="line">        </span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;getLastErrorDefaults&quot; : &#123;</span><br><span class="line">            &quot;w&quot; : 1,</span><br><span class="line">            &quot;wtimeout&quot; : 0</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;replicaSetId&quot; : ObjectId(&quot;5d539bdcd6a308e600d126bb&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>说明：</p><ul><li><code>&quot;_id&quot; : &quot;myrs&quot;</code> ：副本集的配置数据存储的主键值，默认就是副本集的名字</li><li><code>&quot;members&quot;</code> ：副本集成员数组，此时只有一个： “host” : “180.76.159.126:27017” ，该成员不是仲裁节点：”arbiterOnly” : false ，优先级（权重值）： “priority” : 1,</li><li><code>&quot;settings&quot;</code> ：副本集的参数配置。</li></ul><p>提示：副本集配置的查看命令，本质是查询的是 system.replset 的表中的数据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">myrs:PRIMARY&gt; use local</span><br><span class="line">switched to db local</span><br><span class="line">myrs:PRIMARY&gt; show collections</span><br><span class="line">oplog.rs</span><br><span class="line">replset.election</span><br><span class="line">replset.minvalid</span><br><span class="line">replset.oplogTruncateAfterPoint</span><br><span class="line">startup_log</span><br><span class="line">system.replset</span><br><span class="line">system.rollback.id</span><br><span class="line">myrs:PRIMARY&gt; db.system.replset.find()</span><br><span class="line">&#123; &quot;_id&quot; : &quot;myrs&quot;, &quot;version&quot; : 1, &quot;protocolVersion&quot; : NumberLong(1),</span><br><span class="line">&quot;writeConcernMajorityJournalDefault&quot; : true, &quot;members&quot; : [ &#123; &quot;_id&quot; : 0, &quot;host&quot; :</span><br><span class="line">&quot;180.76.159.126:27017&quot;, &quot;arbiterOnly&quot; : false, &quot;buildIndexes&quot; : true, &quot;hidden&quot; :</span><br><span class="line">false, &quot;priority&quot; : 1, &quot;tags&quot; : &#123; &#125;, &quot;slaveDelay&quot; : NumberLong(0), &quot;votes&quot; : 1</span><br><span class="line">&#125; ], &quot;settings&quot; : &#123; &quot;chainingAllowed&quot; : true, &quot;heartbeatIntervalMillis&quot; : 2000,</span><br><span class="line">&quot;heartbeatTimeoutSecs&quot; : 10, &quot;electionTimeoutMillis&quot; : 10000,</span><br><span class="line">&quot;catchUpTimeoutMillis&quot; : -1, &quot;catchUpTakeoverDelayMillis&quot; : 30000,</span><br><span class="line">&quot;getLastErrorModes&quot; : &#123; &#125;, &quot;getLastErrorDefaults&quot; : &#123; &quot;w&quot; : 1, &quot;wtimeout&quot; : 0</span><br><span class="line">&#125;, &quot;replicaSetId&quot; : ObjectId(&quot;5d539bdcd6a308e600d126bb&quot;) &#125; &#125;</span><br><span class="line">myrs:PRIMARY&gt;</span><br></pre></td></tr></table></figure><h3 id="1-4-6-第六步：查看副本集状态"><a href="#1-4-6-第六步：查看副本集状态" class="headerlink" title="1.4.6 第六步：查看副本集状态"></a>1.4.6 第六步：查看副本集状态</h3><p>检查副本集状态。</p><p>说明：</p><p>返回包含状态信息的文档。此输出使用从副本集的其他成员发送的心跳包中获得的数据反映副本集的当前状态。</p><p>语法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.status()</span><br></pre></td></tr></table></figure><p>【示例】</p><p>在27017上查看副本集状态：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">myrs:PRIMARY&gt; rs.status()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;set&quot; : &quot;myrs&quot;,</span><br><span class="line">    &quot;date&quot; : ISODate(&quot;2019-08-14T05:29:45.161Z&quot;),</span><br><span class="line">    &quot;myState&quot; : 1,</span><br><span class="line">    &quot;term&quot; : NumberLong(1),</span><br><span class="line">    &quot;syncingTo&quot; : &quot;&quot;,</span><br><span class="line">    &quot;syncSourceHost&quot; : &quot;&quot;,</span><br><span class="line">    &quot;syncSourceId&quot; : -1,</span><br><span class="line">    &quot;heartbeatIntervalMillis&quot; : NumberLong(2000),</span><br><span class="line">    &quot;optimes&quot; : &#123;</span><br><span class="line">        &quot;lastCommittedOpTime&quot; : &#123;</span><br><span class="line">            &quot;ts&quot; : Timestamp(1565760578, 1),</span><br><span class="line">            &quot;t&quot; : NumberLong(1)</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;readConcernMajorityOpTime&quot; : &#123;</span><br><span class="line">            &quot;ts&quot; : Timestamp(1565760578, 1),</span><br><span class="line">            &quot;t&quot; : NumberLong(1)</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;appliedOpTime&quot; : &#123;</span><br><span class="line">            &quot;ts&quot; : Timestamp(1565760578, 1),</span><br><span class="line">            &quot;t&quot; : NumberLong(1)</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;durableOpTime&quot; : &#123;</span><br><span class="line">            &quot;ts&quot; : Timestamp(1565760578, 1),</span><br><span class="line">            &quot;t&quot; : NumberLong(1)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;lastStableCheckpointTimestamp&quot; : Timestamp(1565760528, 1),</span><br><span class="line">    &quot;members&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">        &quot;_id&quot; : 0,</span><br><span class="line">        &quot;name&quot; : &quot;180.76.159.126:27017&quot;,</span><br><span class="line">        &quot;health&quot; : 1,</span><br><span class="line">        &quot;state&quot; : 1,</span><br><span class="line">        &quot;stateStr&quot; : &quot;PRIMARY&quot;,</span><br><span class="line">        &quot;uptime&quot; : 419,</span><br><span class="line">        &quot;optime&quot; : &#123;</span><br><span class="line">            &quot;ts&quot; : Timestamp(1565760578, 1),</span><br><span class="line">            &quot;t&quot; : NumberLong(1)</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;optimeDate&quot; : ISODate(&quot;2019-08-14T05:29:38Z&quot;),</span><br><span class="line">        &quot;syncingTo&quot; : &quot;&quot;,</span><br><span class="line">        &quot;syncSourceHost&quot; : &quot;&quot;,</span><br><span class="line">        &quot;syncSourceId&quot; : -1,</span><br><span class="line">        &quot;infoMessage&quot; : &quot;could not find member to sync from&quot;,</span><br><span class="line">        &quot;electionTime&quot; : Timestamp(1565760476, 2),</span><br><span class="line">        &quot;electionDate&quot; : ISODate(&quot;2019-08-14T05:27:56Z&quot;),</span><br><span class="line">        &quot;configVersion&quot; : 1,</span><br><span class="line">        &quot;self&quot; : true,</span><br><span class="line">        &quot;lastHeartbeatMessage&quot; : &quot;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;ok&quot; : 1,</span><br><span class="line">    &quot;operationTime&quot; : Timestamp(1565760578, 1),</span><br><span class="line">    &quot;$clusterTime&quot; : &#123;</span><br><span class="line">        &quot;clusterTime&quot; : Timestamp(1565760578, 1),</span><br><span class="line">        &quot;signature&quot; : &#123;</span><br><span class="line">            &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA&#x3D;&quot;),</span><br><span class="line">            &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>说明：</p><ul><li><code>&quot;set&quot; : &quot;myrs&quot;</code> ：副本集的名字</li><li><code>&quot;myState&quot;</code> : 1：说明状态正常</li><li><code>&quot;members&quot;</code> ：副本集成员数组，此时只有一个： <code>&quot;name&quot; : &quot;180.76.159.126:27017&quot;</code> ，该成员的角色是 <code>&quot;stateStr&quot; : &quot;PRIMARY&quot;</code>, 该节点是健康的： <code>&quot;health&quot; : 1</code> 。</li></ul><h3 id="1-4-7-第七步：添加副本从节点"><a href="#1-4-7-第七步：添加副本从节点" class="headerlink" title="1.4.7 第七步：添加副本从节点"></a>1.4.7 第七步：添加副本从节点</h3><p>在主节点添加从节点，将其他成员加入到副本集</p><p>语法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.add(host, arbiterOnly)</span><br></pre></td></tr></table></figure><p>选项：</p><table><thead><tr><th>Parameter</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>host</td><td>string or document</td><td>要添加到副本集的新成员。 指定为字符串或配置文档：1）如果是一个字符串，则需要指定新成员的主机名和可选的端口号；2）如果是一个文档，请指定在members数组中找到的副本集成员配置文档。 您必须在成员配置文档中指定主机字段。有关文档配置字段的说明，详见下方文档：“主机成员的配置文档”</td></tr><tr><td>arbiterOnly</td><td>boolean</td><td>可选的。 仅在 值为字符串时适用。 如果为true，则添加的主机是仲裁者。</td></tr></tbody></table><p>主机成员的配置文档：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    _id: &lt;int&gt;,</span><br><span class="line">    host: &lt;string&gt;,     &#x2F;&#x2F; required</span><br><span class="line">    arbiterOnly: &lt;boolean&gt;,</span><br><span class="line">    buildIndexes: &lt;boolean&gt;,</span><br><span class="line">    hidden: &lt;boolean&gt;,</span><br><span class="line">    priority: &lt;number&gt;,</span><br><span class="line">    tags: &lt;document&gt;,</span><br><span class="line">    slaveDelay: &lt;int&gt;,</span><br><span class="line">    votes: &lt;number&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>【示例】</p><p>将27018的副本节点添加到副本集中：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">myrs:PRIMARY&gt; rs.add(&quot;180.76.159.126:27018&quot;)</span><br><span class="line">&#123;</span><br><span class="line">    &quot;ok&quot; : 1,</span><br><span class="line">    &quot;operationTime&quot; : Timestamp(1565761757, 1),</span><br><span class="line">    &quot;$clusterTime&quot; : &#123;</span><br><span class="line">        &quot;clusterTime&quot; : Timestamp(1565761757, 1),</span><br><span class="line">        &quot;signature&quot; : &#123;</span><br><span class="line">            &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA&#x3D;&quot;),</span><br><span class="line">            &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>说明：</p><ul><li>“ok” : 1 ：说明添加成功。</li></ul><p>查看副本集状态：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">myrs:PRIMARY&gt; rs.status()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;set&quot; : &quot;myrs&quot;,</span><br><span class="line">    &quot;date&quot; : ISODate(&quot;2019-08-14T05:50:05.738Z&quot;),</span><br><span class="line">    &quot;myState&quot; : 1,</span><br><span class="line">    &quot;term&quot; : NumberLong(1),</span><br><span class="line">    &quot;syncingTo&quot; : &quot;&quot;,</span><br><span class="line">    &quot;syncSourceHost&quot; : &quot;&quot;,</span><br><span class="line">    &quot;syncSourceId&quot; : -1,</span><br><span class="line">    &quot;heartbeatIntervalMillis&quot; : NumberLong(2000),</span><br><span class="line">    &quot;optimes&quot; : &#123;</span><br><span class="line">        &quot;lastCommittedOpTime&quot; : &#123;</span><br><span class="line">            &quot;ts&quot; : Timestamp(1565761798, 1),</span><br><span class="line">            &quot;t&quot; : NumberLong(1)</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;readConcernMajorityOpTime&quot; : &#123;</span><br><span class="line">            &quot;ts&quot; : Timestamp(1565761798, 1),</span><br><span class="line">            &quot;t&quot; : NumberLong(1)</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;appliedOpTime&quot; : &#123;</span><br><span class="line">            &quot;ts&quot; : Timestamp(1565761798, 1),</span><br><span class="line">            &quot;t&quot; : NumberLong(1)</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;durableOpTime&quot; : &#123;</span><br><span class="line">            &quot;ts&quot; : Timestamp(1565761798, 1),</span><br><span class="line">            &quot;t&quot; : NumberLong(1)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;lastStableCheckpointTimestamp&quot; : Timestamp(1565761798, 1),</span><br><span class="line">    &quot;members&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_id&quot; : 0,</span><br><span class="line">            &quot;name&quot; : &quot;180.76.159.126:27017&quot;,</span><br><span class="line">            &quot;health&quot; : 1,</span><br><span class="line">            &quot;state&quot; : 1,</span><br><span class="line">            &quot;stateStr&quot; : &quot;PRIMARY&quot;,</span><br><span class="line">            &quot;uptime&quot; : 1639,</span><br><span class="line">            &quot;optime&quot; : &#123;</span><br><span class="line">                &quot;ts&quot; : Timestamp(1565761798, 1),</span><br><span class="line">                &quot;t&quot; : NumberLong(1)</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;optimeDate&quot; : ISODate(&quot;2019-08-14T05:49:58Z&quot;),</span><br><span class="line">            &quot;syncingTo&quot; : &quot;&quot;,</span><br><span class="line">            &quot;syncSourceHost&quot; : &quot;&quot;,</span><br><span class="line">            &quot;syncSourceId&quot; : -1,</span><br><span class="line">            &quot;infoMessage&quot; : &quot;&quot;,</span><br><span class="line">            &quot;electionTime&quot; : Timestamp(1565760476, 2),</span><br><span class="line">            &quot;electionDate&quot; : ISODate(&quot;2019-08-14T05:27:56Z&quot;),</span><br><span class="line">            &quot;configVersion&quot; : 2,</span><br><span class="line">            &quot;self&quot; : true,</span><br><span class="line">            &quot;lastHeartbeatMessage&quot; : &quot;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_id&quot; : 1,</span><br><span class="line">            &quot;name&quot; : &quot;180.76.159.126:27018&quot;,</span><br><span class="line">            &quot;health&quot; : 1,</span><br><span class="line">            &quot;state&quot; : 2,</span><br><span class="line">            &quot;stateStr&quot; : &quot;SECONDARY&quot;,</span><br><span class="line">            &quot;uptime&quot; : 48,</span><br><span class="line">            &quot;optime&quot; : &#123;</span><br><span class="line">                &quot;ts&quot; : Timestamp(1565761798, 1),</span><br><span class="line">                &quot;t&quot; : NumberLong(1)</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;optimeDurable&quot; : &#123;</span><br><span class="line">                &quot;ts&quot; : Timestamp(1565761798, 1),</span><br><span class="line">                &quot;t&quot; : NumberLong(1)</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;optimeDate&quot; : ISODate(&quot;2019-08-14T05:49:58Z&quot;),</span><br><span class="line">            &quot;optimeDurableDate&quot; : ISODate(&quot;2019-08-14T05:49:58Z&quot;),</span><br><span class="line">            &quot;lastHeartbeat&quot; : ISODate(&quot;2019-08-14T05:50:05.294Z&quot;),</span><br><span class="line">            &quot;lastHeartbeatRecv&quot; : ISODate(&quot;2019-08-</span><br><span class="line">            14T05:50:05.476Z&quot;),</span><br><span class="line">            &quot;pingMs&quot; : NumberLong(0),</span><br><span class="line">            &quot;lastHeartbeatMessage&quot; : &quot;&quot;,</span><br><span class="line">            &quot;syncingTo&quot; : &quot;180.76.159.126:27017&quot;,</span><br><span class="line">            &quot;syncSourceHost&quot; : &quot;180.76.159.126:27017&quot;,</span><br><span class="line">            &quot;syncSourceId&quot; : 0,</span><br><span class="line">            &quot;infoMessage&quot; : &quot;&quot;,</span><br><span class="line">            &quot;configVersion&quot; : 2</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;ok&quot; : 1,</span><br><span class="line">    &quot;operationTime&quot; : Timestamp(1565761798, 1),</span><br><span class="line">    &quot;$clusterTime&quot; : &#123;</span><br><span class="line">        &quot;clusterTime&quot; : Timestamp(1565761798, 1),</span><br><span class="line">        &quot;signature&quot; : &#123;</span><br><span class="line">            &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA&#x3D;&quot;),</span><br><span class="line">            &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>说明：</p><ul><li><code>&quot;name&quot; : &quot;180.76.159.126:27018&quot;</code> 是第二个节点的名字，其角色是 <code>&quot;stateStr&quot; : &quot;SECONDARY&quot;</code></li></ul><h3 id="1-4-8-第八步：添加仲裁从节点"><a href="#1-4-8-第八步：添加仲裁从节点" class="headerlink" title="1.4.8 第八步：添加仲裁从节点"></a>1.4.8 第八步：添加仲裁从节点</h3><p>添加一个仲裁节点到副本集</p><p>语法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.addArb(host)</span><br></pre></td></tr></table></figure><p>将27019的仲裁节点添加到副本集中：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">myrs:PRIMARY&gt; rs.addArb(&quot;180.76.159.126:27019&quot;)</span><br><span class="line">&#123;</span><br><span class="line">    &quot;ok&quot; : 1,</span><br><span class="line">    &quot;operationTime&quot; : Timestamp(1565761959, 1),</span><br><span class="line">    &quot;$clusterTime&quot; : &#123;</span><br><span class="line">        &quot;clusterTime&quot; : Timestamp(1565761959, 1),</span><br><span class="line">        &quot;signature&quot; : &#123;</span><br><span class="line">            &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA&#x3D;&quot;),</span><br><span class="line">            &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>说明：</p><ul><li><code>&quot;ok&quot; : 1</code> ：说明添加成功。</li></ul><p>查看副本集状态：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">myrs:PRIMARY&gt; rs.status()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;set&quot; : &quot;myrs&quot;,</span><br><span class="line">    &quot;date&quot; : ISODate(&quot;2019-08-14T05:53:27.198Z&quot;),</span><br><span class="line">    &quot;myState&quot; : 1,</span><br><span class="line">    &quot;term&quot; : NumberLong(1),</span><br><span class="line">    &quot;syncingTo&quot; : &quot;&quot;,</span><br><span class="line">    &quot;syncSourceHost&quot; : &quot;&quot;,</span><br><span class="line">    &quot;syncSourceId&quot; : -1,</span><br><span class="line">    &quot;heartbeatIntervalMillis&quot; : NumberLong(2000),</span><br><span class="line">    &quot;optimes&quot; : &#123;</span><br><span class="line">        &quot;lastCommittedOpTime&quot; : &#123;</span><br><span class="line">            &quot;ts&quot; : Timestamp(1565761998, 1),</span><br><span class="line">            &quot;t&quot; : NumberLong(1)</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;readConcernMajorityOpTime&quot; : &#123;</span><br><span class="line">            &quot;ts&quot; : Timestamp(1565761998, 1),</span><br><span class="line">            &quot;t&quot; : NumberLong(1)</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;appliedOpTime&quot; : &#123;</span><br><span class="line">            &quot;ts&quot; : Timestamp(1565761998, 1),</span><br><span class="line">            &quot;t&quot; : NumberLong(1)</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;durableOpTime&quot; : &#123;</span><br><span class="line">            &quot;ts&quot; : Timestamp(1565761998, 1),</span><br><span class="line">            &quot;t&quot; : NumberLong(1)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;lastStableCheckpointTimestamp&quot; : Timestamp(1565761978, 1),</span><br><span class="line">    &quot;members&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_id&quot; : 0,</span><br><span class="line">            &quot;name&quot; : &quot;180.76.159.126:27017&quot;,</span><br><span class="line">            &quot;health&quot; : 1,</span><br><span class="line">            &quot;state&quot; : 1,</span><br><span class="line">            &quot;stateStr&quot; : &quot;PRIMARY&quot;,</span><br><span class="line">            &quot;uptime&quot; : 1841,</span><br><span class="line">            &quot;optime&quot; : &#123;</span><br><span class="line">                &quot;ts&quot; : Timestamp(1565761998, 1),</span><br><span class="line">                &quot;t&quot; : NumberLong(1)</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;optimeDate&quot; : ISODate(&quot;2019-08-14T05:53:18Z&quot;),</span><br><span class="line">            &quot;syncingTo&quot; : &quot;&quot;,</span><br><span class="line">            &quot;syncSourceHost&quot; : &quot;&quot;,</span><br><span class="line">            &quot;syncSourceId&quot; : -1,</span><br><span class="line">            &quot;infoMessage&quot; : &quot;&quot;,</span><br><span class="line">            &quot;electionTime&quot; : Timestamp(1565760476, 2),</span><br><span class="line">            &quot;electionDate&quot; : ISODate(&quot;2019-08-14T05:27:56Z&quot;),</span><br><span class="line">            &quot;configVersion&quot; : 3,</span><br><span class="line">            &quot;self&quot; : true,</span><br><span class="line">            &quot;lastHeartbeatMessage&quot; : &quot;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_id&quot; : 1,</span><br><span class="line">            &quot;name&quot; : &quot;180.76.159.126:27018&quot;,</span><br><span class="line">            &quot;health&quot; : 1,</span><br><span class="line">            &quot;state&quot; : 2,</span><br><span class="line">            &quot;stateStr&quot; : &quot;SECONDARY&quot;,</span><br><span class="line">            &quot;uptime&quot; : 249,</span><br><span class="line">            &quot;optime&quot; : &#123;</span><br><span class="line">                &quot;ts&quot; : Timestamp(1565761998, 1),</span><br><span class="line">                &quot;t&quot; : NumberLong(1)</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;optimeDurable&quot; : &#123;</span><br><span class="line">                &quot;ts&quot; : Timestamp(1565761998, 1),</span><br><span class="line">                &quot;t&quot; : NumberLong(1)</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;optimeDate&quot; : ISODate(&quot;2019-08-14T05:53:18Z&quot;),</span><br><span class="line">            &quot;optimeDurableDate&quot; : ISODate(&quot;2019-08-14T05:53:18Z&quot;),</span><br><span class="line">            &quot;lastHeartbeat&quot; : ISODate(&quot;2019-08-14T05:53:25.668Z&quot;),</span><br><span class="line">            &quot;lastHeartbeatRecv&quot; : ISODate(&quot;2019-08-14T05:53:26.702Z&quot;),</span><br><span class="line">            &quot;pingMs&quot; : NumberLong(0),</span><br><span class="line">            &quot;lastHeartbeatMessage&quot; : &quot;&quot;,</span><br><span class="line">            &quot;syncingTo&quot; : &quot;180.76.159.126:27017&quot;,</span><br><span class="line">            &quot;syncSourceHost&quot; : &quot;180.76.159.126:27017&quot;,</span><br><span class="line">            &quot;syncSourceId&quot; : 0,</span><br><span class="line">            &quot;infoMessage&quot; : &quot;&quot;,</span><br><span class="line">            &quot;configVersion&quot; : 3</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_id&quot; : 2,</span><br><span class="line">            &quot;name&quot; : &quot;180.76.159.126:27019&quot;,</span><br><span class="line">            &quot;health&quot; : 1,</span><br><span class="line">            &quot;state&quot; : 7,</span><br><span class="line">            &quot;stateStr&quot; : &quot;ARBITER&quot;,</span><br><span class="line">            &quot;uptime&quot; : 47,</span><br><span class="line">            &quot;lastHeartbeat&quot; : ISODate(&quot;2019-08-14T05:53:25.668Z&quot;),</span><br><span class="line">            &quot;lastHeartbeatRecv&quot; : ISODate(&quot;2019-08-14T05:53:25.685Z&quot;),</span><br><span class="line">            &quot;pingMs&quot; : NumberLong(0),</span><br><span class="line">            &quot;lastHeartbeatMessage&quot; : &quot;&quot;,</span><br><span class="line">            &quot;syncingTo&quot; : &quot;&quot;,</span><br><span class="line">            &quot;syncSourceHost&quot; : &quot;&quot;,</span><br><span class="line">            &quot;syncSourceId&quot; : -1,</span><br><span class="line">            &quot;infoMessage&quot; : &quot;&quot;,</span><br><span class="line">            &quot;configVersion&quot; : 3</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;ok&quot; : 1,</span><br><span class="line">    &quot;operationTime&quot; : Timestamp(1565761998, 1),</span><br><span class="line">    &quot;$clusterTime&quot; : &#123;</span><br><span class="line">        &quot;clusterTime&quot; : Timestamp(1565761998, 1),</span><br><span class="line">        &quot;signature&quot; : &#123;</span><br><span class="line">            &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA&#x3D;&quot;),</span><br><span class="line">            &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>说明：</p><ul><li><code>&quot;name&quot; : &quot;180.76.159.126:27019&quot;</code> 是第二个节点的名字，其角色是 <code>&quot;stateStr&quot; : &quot;ARBITER&quot;</code></li></ul><h2 id="1-5-副本集的数据读写操作"><a href="#1-5-副本集的数据读写操作" class="headerlink" title="1.5 副本集的数据读写操作"></a>1.5 副本集的数据读写操作</h2><p>目标：测试三个不同角色的节点的数据读写情况</p><p>登录主节点27017，写入和读取数据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost ~]# &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongo --host 180.76.159.126 --port 27017</span><br><span class="line">myrs:PRIMARY&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">myrs:PRIMARY&gt; db</span><br><span class="line">articledb</span><br><span class="line">myrs:PRIMARY&gt; db.comment.insert(&#123;&quot;articleid&quot;:&quot;100000&quot;,&quot;content&quot;:&quot;今天天气真好，阳光明媚&quot;,&quot;userid&quot;:&quot;1001&quot;,&quot;nickname&quot;:&quot;Rose&quot;,&quot;createdatetime&quot;:new Date()&#125;)</span><br><span class="line">WriteResult(&#123; &quot;nInserted&quot; : 1 &#125;)</span><br><span class="line">myrs:PRIMARY&gt; db.comment.find()</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d4d2ae3068138b4570f53bf&quot;), &quot;articleid&quot; : &quot;100000&quot;,&quot;content&quot; : &quot;今天天气真好，阳光明媚&quot;, &quot;userid&quot; : &quot;1001&quot;, &quot;nickname&quot; : &quot;Rose&quot;,&quot;createdatetime&quot; : ISODate(&quot;2019-08-09T08:12:19.427Z&quot;) &#125;</span><br></pre></td></tr></table></figure><p>登录从节点27018</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost ~]# &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongo --host 180.76.159.126 --port 27018</span><br><span class="line">myrs:SECONDARY&gt; show dbs;</span><br><span class="line">2019-09-10T10:56:51.953+0800 E QUERY  [js] Error: listDatabases failed:&#123;</span><br><span class="line">    &quot;operationTime&quot; : Timestamp(1568084204, 1),</span><br><span class="line">    &quot;ok&quot; : 0,</span><br><span class="line">    &quot;errmsg&quot; : &quot;not master and slaveOk&#x3D;false&quot;,</span><br><span class="line">    &quot;code&quot; : 13435,</span><br><span class="line">    &quot;codeName&quot; : &quot;NotMasterNoSlaveOk&quot;,</span><br><span class="line">    &quot;$clusterTime&quot; : &#123;</span><br><span class="line">        &quot;clusterTime&quot; : Timestamp(1568084204, 1),</span><br><span class="line">        &quot;signature&quot; : &#123;</span><br><span class="line">            &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA&#x3D;&quot;),</span><br><span class="line">            &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125; :</span><br><span class="line">_getErrorWithCode@src&#x2F;mongo&#x2F;shell&#x2F;utils.js:25:13</span><br><span class="line">Mongo.prototype.getDBs@src&#x2F;mongo&#x2F;shell&#x2F;mongo.js:139:1</span><br><span class="line">shellHelper.show@src&#x2F;mongo&#x2F;shell&#x2F;utils.js:882:13</span><br><span class="line">shellHelper@src&#x2F;mongo&#x2F;shell&#x2F;utils.js:766:15</span><br><span class="line">@(shellhelp2):1:1</span><br></pre></td></tr></table></figure><p>发现，不能读取集合的数据。当前从节点只是一个备份，不是奴隶节点，无法读取数据，写当然更不行。</p><p>因为默认情况下，从节点是没有读写权限的，可以增加读的权限，但需要进行设置</p><p>设置读操作权限：</p><p>说明：</p><p>设置为奴隶节点，允许在从成员上运行读的操作</p><p>语法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rs.slaveOk()</span><br><span class="line">#或</span><br><span class="line">rs.slaveOk(true)</span><br></pre></td></tr></table></figure><p>提示：</p><p>该命令是 <code>db.getMongo().setSlaveOk()</code> 的简化命令。</p><p>【示例】</p><p>在27018上设置作为奴隶节点权限，具备读权限：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs:SECONDARY&gt; rs.slaveOk()</span><br></pre></td></tr></table></figure><p>此时，在执行查询命令，运行成功！</p><p>但仍然不允许插入。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">myrs:SECONDARY&gt; rs.slaveOk()</span><br><span class="line">myrs:SECONDARY&gt; show dbs;</span><br><span class="line">admin    0.000GB</span><br><span class="line">articledb  0.000GB</span><br><span class="line">config   0.000GB</span><br><span class="line">local    0.000GB</span><br><span class="line">myrs:SECONDARY&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">myrs:SECONDARY&gt; show collections</span><br><span class="line">comment</span><br><span class="line">myrs:SECONDARY&gt; db.comment.find()</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5d7710c04cfd7eee2e3cdabe&quot;), &quot;articleid&quot; : &quot;100000&quot;,&quot;content&quot; : &quot;今天天气真好，阳光明媚&quot;, &quot;userid&quot; : &quot;1001&quot;, &quot;nickname&quot; : &quot;Rose&quot;,&quot;createdatetime&quot; : ISODate(&quot;2019-09-10T02:56:00.467Z&quot;) &#125;</span><br><span class="line">myrs:SECONDARY&gt; db.comment.insert(&#123;&quot;_id&quot;:&quot;1&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我们不应该把清晨浪费在手机上，健康很重要，k一杯温水幸福你我他。&quot;,&quot;userid&quot;:&quot;1002&quot;,&quot;nickname&quot;:&quot;相忘于江湖&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-05T22:08:15.522Z&quot;),&quot;likenum&quot;:NumberInt(1000),&quot;state&quot;:&quot;1&quot;&#125;)</span><br><span class="line">WriteCommandError(&#123;</span><br><span class="line">    &quot;operationTime&quot; : Timestamp(1568084434, 1),</span><br><span class="line">    &quot;ok&quot; : 0,</span><br><span class="line">    &quot;errmsg&quot; : &quot;not master&quot;,</span><br><span class="line">    &quot;code&quot; : 10107,</span><br><span class="line">    &quot;codeName&quot; : &quot;NotMaster&quot;,</span><br><span class="line">    &quot;$clusterTime&quot; : &#123;</span><br><span class="line">        &quot;clusterTime&quot; : Timestamp(1568084434, 1),</span><br><span class="line">        &quot;signature&quot; : &#123;</span><br><span class="line">            &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA&#x3D;&quot;),</span><br><span class="line">            &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>现在可实现了读写分离，让主插入数据，让从来读取数据。</p><p>如果要取消作为奴隶节点的读权限：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">myrs:SECONDARY&gt; rs.slaveOk(false)</span><br><span class="line">myrs:SECONDARY&gt; db.comment.find()</span><br><span class="line">Error: error: &#123;</span><br><span class="line">    &quot;operationTime&quot; : Timestamp(1568084459, 1),</span><br><span class="line">    &quot;ok&quot; : 0,</span><br><span class="line">    &quot;errmsg&quot; : &quot;not master and slaveOk&#x3D;false&quot;,</span><br><span class="line">    &quot;code&quot; : 13435,</span><br><span class="line">    &quot;codeName&quot; : &quot;NotMasterNoSlaveOk&quot;,</span><br><span class="line">    &quot;$clusterTime&quot; : &#123;</span><br><span class="line">        &quot;clusterTime&quot; : Timestamp(1568084459, 1),</span><br><span class="line">        &quot;signature&quot; : &#123;</span><br><span class="line">            &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA&#x3D;&quot;),</span><br><span class="line">            &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>仲裁者节点，不存放任何业务数据的，可以登录查看</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost ~]# &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongo --host 180.76.159.126 --port 27019</span><br><span class="line">myrs:ARBITER&gt; rs.slaveOk()</span><br><span class="line">myrs:ARBITER&gt; show dbs</span><br><span class="line">local  0.000GB</span><br><span class="line">myrs:ARBITER&gt; use local</span><br><span class="line">switched to db local</span><br><span class="line">myrs:ARBITER&gt; show collections</span><br><span class="line">replset.minvalid</span><br><span class="line">replset.oplogTruncateAfterPoint</span><br><span class="line">startup_log</span><br><span class="line">system.replset</span><br><span class="line">system.rollback.id</span><br><span class="line">myrs:ARBITER&gt;</span><br></pre></td></tr></table></figure><p>发现，只存放副本集配置等数据。</p><h2 id="1-6-主节点的选举原则"><a href="#1-6-主节点的选举原则" class="headerlink" title="1.6 主节点的选举原则"></a>1.6 主节点的选举原则</h2><p>MongoDB在副本集中，会自动进行主节点的选举，主节点选举的触发条件：</p><ul><li>主节点故障</li><li>主节点网络不可达（默认心跳信息为10秒）</li><li>人工干预（rs.stepDown(600)）</li></ul><p>一旦触发选举，就要根据一定规则来选主节点。</p><p>选举规则是根据票数来决定谁获胜：</p><ul><li><p>票数最高，且获得了 “大多数”成员的投票支持的节点获胜。</p><p>“大多数”的定义为：假设复制集内投票成员数量为N，则大多数为 N/2 + 1。例如：3个投票成员，则大多数的值是2。当复制集内存活成员数量不足大多数时，整个复制集将无法选举出Primary，复制集将无法提供写服务，处于只读状态。</p></li><li><p>若票数相同，且都获得了 “大多数”成员的投票支持的，数据新的节点获胜。</p><p>数据的新旧是通过操作日志oplog来对比的。</p></li></ul><p>在获得票数的时候，优先级（priority）参数影响重大。</p><p>可以通过设置优先级（priority）来设置额外票数。优先级即权重，取值为0-1000，相当于可额外增加0-1000的票数，优先级的值越大，就越可能获得多数成员的投票（votes）数。指定较高的值可使成员更有资格成为主要成员，更低的值可使成员更不符合条件。</p><p>默认情况下，优先级的值是1</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">myrs:PRIMARY&gt; rs.conf()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;_id&quot; : &quot;myrs&quot;,</span><br><span class="line">    &quot;version&quot; : 3,</span><br><span class="line">    &quot;protocolVersion&quot; : NumberLong(1),</span><br><span class="line">    &quot;writeConcernMajorityJournalDefault&quot; : true,</span><br><span class="line">    &quot;members&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_id&quot; : 0,</span><br><span class="line">            &quot;host&quot; : &quot;180.76.159.126:27017&quot;,</span><br><span class="line">            &quot;arbiterOnly&quot; : false,</span><br><span class="line">            &quot;buildIndexes&quot; : true,</span><br><span class="line">            &quot;hidden&quot; : false,</span><br><span class="line">            &quot;priority&quot; : 1,</span><br><span class="line">            &quot;tags&quot; : &#123;</span><br><span class="line">            </span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;slaveDelay&quot; : NumberLong(0),</span><br><span class="line">            &quot;votes&quot; : 1</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_id&quot; : 1,</span><br><span class="line">            &quot;host&quot; : &quot;180.76.159.126:27018&quot;,</span><br><span class="line">            &quot;arbiterOnly&quot; : false,</span><br><span class="line">            &quot;buildIndexes&quot; : true,</span><br><span class="line">            &quot;hidden&quot; : false,</span><br><span class="line">            &quot;priority&quot; : 1,</span><br><span class="line">            &quot;tags&quot; : &#123;</span><br><span class="line">            </span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;slaveDelay&quot; : NumberLong(0),</span><br><span class="line">            &quot;votes&quot; : 1</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_id&quot; : 2,</span><br><span class="line">            &quot;host&quot; : &quot;180.76.159.126:27019&quot;,</span><br><span class="line">            &quot;arbiterOnly&quot; : true,</span><br><span class="line">            &quot;buildIndexes&quot; : true,</span><br><span class="line">            &quot;hidden&quot; : false,</span><br><span class="line">            &quot;priority&quot; : 0,</span><br><span class="line">            &quot;tags&quot; : &#123;</span><br><span class="line">            </span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;slaveDelay&quot; : NumberLong(0),</span><br><span class="line">            &quot;votes&quot; : 1</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">        &quot;chainingAllowed&quot; : true,</span><br><span class="line">        &quot;heartbeatIntervalMillis&quot; : 2000,</span><br><span class="line">        &quot;heartbeatTimeoutSecs&quot; : 10,</span><br><span class="line">        &quot;electionTimeoutMillis&quot; : 10000,</span><br><span class="line">        &quot;catchUpTimeoutMillis&quot; : -1,</span><br><span class="line">        &quot;catchUpTakeoverDelayMillis&quot; : 30000,</span><br><span class="line">        &quot;getLastErrorModes&quot; : &#123;</span><br><span class="line">        </span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;getLastErrorDefaults&quot; : &#123;</span><br><span class="line">            &quot;w&quot; : 1,</span><br><span class="line">            &quot;wtimeout&quot; : 0</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;replicaSetId&quot; : ObjectId(&quot;5d539bdcd6a308e600d126bb&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看出，主节点和副本节点的优先级各为 1，即，默认可以认为都已经有了一票。但选举节点，优先级是0，（要注意是，官方说了，选举节点的优先级必须是0，不能是别的值。即不具备选举权，但具有投票权）</p><p>【了解】修改优先级</p><p>比如，下面提升从节点的优先级：</p><p>1）先将配置导入cfg变量</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myrs:SECONDARY&gt; cfg&#x3D;rs.conf()</span><br></pre></td></tr></table></figure><p>2 ）然后修改值（ID号默认从0开始）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">myrs:SECONDARY&gt; cfg.members[1].priority&#x3D;2</span><br><span class="line">2</span><br></pre></td></tr></table></figure><p>3 ）重新加载配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">myrs:SECONDARY&gt; rs.reconfig(cfg)</span><br><span class="line">&#123; &quot;ok&quot; : 1 &#125;</span><br></pre></td></tr></table></figure><p>稍等片刻会重新开始选举。</p><h2 id="1-7-故障测试"><a href="#1-7-故障测试" class="headerlink" title="1.7 故障测试"></a>1.7 故障测试</h2><h3 id="1-7-1-副本节点故障测试"><a href="#1-7-1-副本节点故障测试" class="headerlink" title="1.7.1 副本节点故障测试"></a>1.7.1 副本节点故障测试</h3><p>关闭27018副本节点：</p><p>发现，主节点和仲裁节点对27018的心跳失败。因为主节点还在，因此，没有触发投票选举。</p><p>如果此时，在主节点写入数据。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.insert(&#123;&quot;_id&quot;:&quot;1&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。&quot;,&quot;userid&quot;:&quot;1002&quot;,&quot;nickname&quot;:&quot;相忘于江湖&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-05T22:08:15.522Z&quot;),&quot;likenum&quot;:NumberInt(1000),&quot;state&quot;:&quot;1&quot;&#125;)</span><br></pre></td></tr></table></figure><p>再启动从节点，会发现，主节点写入的数据，会自动同步给从节点。</p><h3 id="1-7-2-主节点故障测试"><a href="#1-7-2-主节点故障测试" class="headerlink" title="1.7.2 主节点故障测试"></a>1.7.2 主节点故障测试</h3><p>关闭27017节点</p><p>发现，从节点和仲裁节点对27017的心跳失败，当失败超过10秒，此时因为没有主节点了，会自动发起投票。</p><p>而副本节点只有27018，因此，候选人只有一个就是27018，开始投票。</p><p>27019向27018投了一票，27018本身自带一票，因此共两票，超过了“大多数”</p><p>27019是仲裁节点，没有选举权，27018不向其投票，其票数是0.</p><p>最终结果，27018成为主节点。具备读写功能。</p><p>在27018写入数据查看。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.insert(&#123;&quot;_id&quot;:&quot;2&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我夏天空腹喝凉开水，冬天喝温开水&quot;,&quot;userid&quot;:&quot;1005&quot;,&quot;nickname&quot;:&quot;伊人憔悴&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-05T23:58:51.485Z&quot;),&quot;likenum&quot;:NumberInt(888),&quot;state&quot;:&quot;1&quot;&#125;)</span><br></pre></td></tr></table></figure><p>再启动 27017节点，发现27017变成了从节点，27018仍保持主节点。</p><p>登录27017节点，发现是从节点了，数据自动从27018同步。</p><p>从而实现了高可用。</p><h3 id="1-7-3-仲裁节点和主节点故障"><a href="#1-7-3-仲裁节点和主节点故障" class="headerlink" title="1.7.3 仲裁节点和主节点故障"></a>1.7.3 仲裁节点和主节点故障</h3><p>先关掉仲裁节点27019，</p><p>关掉现在的主节点27018</p><p>登录27017后，发现，27017仍然是从节点，副本集中没有主节点了，导致此时，副本集是只读状态，无法写入。</p><p>为啥不选举了？因为27017的票数，没有获得大多数，即没有大于等于2，它只有默认的一票（优先级是1）</p><p>如果要触发选举，随便加入一个成员即可。</p><ul><li>如果只加入 27019仲裁节点成员，则主节点一定是27017，因为没得选了，仲裁节点不参与选举，但参与投票。（不演示）</li><li>如果只加入 27018节点，会发起选举。因为27017和27018都是两票，则按照谁数据新，谁当主节点。</li></ul><h3 id="1-7-4-仲裁节点和从节点故障"><a href="#1-7-4-仲裁节点和从节点故障" class="headerlink" title="1.7.4 仲裁节点和从节点故障"></a>1.7.4 仲裁节点和从节点故障</h3><p>先关掉仲裁节点27019，</p><p>关掉现在的副本节点27018</p><p>10秒后，27017主节点自动降级为副本节点。（服务降级）</p><p>副本集不可写数据了，已经故障了。</p><h2 id="1-8-Compass-连接副本集"><a href="#1-8-Compass-连接副本集" class="headerlink" title="1.8 Compass 连接副本集"></a>1.8 Compass 连接副本集</h2><p>compass连接：</p><p><img src="https://img-blog.csdnimg.cn/20200918165004924.png" alt="image-20200918102748168"></p><p><img src="https://img-blog.csdnimg.cn/202009181650221.png" alt="image-20200918102811874"></p><h2 id="1-9-SpringDataMongoDB-连接副本集"><a href="#1-9-SpringDataMongoDB-连接副本集" class="headerlink" title="1.9 SpringDataMongoDB 连接副本集"></a>1.9 SpringDataMongoDB 连接副本集</h2><p>副本集语法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongodb:&#x2F;&#x2F;host1,host2,host3&#x2F;articledb?connect&#x3D;replicaSet&amp;slaveOk&#x3D;true&amp;replicaSet&#x3D;副本集名字</span><br></pre></td></tr></table></figure><p>其中：</p><ul><li>slaveOk=true ：开启副本节点读的功能，可实现读写分离。</li><li>connect=replicaSet ：自动到副本集中选择读写的主机。如果slaveOK是打开的，则实现了读写分离</li></ul><p>【示例】</p><p>连接 replica set 三台服务器 (端口 27017, 27018, 和27019)，直接连接第一个服务器，无论是replica set一部分或者主服务器或者从服务器，写入操作应用在主服务器 并且分布查询到从服务器。</p><p>修改配置文件application.yml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">    #数据源配置</span><br><span class="line">    data:</span><br><span class="line">        mongodb:</span><br><span class="line">            # 主机地址</span><br><span class="line">            #   host: 180.76.159.126</span><br><span class="line">            # 数据库</span><br><span class="line">            #   database: articledb</span><br><span class="line">            # 默认端口是27017</span><br><span class="line">            #   port: 27017</span><br><span class="line">            #也可以使用uri连接</span><br><span class="line">            #uri: mongodb:&#x2F;&#x2F;192.168.40.134:27017&#x2F;articledb</span><br><span class="line">            # 副本集的连接字符串</span><br><span class="line">            uri: mongodb:&#x2F;&#x2F;180.76.159.126:27017,180.76.159.126:27018,180.76.159.126:27019&#x2F;articledb?connect&#x3D;replicaSet&amp;slaveOk&#x3D;true&amp;replicaSet&#x3D;myrs</span><br></pre></td></tr></table></figure><p>注意：</p><p>主机必须是副本集中所有的主机，包括主节点、副本节点、仲裁节点。</p><p>SpringDataMongoDB自动实现了读写分离：</p><p>写操作时，只打开主节点连接；读操作是，同时打开主节点和从节点连接，但使用从节点获取数据。</p><p>完整的连接字符串的参考（了解）：</p><p>MongoDB客户端连接语法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongodb:&#x2F;&#x2F;[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][&#x2F;[database][?options]]</span><br></pre></td></tr></table></figure><ul><li><strong>mongodb://</strong> 这是固定的格式，必须要指定。</li><li><strong>username:password@</strong> 可选项，如果设置，在连接数据库服务器之后，驱动都会尝试登陆这个数据库</li><li><strong>host1</strong> 必须的指定至少一个host, host1 是这个URI唯一要填写的。它指定了要连接服务器的地址。如果要连接复制集，请指定多个主机地址。</li><li><strong>portX</strong> 可选的指定端口，如果不填，默认为27017</li><li><strong>/database</strong> 如果指定username:password@，连接并验证登陆指定数据库。若不指定，默认打开test 数据库。</li><li><strong>?options</strong> 是连接选项。如果不使用/database，则前面需要加上/。所有连接选项都是键值对name=value，键值对之间通过&amp;或;（分号）隔开</li></ul><p>标准的连接格式包含了多个选项(options)，如下所示：</p><table><thead><tr><th>选项</th><th>描述</th></tr></thead><tbody><tr><td>replicaSet=name</td><td>验证replica set的名称。 Impliesconnect=replicaSet.</td></tr><tr><td>slaveOk=true|false</td><td>true:在connect=direct模式下，驱动会连接第一台机器，即使这台服务器不是主。在connect=replicaSet模式下，驱动会发送所有的写请求到主并且把读取操作分布在其他从服务器。false: 在connect=direct模式下，驱动会自动找寻主服务器. 在connect=replicaSet 模式下，驱动仅仅连接主服务器，并且所有的读写命令都连接到主服务器。</td></tr><tr><td>safe=true|false</td><td>true: 在执行更新操作之后，驱动都会发送getLastError命令来确保更新成功。(还要参考 wtimeoutMS).false: 在每次更新之后，驱动不会发送getLastError来确保更新成功。</td></tr><tr><td>w=n</td><td>驱动添加 { w : n } 到getLastError命令. 应用于safe=true。</td></tr><tr><td>wtimeoutMS=ms</td><td>驱动添加 { wtimeout : ms } 到 getlasterror 命令. 应用于 safe=true.</td></tr><tr><td>fsync=true|false</td><td>true: 驱动添加 { fsync : true } 到 getlasterror 命令.应用于safe=true.false: 驱动不会添加到getLastError命令中。</td></tr><tr><td>journal=true|false</td><td>如果设置为 true, 同步到 journal (在提交到数据库前写入到实体中).应用于 safe=true</td></tr><tr><td>connectTimeoutMS=ms</td><td>可以打开连接的时间</td></tr><tr><td>socketTimeoutMS=ms</td><td>发送和接受sockets的时间</td></tr></tbody></table><h1 id="2-分片集群-Sharded-Cluster"><a href="#2-分片集群-Sharded-Cluster" class="headerlink" title="2. 分片集群-Sharded Cluster"></a>2. 分片集群-Sharded Cluster</h1><h2 id="2-1-分片概念"><a href="#2-1-分片概念" class="headerlink" title="2.1 分片概念"></a>2.1 分片概念</h2><p>分片（sharding）是一种跨多台机器分布数据的方法， MongoDB使用分片来支持具有非常大的数据集和高吞吐量操作的部署。</p><p>换句话说：分片(sharding)是指将数据拆分，将其分散存在不同的机器上的过程。有时也用分区(partitioning)来表示这个概念。将数据分散到不同的机器上，不需要功能强大的大型计算机就可以储存更多的数据，处理更多的负载。</p><p>具有大型数据集或高吞吐量应用程序的数据库系统可以会挑战单个服务器的容量。例如，高查询率会耗尽服务器的CPU容量。工作集大小大于系统的RAM会强调磁盘驱动器的I / O容量。</p><p>有两种解决系统增长的方法：垂直扩展和水平扩展。</p><p>垂直扩展意味着增加单个服务器的容量，例如使用更强大的CPU，添加更多RAM或增加存储空间量。可用技术的局限性可能会限制单个机器对于给定工作负载而言足够强大。此外，基于云的提供商基于可用的硬件配置具有硬性上限。结果，垂直缩放有实际的最大值。</p><p>水平扩展意味着划分系统数据集并加载多个服务器，添加其他服务器以根据需要增加容量。虽然单个机器的总体速度或容量可能不高，但每台机器处理整个工作负载的子集，可能提供比单个高速大容量服务器更高的效率。扩展部署容量只需要根据需要添加额外的服务器，这可能比单个机器的高端硬件的总体成本更低。权衡是基础架构和部署维护的复杂性增加。</p><p>MongoDB支持通过分片进行水平扩展。</p><h2 id="2-2-分片集群包含的组件"><a href="#2-2-分片集群包含的组件" class="headerlink" title="2.2 分片集群包含的组件"></a>2.2 分片集群包含的组件</h2><p>MongoDB分片群集包含以下组件：</p><ul><li>分片（存储）：每个分片包含分片数据的子集。 每个分片都可以部署为副本集。</li><li>mongos （路由）：mongos充当查询路由器，在客户端应用程序和分片集群之间提供接口。</li><li>config servers （“调度”的配置）：配置服务器存储群集的元数据和配置设置。 从MongoDB 3.4开始，必须将配置服务器部署为副本集（CSRS）。</li></ul><p>下图描述了分片集群中组件的交互：</p><p><img src="https://img-blog.csdnimg.cn/20200918165044703.png" alt="image-20200918110216367"></p><p>MongoDB在集合级别对数据进行分片，将集合数据分布在集群中的分片上。</p><h2 id="2-3-分片集群架构目标"><a href="#2-3-分片集群架构目标" class="headerlink" title="2.3 分片集群架构目标"></a>2.3 分片集群架构目标</h2><p>两个分片节点副本集（3+3）+一个配置节点副本集（3）+两个路由节点（2），共11个服务节点。</p><p><img src="https://img-blog.csdnimg.cn/20200918165105108.png" alt="image-20200918110313173"></p><h2 id="2-4-分片（存储）节点副本集的创建"><a href="#2-4-分片（存储）节点副本集的创建" class="headerlink" title="2.4 分片（存储）节点副本集的创建"></a>2.4 分片（存储）节点副本集的创建</h2><p>所有的的配置文件都直接放到 sharded_cluster 的相应的子目录下面，默认配置文件名字：mongod.conf</p><h3 id="2-4-1-第一套副本集"><a href="#2-4-1-第一套副本集" class="headerlink" title="2.4.1 第一套副本集"></a>2.4.1 第一套副本集</h3><p>准备存放数据和日志的目录：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#-----------myshardrs01</span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27018&#x2F;log \ &amp;</span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27018&#x2F;data&#x2F;db \ &amp;</span><br><span class="line"></span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27118&#x2F;log \ &amp;</span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27118&#x2F;data&#x2F;db \ &amp;</span><br><span class="line"></span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27218&#x2F;log \ &amp;</span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27218&#x2F;data&#x2F;db</span><br></pre></td></tr></table></figure><p>新建或修改配置文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27018&#x2F;mongod.conf</span><br></pre></td></tr></table></figure><p>myshardrs01_27018 ：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">    #MongoDB发送所有日志输出的目标指定为文件</span><br><span class="line">    destination: file</span><br><span class="line">    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span><br><span class="line">    path: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27018&#x2F;log&#x2F;mongod.log&quot;</span><br><span class="line">    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span><br><span class="line">    logAppend: true</span><br><span class="line">storage:</span><br><span class="line">    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span><br><span class="line">    dbPath: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27018&#x2F;data&#x2F;db&quot;</span><br><span class="line">    journal:</span><br><span class="line">        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">        enabled: true</span><br><span class="line">processManagement:</span><br><span class="line">    #启用在后台运行mongos或mongod进程的守护进程模式。</span><br><span class="line">    fork: true</span><br><span class="line">    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span><br><span class="line">    pidFilePath: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27018&#x2F;log&#x2F;mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line">    #服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span><br><span class="line">    #bindIpAll: true</span><br><span class="line">    #服务实例绑定的IP</span><br><span class="line">    bindIp: localhost,192.168.0.2</span><br><span class="line">    #bindIp</span><br><span class="line">    #绑定的端口</span><br><span class="line">    port: 27018</span><br><span class="line">replication:</span><br><span class="line">    #副本集的名称</span><br><span class="line">    replSetName: myshardrs01</span><br><span class="line">sharding:</span><br><span class="line">    #分片角色</span><br><span class="line">    clusterRole: shardsvr</span><br></pre></td></tr></table></figure><p>sharding.clusterRole：</p><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td>configsvr</td><td>Start this instance as a config server. The instance starts on port 27019 by default.</td></tr><tr><td>shardsvr</td><td>Start this instance as a shard . The instance starts on port 27018 by default.</td></tr></tbody></table><p>注意：</p><p>设置sharding.clusterRole需要mongod实例运行复制。 要将实例部署为副本集成员，请使用replSetName设置并指定副本集的名称。</p><p>新建或修改配置文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27118&#x2F;mongod.conf</span><br></pre></td></tr></table></figure><p>myshardrs01_27118 ：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">    #MongoDB发送所有日志输出的目标指定为文件</span><br><span class="line">    destination: file</span><br><span class="line">    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span><br><span class="line">    path: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27118&#x2F;log&#x2F;mongod.log&quot;</span><br><span class="line">    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span><br><span class="line">    logAppend: true</span><br><span class="line">storage:</span><br><span class="line">    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span><br><span class="line">    dbPath: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27118&#x2F;data&#x2F;db&quot;</span><br><span class="line">    journal:</span><br><span class="line">        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">        enabled: true</span><br><span class="line">processManagement:</span><br><span class="line">    #启用在后台运行mongos或mongod进程的守护进程模式。</span><br><span class="line">    fork: true</span><br><span class="line">    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span><br><span class="line">    pidFilePath: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27118&#x2F;log&#x2F;mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line">    #服务实例绑定所有IP</span><br><span class="line">    #bindIpAll: true</span><br><span class="line">    #服务实例绑定的IP</span><br><span class="line">    bindIp: localhost,192.168.0.2</span><br><span class="line">    #绑定的端口</span><br><span class="line">    port: 27118</span><br><span class="line">replication:</span><br><span class="line">    replSetName: myshardrs01</span><br><span class="line">sharding:</span><br><span class="line">    clusterRole: shardsvr</span><br></pre></td></tr></table></figure><p>新建或修改配置文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27218&#x2F;mongod.conf</span><br></pre></td></tr></table></figure><p>myshardrs01_27218 ：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">    #MongoDB发送所有日志输出的目标指定为文件</span><br><span class="line">    destination: file</span><br><span class="line">    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span><br><span class="line">    path: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27218&#x2F;log&#x2F;mongod.log&quot;</span><br><span class="line">    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span><br><span class="line">    logAppend: true</span><br><span class="line">storage:</span><br><span class="line">    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span><br><span class="line">    dbPath: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27218&#x2F;data&#x2F;db&quot;</span><br><span class="line">    journal:</span><br><span class="line">        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">        enabled: true</span><br><span class="line">processManagement:</span><br><span class="line">    #启用在后台运行mongos或mongod进程的守护进程模式。</span><br><span class="line">    fork: true</span><br><span class="line">    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span><br><span class="line">    pidFilePath: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27218&#x2F;log&#x2F;mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line">    #服务实例绑定的IP</span><br><span class="line">    bindIp: localhost,192.168.0.2</span><br><span class="line">    #绑定的端口</span><br><span class="line">    port: 27218</span><br><span class="line">replication:</span><br><span class="line">    replSetName: myshardrs01</span><br><span class="line">sharding:</span><br><span class="line">    clusterRole: shardsvr</span><br></pre></td></tr></table></figure><p>启动第一套副本集：一主一副本一仲裁</p><p>依次启动三个mongod服务：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost bin]# &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27018&#x2F;mongod.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 123223</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line"></span><br><span class="line">[root@bobohost bin]# &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27118&#x2F;mongod.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 123292</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line"></span><br><span class="line">[root@bobohost bin]# &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27218&#x2F;mongod.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 123326</span><br><span class="line">child process started successfully, parent exiting</span><br></pre></td></tr></table></figure><p>查看服务是否启动：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost bin]# ps -ef |grep mongod</span><br><span class="line">polkitd  61622  61604  0 7月31 ?    00:04:29 mongod --bind_ip_all</span><br><span class="line">root   123223    1  1 01:10 ?     00:00:01 &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27018&#x2F;mongod.conf</span><br><span class="line">root   123292    1  4 01:11 ?     00:00:00 &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27118&#x2F;mongod.conf</span><br><span class="line">root   123326    1  6 01:11 ?     00:00:00 &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27218&#x2F;mongod.conf</span><br></pre></td></tr></table></figure><h4 id="2-4-1-1-初始化副本集和创建主节点："><a href="#2-4-1-1-初始化副本集和创建主节点：" class="headerlink" title="2.4.1.1 初始化副本集和创建主节点："></a>2.4.1.1 初始化副本集和创建主节点：</h4><p>使用客户端命令连接任意一个节点，但这里尽量要连接主节点：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongo --host 180.76.159.126 --port 27018</span><br></pre></td></tr></table></figure><p>执行初始化副本集命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.initiate()</span><br></pre></td></tr></table></figure><p>查看副本集情况</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.status()</span><br></pre></td></tr></table></figure><p>主节点配置查看</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.conf()</span><br></pre></td></tr></table></figure><h4 id="2-4-1-2-添加副本节点"><a href="#2-4-1-2-添加副本节点" class="headerlink" title="2.4.1.2 添加副本节点"></a>2.4.1.2 添加副本节点</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.add(&quot;180.76.159.126:27118&quot;)</span><br></pre></td></tr></table></figure><h4 id="2-4-1-3-添加仲裁节点"><a href="#2-4-1-3-添加仲裁节点" class="headerlink" title="2.4.1.3 添加仲裁节点"></a>2.4.1.3 添加仲裁节点</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.addArb(&quot;180.76.159.126:27218&quot;)</span><br></pre></td></tr></table></figure><p>查看副本集的配置情况</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">myshardrs01:PRIMARY&gt; rs.conf()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;_id&quot; : &quot;myshardrs01&quot;,</span><br><span class="line">    &quot;version&quot; : 3,</span><br><span class="line">    &quot;protocolVersion&quot; : NumberLong(1),</span><br><span class="line">    &quot;writeConcernMajorityJournalDefault&quot; : true,</span><br><span class="line">    &quot;members&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_id&quot; : 0,</span><br><span class="line">            &quot;host&quot; : &quot;180.76.159.126:27018&quot;,</span><br><span class="line">            &quot;arbiterOnly&quot; : false,</span><br><span class="line">            &quot;buildIndexes&quot; : true,</span><br><span class="line">            &quot;hidden&quot; : false,</span><br><span class="line">            &quot;priority&quot; : 1,</span><br><span class="line">            &quot;tags&quot; : &#123;</span><br><span class="line">            </span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;slaveDelay&quot; : NumberLong(0),</span><br><span class="line">            &quot;votes&quot; : 1</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_id&quot; : 1,</span><br><span class="line">            &quot;host&quot; : &quot;180.76.159.126:27118&quot;,</span><br><span class="line">            &quot;arbiterOnly&quot; : false,</span><br><span class="line">            &quot;buildIndexes&quot; : true,</span><br><span class="line">            &quot;hidden&quot; : false,</span><br><span class="line">            &quot;priority&quot; : 1,</span><br><span class="line">            &quot;tags&quot; : &#123;</span><br><span class="line">            </span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;slaveDelay&quot; : NumberLong(0),</span><br><span class="line">            &quot;votes&quot; : 1</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_id&quot; : 2,</span><br><span class="line">            &quot;host&quot; : &quot;180.76.159.126:27218&quot;,</span><br><span class="line">            &quot;arbiterOnly&quot; : true,</span><br><span class="line">            &quot;buildIndexes&quot; : true,</span><br><span class="line">            &quot;hidden&quot; : false,</span><br><span class="line">            &quot;priority&quot; : 0,</span><br><span class="line">            &quot;tags&quot; : &#123;</span><br><span class="line">            </span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;slaveDelay&quot; : NumberLong(0),</span><br><span class="line">            &quot;votes&quot; : 1</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br></pre></td></tr></table></figure><h3 id="2-4-2-第二套副本集"><a href="#2-4-2-第二套副本集" class="headerlink" title="2.4.2 第二套副本集"></a>2.4.2 第二套副本集</h3><p>准备存放数据和日志的目录：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#-----------myshardrs02</span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27318&#x2F;log \ &amp;</span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27318&#x2F;data&#x2F;db \ &amp;</span><br><span class="line"></span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27418&#x2F;log \ &amp;</span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27418&#x2F;data&#x2F;db \ &amp;</span><br><span class="line"></span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27518&#x2F;log \ &amp;</span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27518&#x2F;data&#x2F;db</span><br></pre></td></tr></table></figure><p>新建或修改配置文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27318&#x2F;mongod.conf</span><br></pre></td></tr></table></figure><p>myshardrs02_27318 ：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">    #MongoDB发送所有日志输出的目标指定为文件</span><br><span class="line">    destination: file</span><br><span class="line">    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span><br><span class="line">    path: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27318&#x2F;log&#x2F;mongod.log&quot;</span><br><span class="line">    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span><br><span class="line">    logAppend: true</span><br><span class="line">storage:</span><br><span class="line">    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span><br><span class="line">    dbPath: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27318&#x2F;data&#x2F;db&quot;</span><br><span class="line">    journal:</span><br><span class="line">        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">        enabled: true</span><br><span class="line">processManagement:</span><br><span class="line">    #启用在后台运行mongos或mongod进程的守护进程模式。</span><br><span class="line">    fork: true</span><br><span class="line">    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span><br><span class="line">    pidFilePath: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27318&#x2F;log&#x2F;mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line">    #服务实例绑定的IP</span><br><span class="line">    bindIp: localhost,192.168.0.2</span><br><span class="line">    #绑定的端口</span><br><span class="line">    port: 27318</span><br><span class="line">replication:</span><br><span class="line">    replSetName: myshardrs02</span><br><span class="line">sharding:</span><br><span class="line">    clusterRole: shardsvr</span><br></pre></td></tr></table></figure><p>新建或修改配置文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27418&#x2F;mongod.conf</span><br></pre></td></tr></table></figure><p>myshardrs02_27418 ：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">    #MongoDB发送所有日志输出的目标指定为文件</span><br><span class="line">    destination: file</span><br><span class="line">    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span><br><span class="line">    path: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27418&#x2F;log&#x2F;mongod.log&quot;</span><br><span class="line">    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span><br><span class="line">    logAppend: true</span><br><span class="line">storage:</span><br><span class="line">    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span><br><span class="line">    dbPath: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27418&#x2F;data&#x2F;db&quot;</span><br><span class="line">    journal:</span><br><span class="line">        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">        enabled: true</span><br><span class="line">processManagement:</span><br><span class="line">    #启用在后台运行mongos或mongod进程的守护进程模式。</span><br><span class="line">    fork: true</span><br><span class="line">    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span><br><span class="line">    pidFilePath: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27418&#x2F;log&#x2F;mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line">    #服务实例绑定所有IP</span><br><span class="line">    #bindIpAll: true</span><br><span class="line">    #服务实例绑定的IP</span><br><span class="line">    bindIp: localhost,192.168.0.2</span><br><span class="line">    #绑定的端口</span><br><span class="line">    port: 27418</span><br><span class="line">replication:</span><br><span class="line">    replSetName: myshardrs02</span><br><span class="line">sharding:</span><br><span class="line">    clusterRole: shardsvr</span><br></pre></td></tr></table></figure><p>新建或修改配置文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27518&#x2F;mongod.conf</span><br></pre></td></tr></table></figure><p>myshardrs02_27518 ：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">    #MongoDB发送所有日志输出的目标指定为文件</span><br><span class="line">    destination: file</span><br><span class="line">    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span><br><span class="line">    path: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27518&#x2F;log&#x2F;mongod.log&quot;</span><br><span class="line">    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span><br><span class="line">    logAppend: true</span><br><span class="line">storage:</span><br><span class="line">    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span><br><span class="line">    dbPath: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27518&#x2F;data&#x2F;db&quot;</span><br><span class="line">    journal:</span><br><span class="line">        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">        enabled: true</span><br><span class="line">processManagement:</span><br><span class="line">    #启用在后台运行mongos或mongod进程的守护进程模式。</span><br><span class="line">    fork: true</span><br><span class="line">    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span><br><span class="line">    pidFilePath: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27518&#x2F;log&#x2F;mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line">    #服务实例绑定所有IP</span><br><span class="line">    #bindIpAll: true</span><br><span class="line">    #服务实例绑定的IP</span><br><span class="line">    bindIp: localhost,192.168.0.2</span><br><span class="line">    #绑定的端口</span><br><span class="line">    port: 27518</span><br><span class="line">replication:</span><br><span class="line">    replSetName: myshardrs02</span><br><span class="line">sharding:</span><br><span class="line">    clusterRole: shardsvr</span><br></pre></td></tr></table></figure><p>启动第二套副本集：一主一副本一仲裁</p><p>依次启动三个mongod服务：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost bin]# &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27318&#x2F;mongod.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 123223</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line"></span><br><span class="line">[root@bobohost bin]# &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27418&#x2F;mongod.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 123292</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line"></span><br><span class="line">[root@bobohost bin]# &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27518&#x2F;mongod.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 123326</span><br><span class="line">child process started successfully, parent exiting</span><br></pre></td></tr></table></figure><p>查看服务是否启动：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost bin]# ps -ef |grep mongod</span><br></pre></td></tr></table></figure><h4 id="2-4-2-1-初始化副本集和创建主节点"><a href="#2-4-2-1-初始化副本集和创建主节点" class="headerlink" title="2.4.2.1 初始化副本集和创建主节点"></a>2.4.2.1 初始化副本集和创建主节点</h4><p>使用客户端命令连接任意一个节点，但这里尽量要连接主节点：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongo --host 180.76.159.126 --port 27318</span><br></pre></td></tr></table></figure><p>执行初始化副本集命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.initiate()</span><br></pre></td></tr></table></figure><p>查看副本集情况 (节选内容)：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.status()</span><br></pre></td></tr></table></figure><p>主节点配置查看：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.conf()</span><br></pre></td></tr></table></figure><h4 id="2-4-2-2-添加副本节点"><a href="#2-4-2-2-添加副本节点" class="headerlink" title="2.4.2.2 添加副本节点"></a>2.4.2.2 添加副本节点</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.add(&quot;180.76.159.126:27418&quot;)</span><br></pre></td></tr></table></figure><h4 id="2-4-2-3-添加仲裁节点"><a href="#2-4-2-3-添加仲裁节点" class="headerlink" title="2.4.2.3 添加仲裁节点"></a>2.4.2.3 添加仲裁节点</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.addArb(&quot;180.76.159.126:27518&quot;)</span><br></pre></td></tr></table></figure><p>查看副本集的配置情况</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">myshardrs02:PRIMARY&gt; rs.status()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;set&quot; : &quot;myshardrs02&quot;,</span><br><span class="line">    &quot;date&quot; : ISODate(&quot;2019-07-31T21:38:22.463Z&quot;),</span><br><span class="line">    &quot;myState&quot; : 1,</span><br><span class="line">    &quot;term&quot; : NumberLong(1),</span><br><span class="line">    &quot;syncingTo&quot; : &quot;&quot;,</span><br><span class="line">    &quot;syncSourceHost&quot; : &quot;&quot;,</span><br><span class="line">    &quot;syncSourceId&quot; : -1,</span><br><span class="line">    &quot;heartbeatIntervalMillis&quot; : NumberLong(2000),</span><br><span class="line">    &quot;optimes&quot; : &#123;</span><br><span class="line">        &quot;lastCommittedOpTime&quot; : &#123;</span><br><span class="line">            &quot;ts&quot; : Timestamp(1564609094, 1),</span><br><span class="line">            &quot;t&quot; : NumberLong(1)</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;readConcernMajorityOpTime&quot; : &#123;</span><br><span class="line">            &quot;ts&quot; : Timestamp(1564609094, 1),</span><br><span class="line">            &quot;t&quot; : NumberLong(1)</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;appliedOpTime&quot; : &#123;</span><br><span class="line">            &quot;ts&quot; : Timestamp(1564609094, 1),</span><br><span class="line">            &quot;t&quot; : NumberLong(1)</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;durableOpTime&quot; : &#123;</span><br><span class="line">            &quot;ts&quot; : Timestamp(1564609094, 1),</span><br><span class="line">            &quot;t&quot; : NumberLong(1)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;lastStableCheckpointTimestamp&quot; : Timestamp(1564609074, 1),</span><br><span class="line">    &quot;members&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_id&quot; : 0,</span><br><span class="line">            &quot;name&quot; : &quot;180.76.159.126:27318&quot;,</span><br><span class="line">            &quot;health&quot; : 1,</span><br><span class="line">            &quot;state&quot; : 1,</span><br><span class="line">            &quot;stateStr&quot; : &quot;PRIMARY&quot;,</span><br><span class="line">            &quot;uptime&quot; : 5086,</span><br><span class="line">            &quot;optime&quot; : &#123;</span><br><span class="line">                &quot;ts&quot; : Timestamp(1564609094, 1),</span><br><span class="line">                &quot;t&quot; : NumberLong(1)</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;optimeDate&quot; : ISODate(&quot;2019-07-31T21:38:14Z&quot;),</span><br><span class="line">            &quot;syncingTo&quot; : &quot;&quot;,</span><br><span class="line">            &quot;syncSourceHost&quot; : &quot;&quot;,</span><br><span class="line">            &quot;syncSourceId&quot; : -1,</span><br><span class="line">            &quot;infoMessage&quot; : &quot;&quot;,</span><br><span class="line">            &quot;electionTime&quot; : Timestamp(1564604032, 2),</span><br><span class="line">            &quot;electionDate&quot; : ISODate(&quot;2019-07-31T20:13:52Z&quot;),</span><br><span class="line">            &quot;configVersion&quot; : 3,</span><br><span class="line">            &quot;self&quot; : true,</span><br><span class="line">            &quot;lastHeartbeatMessage&quot; : &quot;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_id&quot; : 1,</span><br><span class="line">            &quot;name&quot; : &quot;180.76.159.126:27418&quot;,</span><br><span class="line">            &quot;health&quot; : 1,</span><br><span class="line">            &quot;state&quot; : 2,</span><br><span class="line">            &quot;stateStr&quot; : &quot;SECONDARY&quot;,</span><br><span class="line">            &quot;uptime&quot; : 4452,</span><br><span class="line">            &quot;optime&quot; : &#123;</span><br><span class="line">                &quot;ts&quot; : Timestamp(1564609094, 1),</span><br><span class="line">                &quot;t&quot; : NumberLong(1)</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;optimeDurable&quot; : &#123;</span><br><span class="line">                &quot;ts&quot; : Timestamp(1564609094, 1),</span><br><span class="line">                &quot;t&quot; : NumberLong(1)</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;optimeDate&quot; : ISODate(&quot;2019-07-31T21:38:14Z&quot;),</span><br><span class="line">            &quot;optimeDurableDate&quot; : ISODate(&quot;2019-07-31T21:38:14Z&quot;),</span><br><span class="line">            &quot;lastHeartbeat&quot; : ISODate(&quot;2019-07-31T21:38:21.178Z&quot;),</span><br><span class="line">            &quot;lastHeartbeatRecv&quot; : ISODate(&quot;2019-07-31T21:38:20.483Z&quot;),</span><br><span class="line">            &quot;pingMs&quot; : NumberLong(0),</span><br><span class="line">            &quot;lastHeartbeatMessage&quot; : &quot;&quot;,</span><br><span class="line">            &quot;syncingTo&quot; : &quot;180.76.159.126:27518&quot;,</span><br><span class="line">            &quot;syncSourceHost&quot; : &quot;180.76.159.126:27518&quot;,</span><br><span class="line">            &quot;syncSourceId&quot; : 2,</span><br><span class="line">            &quot;infoMessage&quot; : &quot;&quot;,</span><br><span class="line">            &quot;configVersion&quot; : 3</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_id&quot; : 2,</span><br><span class="line">            &quot;name&quot; : &quot;180.76.159.126:27518&quot;,</span><br><span class="line">            &quot;health&quot; : 1,</span><br><span class="line">            &quot;state&quot; : 2,</span><br><span class="line">            &quot;stateStr&quot; : &quot;SECONDARY&quot;,</span><br><span class="line">            &quot;uptime&quot; : 4448,</span><br><span class="line">            &quot;optime&quot; : &#123;</span><br><span class="line">                &quot;ts&quot; : Timestamp(1564609094, 1),</span><br><span class="line">                &quot;t&quot; : NumberLong(1)</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;optimeDurable&quot; : &#123;</span><br><span class="line">                &quot;ts&quot; : Timestamp(1564609094, 1),</span><br><span class="line">                &quot;t&quot; : NumberLong(1)</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;optimeDate&quot; : ISODate(&quot;2019-07-31T21:38:14Z&quot;),</span><br><span class="line">            &quot;optimeDurableDate&quot; : ISODate(&quot;2019-07-31T21:38:14Z&quot;),</span><br><span class="line">            &quot;lastHeartbeat&quot; : ISODate(&quot;2019-07-31T21:38:21.178Z&quot;),</span><br><span class="line">            &quot;lastHeartbeatRecv&quot; : ISODate(&quot;2019-07-31T21:38:22.096Z&quot;),</span><br><span class="line">            &quot;pingMs&quot; : NumberLong(0),</span><br><span class="line">            &quot;lastHeartbeatMessage&quot; : &quot;&quot;,</span><br><span class="line">            &quot;syncingTo&quot; : &quot;180.76.159.126:27318&quot;,</span><br><span class="line">            &quot;syncSourceHost&quot; : &quot;180.76.159.126:27318&quot;,</span><br><span class="line">            &quot;syncSourceId&quot; : 0,</span><br><span class="line">            &quot;infoMessage&quot; : &quot;&quot;,</span><br><span class="line">            &quot;configVersion&quot; : 3</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br></pre></td></tr></table></figure><h2 id="2-5-配置节点副本集的创建"><a href="#2-5-配置节点副本集的创建" class="headerlink" title="2.5 配置节点副本集的创建"></a>2.5 配置节点副本集的创建</h2><p>第一步：准备存放数据和日志的目录：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#-----------configrs</span><br><span class="line">#建立数据节点data和日志目录</span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27019&#x2F;log \ &amp;</span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27019&#x2F;data&#x2F;db \ &amp;</span><br><span class="line"></span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27119&#x2F;log \ &amp;</span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27119&#x2F;data&#x2F;db \ &amp;</span><br><span class="line"></span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27219&#x2F;log \ &amp;</span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27219&#x2F;data&#x2F;db</span><br></pre></td></tr></table></figure><p>新建或修改配置文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27019&#x2F;mongod.conf</span><br></pre></td></tr></table></figure><p>myconfigrs_27019 ：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">    #MongoDB发送所有日志输出的目标指定为文件</span><br><span class="line">    destination: file</span><br><span class="line">    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span><br><span class="line">    path: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27019&#x2F;log&#x2F;mongod.log&quot;</span><br><span class="line">    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span><br><span class="line">    logAppend: true</span><br><span class="line">storage:</span><br><span class="line">    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span><br><span class="line">    dbPath: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27019&#x2F;data&#x2F;db&quot;</span><br><span class="line">    journal:</span><br><span class="line">        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">        enabled: true</span><br><span class="line">processManagement:</span><br><span class="line">    #启用在后台运行mongos或mongod进程的守护进程模式。</span><br><span class="line">    fork: true</span><br><span class="line">    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span><br><span class="line">    pidFilePath: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27019&#x2F;log&#x2F;mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line">    #服务实例绑定所有IP</span><br><span class="line">    #bindIpAll: true</span><br><span class="line">    #服务实例绑定的IP</span><br><span class="line">    bindIp: localhost,192.168.0.2</span><br><span class="line">    #绑定的端口</span><br><span class="line">    port: 27019</span><br><span class="line">replication:</span><br><span class="line">    replSetName: myconfigrs</span><br><span class="line">sharding:</span><br><span class="line">    clusterRole: configsvr</span><br></pre></td></tr></table></figure><p>新建或修改配置文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27119&#x2F;mongod.conf</span><br></pre></td></tr></table></figure><p>myconfigrs_27119</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">    #MongoDB发送所有日志输出的目标指定为文件</span><br><span class="line">    destination: file</span><br><span class="line">    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span><br><span class="line">    path: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27119&#x2F;log&#x2F;mongod.log&quot;</span><br><span class="line">    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span><br><span class="line">    logAppend: true</span><br><span class="line">storage:</span><br><span class="line">    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span><br><span class="line">    dbPath: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27119&#x2F;data&#x2F;db&quot;</span><br><span class="line">    journal:</span><br><span class="line">        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">        enabled: true</span><br><span class="line">processManagement:</span><br><span class="line">    #启用在后台运行mongos或mongod进程的守护进程模式。</span><br><span class="line">    fork: true</span><br><span class="line">    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span><br><span class="line">    pidFilePath: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27119&#x2F;log&#x2F;mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line">    #服务实例绑定所有IP</span><br><span class="line">    #bindIpAll: true</span><br><span class="line">    #服务实例绑定的IP</span><br><span class="line">    bindIp: localhost,192.168.0.2</span><br><span class="line">    #绑定的端口</span><br><span class="line">    port: 27119</span><br><span class="line">replication:</span><br><span class="line">    replSetName: myconfigrs</span><br><span class="line">sharding:</span><br><span class="line">    clusterRole: configsvr</span><br></pre></td></tr></table></figure><p>新建或修改配置文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27219&#x2F;mongod.conf</span><br></pre></td></tr></table></figure><p>myconfigrs_27219</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">    #MongoDB发送所有日志输出的目标指定为文件</span><br><span class="line">    destination: file</span><br><span class="line">    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span><br><span class="line">    path: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27219&#x2F;log&#x2F;mongod.log&quot;</span><br><span class="line">    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span><br><span class="line">    logAppend: true</span><br><span class="line">storage:</span><br><span class="line">    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span><br><span class="line">    dbPath: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27219&#x2F;data&#x2F;db&quot;</span><br><span class="line">    journal:</span><br><span class="line">        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">        enabled: true</span><br><span class="line">processManagement:</span><br><span class="line">    #启用在后台运行mongos或mongod进程的守护进程模式。</span><br><span class="line">    fork: true</span><br><span class="line">    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span><br><span class="line">    pidFilePath: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27219&#x2F;log&#x2F;mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line">    #服务实例绑定所有IP</span><br><span class="line">    #bindIpAll: true</span><br><span class="line">    #服务实例绑定的IP</span><br><span class="line">    bindIp: localhost,192.168.0.2</span><br><span class="line">    #绑定的端口</span><br><span class="line">    port: 27219</span><br><span class="line">replication:</span><br><span class="line">    replSetName: myconfigrs</span><br><span class="line">sharding:</span><br><span class="line">    clusterRole: configsvr</span><br></pre></td></tr></table></figure><p>启动配置副本集：一主两副本</p><p>依次启动三个mongod服务：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost bin]# &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27019&#x2F;mongod.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 123223</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line"></span><br><span class="line">[root@bobohost bin]# &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27119&#x2F;mongod.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 123292</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line"></span><br><span class="line">[root@bobohost bin]# &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27219&#x2F;mongod.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 123326</span><br><span class="line">child process started successfully, parent exiting</span><br></pre></td></tr></table></figure><p>查看服务是否启动：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost bin]# ps -ef |grep mongod</span><br></pre></td></tr></table></figure><h3 id="2-5-1-初始化副本集和创建主节点"><a href="#2-5-1-初始化副本集和创建主节点" class="headerlink" title="2.5.1 初始化副本集和创建主节点"></a>2.5.1 初始化副本集和创建主节点</h3><p>使用客户端命令连接任意一个节点，但这里尽量要连接主节点：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongo --host 180.76.159.126 --port 27019</span><br></pre></td></tr></table></figure><p>执行初始化副本集命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.initiate()</span><br></pre></td></tr></table></figure><p>查看副本集情况 (节选内容)：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.status()</span><br></pre></td></tr></table></figure><p>主节点配置查看：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.conf()</span><br></pre></td></tr></table></figure><h3 id="2-5-2-添加两个副本节点"><a href="#2-5-2-添加两个副本节点" class="headerlink" title="2.5.2 添加两个副本节点"></a>2.5.2 添加两个副本节点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">myshardrs01:PRIMARY&gt; rs.add(&quot;180.76.159.126:27119&quot;)</span><br><span class="line">myshardrs01:PRIMARY&gt; rs.add(&quot;180.76.159.126:27219&quot;)</span><br></pre></td></tr></table></figure><p>查看副本集的配置情况：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">myshardrs01:PRIMARY&gt; rs.conf()</span><br><span class="line">myshardrs01:PRIMARY&gt; rs.status()</span><br></pre></td></tr></table></figure><h2 id="2-6-路由节点的创建和操作"><a href="#2-6-路由节点的创建和操作" class="headerlink" title="2.6 路由节点的创建和操作"></a>2.6 路由节点的创建和操作</h2><h3 id="2-6-1-第一个路由节点的创建和连接"><a href="#2-6-1-第一个路由节点的创建和连接" class="headerlink" title="2.6.1 第一个路由节点的创建和连接"></a>2.6.1 第一个路由节点的创建和连接</h3><p>第一步：准备存放数据和日志的目录：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#-----------mongos01</span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27017&#x2F;log</span><br></pre></td></tr></table></figure><p>mymongos_27017节点：</p><p>新建或修改配置文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27017&#x2F;mongos.conf</span><br></pre></td></tr></table></figure><p>mongos.conf：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">    #MongoDB发送所有日志输出的目标指定为文件</span><br><span class="line">    destination: file</span><br><span class="line">    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span><br><span class="line">    path: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27017&#x2F;log&#x2F;mongod.log&quot;</span><br><span class="line">    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span><br><span class="line">    logAppend: true</span><br><span class="line">processManagement:</span><br><span class="line">    #启用在后台运行mongos或mongod进程的守护进程模式。</span><br><span class="line">    fork: true</span><br><span class="line">    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span><br><span class="line">    pidFilePath: &#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27017&#x2F;log&#x2F;mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line">    #服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span><br><span class="line">    #bindIpAll: true</span><br><span class="line">    #服务实例绑定的IP</span><br><span class="line">    bindIp: localhost,192.168.0.2</span><br><span class="line">    #bindIp</span><br><span class="line">    #绑定的端口</span><br><span class="line">    port: 27017</span><br><span class="line">sharding:</span><br><span class="line">    #指定配置节点副本集</span><br><span class="line">    configDB: myconfigrs&#x2F;180.76.159.126:27019,180.76.159.126:27119,180.76.159.126:27219</span><br></pre></td></tr></table></figure><p>启动mongos：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost bin]# &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongos -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27017&#x2F;mongos.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 129874</span><br><span class="line">child process started successfully, parent exiting</span><br></pre></td></tr></table></figure><p>提示：启动如果失败，可以查看 log目录下的日志，查看失败原因。</p><p>客户端登录mongos</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongo --host 180.76.159.126 --port 27017</span><br></pre></td></tr></table></figure><p>此时，写不进去数据，如果写数据会报错：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; use aadb</span><br><span class="line">switched to db aadb</span><br><span class="line">mongos&gt; db.aa.insert(&#123;aa:&quot;aa&quot;&#125;)</span><br><span class="line">WriteCommandError(&#123;</span><br><span class="line">    &quot;ok&quot; : 0,</span><br><span class="line">    &quot;errmsg&quot; : &quot;unable to initialize targeter for write op for collection aa.aa :: caused by :: Database aa not found :: caused by :: No shards found&quot;,</span><br><span class="line">    &quot;code&quot; : 70,</span><br><span class="line">    &quot;codeName&quot; : &quot;ShardNotFound&quot;,</span><br><span class="line">    &quot;operationTime&quot; : Timestamp(1564600123, 2),</span><br><span class="line">    &quot;$clusterTime&quot; : &#123;</span><br><span class="line">    &quot;clusterTime&quot; : Timestamp(1564600123, 2),</span><br><span class="line">        &quot;signature&quot; : &#123;</span><br><span class="line">            &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA&#x3D;&quot;),</span><br><span class="line">            &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>原因：通过路由节点操作，现在只是连接了配置节点，还没有连接分片数据节点，因此无法写入业务数据。</p><h3 id="2-6-2-在路由节点上进行分片配置操作"><a href="#2-6-2-在路由节点上进行分片配置操作" class="headerlink" title="2.6.2 在路由节点上进行分片配置操作"></a>2.6.2 在路由节点上进行分片配置操作</h3><p>使用命令添加分片：</p><h4 id="2-6-2-1-添加分片："><a href="#2-6-2-1-添加分片：" class="headerlink" title="2.6.2.1 添加分片："></a>2.6.2.1 添加分片：</h4><p>语法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh.addShard(&quot;IP:Port&quot;)</span><br></pre></td></tr></table></figure><p>将第一套分片副本集添加进来：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt;sh.addShard(&quot;myshardrs01&#x2F;192.168.0.2:27018,180.76.159.126:27118,180.76.159.126:27218&quot;)</span><br><span class="line">&#123;</span><br><span class="line">    &quot;shardAdded&quot; : &quot;myshardrs01&quot;,</span><br><span class="line">    &quot;ok&quot; : 1,</span><br><span class="line">    &quot;operationTime&quot; : Timestamp(1564611970, 4),</span><br><span class="line">    &quot;$clusterTime&quot; : &#123;</span><br><span class="line">    &quot;clusterTime&quot; : Timestamp(1564611970, 4),</span><br><span class="line">        &quot;signature&quot; : &#123;</span><br><span class="line">            &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA&#x3D;&quot;),</span><br><span class="line">            &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>查看分片状态情况：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.status()</span><br><span class="line">--- Sharding Status ---</span><br><span class="line">    sharding version: &#123;</span><br><span class="line">        &quot;_id&quot; : 1,</span><br><span class="line">        &quot;minCompatibleVersion&quot; : 5,</span><br><span class="line">        &quot;currentVersion&quot; : 6,</span><br><span class="line">        &quot;clusterId&quot; : ObjectId(&quot;5d4211b798f3f9a48522c68b&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">    shards:</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;myshardrs01&quot;,  &quot;host&quot; : &quot;myshardrs01&#x2F;180.76.159.126:27018,180.76.159.126:27118&quot;,  &quot;state&quot; : 1 &#125;</span><br><span class="line">    active mongoses:</span><br><span class="line">    &quot;4.0.10&quot; : 1</span><br><span class="line">    autosplit:</span><br><span class="line">    Currently enabled: yes</span><br><span class="line">    balancer:</span><br><span class="line">        Currently enabled:  yes</span><br><span class="line">        Currently running:  no</span><br><span class="line">        Failed balancer rounds in last 5 attempts:  0</span><br><span class="line">        Migration Results for the last 24 hours:</span><br><span class="line">        No recent migrations</span><br><span class="line">    databases:</span><br><span class="line">    &#123;  &quot;_id&quot; : &quot;config&quot;,  &quot;primary&quot; : &quot;config&quot;,  &quot;partitioned&quot; : true &#125;</span><br></pre></td></tr></table></figure><p>继续将第二套分片副本集添加进来：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt;sh.addShard(&quot;myshardrs02&#x2F;192.168.0.2:27318,180.76.159.126:27418,180.76.159.126:27518&quot;)</span><br><span class="line">&#123;</span><br><span class="line">    &quot;shardAdded&quot; : &quot;myshardrs02&quot;,</span><br><span class="line">    &quot;ok&quot; : 1,</span><br><span class="line">    &quot;operationTime&quot; : Timestamp(1564612147, 5),</span><br><span class="line">    &quot;$clusterTime&quot; : &#123;</span><br><span class="line">    &quot;clusterTime&quot; : Timestamp(1564612147, 5),</span><br><span class="line">        &quot;signature&quot; : &#123;</span><br><span class="line">            &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA&#x3D;&quot;),</span><br><span class="line">            &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>查看分片状态：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.status()</span><br><span class="line">--- Sharding Status ---</span><br><span class="line">    sharding version: &#123;</span><br><span class="line">        &quot;_id&quot; : 1,</span><br><span class="line">        &quot;minCompatibleVersion&quot; : 5,</span><br><span class="line">        &quot;currentVersion&quot; : 6,</span><br><span class="line">        &quot;clusterId&quot; : ObjectId(&quot;5d4211b798f3f9a48522c68b&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">    shards:</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;myshardrs01&quot;,  &quot;host&quot; : &quot;myshardrs01&#x2F;180.76.159.126:27018,180.76.159.126:27118&quot;,  &quot;state&quot; : 1 &#125;</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;myshardrs02&quot;,  &quot;host&quot; : &quot;myshardrs02&#x2F;180.76.159.126:27318,180.76.159.126:27418&quot;,  &quot;state&quot; : 1 &#125;</span><br><span class="line">    active mongoses:</span><br><span class="line">    &quot;4.0.10&quot; : 1</span><br><span class="line">    autosplit:</span><br><span class="line">    Currently enabled: yes</span><br><span class="line">    balancer:</span><br><span class="line">        Currently enabled:  yes</span><br><span class="line">        Currently running:  no</span><br><span class="line">        Failed balancer rounds in last 5 attempts:  0</span><br><span class="line">        Migration Results for the last 24 hours:</span><br><span class="line">        No recent migrations</span><br><span class="line">    databases:</span><br><span class="line">    &#123;  &quot;_id&quot; : &quot;config&quot;,  &quot;primary&quot; : &quot;config&quot;,  &quot;partitioned&quot; : true &#125;</span><br></pre></td></tr></table></figure><p>提示：如果添加分片失败，需要先手动移除分片，检查添加分片的信息的正确性后，再次添加分片。</p><p>移除分片参考(了解)：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use admin</span><br><span class="line">db.runCommand( &#123; removeShard: &quot;myshardrs02&quot; &#125; )</span><br></pre></td></tr></table></figure><p>注意：如果只剩下最后一个 shard，是无法删除的</p><p>移除时会自动转移分片数据，需要一个时间过程。</p><p>完成后，再次执行删除分片命令才能真正删除。</p><h4 id="2-6-2-2-开启分片功能"><a href="#2-6-2-2-开启分片功能" class="headerlink" title="2.6.2.2 开启分片功能"></a>2.6.2.2 开启分片功能</h4><p>sh.enableSharding(“库名”)、sh.shardCollection(“库名.集合名”,{“key”:1})</p><p>在mongos上的articledb数据库配置sharding:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.enableSharding(&quot;articledb&quot;)</span><br><span class="line">&#123;</span><br><span class="line">    &quot;ok&quot; : 1,</span><br><span class="line">    &quot;operationTime&quot; : Timestamp(1564612296, 5),</span><br><span class="line">    &quot;$clusterTime&quot; : &#123;</span><br><span class="line">        &quot;clusterTime&quot; : Timestamp(1564612296, 5),</span><br><span class="line">        &quot;signature&quot; : &#123;</span><br><span class="line">            &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA&#x3D;&quot;),</span><br><span class="line">            &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>查看分片状态：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.status()</span><br><span class="line">--- Sharding Status ---</span><br><span class="line">    sharding version: &#123;</span><br><span class="line">        &quot;_id&quot; : 1,</span><br><span class="line">        &quot;minCompatibleVersion&quot; : 5,</span><br><span class="line">        &quot;currentVersion&quot; : 6,</span><br><span class="line">        &quot;clusterId&quot; : ObjectId(&quot;5d4211b798f3f9a48522c68b&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">    shards:</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;myshardrs01&quot;,  &quot;host&quot; : &quot;myshardrs01&#x2F;180.76.159.126:27018,180.76.159.126:27118&quot;,  &quot;state&quot; : 1 &#125;</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;myshardrs02&quot;,  &quot;host&quot; : &quot;myshardrs02&#x2F;180.76.159.126:27318,180.76.159.126:27418&quot;,  &quot;state&quot; : 1 &#125;</span><br><span class="line">    active mongoses:</span><br><span class="line">    &quot;4.0.10&quot; : 1</span><br><span class="line">    autosplit:</span><br><span class="line">    Currently enabled: yes</span><br><span class="line">    balancer:</span><br><span class="line">        Currently enabled:  yes</span><br><span class="line">        Currently running:  no</span><br><span class="line">        Failed balancer rounds in last 5 attempts:  0</span><br><span class="line">        Migration Results for the last 24 hours:</span><br><span class="line">        No recent migrations</span><br><span class="line">    databases:</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;articledb&quot;,  &quot;primary&quot; : &quot;myshardrs02&quot;,  &quot;partitioned&quot; : true, &quot;version&quot; : &#123;  &quot;uuid&quot; : UUID(&quot;788c9a3b-bb6a-4cc2-a597-974694772986&quot;), &quot;lastMod&quot; : 1 &#125; &#125;</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;config&quot;,  &quot;primary&quot; : &quot;config&quot;,  &quot;partitioned&quot; : true &#125;</span><br><span class="line">            config.system.sessions</span><br><span class="line">                shard key: &#123; &quot;_id&quot; : 1 &#125;</span><br><span class="line">                unique: false</span><br><span class="line">                balancing: true</span><br><span class="line">                chunks:</span><br><span class="line">            myshardrs01   1</span><br><span class="line">            &#123; &quot;_id&quot; : &#123; &quot;$minKey&quot; : 1 &#125; &#125; --&gt;&gt; &#123; &quot;_id&quot; : &#123; &quot;$maxKey&quot; : 1 &#125; &#125; on : myshardrs01 Timestamp(1, 0)</span><br></pre></td></tr></table></figure><h4 id="2-6-2-3-集合分片"><a href="#2-6-2-3-集合分片" class="headerlink" title="2.6.2.3 集合分片"></a>2.6.2.3 集合分片</h4><p>对集合分片，你必须使用 sh.shardCollection() 方法指定集合和分片键</p><p>语法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh.shardCollection(namespace, key, unique)</span><br></pre></td></tr></table></figure><p>参数：</p><table><thead><tr><th>Parameter</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>namespace</td><td>string</td><td>要（分片）共享的目标集合的命名空间，格式： .</td></tr><tr><td>key</td><td>document</td><td>用作分片键的索引规范文档。shard键决定MongoDB如何在shard之间分发文档。除非集合为空，否则索引必须在shardcollection命令之前存在。如果集合为空，则MongoDB在对集合进行分片之前创建索引，前提是支持分片键的索引不存在。简单的说：由包含字段和该字段的索引遍历方向的文档组成。</td></tr><tr><td>unique</td><td>boolean</td><td>当值为true情况下，片键字段上会限制为确保是唯一索引。哈希策略片键不支持唯一索引。默认是false。</td></tr></tbody></table><p>对集合进行分片时,你需要选择一个 片键（Shard Key） , shard key 是每条记录都必须包含的,且建立了索引的单个字段或复合字段,MongoDB按照片键将数据划分到不同的 数据块 中,并将 数据块 均衡地分布到所有分片中.为了按照片键划分数据块,MongoDB使用 基于哈希的分片方式（随机平均分配）或者基于范围的分片方式（数值大小分配） 。</p><p>用什么字段当片键都可以，如：nickname作为片键，但一定是必填字段。</p><p><strong>分片规则一：哈希策略</strong></p><p>对于 基于哈希的分片 ,MongoDB计算一个字段的哈希值,并用这个哈希值来创建数据块.</p><p>在使用基于哈希分片的系统中,拥有”相近”片键的文档 很可能不会 存储在同一个数据块中,因此数据的分离性更好一些.</p><p>使用nickname作为片键，根据其值的哈希值进行数据分片</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.shardCollection(&quot;articledb.comment&quot;,&#123;&quot;nickname&quot;:&quot;hashed&quot;&#125;)</span><br><span class="line">&#123;</span><br><span class="line">    &quot;collectionsharded&quot; : &quot;articledb.comment&quot;,</span><br><span class="line">    &quot;collectionUUID&quot; : UUID(&quot;ddea6ed8-ee61-4693-bd16-196acc3a45e8&quot;),</span><br><span class="line">    &quot;ok&quot; : 1,</span><br><span class="line">    &quot;operationTime&quot; : Timestamp(1564612840, 28),</span><br><span class="line">    &quot;$clusterTime&quot; : &#123;</span><br><span class="line">        &quot;clusterTime&quot; : Timestamp(1564612840, 28),</span><br><span class="line">        &quot;signature&quot; : &#123;</span><br><span class="line">            &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA&#x3D;&quot;),</span><br><span class="line">            &quot;keyId&quot; : NumberLong(0)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>查看分片状态：sh.status()</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> databases:</span><br><span class="line"> &#123;  &quot;_id&quot; : &quot;articledb&quot;,  &quot;primary&quot; : &quot;myshardrs02&quot;,  &quot;partitioned&quot; : true,  &quot;version&quot; : &#123;  &quot;uuid&quot; : UUID(&quot;251436b7-86c2-4cd8-9a88-70874af29364&quot;), &quot;lastMod&quot; : 1 &#125; &#125;</span><br><span class="line">     articledb.comment</span><br><span class="line">         shard key: &#123; &quot;nickname&quot; : &quot;hashed&quot; &#125;</span><br><span class="line">         unique: false</span><br><span class="line">         balancing: true</span><br><span class="line">         chunks:</span><br><span class="line">             myshardrs01   2</span><br><span class="line">             myshardrs02   2</span><br><span class="line">         &#123; &quot;nickname&quot; : &#123; &quot;$minKey&quot; : 1 &#125; &#125; --&gt;&gt; &#123; &quot;nickname&quot; : NumberLong(&quot;-4611686018427387902&quot;) &#125; on : myshardrs01 Timestamp(1, 0)</span><br><span class="line">         &#123; &quot;nickname&quot; : NumberLong(&quot;-4611686018427387902&quot;) &#125; --&gt;&gt; &#123; &quot;nickname&quot; : NumberLong(0) &#125; on : myshardrs01 Timestamp(1, 1)</span><br><span class="line">         &#123; &quot;nickname&quot; : NumberLong(0) &#125; --&gt;&gt; &#123; &quot;nickname&quot; : NumberLong(&quot;4611686018427387902&quot;) &#125; on : myshardrs02 Timestamp(1, 2)</span><br><span class="line">         &#123; &quot;nickname&quot; : NumberLong(&quot;4611686018427387902&quot;) &#125; --&gt;&gt; &#123; &quot;nickname&quot; : &#123; &quot;$maxKey&quot; : 1 &#125; &#125; on : myshardrs02 Timestamp(1, 3)</span><br><span class="line"></span><br><span class="line">&#123;  &quot;_id&quot; : &quot;config&quot;,  &quot;primary&quot; : &quot;config&quot;,  &quot;partitioned&quot; : true &#125;</span><br><span class="line">    config.system.sessions</span><br><span class="line">        shard key: &#123; &quot;_id&quot; : 1 &#125;</span><br><span class="line">        unique: false</span><br><span class="line">        balancing: true</span><br><span class="line">        chunks:</span><br><span class="line">        myshardrs01   1</span><br><span class="line">    &#123; &quot;_id&quot; : &#123; &quot;$minKey&quot; : 1 &#125; &#125; --&gt;&gt; &#123; &quot;_id&quot; : &#123; &quot;$maxKey&quot; : 1 &#125; &#125; on : myshardrs01 Timestamp(1, 0)</span><br></pre></td></tr></table></figure><p><strong>分片规则二：范围策略</strong></p><p>对于 基于范围的分片 ,MongoDB按照片键的范围把数据分成不同部分.假设有一个数字的片键:想象一个从负无穷到正无穷的直线,每一个片键的值都在直线上画了一个点.MongoDB把这条直线划分为更短的不重叠的片段,并称之为 数据块 ,每个数据块包含了片键在一定范围内的数据.</p><p>在使用片键做范围划分的系统中,拥有”相近”片键的文档很可能存储在同一个数据块中,因此也会存储在同一个分片中.</p><p>如使用作者年龄字段作为片键，按照点赞数的值进行分片：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.shardCollection(&quot;articledb.author&quot;,&#123;&quot;age&quot;:1&#125;)</span><br><span class="line">&#123;</span><br><span class="line">    &quot;collectionsharded&quot; : &quot;articledb.author&quot;,</span><br><span class="line">    &quot;collectionUUID&quot; : UUID(&quot;9a47bdaa-213a-4039-9c18-e70bfc369df7&quot;),</span><br><span class="line">    &quot;ok&quot; : 1,</span><br><span class="line">    &quot;operationTime&quot; : Timestamp(1567512803, 13),</span><br><span class="line">    &quot;$clusterTime&quot; : &#123;</span><br><span class="line">        &quot;clusterTime&quot; : Timestamp(1567512803, 13),</span><br><span class="line">        &quot;signature&quot; : &#123;</span><br><span class="line">            &quot;hash&quot; : BinData(0,&quot;eE9QT5yE5sL1Tyr7+3U8GRy5+5Q&#x3D;&quot;),</span><br><span class="line">            &quot;keyId&quot; : NumberLong(&quot;6732061237309341726&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意的是：</p><ul><li>一个集合只能指定一个片键，否则报错。</li><li>一旦对一个集合分片，分片键和分片值就不可改变。 如：不能给集合选择不同的分片键、不能更新分片键的值。</li><li>根据age索引进行分配数据。</li></ul><p>查看分片状态：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">articledb.author</span><br><span class="line">    shard key: &#123; &quot;age&quot; : 1 &#125;</span><br><span class="line">    unique: false</span><br><span class="line">    balancing: true</span><br><span class="line">    chunks:</span><br><span class="line">    myshardrs01 1</span><br><span class="line">    &#123; &quot;age&quot; : &#123; &quot;$minKey&quot; : 1 &#125; &#125; --&gt;&gt; &#123; &quot;age&quot; : &#123; &quot;$maxKey&quot; : 1 &#125; &#125; on : myshardrs01 Timestamp(1, 0)</span><br></pre></td></tr></table></figure><p>基于范围的分片方式与基于哈希的分片方式性能对比：</p><p>基于范围的分片方式提供了更高效的范围查询,给定一个片键的范围,分发路由可以很简单地确定哪个数据块存储了请求需要的数据,并将请求转发到相应的分片中.</p><p>不过,基于范围的分片会导致数据在不同分片上的不均衡,有时候,带来的消极作用会大于查询性能的积极作用.比如,如果片键所在的字段是线性增长的,一定时间内的所有请求都会落到某个固定的数据块中,最终导致分布在同一个分片中.在这种情况下,一小部分分片承载了集群大部分的数据,系统并不能很好地进行扩展.</p><p>与此相比,基于哈希的分片方式以范围查询性能的损失为代价,保证了集群中数据的均衡.哈希值的随机性使数据随机分布在每个数据块中,因此也随机分布在不同分片中.但是也正由于随机性,一个范围查询很难确定应该请求哪些分片,通常为了返回需要的结果,需要请求所有分片.</p><p>如无特殊情况，一般推荐使用 Hash Sharding。</p><p>而使用 _id 作为片键是一个不错的选择，因为它是必有的，你可以使用数据文档 _id 的哈希作为片键。</p><p>这个方案能够是的读和写都能够平均分布，并且它能够保证每个文档都有不同的片键所以数据块能够很精细。</p><p>似乎还是不够完美，因为这样的话对多个文档的查询必将命中所有的分片。虽说如此，这也是一种比较好的方案了。</p><p>理想化的 shard key 可以让 documents 均匀地在集群中分布：</p><p><img src="https://img-blog.csdnimg.cn/2020091816513874.png" alt="image-20200918121206254"></p><p>显示集群的详细信息：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; db.printShardingStatus()</span><br></pre></td></tr></table></figure><p>查看均衡器是否工作（需要重新均衡时系统才会自动启动，不用管它）：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.isBalancerRunning()</span><br><span class="line">false</span><br></pre></td></tr></table></figure><p>查看当前 Balancer状态：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.getBalancerState()</span><br><span class="line">true</span><br></pre></td></tr></table></figure><h3 id="2-6-3-分片后插入数据测试"><a href="#2-6-3-分片后插入数据测试" class="headerlink" title="2.6.3 分片后插入数据测试"></a>2.6.3 分片后插入数据测试</h3><p>测试一（哈希规则）：登录mongs后，向comment循环插入1000条数据做测试：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">mongos&gt; for(var i&#x3D;1;i&lt;&#x3D;1000;i++)&#123;db.comment.insert(&#123;_id:i+&quot;&quot;,nickname:&quot;BoBo&quot;+i&#125;)&#125;</span><br><span class="line">WriteResult(&#123; &quot;nInserted&quot; : 1 &#125;)</span><br><span class="line">mongos&gt; db.comment.count()</span><br><span class="line">1000</span><br></pre></td></tr></table></figure><p>提示： js的语法，因为mongo的shell是一个JavaScript的shell。</p><p>注意：从路由上插入的数据，必须包含片键，否则无法插入。</p><p>分别登陆两个片的主节点，统计文档数量</p><p>第一个分片副本集：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongo --host 180.76.159.126 --port 27018</span><br><span class="line"></span><br><span class="line">myshardrs01:PRIMARY&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">myshardrs01:PRIMARY&gt; db.comment.count()</span><br><span class="line">507</span><br></pre></td></tr></table></figure><p>第二个分片副本集：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongo --host 180.76.159.126 --port 27318</span><br><span class="line"></span><br><span class="line">myshardrs02:PRIMARY&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">myshardrs02:PRIMARY&gt; db.comment.count()</span><br><span class="line">493</span><br></pre></td></tr></table></figure><p>可以看到， 1000条数据近似均匀的分布到了2个shard上。是根据片键的哈希值分配的。</p><p>这种分配方式非常易于水平扩展：一旦数据存储需要更大空间，可以直接再增加分片即可，同时提升了性能。</p><p>使用db.comment.stats()查看单个集合的完整情况，mongos执行该命令可以查看该集合的数据分片的情况。</p><p>使用sh.status()查看本库内所有集合的分片信息。</p><p>测试二（范围规则）：登录mongs后，向comment循环插入1000条数据做测试：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">mongos&gt; for(var i&#x3D;1;i&lt;&#x3D;20000;i++)&#123;db.author.save(&#123;&quot;name&quot;:&quot;BoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBoBo&quot;+i,&quot;age&quot;:NumberInt(i%120)&#125;)&#125;</span><br><span class="line">WriteResult(&#123; &quot;nInserted&quot; : 1 &#125;)</span><br><span class="line">mongos&gt; db.comment.count()</span><br><span class="line">20000</span><br></pre></td></tr></table></figure><p>插入成功后，仍然要分别查看两个分片副本集的数据情况。</p><p>分片效果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">articledb.author</span><br><span class="line">    shard key: &#123; &quot;age&quot; : 1 &#125;</span><br><span class="line">    unique: false</span><br><span class="line">    balancing: true</span><br><span class="line">    chunks:</span><br><span class="line">        myshardrs01 2</span><br><span class="line">        myshardrs02 1</span><br><span class="line">    &#123; &quot;age&quot; : &#123; &quot;$minKey&quot; : 1 &#125; &#125; --&gt;&gt; &#123; &quot;age&quot; : 0 &#125; on : myshardrs02 Timestamp(2, 0)</span><br><span class="line">    &#123; &quot;age&quot; : 0 &#125; --&gt;&gt; &#123; &quot;age&quot; : 112 &#125; on : myshardrs01 Timestamp(2, 1)</span><br><span class="line">    &#123; &quot;age&quot; : 112 &#125; --&gt;&gt; &#123; &quot;age&quot; : &#123; &quot;$maxKey&quot; : 1 &#125; &#125; on : myshardrs01 Timestamp(1, 3)</span><br></pre></td></tr></table></figure><p>提示：</p><p>如果查看状态发现没有分片，则可能是由于以下原因造成了：</p><ul><li><p>系统繁忙，正在分片中。</p></li><li><p>数据块（chunk）没有填满，默认的数据块尺寸（chunksize）是64M，填满后才会考虑向其他片的数据块填充数据，因此，为了测试，可以将其改小，这里改为1M，操作如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use config</span><br><span class="line">db.settings.save( &#123; _id:&quot;chunksize&quot;, value: 1 &#125; )</span><br></pre></td></tr></table></figure><p>测试完改回来：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.settings.save( &#123; _id:&quot;chunksize&quot;, value: 64 &#125; )</span><br></pre></td></tr></table></figure></li></ul><p>注意：要先改小，再设置分片。为了测试，可以先删除集合，重新建立集合的分片策略，再插入数据测试即可。</p><h3 id="2-6-4-再增加一个路由节点"><a href="#2-6-4-再增加一个路由节点" class="headerlink" title="2.6.4 再增加一个路由节点"></a>2.6.4 再增加一个路由节点</h3><p>文件夹：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#-----------mongos02</span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27117&#x2F;log</span><br></pre></td></tr></table></figure><p>新建或修改配置文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27117&#x2F;mongos.conf</span><br></pre></td></tr></table></figure><p>mongos.conf：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">    #MongoDB发送所有日志输出的目标指定为文件</span><br><span class="line">    destination: file</span><br><span class="line">    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span><br><span class="line">    path: &quot;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27117&#x2F;log&#x2F;mongod.log&quot;</span><br><span class="line">    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span><br><span class="line">    logAppend: true</span><br><span class="line">processManagement:</span><br><span class="line">    #启用在后台运行mongos或mongod进程的守护进程模式。</span><br><span class="line">    fork: true</span><br><span class="line">    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span><br><span class="line">    pidFilePath: &#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27117&#x2F;log&#x2F;mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line">    #服务实例绑定所有IP，有副作用，副本集初始化的时候，节点名字会自动设置为本地域名，而不是ip</span><br><span class="line">    #bindIpAll: true</span><br><span class="line">    #服务实例绑定的IP</span><br><span class="line">    bindIp: localhost,192.168.0.2</span><br><span class="line">    #bindIp</span><br><span class="line">    #绑定的端口</span><br><span class="line">    port: 27117</span><br><span class="line">sharding:</span><br><span class="line">    configDB: myconfigrs&#x2F;180.76.159.126:27019,180.76.159.126:27119,180.76.159.126:27219</span><br></pre></td></tr></table></figure><p>启动mongos2：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost bin]# &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongos -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27117&#x2F;mongos.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 129874</span><br><span class="line">child process started successfully, parent exiting</span><br></pre></td></tr></table></figure><p>使用mongo客户端登录27117，发现，第二个路由无需配置，因为分片配置都保存到了配置服务器中了。</p><h2 id="2-7-Compass-连接分片集群"><a href="#2-7-Compass-连接分片集群" class="headerlink" title="2.7 Compass 连接分片集群"></a>2.7 Compass 连接分片集群</h2><p>compass连接：</p><p><img src="https://img-blog.csdnimg.cn/2020091816515942.png" alt="image-20200918122259273"></p><p>提示：和连接单机 mongod一样。</p><p>连接成功后，上方有mongos和分片集群的提示：</p><p><img src="https://img-blog.csdnimg.cn/20200918165217814.png" alt="image-20200918122329943"></p><h2 id="2-8-SpringDataMongDB-连接分片集群"><a href="#2-8-SpringDataMongDB-连接分片集群" class="headerlink" title="2.8 SpringDataMongDB 连接分片集群"></a>2.8 SpringDataMongDB 连接分片集群</h2><p>Java客户端常用的是SpringDataMongoDB，其连接的是mongs路由，配置和单机mongod的配置是一样的。</p><p>多个路由的时候的SpringDataMongoDB的客户端配置参考如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">    #数据源配置</span><br><span class="line">    data:</span><br><span class="line">        mongodb:</span><br><span class="line">            # 主机地址</span><br><span class="line">            #   host: 180.76.159.126</span><br><span class="line">            # 数据库</span><br><span class="line">            #   database: articledb</span><br><span class="line">            # 默认端口是27017</span><br><span class="line">            #   port: 27017</span><br><span class="line">            #也可以使用uri连接</span><br><span class="line">            #   uri: mongodb:&#x2F;&#x2F;192.168.40.134:28017&#x2F;articledb</span><br><span class="line">            # 连接副本集字符串</span><br><span class="line">            #   uri: mongodb:&#x2F;&#x2F;180.76.159.126:27017,180.76.159.126:27018,180.76.159.126:27019&#x2F;articledb?connect&#x3D;replicaSet&amp;slaveOk&#x3D;true&amp;replicaSet&#x3D;myrs</span><br><span class="line">            #连接路由字符串</span><br><span class="line">            uri: mongodb:&#x2F;&#x2F;180.76.159.126:27017,180.76.159.126:27117&#x2F;articledb</span><br></pre></td></tr></table></figure><p>通过日志发现，写入数据的时候，会选择一个路由写入</p><h2 id="2-9-清除所有的节点数据（备用）"><a href="#2-9-清除所有的节点数据（备用）" class="headerlink" title="2.9 清除所有的节点数据（备用）"></a>2.9 清除所有的节点数据（备用）</h2><p>如果在搭建分片的时候有操作失败或配置有问题，需要重新来过的，可以进行如下操作：</p><p>第一步：查询出所有的测试服务节点的进程：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost sharded_cluster]# ps -ef |grep mongo</span><br><span class="line">root    10184    1  0 06:04 ?     00:01:25 &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27018&#x2F;mongod.conf</span><br><span class="line">root    10219    1  0 06:04 ?     00:01:25 &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27118&#x2F;mongod.conf</span><br><span class="line">root    10253    1  0 06:04 ?     00:00:46 &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27218&#x2F;mongod.conf</span><br><span class="line">root    10312    1  0 06:04 ?     00:01:23 &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27318&#x2F;mongod.conf</span><br><span class="line">root    10346    1  0 06:05 ?     00:01:23 &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27418&#x2F;mongod.conf</span><br><span class="line">root    10380    1  0 06:05 ?     00:00:44 &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27518&#x2F;mongod.conf</span><br><span class="line">root    10414    1  1 06:05 ?     00:01:36 &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27019&#x2F;mongod.conf</span><br><span class="line">root    10453    1  1 06:05 ?     00:01:37 &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27119&#x2F;mongod.conf</span><br><span class="line">root    10492    1  1 06:05 ?     00:01:38 &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27219&#x2F;mongod.conf</span><br><span class="line">root    11392    1  0 06:15 ?     00:00:24 &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongos -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27017&#x2F;mongos.conf</span><br><span class="line">root    14829    1  0 07:15 ?     00:00:13 &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongos -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27117&#x2F;mongos.conf</span><br></pre></td></tr></table></figure><p>根据上述的进程编号，依次中断进程：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -2 进程编号</span><br></pre></td></tr></table></figure><p>第二步：清除所有的节点的数据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rm -rf &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27019&#x2F;data&#x2F;db&#x2F;*.* \ &amp;</span><br><span class="line">rm -rf &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27119&#x2F;data&#x2F;db&#x2F;*.* \ &amp;</span><br><span class="line">rm -rf &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27219&#x2F;data&#x2F;db&#x2F;*.* \ &amp;</span><br><span class="line">rm -rf &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27018&#x2F;data&#x2F;db&#x2F;*.* \ &amp;</span><br><span class="line">rm -rf &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27118&#x2F;data&#x2F;db&#x2F;*.* \ &amp;</span><br><span class="line">rm -rf &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27218&#x2F;data&#x2F;db&#x2F;*.* \ &amp;</span><br><span class="line">rm -rf &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27318&#x2F;data&#x2F;db&#x2F;*.* \ &amp;</span><br><span class="line">rm -rf &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27418&#x2F;data&#x2F;db&#x2F;*.* \ &amp;</span><br><span class="line">rm -rf &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27518&#x2F;data&#x2F;db&#x2F;*.* \ &amp;</span><br><span class="line">rm -rf &#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27017&#x2F;data&#x2F;db&#x2F;*.* \ &amp;</span><br><span class="line">rm -rf &#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27117&#x2F;data&#x2F;db&#x2F;*.*</span><br></pre></td></tr></table></figure><p>第三步：查看或修改有问题的配置</p><p>第四步：依次启动所有节点，不包括路由节点：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27018&#x2F;mongod.conf</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27118&#x2F;mongod.conf</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27218&#x2F;mongod.conf</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27318&#x2F;mongod.conf</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27418&#x2F;mongod.conf</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27518&#x2F;mongod.conf</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27019&#x2F;mongod.conf</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27119&#x2F;mongod.conf</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27219&#x2F;mongod.conf</span><br></pre></td></tr></table></figure><p>第五步：对两个数据分片副本集和一个配置副本集进行初始化和相关配置</p><p>第六步：检查路由mongos的配置，并启动mongos</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27017&#x2F;mongos.cfg</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27017&#x2F;mongos.cfg</span><br></pre></td></tr></table></figure><p>第七步：mongo登录mongos，在其上进行相关操作。</p><h1 id="3-安全认证"><a href="#3-安全认证" class="headerlink" title="3. 安全认证"></a>3. 安全认证</h1><h2 id="3-1-MongoDB-的用户和角色权限简介"><a href="#3-1-MongoDB-的用户和角色权限简介" class="headerlink" title="3.1 MongoDB 的用户和角色权限简介"></a>3.1 MongoDB 的用户和角色权限简介</h2><p>默认情况下，MongoDB实例启动运行时是没有启用用户访问权限控制的，也就是说，在实例本机服务器上都可以随意连接到实例进行各种操作，MongoDB不会对连接客户端进行用户验证，这是非常危险的。</p><p>mongodb官网上说，为了能保障mongodb的安全可以做以下几个步骤：</p><ul><li>使用新的端口，默认的27017端口如果一旦知道了ip就能连接上，不太安全。</li><li>设置mongodb的网络环境，最好将mongodb部署到公司服务器内网，这样外网是访问不到的。公司内部访问使用vpn等。</li><li>开启安全认证。认证要同时设置服务器之间的内部认证方式，同时要设置客户端连接到集群的账号密码认证方式。</li></ul><p>为了强制开启用户访问控制(用户验证)，则需要在MongoDB实例启动时使用选项 – auth 或在指定启动配置文件中添加选项 auth=true 。</p><p>在开始之前需要了解一下概念</p><p>1）启用访问控制：</p><p>MongoDB使用的是基于角色的访问控制(Role-Based Access Control,RBAC)来管理用户对实例的访问。通过对用户授予一个或多个角色来控制用户访问数据库资源的权限和数据库操作的权限，在对用户分配角色之前，用户无法访问实例。</p><p>在实例启动时添加选项 – auth 或指定启动配置文件中添加选项 auth=true 。</p><p>2）角色：</p><p>在MongoDB中通过角色对用户授予相应数据库资源的操作权限，每个角色当中的权限可以显式指定，也可以通过继承其他角色的权限，或者两都都存在的权限。</p><p>3）权限：</p><p>权限由指定的数据库资源(resource)以及允许在指定资源上进行的操作(action)组成。</p><ul><li>资源(resource)包括：数据库、集合、部分集合和集群；</li><li>操作(action)包括：对资源进行的增、删、改、查(CRUD)操作。</li></ul><p>在角色定义时可以包含一个或多个已存在的角色，新创建的角色会继承包含的角色所有的权限。在同一个数据库中，新创建角色可以继承其他角色的权限，在 admin 数据库中创建的角色可以继承在其它任意数据库中角色的权限。</p><p>关于角色权限的查看，可以通过如下命令查询（了解）：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 查询所有角色权限(仅用户自定义角色)</span><br><span class="line">&gt; db.runCommand(&#123; rolesInfo: 1 &#125;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 查询所有角色权限(包含内置角色)</span><br><span class="line">&gt; db.runCommand(&#123; rolesInfo: 1, showBuiltinRoles: true &#125;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 查询当前数据库中的某角色的权限</span><br><span class="line">&gt; db.runCommand(&#123; rolesInfo: &quot;&lt;rolename&gt;&quot; &#125;)</span><br><span class="line">&#x2F;&#x2F; 查询其它数据库中指定的角色权限</span><br><span class="line">&gt; db.runCommand(&#123; rolesInfo: &#123; role: &quot;&lt;rolename&gt;&quot;, db: &quot;&lt;database&gt;&quot; &#125; &#125;</span><br><span class="line">&#x2F;&#x2F; 查询多个角色权限</span><br><span class="line">&gt; db.runCommand(</span><br><span class="line">    &#123;</span><br><span class="line">        rolesInfo: [</span><br><span class="line">            &quot;&lt;rolename&gt;&quot;,</span><br><span class="line">            &#123; role: &quot;&lt;rolename&gt;&quot;, db: &quot;&lt;database&gt;&quot; &#125;,</span><br><span class="line">            ...</span><br><span class="line">        ]  </span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>示例：</p><p>查看所有内置角色：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.runCommand(&#123; rolesInfo: 1, showBuiltinRoles: true &#125;)</span><br><span class="line">&#123;</span><br><span class="line">    &quot;roles&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;role&quot; : &quot;__queryableBackup&quot;,</span><br><span class="line">            &quot;db&quot; : &quot;admin&quot;,</span><br><span class="line">            &quot;isBuiltin&quot; : true,</span><br><span class="line">            &quot;roles&quot; : [ ],</span><br><span class="line">            &quot;inheritedRoles&quot; : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;role&quot; : &quot;__system&quot;,</span><br><span class="line">            &quot;db&quot; : &quot;admin&quot;,</span><br><span class="line">            &quot;isBuiltin&quot; : true,</span><br><span class="line">            &quot;roles&quot; : [ ],</span><br><span class="line">            &quot;inheritedRoles&quot; : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;role&quot; : &quot;backup&quot;,</span><br><span class="line">            &quot;db&quot; : &quot;admin&quot;,</span><br><span class="line">            &quot;isBuiltin&quot; : true,</span><br><span class="line">            &quot;roles&quot; : [ ],</span><br><span class="line">            &quot;inheritedRoles&quot; : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;role&quot; : &quot;clusterAdmin&quot;,</span><br><span class="line">            &quot;db&quot; : &quot;admin&quot;,</span><br><span class="line">            &quot;isBuiltin&quot; : true,</span><br><span class="line">            &quot;roles&quot; : [ ],</span><br><span class="line">            &quot;inheritedRoles&quot; : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;role&quot; : &quot;clusterManager&quot;,</span><br><span class="line">            &quot;db&quot; : &quot;admin&quot;,</span><br><span class="line">            &quot;isBuiltin&quot; : true,</span><br><span class="line">            &quot;roles&quot; : [ ],</span><br><span class="line">            &quot;inheritedRoles&quot; : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;role&quot; : &quot;clusterMonitor&quot;,</span><br><span class="line">            &quot;db&quot; : &quot;admin&quot;,</span><br><span class="line">            &quot;isBuiltin&quot; : true,</span><br><span class="line">            &quot;roles&quot; : [ ],</span><br><span class="line">            &quot;inheritedRoles&quot; : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;role&quot; : &quot;dbAdmin&quot;,</span><br><span class="line">            &quot;db&quot; : &quot;admin&quot;,</span><br><span class="line">            &quot;isBuiltin&quot; : true,</span><br><span class="line">            &quot;roles&quot; : [ ],</span><br><span class="line">            &quot;inheritedRoles&quot; : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;role&quot; : &quot;dbAdminAnyDatabase&quot;,</span><br><span class="line">            &quot;db&quot; : &quot;admin&quot;,</span><br><span class="line">            &quot;isBuiltin&quot; : true,</span><br><span class="line">            &quot;roles&quot; : [ ],</span><br><span class="line">            &quot;inheritedRoles&quot; : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;role&quot; : &quot;dbOwner&quot;,</span><br><span class="line">            &quot;db&quot; : &quot;admin&quot;,</span><br><span class="line">            &quot;isBuiltin&quot; : true,</span><br><span class="line">            &quot;roles&quot; : [ ],</span><br><span class="line">            &quot;inheritedRoles&quot; : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;role&quot; : &quot;enableSharding&quot;,</span><br><span class="line">            &quot;db&quot; : &quot;admin&quot;,</span><br><span class="line">            &quot;isBuiltin&quot; : true,</span><br><span class="line">            &quot;roles&quot; : [ ],</span><br><span class="line">            &quot;inheritedRoles&quot; : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;role&quot; : &quot;hostManager&quot;,</span><br><span class="line">            &quot;db&quot; : &quot;admin&quot;,</span><br><span class="line">            &quot;isBuiltin&quot; : true,</span><br><span class="line">            &quot;roles&quot; : [ ],</span><br><span class="line">            &quot;inheritedRoles&quot; : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;role&quot; : &quot;read&quot;,</span><br><span class="line">            &quot;db&quot; : &quot;admin&quot;,</span><br><span class="line">            &quot;isBuiltin&quot; : true,</span><br><span class="line">            &quot;roles&quot; : [ ],</span><br><span class="line">            &quot;inheritedRoles&quot; : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;role&quot; : &quot;readAnyDatabase&quot;,</span><br><span class="line">            &quot;db&quot; : &quot;admin&quot;,</span><br><span class="line">            &quot;isBuiltin&quot; : true,</span><br><span class="line">            &quot;roles&quot; : [ ],</span><br><span class="line">            &quot;inheritedRoles&quot; : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;role&quot; : &quot;readWrite&quot;,</span><br><span class="line">            &quot;db&quot; : &quot;admin&quot;,</span><br><span class="line">            &quot;isBuiltin&quot; : true,</span><br><span class="line">            &quot;roles&quot; : [ ],</span><br><span class="line">            &quot;inheritedRoles&quot; : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;role&quot; : &quot;readWriteAnyDatabase&quot;,</span><br><span class="line">            &quot;db&quot; : &quot;admin&quot;,</span><br><span class="line">            &quot;isBuiltin&quot; : true,</span><br><span class="line">            &quot;roles&quot; : [ ],</span><br><span class="line">            &quot;inheritedRoles&quot; : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;role&quot; : &quot;restore&quot;,</span><br><span class="line">            &quot;db&quot; : &quot;admin&quot;,</span><br><span class="line">            &quot;isBuiltin&quot; : true,</span><br><span class="line">            &quot;roles&quot; : [ ],</span><br><span class="line">            &quot;inheritedRoles&quot; : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;role&quot; : &quot;root&quot;,</span><br><span class="line">            &quot;db&quot; : &quot;admin&quot;,</span><br><span class="line">            &quot;isBuiltin&quot; : true,</span><br><span class="line">            &quot;roles&quot; : [ ],</span><br><span class="line">            &quot;inheritedRoles&quot; : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;role&quot; : &quot;userAdmin&quot;,</span><br><span class="line">            &quot;db&quot; : &quot;admin&quot;,</span><br><span class="line">            &quot;isBuiltin&quot; : true,</span><br><span class="line">            &quot;roles&quot; : [ ],</span><br><span class="line">            &quot;inheritedRoles&quot; : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;role&quot; : &quot;userAdminAnyDatabase&quot;,</span><br><span class="line">            &quot;db&quot; : &quot;admin&quot;,</span><br><span class="line">            &quot;isBuiltin&quot; : true,</span><br><span class="line">            &quot;roles&quot; : [ ],</span><br><span class="line">            &quot;inheritedRoles&quot; : [ ]</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>常用的内置角色：</p><ul><li>数据库用户角色： read、readWrite;</li><li>所有数据库用户角色： readAnyDatabase、readWriteAnyDatabase、userAdminAnyDatabase、dbAdminAnyDatabase</li><li>数据库管理角色： dbAdmin、dbOwner、userAdmin；</li><li>集群管理角色： clusterAdmin、clusterManager、clusterMonitor、hostManager；</li><li>备份恢复角色： backup、restore；</li><li>超级用户角色： root</li><li>内部角色： system</li></ul><p>角色说明：</p><table><thead><tr><th>角色</th><th>权限描述</th></tr></thead><tbody><tr><td>read</td><td>可以读取指定数据库中任何数据</td></tr><tr><td>readWrite</td><td>可以读写指定数据库中任何数据，包括创建、重命名、删除集合</td></tr><tr><td>readAnyDatabase</td><td>可以读取所有数据库中任何数据(除了数据库config和local之外)</td></tr><tr><td>readWriteAnyDatabase</td><td>可以读写所有数据库中任何数据(除了数据库config和local之外)</td></tr><tr><td>userAdminAnyDatabase</td><td>可以在指定数据库创建和修改用户(除了数据库config和local之外)</td></tr><tr><td>dbAdminAnyDatabase</td><td>可以读取任何数据库以及对数据库进行清理、修改、压缩、获取统计信息、执行检查等操作(除了数据库config和local之外)</td></tr><tr><td>dbAdmin</td><td>可以读取指定数据库以及对数据库进行清理、修改、压缩、获取统计信息、执行检查等操作</td></tr><tr><td>userAdmin</td><td>可以在指定数据库创建和修改用户</td></tr><tr><td>clusterAdmin</td><td>可以对整个集群或数据库系统进行管理操作</td></tr><tr><td>backup</td><td>备份MongoDB数据最小的权限</td></tr><tr><td>restore</td><td>从备份文件中还原恢复MongoDB数据(除了system.profile集合)的权限</td></tr><tr><td>root</td><td>超级账号，超级权限</td></tr></tbody></table><h2 id="3-2-单实例环境"><a href="#3-2-单实例环境" class="headerlink" title="3.2 单实例环境"></a>3.2 单实例环境</h2><p>目标：对单实例的MongoDB服务开启安全认证，这里的单实例指的是未开启副本集或分片的MongoDB实例。</p><h3 id="3-2-1-关闭已开启的服务"><a href="#3-2-1-关闭已开启的服务" class="headerlink" title="3.2.1 关闭已开启的服务"></a>3.2.1 关闭已开启的服务</h3><p>增加mongod的单实例的安全认证功能，可以在服务搭建的时候直接添加，也可以在之前搭建好的服务上添加。</p><p>本文使用之前搭建好的服务，因此，先停止之前的服务</p><p>停止服务的方式有两种：快速关闭和标准关闭，下面依次说明：</p><p>（1）快速关闭方法（快速，简单，数据可能会出错）</p><p>目标：通过系统的kill命令直接杀死进程：</p><p>杀完要检查一下，避免有的没有杀掉。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#通过进程编号关闭节点</span><br><span class="line">kill -2 54410</span><br></pre></td></tr></table></figure><p>【补充】</p><p>如果一旦是因为数据损坏，则需要进行如下操作（了解）：</p><p>1）删除lock文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -f &#x2F;mongodb&#x2F;single&#x2F;data&#x2F;db&#x2F;*.lock</span><br></pre></td></tr></table></figure><p>2 ）修复数据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod --repair --dbpath&#x3D;&#x2F;mongodb&#x2F;single&#x2F;data&#x2F;db</span><br></pre></td></tr></table></figure><p>（2）标准的关闭方法（数据不容易出错，但麻烦）：</p><p>目标：通过mongo客户端中的shutdownServer命令来关闭服务</p><p>主要的操作步骤参考如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;客户端登录服务，注意，这里通过localhost登录，如果需要远程登录，必须先登录认证才行。</span><br><span class="line">mongo --port 27017</span><br><span class="line">&#x2F;&#x2F;#切换到admin库</span><br><span class="line">use admin</span><br><span class="line">&#x2F;&#x2F;关闭服务</span><br><span class="line">db.shutdownServer()</span><br></pre></td></tr></table></figure><h3 id="3-2-2-添加用户和权限"><a href="#3-2-2-添加用户和权限" class="headerlink" title="3.2.2 添加用户和权限"></a>3.2.2 添加用户和权限</h3><p>（1）先按照普通无授权认证的配置，来配置服务端的配置文件 /mongodb/single/mongod.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">    #MongoDB发送所有日志输出的目标指定为文件</span><br><span class="line">    destination: file</span><br><span class="line">    #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span><br><span class="line">    path: &quot;&#x2F;mongodb&#x2F;single&#x2F;log&#x2F;mongod.log&quot;</span><br><span class="line">    #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span><br><span class="line">    logAppend: true</span><br><span class="line">storage:</span><br><span class="line">    #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span><br><span class="line">    dbPath: &quot;&#x2F;mongodb&#x2F;single&#x2F;data&#x2F;db&quot;</span><br><span class="line">    journal:</span><br><span class="line">        #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">        enabled: true</span><br><span class="line">processManagement:</span><br><span class="line">    #启用在后台运行mongos或mongod进程的守护进程模式。</span><br><span class="line">    fork: true</span><br><span class="line">    #指定用于保存mongos或mongod进程的进程ID的文件位置，其中mongos或mongod将写入其PID</span><br><span class="line">    pidFilePath: &quot;&#x2F;mongodb&#x2F;single&#x2F;log&#x2F;mongod.pid&quot;</span><br><span class="line">net:</span><br><span class="line">    #服务实例绑定的IP</span><br><span class="line">    bindIp: localhost,192.168.0.2</span><br><span class="line">    #绑定的端口</span><br><span class="line">    port: 27017</span><br></pre></td></tr></table></figure><p>（2）按之前未开启认证的方式（不添加 – auth 参数）来启动MongoDB服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;single&#x2F;mongod.conf</span><br></pre></td></tr></table></figure><p>提示：</p><p>在操作用户时，启动mongod服务时尽量不要开启授权。</p><p>（3）使用Mongo客户端登录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongo --host 180.76.159.126 --port 27017</span><br></pre></td></tr></table></figure><p>（4）创建两个管理员用户，一个是系统的超级管理员 myroot ，一个是admin库的管理用户myadmin</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;切换到admin库</span><br><span class="line">&gt; use admin</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;创建系统超级用户 myroot,设置密码123456，设置角色root</span><br><span class="line">&#x2F;&#x2F;&gt; db.createUser(&#123;user:&quot;myroot&quot;,pwd:&quot;123456&quot;,roles:[ &#123; &quot;role&quot; : &quot;root&quot;, &quot;db&quot; : &quot;admin&quot; &#125; ]&#125;)</span><br><span class="line">&#x2F;&#x2F;或</span><br><span class="line">&gt; db.createUser(&#123;user:&quot;myroot&quot;,pwd:&quot;123456&quot;,roles:[&quot;root&quot;]&#125;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;创建专门用来管理admin库的账号myadmin，只用来作为用户权限的管理</span><br><span class="line">&gt; db.createUser(&#123;user:&quot;myadmin&quot;,pwd:&quot;123456&quot;,roles: [&#123;role:&quot;userAdminAnyDatabase&quot;,db:&quot;admin&quot;&#125;]&#125;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;查看已经创建了的用户的情况：</span><br><span class="line">&gt; db.system.users.find()</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;删除用户</span><br><span class="line">&gt; db.dropUser(&quot;myadmin&quot;)</span><br><span class="line">true</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;修改密码</span><br><span class="line">&gt; db.changeUserPassword(&quot;myroot&quot;, &quot;123456&quot;)</span><br></pre></td></tr></table></figure><p>提示：</p><ul><li>本案例创建了两个用户，分别对应超管和专门用来管理用户的角色，事实上，你只需要一个用户即可。如果你对安全要求很高，防止超管泄漏，则不要创建超管用户。</li><li>和其它数据库（MySQL）一样，权限的管理都差不多一样，也是将用户和权限信息保存到数据库对应的表中。Mongodb存储所有的用户信息在admin 数据库的集合system.users中，保存用户名、密码和数据库信息。</li><li>如果不指定数据库，则创建的指定的权限的用户在所有的数据库上有效，如 {role: “userAdminAnyDatabase”, db:””}</li></ul><p>（5）认证测试</p><p>测试添加的用户是否正确</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;切换到admin</span><br><span class="line">&gt; use admin</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;密码输错</span><br><span class="line">&gt; db.auth(&quot;myroot&quot;,&quot;12345&quot;)</span><br><span class="line">Error: Authentication failed.</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;密码正确</span><br><span class="line">&gt; db.auth(&quot;myroot&quot;,&quot;123456&quot;)</span><br><span class="line">1</span><br></pre></td></tr></table></figure><p>（6）创建普通用户</p><p>创建普通用户可以在没有开启认证的时候添加，也可以在开启认证之后添加，但开启认证之后，必须使用有操作admin库的用户登录认证后才能操作。底层都是将用户信息保存在了admin数据库的集合system.users中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;创建(切换)将来要操作的数据库articledb,</span><br><span class="line">&gt; use articledb</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;创建用户，拥有articledb数据库的读写权限readWrite，密码是123456</span><br><span class="line">&gt; db.createUser(&#123;user: &quot;bobo&quot;, pwd: &quot;123456&quot;, roles: [&#123; role: &quot;readWrite&quot;, db: &quot;articledb&quot; &#125;]&#125;)</span><br><span class="line">&#x2F;&#x2F;&gt; db.createUser(&#123;user: &quot;bobo&quot;, pwd: &quot;123456&quot;, roles: [&quot;readWrite&quot;]&#125;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;测试是否可用</span><br><span class="line">&gt; db.auth(&quot;bobo&quot;,&quot;123456&quot;)</span><br></pre></td></tr></table></figure><p>提示：</p><p>如果开启了认证后，登录的客户端的用户必须使用admin库的角色，如拥有root角色的myadmin用户，再通过myadmin用户去创建其他角色的用户</p><h3 id="3-2-3-服务端开启认证和客户端连接登录"><a href="#3-2-3-服务端开启认证和客户端连接登录" class="headerlink" title="3.2.3 服务端开启认证和客户端连接登录"></a>3.2.3 服务端开启认证和客户端连接登录</h3><h4 id="3-2-3-1-关闭已经启动的服务"><a href="#3-2-3-1-关闭已经启动的服务" class="headerlink" title="3.2.3.1 关闭已经启动的服务"></a>3.2.3.1 关闭已经启动的服务</h4><p>1）使用linux命令杀死进程：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost single]# ps -ef |grep mongo</span><br><span class="line">root    23482    1  0 08:08 ?     00:00:55 &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;single&#x2F;mongod.conf</span><br><span class="line">[root@bobohost single]# kill -2 23482</span><br></pre></td></tr></table></figure><p>2 ）在mongo客户端中使用shutdownServer命令来关闭</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.shutdownServer()</span><br><span class="line">shutdown command only works with the admin database; try &#39;use admin&#39;</span><br><span class="line">&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">&gt; db.shutdownServer()</span><br><span class="line">2019-08-14T11:20:16.450+0800 E QUERY  [js] Error: shutdownServer failed: &#123;</span><br><span class="line">    &quot;ok&quot; : 0,</span><br><span class="line">    &quot;errmsg&quot; : &quot;shutdown must run from localhost when running db without auth&quot;,</span><br><span class="line">    &quot;code&quot; : 13,</span><br><span class="line">    &quot;codeName&quot; : &quot;Unauthorized&quot;</span><br><span class="line">    &#125; :</span><br><span class="line">_getErrorWithCode@src&#x2F;mongo&#x2F;shell&#x2F;utils.js:25:13</span><br><span class="line">DB.prototype.shutdownServer@src&#x2F;mongo&#x2F;shell&#x2F;db.js:453:1</span><br><span class="line">@(shell):1:1</span><br></pre></td></tr></table></figure><p>需要几个条件：</p><ul><li>必须是在 admin库下执行该关闭服务命令。</li><li>如果没有开启认证，必须是从 localhost登陆的，才能执行关闭服务命令。</li><li>非 localhost的、通过远程登录的，必须有登录且必须登录用户有对admin操作权限才可以。</li></ul><h4 id="3-2-3-2-以开启认证的方式启动服务"><a href="#3-2-3-2-以开启认证的方式启动服务" class="headerlink" title="3.2.3.2 以开启认证的方式启动服务"></a>3.2.3.2 以开启认证的方式启动服务</h4><p>有两种方式开启权限认证启动服务：一种是参数方式，一种是配置文件方式</p><p>1）参数方式</p><p>在启动时指定参数 – auth ，如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;single&#x2F;mongod.conf --auth</span><br></pre></td></tr></table></figure><p>2）配置文件方式</p><p>在mongod.conf配置文件中加入：vim /mongodb/single/mongod.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line">    #开启授权认证</span><br><span class="line">    authorization: enabled</span><br></pre></td></tr></table></figure><p>启动时可不加 – auth 参数：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;single&#x2F;mongod.conf</span><br></pre></td></tr></table></figure><h4 id="3-2-3-3-开启了认证的情况下的客户端登录"><a href="#3-2-3-3-开启了认证的情况下的客户端登录" class="headerlink" title="3.2.3.3 开启了认证的情况下的客户端登录"></a>3.2.3.3 开启了认证的情况下的客户端登录</h4><p>有两种认证方式，一种是先登录，在mongo shell中认证；一种是登录时直接认证</p><p>1）先连接再认证</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost bin]# &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongo --host 180.76.159.126 --port 27017</span><br><span class="line">MongoDB shell version v4.0.10</span><br><span class="line">connecting to: mongodb:&#x2F;&#x2F;180.76.159.126:27017&#x2F;?gssapiServiceName&#x3D;mongodb</span><br><span class="line">Implicit session: session &#123; &quot;id&quot; : UUID(&quot;53fef661-35d6-4d29-b07c-020291d62e1a&quot;)&#125;</span><br><span class="line">MongoDB server version: 4.0.10</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure><p>提示：</p><p>开启认证后再登录，发现打印的日志比较少了。</p><p>相关操作需要认证才可以：</p><p>查询admin库中的system.users集合的用户：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">&gt; db.system.users.find()</span><br><span class="line">Error: error: &#123;</span><br><span class="line">    &quot;ok&quot; : 0,</span><br><span class="line">    &quot;errmsg&quot; : &quot;command find requires authentication&quot;,</span><br><span class="line">    &quot;code&quot; : 13,</span><br><span class="line">    &quot;codeName&quot; : &quot;Unauthorized&quot;</span><br><span class="line">&#125;</span><br><span class="line">&gt; db.auth(&quot;myroot&quot;,&quot;123456&quot;)</span><br><span class="line">1</span><br><span class="line">&gt; db.system.users.find()</span><br></pre></td></tr></table></figure><p>查询articledb库中的comment集合的内容：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">&gt; db.comment.find()</span><br><span class="line">Error: error: &#123;</span><br><span class="line">    &quot;ok&quot; : 0,</span><br><span class="line">    &quot;errmsg&quot; : &quot;not authorized on articledb to execute command &#123; find: \&quot;comment\&quot;, filter: &#123;&#125;, lsid: &#123; id: UUID(\&quot;53fef661-35d6-4d29-b07c-020291d62e1a\&quot;) &#125;, $db: \&quot;articledb\&quot; &#125;&quot;,</span><br><span class="line">    &quot;code&quot; : 13,</span><br><span class="line">    &quot;codeName&quot; : &quot;Unauthorized&quot;</span><br><span class="line">&#125;</span><br><span class="line">&gt; db.auth(&quot;bobo&quot;,&quot;123456&quot;)</span><br><span class="line">1</span><br><span class="line">&gt; db.comment.find()</span><br><span class="line">Error: error: &#123;</span><br><span class="line">    &quot;ok&quot; : 0,</span><br><span class="line">    &quot;errmsg&quot; : &quot;too many users are authenticated&quot;,</span><br><span class="line">    &quot;code&quot; : 13,</span><br><span class="line">    &quot;codeName&quot; : &quot;Unauthorized&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>提示：</p><p>这里可能出现错误，说是太多的用户正在认证了。因为我们确实连续登录了两个用户了。</p><p>解决方案：退出shell，重新进来登录认证</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; exit</span><br><span class="line">bye</span><br><span class="line">[root@bobohost bin]# .&#x2F;mongo --host 180.76.159.126 --port 27017</span><br><span class="line">MongoDB shell version v4.0.10</span><br><span class="line">connecting to: mongodb:&#x2F;&#x2F;180.76.159.126:27017&#x2F;?gssapiServiceName&#x3D;mongodb</span><br><span class="line">Implicit session: session &#123; &quot;id&quot; : UUID(&quot;329c1897-566d-4231-bcb3-b2acda301863&quot;)</span><br><span class="line">&#125;</span><br><span class="line">MongoDB server version: 4.0.10</span><br><span class="line">&gt; db.auth(&quot;bobo&quot;,&quot;123456&quot;)</span><br><span class="line">Error: Authentication failed.</span><br><span class="line">0</span><br><span class="line">&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">&gt; db.auth(&quot;bobo&quot;,&quot;123456&quot;)</span><br><span class="line">1</span><br><span class="line">&gt; db.comment.find()</span><br></pre></td></tr></table></figure><p>2）连接时直接认证</p><p>对admin数据库进行登录认证和相关操作：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost ~]# &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongo --host 180.76.159.126 --port 27017 --authenticationDatabase admin -u myroot -p 123456</span><br><span class="line">MongoDB shell version v4.0.10</span><br><span class="line">connecting to: mongodb:&#x2F;&#x2F;180.76.159.126:27017&#x2F;?</span><br><span class="line">authSource&#x3D;admin&amp;gssapiServiceName&#x3D;mongodb</span><br><span class="line">Implicit session: session &#123; &quot;id&quot; : UUID(&quot;f959b8d6-6994-44bc-9d35-09fc7cd00ba6&quot;)</span><br><span class="line">&#125;</span><br><span class="line">MongoDB server version: 4.0.10</span><br><span class="line">Server has startup warnings:</span><br><span class="line">2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten] ** WARNING: You are</span><br><span class="line">running this process as the root user, which is not recommended.</span><br><span class="line">2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten]</span><br><span class="line">2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten]</span><br><span class="line">2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten] ** WARNING:</span><br><span class="line">&#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled is &#39;always&#39;.</span><br><span class="line">2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten] **    We suggest</span><br><span class="line">setting it to &#39;never&#39;</span><br><span class="line">2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten]</span><br><span class="line">2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten] ** WARNING:</span><br><span class="line">&#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;defrag is &#39;always&#39;.</span><br><span class="line">2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten] **    We suggest</span><br><span class="line">setting it to &#39;never&#39;</span><br><span class="line">2019-09-10T15:23:40.102+0800 I CONTROL [initandlisten]</span><br><span class="line">&gt; show dbs;</span><br><span class="line">admin    0.000GB</span><br><span class="line">articledb  0.000GB</span><br><span class="line">config   0.000GB</span><br><span class="line">local    0.000GB</span><br></pre></td></tr></table></figure><p>对articledb数据库进行登录认证和相关操作：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost bin]# &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongo --host 180.76.159.126 --port 27017 --authenticationDatabase articledb -u bobo -p 123456</span><br><span class="line">MongoDB shell version v4.0.10</span><br><span class="line">connecting to: mongodb:&#x2F;&#x2F;180.76.159.126:27017&#x2F;?</span><br><span class="line">authSource&#x3D;articledb&amp;gssapiServiceName&#x3D;mongodb</span><br><span class="line">Implicit session: session &#123; &quot;id&quot; : UUID(&quot;e5d4148f-373b-45b8-9cff-a927ce617100&quot;)</span><br><span class="line">&#125;</span><br><span class="line">MongoDB server version: 4.0.10</span><br><span class="line">&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">&gt; db.comment.find()</span><br></pre></td></tr></table></figure><p>提示：</p><ul><li><code>-u</code> ：用户名</li><li><code>-p</code> ：密码</li><li><code>-- authenticationDatabase</code> ：指定连接到哪个库。当登录是指定用户名密码时，必须指定对应的数据库！</li></ul><h3 id="3-2-4-SpringDataMongoDB连接认证"><a href="#3-2-4-SpringDataMongoDB连接认证" class="headerlink" title="3.2.4 SpringDataMongoDB连接认证"></a>3.2.4 SpringDataMongoDB连接认证</h3><p>使用用户名和密码连接到 MongoDB 服务器，你必须使用<code>&#39;username:password@hostname/dbname&#39;</code> 格式，’username’为用户名，’password’ 为密码。</p><p>目标：使用用户bobo使用密码 123456 连接到MongoDB 服务上。</p><p>application.yml：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">    #数据源配置</span><br><span class="line">    data:</span><br><span class="line">        mongodb:</span><br><span class="line">            # 主机地址</span><br><span class="line">            #   host: 180.76.159.126</span><br><span class="line">            # 数据库</span><br><span class="line">            #   database: articledb</span><br><span class="line">            # 默认端口是27017</span><br><span class="line">            #   port: 27017</span><br><span class="line">            #帐号</span><br><span class="line">            #   username: bobo</span><br><span class="line">            #密码</span><br><span class="line">            #   password: 123456</span><br><span class="line">            #单机有认证的情况下，也使用字符串连接</span><br><span class="line">            uri: mongodb:&#x2F;&#x2F;bobo:123456@180.76.159.126:27017&#x2F;articledb</span><br></pre></td></tr></table></figure><h2 id="3-3-副本集环境"><a href="#3-3-副本集环境" class="headerlink" title="3.3 副本集环境"></a>3.3 副本集环境</h2><h3 id="3-3-1-前言"><a href="#3-3-1-前言" class="headerlink" title="3.3.1 前言"></a>3.3.1 前言</h3><p>对于搭建好的mongodb副本集，为了安全，启动安全认证，使用账号密码登录。</p><p>副本集环境使用之前搭建好的，架构如下：</p><p><img src="https://img-blog.csdnimg.cn/20200918165235785.png" alt="image-20200918145643639"></p><p>对副本集执行访问控制需要配置两个方面 :</p><ul><li>副本集和共享集群的各个节点成员之间使用内部身份验证，可以使用密钥文件或x.509证书。密钥文件比较简单，本文使用密钥文件，官方推荐如果是测试环境可以使用密钥文件，但是正式环境，官方推荐x.509证书。原理就是，集群中每一个实例彼此连接的时候都检验彼此使用的证书的内容是否相同。只有证书相同的实例彼此才可以访问</li><li>使用客户端连接到mongodb集群时，开启访问授权。对于集群外部的访问。如通过可视化客户端，或者通过代码连接的时候，需要开启授权。</li></ul><p>在keyfile身份验证中，副本集中的每个mongod实例都使用keyfile的内容作为共享密码，只有具有正确密钥文件的mongod或者mongos实例可以连接到副本集。密钥文件的内容必须在6到1024个字符之间，并且在unix/linux系统中文件所有者必须有对文件至少有读的权限。</p><h3 id="3-3-2-关闭已开启的副本集服务"><a href="#3-3-2-关闭已开启的副本集服务" class="headerlink" title="3.3.2 关闭已开启的副本集服务"></a>3.3.2 关闭已开启的副本集服务</h3><p>增加副本集的安全认证和服务鉴权功能，可以在副本集搭建的时候直接添加，也可以在之前搭建好的副本集服务上添加。</p><p>本文使用之前搭建好的副本集服务，因此，先停止之前的集群服务</p><p>停止服务的方式有两种：快速关闭和标准关闭，下面依次说明：</p><p>（1）快速关闭方法（快速，简单，数据可能会出错）</p><p>目标：通过系统的kill命令直接杀死进程：</p><p>依次杀死仲裁者、副本节点、主节点，直到所有成员都离线。建议主节点最后kill，以避免潜在的回滚。杀完要检查一下，避免有的没有杀掉。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#通过进程编号关闭节点</span><br><span class="line">kill -2 54410</span><br></pre></td></tr></table></figure><p>【补充】</p><p>如果一旦是因为数据损坏，则需要进行如下操作（了解）：</p><p>1）删除lock文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rm -f &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27017&#x2F;data&#x2F;db&#x2F;*.lock \</span><br><span class="line">&#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27018&#x2F;data&#x2F;db&#x2F;*.lock \</span><br><span class="line">&#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27019&#x2F;data&#x2F;db&#x2F;mongod.lock \</span><br></pre></td></tr></table></figure><p>2 ）依次修复数据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod --repair --dbpath&#x3D;&#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27017&#x2F;data&#x2F;db</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod --repair --dbpath&#x3D;&#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27018&#x2F;data&#x2F;db</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod --repair --dbpath&#x3D;&#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27019&#x2F;data&#x2F;db</span><br></pre></td></tr></table></figure><p>（2）标准的关闭方法（数据不容易出错，但麻烦）</p><p>目标：通过mongo客户端中的shutdownServer命令来依次关闭各个服务</p><p>关闭副本集中的服务，建议依次关闭仲裁节点、副本节点、主节点。主要的操作步骤参考如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;客户端登录服务，注意，这里通过localhost登录，如果需要远程登录，必须先登录认证才行。</span><br><span class="line">mongo --port 27017</span><br><span class="line">&#x2F;&#x2F;告知副本集说本机要下线</span><br><span class="line">rs.stepDown()</span><br><span class="line">&#x2F;&#x2F;#切换到admin库</span><br><span class="line">use admin</span><br><span class="line">&#x2F;&#x2F;关闭服务</span><br><span class="line">db.shutdownServer()</span><br></pre></td></tr></table></figure><h3 id="3-3-3-通过主节点添加一个管理员帐号"><a href="#3-3-3-通过主节点添加一个管理员帐号" class="headerlink" title="3.3.3 通过主节点添加一个管理员帐号"></a>3.3.3 通过主节点添加一个管理员帐号</h3><p>只需要在主节点上添加用户，副本集会自动同步。</p><p>开启认证之前，创建超管用户：myroot，密码：123456</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">myrs:PRIMARY&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">myrs:PRIMARY&gt; db.createUser(&#123;user:&quot;myroot&quot;,pwd:&quot;123456&quot;,roles:[&quot;root&quot;]&#125;)</span><br><span class="line">Successfully added user: &#123; &quot;user&quot; : &quot;myroot&quot;, &quot;roles&quot; : [ &quot;root&quot; ] &#125;</span><br></pre></td></tr></table></figure><p>该步骤也可以在开启认证之后，但需要通过localhost登录才允许添加用户，用户数据也会自动同步到副本集。</p><p>后续再创建其他用户，都可以使用该超管用户创建。</p><h3 id="3-3-4-创建副本集认证的key文件"><a href="#3-3-4-创建副本集认证的key文件" class="headerlink" title="3.3.4 创建副本集认证的key文件"></a>3.3.4 创建副本集认证的key文件</h3><p>第一步：生成一个key文件到当前文件夹中。</p><p>可以使用任何方法生成密钥文件。例如，以下操作使用openssl生成密码文件，然后使用chmod来更改文件权限，仅为文件所有者提供读取权限</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost ~]# openssl rand -base64 90 -out .&#x2F;mongo.keyfile</span><br><span class="line">[root@bobohost ~]# chmod 400 .&#x2F;mongo.keyfile</span><br><span class="line">[root@bobohost ~]# ll mongo.keyfile</span><br><span class="line">-r--------. 1 root root 122 8月  14 14:23 mongo.keyfile</span><br></pre></td></tr></table></figure><p>提示：</p><p>所有副本集节点都必须要用同一份keyfile，一般是在一台机器上生成，然后拷贝到其他机器上，且必须有读的权限，否则将来会报错： permissions on /mongodb/replica_sets/myrs_27017/mongo.keyfile are too open</p><p>一定要保证密钥文件一致，文件位置随便。但是为了方便查找，建议每台机器都放到一个固定的位置，都放到和配置文件一起的目录中。</p><p>这里将该文件分别拷贝到多个目录中：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost ~]# cp mongo.keyfile &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27017</span><br><span class="line">[root@bobohost ~]# cp mongo.keyfile &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27018</span><br><span class="line">[root@bobohost ~]# cp mongo.keyfile &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27019</span><br></pre></td></tr></table></figure><h3 id="3-3-5-修改配置文件指定keyfile"><a href="#3-3-5-修改配置文件指定keyfile" class="headerlink" title="3.3.5 修改配置文件指定keyfile"></a>3.3.5 修改配置文件指定keyfile</h3><p>分别编辑几个服务的mongod.conf文件，添加相关内容</p><p>/mongodb/replica_sets/myrs_27017/mongod.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line">    #KeyFile鉴权文件</span><br><span class="line">    keyFile: &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27017&#x2F;mongo.keyfile</span><br><span class="line">    #开启认证方式运行</span><br><span class="line">    authorization: enabled</span><br></pre></td></tr></table></figure><p>/mongodb/replica_sets/myrs_27018/mongod.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line">    #KeyFile鉴权文件</span><br><span class="line">    keyFile: &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27018&#x2F;mongo.keyfile</span><br><span class="line">    #开启认证方式运行</span><br><span class="line">    authorization: enabled</span><br></pre></td></tr></table></figure><p>/mongodb/replica_sets/myrs_27019/mongod.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line">    #KeyFile鉴权文件</span><br><span class="line">    keyFile: &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27019&#x2F;mongo.keyfile</span><br><span class="line">    #开启认证方式运行</span><br><span class="line">    authorization: enabled</span><br></pre></td></tr></table></figure><h3 id="3-3-6-重新启动副本集"><a href="#3-3-6-重新启动副本集" class="headerlink" title="3.3.6 重新启动副本集"></a>3.3.6 重新启动副本集</h3><p>如果副本集是开启状态，则先分别关闭关闭复本集中的每个mongod，从次节点开始。直到副本集的所有成员都离线，包括任何仲裁者。主节点必须是最后一个成员关闭以避免潜在的回滚。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#通过进程编号关闭三个节点</span><br><span class="line">kill -2 54410 54361 54257</span><br></pre></td></tr></table></figure><p>分别启动副本集节点：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27017&#x2F;mongod.conf</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27018&#x2F;mongod.conf</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27019&#x2F;mongod.conf</span><br></pre></td></tr></table></figure><p>查看进程情况：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost replica_sets]# ps -ef |grep mongod</span><br><span class="line">root    62425    1  5 14:43 ?     00:00:01 &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27017&#x2F;mongod.conf</span><br><span class="line">root    62495    1  7 14:43 ?     00:00:01 &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27018&#x2F;mongod.conf</span><br><span class="line">root    62567    1 11 14:43 ?     00:00:01 &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;replica_sets&#x2F;myrs_27019&#x2F;mongod.conf</span><br></pre></td></tr></table></figure><h3 id="3-3-7-在主节点上添加普通账号"><a href="#3-3-7-在主节点上添加普通账号" class="headerlink" title="3.3.7 在主节点上添加普通账号"></a>3.3.7 在主节点上添加普通账号</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#先用管理员账号登录</span><br><span class="line">#切换到admin库</span><br><span class="line">use admin</span><br><span class="line">#管理员账号认证</span><br><span class="line">db.auth(&quot;myroot&quot;,&quot;123456&quot;)</span><br><span class="line">#切换到要认证的库</span><br><span class="line">use articledb</span><br><span class="line">#添加普通用户</span><br><span class="line">db.createUser(&#123;user: &quot;bobo&quot;, pwd: &quot;123456&quot;, roles: [&quot;readWrite&quot;]&#125;)</span><br></pre></td></tr></table></figure><p>重新连接，使用普通用户 bobo重新登录，查看数据。</p><h3 id="3-3-8-SpringDataMongoDB连接副本集"><a href="#3-3-8-SpringDataMongoDB连接副本集" class="headerlink" title="3.3.8 SpringDataMongoDB连接副本集"></a>3.3.8 SpringDataMongoDB连接副本集</h3><p>使用用户名和密码连接到 MongoDB 服务器，你必须使用<code>&#39;username:password@hostname/dbname&#39;</code> 格式，’username’为用户名，’password’ 为密码。</p><p>目标：使用用户bobo使用密码 123456 连接到MongoDB 服务上。</p><p>application.yml：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">    #数据源配置</span><br><span class="line">    data:</span><br><span class="line">        mongodb:</span><br><span class="line">            #副本集有认证的情况下，字符串连接</span><br><span class="line">            uri: mongodb:&#x2F;&#x2F;bobo:123456@180.76.159.126:27017,180.76.159.126:27018,180.76.159.126:27019&#x2F;articledb?connect&#x3D;replicaSet&amp;slaveOk&#x3D;true&amp;replicaSet&#x3D;myrs</span><br></pre></td></tr></table></figure><h2 id="3-4-分片集群环境-扩展"><a href="#3-4-分片集群环境-扩展" class="headerlink" title="3.4 分片集群环境(扩展)"></a>3.4 分片集群环境(扩展)</h2><h3 id="3-4-1-关闭已开启的集群服务"><a href="#3-4-1-关闭已开启的集群服务" class="headerlink" title="3.4.1 关闭已开启的集群服务"></a>3.4.1 关闭已开启的集群服务</h3><p>分片集群环境下的安全认证和副本集环境下基本上一样。</p><p>但分片集群的服务器环境和架构较为复杂，建议在搭建分片集群的时候，直接加入安全认证和服务器间的鉴权，如果之前有数据，可先将之前的数据备份出来，再还原回去。</p><p>本文使用之前搭建好的集群服务，因此，先停止之前的集群服务</p><p>停止服务的方式有两种：快速关闭和标准关闭，下面依次说明：</p><p>（1）快速关闭方法（快速，简单，数据可能会出错）</p><p>目标：通过系统的kill命令直接杀死进程：</p><p>依次杀死 mongos路由、配置副本集服务，分片副本集服务，从次节点开始。直到所有成员都离线。副本集杀的时候，建议先杀仲裁者，再杀副本节点，最后是主节点，以避免潜在的回滚。杀完要检查一下，避免有的没有杀掉。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#通过进程编号关闭节点</span><br><span class="line">kill -2 54410</span><br></pre></td></tr></table></figure><p>【补充】</p><p>如果一旦是因为数据损坏，则需要进行如下操作（了解）：</p><p>1）删除lock文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rm -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27018&#x2F;data&#x2F;db&#x2F;*.lock \</span><br><span class="line">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27118&#x2F;data&#x2F;db&#x2F;*.lock \</span><br><span class="line">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27218&#x2F;data&#x2F;db&#x2F;mongod.lock \</span><br><span class="line">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27318&#x2F;data&#x2F;db&#x2F;mongod.lock \</span><br><span class="line">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27418&#x2F;data&#x2F;db&#x2F;mongod.lock \</span><br><span class="line">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27518&#x2F;data&#x2F;db&#x2F;mongod.lock \</span><br><span class="line">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27019&#x2F;data&#x2F;db&#x2F;mongod.lock \</span><br><span class="line">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27119&#x2F;data&#x2F;db&#x2F;mongod.lock \</span><br><span class="line">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27219&#x2F;data&#x2F;db&#x2F;mongod.lock</span><br></pre></td></tr></table></figure><p>2 ）依次修复数据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod --repair --</span><br><span class="line">dbpath&#x3D;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27018&#x2F;data&#x2F;db</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod --repair --</span><br><span class="line">dbpath&#x3D;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27118&#x2F;data&#x2F;db</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod --repair --</span><br><span class="line">dbpath&#x3D;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27218&#x2F;data&#x2F;db</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod --repair --</span><br><span class="line">dbpath&#x3D;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27318&#x2F;data&#x2F;db</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod --repair --</span><br><span class="line">dbpath&#x3D;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27418&#x2F;data&#x2F;db</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod --repair --</span><br><span class="line">dbpath&#x3D;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27518&#x2F;data&#x2F;db</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod --repair --</span><br><span class="line">dbpath&#x3D;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27019&#x2F;data&#x2F;db</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod --repair --</span><br><span class="line">dbpath&#x3D;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27119&#x2F;data&#x2F;db</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod --repair --</span><br><span class="line">dbpath&#x3D;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27219&#x2F;data&#x2F;db</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod --repair --</span><br><span class="line">dbpath&#x3D;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27017&#x2F;data&#x2F;db</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod --repair --</span><br><span class="line">dbpath&#x3D;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27117&#x2F;data&#x2F;db</span><br></pre></td></tr></table></figure><p>（2）标准的关闭方法（数据不容易出错，但麻烦）：</p><p>目标：通过mongo客户端中的shutdownServer命令来依次关闭各个服务</p><p>关闭分片服务器副本集中的服务，建议依次关闭仲裁节点、副本节点、主节点。主要的操作步骤参考如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;客户端登录服务，注意，这里通过localhost登录，如果需要远程登录，必须先登录认证才行。</span><br><span class="line">mongo --port 27018</span><br><span class="line">&#x2F;&#x2F;告知副本集说本机要下线</span><br><span class="line">rs.stepDown()</span><br><span class="line">&#x2F;&#x2F;#切换到admin库</span><br><span class="line">use admin</span><br><span class="line">&#x2F;&#x2F;关闭服务</span><br><span class="line">db.shutdownServer()</span><br></pre></td></tr></table></figure><p>关闭配置服务器副本集的服务，建议依次关闭副本节点、主节点。主要的操作步骤参考如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;客户端登录服务，注意，这里通过localhost登录，如果需要远程登录，必须先登录认证才行。</span><br><span class="line">mongo --port 27019</span><br><span class="line">&#x2F;&#x2F;告知副本集说本机要下线</span><br><span class="line">rs.stepDown()</span><br><span class="line">&#x2F;&#x2F;#切换到admin库</span><br><span class="line">use admin</span><br><span class="line">&#x2F;&#x2F;关闭服务</span><br><span class="line">db.shutdownServer()</span><br></pre></td></tr></table></figure><p>关闭路由服务器的服务，建议依次关闭两个路由节点。主要的操作步骤参考如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;客户端登录服务，注意，这里通过localhost登录，如果需要远程登录，必须先登录认证才行。</span><br><span class="line">mongo --port 27017</span><br><span class="line">&#x2F;&#x2F;告知副本集说本机要下线</span><br><span class="line">rs.stepDown()</span><br><span class="line">&#x2F;&#x2F;#切换到admin库</span><br><span class="line">use admin</span><br><span class="line">&#x2F;&#x2F;关闭服务</span><br><span class="line">db.shutdownServer()</span><br></pre></td></tr></table></figure><h3 id="3-4-2-创建副本集认证的key文件"><a href="#3-4-2-创建副本集认证的key文件" class="headerlink" title="3.4.2 创建副本集认证的key文件"></a>3.4.2 创建副本集认证的key文件</h3><p>第一步：生成一个key文件到当前文件夹中。</p><p>可以使用任何方法生成密钥文件。例如，以下操作使用openssl生成密码文件，然后使用chmod来更改文件权限，仅为文件所有者提供读取权限</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost ~]# openssl rand -base64 90 -out .&#x2F;mongo.keyfile</span><br><span class="line">[root@bobohost ~]# chmod 400 .&#x2F;mongo.keyfile</span><br><span class="line">[root@bobohost ~]# ll mongo.keyfile</span><br><span class="line">-r--------. 1 root root 122 8月  14 14:23 mongo.keyfile</span><br></pre></td></tr></table></figure><p>提示：</p><p>所有副本集节点都必须要用同一份keyfile，一般是在一台机器上生成，然后拷贝到其他机器上，且必须<br>有读的权限，否则将来会报错： permissions on /mongodb/replica_sets/myrs_27017/mongo.keyfile are too open</p><p>一定要保证密钥文件一致，文件位置随便。但是为了方便查找，建议每台机器都放到一个固定的位置，都放到和配置文件一起的目录中。</p><p>这里将该文件分别拷贝到多个目录中：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">echo &#39;&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27018&#x2F;mongo.keyfile</span><br><span class="line">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27118&#x2F;mongo.keyfile</span><br><span class="line">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27218&#x2F;mongo.keyfile</span><br><span class="line">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27318&#x2F;mongo.keyfile</span><br><span class="line">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27418&#x2F;mongo.keyfile</span><br><span class="line">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27518&#x2F;mongo.keyfile</span><br><span class="line">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27019&#x2F;mongo.keyfile</span><br><span class="line">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27119&#x2F;mongo.keyfile</span><br><span class="line">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27219&#x2F;mongo.keyfile</span><br><span class="line">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27017&#x2F;mongo.keyfile</span><br><span class="line">&#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27117&#x2F;mongo.keyfile&#39; | xargs -n 1 cp -v &#x2F;root&#x2F;mongo.keyfile</span><br></pre></td></tr></table></figure><h3 id="3-4-3-修改配置文件指定keyfile"><a href="#3-4-3-修改配置文件指定keyfile" class="headerlink" title="3.4.3 修改配置文件指定keyfile"></a>3.4.3 修改配置文件指定keyfile</h3><p>分别编辑几个服务的mongod.conf文件，添加相关内容：</p><p>/mongodb/sharded_cluster/myshardrs01_27018/mongod.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line">    #KeyFile鉴权文件</span><br><span class="line">    keyFile: &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27018&#x2F;mongo.keyfile</span><br><span class="line">    #开启认证方式运行</span><br><span class="line">    authorization: enabled</span><br></pre></td></tr></table></figure><p>/mongodb/sharded_cluster/myshardrs01_27118/mongod.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line">    #KeyFile鉴权文件</span><br><span class="line">    keyFile: &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27118&#x2F;mongo.keyfile</span><br><span class="line">    #开启认证方式运行</span><br><span class="line">    authorization: enabled</span><br></pre></td></tr></table></figure><p>/mongodb/sharded_cluster/myshardrs01_27218/mongod.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line">    #KeyFile鉴权文件</span><br><span class="line">    keyFile: &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27218&#x2F;mongo.keyfile</span><br><span class="line">    #开启认证方式运行</span><br><span class="line">    authorization: enabled</span><br></pre></td></tr></table></figure><p>/mongodb/sharded_cluster/myshardrs02_27318/mongod.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line">    #KeyFile鉴权文件</span><br><span class="line">    keyFile: &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27318&#x2F;mongo.keyfile</span><br><span class="line">    #开启认证方式运行</span><br><span class="line">    authorization: enabled</span><br></pre></td></tr></table></figure><p>/mongodb/sharded_cluster/myshardrs02_27418/mongod.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line">    #KeyFile鉴权文件</span><br><span class="line">    keyFile: &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27418&#x2F;mongo.keyfile</span><br><span class="line">    #开启认证方式运行</span><br><span class="line">    authorization: enabled</span><br></pre></td></tr></table></figure><p>/mongodb/sharded_cluster/myshardrs02_27518/mongod.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line">    #KeyFile鉴权文件</span><br><span class="line">    keyFile: &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27518&#x2F;mongo.keyfile</span><br><span class="line">    #开启认证方式运行</span><br><span class="line">    authorization: enabled</span><br></pre></td></tr></table></figure><p>/mongodb/sharded_cluster/myconfigrs_27019/mongod.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line">    #KeyFile鉴权文件</span><br><span class="line">    keyFile: &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27019&#x2F;mongo.keyfile</span><br><span class="line">    #开启认证方式运行</span><br><span class="line">    authorization: enabled</span><br></pre></td></tr></table></figure><p>/mongodb/sharded_cluster/myconfigrs_27119/mongod.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line">    #KeyFile鉴权文件</span><br><span class="line">    keyFile: &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27119&#x2F;mongo.keyfile</span><br><span class="line">    #开启认证方式运行</span><br><span class="line">    authorization: enabled</span><br></pre></td></tr></table></figure><p>/mongodb/sharded_cluster/myconfigrs_27219/mongod.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line">    #KeyFile鉴权文件</span><br><span class="line">    keyFile: &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27219&#x2F;mongo.keyfile</span><br><span class="line">    #开启认证方式运行</span><br><span class="line">    authorization: enabled</span><br></pre></td></tr></table></figure><p>/mongodb/sharded_cluster/mymongos_27017/mongos.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line">    #KeyFile鉴权文件</span><br><span class="line">    keyFile: &#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27017&#x2F;mongo.keyfile</span><br></pre></td></tr></table></figure><p>/mongodb/sharded_cluster/mymongos_27117/mongos.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line">    #KeyFile鉴权文件</span><br><span class="line">    keyFile: &#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27117&#x2F;mongo.keyfile</span><br></pre></td></tr></table></figure><p>mongos 比mongod少了authorization：enabled的配置。原因是，副本集加分片的安全认证需要配置两方面的，副本集各个节点之间使用内部身份验证，用于内部各个mongo实例的通信，只有相同keyfile才能相互访问。所以都要开启 keyFile: /mongodb/sharded_cluster/mymongos_27117/mongo.keyfile 。</p><p>然而对于所有的mongod，才是真正的保存数据的分片。mongos只做路由，不保存数据。所以所有的mongod开启访问数据的授权authorization:enabled。这样用户只有账号密码正确才能访问到数据。</p><h3 id="3-4-4-重新启动节点"><a href="#3-4-4-重新启动节点" class="headerlink" title="3.4.4 重新启动节点"></a>3.4.4 重新启动节点</h3><p>必须依次启动配置节点、分片节点、路由节点：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27019&#x2F;mongod.conf</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27119&#x2F;mongod.conf</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myconfigrs_27219&#x2F;mongod.conf</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27018&#x2F;mongod.conf</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27118&#x2F;mongod.conf</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs01_27218&#x2F;mongod.conf</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27318&#x2F;mongod.conf</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27418&#x2F;mongod.conf</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;myshardrs02_27518&#x2F;mongod.conf</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongos -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27017&#x2F;mongos.conf</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongos -f &#x2F;mongodb&#x2F;sharded_cluster&#x2F;mymongos_27117&#x2F;mongos.conf</span><br></pre></td></tr></table></figure><p>注意：</p><p>这里有个非常特别的情况，就是启动顺序。先启动配置节点，再启动分片节点，最后启动路由节点。</p><p>如果先启动分片节点，会卡住，提示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">about to fork child process, waiting until server is ready for connections</span><br></pre></td></tr></table></figure><p>这也许是个 bug。原因未知。</p><h3 id="3-3-5-创建帐号和认证"><a href="#3-3-5-创建帐号和认证" class="headerlink" title="3.3.5 创建帐号和认证"></a>3.3.5 创建帐号和认证</h3><p>客户端mongo，通过localhost登录任意一个mongos路由，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost db]# &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongo --port 27017</span><br></pre></td></tr></table></figure><p>提示：相当于一个后门，只能在 admin下添加用户。</p><p>创建一个管理员帐号：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">mongos&gt;  db.createUser(&#123;user:&quot;myroot&quot;,pwd:&quot;123456&quot;,roles:[&quot;root&quot;]&#125;)</span><br><span class="line">Successfully added user: &#123; &quot;user&quot; : &quot;myroot&quot;, &quot;roles&quot; : [ &quot;root&quot; ] &#125;</span><br></pre></td></tr></table></figure><p>提示：如果在开启认证之前已经创建了管理员账号，这里可以忽略</p><p>创建一个普通权限帐号：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">mongos&gt; db.auth(&quot;myroot&quot;,&quot;123456&quot;)</span><br><span class="line">1</span><br><span class="line">mongos&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">mongos&gt; db.createUser(&#123;user: &quot;bobo&quot;, pwd: &quot;123456&quot;, roles: [&#123; role: &quot;readWrite&quot;,db: &quot;articledb&quot; &#125;]&#125;)</span><br><span class="line">Successfully added user: &#123;</span><br><span class="line">    &quot;user&quot; : &quot;bobo&quot;,</span><br><span class="line">    &quot;roles&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;role&quot; : &quot;readWrite&quot;,</span><br><span class="line">          &quot;db&quot; : &quot;articledb&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">mongos&gt; db.auth(&quot;bobo&quot;,&quot;123456&quot;)</span><br><span class="line">1</span><br></pre></td></tr></table></figure><p>提示：</p><p>通过mongos添加的账号信息，只会保存到配置节点的服务中，具体的数据节点不保存账号信息，因此，分片中的账号信息不涉及到同步问题。</p><p>mongo客户端登录mongos路由，用管理员帐号登录可查看分片情况：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">mongos&gt;  db.auth(&quot;myroot&quot;,&quot;123456&quot;)</span><br><span class="line">1</span><br><span class="line">mongos&gt; sh.status()</span><br></pre></td></tr></table></figure><p>退出连接，重新连接服务，使用普通权限帐号访问数据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@bobohost db]# &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongo --host 180.76.159.126 --port 27017</span><br><span class="line">MongoDB shell version v4.0.10</span><br><span class="line">connecting to: mongodb:&#x2F;&#x2F;180.76.159.126:27017&#x2F;?gssapiServiceName&#x3D;mongodb</span><br><span class="line">Implicit session: session &#123; &quot;id&quot; : UUID(&quot;6f84fa91-2414-407e-b3ab-c0b7eedde825&quot;)</span><br><span class="line">&#125;</span><br><span class="line">MongoDB server version: 4.0.10</span><br><span class="line">mongos&gt; use articledb</span><br><span class="line">switched to db articledb</span><br><span class="line">mongos&gt; db.auth(&quot;bobo&quot;,&quot;123456&quot;)</span><br><span class="line">1</span><br><span class="line">mongos&gt; show collections</span><br><span class="line">comment</span><br><span class="line">comment2</span><br><span class="line">mongos&gt; db.comment.count()</span><br><span class="line">10001</span><br></pre></td></tr></table></figure><h3 id="3-3-6-SpringDataMongoDB连接认证"><a href="#3-3-6-SpringDataMongoDB连接认证" class="headerlink" title="3.3.6 SpringDataMongoDB连接认证"></a>3.3.6 SpringDataMongoDB连接认证</h3><p>使用用户名和密码连接到 MongoDB 服务器，你必须使用<code>&#39;username:password@hostname/dbname&#39;</code> 格式，’username’为用户名，’password’ 为密码。</p><p>目标：使用用户bobo使用密码 123456 连接到MongoDB 服务上。</p><p>application.yml：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">    #数据源配置</span><br><span class="line">    data:</span><br><span class="line">        mongodb:</span><br><span class="line">        # 分片集群有认证的情况下，字符串连接</span><br><span class="line">        uri: mongodb:&#x2F;&#x2F;bobo:123456@180.76.159.126:27017,180.76.159.126:27117&#x2F;articledb</span><br></pre></td></tr></table></figure><p>原文链接：<a href="https://wgy1993.gitee.io/archives/afe7047c.html" target="_blank" rel="noopener">https://wgy1993.gitee.io/archives/afe7047c.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;MongoDB-二&quot;&gt;&lt;a href=&quot;#MongoDB-二&quot; class=&quot;headerlink&quot; title=&quot;MongoDB(二)&quot;&gt;&lt;/a&gt;MongoDB(二)&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://wgy1993.gitee.io/archiv
      
    
    </summary>
    
    
      <category term="mongodb" scheme="http://yoursite.com/categories/mongodb/"/>
    
    
      <category term="mongodb" scheme="http://yoursite.com/tags/mongodb/"/>
    
  </entry>
  
  <entry>
    <title>mongodb一</title>
    <link href="http://yoursite.com/2021/03/01/mongodb/mongodb01/"/>
    <id>http://yoursite.com/2021/03/01/mongodb/mongodb01/</id>
    <published>2021-03-01T14:10:22.526Z</published>
    <updated>2021-03-01T14:10:22.518Z</updated>
    
    <content type="html"><![CDATA[<h1 id="MongoDB-一"><a href="#MongoDB-一" class="headerlink" title="MongoDB(一)"></a>MongoDB(一)</h1><p><a href="https://wgy1993.gitee.io/archives/d69f1e.html" target="_blank" rel="noopener">2020-09-12</a></p><h1 id="1-MongoDB-相关概念"><a href="#1-MongoDB-相关概念" class="headerlink" title="1. MongoDB 相关概念"></a>1. MongoDB 相关概念</h1><h2 id="1-1-业务应用场景"><a href="#1-1-业务应用场景" class="headerlink" title="1.1 业务应用场景"></a>1.1 业务应用场景</h2><p>传统的关系型数据库（如MySQL），在数据操作的“三高”需求以及应对Web2.0的网站需求面前，显得力不从心。</p><p>解释：“三高”需求：</p><ul><li>High performance - 对数据库高并发读写的需求。</li><li>Huge Storage - 对海量数据的高效率存储和访问的需求。</li><li>High Scalability &amp;&amp; High Availability- 对数据库的高可扩展性和高可用性的需求。</li></ul><p><strong>而MongoDB可应对“三高”需求。</strong></p><p>具体的应用场景如：</p><ul><li>社交场景，使用 MongoDB 存储存储用户信息，以及用户发表的朋友圈信息，通过地理位置索引实现附近的人、地点等功能。</li><li>游戏场景，使用 MongoDB 存储游戏用户信息，用户的装备、积分等直接以内嵌文档的形式存储，方便查询、高效率存储和访问。</li><li>物流场景，使用 MongoDB 存储订单信息，订单状态在运送过程中会不断更新，以 MongoDB 内嵌数组的形式来存储，一次查询就能将订单所有的变更读取出来。</li><li>物联网场景，使用 MongoDB 存储所有接入的智能设备信息，以及设备汇报的日志信息，并对这些信息进行多维度的分析。</li><li>视频直播，使用 MongoDB 存储用户信息、点赞互动信息等。</li></ul><p>这些应用场景中，数据操作方面的共同特点是：</p><ul><li>数据量大</li><li>写入操作频繁（读写都很频繁）</li><li>价值较低的数据，对事务性要求不高</li></ul><p>对于这样的数据，我们更适合使用MongoDB来实现数据的存储。</p><p><strong>什么时候选择MongoDB</strong></p><p>在架构选型上，除了上述的三个特点外，如果你还犹豫是否要选择它？可以考虑以下的一些问题：</p><ul><li>应用不需要事务及复杂 join 支持</li><li>新应用，需求会变，数据模型无法确定，想快速迭代开发</li><li>应用需要2000-3000以上的读写QPS（更高也可以）</li><li>应用需要TB甚至 PB 级别数据存储</li><li>应用发展迅速，需要能快速水平扩展</li><li>应用要求存储的数据不丢失</li><li>应用需要99.999%高可用</li><li>应用需要大量的地理位置查询、文本查询</li></ul><p>如果上述有1个符合，可以考虑 MongoDB，2个及以上的符合，选择 MongoDB 绝不会后悔。</p><h2 id="1-2-MongoDB-简介"><a href="#1-2-MongoDB-简介" class="headerlink" title="1.2 MongoDB 简介"></a>1.2 MongoDB 简介</h2><p>MongoDB是一个开源、高性能、无模式的文档型数据库，当初的设计就是用于简化开发和方便扩展，是NoSQL数据库产品中的一种。是最像关系型数据库（MySQL）的非关系型数据库。</p><p>它支持的数据结构非常松散，是一种类似于 JSON 的 格式叫BSON，所以它既可以存储比较复杂的数据类型，又相当的灵活。</p><p>MongoDB中的记录是一个文档，它是一个由字段和值对（field:value）组成的数据结构。MongoDB文档类似于JSON对象，即一个文档认为就是一个对象。字段的数据类型是字符型，它的值除了使用基本的一些类型外，还可以包括其他文档、普通数组和文档数组。</p><h2 id="1-3-体系结构"><a href="#1-3-体系结构" class="headerlink" title="1.3 体系结构"></a>1.3 体系结构</h2><p>MySQL和MongoDB对比</p><p><img src="https://img-blog.csdnimg.cn/20200912222258123.png" alt="image-20200912105858071"></p><table><thead><tr><th>SQL 术语/概念</th><th>MongoDB术语/概念</th><th>解释/说明</th></tr></thead><tbody><tr><td>database</td><td>database</td><td>数据库</td></tr><tr><td>table</td><td>collection</td><td>数据库表/集合</td></tr><tr><td>row</td><td>document</td><td>数据记录行/文档</td></tr><tr><td>column</td><td>field</td><td>数据字段/域</td></tr><tr><td>index</td><td>index</td><td>索引</td></tr><tr><td>table joins</td><td></td><td>表连接,MongoDB不支持</td></tr><tr><td></td><td>嵌入文档</td><td>MongoDB通过嵌入式文档来替代多表连接</td></tr><tr><td>primary key</td><td>primary key</td><td>主键,MongoDB自动将_id字段设置为主键</td></tr></tbody></table><h2 id="1-4-数据模型"><a href="#1-4-数据模型" class="headerlink" title="1.4 数据模型"></a>1.4 数据模型</h2><p>MongoDB的最小存储单位就是文档(document)对象。文档(document)对象对应于关系型数据库的行。数据在MongoDB中以BSON（Binary-JSON）文档的格式存储在磁盘上。</p><p>BSON（Binary Serialized Document Format）是一种类json的一种二进制形式的存储格式，简称Binary JSON。BSON和JSON一样，支持内嵌的文档对象和数组对象，但是BSON有JSON没有的一些数据类型，如Date和BinData类型。</p><p>BSON采用了类似于 C 语言结构体的名称、对表示方法，支持内嵌的文档对象和数组对象，具有轻量性、可遍历性、高效性的三个特点，可以有效描述非结构化数据和结构化数据。这种格式的优点是灵活性高，但它的缺点是空间利用率不是很理想。</p><p>Bson中，除了基本的JSON类型：string,integer,boolean,double,null,array和object，mongo还使用了特殊的数据类型。这些类型包括date,object id,binary data,regular expression 和code。每一个驱动都以特定语言的方式实现了这些类型，查看你的驱动的文档来获取详细信息。</p><p>BSON数据类型参考列表：</p><table><thead><tr><th>数据类型</th><th>描述</th><th>举例</th></tr></thead><tbody><tr><td>字符串</td><td>UTF-8字符串都可表示为字符串类型的数据</td><td>{“x” : “foobar”}</td></tr><tr><td>对象id</td><td>对象id是文档的12字节的唯一 ID</td><td>{“X” :ObjectId() }</td></tr><tr><td>布尔值</td><td>真或者假：true或者false</td><td>{“x”:true}</td></tr><tr><td>数组</td><td>值的集合或者列表可以表示成数组</td><td>{“x” ： [“a”, “b”, “c”]}</td></tr><tr><td>32位整数</td><td>类型不可用。JavaScript仅支持64位浮点数，所以32位整数会被自动转换。</td><td>shell是不支持该类型的，shell中默认会转换成64位浮点数</td></tr><tr><td>64位整数</td><td>不支持这个类型。shell会使用一个特殊的内嵌文档来显示64位整数</td><td>shell是不支持该类型的，shell中默认会转换成64位浮点数</td></tr><tr><td>64位浮点数</td><td>shell中的数字就是这一种类型</td><td>{“x”：3.14159，”y”：3}</td></tr><tr><td>null</td><td>表示空值或者未定义的对象</td><td>{“x”:null}</td></tr><tr><td>undefined</td><td>文档中也可以使用未定义类型</td><td>{“x”:undefined}</td></tr><tr><td>符号</td><td>shell不支持，shell会将数据库中的符号类型的数据自动转换成字符串</td><td></td></tr><tr><td>正则表达式</td><td>文档中可以包含正则表达式，采用JavaScript的正则表达式语法</td><td>{“x” ： /foobar/i}</td></tr><tr><td>代码</td><td>文档中还可以包含JavaScript代码</td><td>{“x” ： function() { /* …… */ }}</td></tr><tr><td>二进制数据</td><td>二进制数据可以由任意字节的串组成，不过shell中无法使用</td><td></td></tr><tr><td>最大值/最小值</td><td>BSON包括一个特殊类型，表示可能的最大值。shell中没有这个类型。</td><td></td></tr></tbody></table><p>提示：</p><p>shell默认使用64位浮点型数值。{“x”：3.14}或{“x”：3}。对于整型值，可以使用NumberInt（4字节符号整数）或NumberLong（8字节符号整数），{“x”:NumberInt(“3”)}{“x”:NumberLong(“3”)}</p><h2 id="1-5-MongoDB-的特点"><a href="#1-5-MongoDB-的特点" class="headerlink" title="1.5 MongoDB 的特点"></a>1.5 MongoDB 的特点</h2><p>MongoDB主要有如下特点：</p><ul><li><p>高性能：</p><p>MongoDB提供高性能的数据持久性。特别是</p><p>对嵌入式数据模型的支持减少了数据库系统上的I/O活动。</p><p>索引支持更快的查询，并且可以包含来自嵌入式文档和数组的键。（文本索引解决搜索的需求、TTL索引解决历史数据自动过期的需求、地理位置索引可用于构建各种 O2O 应用）</p><p>mmapv1、wiredtiger、mongorocks（rocksdb）、in-memory 等多引擎支持满足各种场景需求。</p><p>Gridfs解决文件存储的需求。</p></li><li><p>高可用性：</p><p>MongoDB的复制工具称为副本集（replica set），它可提供自动故障转移和数据冗余。</p></li><li><p>高扩展性：</p><p>MongoDB提供了水平可扩展性作为其核心功能的一部分。</p><p>分片将数据分布在一组集群的机器上。（海量数据存储，服务能力水平扩展）</p><p>从3.4开始，MongoDB支持基于片键创建数据区域。在一个平衡的集群中，MongoDB将一个区域所覆盖的读写只定向到该区域内的那些片。</p></li><li><p>丰富的查询支持：</p><p>MongoDB支持丰富的查询语言，支持读和写操作(CRUD)，比如数据聚合、文本搜索和地理空间查询等。</p></li><li><p>其他特点：如无模式（动态模式）、灵活的文档模型、</p></li></ul><h1 id="2-单机部署"><a href="#2-单机部署" class="headerlink" title="2. 单机部署"></a>2. 单机部署</h1><h2 id="2-1-Windows-系统中的安装启动"><a href="#2-1-Windows-系统中的安装启动" class="headerlink" title="2.1 Windows 系统中的安装启动"></a>2.1 Windows 系统中的安装启动</h2><h3 id="2-1-1-下载安装包"><a href="#2-1-1-下载安装包" class="headerlink" title="2.1.1 下载安装包"></a>2.1.1 下载安装包</h3><p>MongoDB 提供了可用于 32 位和 64 位系统的预编译二进制包，你可以从MongoDB官网下载安装，MongoDB 预编译二进制包下地址：<a href="https://www.mongodb.com/download-center#community" target="_blank" rel="noopener">https://www.mongodb.com/download-center#community</a></p><p><img src="https://img-blog.csdnimg.cn/20200912222345916.png" alt="image-20200912113819545"></p><p>根据上图所示下载 zip 包。</p><p>提示：版本的选择：</p><p>MongoDB的版本命名规范如：x.y.z；</p><p>y为奇数时表示当前版本为开发版，如：1.5.2、4.1.13；</p><p>y为偶数时表示当前版本为稳定版，如：1.6.3、4.0.10；</p><p>z是修正版本号，数字越大越好。</p><p>详情： <a href="http://docs.mongodb.org/manual/release-notes/#release-version-numbers" target="_blank" rel="noopener">http://docs.mongodb.org/manual/release-notes/#release-version-numbers</a></p><h3 id="2-1-2-解压安装启动"><a href="#2-1-2-解压安装启动" class="headerlink" title="2.1.2 解压安装启动"></a>2.1.2 解压安装启动</h3><p>将压缩包解压到一个目录中。在解压目录中，手动建立一个目录用于存放数据文件，如 data/db</p><p><strong>方式1：命令行参数方式启动服务</strong></p><p>在 bin 目录中打开命令行提示符，输入如下命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --dbpath&#x3D;..\data\db</span><br></pre></td></tr></table></figure><p>我们在启动信息中可以看到， mongoDB的默认端口是27017，如果我们想改变默认的启动端口，可以通过–port来指定端口。</p><p>为了方便我们每次启动，可以将安装目录的bin目录设置到环境变量的path中， bin 目录下是一些常用命令，比如 mongod 启动服务用的，mongo 客户端连接服务用的。</p><p><strong>方式2：配置文件方式启动服务</strong></p><p>在解压目录中新建 config 文件夹，该文件夹中新建配置文件 mongod.conf ，内如参考如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">storage:</span><br><span class="line">    #The directory where the mongod instance stores its data.Default Value is &quot;\data\db&quot; on Windows.</span><br><span class="line">    dbPath: D:\mongodb-win32-x86_64-2008plus-ssl-4.0.1\data</span><br></pre></td></tr></table></figure><p>详细配置项内容可以参考官方文档： <a href="https://docs.mongodb.com/manual/reference/configuration-options/" target="_blank" rel="noopener">https://docs.mongodb.com/manual/reference/configuration-options/</a></p><p><strong>【注意】</strong></p><ul><li><p>配置文件中如果使用双引号，比如路径地址，自动会将双引号的内容转义。如果不转义，则会报错：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error-parsing-yaml-config-file-yaml-cpp-error-at-line-3-column-15-unknown-escape-character-d</span><br></pre></td></tr></table></figure><p>解决：</p><p>a. 对 \ 换成 / 或 \</p><p>b. 如果路径中没有空格，则无需加引号。</p></li><li><p>配置文件中不能以Tab分割字段</p><p>解决：</p><p>将其转换成空格。</p></li></ul><p>启动方式：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mongod -f ..&#x2F;config&#x2F;mongod.conf</span><br><span class="line">或</span><br><span class="line">mongod --config ..&#x2F;config&#x2F;mongod.conf</span><br></pre></td></tr></table></figure><p>更多参数配置：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">    destination: file</span><br><span class="line">    #The path of the log file to which mongod or mongos should send all diagnostic logging information</span><br><span class="line">    path: &quot;D:&#x2F;mongodb-win32-x86_64-2008plus-ssl-4.0.1&#x2F;log&#x2F;mongod.log&quot;</span><br><span class="line">    logAppend: true</span><br><span class="line">storage:</span><br><span class="line">    journal:</span><br><span class="line">      enabled: true</span><br><span class="line">    #The directory where the mongod instance stores its data.Default Value is &quot;&#x2F;data&#x2F;db&quot;.</span><br><span class="line">    dbPath: &quot;D:&#x2F;mongodb-win32-x86_64-2008plus-ssl-4.0.1&#x2F;data&quot;</span><br><span class="line">net:</span><br><span class="line">    #bindIp: 127.0.0.1</span><br><span class="line">    port: 27017</span><br><span class="line">setParameter:</span><br><span class="line">    enableLocalhostAuthBypass: false</span><br></pre></td></tr></table></figure><h2 id="2-2-Shell-连接-mongo命令"><a href="#2-2-Shell-连接-mongo命令" class="headerlink" title="2.2 Shell 连接(mongo命令)"></a>2.2 Shell 连接(mongo命令)</h2><p>在命令提示符输入以下shell命令即可完成登陆</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mongo</span><br><span class="line">或</span><br><span class="line">mongo --host&#x3D;127.0.0.1 --port&#x3D;27017</span><br></pre></td></tr></table></figure><h3 id="2-2-1-查看已经有的数据库"><a href="#2-2-1-查看已经有的数据库" class="headerlink" title="2.2.1 查看已经有的数据库"></a>2.2.1 查看已经有的数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show databases</span><br></pre></td></tr></table></figure><h3 id="2-2-2-退出-mongodb"><a href="#2-2-2-退出-mongodb" class="headerlink" title="2.2.2 退出 mongodb"></a>2.2.2 退出 mongodb</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br></pre></td></tr></table></figure><p>更多参数可以通过帮助查看：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo --help</span><br></pre></td></tr></table></figure><p>提示：</p><p>MongoDB javascript shell是一个基于javascript的解释器，故是支持js程序的。</p><h2 id="2-3-Compass-图形化界面客户端"><a href="#2-3-Compass-图形化界面客户端" class="headerlink" title="2.3 Compass- 图形化界面客户端"></a>2.3 Compass- 图形化界面客户端</h2><p>到MongoDB官网下载MongoDB Compass，地址： <a href="https://www.mongodb.com/download-center/v2/compass?initial=true" target="_blank" rel="noopener">https://www.mongodb.com/download-center/v2/compass?initial=true</a></p><p>如果是下载安装版，则按照步骤安装；如果是下载加压缩版，直接解压，执行里面的MongoDBCompassCommunity.exe 文件即可。</p><p>在打开的界面中，输入主机地址、端口等相关信息，点击连接：</p><p><img src="https://img-blog.csdnimg.cn/20200912222408267.png" alt="image-20200912120121079"></p><h2 id="2-4-Linux-系统中的安装启动和连接"><a href="#2-4-Linux-系统中的安装启动和连接" class="headerlink" title="2.4 Linux 系统中的安装启动和连接"></a>2.4 Linux 系统中的安装启动和连接</h2><p>目标：在Linux中部署一个单机的MongoDB，作为生产环境下使用。</p><p>提示：和Windows下操作差不多。</p><p>步骤如下：</p><ul><li><p>先到官网下载压缩包 mongod -linux-x86_64-4.0.10.tgz 。</p></li><li><p>上传压缩包到Linux中，解压到当前目录：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf mongodb-linux-x86_64-4.0.10.tgz</span><br></pre></td></tr></table></figure></li><li><p>移动解压后的文件夹到指定的目录中：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv mongodb-linux-x86_64-4.0.10 &#x2F;usr&#x2F;local&#x2F;mongodb</span><br></pre></td></tr></table></figure></li><li><p>新建几个目录，分别用来存储数据和日志：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#数据存储目录</span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;single&#x2F;data&#x2F;db</span><br><span class="line">#日志存储目录</span><br><span class="line">mkdir -p &#x2F;mongodb&#x2F;single&#x2F;log</span><br></pre></td></tr></table></figure></li><li><p>新建并修改配置文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;mongodb&#x2F;single&#x2F;mongod.conf</span><br></pre></td></tr></table></figure><p>配置文件的内容如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">      #MongoDB发送所有日志输出的目标指定为文件</span><br><span class="line">      # #The path of the log file to which mongod or mongos should send all diagnostic logging information</span><br><span class="line">      destination: file</span><br><span class="line">      #mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径</span><br><span class="line">      path: &quot;&#x2F;mongodb&#x2F;single&#x2F;log&#x2F;mongod.log&quot;</span><br><span class="line">      #当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。</span><br><span class="line">      logAppend: true</span><br><span class="line">storage:</span><br><span class="line">      #mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。</span><br><span class="line">      ##The directory where the mongod instance stores its data.Default Value is &quot;&#x2F;data&#x2F;db&quot;.</span><br><span class="line">      dbPath: &quot;&#x2F;mongodb&#x2F;single&#x2F;data&#x2F;db&quot;</span><br><span class="line">      journal:</span><br><span class="line">          #启用或禁用持久性日志以确保数据文件保持有效和可恢复。</span><br><span class="line">          enabled: true</span><br><span class="line">processManagement:</span><br><span class="line">      #启用在后台运行mongos或mongod进程的守护进程模式。</span><br><span class="line">      fork: true</span><br><span class="line">net:</span><br><span class="line">      #服务实例绑定的IP，默认是localhost</span><br><span class="line">      bindIp: localhost,192.168.142.128</span><br><span class="line">      #bindIp</span><br><span class="line">      #绑定的端口，默认是27017</span><br><span class="line">      port: 27017</span><br></pre></td></tr></table></figure></li><li><p>启动MongoDB服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin&#x2F;mongod -f &#x2F;mongodb&#x2F;single&#x2F;mongod.conf</span><br></pre></td></tr></table></figure><p>注意：</p><p>如果启动后不是 successfully ，则是启动失败了。原因基本上就是配置文件有问题。</p><p>通过进程来查看服务是否启动了：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef |grep mongod</span><br></pre></td></tr></table></figure></li><li><p>分别使用mongo命令和compass工具来连接测试。</p><p>提示：如果远程连接不上，需要配置防火墙放行，或直接关闭linux防火墙</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#查看防火墙状态</span><br><span class="line">systemctl status firewalld</span><br><span class="line">#临时关闭防火墙</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">#开机禁止启动防火墙</span><br><span class="line">systemctl disable firewalld</span><br></pre></td></tr></table></figure></li><li><p>停止关闭服务</p><p>停止服务的方式有两种：快速关闭和标准关闭，下面依次说明：</p><p><strong>（一）快速关闭方法（快速，简单，数据可能会出错）</strong></p><p>目标：通过系统的kill命令直接杀死进程：</p><p>杀完要检查一下，避免有的没有杀掉。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#通过进程编号关闭节点</span><br><span class="line">kill -2 54410</span><br></pre></td></tr></table></figure><p>【补充】</p><p>如果一旦是因为数据损坏，则需要进行如下操作（了解）：</p><p>1）删除lock文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -f &#x2F;mongodb&#x2F;single&#x2F;data&#x2F;db&#x2F;*.lock</span><br></pre></td></tr></table></figure><p>2 ）修复数据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;mongdb&#x2F;bin&#x2F;mongod --repair --dbpath&#x3D;&#x2F;mongodb&#x2F;single&#x2F;data&#x2F;db</span><br></pre></td></tr></table></figure><p><strong>（二）标准的关闭方法（数据不容易出错，但麻烦）：</strong></p><p>目标：通过mongo客户端中的shutdownServer命令来关闭服务</p><p>主要的操作步骤参考如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;客户端登录服务，注意，这里通过localhost登录，如果需要远程登录，必须先登录认证才行。</span><br><span class="line">mongo --port 27017</span><br><span class="line">&#x2F;&#x2F;#切换到admin库</span><br><span class="line">use admin</span><br><span class="line">&#x2F;&#x2F;关闭服务</span><br><span class="line">db.shutdownServer()</span><br></pre></td></tr></table></figure></li></ul><h1 id="3-基本常用命令"><a href="#3-基本常用命令" class="headerlink" title="3. 基本常用命令"></a>3. 基本常用命令</h1><h2 id="3-1-案例需求"><a href="#3-1-案例需求" class="headerlink" title="3.1 案例需求"></a>3.1 案例需求</h2><p>存放文章评论的数据存放到MongoDB中，数据结构参考如下：</p><p>数据库：articledb</p><table><thead><tr><th>专栏文章评论</th><th>comment</th><th></th><th></th></tr></thead><tbody><tr><td>字段名称</td><td>字段含义</td><td>字段类型</td><td>备注</td></tr><tr><td>_id</td><td>ID</td><td>ObjectId或String</td><td>Mongo的主键的字段</td></tr><tr><td>articleid</td><td>文章ID</td><td>String</td><td></td></tr><tr><td>content</td><td>评论内容</td><td>String</td><td></td></tr><tr><td>userid</td><td>评论人ID</td><td>String</td><td></td></tr><tr><td>nickname</td><td>评论人昵称</td><td>String</td><td></td></tr><tr><td>createdatetime</td><td>评论的日期时间</td><td>Date</td><td></td></tr><tr><td>likenum</td><td>点赞数</td><td>Int32</td><td></td></tr><tr><td>replynum</td><td>回复数</td><td>Int32</td><td></td></tr><tr><td>state</td><td>状态</td><td>String</td><td>0：不可见；1：可见；</td></tr><tr><td>parentid</td><td>上级ID</td><td>String</td><td>如果为0表示文章的顶级评论</td></tr></tbody></table><h2 id="3-2-数据库操作"><a href="#3-2-数据库操作" class="headerlink" title="3.2 数据库操作"></a>3.2 数据库操作</h2><h3 id="3-2-1-选择和创建数据库"><a href="#3-2-1-选择和创建数据库" class="headerlink" title="3.2.1 选择和创建数据库"></a>3.2.1 选择和创建数据库</h3><p>选择和创建数据库的语法格式：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use 数据库名称</span><br></pre></td></tr></table></figure><p>如果数据库不存在则自动创建，例如，以下语句创建 articledb 数据库：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use articledb</span><br></pre></td></tr></table></figure><p>查看有权限的所有的数据库命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show dbs</span><br><span class="line">或</span><br><span class="line">show databases</span><br></pre></td></tr></table></figure><blockquote><p>注意 : 在 MongoDB 中，集合只有在内容插入后才会创建! 就是说，创建集合(数据表)后要再插入一个文档(记录)，集合才会真正创建。</p></blockquote><p>查看当前正在使用的数据库命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db</span><br></pre></td></tr></table></figure><p>MongoDB 中默认的数据库为 test，如果你没有选择数据库，集合将存放在 test 数据库中。</p><p>另外：</p><p>数据库名可以是满足以下条件的任意UTF-8字符串。</p><ul><li>不能是空字符串（ “”)。</li><li>不得含有 ‘ ‘（空格)、.、$、/、\和\0 (空字符)。</li><li>应全部小写。</li><li>最多 64字节。</li></ul><p>有一些数据库名是保留的，可以直接访问这些有特殊作用的数据库。</p><ul><li>admin ： 从权限的角度来看，这是”root”数据库。要是将一个用户添加到这个数据库，这个用户自动继承所有数据库的权限。一些特定的服务器端命令也只能从这个数据库运行，比如列出所有的数据库或者关闭服务器。</li><li>local: 这个数据永远不会被复制，可以用来存储限于本地单台服务器的任意集合</li><li>config : 当Mongo用于分片设置时，config数据库在内部使用，用于保存分片的相关信息。</li></ul><h3 id="3-2-2-数据库的删除"><a href="#3-2-2-数据库的删除" class="headerlink" title="3.2.2 数据库的删除"></a>3.2.2 数据库的删除</h3><p>MongoDB 删除数据库的语法格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.dropDatabase()</span><br></pre></td></tr></table></figure><p>提示：主要用来删除已经持久化的数据库</p><h2 id="3-3-集合操作"><a href="#3-3-集合操作" class="headerlink" title="3.3 集合操作"></a>3.3 集合操作</h2><p>集合，类似关系型数据库中的表。</p><p>可以显示的创建，也可以隐式的创建。</p><h3 id="3-3-1-集合的显式创建"><a href="#3-3-1-集合的显式创建" class="headerlink" title="3.3.1 集合的显式创建"></a>3.3.1 集合的显式创建</h3><p>基本语法格式：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.createCollection(name)</span><br></pre></td></tr></table></figure><p>参数说明：</p><ul><li>name: 要创建的集合名称</li></ul><p>例如：创建一个名为 mycollection 的普通集合。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.createCollection(&quot;mycollection&quot;)</span><br></pre></td></tr></table></figure><p>查看当前库中的表： show tables命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show collections</span><br><span class="line">或</span><br><span class="line">show tables</span><br></pre></td></tr></table></figure><p>集合的命名规范：</p><ul><li>集合名不能是空字符串 “”。</li><li>集合名不能含有 \0字符（空字符)，这个字符表示集合名的结尾。</li><li>集合名不能以 “system.”开头，这是为系统集合保留的前缀。</li><li>用户创建的集合名字不能含有保留字符。有些驱动程序的确支持在集合名里面包含，这是因为某些系统生成的集合中包含该字符。除非你要访问这种系统创建的集合，否则千万不要在名字里出现$。</li></ul><h3 id="3-3-2-集合的隐式创建"><a href="#3-3-2-集合的隐式创建" class="headerlink" title="3.3.2 集合的隐式创建"></a>3.3.2 集合的隐式创建</h3><p>当向一个集合中插入一个文档的时候，如果集合不存在，则会自动创建集合。</p><p>详见 文档的插入 章节。</p><p>提示：通常我们使用隐式创建文档即可。</p><h3 id="3-3-3-集合的删除"><a href="#3-3-3-集合的删除" class="headerlink" title="3.3.3 集合的删除"></a>3.3.3 集合的删除</h3><p>集合删除语法格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.collection.drop()</span><br><span class="line">或</span><br><span class="line">db.集合.drop()</span><br></pre></td></tr></table></figure><p>返回值</p><p>如果成功删除选定集合，则 drop() 方法返回 true，否则返回 false。</p><p>例如：要删除mycollection集合</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.mycollection.drop()</span><br></pre></td></tr></table></figure><h2 id="3-4-文档基本CRUD"><a href="#3-4-文档基本CRUD" class="headerlink" title="3.4 文档基本CRUD"></a>3.4 文档基本CRUD</h2><p>文档（document）的数据结构和 JSON 基本一样。</p><p>所有存储在集合中的数据都是 BSON 格式。</p><h3 id="3-4-1-文档的插入"><a href="#3-4-1-文档的插入" class="headerlink" title="3.4.1 文档的插入"></a>3.4.1 文档的插入</h3><h4 id="3-4-1-1-单个文档插入"><a href="#3-4-1-1-单个文档插入" class="headerlink" title="3.4.1.1 单个文档插入"></a>3.4.1.1 单个文档插入</h4><p>使用insert() 或 save() 方法向集合中插入文档，语法如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.collection.insert(</span><br><span class="line">    &lt;document or array of documents&gt;,</span><br><span class="line">    &#123;</span><br><span class="line">        writeConcern: &lt;document&gt;,</span><br><span class="line">        ordered: &lt;boolean&gt;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>参数：</p><table><thead><tr><th>Parameter</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>document</td><td>document or array</td><td>要插入到集合中的文档或文档数组。（(json格式）</td></tr><tr><td>writeConcern</td><td>document</td><td>Optional. A document expressing the write concern . Omit to use the default write concern. See Write Concern .Do not explicitly set the write concern for the operation if run in a transaction. To use write concern with transactions, see Transactions and Write Concern</td></tr><tr><td>ordered</td><td>boolean</td><td>可选。如果为真，则按顺序插入数组中的文档，如果其中一个文档出现错误，MongoDB将返回而不处理数组中的其余文档。如果为假，则执行无序插入，如果其中一个文档出现错误，则继续处理数组中的主文档。在版本2.6+中默认为true</td></tr></tbody></table><p>【示例】</p><p>要向comment的集合(表)中插入一条测试数据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.insert(&#123;&quot;articleid&quot;:&quot;100000&quot;,&quot;content&quot;:&quot;今天天气真好，阳光明媚&quot;,&quot;userid&quot;:&quot;1001&quot;,&quot;nickname&quot;:&quot;Rose&quot;,&quot;createdatetime&quot;:new Date(),&quot;likenum&quot;:NumberInt(10),&quot;state&quot;:null&#125;)</span><br></pre></td></tr></table></figure><p>提示：</p><ul><li>comment集合如果不存在，则会隐式创建</li><li>mongo中的数字，默认情况下是double类型，如果要存整型，必须使用函数NumberInt(整型数字)，否则取出来就有问题了。</li><li>插入当前日期使用 new Date()</li><li>插入的数据没有指定 _id ，会自动生成主键值</li><li>如果某字段没值，可以赋值为null，或不写该字段。</li></ul><p>执行后，如下，说明插入一个数据成功了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WriteResult(&#123; &quot;nInserted&quot; : 1 &#125;)</span><br></pre></td></tr></table></figure><p>注意：</p><ul><li>文档中的键/值对是有序的。</li><li>文档中的值不仅可以是在双引号里面的字符串，还可以是其他几种数据类型（甚至可以是整个嵌入的文档)。</li><li>MongoDB区分类型和大小写。</li><li>MongoDB的文档不能有重复的键。</li><li>文档的键是字符串。除了少数例外情况，键可以使用任意UTF-8字符。</li></ul><p>文档键命名规范：</p><ul><li>键不能含有 \0 (空字符)。这个字符用来表示键的结尾。</li><li>. 和$有特别的意义，只有在特定环境下才能使用。</li><li>以下划线 “_”开头的键是保留的(不是严格要求的)。</li></ul><h4 id="3-4-1-2-批量插入"><a href="#3-4-1-2-批量插入" class="headerlink" title="3.4.1.2 批量插入"></a>3.4.1.2 批量插入</h4><p>语法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.collection.insertMany(</span><br><span class="line">     [ &lt;document 1&gt; , &lt;document 2&gt;, ... ],</span><br><span class="line">     &#123;</span><br><span class="line">         writeConcern: &lt;document&gt;,</span><br><span class="line">         ordered: &lt;boolean&gt;</span><br><span class="line">     &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>【示例】</p><p>批量插入多条文章评论：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.comment.insertMany([</span><br><span class="line">    &#123;&quot;_id&quot;:&quot;1&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。&quot;,&quot;userid&quot;:&quot;1002&quot;,&quot;nickname&quot;:&quot;相忘于江湖&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-05T22:08:15.522Z&quot;),&quot;likenum&quot;:NumberInt(1000),&quot;state&quot;:&quot;1&quot;&#125;,</span><br><span class="line">    &#123;&quot;_id&quot;:&quot;2&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我夏天空腹喝凉开水，冬天喝温开水&quot;,&quot;userid&quot;:&quot;1005&quot;,&quot;nickname&quot;:&quot;伊人憔悴&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-05T23:58:51.485Z&quot;),&quot;likenum&quot;:NumberInt(888),&quot;state&quot;:&quot;1&quot;&#125;,</span><br><span class="line">    &#123;&quot;_id&quot;:&quot;3&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我一直喝凉开水，冬天夏天都喝。&quot;,&quot;userid&quot;:&quot;1004&quot;,&quot;nickname&quot;:&quot;杰克船长&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-06T01:05:06.321Z&quot;),&quot;likenum&quot;:NumberInt(666),&quot;state&quot;:&quot;1&quot;&#125;,</span><br><span class="line">    &#123;&quot;_id&quot;:&quot;4&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;专家说不能空腹吃饭，影响健康。&quot;,&quot;userid&quot;:&quot;1003&quot;,&quot;nickname&quot;:&quot;凯撒&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-06T08:18:35.288Z&quot;),&quot;likenum&quot;:NumberInt(2000),&quot;state&quot;:&quot;1&quot;&#125;,</span><br><span class="line">    &#123;&quot;_id&quot;:&quot;5&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;研究表明，刚烧开的水千万不能喝，因为烫嘴。&quot;,&quot;userid&quot;:&quot;1003&quot;,&quot;nickname&quot;:&quot;凯撒&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-06T11:01:02.521Z&quot;),&quot;likenum&quot;:NumberInt(3000),&quot;state&quot;:&quot;1&quot;&#125;</span><br><span class="line"> </span><br><span class="line">]);</span><br></pre></td></tr></table></figure><p>提示：</p><p>插入时指定了 _id ，则主键就是该值。</p><p>如果某条数据插入失败，将会终止插入，但已经插入成功的数据不会回滚掉。</p><p>因为批量插入由于数据较多容易出现失败，因此，可以使用try catch进行异常捕捉处理，测试的时候可以不处理。如（了解）：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">    db.comment.insertMany([</span><br><span class="line">        &#123;&quot;_id&quot;:&quot;1&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我们不应该把清晨浪费在手机上，健康很重要，一杯温水幸福你我他。&quot;,&quot;userid&quot;:&quot;1002&quot;,&quot;nickname&quot;:&quot;相忘于江湖&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-05T22:08:15.522Z&quot;),&quot;likenum&quot;:NumberInt(1000),&quot;state&quot;:&quot;1&quot;&#125;,</span><br><span class="line">        &#123;&quot;_id&quot;:&quot;2&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我夏天空腹喝凉开水，冬天喝温开水&quot;,&quot;userid&quot;:&quot;1005&quot;,&quot;nickname&quot;:&quot;伊人憔悴&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-05T23:58:51.485Z&quot;),&quot;likenum&quot;:NumberInt(888),&quot;state&quot;:&quot;1&quot;&#125;,</span><br><span class="line">        &#123;&quot;_id&quot;:&quot;3&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;我一直喝凉开水，冬天夏天都喝。&quot;,&quot;userid&quot;:&quot;1004&quot;,&quot;nickname&quot;:&quot;杰克船长&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-06T01:05:06.321Z&quot;),&quot;likenum&quot;:NumberInt(666),&quot;state&quot;:&quot;1&quot;&#125;,</span><br><span class="line">        &#123;&quot;_id&quot;:&quot;4&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;专家说不能空腹吃饭，影响健康。&quot;,&quot;userid&quot;:&quot;1003&quot;,&quot;nickname&quot;:&quot;凯撒&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-06T08:18:35.288Z&quot;),&quot;likenum&quot;:NumberInt(2000),&quot;state&quot;:&quot;1&quot;&#125;,</span><br><span class="line">        &#123;&quot;_id&quot;:&quot;5&quot;,&quot;articleid&quot;:&quot;100001&quot;,&quot;content&quot;:&quot;研究表明，刚烧开的水千万不能喝，因为烫嘴。&quot;,&quot;userid&quot;:&quot;1003&quot;,&quot;nickname&quot;:&quot;凯撒&quot;,&quot;createdatetime&quot;:new Date(&quot;2019-08-06T11:01:02.521Z&quot;),&quot;likenum&quot;:NumberInt(3000),&quot;state&quot;:&quot;1&quot;&#125;</span><br><span class="line"></span><br><span class="line">    ]);</span><br><span class="line"> </span><br><span class="line">&#125; catch (e) &#123;</span><br><span class="line">    print (e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-4-2-文档的基本查询"><a href="#3-4-2-文档的基本查询" class="headerlink" title="3.4.2 文档的基本查询"></a>3.4.2 文档的基本查询</h3><p>查询数据的语法格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.find(&lt;query&gt;, [projection])</span><br></pre></td></tr></table></figure><p>参数：</p><table><thead><tr><th>Parameter</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>query</td><td>document</td><td>可选。使用查询运算符指定选择筛选器。若要返回集合中的所有文档，请省略此参数或传递空文档( {} )。</td></tr><tr><td>projection</td><td>document</td><td>可选。指定要在与查询筛选器匹配的文档中返回的字段（投影）。若要返回匹配文档中的所有字段，请省略此参数。</td></tr></tbody></table><p>【示例】</p><h4 id="3-4-2-1-查询所有"><a href="#3-4-2-1-查询所有" class="headerlink" title="3.4.2.1 查询所有"></a>3.4.2.1 查询所有</h4><p>如果我们要查询comment集合的所有文档，我们输入以下命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find()</span><br><span class="line">或</span><br><span class="line">db.comment.find(&#123;&#125;)</span><br></pre></td></tr></table></figure><p>这里你会发现每条文档会有一个叫 _id的字段，这个相当于我们原来关系数据库中表的主键，当你在插入文档记录时没有指定该字段，MongoDB会自动创建，其类型是ObjectID类型。</p><p>如果我们在插入文档记录时指定该字段也可以，其类型可以是ObjectID类型，也可以是MongoDB支持的任意类型。</p><p>如果我想按一定条件来查询，比如我想查询userid为1003的记录，怎么办？很简单！只 要在find()中添加参数即可，参数也是json格式，如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;userid:&#39;1003&#39;&#125;)</span><br></pre></td></tr></table></figure><p>如果你只需要返回符合条件的第一条数据，我们可以使用findOne命令来实现，语法和find一样。</p><p>如：查询用户编号是1003的记录，但只最多返回符合条件的第一条记录：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.findOne(&#123;userid:&#39;1003&#39;&#125;)</span><br></pre></td></tr></table></figure><h4 id="3-4-2-2-投影查询（PROJECTION-QUERY）"><a href="#3-4-2-2-投影查询（PROJECTION-QUERY）" class="headerlink" title="3.4.2.2 投影查询（PROJECTION QUERY）"></a>3.4.2.2 投影查询（PROJECTION QUERY）</h4><p>如果要查询结果返回部分字段，则需要使用投影查询（不显示所有字段，只显示指定的字段）。</p><p>如：查询结果只显示 _id 、userid、nickname :</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;userid:&quot;1003&quot;&#125;,&#123;userid:1,nickname:1&#125;)</span><br></pre></td></tr></table></figure><p>默认 _id 会显示。</p><p>如：查询结果只显示 、 userid、nickname ，不显示 _id ：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;userid:&quot;1003&quot;&#125;,&#123;userid:1,nickname:1,_id:0&#125;)</span><br></pre></td></tr></table></figure><p>再例如：查询所有数据，但只显示 _id 、userid、nickname :</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;&#125;,&#123;userid:1,nickname:1&#125;)</span><br></pre></td></tr></table></figure><h3 id="3-4-3-文档的更新"><a href="#3-4-3-文档的更新" class="headerlink" title="3.4.3 文档的更新"></a>3.4.3 文档的更新</h3><p>更新文档的语法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">db.collection.update(query, update, options)</span><br><span class="line">&#x2F;&#x2F;或</span><br><span class="line">db.collection.update(</span><br><span class="line">    &lt;query&gt;,</span><br><span class="line">    &lt;update&gt;,</span><br><span class="line">    &#123;</span><br><span class="line">        upsert: &lt;boolean&gt;,</span><br><span class="line">        multi: &lt;boolean&gt;,</span><br><span class="line">        writeConcern: &lt;document&gt;,</span><br><span class="line">        collation: &lt;document&gt;,</span><br><span class="line">        arrayFilters: [ &lt;filterdocument1&gt;, ... ],</span><br><span class="line">        hint:  &lt;document|string&gt;     &#x2F;&#x2F; Available starting in MongoDB 4.2</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>参数：</p><table><thead><tr><th>Parameter</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>query</td><td>document</td><td>更新的选择条件。可以使用与find（）方法中相同的查询选择器，类似sql update查询内where后面的。。在3.0版中进行了更改：当使用upsert:true执行update（）时，如果查询使用点表示法在_id 字段上指定条件，则MongoDB将拒绝插入新文档。</td></tr><tr><td>multi</td><td>boolean</td><td>可选。如果设置为true，则更新符合查询条件的多个文档。如果设置为false，则更新一个文档。默认值为false。</td></tr></tbody></table><p>【示例】</p><h4 id="3-4-3-1-覆盖的修改"><a href="#3-4-3-1-覆盖的修改" class="headerlink" title="3.4.3.1 覆盖的修改"></a>3.4.3.1 覆盖的修改</h4><p>如果我们想修改_id为1的记录，点赞量为1001，输入以下语句：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.update(&#123;_id:&quot;1&quot;&#125;,&#123;likenum:NumberInt(1001)&#125;)</span><br></pre></td></tr></table></figure><p>执行后，我们会发现，这条文档除了 likenum字段其它字段都不见了，</p><h4 id="3-4-3-2-局部修改"><a href="#3-4-3-2-局部修改" class="headerlink" title="3.4.3.2 局部修改"></a>3.4.3.2 局部修改</h4><p>为了解决这个问题，我们需要使用修改器$set来实现，命令如下：</p><p>我们想修改_id为2的记录，浏览量为889，输入以下语句：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.update(&#123;_id:&quot;2&quot;&#125;,&#123;$set:&#123;likenum:NumberInt(889)&#125;&#125;)</span><br></pre></td></tr></table></figure><h4 id="3-4-3-3-批量的修改"><a href="#3-4-3-3-批量的修改" class="headerlink" title="3.4.3.3 批量的修改"></a>3.4.3.3 批量的修改</h4><p>更新所有用户为 1003 的用户的昵称为 凯撒大帝 。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;默认只修改第一条数据</span><br><span class="line">db.comment.update(&#123;userid:&quot;1003&quot;&#125;,&#123;$set:&#123;nickname:&quot;凯撒2&quot;&#125;&#125;)</span><br><span class="line">&#x2F;&#x2F;修改所有符合条件的数据</span><br><span class="line">db.comment.update(&#123;userid:&quot;1003&quot;&#125;,&#123;$set:&#123;nickname:&quot;凯撒大帝&quot;&#125;&#125;,&#123;multi:true&#125;)</span><br></pre></td></tr></table></figure><p>提示：如果不加后面的参数，则只更新符合条件的第一条记录</p><h4 id="3-4-3-4-列值增长的修改"><a href="#3-4-3-4-列值增长的修改" class="headerlink" title="3.4.3.4 列值增长的修改"></a>3.4.3.4 列值增长的修改</h4><p>如果我们想实现对某列值在原有值的基础上进行增加或减少，可以使用 $inc 运算符来实现。</p><p>需求：对3号数据的点赞数，每次递增1</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.update(&#123;_id:&quot;3&quot;&#125;,&#123;$inc:&#123;likenum:NumberInt(1)&#125;&#125;)</span><br></pre></td></tr></table></figure><h3 id="3-4-4-删除文档"><a href="#3-4-4-删除文档" class="headerlink" title="3.4.4 删除文档"></a>3.4.4 删除文档</h3><p>删除文档的语法结构：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.集合名称.remove(条件)</span><br></pre></td></tr></table></figure><p>以下语句可以将数据全部删除，请慎用</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.remove(&#123;&#125;)</span><br></pre></td></tr></table></figure><p>如果删除 _id=1的记录，输入以下语句</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.remove(&#123;_id:&quot;1&quot;&#125;)</span><br></pre></td></tr></table></figure><h2 id="3-5-文档的分页查询"><a href="#3-5-文档的分页查询" class="headerlink" title="3.5 文档的分页查询"></a>3.5 文档的分页查询</h2><h3 id="3-5-1-统计查询"><a href="#3-5-1-统计查询" class="headerlink" title="3.5.1 统计查询"></a>3.5.1 统计查询</h3><p>统计查询使用count()方法，语法如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.count(query, options)</span><br></pre></td></tr></table></figure><p>参数：</p><table><thead><tr><th>Parameter</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>query</td><td>document</td><td>查询选择条件</td></tr><tr><td>options</td><td>document</td><td>可选。用于修改计数的额外选项</td></tr></tbody></table><p>【示例】</p><h4 id="3-5-1-1-统计所有记录数"><a href="#3-5-1-1-统计所有记录数" class="headerlink" title="3.5.1.1 统计所有记录数"></a>3.5.1.1 统计所有记录数</h4><p>统计comment集合的所有的记录数：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.count()</span><br></pre></td></tr></table></figure><h4 id="3-5-1-2-按条件统计记录数"><a href="#3-5-1-2-按条件统计记录数" class="headerlink" title="3.5.1.2 按条件统计记录数"></a>3.5.1.2 按条件统计记录数</h4><p>例如：统计userid为1003的记录条数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.count(&#123;userid:&quot;1003&quot;&#125;)</span><br></pre></td></tr></table></figure><p>提示：</p><p>默认情况下 count() 方法返回符合条件的全部记录条数。</p><h3 id="3-5-2-分页列表查询"><a href="#3-5-2-分页列表查询" class="headerlink" title="3.5.2 分页列表查询"></a>3.5.2 分页列表查询</h3><p>可以使用limit()方法来读取指定数量的数据，使用skip()方法来跳过指定数量的数据。</p><p>基本语法如下所示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.find().limit(NUMBER).skip(NUMBER)</span><br></pre></td></tr></table></figure><p>如果你想返回指定条数的记录，可以在find方法后调用limit来返回结果(TopN)，默认值20，例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find().limit(3)</span><br></pre></td></tr></table></figure><p>skip 方法同样接受一个数字参数作为跳过的记录条数。（前N个不要）,默认值是0</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find().skip(3)</span><br></pre></td></tr></table></figure><p>分页查询：需求：每页2个，第二页开始：跳过前两条数据，接着值显示3和4条数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;第一页</span><br><span class="line">db.comment.find().skip(0).limit(2)</span><br><span class="line">&#x2F;&#x2F;第二页</span><br><span class="line">db.comment.find().skip(2).limit(2)</span><br><span class="line">&#x2F;&#x2F;第三页</span><br><span class="line">db.comment.find().skip(4).limit(2)</span><br></pre></td></tr></table></figure><h3 id="3-5-3-排序查询"><a href="#3-5-3-排序查询" class="headerlink" title="3.5.3 排序查询"></a>3.5.3 排序查询</h3><p>sort() 方法对数据进行排序，sort() 方法可以通过参数指定排序的字段，并使用 1 和 -1 来指定排序的方式，其中 1为升序排列，而 -1 是用于降序排列。</p><p>语法如下所示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.find().sort(&#123;KEY:1&#125;)</span><br><span class="line">或</span><br><span class="line">db.集合名称.find().sort(排序方式)</span><br></pre></td></tr></table></figure><p>例如：</p><p>对userid降序排列，并对访问量进行升序排列</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find().sort(&#123;userid:-1,likenum:1&#125;)</span><br></pre></td></tr></table></figure><p>提示：</p><p>skip(), limilt(), sort()三个放在一起执行的时候，执行的顺序是先 sort(), 然后是 skip()，最后是显示的 limit()，和命令编写顺序无关。</p><h2 id="3-6-文档的更多查询"><a href="#3-6-文档的更多查询" class="headerlink" title="3.6 文档的更多查询"></a>3.6 文档的更多查询</h2><h3 id="3-6-1-正则的复杂条件查询"><a href="#3-6-1-正则的复杂条件查询" class="headerlink" title="3.6.1 正则的复杂条件查询"></a>3.6.1 正则的复杂条件查询</h3><p>MongoDB的模糊查询是通过正则表达式的方式实现的。格式为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.collection.find(&#123;field:&#x2F;正则表达式&#x2F;&#125;)</span><br><span class="line">或</span><br><span class="line">db.集合.find(&#123;字段:&#x2F;正则表达式&#x2F;&#125;)</span><br></pre></td></tr></table></figure><p>提示：正则表达式是 js的语法，直接量的写法。</p><p>例如，我要查询评论内容包含“开水”的所有文档，代码如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;content:&#x2F;开水&#x2F;&#125;)</span><br></pre></td></tr></table></figure><p>如果要查询评论的内容中以 “专家”开头的，代码如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;content:&#x2F;^专家&#x2F;&#125;)</span><br></pre></td></tr></table></figure><h3 id="3-6-2-比较查询"><a href="#3-6-2-比较查询" class="headerlink" title="3.6.2 比较查询"></a>3.6.2 比较查询</h3><p>&lt;, &lt;=, &gt;, &gt;= 这个操作符也是很常用的，格式如下:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $gt: value &#125;&#125;) &#x2F;&#x2F; 大于: field &gt; value</span><br><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $lt: value &#125;&#125;) &#x2F;&#x2F; 小于: field &lt; value</span><br><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $gte: value &#125;&#125;) &#x2F;&#x2F; 大于等于: field &gt;&#x3D; value</span><br><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $lte: value &#125;&#125;) &#x2F;&#x2F; 小于等于: field &lt;&#x3D; value</span><br><span class="line">db.集合名称.find(&#123; &quot;field&quot; : &#123; $ne: value &#125;&#125;) &#x2F;&#x2F; 不等于: field !&#x3D; value</span><br></pre></td></tr></table></figure><p>示例：查询评论点赞数量大于 700的记录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;likenum:&#123;$gt:NumberInt(700)&#125;&#125;)</span><br></pre></td></tr></table></figure><h3 id="3-6-3-包含查询"><a href="#3-6-3-包含查询" class="headerlink" title="3.6.3 包含查询"></a>3.6.3 包含查询</h3><p>包含使用$in操作符。 示例：查询评论的集合中userid字段包含1003或1004的文档</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;userid:&#123;$in:[&quot;1003&quot;,&quot;1004&quot;]&#125;&#125;)</span><br></pre></td></tr></table></figure><p>不包含使用 $nin操作符。 示例：查询评论集合中userid字段不包含1003和1004的文档</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;userid:&#123;$nin:[&quot;1003&quot;,&quot;1004&quot;]&#125;&#125;)</span><br></pre></td></tr></table></figure><h3 id="3-6-4-条件连接查询"><a href="#3-6-4-条件连接查询" class="headerlink" title="3.6.4 条件连接查询"></a>3.6.4 条件连接查询</h3><p>我们如果需要查询同时满足两个以上条件，需要使用$and操作符将条件进行关联。（相当于SQL的and） 格式为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$and:[ &#123;  &#125;,&#123;  &#125;,&#123; &#125; ]</span><br></pre></td></tr></table></figure><p>示例：查询评论集合中 likenum大于等于700 并且小于2000的文档：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;$and:[&#123;likenum:&#123;$gte:NumberInt(700)&#125;&#125;,&#123;likenum:&#123;$lt:NumberInt(2000)&#125;&#125;]&#125;)</span><br></pre></td></tr></table></figure><p>如果两个以上条件之间是或者的关系，我们使用操作符进行关联，与前面 and的使用方式相同格式为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$or:[ &#123;  &#125;,&#123;  &#125;,&#123;   &#125; ]</span><br></pre></td></tr></table></figure><p>示例：查询评论集合中 userid为1003，或者点赞数小于1000的文档记录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.find(&#123;$or:[ &#123;userid:&quot;1003&quot;&#125; ,&#123;likenum:&#123;$lt:1000&#125; &#125;]&#125;)</span><br></pre></td></tr></table></figure><h2 id="3-7-常用命令小结"><a href="#3-7-常用命令小结" class="headerlink" title="3.7 常用命令小结"></a>3.7 常用命令小结</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">选择切换数据库：use articledb</span><br><span class="line">插入数据：db.comment.insert(&#123;bson数据&#125;)</span><br><span class="line">查询所有数据：db.comment.find();</span><br><span class="line">条件查询数据：db.comment.find(&#123;条件&#125;)</span><br><span class="line">查询符合条件的第一条记录：db.comment.findOne(&#123;条件&#125;)</span><br><span class="line">查询符合条件的前几条记录：db.comment.find(&#123;条件&#125;).limit(条数)</span><br><span class="line">查询符合条件的跳过的记录：db.comment.find(&#123;条件&#125;).skip(条数)</span><br><span class="line">修改数据：db.comment.update(&#123;条件&#125;,&#123;修改后的数据&#125;) 或db.comment.update(&#123;条件&#125;,&#123;$set:&#123;要修改部分的字段:数据&#125;)</span><br><span class="line">修改数据并自增某字段值：db.comment.update(&#123;条件&#125;,&#123;$inc:&#123;自增的字段:步进值&#125;&#125;)</span><br><span class="line">删除数据：db.comment.remove(&#123;条件&#125;)</span><br><span class="line">统计查询：db.comment.count(&#123;条件&#125;)</span><br><span class="line">模糊查询：db.comment.find(&#123;字段名:&#x2F;正则表达式&#x2F;&#125;)</span><br><span class="line">条件比较运算：db.comment.find(&#123;字段名:&#123;$gt:值&#125;&#125;)</span><br><span class="line">包含查询：db.comment.find(&#123;字段名:&#123;$in:[值1，值2]&#125;&#125;)或db.comment.find(&#123;字段名:&#123;$nin:[值1，值2]&#125;&#125;)</span><br><span class="line">条件连接查询：db.comment.find(&#123;$and:[&#123;条件1&#125;,&#123;条件2&#125;]&#125;)或db.comment.find(&#123;$or:[&#123;条件1&#125;,&#123;条件2&#125;]&#125;)</span><br></pre></td></tr></table></figure><h1 id="4-索引-Index"><a href="#4-索引-Index" class="headerlink" title="4. 索引-Index"></a>4. 索引-Index</h1><h2 id="4-1-概述"><a href="#4-1-概述" class="headerlink" title="4.1 概述"></a>4.1 概述</h2><p>索引支持在MongoDB中高效地执行查询。如果没有索引，MongoDB必须执行全集合扫描，即扫描集合中的每个文档，以选择与查询语句匹配的文档。这种扫描全集合的查询效率是非常低的，特别在处理大量的数据时，查询可以要花费几十秒甚至几分钟，这对网站的性能是非常致命的。</p><p>如果查询存在适当的索引，MongoDB可以使用该索引限制必须检查的文档数。</p><p>索引是特殊的数据结构，它以易于遍历的形式存储集合数据集的一小部分。索引存储特定字段或一组字段的值，按字段值排序。索引项的排序支持有效的相等匹配和基于范围的查询操作。此外，MongoDB还可以使用索引中的排序返回排序结果。</p><p>官网文档： <a href="https://docs.mongodb.com/manual/indexes/" target="_blank" rel="noopener">https://docs.mongodb.com/manual/indexes/</a></p><p>了解：</p><p>MongoDB索引使用B树数据结构（确切的说是B-Tree，MySQL是B+Tree）</p><h2 id="4-2-索引的类型"><a href="#4-2-索引的类型" class="headerlink" title="4.2 索引的类型"></a>4.2 索引的类型</h2><h3 id="4-2-1-单字段索引"><a href="#4-2-1-单字段索引" class="headerlink" title="4.2.1 单字段索引"></a>4.2.1 单字段索引</h3><p>MongoDB支持在文档的单个字段上创建用户定义的升序/降序索引，称为单字段索引（Single Field Index）。</p><p>对于单个字段索引和排序操作，索引键的排序顺序（即升序或降序）并不重要，因为MongoDB可以在任何方向上遍历索引。</p><p><img src="https://img-blog.csdnimg.cn/20200912222446304.png" alt="image-20200912175647643"></p><h3 id="4-2-2-复合索引"><a href="#4-2-2-复合索引" class="headerlink" title="4.2.2 复合索引"></a>4.2.2 复合索引</h3><p>MongoDB还支持多个字段的用户定义索引，即复合索引（Compound Index）。</p><p>复合索引中列出的字段顺序具有重要意义。例如，如果复合索引由 { userid: 1, score: -1 } 组成，则索引首先按userid正序排序，然后在每个userid的值内，再在按score倒序排序。</p><p><img src="https://img-blog.csdnimg.cn/20200912222502355.png" alt="image-20200912175808078"></p><h3 id="4-2-3-其他索引"><a href="#4-2-3-其他索引" class="headerlink" title="4.2.3 其他索引"></a>4.2.3 其他索引</h3><p>地理空间索引（Geospatial Index）、文本索引（Text Indexes）、哈希索引（Hashed Indexes）。</p><ul><li><p>地理空间索引（Geospatial Index）</p><p>为了支持对地理空间坐标数据的有效查询，MongoDB提供了两种特殊的索引：返回结果时使用平面几何的二维索引和返回结果时使用球面几何的二维球面索引。</p></li><li><p>文本索引（Text Indexes）</p><p>MongoDB提供了一种文本索引类型，支持在集合中搜索字符串内容。这些文本索引不存储特定于语言的停止词（例如“the”、“a”、“or”），而将集合中的词作为词干，只存储根词。</p></li><li><p>哈希索引（Hashed Indexes）</p><p>为了支持基于散列的分片，MongoDB提供了散列索引类型，它对字段值的散列进行索引。这些索引在其范围内的值分布更加随机，但只支持相等匹配，不支持基于范围的查询。</p></li></ul><h2 id="4-3-索引的管理操作"><a href="#4-3-索引的管理操作" class="headerlink" title="4.3 索引的管理操作"></a>4.3 索引的管理操作</h2><h3 id="4-3-1-索引的查看"><a href="#4-3-1-索引的查看" class="headerlink" title="4.3.1 索引的查看"></a>4.3.1 索引的查看</h3><p>说明：</p><p>返回一个集合中的所有索引的数组。</p><p>语法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.getIndexes()</span><br></pre></td></tr></table></figure><p>提示：该语法命令运行要求是 MongoDB 3.0+</p><p>【示例】</p><p>查看comment集合中所有的索引情况</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.comment.getIndexes()</span><br><span class="line">[</span><br><span class="line">   &#123;</span><br><span class="line">        &quot;v&quot; : 2,</span><br><span class="line">        &quot;key&quot; : &#123;</span><br><span class="line">            &quot;_id&quot; : 1</span><br><span class="line">       &#125;,</span><br><span class="line">        &quot;name&quot; : &quot;_id_&quot;,</span><br><span class="line">        &quot;ns&quot; : &quot;articledb.comment&quot;</span><br><span class="line">   &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>结果中显示的是默认 <code>_id</code> 索引。</p><p>默认<code>_id</code>索引：</p><p>MongoDB在创建集合的过程中，在<code>_id</code> 字段上创建一个唯一的索引，默认名字为<code>_id_</code>，该索引可防止客户端插入两个具有相同值的文档，您不能在<code>_id</code>字段上删除此索引。</p><p>注意：该索引是唯一索引，因此值不能重复，即 <code>_id</code> 值不能重复的。在分片集群中，通常使用 <code>_id</code> 作为片键。</p><h3 id="4-3-2-索引的创建"><a href="#4-3-2-索引的创建" class="headerlink" title="4.3.2 索引的创建"></a>4.3.2 索引的创建</h3><p>说明：在集合上创建索引。</p><p>语法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.createIndex(keys, options)</span><br></pre></td></tr></table></figure><p>参数：</p><table><thead><tr><th>Parameter</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>keys</td><td>document</td><td>包含字段和值对的文档，其中字段是索引键，值描述该字段的索引类型。对于字段上的升序索引，请 指定值1；对于降序索引，请指定值-1。比如： { 字段:1或-1} ，其中1 为指定按升序创建索引，如果你 想按降序来创建索引指定为 -1 即可。另外，MongoDB支持几种不同的索引类型，包括文本、地理空 间和哈希索引。</td></tr><tr><td>options</td><td>document</td><td>可选。包含一组控制索引创建的选项的文档。有关详细信息，请参见选项详情列表。</td></tr></tbody></table><p>options（更多选项）列表：</p><table><thead><tr><th>Parameter</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>background</td><td>Boolean</td><td>建索引过程会阻塞其它数据库操作，background可指定以后台方式创建索引，即增加 “background” 可选参数。 “background” 默认值为false。</td></tr><tr><td>unique</td><td>Boolean</td><td>建立的索引是否唯一。指定为true创建唯一索引。默认值为false.</td></tr><tr><td>name</td><td>string</td><td>索引的名称。如果未指定，MongoDB的通过连接索引的字段名和排序顺序生成一个索引名 称。</td></tr><tr><td>dropDups</td><td>Boolean</td><td>3.0+版本已废弃。在建立唯一索引时是否删除重复记录,指定 true 创建唯一索引。默认值为 false.</td></tr><tr><td>sparse</td><td>Boolean</td><td>对文档中不存在的字段数据不启用索引；这个参数需要特别注意，如果设置为true的话，在索 引字段中不会查询出不包含对应字段的文档.。默认值为 false.</td></tr><tr><td>expireAfterSeconds</td><td>integer</td><td>指定一个以秒为单位的数值，完成 TTL设定，设定集合的生存时间。</td></tr><tr><td>v</td><td>index version</td><td>索引的版本号。默认的索引版本取决于mongod创建索引时运行的版本。</td></tr><tr><td>weights</td><td>document</td><td>索引权重值，数值在 1 到 99,999 之间，表示该索引相对于其他索引字段的得分权重。</td></tr><tr><td>default_language</td><td>string</td><td>对于文本索引，该参数决定了停用词及词干和词器的规则的列表。 默认为英语</td></tr><tr><td>language_override</td><td>string</td><td>对于文本索引，该参数指定了包含在文档中的字段名，语言覆盖默认的language，默认值为 language.</td></tr></tbody></table><p>提示：<br>注意在 3.0.0 版本前创建索引方法为 db.collection.ensureIndex() ，之后的版本使用了 db.collection.createIndex() 方法，ensureIndex() 还能用，但只是 createIndex() 的别名。</p><p>【示例】</p><h4 id="4-3-2-1-单字段索引"><a href="#4-3-2-1-单字段索引" class="headerlink" title="4.3.2.1 单字段索引"></a>4.3.2.1 单字段索引</h4><p>示例：对 userid 字段建立索引：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.createIndex(&#123;userid:1&#125;)</span><br></pre></td></tr></table></figure><p>参数 1：按升序创建索引</p><p>compass查看：</p><p><img src="https://img-blog.csdnimg.cn/20200912222523315.png" alt="image-20200912184832080"></p><h4 id="4-3-2-2-复合索引"><a href="#4-3-2-2-复合索引" class="headerlink" title="4.3.2.2 复合索引"></a>4.3.2.2 复合索引</h4><p>对 userid 和 nickname 同时建立复合（Compound）索引：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.createIndex(&#123;userid:1,nickname:-1&#125;)</span><br></pre></td></tr></table></figure><p>compass 中：</p><p><img src="https://img-blog.csdnimg.cn/20200912222541442.png" alt="image-20200912184915143"></p><h3 id="4-3-3-索引的移除"><a href="#4-3-3-索引的移除" class="headerlink" title="4.3.3 索引的移除"></a>4.3.3 索引的移除</h3><p>说明：可以移除指定的索引，或移除所有索引</p><h4 id="4-3-3-1-指定索引的移除"><a href="#4-3-3-1-指定索引的移除" class="headerlink" title="4.3.3.1 指定索引的移除"></a>4.3.3.1 指定索引的移除</h4><p>语法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.dropIndex(index)</span><br></pre></td></tr></table></figure><p>参数：</p><table><thead><tr><th>Parameter</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>index</td><td>string or document</td><td>指定要删除的索引。可以通过索引名称或索引规范文档指定索引。若要删除文本索引，请指定 索引名称。</td></tr></tbody></table><p>【示例】</p><p>删除 comment 集合中 userid 字段上的升序索引：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.dropIndex(&#123;userid:1&#125;)</span><br></pre></td></tr></table></figure><h4 id="4-3-3-2-所有索引的移除"><a href="#4-3-3-2-所有索引的移除" class="headerlink" title="4.3.3.2 所有索引的移除"></a>4.3.3.2 所有索引的移除</h4><p>语法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.dropIndexes()</span><br></pre></td></tr></table></figure><p>【示例】</p><p>删除 comment 集合中所有索引。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.dropIndexes()</span><br></pre></td></tr></table></figure><p>提示： _id 的字段的索引是无法删除的，只能删除非 _id 字段的索引。</p><h2 id="4-4-索引的使用"><a href="#4-4-索引的使用" class="headerlink" title="4.4 索引的使用"></a>4.4 索引的使用</h2><h3 id="4-4-1-执行计划"><a href="#4-4-1-执行计划" class="headerlink" title="4.4.1 执行计划"></a>4.4.1 执行计划</h3><p>分析查询性能（Analyze Query Performance）通常使用执行计划（解释计划、Explain Plan）来查看查询的情况，如查询耗费的时间、是否基于索引查询等。</p><p>那么，通常，我们想知道，建立的索引是否有效，效果如何，都需要通过执行计划查看。</p><p>语法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.find(query,options).explain(options)</span><br></pre></td></tr></table></figure><p>【示例】</p><p>查看根据userid查询数据的情况：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.comment.find(&#123;userid:&quot;1003&quot;&#125;).explain()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;queryPlanner&quot; : &#123;</span><br><span class="line">        &quot;plannerVersion&quot; : 1,</span><br><span class="line">        &quot;namespace&quot; : &quot;articledb.comment&quot;,</span><br><span class="line">        &quot;indexFilterSet&quot; : false,</span><br><span class="line">        &quot;parsedQuery&quot; : &#123;</span><br><span class="line">            &quot;userid&quot; : &#123;</span><br><span class="line">            &quot;$eq&quot; : &quot;1003&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;winningPlan&quot; : &#123;</span><br><span class="line">            &quot;stage&quot; : &quot;COLLSCAN&quot;,</span><br><span class="line">            &quot;filter&quot; : &#123;</span><br><span class="line">                &quot;userid&quot; : &#123;</span><br><span class="line">                &quot;$eq&quot; : &quot;1003&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;direction&quot; : &quot;forward&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;rejectedPlans&quot; : [ ]</span><br><span class="line">   &#125;,</span><br><span class="line">   &quot;serverInfo&quot; : &#123;</span><br><span class="line">       &quot;host&quot; : &quot;9ef3740277ad&quot;,</span><br><span class="line">       &quot;port&quot; : 27017,</span><br><span class="line">       &quot;version&quot; : &quot;4.0.10&quot;,</span><br><span class="line">       &quot;gitVersion&quot; : &quot;c389e7f69f637f7a1ac3cc9fae843b635f20b766&quot;</span><br><span class="line">   &#125;,</span><br><span class="line">   &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关键点看： “stage” : “COLLSCAN”, 表示全集合扫描</p><p><img src="https://img-blog.csdnimg.cn/20200912222603862.png" alt="image-20200912185953559"></p><p>下面对userid建立索引</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.createIndex(&#123;userid:1&#125;)</span><br></pre></td></tr></table></figure><p>再次查看执行计划：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.comment.find(&#123;userid:&quot;1013&quot;&#125;).explain()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;queryPlanner&quot; : &#123;</span><br><span class="line">        &quot;plannerVersion&quot; : 1,</span><br><span class="line">        &quot;namespace&quot; : &quot;articledb.comment&quot;,</span><br><span class="line">        &quot;indexFilterSet&quot; : false,</span><br><span class="line">        &quot;parsedQuery&quot; : &#123;</span><br><span class="line">            &quot;userid&quot; : &#123;</span><br><span class="line">                &quot;$eq&quot; : &quot;1013&quot;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">        &quot;winningPlan&quot; : &#123;</span><br><span class="line">            &quot;stage&quot; : &quot;FETCH&quot;,</span><br><span class="line">            &quot;inputStage&quot; : &#123;</span><br><span class="line">                &quot;stage&quot; : &quot;IXSCAN&quot;,</span><br><span class="line">                &quot;keyPattern&quot; : &#123;</span><br><span class="line">                    &quot;userid&quot; : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;indexName&quot; : &quot;userid_1&quot;,</span><br><span class="line">                &quot;isMultiKey&quot; : false,</span><br><span class="line">                &quot;multiKeyPaths&quot; : &#123;</span><br><span class="line">                    &quot;userid&quot; : [ ]</span><br><span class="line">                 &#125;,</span><br><span class="line">                &quot;isUnique&quot; : false,</span><br><span class="line">                &quot;isSparse&quot; : false,</span><br><span class="line">                &quot;isPartial&quot; : false,</span><br><span class="line">                &quot;indexVersion&quot; : 2,</span><br><span class="line">                &quot;direction&quot; : &quot;forward&quot;,</span><br><span class="line">                &quot;indexBounds&quot; : &#123;</span><br><span class="line">                    &quot;userid&quot; : [</span><br><span class="line">                        &quot;[\&quot;1013\&quot;, \&quot;1013\&quot;]&quot;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;rejectedPlans&quot; : [ ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;serverInfo&quot; : &#123;</span><br><span class="line">        &quot;host&quot; : &quot;9ef3740277ad&quot;,</span><br><span class="line">        &quot;port&quot; : 27017,</span><br><span class="line">        &quot;version&quot; : &quot;4.0.10&quot;,</span><br><span class="line">        &quot;gitVersion&quot; : &quot;c389e7f69f637f7a1ac3cc9fae843b635f20b766&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关键点看： “stage” : “IXSCAN” ,基于索引的扫描</p><p>compass查看：</p><p><img src="https://img-blog.csdnimg.cn/20200912222620711.png" alt="image-20200912190339355"></p><h3 id="4-4-2-涵盖的查询"><a href="#4-4-2-涵盖的查询" class="headerlink" title="4.4.2 涵盖的查询"></a>4.4.2 涵盖的查询</h3><p>Covered Queries</p><p>当查询条件和查询的投影仅包含索引字段时，MongoDB直接从索引返回结果，而不扫描任何文档或将文档带入内存。 这些覆盖的查询可以非常有效。</p><p><img src="https://img-blog.csdnimg.cn/20200912222637894.png" alt="image-20200912190507995"></p><p>更多：<a href="https://docs.mongodb.com/manual/core/query-optimization/#read-operations-covered-query" target="_blank" rel="noopener">https://docs.mongodb.com/manual/core/query-optimization/#read-operations-covered-query</a></p><p>【示例】</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.comment.find(&#123;userid:&quot;1003&quot;&#125;,&#123;userid:1,_id:0&#125;)</span><br><span class="line">&#123; &quot;userid&quot; : &quot;1003&quot; &#125;</span><br><span class="line">&#123; &quot;userid&quot; : &quot;1003&quot; &#125;</span><br><span class="line">&gt; db.comment.find(&#123;userid:&quot;1003&quot;&#125;,&#123;userid:1,_id:0&#125;).explain()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;queryPlanner&quot; : &#123;</span><br><span class="line">        &quot;plannerVersion&quot; : 1,</span><br><span class="line">        &quot;namespace&quot; : &quot;articledb.comment&quot;,</span><br><span class="line">        &quot;indexFilterSet&quot; : false,</span><br><span class="line">        &quot;parsedQuery&quot; : &#123;</span><br><span class="line">            &quot;userid&quot; : &#123;</span><br><span class="line">                &quot;$eq&quot; : &quot;1003&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;winningPlan&quot; : &#123;</span><br><span class="line">            &quot;stage&quot; : &quot;PROJECTION&quot;,</span><br><span class="line">            &quot;transformBy&quot; : &#123;</span><br><span class="line">                &quot;userid&quot; : 1,</span><br><span class="line">                &quot;_id&quot; : 0</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;inputStage&quot; : &#123;</span><br><span class="line">                &quot;stage&quot; : &quot;IXSCAN&quot;,</span><br><span class="line">                &quot;keyPattern&quot; : &#123;</span><br><span class="line">                &quot;userid&quot; : 1</span><br><span class="line">            &#125;,</span><br><span class="line">                &quot;indexName&quot; : &quot;userid_1&quot;,</span><br><span class="line">                &quot;isMultiKey&quot; : false,</span><br><span class="line">                &quot;multiKeyPaths&quot; : &#123;</span><br><span class="line">                    &quot;userid&quot; : [ ]</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;isUnique&quot; : false,</span><br><span class="line">                &quot;isSparse&quot; : false,</span><br><span class="line">                &quot;isPartial&quot; : false,</span><br><span class="line">                &quot;indexVersion&quot; : 2,</span><br><span class="line">                &quot;direction&quot; : &quot;forward&quot;,</span><br><span class="line">                &quot;indexBounds&quot; : &#123;</span><br><span class="line">                    &quot;userid&quot; : [</span><br><span class="line">                        &quot;[\&quot;1003\&quot;, \&quot;1003\&quot;]&quot;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;rejectedPlans&quot; : [ ]</span><br><span class="line">&#125;,</span><br><span class="line">    &quot;serverInfo&quot; : &#123;</span><br><span class="line">        &quot;host&quot; : &quot;bobohost.localdomain&quot;,</span><br><span class="line">        &quot;port&quot; : 27017,</span><br><span class="line">        &quot;version&quot; : &quot;4.0.10&quot;,</span><br><span class="line">        &quot;gitVersion&quot; : &quot;c389e7f69f637f7a1ac3cc9fae843b635f20b766&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Compass 中：</p><p><img src="https://img-blog.csdnimg.cn/20200912222653761.png" alt="image-20200912191627943"></p><h1 id="5-文章评论"><a href="#5-文章评论" class="headerlink" title="5. 文章评论"></a>5. 文章评论</h1><h2 id="5-1-需求分析"><a href="#5-1-需求分析" class="headerlink" title="5.1 需求分析"></a>5.1 需求分析</h2><p>某头条的文章评论业务如下：</p><p><img src="https://img-blog.csdnimg.cn/20200912222709789.png" alt="image-20200912191728761"></p><p>文章示例参考：早晨空腹喝水，是对还是错？ <a href="https://www.toutiao.com/a6721476546088927748/" target="_blank" rel="noopener">https://www.toutiao.com/a6721476546088927748/</a></p><p>需要实现以下功能：</p><ul><li>基本增删改查API</li><li>根据文章id查询评论</li><li>评论点赞</li></ul><h2 id="5-2-表结构分析"><a href="#5-2-表结构分析" class="headerlink" title="5.2 表结构分析"></a>5.2 表结构分析</h2><p>数据库：articledb</p><table><thead><tr><th>专栏文章评论</th><th>comment</th><th></th><th></th></tr></thead><tbody><tr><td>字段名称</td><td>字段含义</td><td>字段类型</td><td>备注</td></tr><tr><td>_id</td><td>ID</td><td>ObjectId或String</td><td>Mongo的主键的字段</td></tr><tr><td>articleid</td><td>文章ID</td><td>String</td><td></td></tr><tr><td>content</td><td>评论内容</td><td>String</td><td></td></tr><tr><td>userid</td><td>评论人ID</td><td>String</td><td></td></tr><tr><td>nickname</td><td>评论人昵称</td><td>String</td><td></td></tr><tr><td>createdatetime</td><td>评论的日期时间</td><td>Date</td><td></td></tr><tr><td>likenum</td><td>点赞数</td><td>Int32</td><td></td></tr><tr><td>replynum</td><td>回复数</td><td>Int32</td><td></td></tr><tr><td>state</td><td>状态</td><td>String</td><td>0：不可见；1：可见；</td></tr><tr><td>parentid</td><td>上级ID</td><td>String</td><td>如果为0表示文章的顶级评论</td></tr></tbody></table><h2 id="5-3-技术选型"><a href="#5-3-技术选型" class="headerlink" title="5.3 技术选型"></a>5.3 技术选型</h2><h3 id="5-3-1-mongodb-driver"><a href="#5-3-1-mongodb-driver" class="headerlink" title="5.3.1 mongodb-driver"></a>5.3.1 mongodb-driver</h3><p>mongodb-driver是mongo官方推出的java连接mongoDB的驱动包，相当于JDBC驱动。我们通过一个入门的案例来了解mongodb-driver的基本使用。</p><p>官方驱动说明和下载： <a href="http://mongodb.github.io/mongo-java-driver/" target="_blank" rel="noopener">http://mongodb.github.io/mongo-java-driver/</a></p><p>官方驱动示例文档：<a href="http://mongodb.github.io/mongo-java-driver/3.8/driver/getting-started/quick-start/" target="_blank" rel="noopener">http://mongodb.github.io/mongo-java-driver/3.8/driver/getting-started/quick-start/</a></p><h3 id="5-3-2-SpringDataMongoDB"><a href="#5-3-2-SpringDataMongoDB" class="headerlink" title="5.3.2 SpringDataMongoDB"></a>5.3.2 SpringDataMongoDB</h3><p>SpringData家族成员之一，用于操作MongoDB的持久层框架，封装了底层的mongodb-driver。</p><p>官网主页： <a href="https://projects.spring.io/spring-data-mongodb/" target="_blank" rel="noopener">https://projects.spring.io/spring-data-mongodb/</a></p><p>我们十次方项目的吐槽微服务就采用SpringDataMongoDB框架。</p><h2 id="5-4-文章微服务模块搭建"><a href="#5-4-文章微服务模块搭建" class="headerlink" title="5.4 文章微服务模块搭建"></a>5.4 文章微服务模块搭建</h2><p>（1）搭建项目工程article，pom.xml引入依赖：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.1.6.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;relativePath&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line">    &lt;groupId&gt;com.wgy&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;article&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-data-mongodb&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure><p>（ 2）创建application.yml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  #数据源配置</span><br><span class="line">  data:</span><br><span class="line">    mongodb:</span><br><span class="line">      # 主机地址</span><br><span class="line">      #host: 192.168.142.128</span><br><span class="line">      # 数据库</span><br><span class="line">      #database: articledb</span><br><span class="line">      # 默认端口是27017</span><br><span class="line">      #port: 27017</span><br><span class="line">      #也可以使用uri连接</span><br><span class="line">      uri: mongodb:&#x2F;&#x2F;192.168.142.128:27017&#x2F;articledb</span><br><span class="line">server:</span><br><span class="line">  # 端口</span><br><span class="line">  port: 80</span><br></pre></td></tr></table></figure><p>（ 3）创建启动类</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">package com.wgy;</span><br><span class="line"></span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 启动类</span><br><span class="line"> *</span><br><span class="line"> * @author wgy</span><br><span class="line"> *&#x2F;</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class ArticleApplication &#123;</span><br><span class="line">    </span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(ArticleApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>（4）启动项目，看是否能正常启动，控制台没有错误。</p><h2 id="5-5-文章评论实体类的编写"><a href="#5-5-文章评论实体类的编写" class="headerlink" title="5.5 文章评论实体类的编写"></a>5.5 文章评论实体类的编写</h2><p>创建实体类 创建包com.wgy.article，包下建包po用于存放实体类，创建实体类</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 评论实体类</span><br><span class="line"> *</span><br><span class="line"> * @author wgy</span><br><span class="line"> *&#x2F;</span><br><span class="line">&#x2F;&#x2F;把一个java类声明为mongodb的文档，可以通过collection参数指定这个类对应的文档。</span><br><span class="line">&#x2F;&#x2F;@Document(collection&#x3D;&quot;mongodb 对应 collection 名&quot;)</span><br><span class="line">&#x2F;&#x2F; 若未加 @Document ，该 bean save 到 mongo 的 comment collection</span><br><span class="line">&#x2F;&#x2F; 若添加 @Document ，则 save 到 comment collection</span><br><span class="line">@Document(collection &#x3D; &quot;comment&quot;)&#x2F;&#x2F;可以省略，如果省略，则默认使用类名小写映射集合</span><br><span class="line">&#x2F;&#x2F;复合索引</span><br><span class="line">&#x2F;&#x2F; @CompoundIndex( def &#x3D; &quot;&#123;&#39;userid&#39;: 1, &#39;nickname&#39;: -1&#125;&quot;)</span><br><span class="line">public class Comment implements Serializable &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;主键标识，该属性的值会自动对应mongodb的主键字段&quot;_id&quot;，如果该属性名就叫“id”,则该注解可以省略，否则必须写</span><br><span class="line">    @Id</span><br><span class="line">    private String id;&#x2F;&#x2F;主键    &#x2F;&#x2F;该属性对应mongodb的字段的名字，如果一致，则无需该注解</span><br><span class="line">    @Field(&quot;content&quot;)</span><br><span class="line">    private String content;&#x2F;&#x2F;吐槽内容</span><br><span class="line">    private Date publishtime;&#x2F;&#x2F;发布日期    &#x2F;&#x2F;添加了一个单字段的索引</span><br><span class="line">    @Indexed</span><br><span class="line">    private String userid;&#x2F;&#x2F;发布人ID</span><br><span class="line">    private String nickname;&#x2F;&#x2F;昵称</span><br><span class="line">    private LocalDateTime createdatetime;&#x2F;&#x2F;评论的日期时间</span><br><span class="line">    private Integer likenum;&#x2F;&#x2F;点赞数</span><br><span class="line">    private Integer replynum;&#x2F;&#x2F;回复数</span><br><span class="line">    private String state;&#x2F;&#x2F;状态</span><br><span class="line">    private String parentid;&#x2F;&#x2F;上级ID</span><br><span class="line">    private String articleid;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;set&#x2F;get&#x2F;toString...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>说明：</p><p>索引可以大大提升查询效率，一般在查询字段上添加索引，索引的添加可以通过Mongo的命令来添加，也可以在Java的实体类中通过注解添加。</p><p>1）单字段索引注解@Indexed</p><p>org.springframework.data.mongodb.core.index.Indexed.class</p><p>声明该字段需要索引，建索引可以大大的提高查询效率。</p><p>Mongo命令参考：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.createIndex(&#123;&quot;userid&quot;:1&#125;)</span><br></pre></td></tr></table></figure><p>2 ）复合索引注解@CompoundIndex</p><p>org.springframework.data.mongodb.core.index.CompoundIndex.class</p><p>复合索引的声明，建复合索引可以有效地提高多字段的查询效率。</p><p>Mongo命令参考：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.comment.createIndex(&#123;&quot;userid&quot;:1,&quot;nickname&quot;:-1&#125;)</span><br></pre></td></tr></table></figure><h2 id="5-6-文章评论的基本增删改查"><a href="#5-6-文章评论的基本增删改查" class="headerlink" title="5.6 文章评论的基本增删改查"></a>5.6 文章评论的基本增删改查</h2><p>（1）创建数据访问接口 com.wgy.article包下创建dao包，包下创建接口</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 评论的持久层接口</span><br><span class="line"> *</span><br><span class="line"> * @author wgy</span><br><span class="line"> *&#x2F;</span><br><span class="line">public interface CommentRepository extends MongoRepository&lt;Comment, String&gt; &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>（ 2）创建业务逻辑类 com.wgy.article包下创建service包，包下创建类</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 评论的业务层</span><br><span class="line"> *</span><br><span class="line"> * @author wgy</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Service</span><br><span class="line">public class CommentService &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;注入dao</span><br><span class="line">    @Autowired</span><br><span class="line">    private CommentRepository commentRepository;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 保存一个评论</span><br><span class="line">     *</span><br><span class="line">     * @param comment</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void saveComment(Comment comment) &#123;</span><br><span class="line">        &#x2F;&#x2F;如果需要自定义主键，可以在这里指定主键；如果不指定主键，MongoDB会自动生成主键</span><br><span class="line">        &#x2F;&#x2F;设置一些默认初始值。。。</span><br><span class="line">        &#x2F;&#x2F;调用dao</span><br><span class="line">        commentRepository.save(comment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 更新评论</span><br><span class="line">     *</span><br><span class="line">     * @param comment</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void updateComment(Comment comment) &#123;</span><br><span class="line">        &#x2F;&#x2F;调用dao</span><br><span class="line">        commentRepository.save(comment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 根据id删除评论</span><br><span class="line">     *</span><br><span class="line">     * @param id</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void deleteCommentById(String id) &#123;</span><br><span class="line">        &#x2F;&#x2F;调用dao</span><br><span class="line">        commentRepository.deleteById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 查询所有评论</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public List&lt;Comment&gt; findCommentList() &#123;</span><br><span class="line">        &#x2F;&#x2F;调用dao</span><br><span class="line">        return commentRepository.findAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 根据id查询评论</span><br><span class="line">     *</span><br><span class="line">     * @param id</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public Comment findCommentById(String id) &#123;</span><br><span class="line">        &#x2F;&#x2F;调用dao</span><br><span class="line">        return commentRepository.findById(id).get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>（ 3）新建Junit测试类，测试保存和查询所有：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 评论测试类</span><br><span class="line"> *</span><br><span class="line"> * @author wgy</span><br><span class="line"> *&#x2F;</span><br><span class="line">@RunWith(SpringRunner.class)</span><br><span class="line">@SpringBootTest</span><br><span class="line">public class CommentServiceTest &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private CommentService commentService;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 查询所有数据</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Test</span><br><span class="line">    public void testFindCommentList() &#123;</span><br><span class="line">        List&lt;Comment&gt; commentList &#x3D; commentService.findCommentList();</span><br><span class="line">        System.out.println(commentList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 测试根据id查询</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Test</span><br><span class="line">    public void testFindCommentById() &#123;</span><br><span class="line">        Comment commentById &#x3D; commentService.findCommentById(&quot;1&quot;);</span><br><span class="line">        System.out.println(commentById);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 保存一个评论</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Test</span><br><span class="line">    public void testSaveComment() &#123;</span><br><span class="line">        Comment comment &#x3D; new Comment();</span><br><span class="line">        comment.setArticleid(&quot;100000&quot;);</span><br><span class="line">        comment.setContent(&quot;测试添加的数据&quot;);</span><br><span class="line">        comment.setCreatedatetime(LocalDateTime.now());</span><br><span class="line">        comment.setUserid(&quot;1003&quot;);</span><br><span class="line">        comment.setNickname(&quot;凯撒大帝&quot;);</span><br><span class="line">        comment.setState(&quot;1&quot;);</span><br><span class="line">        comment.setLikenum(0);</span><br><span class="line">        comment.setReplynum(0);</span><br><span class="line">        commentService.saveComment(comment);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-7-根据上级ID查询文章评论的分页列表"><a href="#5-7-根据上级ID查询文章评论的分页列表" class="headerlink" title="5.7 根据上级ID查询文章评论的分页列表"></a>5.7 根据上级ID查询文章评论的分页列表</h2><p>（1）CommentRepository新增方法定义</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 根据父id，查询子评论的分页列表</span><br><span class="line"> *</span><br><span class="line"> * @param parentid</span><br><span class="line"> * @param pageable</span><br><span class="line"> * @return</span><br><span class="line"> *&#x2F;</span><br><span class="line">Page&lt;Comment&gt; findByParentid(String parentid, Pageable pageable);</span><br></pre></td></tr></table></figure><p>（2）CommentService新增方法</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 根据父id查询分页列表</span><br><span class="line"> *</span><br><span class="line"> * @param parentid</span><br><span class="line"> * @param page</span><br><span class="line"> * @param size</span><br><span class="line"> * @return</span><br><span class="line"> *&#x2F;</span><br><span class="line">public Page&lt;Comment&gt; findCommentListByParentid(String parentid, int page, int size) &#123;</span><br><span class="line">    return commentRepository.findByParentid(parentid, PageRequest.of(page - 1, size));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>（3）junit测试用例：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 测试根据父id查询子评论的分页列表</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Test</span><br><span class="line">public void testFindCommentListByParentid() &#123;</span><br><span class="line">    Page&lt;Comment&gt; pageResponse &#x3D; commentService.findCommentListByParentid(&quot;3&quot;, 1, 2);</span><br><span class="line">    System.out.println(&quot;----总记录数：&quot; + pageResponse.getTotalElements());</span><br><span class="line">    System.out.println(&quot;----当前页数据：&quot; + pageResponse.getContent());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>（4）测试</p><p>使用compass快速插入一条测试数据，数据的内容是对3号评论内容进行评论。</p><p><img src="https://img-blog.csdnimg.cn/20200912222735575.png" alt="image-20200912193206349"></p><p>执行测试，结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">----总记录数：1</span><br><span class="line">----当前页数据：[Comment&#123;id&#x3D;&#39;33&#39;, content&#x3D;&#39;你年轻，火力大&#39;, publishtime&#x3D;null, userid&#x3D;&#39;1003&#39;, nickname&#x3D;&#39;凯撒大帝&#39;,createdatetime&#x3D;null, likenum&#x3D;null, replynum&#x3D;null, state&#x3D;&#39;null&#39;, parentid&#x3D;&#39;3&#39;, articleid&#x3D;&#39;100001&#39;&#125;]</span><br></pre></td></tr></table></figure><h2 id="5-8-MongoTemplate-实现评论点赞"><a href="#5-8-MongoTemplate-实现评论点赞" class="headerlink" title="5.8 MongoTemplate 实现评论点赞"></a>5.8 MongoTemplate 实现评论点赞</h2><p>我们看一下以下点赞的临时示例代码： CommentService 新增updateThumbup方法</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 点赞-效率低</span><br><span class="line"> * @param id</span><br><span class="line"> *&#x2F;</span><br><span class="line">public void updateCommentThumbupToIncrementingOld(String id)&#123;</span><br><span class="line">    Comment comment &#x3D; CommentRepository.findById(id).get();</span><br><span class="line">    comment.setLikenum(comment.getLikenum()+1);</span><br><span class="line">    CommentRepository.save(comment);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上方法虽然实现起来比较简单，但是执行效率并不高，因为我只需要将点赞数加 1就可以了，没必要查询出所有字段修改后再更新所有字段。(蝴蝶效应)</p><p>我们可以使用MongoTemplate类来实现对某列的操作。 （1）修改CommentService</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;注入MongoTemplate</span><br><span class="line">@Autowired</span><br><span class="line">private MongoTemplate mongoTemplate;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 点赞数+1</span><br><span class="line"> *</span><br><span class="line"> * @param id</span><br><span class="line"> *&#x2F;</span><br><span class="line">public void updateCommentLikenum(String id) &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;  查询条件</span><br><span class="line">    Query query &#x3D; Query.query(Criteria.where(&quot;_id&quot;).is(id));</span><br><span class="line">    &#x2F;&#x2F;  更新条件</span><br><span class="line">    Update update &#x3D; new Update();</span><br><span class="line">    &#x2F;&#x2F;局部更新，相当于$set</span><br><span class="line">&#x2F;&#x2F;        update.set(key, value)</span><br><span class="line">    &#x2F;&#x2F;递增$inc</span><br><span class="line">    update.inc(&quot;likenum&quot;);</span><br><span class="line">    &#x2F;&#x2F;参数3：集合的名字或实体类的类型Comment.class</span><br><span class="line">    mongoTemplate.updateFirst(query, update, Comment.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>（ 2）测试用例：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 测试点赞数+1</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Test</span><br><span class="line">public void testUpdateCommentLikenum() &#123;</span><br><span class="line">    commentService.updateCommentLikenum(&quot;3&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行测试用例后，发现点赞数+1了：</p><p><img src="https://img-blog.csdnimg.cn/20200912222748699.png" alt="image-20200912193644179"></p><p>原文链接：<a href="https://wgy1993.gitee.io/archives/d69f1e.html" target="_blank" rel="noopener">https://wgy1993.gitee.io/archives/d69f1e.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;MongoDB-一&quot;&gt;&lt;a href=&quot;#MongoDB-一&quot; class=&quot;headerlink&quot; title=&quot;MongoDB(一)&quot;&gt;&lt;/a&gt;MongoDB(一)&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://wgy1993.gitee.io/archiv
      
    
    </summary>
    
    
      <category term="mongodb" scheme="http://yoursite.com/categories/mongodb/"/>
    
    
      <category term="mongodb" scheme="http://yoursite.com/tags/mongodb/"/>
    
  </entry>
  
  <entry>
    <title>rsync服务实现推送，拉取</title>
    <link href="http://yoursite.com/2020/12/26/k8s/20/"/>
    <id>http://yoursite.com/2020/12/26/k8s/20/</id>
    <published>2020-12-26T09:13:53.321Z</published>
    <updated>2020-12-26T09:13:53.316Z</updated>
    
    <content type="html"><![CDATA[<h1 id="rsync服务实现推送，拉取"><a href="#rsync服务实现推送，拉取" class="headerlink" title="rsync服务实现推送，拉取"></a>rsync服务实现推送，拉取</h1><p><a href="https://www.csdn.net/tags/OtTacg3sMzk5Mi1ibG9n.html" target="_blank" rel="noopener">https://www.csdn.net/tags/OtTacg3sMzk5Mi1ibG9n.html</a></p><p><strong>1.简介</strong></p><p>rsync是一款远程数据同步工具，一个Rsync server能够同时备份多个客户端数据，需要scp，ssh，daemon的支持，默认端口为873。</p><p>rsync + crond 可以实现数据定时同步，rsync + inotify可以实现数据的实时同步。</p><p>工作中的Rsync服务最好以只读方式提供要备份的数据，避免造成误操作。</p><p><strong><em>\</em>2.实验环境介绍**</strong></p><p>两台CentOS6.3 x64  测试机，一台server，一台client。系统已经默认安装了rsync软件。</p><p><img src="http://s3.51cto.com/wyfs02/M02/8A/01/wKioL1gkBdaDE-dQAAAE5R3eKYo767.png" alt="img"></p><p><strong><em>\</em>3.Rsync命令格式及命令参数**</strong></p><p><img src="http://s3.51cto.com/wyfs02/M00/8A/05/wKiom1gkBdaBFVmoAAAEEauWqYY331.png" alt="img"></p><p>参数介绍：</p><p>-a   归档模式，表示以归档方式传输文件，并保持所有文件属性</p><p>-v   详细模式输出</p><p>-z   对备份的文件在传输时进行压缩处理</p><p>–delete   无差异同步</p><p><strong><em>\</em>4.Rsync的三种工作模式**</strong></p><p>1）本地的拷贝和删除</p><p># rsync avz /etc/hosts /tmp  将文件hosts拷贝到/tmp目录中。与cp命令相似，但区别在rsync可以自己比较两个文件，实现增量备份</p><p><img src="http://s3.51cto.com/wyfs02/M02/8A/05/wKiom1gkBdaCu9GFAAAENpjOZwk289.png" alt="img"></p><p># rsync avz delete /tmp/ /opt/    /tmp/目录为空，加上 –delete参数，相当于 rm 命令</p><p>–delete可以理解为：本地有远端有，本地没有删除远端有的</p><p><img src="http://s3.51cto.com/wyfs02/M00/8A/01/wKioL1gkBdfBqcSQAAAEeSjaT88079.png" alt="img"></p><p>2）remote shell</p><p>rsync远程”推”和”拉”</p><p>（推）# rsync avzP e ‘ssh p 22’ /tmp/ <a href="mailto:root@192.168.87.138">root@192.168.87.138</a>:/tmp/aaa</p><p>把本地的 /tmp/ 目录中的文件复制到192.168.87.138的 /tmp/aaa 目录下，通过22端口</p><p><img src="http://s3.51cto.com/wyfs02/M02/8A/01/wKioL1gkBdfgv6I3AAAGCVg3uT4163.png" alt="img"></p><p>（拉）# rsync avzP e ‘ssh p 22’ <a href="mailto:root@192.168.87.138">root@192.168.87.138</a>:/tmp/ /tmp</p><p>把192.168.87.138的 /tmp/ 目录文件复制到本地的 /tmp 目录中</p><p><img src="http://s3.51cto.com/wyfs02/M00/8A/05/wKiom1gkBdfRu9JBAAAF6tIHihM264.png" alt="img"></p><p><strong># rsync -avzP -e ‘ssh -p 22’ /tmp\</strong>/** <a href="mailto:root@192.168.87.133">root@192.168.87.133</a>:/tmp**</p><p><strong># rsync -avzP -e ‘ssh -p 22’ <a href="mailto:root@192.168.87.133">root@192.168.87.133</a>:/tmp\</strong>/** /tmp**</p><p><strong>标红的斜杠，有这个就是推送指定文件夹的全部内容，没有这个就是推送整个目录</strong></p><p>3）daemon   （配置Rsync服务端步骤）</p><p>首先确认系统中安装了rsync版本及其版本号</p><p># rsync –version查看当前rsync版本</p><p># rpm qa rsync</p><p><img src="http://s3.51cto.com/wyfs02/M00/8A/01/wKioL1gkBdfzI5MAAAAfMXva_mk381.png" alt="img"></p><p>rsync的配置文件默认不存在，需要手工创建。路径为 /etc/rsyncd.conf</p><p>编辑 /etc/rsyncd.conf 文件，内容如下。复制粘贴保存退出即可。</p><p><img src="http://s3.51cto.com/wyfs02/M01/8A/05/wKiom1gkBdfyZRnNAAAEUhEq4iU490.png" alt="img"></p><p>#Rsync server</p><p>#yuci</p><p>uid = rsync</p><p>gid = rsync</p><p>use chroot = no</p><p>max connections = 2000</p><p>timeout = 600</p><p>pid file = /var/run/rsyncd.pid</p><p>lock file = /var/run/rsync.lock</p><p>log file = /var/log/rsyncd.log</p><p>ignore errors</p><p>read only = false</p><p>list = false</p><p>hosts allow = 192.168.0.0/24</p><p>hosts deny = 0.0.0.0/32</p><p>auth users = rsync_backup</p><p>secrets file = /etc/rsync.password</p><p>###################################</p><p>[backup]</p><p>comment = www by yuci</p><p>path = /backup</p><p>创建rsync用户及共享的目录 /backup（创建完后检查一下，养成好习惯）</p><p><img src="http://s3.51cto.com/wyfs02/M01/8A/01/wKioL1gkBdjzcbjKAAAM4CSuIcI314.png" alt="img"></p><p>如上编辑的文件，secrets file = /etc/rsync.password 为密码文件，可以实现两台机器互信。因为是密码所以需要更改权限。</p><p>rsync_backup 是上面配置文件的 auth users = rsync_backup  “123456”为连接时需要验证的密码</p><p><img src="http://s3.51cto.com/wyfs02/M01/8A/05/wKiom1gkBdjD35w0AAAKUNSr_A8689.png" alt="img"></p><p># rsync –daemon   启动rsync服务</p><p># netstat lntup | grep rsync   查看rsync是否正常运行在873端口</p><p># ps ef | grep rsync</p><p># echo “rsync –daemon” &gt;&gt; /etc/rc.local    加入开机自启动</p><p># cat /etc/rc.local</p><p><img src="http://s3.51cto.com/wyfs02/M01/8A/01/wKioL1gkBdjzn-nSAAAIrYeLOGo175.png" alt="img"></p><p><img src="http://s3.51cto.com/wyfs02/M02/8A/05/wKiom1gkBdjy_DqPAAAHzZg6JvE349.png" alt="img"></p><p><img src="http://s3.51cto.com/wyfs02/M02/8A/05/wKiom1gkBdnSIG1-AAASzQvpjwU577.png" alt="img"></p><p>到此为止，服务器端的配置已经完成。接下来配置客户端</p><p># echo “123456” &gt;&gt; /etc/rsync.password</p><p>只需要密码即可，因为在连接命令中已经有了 rsync_backup用户</p><p># chmod 600 /etc/rsync.password</p><p>跟服务器的密码文件相同，需要修改权限</p><p><img src="http://s3.51cto.com/wyfs02/M02/8A/01/wKioL1gkBdmwQdYDAAAIMT79i0I947.png" alt="img"></p><p>客户端只需要这简单的两步就可以了。</p><p><strong><em>\</em>5.测试环境搭建是否成功**</strong></p><p>现在要将客户端的 /tmp/ 目录中的文件，推送到服务端的 /backup 目录中，将 /backup 目录清空，在 /tmp/ 目录中随便创建几个文件</p><p>没有报错推送成功，下图选中的backup是要对应 /etc/rsyncd.conf 中的模块命令</p><p><img src="http://s3.51cto.com/wyfs02/M02/8A/01/wKioL1gkBdmBNVCUAAAR1mwLce0510.png" alt="img"></p><p>与上图的 ::backup 对应</p><p><img src="http://s3.51cto.com/wyfs02/M00/8A/05/wKiom1gkBdmDlzuxAAAJfLW17Hc554.png" alt="img"></p><p>回到服务器端检查，测试成功</p><p><img src="http://s3.51cto.com/wyfs02/M00/8A/05/wKiom1gkBdmwYMjTAAAE0_uB2wo600.png" alt="img"></p><p>本文转自  mlwzby  51CTO博客，原文链接:<a href="http://blog.51cto.com/aby028/1871433" target="_blank" rel="noopener">http://blog.51cto.com/aby028/1871433</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;rsync服务实现推送，拉取&quot;&gt;&lt;a href=&quot;#rsync服务实现推送，拉取&quot; class=&quot;headerlink&quot; title=&quot;rsync服务实现推送，拉取&quot;&gt;&lt;/a&gt;rsync服务实现推送，拉取&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://www.c
      
    
    </summary>
    
    
      <category term="rsync" scheme="http://yoursite.com/categories/rsync/"/>
    
    
      <category term="rsync" scheme="http://yoursite.com/tags/rsync/"/>
    
  </entry>
  
  <entry>
    <title>rsync用法及参数详解</title>
    <link href="http://yoursite.com/2020/12/26/k8s/19/"/>
    <id>http://yoursite.com/2020/12/26/k8s/19/</id>
    <published>2020-12-26T07:59:03.127Z</published>
    <updated>2020-12-26T07:59:03.119Z</updated>
    
    <content type="html"><![CDATA[<h2 id="rsync"><a href="#rsync" class="headerlink" title="rsync"></a>rsync</h2><p>rsync的目的是实现本地主机和远程主机上的文件同步(包括本地推到远程，远程拉到本地两种同步方式)，也可以实现本地不同路径下文件的同步，但不能实现远程路径1到远程路径2之间的同步(scp可以实现)。</p><p>不考虑rsync的实现细节，就文件同步而言，涉及了源文件和目标文件的概念，还涉及了以哪边文件为同步基准。例如，想让目标主机上的文件和本地文件保持同步，则是以本地文件为同步基准，将本地文件作为源文件推送到目标主机上。反之，如果想让本地主机上的文件和目标主机上的文件保持同步，则目标主机上的文件为同步基准，实现方式是将目标主机上的文件作为源文件拉取到本地。当然，要保持本地的两个文件相互同步，rsync也一样能实现，这就像Linux中cp命令一样，以本地某文件作为源，另一文件作为目标文件，但请注意，虽然rsync和cp能达到相同的目的，但它们的实现方式是不一样的。</p><p>既然是文件同步，在同步过程中必然会涉及到源和目标两文件之间版本控制的问题，例如是否要删除源主机上没有但目标上多出来的文件，目标文件比源文件更新(newer than source)时是否仍要保持同步，遇到软链接时是拷贝软链接本身还是拷贝软链接所指向的文件，目标文件已存在时是否要先对其做个备份等等。</p><p><strong>rsync同步过程中由两部分模式组成：决定哪些文件需要同步的检查模式以及文件同步时的同步模式。</strong></p><p>(1).检查模式是指按照指定规则来检查哪些文件需要被同步，例如哪些文件是明确被排除不传输的。<strong>默认情况下，rsync使用”quick check”算法快速检查源文件和目标文件的大小、mtime(修改时间)是否一致，如果不一致则需要传输。</strong>当然，也可以通过在rsync命令行中指定某些选项来改变quick check的检查模式，比如”–size-only”选项表示”quick check”将仅检查文件大小不同的文件作为待传输文件。rsync支持非常多的选项，其中检查模式的自定义性是非常有弹性的。</p><p>(2).同步模式是指在文件确定要被同步后，在同步过程发生之前要做哪些额外工作。例如上文所说的是否要先删除源主机上没有但目标主机上有的文件，是否要先备份已存在的目标文件，是否要追踪链接文件等额外操作。rsync也提供非常多的选项使得同步模式变得更具弹性。</p><p>相对来说，为rsync手动指定同步模式的选项更常见一些，只有在有特殊需求时才指定检查模式，因为大多数检查模式选项都可能会影响rsync的性能。</p><p>rsync 的命令格式（用法）为：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">1）本地使用：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rsync [OPTION...] SRC... [DEST]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2）通过远程 Shell 使用：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">拉: rsync [OPTION...] [USER@]HOST:SRC... [DEST]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">推: rsync [OPTION...] SRC... [USER@]HOST:DEST</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3）访问 rsync 服务器:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">拉: rsync [OPTION...] [USER@]HOST::SRC... [DEST]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">推: rsync [OPTION...] SRC... [USER@]HOST::DEST</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">拉: rsync [OPTION...] rsync://[USER@]HOST[:PORT]/SRC... [DEST]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">推: rsync [OPTION...] SRC... rsync://[USER@]HOST[:PORT]/DEST</span><br></pre></td></tr></table></figure><p>其中：</p><ul><li><p>SRC: 是要复制的源位置</p></li><li><p>DEST: 是复制目标位置</p></li><li><p>若本地登录用户与远程主机上的用户一致，可以省略 USER@</p></li><li><p>使用远程 shell 同步时，主机名与资源之间使用单个冒号“:”作为分隔符</p></li><li><p>使用 rsync 服务器同步时，主机名与资源之间使用两个冒号“::”作为分隔符</p></li><li><p>当访问 rsync 服务器时也可以使用 rsync:// URL</p></li><li><p>“拉”复制是指从远程主机复制文件到本地主机</p></li><li><p>“推”复制是指从本地主机复制文件到远程主机</p></li><li><p>当进行“拉”复制时，若指定一个 SRC 且省略 DEST，则只列出资源而不进行复制</p><p>下面列出常用选项：</p><table><thead><tr><th align="left">选项</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">-a, ––archive</td><td align="left">归档模式，表示以递归方式传输文件，并保持所有文件属性，等价于 -rlptgoD (注意不包括 -H)</td></tr><tr><td align="left">-r, ––recursive</td><td align="left">对子目录以递归模式处理</td></tr><tr><td align="left">-l, ––links</td><td align="left">保持符号链接文件</td></tr><tr><td align="left">-H, ––hard-links</td><td align="left">保持硬链接文件</td></tr><tr><td align="left">-p, ––perms</td><td align="left">保持文件权限</td></tr><tr><td align="left">-t, ––times</td><td align="left">保持文件时间信息</td></tr><tr><td align="left">-g, ––group</td><td align="left">保持文件属组信息</td></tr><tr><td align="left">-o, ––owner</td><td align="left">保持文件属主信息 (super-user only)</td></tr><tr><td align="left">-D</td><td align="left">保持设备文件和特殊文件 (super-user only)</td></tr><tr><td align="left">-z, ––compress</td><td align="left">在传输文件时进行压缩处理</td></tr><tr><td align="left">––exclude=PATTERN</td><td align="left">指定排除一个不需要传输的文件匹配模式</td></tr><tr><td align="left">––exclude-from=FILE</td><td align="left">从 FILE 中读取排除规则</td></tr><tr><td align="left">––include=PATTERN</td><td align="left">指定需要传输的文件匹配模式</td></tr><tr><td align="left">––include-from=FILE</td><td align="left">从 FILE 中读取包含规则</td></tr><tr><td align="left">––copy-unsafe-links</td><td align="left">拷贝指向SRC路径目录树以外的链接文件</td></tr><tr><td align="left">––safe-links</td><td align="left">忽略指向SRC路径目录树以外的链接文件（默认）</td></tr><tr><td align="left">––existing</td><td align="left">仅仅更新那些已经存在于接收端的文件，而不备份那些新创建的文件</td></tr><tr><td align="left">––ignore-existing</td><td align="left">忽略那些已经存在于接收端的文件，仅备份那些新创建的文件</td></tr><tr><td align="left">-b, ––backup</td><td align="left">当有变化时，对目标目录中的旧版文件进行备份</td></tr><tr><td align="left">––backup-dir=DIR</td><td align="left">与 -b 结合使用，将备份的文件存到 DIR 目录中</td></tr><tr><td align="left">––link-dest=DIR</td><td align="left">当文件未改变时基于 DIR 创建硬链接文件</td></tr><tr><td align="left">––delete</td><td align="left">删除那些接收端还有而发送端已经不存在的文件</td></tr><tr><td align="left">––delete-before</td><td align="left">接收者在传输之前进行删除操作 (默认)</td></tr><tr><td align="left">––delete-during</td><td align="left">接收者在传输过程中进行删除操作</td></tr><tr><td align="left">––delete-after</td><td align="left">接收者在传输之后进行删除操作</td></tr><tr><td align="left">––delete-excluded</td><td align="left">在接收方同时删除被排除的文件</td></tr><tr><td align="left">-e, ––rsh=COMMAND</td><td align="left">指定替代 rsh 的 shell 程序</td></tr><tr><td align="left">––ignore-errors</td><td align="left">即使出现 I/O 错误也进行删除</td></tr><tr><td align="left">––partial</td><td align="left">保留那些因故没有完全传输的文件，以是加快随后的再次传输</td></tr><tr><td align="left">––progress</td><td align="left">在传输时显示传输过程</td></tr><tr><td align="left">-P</td><td align="left">等价于 ––partial ––progress</td></tr><tr><td align="left">––delay-updates</td><td align="left">将正在更新的文件先保存到一个临时目录（默认为 “.<del>tmp</del>”），待传输完毕再更新目标文件</td></tr><tr><td align="left">-v, ––verbose</td><td align="left">详细输出模式</td></tr><tr><td align="left">-q, ––quiet</td><td align="left">精简输出模式</td></tr><tr><td align="left">-h, ––human-readable</td><td align="left">输出文件大小使用易读的单位（如，K，M等）</td></tr><tr><td align="left">-n, ––dry-run</td><td align="left">显示哪些文件将被传输</td></tr><tr><td align="left">––list-only</td><td align="left">仅仅列出文件而不进行复制</td></tr><tr><td align="left">––rsyncpath=PROGRAM</td><td align="left">指定远程服务器上的 rsync 命令所在路径</td></tr><tr><td align="left">––password-file=FILE</td><td align="left">从 FILE 中读取口令，以避免在终端上输入口令，通常在 cron 中连接 rsync 服务器时使用</td></tr><tr><td align="left">-4, ––ipv4</td><td align="left">使用 IPv4</td></tr><tr><td align="left">-6, ––ipv6</td><td align="left">使用 IPv6</td></tr><tr><td align="left">––version</td><td align="left">打印版本信息</td></tr><tr><td align="left">––help</td><td align="left">显示帮助信息</td></tr></tbody></table></li><li><p>若使用普通用户身份运行 rsync 命令，同步后的文件的属主将改变为这个普通用户身份。</p></li><li><p>若使用超级用户身份运行 rsync 命令，同步后的文件的属主将保持原来的用户身份。</p></li></ul><p>摘自：</p><p><a href="https://www.cnblogs.com/noxy/p/8986164.html" target="_blank" rel="noopener">https://www.cnblogs.com/noxy/p/8986164.html</a></p><p><a href="http://www.cnblogs.com/f-ck-need-u/p/7220009.html" target="_blank" rel="noopener">http://www.cnblogs.com/f-ck-need-u/p/7220009.html</a></p><p><a href="https://blog.csdn.net/woshiji594167/article/details/83860993" target="_blank" rel="noopener">https://blog.csdn.net/woshiji594167/article/details/83860993</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;rsync&quot;&gt;&lt;a href=&quot;#rsync&quot; class=&quot;headerlink&quot; title=&quot;rsync&quot;&gt;&lt;/a&gt;rsync&lt;/h2&gt;&lt;p&gt;rsync的目的是实现本地主机和远程主机上的文件同步(包括本地推到远程，远程拉到本地两种同步方式)，也可以实现本地不
      
    
    </summary>
    
    
      <category term="rsync" scheme="http://yoursite.com/categories/rsync/"/>
    
    
      <category term="rsync" scheme="http://yoursite.com/tags/rsync/"/>
    
  </entry>
  
  <entry>
    <title>K8S(15)监控实战-ELK收集K8S内应用日志</title>
    <link href="http://yoursite.com/2020/12/26/k8s/17/"/>
    <id>http://yoursite.com/2020/12/26/k8s/17/</id>
    <published>2020-12-26T07:58:55.160Z</published>
    <updated>2020-12-26T07:58:55.151Z</updated>
    
    <content type="html"><![CDATA[<h1 id="K8S监控实战-ELK收集K8S内应用日志"><a href="#K8S监控实战-ELK收集K8S内应用日志" class="headerlink" title="K8S监控实战-ELK收集K8S内应用日志"></a>K8S监控实战-ELK收集K8S内应用日志</h1><p>目录</p><ul><li><p>K8S监控实战-ELK收集K8S内应用日志</p></li><li><ul><li>1 收集K8S日志方案</li></ul></li><li><ul><li><ul><li>1.1 传统ELk模型缺点：</li><li>1.2 K8s容器日志收集模型</li></ul></li></ul></li><li><ul><li>2 制作tomcat底包</li></ul></li><li><ul><li><ul><li>2.1 准备tomcat底包</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>2.1.1 下载tomcat8</li><li>2.1.2 简单配置tomcat</li></ul></li></ul></li></ul></li><li><ul><li><ul><li>2.2 准备docker镜像</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>2.2.1 创建dockerfile</li><li>2.2.2 准备dockerfile所需文件</li><li>2.2.3 构建docker</li></ul></li></ul></li></ul></li><li><ul><li>3 部署ElasticSearch</li></ul></li><li><ul><li><ul><li>3.1 安装ElasticSearch</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>3.1.1 下载二进制包</li><li>3.1.2 配置elasticsearch.yml</li></ul></li></ul></li></ul></li><li><ul><li><ul><li>3.2 优化其他设置</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>3.2.1 设置jvm参数</li><li>3.2.2 创建普通用户</li><li>3.2.3 调整文件描述符</li><li>3.2.4 调整内核参数</li></ul></li></ul></li></ul></li><li><ul><li><ul><li>3.3 启动ES</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>3.3.1 启动es服务</li><li>3.3.1 调整ES日志模板</li></ul></li></ul></li></ul></li><li><ul><li>4 部署kafka和kafka-manager</li></ul></li><li><ul><li><ul><li>4.1 但节点安装kafka</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>4.1.1 下载包</li><li>4.1.2 修改配置</li><li>4.1.3 启动kafka</li></ul></li></ul></li></ul></li><li><ul><li><ul><li>4.2 获取kafka-manager的docker镜像</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>4.2.1 方法一 通过dockerfile获取</li><li>4.2.2 直接下载docker镜像</li><li>4.3 部署kafka-manager</li></ul></li></ul></li></ul></li><li><ul><li><ul><li>4.3.1 准备dp清单</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>4.3.2 准备svc资源清单</li><li>4.3.3 准备ingress资源清单</li><li>4.3.4 应用资源配置清单</li><li>4.3.5 解析域名</li><li>4.3.6 浏览器访问</li></ul></li></ul></li></ul></li><li><ul><li>5 部署filebeat</li></ul></li><li><ul><li><ul><li>5.1 制作docker镜像</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>5.1.1 准备Dockerfile</li><li>5.1.2 准备filebeat配置文件</li><li>5.1.3 准备启动脚本</li><li>5.1.4 构建镜像</li></ul></li></ul></li></ul></li><li><ul><li><ul><li>5.2 以边车模式运行POD</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>5.2.1 准备资源配置清单</li><li>5.2.2 应用资源清单</li></ul></li></ul></li></ul></li><li><ul><li><ul><li>5.2.3 验证</li></ul></li></ul></li><li><ul><li>6 部署logstash</li></ul></li><li><ul><li><ul><li>6.1 准备docker镜像</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>6.1.1 下载官方镜像</li><li>6.1.2 准备配置文件</li></ul></li></ul></li></ul></li><li><ul><li><ul><li>6.2 启动logstash</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>6.2.1 启动测试环境的logstash</li><li>6.2.2 查看es是否接收数据</li><li>6.2.3 启动正式环境的logstash</li></ul></li></ul></li></ul></li><li><ul><li>7 部署Kibana</li></ul></li><li><ul><li><ul><li>7.1 准备相关资源</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>7.1.1 准备docker镜像</li><li>7.1.3 准备dp资源清单</li><li>7.1.4 准备svc资源清单</li><li>7.1.5 准备ingress资源清单</li></ul></li></ul></li></ul></li><li><ul><li><ul><li>7.2 应用资源</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>7.2.1 应用资源配置清单</li><li>7.2.2 解析域名</li><li>7.2.3 浏览器访问</li></ul></li></ul></li></ul></li><li><ul><li><ul><li>7.3 kibana的使用</li></ul></li></ul></li></ul><h2 id="1-收集K8S日志方案"><a href="#1-收集K8S日志方案" class="headerlink" title="1 收集K8S日志方案"></a>1 收集K8S日志方案</h2><p>K8s系统里的业务应用是高度“动态化”的，随着容器编排的进行，业务容器在不断的被创建、被摧毁、被漂移、被扩缩容…</p><p>我们需要这样一套日志收集、分析的系统：</p><ol><li>收集 – 能够采集多种来源的日志数据（流式日志收集器）</li><li>传输 – 能够稳定的把日志数据传输到中央系统（消息队列）</li><li>存储 – 可以将日志以结构化数据的形式存储起来（搜索引擎）</li><li>分析 – 支持方便的分析、检索方法，最好有GUI管理系统（web）</li><li>警告 – 能够提供错误报告，监控机制（监控系统）</li></ol><h3 id="1-1-传统ELk模型缺点："><a href="#1-1-传统ELk模型缺点：" class="headerlink" title="1.1 传统ELk模型缺点："></a>1.1 传统ELk模型缺点：</h3><p><a href="https://img2020.cnblogs.com/blog/1400393/202008/1400393-20200817091851120-1924717712.jpg" target="_blank" rel="noopener"><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/2511954/1601220131710-91d0ec84-4c3a-47cf-a7d7-9947bd6435be.jpeg?x-oss-process=image%2Fresize%2Cw_1500" alt="image"></a></p><ol><li>Logstash使用Jruby语言开发，吃资源，大量部署消耗极高</li><li>业务程序与logstash耦合过松，不利于业务迁移</li><li>日志收集与ES耦合又过紧，（Logstash）易打爆（ES）、丢数据</li><li>在容器云环境下，传统ELk模型难以完成工作</li></ol><h3 id="1-2-K8s容器日志收集模型"><a href="#1-2-K8s容器日志收集模型" class="headerlink" title="1.2 K8s容器日志收集模型"></a>1.2 K8s容器日志收集模型</h3><p><a href="https://img2020.cnblogs.com/blog/1400393/202008/1400393-20200817091802981-198328129.png" target="_blank" rel="noopener"><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601220131745-5701f5c6-17a2-4a80-9eda-f3389d14d071.png" alt="image"></a></p><h2 id="2-制作tomcat底包"><a href="#2-制作tomcat底包" class="headerlink" title="2 制作tomcat底包"></a>2 制作tomcat底包</h2><h3 id="2-1-准备tomcat底包"><a href="#2-1-准备tomcat底包" class="headerlink" title="2.1 准备tomcat底包"></a>2.1 准备tomcat底包</h3><h4 id="2-1-1-下载tomcat8"><a href="#2-1-1-下载tomcat8" class="headerlink" title="2.1.1 下载tomcat8"></a>2.1.1 下载tomcat8</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;src&#x2F;</span><br><span class="line">wget http:&#x2F;&#x2F;mirror.bit.edu.cn&#x2F;apache&#x2F;tomcat&#x2F;tomcat-8&#x2F;v8.5.50&#x2F;bin&#x2F;apache-tomcat-8.5.50.tar.gz</span><br><span class="line">mkdir &#x2F;data&#x2F;dockerfile&#x2F;tomcat</span><br><span class="line">tar xf apache-tomcat-8.5.50.tar.gz -C &#x2F;data&#x2F;dockerfile&#x2F;tomcat</span><br><span class="line">cd &#x2F;data&#x2F;dockerfile&#x2F;tomcat</span><br></pre></td></tr></table></figure><h4 id="2-1-2-简单配置tomcat"><a href="#2-1-2-简单配置tomcat" class="headerlink" title="2.1.2 简单配置tomcat"></a>2.1.2 简单配置tomcat</h4><p>删除自带网页</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf apache-tomcat-8.5.50&#x2F;webapps&#x2F;*</span><br></pre></td></tr></table></figure><p>关闭AJP端口</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tomcat]# vim apache-tomcat-8.5.50&#x2F;conf&#x2F;server.xml</span><br><span class="line">  &lt;!-- &lt;Connector port&#x3D;&quot;8009&quot; protocol&#x3D;&quot;AJP&#x2F;1.3&quot; redirectPort&#x3D;&quot;8443&quot; &#x2F;&gt; --&gt;</span><br></pre></td></tr></table></figure><p>修改日志类型</p><blockquote><p>删除3manager，4host-manager的handlers</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tomcat]# vim apache-tomcat-8.5.50&#x2F;conf&#x2F;logging.properties</span><br><span class="line">handlers &#x3D; [1catalina.org.apache.juli.AsyncFileHandler](http:&#x2F;&#x2F;1catalina.org.apache.juli.asyncfilehandler&#x2F;), [2localhost.org.apache.juli.AsyncFileHandler](http:&#x2F;&#x2F;2localhost.org.apache.juli.asyncfilehandler&#x2F;), java.util.logging.ConsoleHandler</span><br></pre></td></tr></table></figure><p>日志级别改为INFO</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1catalina.org.apache.juli.AsyncFileHandler.level &#x3D; INFO</span><br><span class="line">2localhost.org.apache.juli.AsyncFileHandler.level &#x3D; INFO</span><br><span class="line">java.util.logging.ConsoleHandler.level &#x3D; INFO</span><br></pre></td></tr></table></figure><p>注释所有关于3manager，4host-manager日志的配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#3manager.org.apache.juli.AsyncFileHandler.level &#x3D; FINE</span><br><span class="line">#3manager.org.apache.juli.AsyncFileHandler.directory &#x3D; $&#123;catalina.base&#125;&#x2F;logs</span><br><span class="line">#3manager.org.apache.juli.AsyncFileHandler.prefix &#x3D; manager.</span><br><span class="line">#3manager.org.apache.juli.AsyncFileHandler.encoding &#x3D; UTF-8</span><br><span class="line">#4host-manager.org.apache.juli.AsyncFileHandler.level &#x3D; FINE</span><br><span class="line">#4host-manager.org.apache.juli.AsyncFileHandler.directory &#x3D; $&#123;catalina.base&#125;&#x2F;logs</span><br><span class="line">#4host-manager.org.apache.juli.AsyncFileHandler.prefix &#x3D; host-manager.</span><br><span class="line">#4host-manager.org.apache.juli.AsyncFileHandler.encoding &#x3D; UTF-8</span><br></pre></td></tr></table></figure><h3 id="2-2-准备docker镜像"><a href="#2-2-准备docker镜像" class="headerlink" title="2.2 准备docker镜像"></a>2.2 准备docker镜像</h3><h4 id="2-2-1-创建dockerfile"><a href="#2-2-1-创建dockerfile" class="headerlink" title="2.2.1 创建dockerfile"></a>2.2.1 创建dockerfile</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;Dockerfile &lt;&lt;&#39;EOF&#39;</span><br><span class="line">From harbor.od.com&#x2F;public&#x2F;jre:8u112</span><br><span class="line">RUN &#x2F;bin&#x2F;cp &#x2F;usr&#x2F;share&#x2F;zoneinfo&#x2F;Asia&#x2F;Shanghai &#x2F;etc&#x2F;localtime &amp;&amp;\</span><br><span class="line">  echo &#39;Asia&#x2F;Shanghai&#39; &gt;&#x2F;etc&#x2F;timezone</span><br><span class="line">ENV CATALINA_HOME &#x2F;opt&#x2F;tomcat</span><br><span class="line">ENV LANG zh_CN.UTF-8</span><br><span class="line">ADD apache-tomcat-8.5.50&#x2F; &#x2F;opt&#x2F;tomcat</span><br><span class="line">ADD config.yml &#x2F;opt&#x2F;prom&#x2F;config.yml</span><br><span class="line">ADD jmx_javaagent-0.3.1.jar &#x2F;opt&#x2F;prom&#x2F;jmx_javaagent-0.3.1.jar</span><br><span class="line">WORKDIR &#x2F;opt&#x2F;tomcat</span><br><span class="line">ADD entrypoint.sh &#x2F;entrypoint.sh</span><br><span class="line">CMD [&quot;&#x2F;bin&#x2F;bash&quot;,&quot;&#x2F;entrypoint.sh&quot;]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="2-2-2-准备dockerfile所需文件"><a href="#2-2-2-准备dockerfile所需文件" class="headerlink" title="2.2.2 准备dockerfile所需文件"></a>2.2.2 准备dockerfile所需文件</h4><p>JVM监控所需jar包</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget  -O jmx_javaagent-0.3.1.jar https:&#x2F;&#x2F;repo1.maven.org&#x2F;maven2&#x2F;io&#x2F;prometheus&#x2F;jmx&#x2F;jmx_prometheus_javaagent&#x2F;0.3.1&#x2F;jmx_prometheus_javaagent-0.3.1.jar</span><br></pre></td></tr></table></figure><p>jmx_agent读取的配置文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;config.yml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">---</span><br><span class="line">rules:</span><br><span class="line"> - pattern: &#39;.*&#39;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>容器启动脚本</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat  &gt;entrypoint.sh &lt;&lt;&#39;EOF&#39;</span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">M_OPTS&#x3D;&quot;-Duser.timezone&#x3D;Asia&#x2F;Shanghai -javaagent:&#x2F;opt&#x2F;prom&#x2F;jmx_javaagent-0.3.1.jar&#x3D;$(hostname -i):$&#123;M_PORT:-&quot;12346&quot;&#125;:&#x2F;opt&#x2F;prom&#x2F;config.yml&quot; # Pod ip:port 监控规则传给jvm监控客户端</span><br><span class="line">C_OPTS&#x3D;$&#123;C_OPTS&#125;             # 启动追加参数</span><br><span class="line">MIN_HEAP&#x3D;$&#123;MIN_HEAP:-&quot;128m&quot;&#125; # java虚拟机初始化时的最小内存</span><br><span class="line">MAX_HEAP&#x3D;$&#123;MAX_HEAP:-&quot;128m&quot;&#125; # java虚拟机初始化时的最大内存</span><br><span class="line">JAVA_OPTS&#x3D;$&#123;JAVA_OPTS:-&quot;-Xmn384m -Xss256k -Duser.timezone&#x3D;GMT+08  -XX:+DisableExplicitGC -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:+CMSParallelRemarkEnabled -XX:+UseCMSCompactAtFullCollection -XX:CMSFullGCsBeforeCompaction&#x3D;0 -XX:+CMSClassUnloadingEnabled -XX:LargePageSizeInBytes&#x3D;128m -XX:+UseFastAccessorMethods -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction&#x3D;80 -XX:SoftRefLRUPolicyMSPerMB&#x3D;0 -XX:+PrintClassHistogram  -Dfile.encoding&#x3D;UTF8 -Dsun.jnu.encoding&#x3D;UTF8&quot;&#125;     # 年轻代，gc回收</span><br><span class="line">CATALINA_OPTS&#x3D;&quot;$&#123;CATALINA_OPTS&#125;&quot;</span><br><span class="line">JAVA_OPTS&#x3D;&quot;$&#123;M_OPTS&#125; $&#123;C_OPTS&#125; -Xms$&#123;MIN_HEAP&#125; -Xmx$&#123;MAX_HEAP&#125; $&#123;JAVA_OPTS&#125;&quot;</span><br><span class="line">sed -i -e &quot;1a\JAVA_OPTS&#x3D;\&quot;$JAVA_OPTS\&quot;&quot; -e &quot;1a\CATALINA_OPTS&#x3D;\&quot;$CATALINA_OPTS\&quot;&quot; &#x2F;opt&#x2F;tomcat&#x2F;bin&#x2F;catalina.sh   </span><br><span class="line">cd &#x2F;opt&#x2F;tomcat &amp;&amp; &#x2F;opt&#x2F;tomcat&#x2F;bin&#x2F;catalina.sh run 2&gt;&amp;1 &gt;&gt; &#x2F;opt&#x2F;tomcat&#x2F;logs&#x2F;stdout.log # 日志文件</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="2-2-3-构建docker"><a href="#2-2-3-构建docker" class="headerlink" title="2.2.3 构建docker"></a>2.2.3 构建docker</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build . -t harbor.zq.com&#x2F;base&#x2F;tomcat:v8.5.50</span><br><span class="line">docker push       harbor.zq.com&#x2F;base&#x2F;tomcat:v8.5.50</span><br></pre></td></tr></table></figure><h2 id="3-部署ElasticSearch"><a href="#3-部署ElasticSearch" class="headerlink" title="3 部署ElasticSearch"></a>3 部署ElasticSearch</h2><p><a href="https://www.elastic.co/" target="_blank" rel="noopener">官网</a></p><p><a href="https://github.com/elastic/elasticsearch" target="_blank" rel="noopener">官方github地址</a></p><p><a href="https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.6.15.tar.gz" target="_blank" rel="noopener">下载地址</a></p><p>部署<code>HDSS7-12.host.com</code>上：</p><h3 id="3-1-安装ElasticSearch"><a href="#3-1-安装ElasticSearch" class="headerlink" title="3.1 安装ElasticSearch"></a>3.1 安装ElasticSearch</h3><h4 id="3-1-1-下载二进制包"><a href="#3-1-1-下载二进制包" class="headerlink" title="3.1.1 下载二进制包"></a>3.1.1 下载二进制包</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;src</span><br><span class="line">wget https:&#x2F;&#x2F;artifacts.elastic.co&#x2F;downloads&#x2F;elasticsearch&#x2F;elasticsearch-6.8.6.tar.gz</span><br><span class="line">tar xf elasticsearch-6.8.6.tar.gz -C &#x2F;opt&#x2F;</span><br><span class="line">ln -s &#x2F;opt&#x2F;elasticsearch-6.8.6&#x2F; &#x2F;opt&#x2F;elasticsearch</span><br><span class="line">cd &#x2F;opt&#x2F;elasticsearch</span><br></pre></td></tr></table></figure><h4 id="3-1-2-配置elasticsearch-yml"><a href="#3-1-2-配置elasticsearch-yml" class="headerlink" title="3.1.2 配置elasticsearch.yml"></a>3.1.2 配置elasticsearch.yml</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;data&#x2F;elasticsearch&#x2F;&#123;data,logs&#125;</span><br><span class="line">cat &gt;config&#x2F;elasticsearch.yml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">cluster.name: es.zq.com</span><br><span class="line">node.name: hdss7-12.host.com</span><br><span class="line">path.data: &#x2F;data&#x2F;elasticsearch&#x2F;data</span><br><span class="line">path.logs: &#x2F;data&#x2F;elasticsearch&#x2F;logs</span><br><span class="line">bootstrap.memory_lock: true</span><br><span class="line">network.host: 10.4.7.12</span><br><span class="line">http.port: 9200</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="3-2-优化其他设置"><a href="#3-2-优化其他设置" class="headerlink" title="3.2 优化其他设置"></a>3.2 优化其他设置</h3><h4 id="3-2-1-设置jvm参数"><a href="#3-2-1-设置jvm参数" class="headerlink" title="3.2.1 设置jvm参数"></a>3.2.1 设置jvm参数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch]# vi config&#x2F;jvm.options</span><br><span class="line"># 根据环境设置，-Xms和-Xmx设置为相同的值，推荐设置为机器内存的一半左右</span><br><span class="line">-Xms512m </span><br><span class="line">-Xmx512m</span><br></pre></td></tr></table></figure><h4 id="3-2-2-创建普通用户"><a href="#3-2-2-创建普通用户" class="headerlink" title="3.2.2 创建普通用户"></a>3.2.2 创建普通用户</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useradd -s &#x2F;bin&#x2F;bash -M es</span><br><span class="line">chown -R es.es &#x2F;opt&#x2F;elasticsearch-6.8.6</span><br><span class="line">chown -R es.es &#x2F;data&#x2F;elasticsearch&#x2F;</span><br></pre></td></tr></table></figure><h4 id="3-2-3-调整文件描述符"><a href="#3-2-3-调整文件描述符" class="headerlink" title="3.2.3 调整文件描述符"></a>3.2.3 调整文件描述符</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;security&#x2F;limits.d&#x2F;es.conf</span><br><span class="line">es hard nofile 65536</span><br><span class="line">es soft fsize unlimited</span><br><span class="line">es hard memlock unlimited</span><br><span class="line">es soft memlock unlimited</span><br></pre></td></tr></table></figure><h4 id="3-2-4-调整内核参数"><a href="#3-2-4-调整内核参数" class="headerlink" title="3.2.4 调整内核参数"></a>3.2.4 调整内核参数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w vm.max_map_count&#x3D;262144</span><br><span class="line">echo &quot;vm.max_map_count&#x3D;262144&quot; &gt; &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure><h3 id="3-3-启动ES"><a href="#3-3-启动ES" class="headerlink" title="3.3 启动ES"></a>3.3 启动ES</h3><h4 id="3-3-1-启动es服务"><a href="#3-3-1-启动es服务" class="headerlink" title="3.3.1 启动es服务"></a>3.3.1 启动es服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">]# su -c &quot;&#x2F;opt&#x2F;elasticsearch&#x2F;bin&#x2F;elasticsearch -d&quot; es</span><br><span class="line">]# netstat -luntp|grep 9200</span><br><span class="line">tcp6    0   0 10.4.7.12:9200     :::*          LISTEN   16784&#x2F;java</span><br></pre></td></tr></table></figure><h4 id="3-3-1-调整ES日志模板"><a href="#3-3-1-调整ES日志模板" class="headerlink" title="3.3.1 调整ES日志模板"></a>3.3.1 调整ES日志模板</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT http:&#x2F;&#x2F;10.4.7.12:9200&#x2F;_template&#x2F;k8s -d &#39;&#123;</span><br><span class="line"> &quot;template&quot; : &quot;k8s*&quot;,</span><br><span class="line"> &quot;index_patterns&quot;: [&quot;k8s*&quot;], </span><br><span class="line"> &quot;settings&quot;: &#123;</span><br><span class="line">  &quot;number_of_shards&quot;: 5,</span><br><span class="line">  &quot;number_of_replicas&quot;: 0    # 生产为3份副本集，本es为单节点，不能配置副本集</span><br><span class="line"> &#125;</span><br><span class="line">&#125;&#39;</span><br></pre></td></tr></table></figure><h2 id="4-部署kafka和kafka-manager"><a href="#4-部署kafka和kafka-manager" class="headerlink" title="4 部署kafka和kafka-manager"></a>4 部署kafka和kafka-manager</h2><p><a href="http://kafka.apache.org/" target="_blank" rel="noopener">官网</a></p><p><a href="https://github.com/apache/kafka" target="_blank" rel="noopener">官方github地址</a></p><p><a href="http://mirrors.tuna.tsinghua.edu.cn/apache/kafka/2.1.1/kafka_2.12-2.1.1.tgz" target="_blank" rel="noopener">下载地址</a></p><p><code>HDSS7-11.host.com</code>上：</p><h3 id="4-1-但节点安装kafka"><a href="#4-1-但节点安装kafka" class="headerlink" title="4.1 但节点安装kafka"></a>4.1 但节点安装kafka</h3><h4 id="4-1-1-下载包"><a href="#4-1-1-下载包" class="headerlink" title="4.1.1 下载包"></a>4.1.1 下载包</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;src</span><br><span class="line">wget https:&#x2F;&#x2F;archive.apache.org&#x2F;dist&#x2F;kafka&#x2F;2.2.0&#x2F;kafka_2.12-2.2.0.tgz</span><br><span class="line">tar xf kafka_2.12-2.2.0.tgz -C &#x2F;opt&#x2F;</span><br><span class="line">ln -s &#x2F;opt&#x2F;kafka_2.12-2.2.0&#x2F; &#x2F;opt&#x2F;kafka</span><br><span class="line">cd &#x2F;opt&#x2F;kafka</span><br></pre></td></tr></table></figure><h4 id="4-1-2-修改配置"><a href="#4-1-2-修改配置" class="headerlink" title="4.1.2 修改配置"></a>4.1.2 修改配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;data&#x2F;kafka&#x2F;logs -p</span><br><span class="line">cat &gt;config&#x2F;server.properties &lt;&lt;&#39;EOF&#39;</span><br><span class="line">log.dirs&#x3D;&#x2F;data&#x2F;kafka&#x2F;logs</span><br><span class="line">zookeeper.connect&#x3D;localhost:2181    # zk消息队列地址 </span><br><span class="line">log.flush.interval.messages&#x3D;10000</span><br><span class="line">log.flush.interval.ms&#x3D;1000</span><br><span class="line">delete.topic.enable&#x3D;true</span><br><span class="line">host.name&#x3D;hdss7-11.host.com</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-1-3-启动kafka"><a href="#4-1-3-启动kafka" class="headerlink" title="4.1.3 启动kafka"></a>4.1.3 启动kafka</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bin&#x2F;kafka-server-start.sh -daemon config&#x2F;server.properties</span><br><span class="line">]# netstat -luntp|grep 9092</span><br><span class="line">tcp6    0   0 10.4.7.11:9092     :::*          LISTEN   34240&#x2F;java</span><br></pre></td></tr></table></figure><h3 id="4-2-获取kafka-manager的docker镜像"><a href="#4-2-获取kafka-manager的docker镜像" class="headerlink" title="4.2 获取kafka-manager的docker镜像"></a>4.2 获取kafka-manager的docker镜像</h3><p><a href="https://github.com/yahoo/kafka-manager" target="_blank" rel="noopener">官方github地址</a></p><p><a href="https://github.com/yahoo/kafka-manager/archive/2.0.0.2.tar.gz" target="_blank" rel="noopener">源码下载地址</a></p><p>运维主机<code>HDSS7-200.host.com</code>上：</p><p>kafka-manager是kafka的一个web管理页面,非必须</p><h4 id="4-2-1-方法一-通过dockerfile获取"><a href="#4-2-1-方法一-通过dockerfile获取" class="headerlink" title="4.2.1 方法一 通过dockerfile获取"></a>4.2.1 方法一 通过dockerfile获取</h4><p>1 准备Dockerfile</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;data&#x2F;dockerfile&#x2F;kafka-manager&#x2F;Dockerfile &lt;&lt;&#39;EOF&#39;</span><br><span class="line">FROM hseeberger&#x2F;scala-sbt</span><br><span class="line">ENV ZK_HOSTS&#x3D;10.4.7.11:2181 \</span><br><span class="line">     KM_VERSION&#x3D;2.0.0.2</span><br><span class="line">RUN mkdir -p &#x2F;tmp &amp;&amp; \</span><br><span class="line">    cd &#x2F;tmp &amp;&amp; \</span><br><span class="line">    wget https:&#x2F;&#x2F;github.com&#x2F;yahoo&#x2F;kafka-manager&#x2F;archive&#x2F;$&#123;KM_VERSION&#125;.tar.gz &amp;&amp; \</span><br><span class="line">    tar xxf $&#123;KM_VERSION&#125;.tar.gz &amp;&amp; \</span><br><span class="line">    cd &#x2F;tmp&#x2F;kafka-manager-$&#123;KM_VERSION&#125; &amp;&amp; \</span><br><span class="line">    sbt clean dist &amp;&amp; \</span><br><span class="line">    unzip  -d &#x2F; .&#x2F;target&#x2F;universal&#x2F;kafka-manager-$&#123;KM_VERSION&#125;.zip &amp;&amp; \</span><br><span class="line">    rm -fr &#x2F;tmp&#x2F;$&#123;KM_VERSION&#125; &#x2F;tmp&#x2F;kafka-manager-$&#123;KM_VERSION&#125;</span><br><span class="line">WORKDIR &#x2F;kafka-manager-$&#123;KM_VERSION&#125;</span><br><span class="line">EXPOSE 9000</span><br><span class="line">ENTRYPOINT [&quot;.&#x2F;bin&#x2F;kafka-manager&quot;,&quot;-Dconfig.file&#x3D;conf&#x2F;application.conf&quot;]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>2 制作docker镜像</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;data&#x2F;dockerfile&#x2F;kafka-manager</span><br><span class="line">docker build . -t harbor.od.com&#x2F;infra&#x2F;kafka-manager:v2.0.0.2</span><br><span class="line">(漫长的过程)</span><br><span class="line">docker push harbor.zq.com&#x2F;infra&#x2F;kafka-manager:latest</span><br></pre></td></tr></table></figure><blockquote><p>构建过程极其漫长,大概率会失败,因此可以通过第二种方式下载构建好的镜像</p><p>但构建好的镜像写死了zk地址,要注意传入变量修改zk地址</p></blockquote><h4 id="4-2-2-直接下载docker镜像"><a href="#4-2-2-直接下载docker镜像" class="headerlink" title="4.2.2 直接下载docker镜像"></a>4.2.2 直接下载docker镜像</h4><p><a href="https://hub.docker.com/r/sheepkiller/kafka-manager/tags" target="_blank" rel="noopener">镜像下载地址</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker pull sheepkiller&#x2F;kafka-manager:latest</span><br><span class="line">docker images|grep kafka-manager</span><br><span class="line">docker tag  4e4a8c5dabab harbor.zq.com&#x2F;infra&#x2F;kafka-manager:latest</span><br><span class="line">docker push harbor.zq.com&#x2F;infra&#x2F;kafka-manager:latest</span><br></pre></td></tr></table></figure><h4 id="4-3-部署kafka-manager"><a href="#4-3-部署kafka-manager" class="headerlink" title="4.3 部署kafka-manager"></a>4.3 部署kafka-manager</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;data&#x2F;k8s-yaml&#x2F;kafka-manager</span><br><span class="line">cd &#x2F;data&#x2F;k8s-yaml&#x2F;kafka-manager</span><br></pre></td></tr></table></figure><h3 id="4-3-1-准备dp清单"><a href="#4-3-1-准备dp清单" class="headerlink" title="4.3.1 准备dp清单"></a>4.3.1 准备dp清单</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;deployment.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: kafka-manager</span><br><span class="line">  namespace: infra</span><br><span class="line">  labels: </span><br><span class="line">    name: kafka-manager</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: kafka-manager</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: kafka-manager</span><br><span class="line">        name: kafka-manager</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kafka-manager</span><br><span class="line">        image: harbor.zq.com&#x2F;infra&#x2F;kafka-manager:latest</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9000</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: ZK_HOSTS</span><br><span class="line">          value: zk1.od.com:2181</span><br><span class="line">        - name: APPLICATION_SECRET</span><br><span class="line">          value: letmein</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-3-2-准备svc资源清单"><a href="#4-3-2-准备svc资源清单" class="headerlink" title="4.3.2 准备svc资源清单"></a>4.3.2 准备svc资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;service.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: kafka-manager</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 9000</span><br><span class="line">    targetPort: 9000</span><br><span class="line">    selector: </span><br><span class="line">    app: kafka-manager</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-3-3-准备ingress资源清单"><a href="#4-3-3-准备ingress资源清单" class="headerlink" title="4.3.3 准备ingress资源清单"></a>4.3.3 准备ingress资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;ingress.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">kind: Ingress</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata: </span><br><span class="line">  name: kafka-manager</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: km.zq.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: &#x2F;</span><br><span class="line">        backend: </span><br><span class="line">          serviceName: kafka-manager</span><br><span class="line">          servicePort: 9000</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-3-4-应用资源配置清单"><a href="#4-3-4-应用资源配置清单" class="headerlink" title="4.3.4 应用资源配置清单"></a>4.3.4 应用资源配置清单</h4><p>任意一台运算节点上：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;kafka-manager&#x2F;deployment.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;kafka-manager&#x2F;service.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;kafka-manager&#x2F;ingress.yaml</span><br></pre></td></tr></table></figure><h4 id="4-3-5-解析域名"><a href="#4-3-5-解析域名" class="headerlink" title="4.3.5 解析域名"></a>4.3.5 解析域名</h4><p><code>HDSS7-11.host.com</code>上</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~]# vim &#x2F;var&#x2F;named&#x2F;zq.com.zone</span><br><span class="line">km    A   10.4.7.10</span><br><span class="line">~]# systemctl restart named</span><br><span class="line">~]# dig -t A km.od.com @10.4.7.11 +short</span><br><span class="line">10.4.7.10</span><br></pre></td></tr></table></figure><h4 id="4-3-6-浏览器访问"><a href="#4-3-6-浏览器访问" class="headerlink" title="4.3.6 浏览器访问"></a>4.3.6 浏览器访问</h4><p><a href="http://km.od.com/" target="_blank" rel="noopener">http://km.zq.com</a></p><p><strong>添加集群</strong></p><p><a href="https://www.wqblogs.com/image/456789875.png" target="_blank" rel="noopener"><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601220132126-1ce93a26-ae4a-4730-a388-0904f685abcd.png" alt="image"></a></p><p><strong>查看集群信息</strong></p><p><a href="https://www.wqblogs.com/image/09876543234.png" target="_blank" rel="noopener"><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601220132926-3082dd5f-00c5-435c-a89b-195d3afc1ea9.png" alt="image"></a></p><h2 id="5-部署filebeat"><a href="#5-部署filebeat" class="headerlink" title="5 部署filebeat"></a>5 部署filebeat</h2><p><a href="https://www.elastic.co/downloads/beats/filebeat" target="_blank" rel="noopener">官方下载地址</a></p><p>运维主机<code>HDSS7-200.host.com</code>上：</p><h3 id="5-1-制作docker镜像"><a href="#5-1-制作docker镜像" class="headerlink" title="5.1 制作docker镜像"></a>5.1 制作docker镜像</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;data&#x2F;dockerfile&#x2F;filebeat</span><br><span class="line">cd &#x2F;data&#x2F;dockerfile&#x2F;filebeat</span><br></pre></td></tr></table></figure><h4 id="5-1-1-准备Dockerfile"><a href="#5-1-1-准备Dockerfile" class="headerlink" title="5.1.1 准备Dockerfile"></a>5.1.1 准备Dockerfile</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;Dockerfile &lt;&lt;&#39;EOF&#39;</span><br><span class="line">FROM debian:jessie</span><br><span class="line"># 如果更换版本,需在官网下载同版本LINUX64-BIT的sha替换FILEBEAT_SHA1</span><br><span class="line">ENV FILEBEAT_VERSION&#x3D;7.5.1 \ FILEBEAT_SHA1&#x3D;daf1a5e905c415daf68a8192a069f913a1d48e2c79e270da118385ba12a93aaa91bda4953c3402a6f0abf1c177f7bcc916a70bcac41977f69a6566565a8fae9c  </span><br><span class="line">RUN set -x &amp;&amp; \</span><br><span class="line"> apt-get update &amp;&amp; \</span><br><span class="line"> apt-get install -y wget &amp;&amp; \</span><br><span class="line"> wget https:&#x2F;&#x2F;artifacts.elastic.co&#x2F;downloads&#x2F;beats&#x2F;filebeat&#x2F;filebeat-$&#123;FILEBEAT_VERSION&#125;-linux-x86_64.tar.gz -O &#x2F;opt&#x2F;filebeat.tar.gz &amp;&amp; \</span><br><span class="line"> cd &#x2F;opt &amp;&amp; \</span><br><span class="line"> echo &quot;$&#123;FILEBEAT_SHA1&#125; filebeat.tar.gz&quot; | sha512sum -c - &amp;&amp; \</span><br><span class="line"> tar xzvf filebeat.tar.gz &amp;&amp; \</span><br><span class="line"> cd filebeat-* &amp;&amp; \</span><br><span class="line"> cp filebeat &#x2F;bin &amp;&amp; \</span><br><span class="line"> cd &#x2F;opt &amp;&amp; \</span><br><span class="line"> rm -rf filebeat* &amp;&amp; \</span><br><span class="line"> apt-get purge -y wget &amp;&amp; \</span><br><span class="line"> apt-get autoremove -y &amp;&amp; \</span><br><span class="line"> apt-get clean &amp;&amp; rm -rf &#x2F;var&#x2F;lib&#x2F;apt&#x2F;lists&#x2F;* &#x2F;tmp&#x2F;* &#x2F;var&#x2F;tmp&#x2F;*</span><br><span class="line">COPY filebeat.yaml &#x2F;etc&#x2F;</span><br><span class="line">COPY docker-entrypoint.sh &#x2F;</span><br><span class="line">ENTRYPOINT [&quot;&#x2F;bin&#x2F;bash&quot;,&quot;&#x2F;docker-entrypoint.sh&quot;]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="5-1-2-准备filebeat配置文件"><a href="#5-1-2-准备filebeat配置文件" class="headerlink" title="5.1.2 准备filebeat配置文件"></a>5.1.2 准备filebeat配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;etc&#x2F;filebeat.yaml &lt;&lt; EOF</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  fields_under_root: true</span><br><span class="line">  fields:</span><br><span class="line">    topic: logm-PROJ_NAME</span><br><span class="line">  paths:</span><br><span class="line">    - &#x2F;logm&#x2F;*.log</span><br><span class="line">    - &#x2F;logm&#x2F;*&#x2F;*.log</span><br><span class="line">    - &#x2F;logm&#x2F;*&#x2F;*&#x2F;*.log</span><br><span class="line">    - &#x2F;logm&#x2F;*&#x2F;*&#x2F;*&#x2F;*.log</span><br><span class="line">    - &#x2F;logm&#x2F;*&#x2F;*&#x2F;*&#x2F;*&#x2F;*.log</span><br><span class="line">  scan_frequency: 120s</span><br><span class="line">  max_bytes: 10485760</span><br><span class="line">  multiline.pattern: &#39;MULTILINE&#39;</span><br><span class="line">  multiline.negate: true</span><br><span class="line">  multiline.match: after</span><br><span class="line">  multiline.max_lines: 100</span><br><span class="line">- type: log</span><br><span class="line">  fields_under_root: true</span><br><span class="line">  fields:</span><br><span class="line">    topic: logu-PROJ_NAME</span><br><span class="line">  paths:</span><br><span class="line">    - &#x2F;logu&#x2F;*.log</span><br><span class="line">    - &#x2F;logu&#x2F;*&#x2F;*.log</span><br><span class="line">    - &#x2F;logu&#x2F;*&#x2F;*&#x2F;*.log</span><br><span class="line">    - &#x2F;logu&#x2F;*&#x2F;*&#x2F;*&#x2F;*.log</span><br><span class="line">    - &#x2F;logu&#x2F;*&#x2F;*&#x2F;*&#x2F;*&#x2F;*.log</span><br><span class="line">    - &#x2F;logu&#x2F;*&#x2F;*&#x2F;*&#x2F;*&#x2F;*&#x2F;*.log</span><br><span class="line">output.kafka:</span><br><span class="line">  hosts: [&quot;10.4.7.11:9092&quot;]</span><br><span class="line">  topic: k8s-fb-ENV-%&#123;[topic]&#125;</span><br><span class="line">  version: 2.0.0      # kafka版本超过2.0，默认写2.0.0 </span><br><span class="line">  required_acks: 0</span><br><span class="line">  max_message_bytes: 10485760</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="5-1-3-准备启动脚本"><a href="#5-1-3-准备启动脚本" class="headerlink" title="5.1.3 准备启动脚本"></a>5.1.3 准备启动脚本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;docker-entrypoint.sh &lt;&lt;&#39;EOF&#39;</span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">ENV&#x3D;$&#123;ENV:-&quot;test&quot;&#125;                    # 定义日志收集的环境</span><br><span class="line">PROJ_NAME&#x3D;$&#123;PROJ_NAME:-&quot;no-define”&#125;   # 定义项目名称</span><br><span class="line">MULTILINE&#x3D;$&#123;MULTILINE:-&quot;^\d&#123;2&#125;&quot;&#125;      # 多行匹配，以2个数据开头的为一行，反之</span><br><span class="line"># 替换配置文件中的内容</span><br><span class="line">sed -i &#39;s#PROJ_NAME#$&#123;PROJ_NAME&#125;#g&#39; &#x2F;etc&#x2F;filebeat.yaml</span><br><span class="line">sed -i &#39;s#MULTILINE#$&#123;MULTILINE&#125;#g&#39; &#x2F;etc&#x2F;filebeat.yaml</span><br><span class="line">sed -i &#39;s#ENV#$&#123;ENV&#125;#g&#39;             &#x2F;etc&#x2F;filebeat.yaml</span><br><span class="line">if [[ &quot;$1&quot; &#x3D;&#x3D; &quot;&quot; ]]; then</span><br><span class="line">     exec filebeat  -c &#x2F;etc&#x2F;filebeat.yaml </span><br><span class="line">else</span><br><span class="line">    exec &quot;$@&quot;</span><br><span class="line">fi</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="5-1-4-构建镜像"><a href="#5-1-4-构建镜像" class="headerlink" title="5.1.4 构建镜像"></a>5.1.4 构建镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build . -t harbor.od.com&#x2F;infra&#x2F;filebeat:v7.5.1</span><br><span class="line">docker push       harbor.od.com&#x2F;infra&#x2F;filebeat:v7.5.1</span><br></pre></td></tr></table></figure><h3 id="5-2-以边车模式运行POD"><a href="#5-2-以边车模式运行POD" class="headerlink" title="5.2 以边车模式运行POD"></a>5.2 以边车模式运行POD</h3><h4 id="5-2-1-准备资源配置清单"><a href="#5-2-1-准备资源配置清单" class="headerlink" title="5.2.1 准备资源配置清单"></a>5.2.1 准备资源配置清单</h4><p>使用dubbo-demo-consumer的镜像,以边车模式运行filebeat</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">]# vim &#x2F;data&#x2F;k8s-yaml&#x2F;test&#x2F;dubbo-demo-consumer&#x2F;deployment.yaml </span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-demo-consumer</span><br><span class="line">  namespace: test</span><br><span class="line">  labels: </span><br><span class="line">    name: dubbo-demo-consumer</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: dubbo-demo-consumer</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: dubbo-demo-consumer</span><br><span class="line">        name: dubbo-demo-consumer</span><br><span class="line">      annotations:</span><br><span class="line">        blackbox_path: &quot;&#x2F;hello?name&#x3D;health&quot;</span><br><span class="line">        blackbox_port: &quot;8080&quot;</span><br><span class="line">        blackbox_scheme: &quot;http&quot;</span><br><span class="line">        prometheus_io_scrape: &quot;true&quot;</span><br><span class="line">        prometheus_io_port: &quot;12346&quot;</span><br><span class="line">        prometheus_io_path: &quot;&#x2F;&quot;</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: dubbo-demo-consumer</span><br><span class="line">        image: harbor.zq.com&#x2F;app&#x2F;dubbo-tomcat-web:apollo_200513_1808</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 20880</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: JAR_BALL</span><br><span class="line">          value: dubbo-client.jar</span><br><span class="line">        - name: C_OPTS</span><br><span class="line">          value: -Denv&#x3D;fat -Dapollo.meta&#x3D;http:&#x2F;&#x2F;config-test.zq.com</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">#--------新增内容--------</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: &#x2F;opt&#x2F;tomcat&#x2F;logs</span><br><span class="line">          name: logm</span><br><span class="line">      - name: filebeat</span><br><span class="line">        image: harbor.zq.com&#x2F;infra&#x2F;filebeat:v7.5.1</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        env:</span><br><span class="line">        - name: ENV</span><br><span class="line">          value: test             # 测试环境</span><br><span class="line">        - name: PROJ_NAME</span><br><span class="line">          value: dubbo-demo-web   # 项目名</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: &#x2F;logm        </span><br><span class="line">          name: logm</span><br><span class="line">      volumes:</span><br><span class="line">      - emptyDir: &#123;&#125; #随机在宿主机找目录创建,容器删除时一起删除</span><br><span class="line">        name: logm</span><br><span class="line">#--------新增结束--------</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure><h4 id="5-2-2-应用资源清单"><a href="#5-2-2-应用资源清单" class="headerlink" title="5.2.2 应用资源清单"></a>5.2.2 应用资源清单</h4><p>任意node节点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;test&#x2F;dubbo-demo-consumer&#x2F;deployment.yaml</span><br></pre></td></tr></table></figure><h3 id="5-2-3-验证"><a href="#5-2-3-验证" class="headerlink" title="5.2.3 验证"></a>5.2.3 验证</h3><p>浏览器访问<a href="http://km.zq.com,看到kafaka-manager里，topic打进来，即为成功" target="_blank" rel="noopener">http://km.zq.com,看到kafaka-manager里，topic打进来，即为成功</a></p><p><a href="https://www.wqblogs.com/image/1765432234.png" target="_blank" rel="noopener"><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601220132136-c59d9841-3852-480e-89c9-2fd65545ca96.png?x-oss-process=image%2Fresize%2Cw_1500" alt="image"></a></p><p>进入dubbo-demo-consumer的容器中,查看logm目录下是否有日志</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test exec -it dobbo...... -c filebeat &#x2F;bin&#x2F;bash</span><br><span class="line">ls &#x2F;logm</span><br><span class="line"># -c参数指定pod中的filebeat容器</span><br><span class="line"># &#x2F;logm是filebeat容器挂载的目录</span><br></pre></td></tr></table></figure><h2 id="6-部署logstash"><a href="#6-部署logstash" class="headerlink" title="6 部署logstash"></a>6 部署logstash</h2><p>运维主机<code>HDSS7-200.host.com</code>上：</p><h3 id="6-1-准备docker镜像"><a href="#6-1-准备docker镜像" class="headerlink" title="6.1 准备docker镜像"></a>6.1 准备docker镜像</h3><h4 id="6-1-1-下载官方镜像"><a href="#6-1-1-下载官方镜像" class="headerlink" title="6.1.1 下载官方镜像"></a>6.1.1 下载官方镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull logstash:6.8.6</span><br><span class="line">docker tag  d0a2dac51fcb harbor.od.com&#x2F;infra&#x2F;logstash:v6.8.6</span><br><span class="line">docker push harbor.zq.com&#x2F;infra&#x2F;logstash:v6.8.6</span><br></pre></td></tr></table></figure><h4 id="6-1-2-准备配置文件"><a href="#6-1-2-准备配置文件" class="headerlink" title="6.1.2 准备配置文件"></a>6.1.2 准备配置文件</h4><p>准备目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;etc&#x2F;logstash&#x2F;</span><br></pre></td></tr></table></figure><p>创建test.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;etc&#x2F;logstash&#x2F;logstash-test.conf &lt;&lt;&#39;EOF&#39;</span><br><span class="line">input &#123;</span><br><span class="line">  kafka &#123;</span><br><span class="line">    bootstrap_servers &#x3D;&gt; &quot;10.4.7.11:9092&quot;</span><br><span class="line">    client_id &#x3D;&gt; &quot;10.4.7.200&quot;</span><br><span class="line">    consumer_threads &#x3D;&gt; 4</span><br><span class="line">    group_id &#x3D;&gt; &quot;k8s_test&quot;               # 为test组</span><br><span class="line">    topics_pattern &#x3D;&gt; &quot;k8s-fb-test-.*&quot;   # 只收集k8s-fb-test开头的topics</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">  json &#123;</span><br><span class="line">    source &#x3D;&gt; &quot;message&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts &#x3D;&gt; [&quot;10.4.7.12:9200&quot;]</span><br><span class="line">    index &#x3D;&gt; &quot;k8s-test-%&#123;+YYYY.MM.DD&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>创建prod.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;etc&#x2F;logstash&#x2F;logstash-prod.conf &lt;&lt;&#39;EOF&#39;</span><br><span class="line">input &#123;</span><br><span class="line">  kafka &#123;</span><br><span class="line">    bootstrap_servers &#x3D;&gt; &quot;10.4.7.11:9092&quot;</span><br><span class="line">    client_id &#x3D;&gt; &quot;10.4.7.200&quot;</span><br><span class="line">    consumer_threads &#x3D;&gt; 4</span><br><span class="line">    group_id &#x3D;&gt; &quot;k8s_prod&quot;                   </span><br><span class="line">    topics_pattern &#x3D;&gt; &quot;k8s-fb-prod-.*&quot; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">  json &#123;</span><br><span class="line">    source &#x3D;&gt; &quot;message&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts &#x3D;&gt; [&quot;10.4.7.12:9200&quot;]</span><br><span class="line">    index &#x3D;&gt; “k8s-prod-%&#123;+YYYY.MM.DD&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="6-2-启动logstash"><a href="#6-2-启动logstash" class="headerlink" title="6.2 启动logstash"></a>6.2 启动logstash</h3><h4 id="6-2-1-启动测试环境的logstash"><a href="#6-2-1-启动测试环境的logstash" class="headerlink" title="6.2.1 启动测试环境的logstash"></a>6.2.1 启动测试环境的logstash</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">    --restart&#x3D;always \</span><br><span class="line">    --name logstash-test \</span><br><span class="line">    -v &#x2F;etc&#x2F;logstash:&#x2F;etc&#x2F;logstash  \</span><br><span class="line">    -f &#x2F;etc&#x2F;logstash&#x2F;logstash-test.conf  \</span><br><span class="line">    harbor.od.com&#x2F;infra&#x2F;logstash:v6.8.6 </span><br><span class="line">~]# docker ps -a|grep logstash</span><br></pre></td></tr></table></figure><h4 id="6-2-2-查看es是否接收数据"><a href="#6-2-2-查看es是否接收数据" class="headerlink" title="6.2.2 查看es是否接收数据"></a>6.2.2 查看es是否接收数据</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~]# curl http:&#x2F;&#x2F;10.4.7.12:9200&#x2F;_cat&#x2F;indices?v</span><br><span class="line">health status index        uuid          pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line">green open  k8s-test-2020.01.07 mFEQUyKVTTal8c97VsmZHw  5  0     12      0   78.4kb     78.4kb</span><br></pre></td></tr></table></figure><h4 id="6-2-3-启动正式环境的logstash"><a href="#6-2-3-启动正式环境的logstash" class="headerlink" title="6.2.3 启动正式环境的logstash"></a>6.2.3 启动正式环境的logstash</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">    --restart&#x3D;always \</span><br><span class="line">    --name logstash-prod \</span><br><span class="line">    -v &#x2F;etc&#x2F;logstash:&#x2F;etc&#x2F;logstash  \</span><br><span class="line">    -f &#x2F;etc&#x2F;logstash&#x2F;logstash-prod.conf  \</span><br><span class="line">    harbor.od.com&#x2F;infra&#x2F;logstash:v6.8.6</span><br></pre></td></tr></table></figure><h2 id="7-部署Kibana"><a href="#7-部署Kibana" class="headerlink" title="7 部署Kibana"></a>7 部署Kibana</h2><p>运维主机<code>HDSS7-200.host.com</code>上：</p><h3 id="7-1-准备相关资源"><a href="#7-1-准备相关资源" class="headerlink" title="7.1 准备相关资源"></a>7.1 准备相关资源</h3><h4 id="7-1-1-准备docker镜像"><a href="#7-1-1-准备docker镜像" class="headerlink" title="7.1.1 准备docker镜像"></a>7.1.1 准备docker镜像</h4><p><a href="https://hub.docker.com/_/kibana?tab=tags" target="_blank" rel="noopener">kibana官方镜像下载地址</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull kibana:6.8.6</span><br><span class="line">docker tag  adfab5632ef4 harbor.od.com&#x2F;infra&#x2F;kibana:v6.8.6</span><br><span class="line">docker push harbor.zq.com&#x2F;infra&#x2F;kibana:v6.8.6</span><br></pre></td></tr></table></figure><p>准备目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;data&#x2F;k8s-yaml&#x2F;kibana</span><br><span class="line">cd &#x2F;data&#x2F;k8s-yaml&#x2F;kibana</span><br></pre></td></tr></table></figure><h4 id="7-1-3-准备dp资源清单"><a href="#7-1-3-准备dp资源清单" class="headerlink" title="7.1.3 准备dp资源清单"></a>7.1.3 准备dp资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;deployment.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: kibana</span><br><span class="line">  namespace: infra</span><br><span class="line">  labels: </span><br><span class="line">    name: kibana</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: kibana</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: kibana</span><br><span class="line">        name: kibana</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kibana</span><br><span class="line">        image: harbor.zq.com&#x2F;infra&#x2F;kibana:v6.8.6</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 5601</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: ELASTICSEARCH_URL</span><br><span class="line">          value: http:&#x2F;&#x2F;10.4.7.12:9200</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="7-1-4-准备svc资源清单"><a href="#7-1-4-准备svc资源清单" class="headerlink" title="7.1.4 准备svc资源清单"></a>7.1.4 准备svc资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;service.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: kibana</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 5601</span><br><span class="line">    targetPort: 5601</span><br><span class="line">    selector: </span><br><span class="line">    app: kibana</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="7-1-5-准备ingress资源清单"><a href="#7-1-5-准备ingress资源清单" class="headerlink" title="7.1.5 准备ingress资源清单"></a>7.1.5 准备ingress资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;ingress.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">kind: Ingress</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata: </span><br><span class="line">  name: kibana</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: kibana.zq.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: &#x2F;</span><br><span class="line">        backend: </span><br><span class="line">          serviceName: kibana</span><br><span class="line">          servicePort: 5601</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="7-2-应用资源"><a href="#7-2-应用资源" class="headerlink" title="7.2 应用资源"></a>7.2 应用资源</h3><h4 id="7-2-1-应用资源配置清单"><a href="#7-2-1-应用资源配置清单" class="headerlink" title="7.2.1 应用资源配置清单"></a>7.2.1 应用资源配置清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;kibana&#x2F;deployment.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;kibana&#x2F;service.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;kibana&#x2F;ingress.yaml</span><br></pre></td></tr></table></figure><h4 id="7-2-2-解析域名"><a href="#7-2-2-解析域名" class="headerlink" title="7.2.2 解析域名"></a>7.2.2 解析域名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~]# vim &#x2F;var&#x2F;named&#x2F;od.com.zone</span><br><span class="line">kibana         A  10.4.7.10</span><br><span class="line">~]# systemctl restart named</span><br><span class="line">~]# dig -t A kibana.od.com @10.4.7.11 +short</span><br><span class="line">10.4.7.10</span><br></pre></td></tr></table></figure><h4 id="7-2-3-浏览器访问"><a href="#7-2-3-浏览器访问" class="headerlink" title="7.2.3 浏览器访问"></a>7.2.3 浏览器访问</h4><p>访问<a href="http://kibana.zq.com" target="_blank" rel="noopener">http://kibana.zq.com</a></p><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601220134708-c82a19f5-82bd-4be0-a8cf-193be188a250.png?x-oss-process=image%2Fresize%2Cw_1500" alt="image"></p><h3 id="7-3-kibana的使用"><a href="#7-3-kibana的使用" class="headerlink" title="7.3 kibana的使用"></a>7.3 kibana的使用</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601220133815-6134311a-d55b-4d51-a5ab-da45338cdddb.png?x-oss-process=image%2Fresize%2Cw_1500" alt="image"></p><ol><li>选择区域</li></ol><table><thead><tr><th>项目</th><th>用途</th></tr></thead><tbody><tr><td>@timestamp</td><td>对应日志的时间戳</td></tr><tr><td>og.file.path</td><td>对应日志文件名</td></tr><tr><td>message</td><td>对应日志内容</td></tr></tbody></table><ol><li>时间选择器<br>选择日志时间</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">快速时间</span><br><span class="line">绝对时间</span><br><span class="line">相对时间</span><br></pre></td></tr></table></figure><ol><li>环境选择器<br>选择对应环境的日志</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">k8s-test-*</span><br><span class="line">k8s-prod-*</span><br></pre></td></tr></table></figure><ol><li>项目选择器</li></ol><ul><li><ul><li>对应filebeat的PROJ_NAME值</li><li>Add a fillter</li><li>topic is ${PROJ_NAME}<br>dubbo-demo-service<br>dubbo-demo-web</li></ul></li></ul><ol><li>关键字选择器<br>exception<br>error</li></ol><p>转载自：<a href="https://www.cnblogs.com/noah-luo/p/13501895.html" target="_blank" rel="noopener">https://www.cnblogs.com/noah-luo/p/13501895.html</a></p><pre><code></code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;K8S监控实战-ELK收集K8S内应用日志&quot;&gt;&lt;a href=&quot;#K8S监控实战-ELK收集K8S内应用日志&quot; class=&quot;headerlink&quot; title=&quot;K8S监控实战-ELK收集K8S内应用日志&quot;&gt;&lt;/a&gt;K8S监控实战-ELK收集K8S内应用日志&lt;/
      
    
    </summary>
    
    
      <category term="k8s" scheme="http://yoursite.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="http://yoursite.com/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>K8s集成实战-使用spinnaker进行自动化部署</title>
    <link href="http://yoursite.com/2020/12/26/k8s/18/"/>
    <id>http://yoursite.com/2020/12/26/k8s/18/</id>
    <published>2020-12-26T07:58:46.765Z</published>
    <updated>2020-12-26T07:58:46.759Z</updated>
    
    <content type="html"><![CDATA[<h1 id="K8s集成实战-使用spinnaker进行自动化部署"><a href="#K8s集成实战-使用spinnaker进行自动化部署" class="headerlink" title="K8s集成实战-使用spinnaker进行自动化部署"></a>K8s集成实战-使用spinnaker进行自动化部署</h1><h2 id="1-spinnaker概述和选型"><a href="#1-spinnaker概述和选型" class="headerlink" title="1 spinnaker概述和选型"></a>1 spinnaker概述和选型</h2><h3 id="1-1-概述"><a href="#1-1-概述" class="headerlink" title="1.1 概述"></a>1.1 概述</h3><h4 id="1-1-1-主要功能"><a href="#1-1-1-主要功能" class="headerlink" title="1.1.1 主要功能"></a>1.1.1 主要功能</h4><p>Spinnaker是一个开源的多云持续交付平台，提供快速、可靠、稳定的软件变更服务。主要包含两类功能：集群管理和部署管理</p><h4 id="1-1-2-集群管理"><a href="#1-1-2-集群管理" class="headerlink" title="1.1.2 集群管理"></a>1.1.2 集群管理</h4><p>集群管理主要用于管理云资源，Spinnaker所说的”云“可以理解成AWS，即主要是laaS的资源，比如OpenStak，Google云，微软云等，后来还支持了容器与Kubernetes，但是管理方式还是按照管理基础设施的模式来设计的。</p><h4 id="1-1-3-部署管理"><a href="#1-1-3-部署管理" class="headerlink" title="1.1.3 部署管理"></a>1.1.3 部署管理</h4><p>管理部署流程是Spinnaker的核心功能，使用minio作为持久化层，同时对接jenkins流水线创建的镜像，部署到Kubernetes集群中去，让服务真正运行起来。</p><h4 id="1-1-4-逻辑架构图"><a href="#1-1-4-逻辑架构图" class="headerlink" title="1.1.4 逻辑架构图"></a>1.1.4 逻辑架构图</h4><p>Spinnaker自己就是Spinnake一个微服务,由若干组件组成，整套逻辑架构图如下：</p><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601220290086-ee59f59d-ef36-4334-8f8f-5e8bfa743db2.png" alt="image"></p><ul><li>Deck是基于浏览器的UI。</li><li>Gate是API网关。<br>Spinnaker UI和所有api调用程序都通过Gate与Spinnaker进行通信。</li><li>Clouddriver负责管理云平台，并为所有部署的资源编制索引/缓存。</li><li>Front50用于管理数据持久化，用于保存应用程序，管道，项目和通知的元数据。</li><li>Igor用于通过Jenkins和Travis CI等系统中的持续集成作业来触发管道，并且它允许在管道中使用Jenkins / Travis阶段。</li><li>Orca是编排引擎。它处理所有临时操作和流水线。</li><li>Rosco是管理调度虚拟机。</li><li>Kayenta为Spinnaker提供自动化的金丝雀分析。</li><li>Fiat 是Spinnaker的认证服务。</li><li>Echo是信息通信服务。<br>它支持发送通知（例如，Slack，电子邮件，SMS），并处理来自Github之类的服务中传入的Webhook。</li></ul><h3 id="1-2-部署选型"><a href="#1-2-部署选型" class="headerlink" title="1.2 部署选型"></a>1.2 部署选型</h3><p><a href="https://www.spinnaker.io/" target="_blank" rel="noopener">Spinnaker官网</a></p><p>Spinnaker包含组件众多,部署相对复杂,因此官方提供的脚手架工具halyard,但是可惜里面涉及的部分镜像地址被墙</p><p><a href="https://www.armory.io/" target="_blank" rel="noopener">Armory发行版</a></p><p>基于Spinnaker,众多公司开发了开发第三方发行版来简化Spinnaker的部署工作,例如我们要用的Armory发行版</p><p>Armory也有自己的脚手架工具,虽然相对halyard更简化了,但仍然部分被墙</p><p>因此我们部署的方式是手动交付Spinnaker的Armory发行版</p><h2 id="2-部署spinnaker第一部分"><a href="#2-部署spinnaker第一部分" class="headerlink" title="2 部署spinnaker第一部分"></a>2 部署spinnaker第一部分</h2><h3 id="2-1-spinnaker之minio部署"><a href="#2-1-spinnaker之minio部署" class="headerlink" title="2.1 spinnaker之minio部署"></a>2.1 spinnaker之minio部署</h3><h4 id="2-1-1-准备minio镜像"><a href="#2-1-1-准备minio镜像" class="headerlink" title="2.1.1 准备minio镜像"></a>2.1.1 准备minio镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull minio&#x2F;minio:latest</span><br><span class="line">docker tag  533fee13ab07 harbor.zq.com&#x2F;armory&#x2F;minio:latest</span><br><span class="line">docker push harbor.od.com&#x2F;armory&#x2F;minio:latest</span><br></pre></td></tr></table></figure><p>准备目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;data&#x2F;nfs-volume&#x2F;minio</span><br><span class="line">mkdir -p &#x2F;data&#x2F;k8s-yaml&#x2F;armory&#x2F;minio</span><br><span class="line">cd &#x2F;data&#x2F;k8s-yaml&#x2F;armory&#x2F;minio</span><br></pre></td></tr></table></figure><h4 id="2-1-2-准备dp资源清单"><a href="#2-1-2-准备dp资源清单" class="headerlink" title="2.1.2 准备dp资源清单"></a>2.1.2 准备dp资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;dp.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    name: minio</span><br><span class="line">  name: minio</span><br><span class="line">  namespace: armory</span><br><span class="line">spec:</span><br><span class="line">  progressDeadlineSeconds: 600</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: minio</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: minio</span><br><span class="line">        name: minio</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: minio</span><br><span class="line">        image: harbor.zq.com&#x2F;armory&#x2F;minio:latest</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9000</span><br><span class="line">          protocol: TCP</span><br><span class="line">        args:</span><br><span class="line">        - server</span><br><span class="line">        - &#x2F;data</span><br><span class="line">        env:</span><br><span class="line">        - name: MINIO_ACCESS_KEY</span><br><span class="line">          value: admin</span><br><span class="line">        - name: MINIO_SECRET_KEY</span><br><span class="line">          value: admin123</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;minio&#x2F;health&#x2F;ready</span><br><span class="line">            port: 9000</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 10</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: &#x2F;data</span><br><span class="line">          name: data</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      volumes:</span><br><span class="line">      - nfs:</span><br><span class="line">          server: ops-200.host.com</span><br><span class="line">          path: &#x2F;data&#x2F;nfs-volume&#x2F;minio</span><br><span class="line">        name: data </span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="2-1-3-准备svc资源清单"><a href="#2-1-3-准备svc资源清单" class="headerlink" title="2.1.3 准备svc资源清单"></a>2.1.3 准备svc资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;svc.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: minio</span><br><span class="line">  namespace: armory</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 9000</span><br><span class="line">  selector:</span><br><span class="line">    app: minio</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="2-1-4-准备ingress资源清单"><a href="#2-1-4-准备ingress资源清单" class="headerlink" title="2.1.4 准备ingress资源清单"></a>2.1.4 准备ingress资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;ingress.yaml &lt;&lt;&#39;EOF&#39; </span><br><span class="line">kind: Ingress</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: minio</span><br><span class="line">  namespace: armory</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: minio.zq.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: &#x2F;</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: minio</span><br><span class="line">          servicePort: 80</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="2-1-5-应用资源配置清单"><a href="#2-1-5-应用资源配置清单" class="headerlink" title="2.1.5 应用资源配置清单"></a>2.1.5 应用资源配置清单</h4><p><strong>任意node节点</strong></p><p>创建namespace和secret</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace armory</span><br><span class="line">kubectl create secret docker-registry harbor \</span><br><span class="line">    --docker-server&#x3D;harbor.zq.com \</span><br><span class="line">    --docker-username&#x3D;admin \</span><br><span class="line">    --docker-password&#x3D;Harbor12345 \</span><br><span class="line">    -n armory</span><br></pre></td></tr></table></figure><p>应用清单</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;minio&#x2F;dp.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;minio&#x2F;svc.yaml </span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;minio&#x2F;ingress.yaml</span><br></pre></td></tr></table></figure><h4 id="2-1-6-访问验证"><a href="#2-1-6-访问验证" class="headerlink" title="2.1.6 访问验证"></a>2.1.6 访问验证</h4><p>访问<a href="http://minio.zq.com,用户名密码为:admin/admin123">http://minio.zq.com,用户名密码为:admin/admin123</a></p><p>如果访问并登陆成功,表示minio部署成功</p><h3 id="2-2-spinnaker之redis部署"><a href="#2-2-spinnaker之redis部署" class="headerlink" title="2.2 spinnaker之redis部署"></a>2.2 spinnaker之redis部署</h3><h4 id="2-2-1-准备镜像好目录"><a href="#2-2-1-准备镜像好目录" class="headerlink" title="2.2.1 准备镜像好目录"></a>2.2.1 准备镜像好目录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull redis:4.0.14</span><br><span class="line">docker tag  6e221e67453d harbor.zq.com&#x2F;armory&#x2F;redis:v4.0.14</span><br><span class="line">docker push harbor.od.com&#x2F;armory&#x2F;redis:v4.0.14</span><br></pre></td></tr></table></figure><p>准备目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;data&#x2F;k8s-yaml&#x2F;armory&#x2F;redis</span><br><span class="line">cd &#x2F;data&#x2F;k8s-yaml&#x2F;armory&#x2F;redis</span><br></pre></td></tr></table></figure><h4 id="2-2-2-准备dp资源清单"><a href="#2-2-2-准备dp资源清单" class="headerlink" title="2.2.2 准备dp资源清单"></a>2.2.2 准备dp资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;dp.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: apps:v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    name: redis</span><br><span class="line">  name: redis</span><br><span class="line">  namespace: armory</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: redis</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: redis</span><br><span class="line">        name: redis</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: redis</span><br><span class="line">        image: harbor.zq.com&#x2F;armory&#x2F;redis:v4.0.14</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 6379</span><br><span class="line">          protocol: TCP</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="2-2-3-准备svc资源清单"><a href="#2-2-3-准备svc资源清单" class="headerlink" title="2.2.3 准备svc资源清单"></a>2.2.3 准备svc资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;svc.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: redis</span><br><span class="line">  namespace: armory</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 6379</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 6379</span><br><span class="line">  selector:</span><br><span class="line">    app: redis</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="2-3-4-应用资源配置清单"><a href="#2-3-4-应用资源配置清单" class="headerlink" title="2.3.4 应用资源配置清单"></a>2.3.4 应用资源配置清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;redis&#x2F;dp.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;redis&#x2F;svc.yaml</span><br></pre></td></tr></table></figure><h2 id="3-部署spinnaker之CloudDriver"><a href="#3-部署spinnaker之CloudDriver" class="headerlink" title="3 部署spinnaker之CloudDriver"></a>3 部署spinnaker之CloudDriver</h2><p>CloudDriver是整套spinnaker部署中最难的部分,因此单独写一章来说明</p><h3 id="3-1-部署准备工作"><a href="#3-1-部署准备工作" class="headerlink" title="3.1 部署准备工作"></a>3.1 部署准备工作</h3><h4 id="3-1-1-准备镜像和目录"><a href="#3-1-1-准备镜像和目录" class="headerlink" title="3.1.1 准备镜像和目录"></a>3.1.1 准备镜像和目录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull armory&#x2F;spinnaker-clouddriver-slim:release-1.11.x-bee52673a</span><br><span class="line">docker tag f1d52d01e28d harbor.od.com&#x2F;armory&#x2F;clouddriver:v1.11.x</span><br><span class="line">docker push harbor.od.com&#x2F;armory&#x2F;clouddriver:v1.11.x</span><br></pre></td></tr></table></figure><p>准备目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;data&#x2F;k8s-yaml&#x2F;armory&#x2F;clouddriver</span><br><span class="line">cd &#x2F;data&#x2F;k8s-yaml&#x2F;armory&#x2F;clouddriver</span><br></pre></td></tr></table></figure><h4 id="3-1-2-准备minio的secret"><a href="#3-1-2-准备minio的secret" class="headerlink" title="3.1.2 准备minio的secret"></a>3.1.2 准备minio的secret</h4><p>准备配置文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;credentials &lt;&lt;&#39;EOF&#39;</span><br><span class="line">[default]</span><br><span class="line">aws_access_key_id&#x3D;admin</span><br><span class="line">aws_secret_access_key&#x3D;admin123</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>NODE节点创建secret</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">wget http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;armory&#x2F;clouddriver&#x2F;credentials</span><br><span class="line">kubectl create secret generic credentials \</span><br><span class="line">    --from-file&#x3D;.&#x2F;credentials \</span><br><span class="line">    -n armory</span><br><span class="line"># 也可以不急于配置文件,直接命令行创建</span><br><span class="line">kubectl create secret generic credentials \</span><br><span class="line">    --aws_access_key_id&#x3D;admin \</span><br><span class="line">    --aws_secret_access_key&#x3D;admin123 \</span><br><span class="line">    -n armory</span><br></pre></td></tr></table></figure><h4 id="3-1-3-签发证书与私钥"><a href="#3-1-3-签发证书与私钥" class="headerlink" title="3.1.3 签发证书与私钥"></a>3.1.3 签发证书与私钥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;certs</span><br><span class="line">cp client-csr.json admin-csr.json</span><br><span class="line">sed -i &#39;s##cluster-admin#g&#39; admin-csr.json</span><br><span class="line">cfssl gencert \</span><br><span class="line">    -ca&#x3D;ca.pem \</span><br><span class="line">    -ca-key&#x3D;ca-key.pem \</span><br><span class="line">    -config&#x3D;ca-config.json \</span><br><span class="line">    -profile&#x3D;client \</span><br><span class="line">    admin-csr.json |cfssl-json -bare admin</span><br><span class="line">ls admin*</span><br></pre></td></tr></table></figure><h4 id="3-1-3-分发证书"><a href="#3-1-3-分发证书" class="headerlink" title="3.1.3 分发证书"></a>3.1.3 分发证书</h4><p>在任意node节点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;certs</span><br><span class="line">scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;ca.pem .</span><br><span class="line">scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;admin.pem .</span><br><span class="line">scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;admin-key.pem .</span><br></pre></td></tr></table></figure><h4 id="3-1-4-创建用户"><a href="#3-1-4-创建用户" class="headerlink" title="3.1.4 创建用户"></a>3.1.4 创建用户</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 4步法创建用户</span><br><span class="line">kubectl config set-cluster myk8s \</span><br><span class="line">    --certificate-authority&#x3D;.&#x2F;ca.pem \</span><br><span class="line">    --embed-certs&#x3D;true --server&#x3D;https:&#x2F;&#x2F;192.168.1.10:7443 \</span><br><span class="line">    --kubeconfig&#x3D;config</span><br><span class="line">kubectl config set-credentials cluster-admin \</span><br><span class="line">    --client-certificate&#x3D;.&#x2F;admin.pem \</span><br><span class="line">    --client-key&#x3D;.&#x2F;admin-key.pem \</span><br><span class="line">    --embed-certs&#x3D;true --kubeconfig&#x3D;config</span><br><span class="line">kubectl config set-context myk8s-context \</span><br><span class="line">    --cluster&#x3D;myk8s \</span><br><span class="line">    --user&#x3D;cluster-admin \</span><br><span class="line">    --kubeconfig&#x3D;config</span><br><span class="line">kubectl config use-context myk8s-context \</span><br><span class="line">    --kubeconfig&#x3D;config</span><br><span class="line">    </span><br><span class="line"># 集群角色绑定</span><br><span class="line">kubectl create clusterrolebinding myk8s-admin \</span><br><span class="line">    --clusterrole&#x3D;cluster-admin \</span><br><span class="line">    --user&#x3D;cluster-admin</span><br></pre></td></tr></table></figure><h4 id="3-1-5-使用config创建cm资源"><a href="#3-1-5-使用config创建cm资源" class="headerlink" title="3.1.5 使用config创建cm资源"></a>3.1.5 使用config创建cm资源</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp config default-kubeconfig</span><br><span class="line">kubectl create cm default-kubeconfig --from-file&#x3D;default-kubeconfig -n armory</span><br></pre></td></tr></table></figure><h3 id="3-2-创建并应用资源清单"><a href="#3-2-创建并应用资源清单" class="headerlink" title="3.2 创建并应用资源清单"></a>3.2 创建并应用资源清单</h3><p>回到7.200管理机</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;data&#x2F;k8s-yaml&#x2F;armory&#x2F;clouddriver</span><br></pre></td></tr></table></figure><h4 id="3-2-1-创建环境变量配置"><a href="#3-2-1-创建环境变量配置" class="headerlink" title="3.2.1 创建环境变量配置"></a>3.2.1 创建环境变量配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;vim init-env.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: init-env</span><br><span class="line">  namespace: armory</span><br><span class="line">data:</span><br><span class="line">  API_HOST: http:&#x2F;&#x2F;spinnaker.zq.com&#x2F;api</span><br><span class="line">  ARMORY_ID: c02f0781-92f5-4e80-86db-0ba8fe7b8544</span><br><span class="line">  ARMORYSPINNAKER_CONF_STORE_BUCKET: armory-platform</span><br><span class="line">  ARMORYSPINNAKER_CONF_STORE_PREFIX: front50</span><br><span class="line">  ARMORYSPINNAKER_GCS_ENABLED: &quot;false&quot;</span><br><span class="line">  ARMORYSPINNAKER_S3_ENABLED: &quot;true&quot;</span><br><span class="line">  AUTH_ENABLED: &quot;false&quot;</span><br><span class="line">  AWS_REGION: us-east-1</span><br><span class="line">  BASE_IP: 127.0.0.1</span><br><span class="line">  CLOUDDRIVER_OPTS: -Dspring.profiles.active&#x3D;armory,configurator,local</span><br><span class="line">  CONFIGURATOR_ENABLED: &quot;false&quot;</span><br><span class="line">  DECK_HOST: http:&#x2F;&#x2F;spinnaker.zq.com</span><br><span class="line">  ECHO_OPTS: -Dspring.profiles.active&#x3D;armory,configurator,local</span><br><span class="line">  GATE_OPTS: -Dspring.profiles.active&#x3D;armory,configurator,local</span><br><span class="line">  IGOR_OPTS: -Dspring.profiles.active&#x3D;armory,configurator,local</span><br><span class="line">  PLATFORM_ARCHITECTURE: k8s</span><br><span class="line">  REDIS_HOST: redis:&#x2F;&#x2F;redis:6379</span><br><span class="line">  SERVER_ADDRESS: 0.0.0.0</span><br><span class="line">  SPINNAKER_AWS_DEFAULT_REGION: us-east-1</span><br><span class="line">  SPINNAKER_AWS_ENABLED: &quot;false&quot;</span><br><span class="line">  SPINNAKER_CONFIG_DIR: &#x2F;home&#x2F;spinnaker&#x2F;config</span><br><span class="line">  SPINNAKER_GOOGLE_PROJECT_CREDENTIALS_PATH: &quot;&quot;</span><br><span class="line">  SPINNAKER_HOME: &#x2F;home&#x2F;spinnaker</span><br><span class="line">  SPRING_PROFILES_ACTIVE: armory,configurator,local</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="3-2-2-创建组件配置文件"><a href="#3-2-2-创建组件配置文件" class="headerlink" title="3.2.2 创建组件配置文件"></a>3.2.2 创建组件配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;custom-config.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: custom-config</span><br><span class="line">  namespace: armory</span><br><span class="line">data:</span><br><span class="line">  clouddriver-local.yml: |</span><br><span class="line">    kubernetes:</span><br><span class="line">      enabled: true</span><br><span class="line">      accounts:</span><br><span class="line">        - name: cluster-admin</span><br><span class="line">          serviceAccount: false</span><br><span class="line">          dockerRegistries:</span><br><span class="line">            - accountName: harbor</span><br><span class="line">              namespace: []</span><br><span class="line">          namespaces:</span><br><span class="line">            - test</span><br><span class="line">            - prod</span><br><span class="line">          kubeconfigFile: &#x2F;opt&#x2F;spinnaker&#x2F;credentials&#x2F;custom&#x2F;default-kubeconfig</span><br><span class="line">      primaryAccount: cluster-admin</span><br><span class="line">    dockerRegistry:</span><br><span class="line">      enabled: true</span><br><span class="line">      accounts:</span><br><span class="line">        - name: harbor</span><br><span class="line">          requiredGroupMembership: []</span><br><span class="line">          providerVersion: V1</span><br><span class="line">          insecureRegistry: true</span><br><span class="line">          address: http:&#x2F;&#x2F;harbor.zq.com</span><br><span class="line">          username: admin</span><br><span class="line">          password: Harbor12345</span><br><span class="line">      primaryAccount: harbor</span><br><span class="line">    artifacts:</span><br><span class="line">      s3:</span><br><span class="line">        enabled: true</span><br><span class="line">        accounts:</span><br><span class="line">        - name: armory-config-s3-account</span><br><span class="line">          apiEndpoint: http:&#x2F;&#x2F;minio</span><br><span class="line">          apiRegion: us-east-1</span><br><span class="line">      gcs:</span><br><span class="line">        enabled: false</span><br><span class="line">        accounts:</span><br><span class="line">        - name: armory-config-gcs-account</span><br><span class="line">  custom-config.json: &quot;&quot;</span><br><span class="line">  echo-configurator.yml: |</span><br><span class="line">    diagnostics:</span><br><span class="line">      enabled: true</span><br><span class="line">  front50-local.yml: |</span><br><span class="line">    spinnaker:</span><br><span class="line">      s3:</span><br><span class="line">        endpoint: http:&#x2F;&#x2F;minio</span><br><span class="line">  igor-local.yml: |</span><br><span class="line">    jenkins:</span><br><span class="line">      enabled: true</span><br><span class="line">      masters:</span><br><span class="line">        - name: jenkins-admin</span><br><span class="line">          address: http:&#x2F;&#x2F;jenkins.zq.com</span><br><span class="line">          username: admin</span><br><span class="line">          password: admin123</span><br><span class="line">      primaryAccount: jenkins-admin</span><br><span class="line">  nginx.conf: |</span><br><span class="line">    gzip on;</span><br><span class="line">    gzip_types text&#x2F;plain text&#x2F;css application&#x2F;json application&#x2F;x-javascript text&#x2F;xml application&#x2F;xml application&#x2F;xml+rss text&#x2F;javascript application&#x2F;vnd.ms-fontobject application&#x2F;x-font-ttf font&#x2F;opentype image&#x2F;svg+xml image&#x2F;x-icon;</span><br><span class="line">    server &#123;</span><br><span class="line">           listen 80;</span><br><span class="line">           location &#x2F; &#123;</span><br><span class="line">                proxy_pass http:&#x2F;&#x2F;armory-deck&#x2F;;</span><br><span class="line">           &#125;</span><br><span class="line">           location &#x2F;api&#x2F; &#123;</span><br><span class="line">                proxy_pass http:&#x2F;&#x2F;armory-gate:8084&#x2F;;</span><br><span class="line">           &#125;</span><br><span class="line">           rewrite ^&#x2F;login(.*)$ &#x2F;api&#x2F;login$1 last;</span><br><span class="line">           rewrite ^&#x2F;auth(.*)$ &#x2F;api&#x2F;auth$1 last;</span><br><span class="line">    &#125;</span><br><span class="line">  spinnaker-local.yml: |</span><br><span class="line">    services:</span><br><span class="line">      igor:</span><br><span class="line">        enabled: true</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="3-2-3-创建默认配置文件"><a href="#3-2-3-创建默认配置文件" class="headerlink" title="3.2.3 创建默认配置文件"></a>3.2.3 创建默认配置文件</h4><blockquote><p>注意:</p><p>此配置文件超长,是用armory部署工具部署好后,基本不需要改动</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;default-config.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: default-config</span><br><span class="line">  namespace: armory</span><br><span class="line">data:</span><br><span class="line">  barometer.yml: |</span><br><span class="line">    server:</span><br><span class="line">      port: 9092</span><br><span class="line">    spinnaker:</span><br><span class="line">      redis:</span><br><span class="line">        host: $&#123;services.redis.host&#125;</span><br><span class="line">        port: $&#123;services.redis.port&#125;</span><br><span class="line">  clouddriver-armory.yml: |</span><br><span class="line">    aws:</span><br><span class="line">      defaultAssumeRole: role&#x2F;$&#123;SPINNAKER_AWS_DEFAULT_ASSUME_ROLE:SpinnakerManagedProfile&#125;</span><br><span class="line">      accounts:</span><br><span class="line">        - name: default-aws-account</span><br><span class="line">          accountId: $&#123;SPINNAKER_AWS_DEFAULT_ACCOUNT_ID:none&#125;</span><br><span class="line">      client:</span><br><span class="line">        maxErrorRetry: 20</span><br><span class="line">    serviceLimits:</span><br><span class="line">      cloudProviderOverrides:</span><br><span class="line">        aws:</span><br><span class="line">          rateLimit: 15.0</span><br><span class="line">      implementationLimits:</span><br><span class="line">        AmazonAutoScaling:</span><br><span class="line">          defaults:</span><br><span class="line">            rateLimit: 3.0</span><br><span class="line">        AmazonElasticLoadBalancing:</span><br><span class="line">          defaults:</span><br><span class="line">            rateLimit: 5.0</span><br><span class="line">    security.basic.enabled: false</span><br><span class="line">    management.security.enabled: false</span><br><span class="line">  clouddriver-dev.yml: |</span><br><span class="line">    serviceLimits:</span><br><span class="line">      defaults:</span><br><span class="line">        rateLimit: 2</span><br><span class="line">  clouddriver.yml: |</span><br><span class="line">    server:</span><br><span class="line">      port: $&#123;services.clouddriver.port:7002&#125;</span><br><span class="line">      address: $&#123;services.clouddriver.host:localhost&#125;</span><br><span class="line">    redis:</span><br><span class="line">      connection: $&#123;REDIS_HOST:redis:&#x2F;&#x2F;localhost:6379&#125;</span><br><span class="line">    udf:</span><br><span class="line">      enabled: $&#123;services.clouddriver.aws.udf.enabled:true&#125;</span><br><span class="line">      udfRoot: &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;udf</span><br><span class="line">      defaultLegacyUdf: false</span><br><span class="line">    default:</span><br><span class="line">      account:</span><br><span class="line">        env: $&#123;providers.aws.primaryCredentials.name&#125;</span><br><span class="line">    aws:</span><br><span class="line">      enabled: $&#123;providers.aws.enabled:false&#125;</span><br><span class="line">      defaults:</span><br><span class="line">        iamRole: $&#123;providers.aws.defaultIAMRole:BaseIAMRole&#125;</span><br><span class="line">      defaultRegions:</span><br><span class="line">        - name: $&#123;providers.aws.defaultRegion:us-east-1&#125;</span><br><span class="line">      defaultFront50Template: $&#123;services.front50.baseUrl&#125;</span><br><span class="line">      defaultKeyPairTemplate: $&#123;providers.aws.defaultKeyPairTemplate&#125;</span><br><span class="line">    azure:</span><br><span class="line">      enabled: $&#123;providers.azure.enabled:false&#125;</span><br><span class="line">      accounts:</span><br><span class="line">        - name: $&#123;providers.azure.primaryCredentials.name&#125;</span><br><span class="line">          clientId: $&#123;providers.azure.primaryCredentials.clientId&#125;</span><br><span class="line">          appKey: $&#123;providers.azure.primaryCredentials.appKey&#125;</span><br><span class="line">          tenantId: $&#123;providers.azure.primaryCredentials.tenantId&#125;</span><br><span class="line">          subscriptionId: $&#123;providers.azure.primaryCredentials.subscriptionId&#125;</span><br><span class="line">    google:</span><br><span class="line">      enabled: $&#123;providers.google.enabled:false&#125;</span><br><span class="line">      accounts:</span><br><span class="line">        - name: $&#123;providers.google.primaryCredentials.name&#125;</span><br><span class="line">          project: $&#123;providers.google.primaryCredentials.project&#125;</span><br><span class="line">          jsonPath: $&#123;providers.google.primaryCredentials.jsonPath&#125;</span><br><span class="line">          consul:</span><br><span class="line">            enabled: $&#123;providers.google.primaryCredentials.consul.enabled:false&#125;</span><br><span class="line">    cf:</span><br><span class="line">      enabled: $&#123;providers.cf.enabled:false&#125;</span><br><span class="line">      accounts:</span><br><span class="line">        - name: $&#123;providers.cf.primaryCredentials.name&#125;</span><br><span class="line">          api: $&#123;providers.cf.primaryCredentials.api&#125;</span><br><span class="line">          console: $&#123;providers.cf.primaryCredentials.console&#125;</span><br><span class="line">          org: $&#123;providers.cf.defaultOrg&#125;</span><br><span class="line">          space: $&#123;providers.cf.defaultSpace&#125;</span><br><span class="line">          username: $&#123;providers.cf.account.name:&#125;</span><br><span class="line">          password: $&#123;providers.cf.account.password:&#125;</span><br><span class="line">    kubernetes:</span><br><span class="line">      enabled: $&#123;providers.kubernetes.enabled:false&#125;</span><br><span class="line">      accounts:</span><br><span class="line">        - name: $&#123;providers.kubernetes.primaryCredentials.name&#125;</span><br><span class="line">          dockerRegistries:</span><br><span class="line">            - accountName: $&#123;providers.kubernetes.primaryCredentials.dockerRegistryAccount&#125;</span><br><span class="line">    openstack:</span><br><span class="line">      enabled: $&#123;providers.openstack.enabled:false&#125;</span><br><span class="line">      accounts:</span><br><span class="line">        - name: $&#123;providers.openstack.primaryCredentials.name&#125;</span><br><span class="line">          authUrl: $&#123;providers.openstack.primaryCredentials.authUrl&#125;</span><br><span class="line">          username: $&#123;providers.openstack.primaryCredentials.username&#125;</span><br><span class="line">          password: $&#123;providers.openstack.primaryCredentials.password&#125;</span><br><span class="line">          projectName: $&#123;providers.openstack.primaryCredentials.projectName&#125;</span><br><span class="line">          domainName: $&#123;providers.openstack.primaryCredentials.domainName:Default&#125;</span><br><span class="line">          regions: $&#123;providers.openstack.primaryCredentials.regions&#125;</span><br><span class="line">          insecure: $&#123;providers.openstack.primaryCredentials.insecure:false&#125;</span><br><span class="line">          userDataFile: $&#123;providers.openstack.primaryCredentials.userDataFile:&#125;</span><br><span class="line">          lbaas:</span><br><span class="line">            pollTimeout: 60</span><br><span class="line">            pollInterval: 5</span><br><span class="line">    dockerRegistry:</span><br><span class="line">      enabled: $&#123;providers.dockerRegistry.enabled:false&#125;</span><br><span class="line">      accounts:</span><br><span class="line">        - name: $&#123;providers.dockerRegistry.primaryCredentials.name&#125;</span><br><span class="line">          address: $&#123;providers.dockerRegistry.primaryCredentials.address&#125;</span><br><span class="line">          username: $&#123;providers.dockerRegistry.primaryCredentials.username:&#125;</span><br><span class="line">          passwordFile: $&#123;providers.dockerRegistry.primaryCredentials.passwordFile&#125;</span><br><span class="line">    credentials:</span><br><span class="line">      primaryAccountTypes: $&#123;providers.aws.primaryCredentials.name&#125;, $&#123;providers.google.primaryCredentials.name&#125;, $&#123;providers.cf.primaryCredentials.name&#125;, $&#123;providers.azure.primaryCredentials.name&#125;</span><br><span class="line">      challengeDestructiveActionsEnvironments: $&#123;providers.aws.primaryCredentials.name&#125;, $&#123;providers.google.primaryCredentials.name&#125;, $&#123;providers.cf.primaryCredentials.name&#125;, $&#123;providers.azure.primaryCredentials.name&#125;</span><br><span class="line">    spectator:</span><br><span class="line">      applicationName: $&#123;spring.application.name&#125;</span><br><span class="line">      webEndpoint:</span><br><span class="line">        enabled: $&#123;services.spectator.webEndpoint.enabled:false&#125;</span><br><span class="line">        prototypeFilter:</span><br><span class="line">          path: $&#123;services.spectator.webEndpoint.prototypeFilter.path:&#125;</span><br><span class="line">      stackdriver:</span><br><span class="line">        enabled: $&#123;services.stackdriver.enabled&#125;</span><br><span class="line">        projectName: $&#123;services.stackdriver.projectName&#125;</span><br><span class="line">        credentialsPath: $&#123;services.stackdriver.credentialsPath&#125;</span><br><span class="line">    stackdriver:</span><br><span class="line">      hints:</span><br><span class="line">        - name: controller.invocations</span><br><span class="line">          labels:</span><br><span class="line">          - account</span><br><span class="line">          - region</span><br><span class="line">  dinghy.yml: &quot;&quot;</span><br><span class="line">  echo-armory.yml: |</span><br><span class="line">    diagnostics:</span><br><span class="line">      enabled: true</span><br><span class="line">      id: $&#123;ARMORY_ID:unknown&#125;</span><br><span class="line">    armorywebhooks:</span><br><span class="line">      enabled: false</span><br><span class="line">      forwarding:</span><br><span class="line">        baseUrl: http:&#x2F;&#x2F;armory-dinghy:8081</span><br><span class="line">        endpoint: v1&#x2F;webhooks</span><br><span class="line">  echo-noncron.yml: |</span><br><span class="line">    scheduler:</span><br><span class="line">      enabled: false</span><br><span class="line">  echo.yml: |</span><br><span class="line">    server:</span><br><span class="line">      port: $&#123;services.echo.port:8089&#125;</span><br><span class="line">      address: $&#123;services.echo.host:localhost&#125;</span><br><span class="line">    cassandra:</span><br><span class="line">      enabled: $&#123;services.echo.cassandra.enabled:false&#125;</span><br><span class="line">      embedded: $&#123;services.cassandra.embedded:false&#125;</span><br><span class="line">      host: $&#123;services.cassandra.host:localhost&#125;</span><br><span class="line">    spinnaker:</span><br><span class="line">      baseUrl: $&#123;services.deck.baseUrl&#125;</span><br><span class="line">      cassandra:</span><br><span class="line">         enabled: $&#123;services.echo.cassandra.enabled:false&#125;</span><br><span class="line">      inMemory:</span><br><span class="line">         enabled: $&#123;services.echo.inMemory.enabled:true&#125;</span><br><span class="line">    front50:</span><br><span class="line">      baseUrl: $&#123;services.front50.baseUrl:http:&#x2F;&#x2F;localhost:8080 &#125;</span><br><span class="line">    orca:</span><br><span class="line">      baseUrl: $&#123;services.orca.baseUrl:http:&#x2F;&#x2F;localhost:8083 &#125;</span><br><span class="line">    endpoints.health.sensitive: false</span><br><span class="line">    slack:</span><br><span class="line">      enabled: $&#123;services.echo.notifications.slack.enabled:false&#125;</span><br><span class="line">      token: $&#123;services.echo.notifications.slack.token&#125;</span><br><span class="line">    spring:</span><br><span class="line">      mail:</span><br><span class="line">        host: $&#123;mail.host&#125;</span><br><span class="line">    mail:</span><br><span class="line">      enabled: $&#123;services.echo.notifications.mail.enabled:false&#125;</span><br><span class="line">      host: $&#123;services.echo.notifications.mail.host&#125;</span><br><span class="line">      from: $&#123;services.echo.notifications.mail.fromAddress&#125;</span><br><span class="line">    hipchat:</span><br><span class="line">      enabled: $&#123;services.echo.notifications.hipchat.enabled:false&#125;</span><br><span class="line">      baseUrl: $&#123;services.echo.notifications.hipchat.url&#125;</span><br><span class="line">      token: $&#123;services.echo.notifications.hipchat.token&#125;</span><br><span class="line">    twilio:</span><br><span class="line">      enabled: $&#123;services.echo.notifications.sms.enabled:false&#125;</span><br><span class="line">      baseUrl: $&#123;services.echo.notifications.sms.url:https:&#x2F;&#x2F;api.twilio.com&#x2F; &#125;</span><br><span class="line">      account: $&#123;services.echo.notifications.sms.account&#125;</span><br><span class="line">      token: $&#123;services.echo.notifications.sms.token&#125;</span><br><span class="line">      from: $&#123;services.echo.notifications.sms.from&#125;</span><br><span class="line">    scheduler:</span><br><span class="line">      enabled: $&#123;services.echo.cron.enabled:true&#125;</span><br><span class="line">      threadPoolSize: 20</span><br><span class="line">      triggeringEnabled: true</span><br><span class="line">      pipelineConfigsPoller:</span><br><span class="line">        enabled: true</span><br><span class="line">        pollingIntervalMs: 30000</span><br><span class="line">      cron:</span><br><span class="line">        timezone: $&#123;services.echo.cron.timezone&#125;</span><br><span class="line">    spectator:</span><br><span class="line">      applicationName: $&#123;spring.application.name&#125;</span><br><span class="line">      webEndpoint:</span><br><span class="line">        enabled: $&#123;services.spectator.webEndpoint.enabled:false&#125;</span><br><span class="line">        prototypeFilter:</span><br><span class="line">          path: $&#123;services.spectator.webEndpoint.prototypeFilter.path:&#125;</span><br><span class="line">      stackdriver:</span><br><span class="line">        enabled: $&#123;services.stackdriver.enabled&#125;</span><br><span class="line">        projectName: $&#123;services.stackdriver.projectName&#125;</span><br><span class="line">        credentialsPath: $&#123;services.stackdriver.credentialsPath&#125;</span><br><span class="line">    webhooks:</span><br><span class="line">      artifacts:</span><br><span class="line">        enabled: true</span><br><span class="line">  fetch.sh: |+</span><br><span class="line">  </span><br><span class="line">    CONFIG_LOCATION&#x3D;$&#123;SPINNAKER_HOME:-&quot;&#x2F;opt&#x2F;spinnaker&quot;&#125;&#x2F;config</span><br><span class="line">    CONTAINER&#x3D;$1</span><br><span class="line">    rm -f &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;*.yml</span><br><span class="line">    mkdir -p $&#123;CONFIG_LOCATION&#125;</span><br><span class="line">    for filename in &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;default&#x2F;*.yml; do</span><br><span class="line">        cp $filename $&#123;CONFIG_LOCATION&#125;</span><br><span class="line">    done</span><br><span class="line">    if [ -d &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;custom ]; then</span><br><span class="line">        for filename in &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;custom&#x2F;*; do</span><br><span class="line">            cp $filename $&#123;CONFIG_LOCATION&#125;</span><br><span class="line">        done</span><br><span class="line">    fi</span><br><span class="line">    add_ca_certs() &#123;</span><br><span class="line">      ca_cert_path&#x3D;&quot;$1&quot;</span><br><span class="line">      jks_path&#x3D;&quot;$2&quot;</span><br><span class="line">      alias&#x3D;&quot;$3&quot;</span><br><span class="line">      if [[ &quot;$(whoami)&quot; !&#x3D; &quot;root&quot; ]]; then</span><br><span class="line">        echo &quot;INFO: I do not have proper permisions to add CA roots&quot;</span><br><span class="line">        return</span><br><span class="line">      fi</span><br><span class="line">      if [[ ! -f $&#123;ca_cert_path&#125; ]]; then</span><br><span class="line">        echo &quot;INFO: No CA cert found at $&#123;ca_cert_path&#125;&quot;</span><br><span class="line">        return</span><br><span class="line">      fi</span><br><span class="line">      keytool -importcert \</span><br><span class="line">          -file $&#123;ca_cert_path&#125; \</span><br><span class="line">          -keystore $&#123;jks_path&#125; \</span><br><span class="line">          -alias $&#123;alias&#125; \</span><br><span class="line">          -storepass changeit \</span><br><span class="line">          -noprompt</span><br><span class="line">    &#125;</span><br><span class="line">    if [ &#96;which keytool&#96; ]; then</span><br><span class="line">      echo &quot;INFO: Keytool found adding certs where appropriate&quot;</span><br><span class="line">      add_ca_certs &quot;$&#123;CONFIG_LOCATION&#125;&#x2F;ca.crt&quot; &quot;&#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;java&#x2F;cacerts&quot; &quot;custom-ca&quot;</span><br><span class="line">    else</span><br><span class="line">      echo &quot;INFO: Keytool not found, not adding any certs&#x2F;private keys&quot;</span><br><span class="line">    fi</span><br><span class="line">    saml_pem_path&#x3D;&quot;&#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;custom&#x2F;saml.pem&quot;</span><br><span class="line">    saml_pkcs12_path&#x3D;&quot;&#x2F;tmp&#x2F;saml.pkcs12&quot;</span><br><span class="line">    saml_jks_path&#x3D;&quot;$&#123;CONFIG_LOCATION&#125;&#x2F;saml.jks&quot;</span><br><span class="line">    x509_ca_cert_path&#x3D;&quot;&#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;custom&#x2F;x509ca.crt&quot;</span><br><span class="line">    x509_client_cert_path&#x3D;&quot;&#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;custom&#x2F;x509client.crt&quot;</span><br><span class="line">    x509_jks_path&#x3D;&quot;$&#123;CONFIG_LOCATION&#125;&#x2F;x509.jks&quot;</span><br><span class="line">    x509_nginx_cert_path&#x3D;&quot;&#x2F;opt&#x2F;nginx&#x2F;certs&#x2F;ssl.crt&quot;</span><br><span class="line">    if [ &quot;$&#123;CONTAINER&#125;&quot; &#x3D;&#x3D; &quot;gate&quot; ]; then</span><br><span class="line">        if [ -f $&#123;saml_pem_path&#125; ]; then</span><br><span class="line">            echo &quot;Loading $&#123;saml_pem_path&#125; into $&#123;saml_jks_path&#125;&quot;</span><br><span class="line">            openssl pkcs12 -export -out $&#123;saml_pkcs12_path&#125; -in $&#123;saml_pem_path&#125; -password pass:changeit -name saml</span><br><span class="line">            keytool -genkey -v -keystore $&#123;saml_jks_path&#125; -alias saml \</span><br><span class="line">                    -keyalg RSA -keysize 2048 -validity 10000 \</span><br><span class="line">                    -storepass changeit -keypass changeit -dname &quot;CN&#x3D;armory&quot;</span><br><span class="line">            keytool -importkeystore \</span><br><span class="line">                    -srckeystore $&#123;saml_pkcs12_path&#125; \</span><br><span class="line">                    -srcstoretype PKCS12 \</span><br><span class="line">                    -srcstorepass changeit \</span><br><span class="line">                    -destkeystore $&#123;saml_jks_path&#125; \</span><br><span class="line">                    -deststoretype JKS \</span><br><span class="line">                    -storepass changeit \</span><br><span class="line">                    -alias saml \</span><br><span class="line">                    -destalias saml \</span><br><span class="line">                    -noprompt</span><br><span class="line">        else</span><br><span class="line">            echo &quot;No SAML IDP pemfile found at $&#123;saml_pem_path&#125;&quot;</span><br><span class="line">        fi</span><br><span class="line">        if [ -f $&#123;x509_ca_cert_path&#125; ]; then</span><br><span class="line">            echo &quot;Loading $&#123;x509_ca_cert_path&#125; into $&#123;x509_jks_path&#125;&quot;</span><br><span class="line">            add_ca_certs $&#123;x509_ca_cert_path&#125; $&#123;x509_jks_path&#125; &quot;ca&quot;</span><br><span class="line">        else</span><br><span class="line">            echo &quot;No x509 CA cert found at $&#123;x509_ca_cert_path&#125;&quot;</span><br><span class="line">        fi</span><br><span class="line">        if [ -f $&#123;x509_client_cert_path&#125; ]; then</span><br><span class="line">            echo &quot;Loading $&#123;x509_client_cert_path&#125; into $&#123;x509_jks_path&#125;&quot;</span><br><span class="line">            add_ca_certs $&#123;x509_client_cert_path&#125; $&#123;x509_jks_path&#125; &quot;client&quot;</span><br><span class="line">        else</span><br><span class="line">            echo &quot;No x509 Client cert found at $&#123;x509_client_cert_path&#125;&quot;</span><br><span class="line">        fi</span><br><span class="line">        if [ -f $&#123;x509_nginx_cert_path&#125; ]; then</span><br><span class="line">            echo &quot;Creating a self-signed CA (EXPIRES IN 360 DAYS) with java keystore: $&#123;x509_jks_path&#125;&quot;</span><br><span class="line">            echo -e &quot;\n\n\n\n\n\ny\n&quot; | keytool -genkey -keyalg RSA -alias server -keystore keystore.jks -storepass changeit -validity 360 -keysize 2048</span><br><span class="line">            keytool -importkeystore \</span><br><span class="line">                    -srckeystore keystore.jks \</span><br><span class="line">                    -srcstorepass changeit \</span><br><span class="line">                    -destkeystore &quot;$&#123;x509_jks_path&#125;&quot; \</span><br><span class="line">                    -storepass changeit \</span><br><span class="line">                    -srcalias server \</span><br><span class="line">                    -destalias server \</span><br><span class="line">                    -noprompt</span><br><span class="line">        else</span><br><span class="line">            echo &quot;No x509 nginx cert found at $&#123;x509_nginx_cert_path&#125;&quot;</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">    if [ &quot;$&#123;CONTAINER&#125;&quot; &#x3D;&#x3D; &quot;nginx&quot; ]; then</span><br><span class="line">        nginx_conf_path&#x3D;&quot;&#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;default&#x2F;nginx.conf&quot;</span><br><span class="line">        if [ -f $&#123;nginx_conf_path&#125; ]; then</span><br><span class="line">            cp $&#123;nginx_conf_path&#125; &#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">  fiat.yml: |-</span><br><span class="line">    server:</span><br><span class="line">      port: $&#123;services.fiat.port:7003&#125;</span><br><span class="line">      address: $&#123;services.fiat.host:localhost&#125;</span><br><span class="line">    redis:</span><br><span class="line">      connection: $&#123;services.redis.connection:redis:&#x2F;&#x2F;localhost:6379&#125;</span><br><span class="line">    spectator:</span><br><span class="line">      applicationName: $&#123;spring.application.name&#125;</span><br><span class="line">      webEndpoint:</span><br><span class="line">        enabled: $&#123;services.spectator.webEndpoint.enabled:false&#125;</span><br><span class="line">        prototypeFilter:</span><br><span class="line">          path: $&#123;services.spectator.webEndpoint.prototypeFilter.path:&#125;</span><br><span class="line">      stackdriver:</span><br><span class="line">        enabled: $&#123;services.stackdriver.enabled&#125;</span><br><span class="line">        projectName: $&#123;services.stackdriver.projectName&#125;</span><br><span class="line">        credentialsPath: $&#123;services.stackdriver.credentialsPath&#125;</span><br><span class="line">    hystrix:</span><br><span class="line">     command:</span><br><span class="line">       default.execution.isolation.thread.timeoutInMilliseconds: 20000</span><br><span class="line">    logging:</span><br><span class="line">      level:</span><br><span class="line">        com.netflix.spinnaker.fiat: DEBUG</span><br><span class="line">  front50-armory.yml: |</span><br><span class="line">    spinnaker:</span><br><span class="line">      redis:</span><br><span class="line">        enabled: true</span><br><span class="line">        host: redis</span><br><span class="line">  front50.yml: |</span><br><span class="line">    server:</span><br><span class="line">      port: $&#123;services.front50.port:8080&#125;</span><br><span class="line">      address: $&#123;services.front50.host:localhost&#125;</span><br><span class="line">    hystrix:</span><br><span class="line">      command:</span><br><span class="line">        default.execution.isolation.thread.timeoutInMilliseconds: 15000</span><br><span class="line">    cassandra:</span><br><span class="line">      enabled: $&#123;services.front50.cassandra.enabled:false&#125;</span><br><span class="line">      embedded: $&#123;services.cassandra.embedded:false&#125;</span><br><span class="line">      host: $&#123;services.cassandra.host:localhost&#125;</span><br><span class="line">    aws:</span><br><span class="line">      simpleDBEnabled: $&#123;providers.aws.simpleDBEnabled:false&#125;</span><br><span class="line">      defaultSimpleDBDomain: $&#123;providers.aws.defaultSimpleDBDomain&#125;</span><br><span class="line">    spinnaker:</span><br><span class="line">      cassandra:</span><br><span class="line">        enabled: $&#123;services.front50.cassandra.enabled:false&#125;</span><br><span class="line">        host: $&#123;services.cassandra.host:localhost&#125;</span><br><span class="line">        port: $&#123;services.cassandra.port:9042&#125;</span><br><span class="line">        cluster: $&#123;services.cassandra.cluster:CASS_SPINNAKER&#125;</span><br><span class="line">        keyspace: front50</span><br><span class="line">        name: global</span><br><span class="line">      redis:</span><br><span class="line">        enabled: $&#123;services.front50.redis.enabled:false&#125;</span><br><span class="line">      gcs:</span><br><span class="line">        enabled: $&#123;services.front50.gcs.enabled:false&#125;</span><br><span class="line">        bucket: $&#123;services.front50.storage_bucket:&#125;</span><br><span class="line">        bucketLocation: $&#123;services.front50.bucket_location:&#125;</span><br><span class="line">        rootFolder: $&#123;services.front50.rootFolder:front50&#125;</span><br><span class="line">        project: $&#123;providers.google.primaryCredentials.project&#125;</span><br><span class="line">        jsonPath: $&#123;providers.google.primaryCredentials.jsonPath&#125;</span><br><span class="line">      s3:</span><br><span class="line">        enabled: $&#123;services.front50.s3.enabled:false&#125;</span><br><span class="line">        bucket: $&#123;services.front50.storage_bucket:&#125;</span><br><span class="line">        rootFolder: $&#123;services.front50.rootFolder:front50&#125;</span><br><span class="line">    spectator:</span><br><span class="line">      applicationName: $&#123;spring.application.name&#125;</span><br><span class="line">      webEndpoint:</span><br><span class="line">        enabled: $&#123;services.spectator.webEndpoint.enabled:false&#125;</span><br><span class="line">        prototypeFilter:</span><br><span class="line">          path: $&#123;services.spectator.webEndpoint.prototypeFilter.path:&#125;</span><br><span class="line">      stackdriver:</span><br><span class="line">        enabled: $&#123;services.stackdriver.enabled&#125;</span><br><span class="line">        projectName: $&#123;services.stackdriver.projectName&#125;</span><br><span class="line">        credentialsPath: $&#123;services.stackdriver.credentialsPath&#125;</span><br><span class="line">    stackdriver:</span><br><span class="line">      hints:</span><br><span class="line">        - name: controller.invocations</span><br><span class="line">          labels:</span><br><span class="line">          - application</span><br><span class="line">          - cause</span><br><span class="line">        - name: aws.request.httpRequestTime</span><br><span class="line">          labels:</span><br><span class="line">          - status</span><br><span class="line">          - exception</span><br><span class="line">          - AWSErrorCode</span><br><span class="line">        - name: aws.request.requestSigningTime</span><br><span class="line">          labels:</span><br><span class="line">          - exception</span><br><span class="line">  gate-armory.yml: |+</span><br><span class="line">    lighthouse:</span><br><span class="line">        baseUrl: http:&#x2F;&#x2F;$&#123;DEFAULT_DNS_NAME:lighthouse&#125;:5000</span><br><span class="line">  gate.yml: |</span><br><span class="line">    server:</span><br><span class="line">      port: $&#123;services.gate.port:8084&#125;</span><br><span class="line">      address: $&#123;services.gate.host:localhost&#125;</span><br><span class="line">    redis:</span><br><span class="line">      connection: $&#123;REDIS_HOST:redis:&#x2F;&#x2F;localhost:6379&#125;</span><br><span class="line">      configuration:</span><br><span class="line">        secure: true</span><br><span class="line">    spectator:</span><br><span class="line">      applicationName: $&#123;spring.application.name&#125;</span><br><span class="line">      webEndpoint:</span><br><span class="line">        enabled: $&#123;services.spectator.webEndpoint.enabled:false&#125;</span><br><span class="line">        prototypeFilter:</span><br><span class="line">          path: $&#123;services.spectator.webEndpoint.prototypeFilter.path:&#125;</span><br><span class="line">      stackdriver:</span><br><span class="line">        enabled: $&#123;services.stackdriver.enabled&#125;</span><br><span class="line">        projectName: $&#123;services.stackdriver.projectName&#125;</span><br><span class="line">        credentialsPath: $&#123;services.stackdriver.credentialsPath&#125;</span><br><span class="line">    stackdriver:</span><br><span class="line">      hints:</span><br><span class="line">        - name: EurekaOkClient_Request</span><br><span class="line">          labels:</span><br><span class="line">          - cause</span><br><span class="line">          - reason</span><br><span class="line">          - status</span><br><span class="line">  igor-nonpolling.yml: |</span><br><span class="line">    jenkins:</span><br><span class="line">      polling:</span><br><span class="line">        enabled: false</span><br><span class="line">  igor.yml: |</span><br><span class="line">    server:</span><br><span class="line">      port: $&#123;services.igor.port:8088&#125;</span><br><span class="line">      address: $&#123;services.igor.host:localhost&#125;</span><br><span class="line">    jenkins:</span><br><span class="line">      enabled: $&#123;services.jenkins.enabled:false&#125;</span><br><span class="line">      masters:</span><br><span class="line">        - name: $&#123;services.jenkins.defaultMaster.name&#125;</span><br><span class="line">          address: $&#123;services.jenkins.defaultMaster.baseUrl&#125;</span><br><span class="line">          username: $&#123;services.jenkins.defaultMaster.username&#125;</span><br><span class="line">          password: $&#123;services.jenkins.defaultMaster.password&#125;</span><br><span class="line">          csrf: $&#123;services.jenkins.defaultMaster.csrf:false&#125;</span><br><span class="line">          </span><br><span class="line">    travis:</span><br><span class="line">      enabled: $&#123;services.travis.enabled:false&#125;</span><br><span class="line">      masters:</span><br><span class="line">        - name: $&#123;services.travis.defaultMaster.name&#125;</span><br><span class="line">          baseUrl: $&#123;services.travis.defaultMaster.baseUrl&#125;</span><br><span class="line">          address: $&#123;services.travis.defaultMaster.address&#125;</span><br><span class="line">          githubToken: $&#123;services.travis.defaultMaster.githubToken&#125;</span><br><span class="line">    dockerRegistry:</span><br><span class="line">      enabled: $&#123;providers.dockerRegistry.enabled:false&#125;</span><br><span class="line">    redis:</span><br><span class="line">      connection: $&#123;REDIS_HOST:redis:&#x2F;&#x2F;localhost:6379&#125;</span><br><span class="line">    spectator:</span><br><span class="line">      applicationName: $&#123;spring.application.name&#125;</span><br><span class="line">      webEndpoint:</span><br><span class="line">        enabled: $&#123;services.spectator.webEndpoint.enabled:false&#125;</span><br><span class="line">        prototypeFilter:</span><br><span class="line">          path: $&#123;services.spectator.webEndpoint.prototypeFilter.path:&#125;</span><br><span class="line">      stackdriver:</span><br><span class="line">        enabled: $&#123;services.stackdriver.enabled&#125;</span><br><span class="line">        projectName: $&#123;services.stackdriver.projectName&#125;</span><br><span class="line">        credentialsPath: $&#123;services.stackdriver.credentialsPath&#125;</span><br><span class="line">    stackdriver:</span><br><span class="line">      hints:</span><br><span class="line">        - name: controller.invocations</span><br><span class="line">          labels:</span><br><span class="line">          - master</span><br><span class="line">  kayenta-armory.yml: |</span><br><span class="line">    kayenta:</span><br><span class="line">      aws:</span><br><span class="line">        enabled: $&#123;ARMORYSPINNAKER_S3_ENABLED:false&#125;</span><br><span class="line">        accounts:</span><br><span class="line">          - name: aws-s3-storage</span><br><span class="line">            bucket: $&#123;ARMORYSPINNAKER_CONF_STORE_BUCKET&#125;</span><br><span class="line">            rootFolder: kayenta</span><br><span class="line">            supportedTypes:</span><br><span class="line">              - OBJECT_STORE</span><br><span class="line">              - CONFIGURATION_STORE</span><br><span class="line">      s3:</span><br><span class="line">        enabled: $&#123;ARMORYSPINNAKER_S3_ENABLED:false&#125;</span><br><span class="line">      google:</span><br><span class="line">        enabled: $&#123;ARMORYSPINNAKER_GCS_ENABLED:false&#125;</span><br><span class="line">        accounts:</span><br><span class="line">          - name: cloud-armory</span><br><span class="line">            bucket: $&#123;ARMORYSPINNAKER_CONF_STORE_BUCKET&#125;</span><br><span class="line">            rootFolder: kayenta-prod</span><br><span class="line">            supportedTypes:</span><br><span class="line">              - METRICS_STORE</span><br><span class="line">              - OBJECT_STORE</span><br><span class="line">              - CONFIGURATION_STORE</span><br><span class="line">              </span><br><span class="line">      gcs:</span><br><span class="line">        enabled: $&#123;ARMORYSPINNAKER_GCS_ENABLED:false&#125;</span><br><span class="line">  kayenta.yml: |2</span><br><span class="line">    server:</span><br><span class="line">      port: 8090</span><br><span class="line">    kayenta:</span><br><span class="line">      atlas:</span><br><span class="line">        enabled: false</span><br><span class="line">      google:</span><br><span class="line">        enabled: false</span><br><span class="line">      aws:</span><br><span class="line">        enabled: false</span><br><span class="line">      datadog:</span><br><span class="line">        enabled: false</span><br><span class="line">      prometheus:</span><br><span class="line">        enabled: false</span><br><span class="line">      gcs:</span><br><span class="line">        enabled: false</span><br><span class="line">      s3:</span><br><span class="line">        enabled: false</span><br><span class="line">      stackdriver:</span><br><span class="line">        enabled: false</span><br><span class="line">      memory:</span><br><span class="line">        enabled: false</span><br><span class="line">      configbin:</span><br><span class="line">        enabled: false</span><br><span class="line">    keiko:</span><br><span class="line">      queue:</span><br><span class="line">        redis:</span><br><span class="line">          queueName: kayenta.keiko.queue</span><br><span class="line">          deadLetterQueueName: kayenta.keiko.queue.deadLetters</span><br><span class="line">    redis:</span><br><span class="line">      connection: $&#123;REDIS_HOST:redis:&#x2F;&#x2F;localhost:6379&#125;</span><br><span class="line">    spectator:</span><br><span class="line">      applicationName: $&#123;spring.application.name&#125;</span><br><span class="line">      webEndpoint:</span><br><span class="line">        enabled: true</span><br><span class="line">    swagger:</span><br><span class="line">      enabled: true</span><br><span class="line">      title: Kayenta API</span><br><span class="line">      description:</span><br><span class="line">      contact:</span><br><span class="line">      patterns:</span><br><span class="line">        - &#x2F;admin.*</span><br><span class="line">        - &#x2F;canary.*</span><br><span class="line">        - &#x2F;canaryConfig.*</span><br><span class="line">        - &#x2F;canaryJudgeResult.*</span><br><span class="line">        - &#x2F;credentials.*</span><br><span class="line">        - &#x2F;fetch.*</span><br><span class="line">        - &#x2F;health</span><br><span class="line">        - &#x2F;judges.*</span><br><span class="line">        - &#x2F;metadata.*</span><br><span class="line">        - &#x2F;metricSetList.*</span><br><span class="line">        - &#x2F;metricSetPairList.*</span><br><span class="line">        - &#x2F;pipeline.*</span><br><span class="line">    security.basic.enabled: false</span><br><span class="line">    management.security.enabled: false</span><br><span class="line">  nginx.conf: |</span><br><span class="line">    user  nginx;</span><br><span class="line">    worker_processes  1;</span><br><span class="line">    error_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log warn;</span><br><span class="line">    pid        &#x2F;var&#x2F;run&#x2F;nginx.pid;</span><br><span class="line">    events &#123;</span><br><span class="line">        worker_connections  1024;</span><br><span class="line">    &#125;</span><br><span class="line">    http &#123;</span><br><span class="line">        include       &#x2F;etc&#x2F;nginx&#x2F;mime.types;</span><br><span class="line">        default_type  application&#x2F;octet-stream;</span><br><span class="line">        log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span><br><span class="line">                          &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span><br><span class="line">                          &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;</span><br><span class="line">        access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log  main;</span><br><span class="line">        </span><br><span class="line">        sendfile        on;</span><br><span class="line">        keepalive_timeout  65;</span><br><span class="line">        include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;</span><br><span class="line">    &#125;</span><br><span class="line">    stream &#123;</span><br><span class="line">        upstream gate_api &#123;</span><br><span class="line">            server armory-gate:8085;</span><br><span class="line">        &#125;</span><br><span class="line">        server &#123;</span><br><span class="line">            listen 8085;</span><br><span class="line">            proxy_pass gate_api;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  nginx.http.conf: |</span><br><span class="line">    gzip on;</span><br><span class="line">    gzip_types text&#x2F;plain text&#x2F;css application&#x2F;json application&#x2F;x-javascript text&#x2F;xml application&#x2F;xml application&#x2F;xml+rss text&#x2F;javascript application&#x2F;vnd.ms-fontobject application&#x2F;x-font-ttf font&#x2F;opentype image&#x2F;svg+xml image&#x2F;x-icon;</span><br><span class="line">    server &#123;</span><br><span class="line">           listen 80;</span><br><span class="line">           listen [::]:80;</span><br><span class="line">           location &#x2F; &#123;</span><br><span class="line">                proxy_pass http:&#x2F;&#x2F;armory-deck&#x2F;;</span><br><span class="line">           &#125;</span><br><span class="line">           location &#x2F;api&#x2F; &#123;</span><br><span class="line">                proxy_pass http:&#x2F;&#x2F;armory-gate:8084&#x2F;;</span><br><span class="line">           &#125;</span><br><span class="line">           location &#x2F;slack&#x2F; &#123;</span><br><span class="line">               proxy_pass http:&#x2F;&#x2F;armory-platform:10000&#x2F;;</span><br><span class="line">           &#125;</span><br><span class="line">           rewrite ^&#x2F;login(.*)$ &#x2F;api&#x2F;login$1 last;</span><br><span class="line">           rewrite ^&#x2F;auth(.*)$ &#x2F;api&#x2F;auth$1 last;</span><br><span class="line">    &#125;</span><br><span class="line">  nginx.https.conf: |</span><br><span class="line">    gzip on;</span><br><span class="line">    gzip_types text&#x2F;plain text&#x2F;css application&#x2F;json application&#x2F;x-javascript text&#x2F;xml application&#x2F;xml application&#x2F;xml+rss text&#x2F;javascript application&#x2F;vnd.ms-fontobject application&#x2F;x-font-ttf font&#x2F;opentype image&#x2F;svg+xml image&#x2F;x-icon;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        listen [::]:80;</span><br><span class="line">        return 301 https:&#x2F;&#x2F;$host$request_uri;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 443 ssl;</span><br><span class="line">        listen [::]:443 ssl;</span><br><span class="line">        ssl on;</span><br><span class="line">        ssl_certificate &#x2F;opt&#x2F;nginx&#x2F;certs&#x2F;ssl.crt;</span><br><span class="line">        ssl_certificate_key &#x2F;opt&#x2F;nginx&#x2F;certs&#x2F;ssl.key;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            proxy_pass http:&#x2F;&#x2F;armory-deck&#x2F;;</span><br><span class="line">        &#125;</span><br><span class="line">        location &#x2F;api&#x2F; &#123;</span><br><span class="line">            proxy_pass http:&#x2F;&#x2F;armory-gate:8084&#x2F;;</span><br><span class="line">            proxy_set_header Host            $host;</span><br><span class="line">            proxy_set_header X-Real-IP       $proxy_protocol_addr;</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_protocol_addr;</span><br><span class="line">            proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">        &#125;</span><br><span class="line">        location &#x2F;slack&#x2F; &#123;</span><br><span class="line">            proxy_pass http:&#x2F;&#x2F;armory-platform:10000&#x2F;;</span><br><span class="line">        &#125;</span><br><span class="line">        rewrite ^&#x2F;login(.*)$ &#x2F;api&#x2F;login$1 last;</span><br><span class="line">        rewrite ^&#x2F;auth(.*)$ &#x2F;api&#x2F;auth$1 last;</span><br><span class="line">    &#125;</span><br><span class="line">  orca-armory.yml: |</span><br><span class="line">    mine:</span><br><span class="line">      baseUrl: http:&#x2F;&#x2F;$&#123;services.barometer.host&#125;:$&#123;services.barometer.port&#125;</span><br><span class="line">    pipelineTemplate:</span><br><span class="line">      enabled: $&#123;features.pipelineTemplates.enabled:false&#125;</span><br><span class="line">      jinja:</span><br><span class="line">        enabled: true</span><br><span class="line">    kayenta:</span><br><span class="line">      enabled: $&#123;services.kayenta.enabled:false&#125;</span><br><span class="line">      baseUrl: $&#123;services.kayenta.baseUrl&#125;</span><br><span class="line">    jira:</span><br><span class="line">      enabled: $&#123;features.jira.enabled:false&#125;</span><br><span class="line">      basicAuth:  &quot;Basic $&#123;features.jira.basicAuthToken&#125;&quot;</span><br><span class="line">      url: $&#123;features.jira.createIssueUrl&#125;</span><br><span class="line">    webhook:</span><br><span class="line">      preconfigured:</span><br><span class="line">        - label: Enforce Pipeline Policy</span><br><span class="line">          description: Checks pipeline configuration against policy requirements</span><br><span class="line">          type: enforcePipelinePolicy</span><br><span class="line">          enabled: $&#123;features.certifiedPipelines.enabled:false&#125;</span><br><span class="line">          url: &quot;http:&#x2F;&#x2F;lighthouse:5000&#x2F;v1&#x2F;pipelines&#x2F;$&#123;execution.application&#125;&#x2F;$&#123;execution.pipelineConfigId&#125;?check_policy&#x3D;yes&quot;</span><br><span class="line">          headers:</span><br><span class="line">            Accept:</span><br><span class="line">              - application&#x2F;json</span><br><span class="line">          method: GET</span><br><span class="line">          waitForCompletion: true</span><br><span class="line">          statusUrlResolution: getMethod</span><br><span class="line">          statusJsonPath: $.status</span><br><span class="line">          successStatuses: pass</span><br><span class="line">          canceledStatuses:</span><br><span class="line">          terminalStatuses: TERMINAL</span><br><span class="line">        - label: &quot;Jira: Create Issue&quot;</span><br><span class="line">          description:  Enter a Jira ticket when this pipeline runs</span><br><span class="line">          type: createJiraIssue</span><br><span class="line">          enabled: $&#123;jira.enabled&#125;</span><br><span class="line">          url:  $&#123;jira.url&#125;</span><br><span class="line">          customHeaders:</span><br><span class="line">            &quot;Content-Type&quot;: application&#x2F;json</span><br><span class="line">            Authorization: $&#123;jira.basicAuth&#125;</span><br><span class="line">          method: POST</span><br><span class="line">          parameters:</span><br><span class="line">            - name: summary</span><br><span class="line">              label: Issue Summary</span><br><span class="line">              description: A short summary of your issue.</span><br><span class="line">            - name: description</span><br><span class="line">              label: Issue Description</span><br><span class="line">              description: A longer description of your issue.</span><br><span class="line">            - name: projectKey</span><br><span class="line">              label: Project key</span><br><span class="line">              description: The key of your JIRA project.</span><br><span class="line">            - name: type</span><br><span class="line">              label: Issue Type</span><br><span class="line">              description: The type of your issue, e.g. &quot;Task&quot;, &quot;Story&quot;, etc.</span><br><span class="line">          payload: |</span><br><span class="line">            &#123;</span><br><span class="line">              &quot;fields&quot; : &#123;</span><br><span class="line">                &quot;description&quot;: &quot;$&#123;parameterValues[&#39;description&#39;]&#125;&quot;,</span><br><span class="line">                &quot;issuetype&quot;: &#123;</span><br><span class="line">                   &quot;name&quot;: &quot;$&#123;parameterValues[&#39;type&#39;]&#125;&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;project&quot;: &#123;</span><br><span class="line">                   &quot;key&quot;: &quot;$&#123;parameterValues[&#39;projectKey&#39;]&#125;&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;summary&quot;:  &quot;$&#123;parameterValues[&#39;summary&#39;]&#125;&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          waitForCompletion: false</span><br><span class="line">        - label: &quot;Jira: Update Issue&quot;</span><br><span class="line">          description:  Update a previously created Jira Issue</span><br><span class="line">          type: updateJiraIssue</span><br><span class="line">          enabled: $&#123;jira.enabled&#125;</span><br><span class="line">          url: &quot;$&#123;execution.stages.?[type &#x3D;&#x3D; &#39;createJiraIssue&#39;][0][&#39;context&#39;][&#39;buildInfo&#39;][&#39;self&#39;]&#125;&quot;</span><br><span class="line">          customHeaders:</span><br><span class="line">            &quot;Content-Type&quot;: application&#x2F;json</span><br><span class="line">            Authorization: $&#123;jira.basicAuth&#125;</span><br><span class="line">          method: PUT</span><br><span class="line">          parameters:</span><br><span class="line">            - name: summary</span><br><span class="line">              label: Issue Summary</span><br><span class="line">              description: A short summary of your issue.</span><br><span class="line">            - name: description</span><br><span class="line">              label: Issue Description</span><br><span class="line">              description: A longer description of your issue.</span><br><span class="line">          payload: |</span><br><span class="line">            &#123;</span><br><span class="line">              &quot;fields&quot; : &#123;</span><br><span class="line">                &quot;description&quot;: &quot;$&#123;parameterValues[&#39;description&#39;]&#125;&quot;,</span><br><span class="line">                &quot;summary&quot;: &quot;$&#123;parameterValues[&#39;summary&#39;]&#125;&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          waitForCompletion: false</span><br><span class="line">        - label: &quot;Jira: Transition Issue&quot;</span><br><span class="line">          description:  Change state of existing Jira Issue</span><br><span class="line">          type: transitionJiraIssue</span><br><span class="line">          enabled: $&#123;jira.enabled&#125;</span><br><span class="line">          url: &quot;$&#123;execution.stages.?[type &#x3D;&#x3D; &#39;createJiraIssue&#39;][0][&#39;context&#39;][&#39;buildInfo&#39;][&#39;self&#39;]&#125;&#x2F;transitions&quot;</span><br><span class="line">          customHeaders:</span><br><span class="line">            &quot;Content-Type&quot;: application&#x2F;json</span><br><span class="line">            Authorization: $&#123;jira.basicAuth&#125;</span><br><span class="line">          method: POST</span><br><span class="line">          parameters:</span><br><span class="line">            - name: newStateID</span><br><span class="line">              label: New State ID</span><br><span class="line">              description: The ID of the state you want to transition the issue to.</span><br><span class="line">          payload: |</span><br><span class="line">            &#123;</span><br><span class="line">              &quot;transition&quot; : &#123;</span><br><span class="line">                &quot;id&quot; : &quot;$&#123;parameterValues[&#39;newStateID&#39;]&#125;&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          waitForCompletion: false</span><br><span class="line">        - label: &quot;Jira: Add Comment&quot;</span><br><span class="line">          description:  Add a comment to an existing Jira Issue</span><br><span class="line">          type: commentJiraIssue</span><br><span class="line">          enabled: $&#123;jira.enabled&#125;</span><br><span class="line">          url: &quot;$&#123;execution.stages.?[type &#x3D;&#x3D; &#39;createJiraIssue&#39;][0][&#39;context&#39;][&#39;buildInfo&#39;][&#39;self&#39;]&#125;&#x2F;comment&quot;</span><br><span class="line">          customHeaders:</span><br><span class="line">            &quot;Content-Type&quot;: application&#x2F;json</span><br><span class="line">            Authorization: $&#123;jira.basicAuth&#125;</span><br><span class="line">          method: POST</span><br><span class="line">          parameters:</span><br><span class="line">            - name: body</span><br><span class="line">              label: Comment body</span><br><span class="line">              description: The text body of the component.</span><br><span class="line">          payload: |</span><br><span class="line">            &#123;</span><br><span class="line">              &quot;body&quot; : &quot;$&#123;parameterValues[&#39;body&#39;]&#125;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          waitForCompletion: false</span><br><span class="line">  orca.yml: |</span><br><span class="line">    server:</span><br><span class="line">        port: $&#123;services.orca.port:8083&#125;</span><br><span class="line">        address: $&#123;services.orca.host:localhost&#125;</span><br><span class="line">    oort:</span><br><span class="line">        baseUrl: $&#123;services.oort.baseUrl:localhost:7002&#125;</span><br><span class="line">    front50:</span><br><span class="line">        baseUrl: $&#123;services.front50.baseUrl:localhost:8080&#125;</span><br><span class="line">    mort:</span><br><span class="line">        baseUrl: $&#123;services.mort.baseUrl:localhost:7002&#125;</span><br><span class="line">    kato:</span><br><span class="line">        baseUrl: $&#123;services.kato.baseUrl:localhost:7002&#125;</span><br><span class="line">    bakery:</span><br><span class="line">        baseUrl: $&#123;services.bakery.baseUrl:localhost:8087&#125;</span><br><span class="line">        extractBuildDetails: $&#123;services.bakery.extractBuildDetails:true&#125;</span><br><span class="line">        allowMissingPackageInstallation: $&#123;services.bakery.allowMissingPackageInstallation:true&#125;</span><br><span class="line">    echo:</span><br><span class="line">        enabled: $&#123;services.echo.enabled:false&#125;</span><br><span class="line">        baseUrl: $&#123;services.echo.baseUrl:8089&#125;</span><br><span class="line">    igor:</span><br><span class="line">        baseUrl: $&#123;services.igor.baseUrl:8088&#125;</span><br><span class="line">    flex:</span><br><span class="line">      baseUrl: http:&#x2F;&#x2F;not-a-host</span><br><span class="line">    default:</span><br><span class="line">      bake:</span><br><span class="line">        account: $&#123;providers.aws.primaryCredentials.name&#125;</span><br><span class="line">      securityGroups:</span><br><span class="line">      vpc:</span><br><span class="line">        securityGroups:</span><br><span class="line">    redis:</span><br><span class="line">      connection: $&#123;REDIS_HOST:redis:&#x2F;&#x2F;localhost:6379&#125;</span><br><span class="line">    tasks:</span><br><span class="line">      executionWindow:</span><br><span class="line">        timezone: $&#123;services.orca.timezone&#125;</span><br><span class="line">    spectator:</span><br><span class="line">      applicationName: $&#123;spring.application.name&#125;</span><br><span class="line">      webEndpoint:</span><br><span class="line">        enabled: $&#123;services.spectator.webEndpoint.enabled:false&#125;</span><br><span class="line">        prototypeFilter:</span><br><span class="line">          path: $&#123;services.spectator.webEndpoint.prototypeFilter.path:&#125;        </span><br><span class="line">      stackdriver:</span><br><span class="line">        enabled: $&#123;services.stackdriver.enabled&#125;</span><br><span class="line">        projectName: $&#123;services.stackdriver.projectName&#125;</span><br><span class="line">        credentialsPath: $&#123;services.stackdriver.credentialsPath&#125;</span><br><span class="line">    stackdriver:</span><br><span class="line">      hints:</span><br><span class="line">        - name: controller.invocations</span><br><span class="line">          labels:</span><br><span class="line">          - application</span><br><span class="line">  rosco-armory.yml: |</span><br><span class="line">    redis:</span><br><span class="line">      timeout: 50000</span><br><span class="line">    rosco:</span><br><span class="line">      jobs:</span><br><span class="line">        local:</span><br><span class="line">          timeoutMinutes: 60</span><br><span class="line">  rosco.yml: |</span><br><span class="line">    server:</span><br><span class="line">      port: $&#123;services.rosco.port:8087&#125;</span><br><span class="line">      address: $&#123;services.rosco.host:localhost&#125;</span><br><span class="line">    redis:</span><br><span class="line">      connection: $&#123;REDIS_HOST:redis:&#x2F;&#x2F;localhost:6379&#125;</span><br><span class="line">    aws:</span><br><span class="line">      enabled: $&#123;providers.aws.enabled:false&#125;</span><br><span class="line">    docker:</span><br><span class="line">      enabled: $&#123;services.docker.enabled:false&#125;</span><br><span class="line">      bakeryDefaults:</span><br><span class="line">        targetRepository: $&#123;services.docker.targetRepository&#125;</span><br><span class="line">    google:</span><br><span class="line">      enabled: $&#123;providers.google.enabled:false&#125;</span><br><span class="line">      accounts:</span><br><span class="line">        - name: $&#123;providers.google.primaryCredentials.name&#125;</span><br><span class="line">          project: $&#123;providers.google.primaryCredentials.project&#125;</span><br><span class="line">          jsonPath: $&#123;providers.google.primaryCredentials.jsonPath&#125;</span><br><span class="line">      gce:</span><br><span class="line">        bakeryDefaults:</span><br><span class="line">          zone: $&#123;providers.google.defaultZone&#125;</span><br><span class="line">    rosco:</span><br><span class="line">      configDir: $&#123;services.rosco.configDir&#125;</span><br><span class="line">      jobs:</span><br><span class="line">        local:</span><br><span class="line">          timeoutMinutes: 30</span><br><span class="line">    spectator:</span><br><span class="line">      applicationName: $&#123;spring.application.name&#125;</span><br><span class="line">      webEndpoint:</span><br><span class="line">        enabled: $&#123;services.spectator.webEndpoint.enabled:false&#125;</span><br><span class="line">        prototypeFilter:</span><br><span class="line">          path: $&#123;services.spectator.webEndpoint.prototypeFilter.path:&#125;</span><br><span class="line">      stackdriver:</span><br><span class="line">        enabled: $&#123;services.stackdriver.enabled&#125;</span><br><span class="line">        projectName: $&#123;services.stackdriver.projectName&#125;</span><br><span class="line">        credentialsPath: $&#123;services.stackdriver.credentialsPath&#125;</span><br><span class="line">    stackdriver:</span><br><span class="line">      hints:</span><br><span class="line">        - name: bakes</span><br><span class="line">          labels:</span><br><span class="line">          - success</span><br><span class="line">  spinnaker-armory.yml: |</span><br><span class="line">    armory:</span><br><span class="line">      architecture: &#39;k8s&#39;</span><br><span class="line">      </span><br><span class="line">    features:</span><br><span class="line">      artifacts:</span><br><span class="line">        enabled: true</span><br><span class="line">      pipelineTemplates:</span><br><span class="line">        enabled: $&#123;PIPELINE_TEMPLATES_ENABLED:false&#125;</span><br><span class="line">      infrastructureStages:</span><br><span class="line">        enabled: $&#123;INFRA_ENABLED:false&#125;</span><br><span class="line">      certifiedPipelines:</span><br><span class="line">        enabled: $&#123;CERTIFIED_PIPELINES_ENABLED:false&#125;</span><br><span class="line">      configuratorEnabled:</span><br><span class="line">        enabled: true</span><br><span class="line">      configuratorWizard:</span><br><span class="line">        enabled: true</span><br><span class="line">      configuratorCerts:</span><br><span class="line">        enabled: true</span><br><span class="line">      loadtestStage:</span><br><span class="line">        enabled: $&#123;LOADTEST_ENABLED:false&#125;</span><br><span class="line">      jira:</span><br><span class="line">        enabled: $&#123;JIRA_ENABLED:false&#125;</span><br><span class="line">        basicAuthToken: $&#123;JIRA_BASIC_AUTH&#125;</span><br><span class="line">        url: $&#123;JIRA_URL&#125;</span><br><span class="line">        login: $&#123;JIRA_LOGIN&#125;</span><br><span class="line">        password: $&#123;JIRA_PASSWORD&#125;</span><br><span class="line">      slaEnabled:</span><br><span class="line">        enabled: $&#123;SLA_ENABLED:false&#125;</span><br><span class="line">      chaosMonkey:</span><br><span class="line">        enabled: $&#123;CHAOS_ENABLED:false&#125;</span><br><span class="line">      armoryPlatform:</span><br><span class="line">        enabled: $&#123;PLATFORM_ENABLED:false&#125;</span><br><span class="line">        uiEnabled: $&#123;PLATFORM_UI_ENABLED:false&#125;</span><br><span class="line">    services:</span><br><span class="line">      default:</span><br><span class="line">        host: $&#123;DEFAULT_DNS_NAME:localhost&#125;</span><br><span class="line">      clouddriver:</span><br><span class="line">        host: $&#123;DEFAULT_DNS_NAME:armory-clouddriver&#125;</span><br><span class="line">        entityTags:</span><br><span class="line">          enabled: false</span><br><span class="line">      configurator:</span><br><span class="line">        baseUrl: http:&#x2F;&#x2F;$&#123;CONFIGURATOR_HOST:armory-configurator&#125;:8069</span><br><span class="line">      echo:</span><br><span class="line">        host: $&#123;DEFAULT_DNS_NAME:armory-echo&#125;</span><br><span class="line">      deck:</span><br><span class="line">        gateUrl: $&#123;API_HOST:service.default.host&#125;</span><br><span class="line">        baseUrl: $&#123;DECK_HOST:armory-deck&#125;</span><br><span class="line">      dinghy:</span><br><span class="line">        enabled: $&#123;DINGHY_ENABLED:false&#125;</span><br><span class="line">        host: $&#123;DEFAULT_DNS_NAME:armory-dinghy&#125;</span><br><span class="line">        baseUrl: $&#123;services.default.protocol&#125;:&#x2F;&#x2F;$&#123;services.dinghy.host&#125;:$&#123;services.dinghy.port&#125;</span><br><span class="line">        port: 8081</span><br><span class="line">      front50:</span><br><span class="line">        host: $&#123;DEFAULT_DNS_NAME:armory-front50&#125;</span><br><span class="line">        cassandra:</span><br><span class="line">          enabled: false</span><br><span class="line">        redis:</span><br><span class="line">          enabled: true</span><br><span class="line">        gcs:</span><br><span class="line">          enabled: $&#123;ARMORYSPINNAKER_GCS_ENABLED:false&#125;</span><br><span class="line">        s3:</span><br><span class="line">          enabled: $&#123;ARMORYSPINNAKER_S3_ENABLED:false&#125;</span><br><span class="line">        storage_bucket: $&#123;ARMORYSPINNAKER_CONF_STORE_BUCKET&#125;</span><br><span class="line">        rootFolder: $&#123;ARMORYSPINNAKER_CONF_STORE_PREFIX:front50&#125;</span><br><span class="line">      gate:</span><br><span class="line">        host: $&#123;DEFAULT_DNS_NAME:armory-gate&#125;</span><br><span class="line">      igor:</span><br><span class="line">        host: $&#123;DEFAULT_DNS_NAME:armory-igor&#125;</span><br><span class="line">      kayenta:</span><br><span class="line">        enabled: true</span><br><span class="line">        host: $&#123;DEFAULT_DNS_NAME:armory-kayenta&#125;</span><br><span class="line">        canaryConfigStore: true</span><br><span class="line">        port: 8090</span><br><span class="line">        baseUrl: $&#123;services.default.protocol&#125;:&#x2F;&#x2F;$&#123;services.kayenta.host&#125;:$&#123;services.kayenta.port&#125;</span><br><span class="line">        metricsStore: $&#123;METRICS_STORE:stackdriver&#125;</span><br><span class="line">        metricsAccountName: $&#123;METRICS_ACCOUNT_NAME&#125;</span><br><span class="line">        storageAccountName: $&#123;STORAGE_ACCOUNT_NAME&#125;</span><br><span class="line">        atlasWebComponentsUrl: $&#123;ATLAS_COMPONENTS_URL:&#125;</span><br><span class="line">        </span><br><span class="line">      lighthouse:</span><br><span class="line">        host: $&#123;DEFAULT_DNS_NAME:armory-lighthouse&#125;</span><br><span class="line">        port: 5000</span><br><span class="line">        baseUrl: $&#123;services.default.protocol&#125;:&#x2F;&#x2F;$&#123;services.lighthouse.host&#125;:$&#123;services.lighthouse.port&#125;</span><br><span class="line">      orca:</span><br><span class="line">        host: $&#123;DEFAULT_DNS_NAME:armory-orca&#125;</span><br><span class="line">      platform:</span><br><span class="line">        enabled: $&#123;PLATFORM_ENABLED:false&#125;</span><br><span class="line">        host: $&#123;DEFAULT_DNS_NAME:armory-platform&#125;</span><br><span class="line">        baseUrl: $&#123;services.default.protocol&#125;:&#x2F;&#x2F;$&#123;services.platform.host&#125;:$&#123;services.platform.port&#125;</span><br><span class="line">        port: 5001</span><br><span class="line">      rosco:</span><br><span class="line">        host: $&#123;DEFAULT_DNS_NAME:armory-rosco&#125;</span><br><span class="line">        enabled: true</span><br><span class="line">        configDir: &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;packer</span><br><span class="line">      bakery:</span><br><span class="line">        allowMissingPackageInstallation: true</span><br><span class="line">      barometer:</span><br><span class="line">        enabled: $&#123;BAROMETER_ENABLED:false&#125;</span><br><span class="line">        host: $&#123;DEFAULT_DNS_NAME:armory-barometer&#125;</span><br><span class="line">        baseUrl: $&#123;services.default.protocol&#125;:&#x2F;&#x2F;$&#123;services.barometer.host&#125;:$&#123;services.barometer.port&#125;</span><br><span class="line">        port: 9092</span><br><span class="line">        newRelicEnabled: $&#123;NEW_RELIC_ENABLED:false&#125;</span><br><span class="line">      redis:</span><br><span class="line">        host: redis</span><br><span class="line">        port: 6379</span><br><span class="line">        connection: $&#123;REDIS_HOST:redis:&#x2F;&#x2F;localhost:6379&#125;</span><br><span class="line">      fiat:</span><br><span class="line">        enabled: $&#123;FIAT_ENABLED:false&#125;</span><br><span class="line">        host: $&#123;DEFAULT_DNS_NAME:armory-fiat&#125;</span><br><span class="line">        port: 7003</span><br><span class="line">        baseUrl: $&#123;services.default.protocol&#125;:&#x2F;&#x2F;$&#123;services.fiat.host&#125;:$&#123;services.fiat.port&#125;</span><br><span class="line">    providers:</span><br><span class="line">      aws:</span><br><span class="line">        enabled: $&#123;SPINNAKER_AWS_ENABLED:true&#125;</span><br><span class="line">        defaultRegion: $&#123;SPINNAKER_AWS_DEFAULT_REGION:us-west-2&#125;</span><br><span class="line">        defaultIAMRole: $&#123;SPINNAKER_AWS_DEFAULT_IAM_ROLE:SpinnakerInstanceProfile&#125;</span><br><span class="line">        defaultAssumeRole: $&#123;SPINNAKER_AWS_DEFAULT_ASSUME_ROLE:SpinnakerManagedProfile&#125;</span><br><span class="line">        primaryCredentials:</span><br><span class="line">          name: $&#123;SPINNAKER_AWS_DEFAULT_ACCOUNT:default-aws-account&#125;</span><br><span class="line">      kubernetes:</span><br><span class="line">        proxy: localhost:8001</span><br><span class="line">        apiPrefix: api&#x2F;v1&#x2F;proxy&#x2F;namespaces&#x2F;kube-system&#x2F;services&#x2F;kubernetes-dashboard&#x2F;#</span><br><span class="line">  spinnaker.yml: |2</span><br><span class="line">    global:</span><br><span class="line">      spinnaker:</span><br><span class="line">        timezone: &#39;America&#x2F;Los_Angeles&#39;</span><br><span class="line">        architecture: $&#123;PLATFORM_ARCHITECTURE&#125;</span><br><span class="line">    services:</span><br><span class="line">      default:</span><br><span class="line">        host: localhost</span><br><span class="line">        protocol: http</span><br><span class="line">      clouddriver:</span><br><span class="line">        host: $&#123;services.default.host&#125;</span><br><span class="line">        port: 7002</span><br><span class="line">        baseUrl: $&#123;services.default.protocol&#125;:&#x2F;&#x2F;$&#123;services.clouddriver.host&#125;:$&#123;services.clouddriver.port&#125;</span><br><span class="line">        aws:</span><br><span class="line">          udf:</span><br><span class="line">            enabled: true</span><br><span class="line">      echo:</span><br><span class="line">        enabled: true</span><br><span class="line">        host: $&#123;services.default.host&#125;</span><br><span class="line">        port: 8089</span><br><span class="line">        baseUrl: $&#123;services.default.protocol&#125;:&#x2F;&#x2F;$&#123;services.echo.host&#125;:$&#123;services.echo.port&#125;</span><br><span class="line">        cassandra:</span><br><span class="line">          enabled: false</span><br><span class="line">        inMemory:</span><br><span class="line">          enabled: true</span><br><span class="line">        cron:</span><br><span class="line">          enabled: true</span><br><span class="line">          timezone: $&#123;global.spinnaker.timezone&#125;</span><br><span class="line">        notifications:</span><br><span class="line">          mail:</span><br><span class="line">            enabled: false</span><br><span class="line">            host: # the smtp host</span><br><span class="line">            fromAddress: # the address for which emails are sent from</span><br><span class="line">          hipchat:</span><br><span class="line">            enabled: false</span><br><span class="line">            url: # the hipchat server to connect to</span><br><span class="line">            token: # the hipchat auth token</span><br><span class="line">            botName: # the username of the bot</span><br><span class="line">          sms:</span><br><span class="line">            enabled: false</span><br><span class="line">            account: # twilio account id</span><br><span class="line">            token: # twilio auth token</span><br><span class="line">            from: # phone number by which sms messages are sent</span><br><span class="line">          slack:</span><br><span class="line">            enabled: false</span><br><span class="line">            token: # the API token for the bot</span><br><span class="line">            botName: # the username of the bot</span><br><span class="line">      deck:</span><br><span class="line">        host: $&#123;services.default.host&#125;</span><br><span class="line">        port: 9000</span><br><span class="line">        baseUrl: $&#123;services.default.protocol&#125;:&#x2F;&#x2F;$&#123;services.deck.host&#125;:$&#123;services.deck.port&#125;</span><br><span class="line">        gateUrl: $&#123;API_HOST:services.gate.baseUrl&#125;</span><br><span class="line">        bakeryUrl: $&#123;services.bakery.baseUrl&#125;</span><br><span class="line">        timezone: $&#123;global.spinnaker.timezone&#125;</span><br><span class="line">        auth:</span><br><span class="line">          enabled: $&#123;AUTH_ENABLED:false&#125;</span><br><span class="line">      fiat:</span><br><span class="line">        enabled: false</span><br><span class="line">        host: $&#123;services.default.host&#125;</span><br><span class="line">        port: 7003</span><br><span class="line">        baseUrl: $&#123;services.default.protocol&#125;:&#x2F;&#x2F;$&#123;services.fiat.host&#125;:$&#123;services.fiat.port&#125;</span><br><span class="line">      front50:</span><br><span class="line">        host: $&#123;services.default.host&#125;</span><br><span class="line">        port: 8080</span><br><span class="line">        baseUrl: $&#123;services.default.protocol&#125;:&#x2F;&#x2F;$&#123;services.front50.host&#125;:$&#123;services.front50.port&#125;</span><br><span class="line">        storage_bucket: $&#123;SPINNAKER_DEFAULT_STORAGE_BUCKET:&#125;</span><br><span class="line">        bucket_location:</span><br><span class="line">        bucket_root: front50</span><br><span class="line">        cassandra:</span><br><span class="line">          enabled: false</span><br><span class="line">        redis:</span><br><span class="line">          enabled: false</span><br><span class="line">        gcs:</span><br><span class="line">          enabled: false</span><br><span class="line">        s3:</span><br><span class="line">          enabled: false</span><br><span class="line">      gate:</span><br><span class="line">        host: $&#123;services.default.host&#125;</span><br><span class="line">        port: 8084</span><br><span class="line">        baseUrl: $&#123;services.default.protocol&#125;:&#x2F;&#x2F;$&#123;services.gate.host&#125;:$&#123;services.gate.port&#125;</span><br><span class="line">      igor:</span><br><span class="line">        enabled: false</span><br><span class="line">        host: $&#123;services.default.host&#125;</span><br><span class="line">        port: 8088</span><br><span class="line">        baseUrl: $&#123;services.default.protocol&#125;:&#x2F;&#x2F;$&#123;services.igor.host&#125;:$&#123;services.igor.port&#125;</span><br><span class="line">      kato:</span><br><span class="line">        host: $&#123;services.clouddriver.host&#125;</span><br><span class="line">        port: $&#123;services.clouddriver.port&#125;</span><br><span class="line">        baseUrl: $&#123;services.clouddriver.baseUrl&#125;</span><br><span class="line">      mort:</span><br><span class="line">        host: $&#123;services.clouddriver.host&#125;</span><br><span class="line">        port: $&#123;services.clouddriver.port&#125;</span><br><span class="line">        baseUrl: $&#123;services.clouddriver.baseUrl&#125;</span><br><span class="line">      orca:</span><br><span class="line">        host: $&#123;services.default.host&#125;</span><br><span class="line">        port: 8083</span><br><span class="line">        baseUrl: $&#123;services.default.protocol&#125;:&#x2F;&#x2F;$&#123;services.orca.host&#125;:$&#123;services.orca.port&#125;</span><br><span class="line">        timezone: $&#123;global.spinnaker.timezone&#125;</span><br><span class="line">        enabled: true</span><br><span class="line">      oort:</span><br><span class="line">        host: $&#123;services.clouddriver.host&#125;</span><br><span class="line">        port: $&#123;services.clouddriver.port&#125;</span><br><span class="line">        baseUrl: $&#123;services.clouddriver.baseUrl&#125;</span><br><span class="line">      rosco:</span><br><span class="line">        host: $&#123;services.default.host&#125;</span><br><span class="line">        port: 8087</span><br><span class="line">        baseUrl: $&#123;services.default.protocol&#125;:&#x2F;&#x2F;$&#123;services.rosco.host&#125;:$&#123;services.rosco.port&#125;</span><br><span class="line">        configDir: &#x2F;opt&#x2F;rosco&#x2F;config&#x2F;packer</span><br><span class="line">      bakery:</span><br><span class="line">        host: $&#123;services.rosco.host&#125;</span><br><span class="line">        port: $&#123;services.rosco.port&#125;</span><br><span class="line">        baseUrl: $&#123;services.rosco.baseUrl&#125;</span><br><span class="line">        extractBuildDetails: true</span><br><span class="line">        allowMissingPackageInstallation: false</span><br><span class="line">      docker:</span><br><span class="line">        targetRepository: # Optional, but expected in spinnaker-local.yml if specified.</span><br><span class="line">      jenkins:</span><br><span class="line">        enabled: $&#123;services.igor.enabled:false&#125;</span><br><span class="line">        defaultMaster:</span><br><span class="line">          name: Jenkins</span><br><span class="line">          baseUrl:   # Expected in spinnaker-local.yml</span><br><span class="line">          username:  # Expected in spinnaker-local.yml</span><br><span class="line">          password:  # Expected in spinnaker-local.yml</span><br><span class="line">      redis:</span><br><span class="line">        host: redis</span><br><span class="line">        port: 6379</span><br><span class="line">        connection: $&#123;REDIS_HOST:redis:&#x2F;&#x2F;localhost:6379&#125;</span><br><span class="line">      cassandra:</span><br><span class="line">        host: $&#123;services.default.host&#125;</span><br><span class="line">        port: 9042</span><br><span class="line">        embedded: false</span><br><span class="line">        cluster: CASS_SPINNAKER</span><br><span class="line">      travis:</span><br><span class="line">        enabled: false</span><br><span class="line">        defaultMaster:</span><br><span class="line">          name: ci # The display name for this server. Gets prefixed with &quot;travis-&quot;</span><br><span class="line">          baseUrl: https:&#x2F;&#x2F;travis-ci.com</span><br><span class="line">          address: https:&#x2F;&#x2F;api.travis-ci.org</span><br><span class="line">          githubToken: # GitHub scopes currently required by Travis is required.</span><br><span class="line">      spectator:</span><br><span class="line">        webEndpoint:</span><br><span class="line">          enabled: false</span><br><span class="line">      stackdriver:</span><br><span class="line">        enabled: $&#123;SPINNAKER_STACKDRIVER_ENABLED:false&#125;</span><br><span class="line">        projectName: $&#123;SPINNAKER_STACKDRIVER_PROJECT_NAME:$&#123;providers.google.primaryCredentials.project&#125;&#125;</span><br><span class="line">        credentialsPath: $&#123;SPINNAKER_STACKDRIVER_CREDENTIALS_PATH:$&#123;providers.google.primaryCredentials.jsonPath&#125;&#125;</span><br><span class="line">    providers:</span><br><span class="line">      aws:</span><br><span class="line">        enabled: $&#123;SPINNAKER_AWS_ENABLED:false&#125;</span><br><span class="line">        simpleDBEnabled: false</span><br><span class="line">        defaultRegion: $&#123;SPINNAKER_AWS_DEFAULT_REGION:us-west-2&#125;</span><br><span class="line">        defaultIAMRole: BaseIAMRole</span><br><span class="line">        defaultSimpleDBDomain: CLOUD_APPLICATIONS</span><br><span class="line">        primaryCredentials:</span><br><span class="line">          name: default</span><br><span class="line">        defaultKeyPairTemplate: &quot;&#123;&#123;name&#125;&#125;-keypair&quot;</span><br><span class="line">      google:</span><br><span class="line">        enabled: $&#123;SPINNAKER_GOOGLE_ENABLED:false&#125;</span><br><span class="line">        defaultRegion: $&#123;SPINNAKER_GOOGLE_DEFAULT_REGION:us-central1&#125;</span><br><span class="line">        defaultZone: $&#123;SPINNAKER_GOOGLE_DEFAULT_ZONE:us-central1-f&#125;</span><br><span class="line">        primaryCredentials:</span><br><span class="line">          name: my-account-name</span><br><span class="line">          project: $&#123;SPINNAKER_GOOGLE_PROJECT_ID:&#125;</span><br><span class="line">          jsonPath: $&#123;SPINNAKER_GOOGLE_PROJECT_CREDENTIALS_PATH:&#125;</span><br><span class="line">          consul:</span><br><span class="line">            enabled: $&#123;SPINNAKER_GOOGLE_CONSUL_ENABLED:false&#125;</span><br><span class="line">      cf:</span><br><span class="line">        enabled: false</span><br><span class="line">        defaultOrg: spinnaker-cf-org</span><br><span class="line">        defaultSpace: spinnaker-cf-space</span><br><span class="line">        primaryCredentials:</span><br><span class="line">          name: my-cf-account</span><br><span class="line">          api: my-cf-api-uri</span><br><span class="line">          console: my-cf-console-base-url</span><br><span class="line">      azure:</span><br><span class="line">        enabled: $&#123;SPINNAKER_AZURE_ENABLED:false&#125;</span><br><span class="line">        defaultRegion: $&#123;SPINNAKER_AZURE_DEFAULT_REGION:westus&#125;</span><br><span class="line">        primaryCredentials:</span><br><span class="line">          name: my-azure-account</span><br><span class="line">          clientId:</span><br><span class="line">          appKey:</span><br><span class="line">          tenantId:</span><br><span class="line">          subscriptionId:</span><br><span class="line">      titan:</span><br><span class="line">        enabled: false</span><br><span class="line">        defaultRegion: us-east-1</span><br><span class="line">        primaryCredentials:</span><br><span class="line">          name: my-titan-account</span><br><span class="line">      kubernetes:</span><br><span class="line">        enabled: $&#123;SPINNAKER_KUBERNETES_ENABLED:false&#125;</span><br><span class="line">        primaryCredentials:</span><br><span class="line">          name: my-kubernetes-account</span><br><span class="line">          namespace: default</span><br><span class="line">          dockerRegistryAccount: $&#123;providers.dockerRegistry.primaryCredentials.name&#125;</span><br><span class="line">      dockerRegistry:</span><br><span class="line">        enabled: $&#123;SPINNAKER_KUBERNETES_ENABLED:false&#125;</span><br><span class="line">        primaryCredentials:</span><br><span class="line">          name: my-docker-registry-account</span><br><span class="line">          address: $&#123;SPINNAKER_DOCKER_REGISTRY:https:&#x2F;&#x2F;index.docker.io&#x2F; &#125;</span><br><span class="line">          repository: $&#123;SPINNAKER_DOCKER_REPOSITORY:&#125;</span><br><span class="line">          username: $&#123;SPINNAKER_DOCKER_USERNAME:&#125;</span><br><span class="line">          passwordFile: $&#123;SPINNAKER_DOCKER_PASSWORD_FILE:&#125;</span><br><span class="line">          </span><br><span class="line">      openstack:</span><br><span class="line">        enabled: false</span><br><span class="line">        defaultRegion: $&#123;SPINNAKER_OPENSTACK_DEFAULT_REGION:RegionOne&#125;</span><br><span class="line">        primaryCredentials:</span><br><span class="line">          name: my-openstack-account</span><br><span class="line">          authUrl: $&#123;OS_AUTH_URL&#125;</span><br><span class="line">          username: $&#123;OS_USERNAME&#125;</span><br><span class="line">          password: $&#123;OS_PASSWORD&#125;</span><br><span class="line">          projectName: $&#123;OS_PROJECT_NAME&#125;</span><br><span class="line">          domainName: $&#123;OS_USER_DOMAIN_NAME:Default&#125;</span><br><span class="line">          regions: $&#123;OS_REGION_NAME:RegionOne&#125;</span><br><span class="line">          insecure: false</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="3-2-5-创建dp资源文件"><a href="#3-2-5-创建dp资源文件" class="headerlink" title="3.2.5 创建dp资源文件"></a>3.2.5 创建dp资源文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;dp.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: armory-clouddriver</span><br><span class="line">  name: armory-clouddriver</span><br><span class="line">  namespace: armory</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: armory-clouddriver</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      annotations:</span><br><span class="line">        artifact.spinnaker.io&#x2F;location: &#39;&quot;armory&quot;&#39;</span><br><span class="line">        artifact.spinnaker.io&#x2F;name: &#39;&quot;armory-clouddriver&quot;&#39;</span><br><span class="line">        artifact.spinnaker.io&#x2F;type: &#39;&quot;kubernetes&#x2F;deployment&quot;&#39;</span><br><span class="line">        moniker.spinnaker.io&#x2F;application: &#39;&quot;armory&quot;&#39;</span><br><span class="line">        moniker.spinnaker.io&#x2F;cluster: &#39;&quot;clouddriver&quot;&#39;</span><br><span class="line">      labels:</span><br><span class="line">        app: armory-clouddriver</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: armory-clouddriver</span><br><span class="line">        image: harbor.od.com&#x2F;armory&#x2F;clouddriver:v1.11.x</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        command:</span><br><span class="line">        - bash</span><br><span class="line">        - -c</span><br><span class="line">        args:</span><br><span class="line">        - bash &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;default&#x2F;fetch.sh &amp;&amp; cd &#x2F;home&#x2F;spinnaker&#x2F;config</span><br><span class="line">          &amp;&amp; &#x2F;opt&#x2F;clouddriver&#x2F;bin&#x2F;clouddriver</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 7002</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: JAVA_OPTS</span><br><span class="line">          value: -Xmx2048M</span><br><span class="line">        envFrom:</span><br><span class="line">        - configMapRef:</span><br><span class="line">            name: init-env</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;health</span><br><span class="line">            port: 7002</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 600</span><br><span class="line">          periodSeconds: 3</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;health</span><br><span class="line">            port: 7002</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 180</span><br><span class="line">          periodSeconds: 3</span><br><span class="line">          successThreshold: 5</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        securityContext:</span><br><span class="line">          runAsUser: 0</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: &#x2F;etc&#x2F;podinfo</span><br><span class="line">          name: podinfo</span><br><span class="line">        - mountPath: &#x2F;home&#x2F;spinnaker&#x2F;.aws</span><br><span class="line">          name: credentials</span><br><span class="line">        - mountPath: &#x2F;opt&#x2F;spinnaker&#x2F;credentials&#x2F;custom</span><br><span class="line">          name: default-kubeconfig</span><br><span class="line">        - mountPath: &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;default</span><br><span class="line">          name: default-config</span><br><span class="line">        - mountPath: &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;custom</span><br><span class="line">          name: custom-config</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      volumes:</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          name: default-kubeconfig</span><br><span class="line">        name: default-kubeconfig</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          name: custom-config</span><br><span class="line">        name: custom-config</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          name: default-config</span><br><span class="line">        name: default-config</span><br><span class="line">      - name: credentials</span><br><span class="line">        secret:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          secretName: credentials</span><br><span class="line">      - downwardAPI:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          items:</span><br><span class="line">          - fieldRef:</span><br><span class="line">              apiVersion: v1</span><br><span class="line">              fieldPath: metadata.labels</span><br><span class="line">            path: labels</span><br><span class="line">          - fieldRef:</span><br><span class="line">              apiVersion: v1</span><br><span class="line">              fieldPath: metadata.annotations</span><br><span class="line">            path: annotations</span><br><span class="line">        name: podinfo</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="3-2-6-床架svc资源文件"><a href="#3-2-6-床架svc资源文件" class="headerlink" title="3.2.6 床架svc资源文件"></a>3.2.6 床架svc资源文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;svc.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: armory-clouddriver</span><br><span class="line">  namespace: armory</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 7002</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 7002</span><br><span class="line">  selector:</span><br><span class="line">    app: armory-clouddriver</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="3-2-7-应用资源清单"><a href="#3-2-7-应用资源清单" class="headerlink" title="3.2.7 应用资源清单"></a>3.2.7 应用资源清单</h4><p>任意node节点执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;clouddriver&#x2F;init-env.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;clouddriver&#x2F;default-config.yaml </span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;clouddriver&#x2F;custom-config.yaml </span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;clouddriver&#x2F;dp.yaml </span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;clouddriver&#x2F;svc.yaml</span><br></pre></td></tr></table></figure><h4 id="3-2-8-检查"><a href="#3-2-8-检查" class="headerlink" title="3.2.8 检查"></a>3.2.8 检查</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">~]# docker ps -a|grep minio</span><br><span class="line">~]# docker exec -it b71a5af3c57e sh</span><br><span class="line">&#x2F; # curl armory-clouddriver:7002&#x2F;health</span><br><span class="line">&#123;</span><br><span class="line">    &quot;status&quot;: &quot;UP&quot;,</span><br><span class="line">    &quot;kubernetes&quot;: &#123;</span><br><span class="line">        &quot;status&quot;: &quot;UP&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;dockerRegistry&quot;: &#123;</span><br><span class="line">        &quot;status&quot;: &quot;UP&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;redisHealth&quot;: &#123;</span><br><span class="line">        &quot;status&quot;: &quot;UP&quot;,</span><br><span class="line">        &quot;maxIdle&quot;: 100,</span><br><span class="line">        &quot;minIdle&quot;: 25,</span><br><span class="line">        &quot;numActive&quot;: 0,</span><br><span class="line">        &quot;numIdle&quot;: 5,</span><br><span class="line">        &quot;numWaiters&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;diskSpace&quot;: &#123;</span><br><span class="line">        &quot;status&quot;: &quot;UP&quot;,</span><br><span class="line">        &quot;total&quot;: 21250441216,</span><br><span class="line">        &quot;free&quot;: 15657390080,</span><br><span class="line">        &quot;threshold&quot;: 10485760</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-部署spinnaker第三部分"><a href="#4-部署spinnaker第三部分" class="headerlink" title="4 部署spinnaker第三部分"></a>4 部署spinnaker第三部分</h2><h3 id="4-1-spinnaker之front50部署"><a href="#4-1-spinnaker之front50部署" class="headerlink" title="4.1 spinnaker之front50部署"></a>4.1 spinnaker之front50部署</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;data&#x2F;k8s-yaml&#x2F;armory&#x2F;front50</span><br><span class="line">cd &#x2F;data&#x2F;k8s-yaml&#x2F;armory&#x2F;front50</span><br></pre></td></tr></table></figure><h4 id="4-1-1-准备镜像"><a href="#4-1-1-准备镜像" class="headerlink" title="4.1.1 准备镜像"></a>4.1.1 准备镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull armory&#x2F;spinnaker-front50-slim:release-1.8.x-93febf2</span><br><span class="line">docker tag  0d353788f4f2 harbor.zq.com&#x2F;armory&#x2F;front50:v1.8.x</span><br><span class="line">docker push harbor.zq.com&#x2F;armory&#x2F;front50:v1.8.x</span><br></pre></td></tr></table></figure><h4 id="4-1-2-准备dp资源清单"><a href="#4-1-2-准备dp资源清单" class="headerlink" title="4.1.2 准备dp资源清单"></a>4.1.2 准备dp资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;dp.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: armory-front50</span><br><span class="line">  name: armory-front50</span><br><span class="line">  namespace: armory</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: armory-front50</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      annotations:</span><br><span class="line">        artifact.spinnaker.io&#x2F;location: &#39;&quot;armory&quot;&#39;</span><br><span class="line">        artifact.spinnaker.io&#x2F;name: &#39;&quot;armory-front50&quot;&#39;</span><br><span class="line">        artifact.spinnaker.io&#x2F;type: &#39;&quot;kubernetes&#x2F;deployment&quot;&#39;</span><br><span class="line">        moniker.spinnaker.io&#x2F;application: &#39;&quot;armory&quot;&#39;</span><br><span class="line">        moniker.spinnaker.io&#x2F;cluster: &#39;&quot;front50&quot;&#39;</span><br><span class="line">      labels:</span><br><span class="line">        app: armory-front50</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: armory-front50</span><br><span class="line">        image: harbor.od.com&#x2F;armory&#x2F;front50:v1.8.x</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        command:</span><br><span class="line">        - bash</span><br><span class="line">        - -c</span><br><span class="line">        args:</span><br><span class="line">        - bash &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;default&#x2F;fetch.sh &amp;&amp; cd &#x2F;home&#x2F;spinnaker&#x2F;config</span><br><span class="line">          &amp;&amp; &#x2F;opt&#x2F;front50&#x2F;bin&#x2F;front50</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: JAVA_OPTS</span><br><span class="line">          value: -javaagent:&#x2F;opt&#x2F;front50&#x2F;lib&#x2F;jamm-0.2.5.jar -Xmx1000M</span><br><span class="line">        envFrom:</span><br><span class="line">        - configMapRef:</span><br><span class="line">            name: init-env</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;health</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 600</span><br><span class="line">          periodSeconds: 3</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;health</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 180</span><br><span class="line">          periodSeconds: 5</span><br><span class="line">          successThreshold: 8</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: &#x2F;etc&#x2F;podinfo</span><br><span class="line">          name: podinfo</span><br><span class="line">        - mountPath: &#x2F;home&#x2F;spinnaker&#x2F;.aws</span><br><span class="line">          name: credentials</span><br><span class="line">        - mountPath: &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;default</span><br><span class="line">          name: default-config</span><br><span class="line">        - mountPath: &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;custom</span><br><span class="line">          name: custom-config</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      volumes:</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          name: custom-config</span><br><span class="line">        name: custom-config</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          name: default-config</span><br><span class="line">        name: default-config</span><br><span class="line">      - name: credentials</span><br><span class="line">        secret:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          secretName: credentials</span><br><span class="line">      - downwardAPI:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          items:</span><br><span class="line">          - fieldRef:</span><br><span class="line">              apiVersion: v1</span><br><span class="line">              fieldPath: metadata.labels</span><br><span class="line">            path: labels</span><br><span class="line">          - fieldRef:</span><br><span class="line">              apiVersion: v1</span><br><span class="line">              fieldPath: metadata.annotations</span><br><span class="line">            path: annotations</span><br><span class="line">        name: podinfo</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-1-3-创建svc资源清单"><a href="#4-1-3-创建svc资源清单" class="headerlink" title="4.1.3 创建svc资源清单"></a>4.1.3 创建svc资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;svc.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: armory-front50</span><br><span class="line">  namespace: armory</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8080</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector:</span><br><span class="line">    app: armory-front50</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-1-4-应用资源清单"><a href="#4-1-4-应用资源清单" class="headerlink" title="4.1.4 应用资源清单"></a>4.1.4 应用资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;front50&#x2F;dp.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;front50&#x2F;svc.yaml</span><br></pre></td></tr></table></figure><p>验证</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~]# docker ps -qa|grep minio</span><br><span class="line">b71a5af3c57e</span><br><span class="line">~]# docker exec -it b71a5af3c57e sh</span><br><span class="line">&#x2F; # curl armory-front50:8080&#x2F;health</span><br><span class="line">&#123;&quot;status&quot;:&quot;UP&quot;&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-spinnaker之orca部署"><a href="#4-2-spinnaker之orca部署" class="headerlink" title="4.2 spinnaker之orca部署"></a>4.2 spinnaker之orca部署</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;data&#x2F;k8s-yaml&#x2F;armory&#x2F;orca</span><br><span class="line">cd &#x2F;data&#x2F;k8s-yaml&#x2F;armory&#x2F;orca</span><br></pre></td></tr></table></figure><h4 id="4-2-1-准备docker镜像"><a href="#4-2-1-准备docker镜像" class="headerlink" title="4.2.1 准备docker镜像"></a>4.2.1 准备docker镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker.io&#x2F;armory&#x2F;spinnaker-orca-slim:release-1.8.x-de4ab55</span><br><span class="line">docker tag  5103b1f73e04 harbor.zq.com&#x2F;armory&#x2F;orca:v1.8.x</span><br><span class="line">docker push harbor.zq.com&#x2F;armory&#x2F;orca:v1.8.x</span><br></pre></td></tr></table></figure><h4 id="4-2-2-准备dp资源清单"><a href="#4-2-2-准备dp资源清单" class="headerlink" title="4.2.2 准备dp资源清单"></a>4.2.2 准备dp资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;dp.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: armory-orca</span><br><span class="line">  name: armory-orca</span><br><span class="line">  namespace: armory</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: armory-orca</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      annotations:</span><br><span class="line">        artifact.spinnaker.io&#x2F;location: &#39;&quot;armory&quot;&#39;</span><br><span class="line">        artifact.spinnaker.io&#x2F;name: &#39;&quot;armory-orca&quot;&#39;</span><br><span class="line">        artifact.spinnaker.io&#x2F;type: &#39;&quot;kubernetes&#x2F;deployment&quot;&#39;</span><br><span class="line">        moniker.spinnaker.io&#x2F;application: &#39;&quot;armory&quot;&#39;</span><br><span class="line">        moniker.spinnaker.io&#x2F;cluster: &#39;&quot;orca&quot;&#39;</span><br><span class="line">      labels:</span><br><span class="line">        app: armory-orca</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: armory-orca</span><br><span class="line">        image: harbor.od.com&#x2F;armory&#x2F;orca:v1.8.x</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        command:</span><br><span class="line">        - bash</span><br><span class="line">        - -c</span><br><span class="line">        args:</span><br><span class="line">        - bash &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;default&#x2F;fetch.sh &amp;&amp; cd &#x2F;home&#x2F;spinnaker&#x2F;config</span><br><span class="line">          &amp;&amp; &#x2F;opt&#x2F;orca&#x2F;bin&#x2F;orca</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8083</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: JAVA_OPTS</span><br><span class="line">          value: -Xmx1000M</span><br><span class="line">        envFrom:</span><br><span class="line">        - configMapRef:</span><br><span class="line">            name: init-env</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;health</span><br><span class="line">            port: 8083</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 600</span><br><span class="line">          periodSeconds: 5</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;health</span><br><span class="line">            port: 8083</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 180</span><br><span class="line">          periodSeconds: 3</span><br><span class="line">          successThreshold: 5</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: &#x2F;etc&#x2F;podinfo</span><br><span class="line">          name: podinfo</span><br><span class="line">        - mountPath: &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;default</span><br><span class="line">          name: default-config</span><br><span class="line">        - mountPath: &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;custom</span><br><span class="line">          name: custom-config</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      volumes:</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          name: custom-config</span><br><span class="line">        name: custom-config</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          name: default-config</span><br><span class="line">        name: default-config</span><br><span class="line">      - downwardAPI:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          items:</span><br><span class="line">          - fieldRef:</span><br><span class="line">              apiVersion: v1</span><br><span class="line">              fieldPath: metadata.labels</span><br><span class="line">            path: labels</span><br><span class="line">          - fieldRef:</span><br><span class="line">              apiVersion: v1</span><br><span class="line">              fieldPath: metadata.annotations</span><br><span class="line">            path: annotations</span><br><span class="line">        name: podinfo</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-2-3-准备svc资源清单"><a href="#4-2-3-准备svc资源清单" class="headerlink" title="4.2.3 准备svc资源清单"></a>4.2.3 准备svc资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;svc.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: armory-orca</span><br><span class="line">  namespace: armory</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8083</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 8083</span><br><span class="line">  selector:</span><br><span class="line">    app: armory-orca</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-2-4-应用资源配置清单"><a href="#4-2-4-应用资源配置清单" class="headerlink" title="4.2.4 应用资源配置清单"></a>4.2.4 应用资源配置清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;orca&#x2F;dp.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;orca&#x2F;svc.yaml</span><br></pre></td></tr></table></figure><p>检查</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~]# docker exec -it b71a5af3c57e sh</span><br><span class="line">&#x2F; # curl armory-orca:8083&#x2F;health</span><br><span class="line">&#123;&quot;status&quot;:&quot;UP&quot;&#125;</span><br></pre></td></tr></table></figure><h3 id="4-3-spinnaker之echo部署"><a href="#4-3-spinnaker之echo部署" class="headerlink" title="4.3 spinnaker之echo部署"></a>4.3 spinnaker之echo部署</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;data&#x2F;k8s-yaml&#x2F;armory&#x2F;echo</span><br><span class="line">cd &#x2F;data&#x2F;k8s-yaml&#x2F;armory&#x2F;echo</span><br></pre></td></tr></table></figure><h4 id="4-3-1-准备docker镜像"><a href="#4-3-1-准备docker镜像" class="headerlink" title="4.3.1 准备docker镜像"></a>4.3.1 准备docker镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker.io&#x2F;armory&#x2F;echo-armory:c36d576-release-1.8.x-617c567</span><br><span class="line">docker tag  415efd46f474 harbor.od.com&#x2F;armory&#x2F;echo:v1.8.x</span><br><span class="line">docker push harbor.od.com&#x2F;armory&#x2F;echo:v1.8.x</span><br></pre></td></tr></table></figure><h4 id="4-3-2-准备dp资源清单"><a href="#4-3-2-准备dp资源清单" class="headerlink" title="4.3.2 准备dp资源清单"></a>4.3.2 准备dp资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;dp.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: armory-echo</span><br><span class="line">  name: armory-echo</span><br><span class="line">  namespace: armory</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: armory-echo</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      annotations:</span><br><span class="line">        artifact.spinnaker.io&#x2F;location: &#39;&quot;armory&quot;&#39;</span><br><span class="line">        artifact.spinnaker.io&#x2F;name: &#39;&quot;armory-echo&quot;&#39;</span><br><span class="line">        artifact.spinnaker.io&#x2F;type: &#39;&quot;kubernetes&#x2F;deployment&quot;&#39;</span><br><span class="line">        moniker.spinnaker.io&#x2F;application: &#39;&quot;armory&quot;&#39;</span><br><span class="line">        moniker.spinnaker.io&#x2F;cluster: &#39;&quot;echo&quot;&#39;</span><br><span class="line">      labels:</span><br><span class="line">        app: armory-echo</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: armory-echo</span><br><span class="line">        image: harbor.od.com&#x2F;armory&#x2F;echo:v1.8.x</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        command:</span><br><span class="line">        - bash</span><br><span class="line">        - -c</span><br><span class="line">        args:</span><br><span class="line">        - bash &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;default&#x2F;fetch.sh &amp;&amp; cd &#x2F;home&#x2F;spinnaker&#x2F;config</span><br><span class="line">          &amp;&amp; &#x2F;opt&#x2F;echo&#x2F;bin&#x2F;echo</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8089</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: JAVA_OPTS</span><br><span class="line">          value: -javaagent:&#x2F;opt&#x2F;echo&#x2F;lib&#x2F;jamm-0.2.5.jar -Xmx1000M</span><br><span class="line">        envFrom:</span><br><span class="line">        - configMapRef:</span><br><span class="line">            name: init-env</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;health</span><br><span class="line">            port: 8089</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 600</span><br><span class="line">          periodSeconds: 3</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;health</span><br><span class="line">            port: 8089</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 180</span><br><span class="line">          periodSeconds: 3</span><br><span class="line">          successThreshold: 5</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: &#x2F;etc&#x2F;podinfo</span><br><span class="line">          name: podinfo</span><br><span class="line">        - mountPath: &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;default</span><br><span class="line">          name: default-config</span><br><span class="line">        - mountPath: &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;custom</span><br><span class="line">          name: custom-config</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      volumes:</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          name: custom-config</span><br><span class="line">        name: custom-config</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          name: default-config</span><br><span class="line">        name: default-config</span><br><span class="line">      - downwardAPI:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          items:</span><br><span class="line">          - fieldRef:</span><br><span class="line">              apiVersion: v1</span><br><span class="line">              fieldPath: metadata.labels</span><br><span class="line">            path: labels</span><br><span class="line">          - fieldRef:</span><br><span class="line">              apiVersion: v1</span><br><span class="line">              fieldPath: metadata.annotations</span><br><span class="line">            path: annotations</span><br><span class="line">        name: podinfo</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-3-3-准备svc资源清单"><a href="#4-3-3-准备svc资源清单" class="headerlink" title="4.3.3 准备svc资源清单"></a>4.3.3 准备svc资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;svc.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: armory-echo</span><br><span class="line">  namespace: armory</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8089</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 8089</span><br><span class="line">  selector:</span><br><span class="line">    app: armory-echo</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-3-4-应用资源配置清单"><a href="#4-3-4-应用资源配置清单" class="headerlink" title="4.3.4 应用资源配置清单"></a>4.3.4 应用资源配置清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;echo&#x2F;dp.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;echo&#x2F;svc.yaml</span><br></pre></td></tr></table></figure><p>检查</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~]# docker exec -it b71a5af3c57e sh</span><br><span class="line">&#x2F; # curl armory-echo:8089&#x2F;health</span><br><span class="line">&#123;&quot;status&quot;:&quot;UP&quot;&#125;</span><br></pre></td></tr></table></figure><h3 id="4-4-spinnaker之igor部署"><a href="#4-4-spinnaker之igor部署" class="headerlink" title="4.4 spinnaker之igor部署"></a>4.4 spinnaker之igor部署</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;data&#x2F;k8s-yaml&#x2F;armory&#x2F;igor</span><br><span class="line">cd &#x2F;data&#x2F;k8s-yaml&#x2F;armory&#x2F;igor</span><br></pre></td></tr></table></figure><h4 id="4-4-1-准备docker镜像"><a href="#4-4-1-准备docker镜像" class="headerlink" title="4.4.1 准备docker镜像"></a>4.4.1 准备docker镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker.io&#x2F;armory&#x2F;spinnaker-igor-slim:release-1.8-x-new-install-healthy-ae2b329</span><br><span class="line">docker tag  23984f5b43f6 harbor.zq.com&#x2F;armory&#x2F;igor:v1.8.x</span><br><span class="line">docker push harbor.zq.com&#x2F;armory&#x2F;igor:v1.8.x</span><br></pre></td></tr></table></figure><h4 id="4-4-2-准备dp资源清单"><a href="#4-4-2-准备dp资源清单" class="headerlink" title="4.4.2 准备dp资源清单"></a>4.4.2 准备dp资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;dp.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: armory-igor</span><br><span class="line">  name: armory-igor</span><br><span class="line">  namespace: armory</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: armory-igor</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      annotations:</span><br><span class="line">        artifact.spinnaker.io&#x2F;location: &#39;&quot;armory&quot;&#39;</span><br><span class="line">        artifact.spinnaker.io&#x2F;name: &#39;&quot;armory-igor&quot;&#39;</span><br><span class="line">        artifact.spinnaker.io&#x2F;type: &#39;&quot;kubernetes&#x2F;deployment&quot;&#39;</span><br><span class="line">        moniker.spinnaker.io&#x2F;application: &#39;&quot;armory&quot;&#39;</span><br><span class="line">        moniker.spinnaker.io&#x2F;cluster: &#39;&quot;igor&quot;&#39;</span><br><span class="line">      labels:</span><br><span class="line">        app: armory-igor</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: armory-igor</span><br><span class="line">        image: harbor.od.com&#x2F;armory&#x2F;igor:v1.8.x</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        command:</span><br><span class="line">        - bash</span><br><span class="line">        - -c</span><br><span class="line">        args:</span><br><span class="line">        - bash &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;default&#x2F;fetch.sh &amp;&amp; cd &#x2F;home&#x2F;spinnaker&#x2F;config</span><br><span class="line">          &amp;&amp; &#x2F;opt&#x2F;igor&#x2F;bin&#x2F;igor</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8088</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: IGOR_PORT_MAPPING</span><br><span class="line">          value: -8088:8088</span><br><span class="line">        - name: JAVA_OPTS</span><br><span class="line">          value: -Xmx1000M</span><br><span class="line">        envFrom:</span><br><span class="line">        - configMapRef:</span><br><span class="line">            name: init-env</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;health</span><br><span class="line">            port: 8088</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 600</span><br><span class="line">          periodSeconds: 3</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;health</span><br><span class="line">            port: 8088</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 180</span><br><span class="line">          periodSeconds: 5</span><br><span class="line">          successThreshold: 5</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: &#x2F;etc&#x2F;podinfo</span><br><span class="line">          name: podinfo</span><br><span class="line">        - mountPath: &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;default</span><br><span class="line">          name: default-config</span><br><span class="line">        - mountPath: &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;custom</span><br><span class="line">          name: custom-config</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      securityContext:</span><br><span class="line">        runAsUser: 0</span><br><span class="line">      volumes:</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          name: custom-config</span><br><span class="line">        name: custom-config</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          name: default-config</span><br><span class="line">        name: default-config</span><br><span class="line">      - downwardAPI:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          items:</span><br><span class="line">          - fieldRef:</span><br><span class="line">              apiVersion: v1</span><br><span class="line">              fieldPath: metadata.labels</span><br><span class="line">            path: labels</span><br><span class="line">          - fieldRef:</span><br><span class="line">              apiVersion: v1</span><br><span class="line">              fieldPath: metadata.annotations</span><br><span class="line">            path: annotations</span><br><span class="line">        name: podinfo</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-4-3-准备svc资源清单"><a href="#4-4-3-准备svc资源清单" class="headerlink" title="4.4.3 准备svc资源清单"></a>4.4.3 准备svc资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;svc.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: armory-igor</span><br><span class="line">  namespace: armory</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8088</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 8088</span><br><span class="line">  selector:</span><br><span class="line">    app: armory-igor</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-4-4-应用资源配置清单"><a href="#4-4-4-应用资源配置清单" class="headerlink" title="4.4.4 应用资源配置清单"></a>4.4.4 应用资源配置清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;igor&#x2F;dp.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;igor&#x2F;svc.yaml</span><br></pre></td></tr></table></figure><p>检查</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~]# docker exec -it b71a5af3c57e sh</span><br><span class="line">&#x2F; # curl armory-igor:8088&#x2F;health</span><br><span class="line">&#123;&quot;status&quot;:&quot;UP&quot;&#125;</span><br></pre></td></tr></table></figure><h3 id="4-5-spinnaker之gate部署"><a href="#4-5-spinnaker之gate部署" class="headerlink" title="4.5 spinnaker之gate部署"></a>4.5 spinnaker之gate部署</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;data&#x2F;k8s-yaml&#x2F;armory&#x2F;gate</span><br><span class="line">cd &#x2F;data&#x2F;k8s-yaml&#x2F;armory&#x2F;gate</span><br></pre></td></tr></table></figure><h4 id="4-5-1-准备docker镜像"><a href="#4-5-1-准备docker镜像" class="headerlink" title="4.5.1 准备docker镜像"></a>4.5.1 准备docker镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker.io&#x2F;armory&#x2F;gate-armory:dfafe73-release-1.8.x-5d505ca</span><br><span class="line">docker tag  b092d4665301 harbor.zq.com&#x2F;armory&#x2F;gate:v1.8.x</span><br><span class="line">docker push harbor.zq.com&#x2F;armory&#x2F;gate:v1.8.x</span><br></pre></td></tr></table></figure><h4 id="4-5-2-准备dp资源清单"><a href="#4-5-2-准备dp资源清单" class="headerlink" title="4.5.2 准备dp资源清单"></a>4.5.2 准备dp资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;dp.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: armory-gate</span><br><span class="line">  name: armory-gate</span><br><span class="line">  namespace: armory</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: armory-gate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      annotations:</span><br><span class="line">        artifact.spinnaker.io&#x2F;location: &#39;&quot;armory&quot;&#39;</span><br><span class="line">        artifact.spinnaker.io&#x2F;name: &#39;&quot;armory-gate&quot;&#39;</span><br><span class="line">        artifact.spinnaker.io&#x2F;type: &#39;&quot;kubernetes&#x2F;deployment&quot;&#39;</span><br><span class="line">        moniker.spinnaker.io&#x2F;application: &#39;&quot;armory&quot;&#39;</span><br><span class="line">        moniker.spinnaker.io&#x2F;cluster: &#39;&quot;gate&quot;&#39;</span><br><span class="line">      labels:</span><br><span class="line">        app: armory-gate</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: armory-gate</span><br><span class="line">        image: harbor.od.com&#x2F;armory&#x2F;gate:v1.8.x</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        command:</span><br><span class="line">        - bash</span><br><span class="line">        - -c</span><br><span class="line">        args:</span><br><span class="line">        - bash &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;default&#x2F;fetch.sh gate &amp;&amp; cd &#x2F;home&#x2F;spinnaker&#x2F;config</span><br><span class="line">          &amp;&amp; &#x2F;opt&#x2F;gate&#x2F;bin&#x2F;gate</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8084</span><br><span class="line">          name: gate-port</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 8085</span><br><span class="line">          name: gate-api-port</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: GATE_PORT_MAPPING</span><br><span class="line">          value: -8084:8084</span><br><span class="line">        - name: GATE_API_PORT_MAPPING</span><br><span class="line">          value: -8085:8085</span><br><span class="line">        - name: JAVA_OPTS</span><br><span class="line">          value: -Xmx1000M</span><br><span class="line">        envFrom:</span><br><span class="line">        - configMapRef:</span><br><span class="line">            name: init-env</span><br><span class="line">        livenessProbe:</span><br><span class="line">          exec:</span><br><span class="line">            command:</span><br><span class="line">            - &#x2F;bin&#x2F;bash</span><br><span class="line">            - -c</span><br><span class="line">            - wget -O - http:&#x2F;&#x2F;localhost:8084&#x2F;health || wget -O - https:&#x2F;&#x2F;localhost:8084&#x2F;health</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">          initialDelaySeconds: 600</span><br><span class="line">          periodSeconds: 5</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        readinessProbe:</span><br><span class="line">          exec:</span><br><span class="line">            command:</span><br><span class="line">            - &#x2F;bin&#x2F;bash</span><br><span class="line">            - -c</span><br><span class="line">            - wget -O - http:&#x2F;&#x2F;localhost:8084&#x2F;health?checkDownstreamServices&#x3D;true&amp;downstreamServices&#x3D;true</span><br><span class="line">              || wget -O - https:&#x2F;&#x2F;localhost:8084&#x2F;health?checkDownstreamServices&#x3D;true&amp;downstreamServices&#x3D;true</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          initialDelaySeconds: 180</span><br><span class="line">          periodSeconds: 5</span><br><span class="line">          successThreshold: 10</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: &#x2F;etc&#x2F;podinfo</span><br><span class="line">          name: podinfo</span><br><span class="line">        - mountPath: &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;default</span><br><span class="line">          name: default-config</span><br><span class="line">        - mountPath: &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;custom</span><br><span class="line">          name: custom-config</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      securityContext:</span><br><span class="line">        runAsUser: 0</span><br><span class="line">      volumes:</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          name: custom-config</span><br><span class="line">        name: custom-config</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          name: default-config</span><br><span class="line">        name: default-config</span><br><span class="line">      - downwardAPI:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          items:</span><br><span class="line">          - fieldRef:</span><br><span class="line">              apiVersion: v1</span><br><span class="line">              fieldPath: metadata.labels</span><br><span class="line">            path: labels</span><br><span class="line">          - fieldRef:</span><br><span class="line">              apiVersion: v1</span><br><span class="line">              fieldPath: metadata.annotations</span><br><span class="line">            path: annotations</span><br><span class="line">        name: podinfo</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-5-3-准备svc资源清单"><a href="#4-5-3-准备svc资源清单" class="headerlink" title="4.5.3 准备svc资源清单"></a>4.5.3 准备svc资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;svc.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: armory-gate</span><br><span class="line">  namespace: armory</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: gate-port</span><br><span class="line">    port: 8084</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 8084</span><br><span class="line">  - name: gate-api-port</span><br><span class="line">    port: 8085</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 8085</span><br><span class="line">  selector:</span><br><span class="line">    app: armory-gate</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-5-4-应用资源配置清单"><a href="#4-5-4-应用资源配置清单" class="headerlink" title="4.5.4 应用资源配置清单"></a>4.5.4 应用资源配置清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;gate&#x2F;dp.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;gate&#x2F;svc.yaml</span><br></pre></td></tr></table></figure><p>检查</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bin]# docker exec -it b71a5af3c57e sh</span><br><span class="line">&#x2F; # curl armory-gate:8084&#x2F;health</span><br><span class="line">&#123;&quot;status&quot;:&quot;UP&quot;&#125;</span><br></pre></td></tr></table></figure><h3 id="4-6-spinnaker之deck部署"><a href="#4-6-spinnaker之deck部署" class="headerlink" title="4.6 spinnaker之deck部署"></a>4.6 spinnaker之deck部署</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;data&#x2F;k8s-yaml&#x2F;armory&#x2F;deck</span><br><span class="line">cd &#x2F;data&#x2F;k8s-yaml&#x2F;armory&#x2F;deck</span><br></pre></td></tr></table></figure><h4 id="4-6-1-准备docker镜像"><a href="#4-6-1-准备docker镜像" class="headerlink" title="4.6.1 准备docker镜像"></a>4.6.1 准备docker镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker.io&#x2F;armory&#x2F;deck-armory:d4bf0cf-release-1.8.x-0a33f94</span><br><span class="line">docker tag  9a87ba3b319f harbor.od.com&#x2F;armory&#x2F;deck:v1.8.x</span><br><span class="line">docker push harbor.od.com&#x2F;armory&#x2F;deck:v1.8.x</span><br></pre></td></tr></table></figure><h4 id="4-6-2-准备dp资源清单"><a href="#4-6-2-准备dp资源清单" class="headerlink" title="4.6.2 准备dp资源清单"></a>4.6.2 准备dp资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;dp.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: armory-deck</span><br><span class="line">  name: armory-deck</span><br><span class="line">  namespace: armory</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: armory-deck</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      annotations:</span><br><span class="line">        artifact.spinnaker.io&#x2F;location: &#39;&quot;armory&quot;&#39;</span><br><span class="line">        artifact.spinnaker.io&#x2F;name: &#39;&quot;armory-deck&quot;&#39;</span><br><span class="line">        artifact.spinnaker.io&#x2F;type: &#39;&quot;kubernetes&#x2F;deployment&quot;&#39;</span><br><span class="line">        moniker.spinnaker.io&#x2F;application: &#39;&quot;armory&quot;&#39;</span><br><span class="line">        moniker.spinnaker.io&#x2F;cluster: &#39;&quot;deck&quot;&#39;</span><br><span class="line">      labels:</span><br><span class="line">        app: armory-deck</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: armory-deck</span><br><span class="line">        image: harbor.od.com&#x2F;armory&#x2F;deck:v1.8.x</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        command:</span><br><span class="line">        - bash</span><br><span class="line">        - -c</span><br><span class="line">        args:</span><br><span class="line">        - bash &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;default&#x2F;fetch.sh &amp;&amp; &#x2F;entrypoint.sh</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9000</span><br><span class="line">          protocol: TCP</span><br><span class="line">        envFrom:</span><br><span class="line">        - configMapRef:</span><br><span class="line">            name: init-env</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;</span><br><span class="line">            port: 9000</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 180</span><br><span class="line">          periodSeconds: 3</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;</span><br><span class="line">            port: 9000</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          periodSeconds: 3</span><br><span class="line">          successThreshold: 5</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: &#x2F;etc&#x2F;podinfo</span><br><span class="line">          name: podinfo</span><br><span class="line">        - mountPath: &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;default</span><br><span class="line">          name: default-config</span><br><span class="line">        - mountPath: &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;custom</span><br><span class="line">          name: custom-config</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      volumes:</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          name: custom-config</span><br><span class="line">        name: custom-config</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          name: default-config</span><br><span class="line">        name: default-config</span><br><span class="line">      - downwardAPI:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          items:</span><br><span class="line">          - fieldRef:</span><br><span class="line">              apiVersion: v1</span><br><span class="line">              fieldPath: metadata.labels</span><br><span class="line">            path: labels</span><br><span class="line">          - fieldRef:</span><br><span class="line">              apiVersion: v1</span><br><span class="line">              fieldPath: metadata.annotations</span><br><span class="line">            path: annotations</span><br><span class="line">        name: podinfo</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-6-3-准备svc资源清单"><a href="#4-6-3-准备svc资源清单" class="headerlink" title="4.6.3 准备svc资源清单"></a>4.6.3 准备svc资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;svc.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: armory-deck</span><br><span class="line">  namespace: armory</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 9000</span><br><span class="line">  selector:</span><br><span class="line">    app: armory-deck</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-6-4-应用资源配置清单"><a href="#4-6-4-应用资源配置清单" class="headerlink" title="4.6.4 应用资源配置清单"></a>4.6.4 应用资源配置清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;deck&#x2F;dp.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;deck&#x2F;svc.yaml</span><br></pre></td></tr></table></figure><p>检查</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~]# docker exec -it b71a5af3c57e sh</span><br><span class="line">&#x2F; # curl armory-igor:8088&#x2F;health</span><br><span class="line">&#123;&quot;status&quot;:&quot;UP&quot;&#125;</span><br></pre></td></tr></table></figure><h3 id="4-7-spinnaker之nginx部署"><a href="#4-7-spinnaker之nginx部署" class="headerlink" title="4.7 spinnaker之nginx部署"></a>4.7 spinnaker之nginx部署</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;data&#x2F;k8s-yaml&#x2F;armory&#x2F;nginx</span><br><span class="line">cd &#x2F;data&#x2F;k8s-yaml&#x2F;armory&#x2F;nginx</span><br></pre></td></tr></table></figure><h4 id="4-7-1-准备docker镜像"><a href="#4-7-1-准备docker镜像" class="headerlink" title="4.7.1 准备docker镜像"></a>4.7.1 准备docker镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull nginx:1.12.2</span><br><span class="line">docker tag  4037a5562b03 harbor.od.com&#x2F;armory&#x2F;nginx:v1.12.2</span><br><span class="line">docker push harbor.od.com&#x2F;armory&#x2F;nginx:v1.12.2</span><br></pre></td></tr></table></figure><h4 id="4-7-2-准备dp资源清单"><a href="#4-7-2-准备dp资源清单" class="headerlink" title="4.7.2 准备dp资源清单"></a>4.7.2 准备dp资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;dp.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: armory-nginx</span><br><span class="line">  name: armory-nginx</span><br><span class="line">  namespace: armory</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: armory-nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      annotations:</span><br><span class="line">        artifact.spinnaker.io&#x2F;location: &#39;&quot;armory&quot;&#39;</span><br><span class="line">        artifact.spinnaker.io&#x2F;name: &#39;&quot;armory-nginx&quot;&#39;</span><br><span class="line">        artifact.spinnaker.io&#x2F;type: &#39;&quot;kubernetes&#x2F;deployment&quot;&#39;</span><br><span class="line">        moniker.spinnaker.io&#x2F;application: &#39;&quot;armory&quot;&#39;</span><br><span class="line">        moniker.spinnaker.io&#x2F;cluster: &#39;&quot;nginx&quot;&#39;</span><br><span class="line">      labels:</span><br><span class="line">        app: armory-nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: armory-nginx</span><br><span class="line">        image: harbor.od.com&#x2F;armory&#x2F;nginx:v1.12.2</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        command:</span><br><span class="line">        - bash</span><br><span class="line">        - -c</span><br><span class="line">        args:</span><br><span class="line">        - bash &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;default&#x2F;fetch.sh nginx &amp;&amp; nginx -g &#39;daemon off;&#39;</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          name: http</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 443</span><br><span class="line">          name: https</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 8085</span><br><span class="line">          name: api</span><br><span class="line">          protocol: TCP</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;</span><br><span class="line">            port: 80</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 180</span><br><span class="line">          periodSeconds: 3</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;</span><br><span class="line">            port: 80</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          periodSeconds: 3</span><br><span class="line">          successThreshold: 5</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: &#x2F;opt&#x2F;spinnaker&#x2F;config&#x2F;default</span><br><span class="line">          name: default-config</span><br><span class="line">        - mountPath: &#x2F;etc&#x2F;nginx&#x2F;conf.d</span><br><span class="line">          name: custom-config</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      volumes:</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          name: custom-config</span><br><span class="line">        name: custom-config</span><br><span class="line">      - configMap:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          name: default-config</span><br><span class="line">        name: default-config</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-6-3-准备svc资源清单-1"><a href="#4-6-3-准备svc资源清单-1" class="headerlink" title="4.6.3 准备svc资源清单"></a>4.6.3 准备svc资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;svc.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: armory-nginx</span><br><span class="line">  namespace: armory</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  - name: https</span><br><span class="line">    port: 443</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 443</span><br><span class="line">  - name: api</span><br><span class="line">    port: 8085</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 8085</span><br><span class="line">  selector:</span><br><span class="line">    app: armory-nginx</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-6-4-准备ingress资源清单"><a href="#4-6-4-准备ingress资源清单" class="headerlink" title="4.6.4 准备ingress资源清单"></a>4.6.4 准备ingress资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;ingress.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">kind: IngressRoute</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: spinnaker</span><br><span class="line">    web: spinnaker.od.com</span><br><span class="line">  name: spinnaker-route</span><br><span class="line">  namespace: armory</span><br><span class="line">spec:</span><br><span class="line">  entryPoints:</span><br><span class="line">    - web</span><br><span class="line">  routes:</span><br><span class="line">    - match: Host(&#96;spinnaker.od.com&#96;)</span><br><span class="line">      kind: Rule</span><br><span class="line">      services:</span><br><span class="line">        - name: armory-nginx</span><br><span class="line">          port: 80</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="4-6-5-应用资源配置清单"><a href="#4-6-5-应用资源配置清单" class="headerlink" title="4.6.5 应用资源配置清单"></a>4.6.5 应用资源配置清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;nginx&#x2F;dp.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;nginx&#x2F;svc.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;armory&#x2F;nginx&#x2F;ingress.yaml</span><br></pre></td></tr></table></figure><p>检查</p><p>转载自：<a href="https://www.cnblogs.com/noah-luo/p/13501902.html" target="_blank" rel="noopener">https://www.cnblogs.com/noah-luo/p/13501902.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;K8s集成实战-使用spinnaker进行自动化部署&quot;&gt;&lt;a href=&quot;#K8s集成实战-使用spinnaker进行自动化部署&quot; class=&quot;headerlink&quot; title=&quot;K8s集成实战-使用spinnaker进行自动化部署&quot;&gt;&lt;/a&gt;K8s集成实战-
      
    
    </summary>
    
    
      <category term="k8s" scheme="http://yoursite.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="http://yoursite.com/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>K8S(14)监控实战-grafana出图_alert告警</title>
    <link href="http://yoursite.com/2020/12/26/k8s/16/"/>
    <id>http://yoursite.com/2020/12/26/k8s/16/</id>
    <published>2020-12-26T07:58:16.269Z</published>
    <updated>2020-12-26T07:58:16.264Z</updated>
    
    <content type="html"><![CDATA[<hr><h1 id=""><a href="#" class="headerlink" title=""></a></h1><h1 id="k8s监控实战-grafana出图-alert告警"><a href="#k8s监控实战-grafana出图-alert告警" class="headerlink" title="k8s监控实战-grafana出图_alert告警"></a>k8s监控实战-grafana出图_alert告警</h1><p>目录</p><ul><li><p>k8s监控实战-grafana出图_alert告警</p></li><li><ul><li>1 使用炫酷的grafana出图</li></ul></li><li><ul><li><ul><li>1.1 部署grafana</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>1.1.1 准备镜像</li><li>1.1.2 准备rbac资源清单</li><li>1.1.3 准备dp资源清单</li><li>1.1.4 准备svc资源清单</li><li>1.1.5 准备ingress资源清单</li><li>1.1.6 域名解析</li><li>1.1.7 应用资源配置清单</li></ul></li></ul></li></ul></li><li><ul><li><ul><li>1.2 使用grafana出图</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>1.2.1 浏览器访问验证</li><li>1.2.2 进入容器安装插件</li><li>1.2.3 配置数据源</li><li>1.2.4 添加K8S集群信息</li><li>1.2.5 查看k8s集群数据和图表</li></ul></li></ul></li></ul></li><li><ul><li>2 配置alert告警插件</li></ul></li><li><ul><li><ul><li>2.1 部署alert插件</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>2.1.1 准备docker镜像</li><li>2.1.2 准备cm资源清单</li><li>2.1.3 准备dp资源清单</li><li>2.1.4 准备svc资源清单</li><li>2.1.5 应用资源配置清单</li></ul></li></ul></li></ul></li><li><ul><li><ul><li>2.2 K8S使用alert报警</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>2.2.1 k8s创建基础报警规则文件</li><li>2.2.2 K8S 更新配置</li><li>2.2.3 测试告警</li></ul></li></ul></li></ul></li></ul><h2 id="1-使用炫酷的grafana出图"><a href="#1-使用炫酷的grafana出图" class="headerlink" title="1 使用炫酷的grafana出图"></a>1 使用炫酷的grafana出图</h2><p>prometheus的dashboard虽然号称拥有多种多样的图表,但是实在太简陋了,一般都用专业的grafana工具来出图</p><p><a href="https://hub.docker.com/r/grafana/grafana" target="_blank" rel="noopener">grafana官方dockerhub地址</a></p><p><a href="https://github.com/grafana/grafana" target="_blank" rel="noopener">grafana官方github地址</a></p><p><a href="https://grafana.com/" target="_blank" rel="noopener">grafana官网</a></p><h3 id="1-1-部署grafana"><a href="#1-1-部署grafana" class="headerlink" title="1.1 部署grafana"></a>1.1 部署grafana</h3><h4 id="1-1-1-准备镜像"><a href="#1-1-1-准备镜像" class="headerlink" title="1.1.1 准备镜像"></a>1.1.1 准备镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull grafana&#x2F;grafana:5.4.2</span><br><span class="line">docker tag  6f18ddf9e552 harbor.zq.com&#x2F;infra&#x2F;grafana:v5.4.2</span><br><span class="line">docker push harbor.zq.com&#x2F;infra&#x2F;grafana:v5.4.2</span><br></pre></td></tr></table></figure><p>准备目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;data&#x2F;k8s-yaml&#x2F;grafana</span><br><span class="line">cd    &#x2F;data&#x2F;k8s-yaml&#x2F;grafana</span><br></pre></td></tr></table></figure><h4 id="1-1-2-准备rbac资源清单"><a href="#1-1-2-准备rbac资源清单" class="headerlink" title="1.1.2 准备rbac资源清单"></a>1.1.2 准备rbac资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;rbac.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">    kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">  name: grafana</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;*&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - namespaces</span><br><span class="line">  - deployments</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">    kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">  name: grafana</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: grafana</span><br><span class="line">subjects:</span><br><span class="line">- kind: User</span><br><span class="line">  name: k8s-node</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="1-1-3-准备dp资源清单"><a href="#1-1-3-准备dp资源清单" class="headerlink" title="1.1.3 准备dp资源清单"></a>1.1.3 准备dp资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;dp.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: grafana</span><br><span class="line">    name: grafana</span><br><span class="line">  name: grafana</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  progressDeadlineSeconds: 600</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: grafana</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 1</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: grafana</span><br><span class="line">        name: grafana</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: grafana</span><br><span class="line">        image: harbor.zq.com&#x2F;infra&#x2F;grafana:v5.4.2</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 3000</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: &#x2F;var&#x2F;lib&#x2F;grafana</span><br><span class="line">          name: data</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      securityContext:</span><br><span class="line">        runAsUser: 0</span><br><span class="line">      volumes:</span><br><span class="line">      - nfs:</span><br><span class="line">          server: hdss7-200</span><br><span class="line">          path: &#x2F;data&#x2F;nfs-volume&#x2F;grafana</span><br><span class="line">        name: data</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>创建frafana数据目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;data&#x2F;nfs-volume&#x2F;grafana</span><br></pre></td></tr></table></figure><h4 id="1-1-4-准备svc资源清单"><a href="#1-1-4-准备svc资源清单" class="headerlink" title="1.1.4 准备svc资源清单"></a>1.1.4 准备svc资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;svc.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 3000</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 3000</span><br><span class="line">    selector:</span><br><span class="line">    app: grafana</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="1-1-5-准备ingress资源清单"><a href="#1-1-5-准备ingress资源清单" class="headerlink" title="1.1.5 准备ingress资源清单"></a>1.1.5 准备ingress资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;ingress.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: grafana.zq.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: &#x2F;</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: grafana</span><br><span class="line">          servicePort: 3000</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="1-1-6-域名解析"><a href="#1-1-6-域名解析" class="headerlink" title="1.1.6 域名解析"></a>1.1.6 域名解析</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;var&#x2F;named&#x2F;zq.com.zone</span><br><span class="line">grafana            A    10.4.7.10</span><br><span class="line">systemctl restart named</span><br></pre></td></tr></table></figure><h4 id="1-1-7-应用资源配置清单"><a href="#1-1-7-应用资源配置清单" class="headerlink" title="1.1.7 应用资源配置清单"></a>1.1.7 应用资源配置清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;grafana&#x2F;rbac.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;grafana&#x2F;dp.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;grafana&#x2F;svc.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;grafana&#x2F;ingress.yaml</span><br></pre></td></tr></table></figure><h3 id="1-2-使用grafana出图"><a href="#1-2-使用grafana出图" class="headerlink" title="1.2 使用grafana出图"></a>1.2 使用grafana出图</h3><h4 id="1-2-1-浏览器访问验证"><a href="#1-2-1-浏览器访问验证" class="headerlink" title="1.2.1 浏览器访问验证"></a>1.2.1 浏览器访问验证</h4><p>访问<a href="http://grafana.zq.com,默认用户名密码admin/admin" target="_blank" rel="noopener">http://grafana.zq.com,默认用户名密码admin/admin</a></p><p>能成功访问表示安装成功</p><p>进入后立即修改管理员密码为<code>admin123</code></p><h4 id="1-2-2-进入容器安装插件"><a href="#1-2-2-进入容器安装插件" class="headerlink" title="1.2.2 进入容器安装插件"></a>1.2.2 进入容器安装插件</h4><p>grafana确认启动好以后,需要进入grafana容器内部,安装以下插件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n infra exec  -it grafana-d6588db94-xr4s6 &#x2F;bin&#x2F;bash</span><br><span class="line"># 以下命令在容器内执行</span><br><span class="line">grafana-cli plugins install grafana-kubernetes-app</span><br><span class="line">grafana-cli plugins install grafana-clock-panel</span><br><span class="line">grafana-cli plugins install grafana-piechart-panel</span><br><span class="line">grafana-cli plugins install briangann-gauge-panel</span><br><span class="line">grafana-cli plugins install natel-discrete-panel</span><br></pre></td></tr></table></figure><h4 id="1-2-3-配置数据源"><a href="#1-2-3-配置数据源" class="headerlink" title="1.2.3 配置数据源"></a>1.2.3 配置数据源</h4><p>添加数据源,依次点击：左侧锯齿图标–&gt;add data source–&gt;Prometheus</p><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601220040130-dbba1c40-a1e1-4a2e-a280-9c6536c1ce2d.png" alt="image"></p><p>添加完成后<strong>重启grafana</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n infra delete pod grafana-7dd95b4c8d-nj5cx</span><br></pre></td></tr></table></figure><h4 id="1-2-4-添加K8S集群信息"><a href="#1-2-4-添加K8S集群信息" class="headerlink" title="1.2.4 添加K8S集群信息"></a>1.2.4 添加K8S集群信息</h4><p>启用K8S插件,依次点击：左侧锯齿图标–&gt;Plugins–&gt;kubernetes–&gt;Enable</p><p>新建cluster,依次点击：左侧K8S图标–&gt;New Cluster</p><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601220040150-63dcc2ec-4174-44da-a46f-5f02b08d05d8.png" alt="image"></p><h4 id="1-2-5-查看k8s集群数据和图表"><a href="#1-2-5-查看k8s集群数据和图表" class="headerlink" title="1.2.5 查看k8s集群数据和图表"></a>1.2.5 查看k8s集群数据和图表</h4><p>添加完需要稍等几分钟，在没有取到数据之前，会报http forbidden，没关系，等一会就好。大概2-5分钟。</p><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601220040131-2617029a-46b1-44ac-a8c7-89fe3c9bcf95.png" alt="image"></p><p><strong>点击Cluster Dashboard</strong></p><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601220040139-d5d9cfb6-3022-4436-af8e-27804f20fc18.png" alt="image"></p><h2 id="2-配置alert告警插件"><a href="#2-配置alert告警插件" class="headerlink" title="2 配置alert告警插件"></a>2 配置alert告警插件</h2><h3 id="2-1-部署alert插件"><a href="#2-1-部署alert插件" class="headerlink" title="2.1 部署alert插件"></a>2.1 部署alert插件</h3><h4 id="2-1-1-准备docker镜像"><a href="#2-1-1-准备docker镜像" class="headerlink" title="2.1.1 准备docker镜像"></a>2.1.1 准备docker镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker.io&#x2F;prom&#x2F;alertmanager:v0.14.0</span><br><span class="line">docker tag  23744b2d645c harbor.zq.com&#x2F;infra&#x2F;alertmanager:v0.14.0</span><br><span class="line">docker push harbor.zq.com&#x2F;infra&#x2F;alertmanager:v0.14.0</span><br></pre></td></tr></table></figure><p>准备目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;data&#x2F;k8s-yaml&#x2F;alertmanager</span><br><span class="line">cd &#x2F;data&#x2F;k8s-yaml&#x2F;alertmanager</span><br></pre></td></tr></table></figure><h4 id="2-1-2-准备cm资源清单"><a href="#2-1-2-准备cm资源清单" class="headerlink" title="2.1.2 准备cm资源清单"></a>2.1.2 准备cm资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;cm.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager-config</span><br><span class="line">  namespace: infra</span><br><span class="line">data:</span><br><span class="line">  config.yml: |-</span><br><span class="line">    global:</span><br><span class="line">      # 在没有报警的情况下声明为已解决的时间</span><br><span class="line">      resolve_timeout: 5m</span><br><span class="line">      # 配置邮件发送信息</span><br><span class="line">      smtp_smarthost: &#39;smtp.163.com:25&#39;</span><br><span class="line">      smtp_from: &#39;xxx@163.com&#39;</span><br><span class="line">      smtp_auth_username: &#39;xxx@163.com&#39;</span><br><span class="line">      smtp_auth_password: &#39;xxxxxx&#39;</span><br><span class="line">      smtp_require_tls: false</span><br><span class="line">    templates:   </span><br><span class="line">      - &#39;&#x2F;etc&#x2F;alertmanager&#x2F;*.tmpl&#39;</span><br><span class="line">    # 所有报警信息进入后的根路由，用来设置报警的分发策略</span><br><span class="line">    route:</span><br><span class="line">      # 这里的标签列表是接收到报警信息后的重新分组标签，例如，接收到的报警信息里面有许多具有 cluster&#x3D;A 和 alertname&#x3D;LatncyHigh 这样的标签的报警信息将会批量被聚合到一个分组里面</span><br><span class="line">      group_by: [&#39;alertname&#39;, &#39;cluster&#39;]</span><br><span class="line">      # 当一个新的报警分组被创建后，需要等待至少group_wait时间来初始化通知，这种方式可以确保您能有足够的时间为同一分组来获取多个警报，然后一起触发这个报警信息。</span><br><span class="line">      group_wait: 30s</span><br><span class="line">      # 当第一个报警发送后，等待&#39;group_interval&#39;时间来发送新的一组报警信息。</span><br><span class="line">      group_interval: 5m</span><br><span class="line">      # 如果一个报警信息已经发送成功了，等待&#39;repeat_interval&#39;时间来重新发送他们</span><br><span class="line">      repeat_interval: 5m</span><br><span class="line">      # 默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器</span><br><span class="line">      receiver: default</span><br><span class="line">    receivers:</span><br><span class="line">    - name: &#39;default&#39;</span><br><span class="line">      email_configs:</span><br><span class="line">      - to: &#39;xxxx@qq.com&#39;</span><br><span class="line">        send_resolved: true</span><br><span class="line">        html: &#39;&#123;&#123; template &quot;email.to.html&quot; . &#125;&#125;&#39; </span><br><span class="line">        headers: &#123; Subject: &quot; &#123;&#123; .CommonLabels.instance &#125;&#125; &#123;&#123; .CommonAnnotations.summary &#125;&#125;&quot; &#125;   </span><br><span class="line">  email.tmpl: |</span><br><span class="line">    &#123;&#123; define &quot;email.to.html&quot; &#125;&#125;</span><br><span class="line">    &#123;&#123;- if gt (len .Alerts.Firing) 0 -&#125;&#125;</span><br><span class="line">    &#123;&#123; range .Alerts &#125;&#125;</span><br><span class="line">    告警程序: prometheus_alert &lt;br&gt;</span><br><span class="line">    告警级别: &#123;&#123; .Labels.severity &#125;&#125; &lt;br&gt;</span><br><span class="line">    告警类型: &#123;&#123; .Labels.alertname &#125;&#125; &lt;br&gt;</span><br><span class="line">    故障主机: &#123;&#123; .Labels.instance &#125;&#125; &lt;br&gt;</span><br><span class="line">    告警主题: &#123;&#123; .Annotations.summary &#125;&#125;  &lt;br&gt;</span><br><span class="line">    触发时间: &#123;&#123; .StartsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125; &lt;br&gt;</span><br><span class="line">    &#123;&#123; end &#125;&#125;&#123;&#123; end -&#125;&#125;</span><br><span class="line">    </span><br><span class="line">    &#123;&#123;- if gt (len .Alerts.Resolved) 0 -&#125;&#125;</span><br><span class="line">    &#123;&#123; range .Alerts &#125;&#125;</span><br><span class="line">    告警程序: prometheus_alert &lt;br&gt;</span><br><span class="line">    告警级别: &#123;&#123; .Labels.severity &#125;&#125; &lt;br&gt;</span><br><span class="line">    告警类型: &#123;&#123; .Labels.alertname &#125;&#125; &lt;br&gt;</span><br><span class="line">    故障主机: &#123;&#123; .Labels.instance &#125;&#125; &lt;br&gt;</span><br><span class="line">    告警主题: &#123;&#123; .Annotations.summary &#125;&#125; &lt;br&gt;</span><br><span class="line">    触发时间: &#123;&#123; .StartsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125; &lt;br&gt;</span><br><span class="line">    恢复时间: &#123;&#123; .EndsAt.Format &quot;2006-01-02 15:04:05&quot; &#125;&#125; &lt;br&gt;</span><br><span class="line">    &#123;&#123; end &#125;&#125;&#123;&#123; end -&#125;&#125;</span><br><span class="line">    </span><br><span class="line">    &#123;&#123;- end &#125;&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="2-1-3-准备dp资源清单"><a href="#2-1-3-准备dp资源清单" class="headerlink" title="2.1.3 准备dp资源清单"></a>2.1.3 准备dp资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;dp.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: alertmanager</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: alertmanager</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: alertmanager</span><br><span class="line">        image: harbor.zq.com&#x2F;infra&#x2F;alertmanager:v0.14.0</span><br><span class="line">        args:</span><br><span class="line">          - &quot;--config.file&#x3D;&#x2F;etc&#x2F;alertmanager&#x2F;config.yml&quot;</span><br><span class="line">          - &quot;--storage.path&#x3D;&#x2F;alertmanager&quot;</span><br><span class="line">        ports:</span><br><span class="line">        - name: alertmanager</span><br><span class="line">          containerPort: 9093</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: alertmanager-cm</span><br><span class="line">          mountPath: &#x2F;etc&#x2F;alertmanager</span><br><span class="line">      volumes:</span><br><span class="line">      - name: alertmanager-cm</span><br><span class="line">        configMap:</span><br><span class="line">          name: alertmanager-config</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="2-1-4-准备svc资源清单"><a href="#2-1-4-准备svc资源清单" class="headerlink" title="2.1.4 准备svc资源清单"></a>2.1.4 准备svc资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;svc.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  selector: </span><br><span class="line">    app: alertmanager</span><br><span class="line">  ports:</span><br><span class="line">    - port: 80</span><br><span class="line">      targetPort: 9093</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="2-1-5-应用资源配置清单"><a href="#2-1-5-应用资源配置清单" class="headerlink" title="2.1.5 应用资源配置清单"></a>2.1.5 应用资源配置清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;alertmanager&#x2F;cm.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;alertmanager&#x2F;dp.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;alertmanager&#x2F;svc.yaml</span><br></pre></td></tr></table></figure><h3 id="2-2-K8S使用alert报警"><a href="#2-2-K8S使用alert报警" class="headerlink" title="2.2 K8S使用alert报警"></a>2.2 K8S使用alert报警</h3><h4 id="2-2-1-k8s创建基础报警规则文件"><a href="#2-2-1-k8s创建基础报警规则文件" class="headerlink" title="2.2.1 k8s创建基础报警规则文件"></a>2.2.1 k8s创建基础报警规则文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;data&#x2F;nfs-volume&#x2F;prometheus&#x2F;etc&#x2F;rules.yml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">groups:</span><br><span class="line">- name: hostStatsAlert</span><br><span class="line">  rules:</span><br><span class="line">  - alert: hostCpuUsageAlert</span><br><span class="line">    expr: sum(avg without (cpu)(irate(node_cpu&#123;mode!&#x3D;&#39;idle&#39;&#125;[5m]))) by (instance) &gt; 0.85</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;&#123;&#123; $labels.instance &#125;&#125; CPU usage above 85% (current value: &#123;&#123; $value &#125;&#125;%)&quot;</span><br><span class="line">  - alert: hostMemUsageAlert</span><br><span class="line">    expr: (node_memory_MemTotal - node_memory_MemAvailable)&#x2F;node_memory_MemTotal &gt; 0.85</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;&#123;&#123; $labels.instance &#125;&#125; MEM usage above 85% (current value: &#123;&#123; $value &#125;&#125;%)&quot;</span><br><span class="line">  - alert: OutOfInodes</span><br><span class="line">    expr: node_filesystem_free&#123;fstype&#x3D;&quot;overlay&quot;,mountpoint &#x3D;&quot;&#x2F;&quot;&#125; &#x2F; node_filesystem_size&#123;fstype&#x3D;&quot;overlay&quot;,mountpoint &#x3D;&quot;&#x2F;&quot;&#125; * 100 &lt; 10</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Out of inodes (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Disk is almost running out of available inodes (&lt; 10% left) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: OutOfDiskSpace</span><br><span class="line">    expr: node_filesystem_free&#123;fstype&#x3D;&quot;overlay&quot;,mountpoint &#x3D;&quot;&#x2F;rootfs&quot;&#125; &#x2F; node_filesystem_size&#123;fstype&#x3D;&quot;overlay&quot;,mountpoint &#x3D;&quot;&#x2F;rootfs&quot;&#125; * 100 &lt; 10</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Out of disk space (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Disk is almost full (&lt; 10% left) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: UnusualNetworkThroughputIn</span><br><span class="line">    expr: sum by (instance) (irate(node_network_receive_bytes[2m])) &#x2F; 1024 &#x2F; 1024 &gt; 100</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Unusual network throughput in (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Host network interfaces are probably receiving too much data (&gt; 100 MB&#x2F;s) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: UnusualNetworkThroughputOut</span><br><span class="line">    expr: sum by (instance) (irate(node_network_transmit_bytes[2m])) &#x2F; 1024 &#x2F; 1024 &gt; 100</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Unusual network throughput out (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Host network interfaces are probably sending too much data (&gt; 100 MB&#x2F;s) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: UnusualDiskReadRate</span><br><span class="line">    expr: sum by (instance) (irate(node_disk_bytes_read[2m])) &#x2F; 1024 &#x2F; 1024 &gt; 50</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Unusual disk read rate (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Disk is probably reading too much data (&gt; 50 MB&#x2F;s) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: UnusualDiskWriteRate</span><br><span class="line">    expr: sum by (instance) (irate(node_disk_bytes_written[2m])) &#x2F; 1024 &#x2F; 1024 &gt; 50</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Unusual disk write rate (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Disk is probably writing too much data (&gt; 50 MB&#x2F;s) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: UnusualDiskReadLatency</span><br><span class="line">    expr: rate(node_disk_read_time_ms[1m]) &#x2F; rate(node_disk_reads_completed[1m]) &gt; 100</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Unusual disk read latency (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Disk latency is growing (read operations &gt; 100ms) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: UnusualDiskWriteLatency</span><br><span class="line">    expr: rate(node_disk_write_time_ms[1m]) &#x2F; rate(node_disk_writes_completedl[1m]) &gt; 100</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Unusual disk write latency (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Disk latency is growing (write operations &gt; 100ms) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">- name: http_status</span><br><span class="line">  rules:</span><br><span class="line">  - alert: ProbeFailed</span><br><span class="line">    expr: probe_success &#x3D;&#x3D; 0</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: error</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Probe failed (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Probe failed (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: StatusCode</span><br><span class="line">    expr: probe_http_status_code &lt;&#x3D; 199 OR probe_http_status_code &gt;&#x3D; 400</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: error</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Status Code (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;HTTP status code is not 200-399 (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: SslCertificateWillExpireSoon</span><br><span class="line">    expr: probe_ssl_earliest_cert_expiry - time() &lt; 86400 * 30</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;SSL certificate will expire soon (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;SSL certificate expires in 30 days (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: SslCertificateHasExpired</span><br><span class="line">    expr: probe_ssl_earliest_cert_expiry - time()  &lt;&#x3D; 0</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: error</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;SSL certificate has expired (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;SSL certificate has expired already (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: BlackboxSlowPing</span><br><span class="line">    expr: probe_icmp_duration_seconds &gt; 2</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Blackbox slow ping (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Blackbox ping took more than 2s (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: BlackboxSlowRequests</span><br><span class="line">    expr: probe_http_duration_seconds &gt; 2 </span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Blackbox slow requests (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Blackbox request took more than 2s (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: PodCpuUsagePercent</span><br><span class="line">    expr: sum(sum(label_replace(irate(container_cpu_usage_seconds_total[1m]),&quot;pod&quot;,&quot;$1&quot;,&quot;container_label_io_kubernetes_pod_name&quot;, &quot;(.*)&quot;))by(pod) &#x2F; on(pod) group_right kube_pod_container_resource_limits_cpu_cores *100 )by(container,namespace,node,pod,severity) &gt; 80</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Pod cpu usage percent has exceeded 80% (current value: &#123;&#123; $value &#125;&#125;%)&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="2-2-2-K8S-更新配置"><a href="#2-2-2-K8S-更新配置" class="headerlink" title="2.2.2 K8S 更新配置"></a>2.2.2 K8S 更新配置</h4><p>在prometheus配置文件中追加配置：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt;&#x2F;data&#x2F;nfs-volume&#x2F;prometheus&#x2F;etc&#x2F;prometheus.yml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">    - static_configs:</span><br><span class="line">        - targets: [&quot;alertmanager&quot;]</span><br><span class="line">rule_files:</span><br><span class="line"> - &quot;&#x2F;data&#x2F;etc&#x2F;rules.yml&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>重载配置：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http:&#x2F;&#x2F;prometheus.zq.com&#x2F;-&#x2F;reload</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601220040140-587a9413-6814-4f80-b714-e0917197e30d.png" alt="image"></p><p>以上这些就是我们的告警规则</p><h4 id="2-2-3-测试告警"><a href="#2-2-3-测试告警" class="headerlink" title="2.2.3 测试告警"></a>2.2.3 测试告警</h4><p>把test命名空间里的dubbo-demo-service给停掉</p><p>blackbox里信息已报错,alert里面项目变黄了</p><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601220040147-1db28ba9-d589-4101-9bbf-040f22451803.png" alt="image"></p><p>等到alert中项目变为红色的时候就开会发邮件告警</p><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601220040164-98b9dbe7-551d-43df-894b-5c3e0de2f9a1.png" alt="image"></p><p>如果需要自己定制告警规则和告警内容，需要研究一下promql，自己修改配置文件。</p><p>转载自：<a href="https://www.cnblogs.com/noah-luo/p/13501866.html" target="_blank" rel="noopener">https://www.cnblogs.com/noah-luo/p/13501866.html</a></p><pre><code></code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;h1 id=&quot;&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;headerlink&quot; title=&quot;&quot;&gt;&lt;/a&gt;&lt;/h1&gt;&lt;h1 id=&quot;k8s监控实战-grafana出图-alert告警&quot;&gt;&lt;a href=&quot;#k8s监控实战-grafana出图-alert告警&quot; clas
      
    
    </summary>
    
    
      <category term="k8s" scheme="http://yoursite.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="http://yoursite.com/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>K8S(13)监控实战-部署prometheus</title>
    <link href="http://yoursite.com/2020/12/26/k8s/15/"/>
    <id>http://yoursite.com/2020/12/26/k8s/15/</id>
    <published>2020-12-26T07:58:08.509Z</published>
    <updated>2020-12-26T07:58:08.503Z</updated>
    
    <content type="html"><![CDATA[<hr><h1 id="k8s监控实战-部署prometheus"><a href="#k8s监控实战-部署prometheus" class="headerlink" title="k8s监控实战-部署prometheus"></a>k8s监控实战-部署prometheus</h1><p>目录</p><ul><li><p>k8s监控实战-部署prometheus</p></li><li><ul><li>1 prometheus前言相关</li></ul></li><li><ul><li><ul><li>1.1 Prometheus的特点</li><li>1.2 基本原理</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>1.2.1 原理说明</li><li>1.2.2 架构图:</li><li>1.2.3 三大套件</li><li>1.2.4 架构服务过程</li><li>1.2.5 常用的exporter</li></ul></li></ul></li></ul></li><li><ul><li>2 部署4个exporter</li></ul></li><li><ul><li><ul><li>2.1 部署kube-state-metrics</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>2.1.1 准备docker镜像</li><li>2.1.2 准备rbac资源清单</li><li>2.1.3 准备Dp资源清单</li><li>2.1.4 应用资源配置清单</li></ul></li></ul></li></ul></li><li><ul><li><ul><li>2.2 部署node-exporter</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>2.2.1 准备docker镜像</li><li>2.2.2 准备ds资源清单</li><li>2.2.3 应用资源配置清单：</li></ul></li></ul></li></ul></li><li><ul><li><ul><li>2.3 部署cadvisor</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>2.3.1 准备docker镜像</li><li>2.3.2 准备ds资源清单</li><li>2.3.3 应用资源配置清单：</li></ul></li></ul></li></ul></li><li><ul><li><ul><li>2.4 部署blackbox-exporter</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>2.4.1 准备docker镜像</li><li>2.4.2 准备cm资源清单</li><li>2.4.3 准备dp资源清单</li><li>2.4.4 准备svc资源清单</li><li>2.4.5 准备ingress资源清单</li><li>2.4.6 添加域名解析</li><li>2.4.7 应用资源配置清单</li><li>2.4.8 访问域名测试</li></ul></li></ul></li></ul></li><li><ul><li>3 部署prometheus server</li></ul></li><li><ul><li><ul><li>3.1 准备prometheus server环境</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>3.1.1 准备docker镜像</li><li>3.1.2 准备rbac资源清单</li><li>3.1.3 准备dp资源清单</li><li>3.1.4 准备svc资源清单</li><li>3.1.5 准备ingress资源清单</li><li>3.1.6 添加域名解析</li></ul></li></ul></li></ul></li><li><ul><li><ul><li>3.2 部署prometheus server</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>3.2.1 准备目录和证书</li><li>3.2.2 创建prometheus配置文件</li><li>3.2.3 应用资源配置清单</li><li>3.2.4 浏览器验证</li></ul></li></ul></li></ul></li><li><ul><li>4 使服务能被prometheus自动监控</li></ul></li><li><ul><li><ul><li>4.1 让traefik能被自动监控</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>4.1.1 修改traefik的yaml</li><li>4.1.2 应用配置查看</li></ul></li></ul></li></ul></li><li><ul><li><ul><li>4.2 用blackbox检测TCP/HTTP服务状态</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>4.2.1 被检测服务准备</li><li>4.2.2 添加tcp的annotation</li><li>4.2.3 添加http的annotation</li></ul></li></ul></li></ul></li><li><ul><li><ul><li>4.3 添加监控jvm信息</li></ul></li></ul></li></ul><h2 id="1-prometheus前言相关"><a href="#1-prometheus前言相关" class="headerlink" title="1 prometheus前言相关"></a>1 prometheus前言相关</h2><p>由于docker容器的特殊性，传统的zabbix无法对k8s集群内的docker状态进行监控，所以需要使用prometheus来进行监控</p><p>prometheus官网：<a href="https://prometheus.io/" target="_blank" rel="noopener">官网地址</a></p><h3 id="1-1-Prometheus的特点"><a href="#1-1-Prometheus的特点" class="headerlink" title="1.1 Prometheus的特点"></a>1.1 Prometheus的特点</h3><ul><li>多维度数据模型,使用时间序列数据库TSDB而不使用mysql。</li><li>灵活的查询语言PromQL。</li><li>不依赖分布式存储，单个服务器节点是自主的。</li><li>主要基于HTTP的pull方式主动采集时序数据</li><li>也可通过pushgateway获取主动推送到网关的数据。</li><li>通过服务发现或者静态配置来发现目标服务对象。</li><li>支持多种多样的图表和界面展示，比如Grafana等。</li></ul><h3 id="1-2-基本原理"><a href="#1-2-基本原理" class="headerlink" title="1.2 基本原理"></a>1.2 基本原理</h3><h4 id="1-2-1-原理说明"><a href="#1-2-1-原理说明" class="headerlink" title="1.2.1 原理说明"></a>1.2.1 原理说明</h4><p>Prometheus的基本原理是通过各种exporter提供的HTTP协议接口</p><p>周期性抓取被监控组件的状态，任意组件只要提供对应的HTTP接口就可以接入监控。</p><p>不需要任何SDK或者其他的集成过程,非常适合做虚拟化环境监控系统，比如VM、Docker、Kubernetes等。</p><p>互联网公司常用的组件大部分都有exporter可以直接使用，如Nginx、MySQL、Linux系统信息等。</p><h4 id="1-2-2-架构图"><a href="#1-2-2-架构图" class="headerlink" title="1.2.2 架构图:"></a>1.2.2 架构图:</h4><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601219938866-fc30fe28-f729-49eb-a4b9-8cfeaa83ecb5.png" alt="image"></p><h4 id="1-2-3-三大套件"><a href="#1-2-3-三大套件" class="headerlink" title="1.2.3 三大套件"></a>1.2.3 三大套件</h4><ul><li>Server 主要负责数据采集和存储，提供PromQL查询语言的支持。</li><li>Alertmanager 警告管理器，用来进行报警。</li><li>Push Gateway 支持临时性Job主动推送指标的中间网关。</li></ul><h4 id="1-2-4-架构服务过程"><a href="#1-2-4-架构服务过程" class="headerlink" title="1.2.4 架构服务过程"></a>1.2.4 架构服务过程</h4><ol><li>Prometheus Daemon负责定时去目标上抓取metrics(指标)数据<br>每个抓取目标需要暴露一个http服务的接口给它定时抓取。<br>支持通过配置文件、文本文件、Zookeeper、DNS SRV Lookup等方式指定抓取目标。</li><li>PushGateway用于Client主动推送metrics到PushGateway<br>而Prometheus只是定时去Gateway上抓取数据。<br>适合一次性、短生命周期的服务</li><li>Prometheus在TSDB数据库存储抓取的所有数据<br>通过一定规则进行清理和整理数据，并把得到的结果存储到新的时间序列中。</li><li>Prometheus通过PromQL和其他API可视化地展示收集的数据。<br>支持Grafana、Promdash等方式的图表数据可视化。<br>Prometheus还提供HTTP API的查询方式，自定义所需要的输出。</li><li>Alertmanager是独立于Prometheus的一个报警组件<br>支持Prometheus的查询语句，提供十分灵活的报警方式。</li></ol><h4 id="1-2-5-常用的exporter"><a href="#1-2-5-常用的exporter" class="headerlink" title="1.2.5 常用的exporter"></a>1.2.5 常用的exporter</h4><p>prometheus不同于zabbix，没有agent，使用的是针对不同服务的exporter</p><p>正常情况下，监控k8s集群及node，pod，常用的exporter有四个：</p><ul><li>kube-state-metrics<br>收集k8s集群master&amp;etcd等基本状态信息</li><li>node-exporter<br>收集k8s集群node信息</li><li>cadvisor<br>收集k8s集群docker容器内部使用资源信息</li><li>blackbox-exporte<br>收集k8s集群docker容器服务是否存活</li></ul><h2 id="2-部署4个exporter"><a href="#2-部署4个exporter" class="headerlink" title="2 部署4个exporter"></a>2 部署4个exporter</h2><p>老套路，下载docker镜像，准备资源配置清单，应用资源配置清单：</p><h3 id="2-1-部署kube-state-metrics"><a href="#2-1-部署kube-state-metrics" class="headerlink" title="2.1 部署kube-state-metrics"></a>2.1 部署kube-state-metrics</h3><h4 id="2-1-1-准备docker镜像"><a href="#2-1-1-准备docker镜像" class="headerlink" title="2.1.1 准备docker镜像"></a>2.1.1 准备docker镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull quay.io&#x2F;coreos&#x2F;kube-state-metrics:v1.5.0</span><br><span class="line">docker tag  91599517197a harbor.zq.com&#x2F;public&#x2F;kube-state-metrics:v1.5.0</span><br><span class="line">docker push harbor.zq.com&#x2F;public&#x2F;kube-state-metrics:v1.5.0</span><br></pre></td></tr></table></figure><p>准备目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;data&#x2F;k8s-yaml&#x2F;kube-state-metrics</span><br><span class="line">cd &#x2F;data&#x2F;k8s-yaml&#x2F;kube-state-metrics</span><br></pre></td></tr></table></figure><h4 id="2-1-2-准备rbac资源清单"><a href="#2-1-2-准备rbac资源清单" class="headerlink" title="2.1.2 准备rbac资源清单"></a>2.1.2 准备rbac资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;rbac.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">    kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">    kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  - secrets</span><br><span class="line">  - nodes</span><br><span class="line">  - pods</span><br><span class="line">  - services</span><br><span class="line">  - resourcequotas</span><br><span class="line">  - replicationcontrollers</span><br><span class="line">  - limitranges</span><br><span class="line">  - persistentvolumeclaims</span><br><span class="line">  - persistentvolumes</span><br><span class="line">  - namespaces</span><br><span class="line">  - endpoints</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - policy</span><br><span class="line">  resources:</span><br><span class="line">  - poddisruptionbudgets</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - extensions</span><br><span class="line">  resources:</span><br><span class="line">  - daemonsets</span><br><span class="line">  - deployments</span><br><span class="line">  - replicasets</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - apps</span><br><span class="line">  resources:</span><br><span class="line">  - statefulsets</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - batch</span><br><span class="line">  resources:</span><br><span class="line">  - cronjobs</span><br><span class="line">  - jobs</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - autoscaling</span><br><span class="line">  resources:</span><br><span class="line">  - horizontalpodautoscalers</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">    kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="2-1-3-准备Dp资源清单"><a href="#2-1-3-准备Dp资源清单" class="headerlink" title="2.1.3 准备Dp资源清单"></a>2.1.3 准备Dp资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;dp.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    deployment.kubernetes.io&#x2F;revision: &quot;2&quot;</span><br><span class="line">  labels:</span><br><span class="line">    grafanak8sapp: &quot;true&quot;</span><br><span class="line">    app: kube-state-metrics</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      grafanak8sapp: &quot;true&quot;</span><br><span class="line">      app: kube-state-metrics</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 25%</span><br><span class="line">      maxUnavailable: 25%</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        grafanak8sapp: &quot;true&quot;</span><br><span class="line">        app: kube-state-metrics</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kube-state-metrics</span><br><span class="line">        image: harbor.zq.com&#x2F;public&#x2F;kube-state-metrics:v1.5.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          name: http-metrics</span><br><span class="line">          protocol: TCP</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;healthz</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">      serviceAccountName: kube-state-metrics</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="2-1-4-应用资源配置清单"><a href="#2-1-4-应用资源配置清单" class="headerlink" title="2.1.4 应用资源配置清单"></a>2.1.4 应用资源配置清单</h4><p>任意node节点执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;kube-state-metrics&#x2F;rbac.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;kube-state-metrics&#x2F;dp.yaml</span><br></pre></td></tr></table></figure><p><strong>验证测试</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n kube-system -o wide|grep kube-state-metrices</span><br><span class="line">~]# curl http:&#x2F;&#x2F;172.7.21.4:8080&#x2F;healthz</span><br><span class="line">ok</span><br></pre></td></tr></table></figure><p>返回OK表示已经成功运行。</p><h3 id="2-2-部署node-exporter"><a href="#2-2-部署node-exporter" class="headerlink" title="2.2 部署node-exporter"></a>2.2 部署node-exporter</h3><p><strong>由于node-exporter是监控node的，需要每个节点启动一个，所以使用ds控制器</strong></p><h4 id="2-2-1-准备docker镜像"><a href="#2-2-1-准备docker镜像" class="headerlink" title="2.2.1 准备docker镜像"></a>2.2.1 准备docker镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull prom&#x2F;node-exporter:v0.15.0</span><br><span class="line">docker tag 12d51ffa2b22 harbor.zq.com&#x2F;public&#x2F;node-exporter:v0.15.0</span><br><span class="line">docker push harbor.zq.com&#x2F;public&#x2F;node-exporter:v0.15.0</span><br></pre></td></tr></table></figure><p>准备目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;data&#x2F;k8s-yaml&#x2F;node-exporter</span><br><span class="line">cd &#x2F;data&#x2F;k8s-yaml&#x2F;node-exporter</span><br></pre></td></tr></table></figure><h4 id="2-2-2-准备ds资源清单"><a href="#2-2-2-准备ds资源清单" class="headerlink" title="2.2.2 准备ds资源清单"></a>2.2.2 准备ds资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;ds.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">kind: DaemonSet</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: node-exporter</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    daemon: &quot;node-exporter&quot;</span><br><span class="line">    grafanak8sapp: &quot;true&quot;</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      daemon: &quot;node-exporter&quot;</span><br><span class="line">      grafanak8sapp: &quot;true&quot;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: node-exporter</span><br><span class="line">      labels:</span><br><span class="line">        daemon: &quot;node-exporter&quot;</span><br><span class="line">        grafanak8sapp: &quot;true&quot;</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: proc</span><br><span class="line">        hostPath: </span><br><span class="line">          path: &#x2F;proc</span><br><span class="line">          type: &quot;&quot;</span><br><span class="line">      - name: sys</span><br><span class="line">        hostPath:</span><br><span class="line">          path: &#x2F;sys</span><br><span class="line">          type: &quot;&quot;</span><br><span class="line">      containers:</span><br><span class="line">      - name: node-exporter</span><br><span class="line">        image: harbor.zq.com&#x2F;public&#x2F;node-exporter:v0.15.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        args:</span><br><span class="line">        - --path.procfs&#x3D;&#x2F;host_proc</span><br><span class="line">        - --path.sysfs&#x3D;&#x2F;host_sys</span><br><span class="line">        ports:</span><br><span class="line">        - name: node-exporter</span><br><span class="line">          hostPort: 9100</span><br><span class="line">          containerPort: 9100</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: sys</span><br><span class="line">          readOnly: true</span><br><span class="line">          mountPath: &#x2F;host_sys</span><br><span class="line">        - name: proc</span><br><span class="line">          readOnly: true</span><br><span class="line">          mountPath: &#x2F;host_proc</span><br><span class="line">      hostNetwork: true</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><blockquote><p>主要用途就是将宿主机的<code>/proc</code>,<code>sys</code>目录挂载给容器,是容器能获取node节点宿主机信息</p></blockquote><h4 id="2-2-3-应用资源配置清单："><a href="#2-2-3-应用资源配置清单：" class="headerlink" title="2.2.3 应用资源配置清单："></a>2.2.3 应用资源配置清单：</h4><p>任意node节点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;node-exporter&#x2F;ds.yaml</span><br><span class="line">kubectl get pod -n kube-system -o wide|grep node-exporter</span><br></pre></td></tr></table></figure><h3 id="2-3-部署cadvisor"><a href="#2-3-部署cadvisor" class="headerlink" title="2.3 部署cadvisor"></a>2.3 部署cadvisor</h3><h4 id="2-3-1-准备docker镜像"><a href="#2-3-1-准备docker镜像" class="headerlink" title="2.3.1 准备docker镜像"></a>2.3.1 准备docker镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull google&#x2F;cadvisor:v0.28.3</span><br><span class="line">docker tag 75f88e3ec333 harbor.zq.com&#x2F;public&#x2F;cadvisor:0.28.3</span><br><span class="line">docker push harbor.zq.com&#x2F;public&#x2F;cadvisor:0.28.3</span><br></pre></td></tr></table></figure><p>准备目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;data&#x2F;k8s-yaml&#x2F;cadvisor</span><br><span class="line">cd &#x2F;data&#x2F;k8s-yaml&#x2F;cadvisor</span><br></pre></td></tr></table></figure><h4 id="2-3-2-准备ds资源清单"><a href="#2-3-2-准备ds资源清单" class="headerlink" title="2.3.2 准备ds资源清单"></a>2.3.2 准备ds资源清单</h4><p>cadvisor由于要获取每个node上的pod信息,因此也需要使用daemonset方式运行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;ds.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: cadvisor</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    app: cadvisor</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: cadvisor</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: cadvisor</span><br><span class="line">    spec:</span><br><span class="line">      hostNetwork: true</span><br><span class="line">#------pod的tolerations与node的Taints配合,做POD指定调度----</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: node-role.kubernetes.io&#x2F;master</span><br><span class="line">        effect: NoSchedule</span><br><span class="line">#-------------------------------------</span><br><span class="line">      containers:</span><br><span class="line">      - name: cadvisor</span><br><span class="line">        image: harbor.zq.com&#x2F;public&#x2F;cadvisor:v0.28.3</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: rootfs</span><br><span class="line">          mountPath: &#x2F;rootfs</span><br><span class="line">          readOnly: true</span><br><span class="line">        - name: var-run</span><br><span class="line">          mountPath: &#x2F;var&#x2F;run</span><br><span class="line">        - name: sys</span><br><span class="line">          mountPath: &#x2F;sys</span><br><span class="line">          readOnly: true</span><br><span class="line">        - name: docker</span><br><span class="line">          mountPath: &#x2F;var&#x2F;lib&#x2F;docker</span><br><span class="line">          readOnly: true</span><br><span class="line">        ports:</span><br><span class="line">          - name: http</span><br><span class="line">            containerPort: 4194</span><br><span class="line">            protocol: TCP</span><br><span class="line">        readinessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 4194</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">        args:</span><br><span class="line">          - --housekeeping_interval&#x3D;10s</span><br><span class="line">          - --port&#x3D;4194</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      volumes:</span><br><span class="line">      - name: rootfs</span><br><span class="line">        hostPath:</span><br><span class="line">          path: &#x2F;</span><br><span class="line">      - name: var-run</span><br><span class="line">        hostPath:</span><br><span class="line">          path: &#x2F;var&#x2F;run</span><br><span class="line">      - name: sys</span><br><span class="line">        hostPath:</span><br><span class="line">          path: &#x2F;sys</span><br><span class="line">      - name: docker</span><br><span class="line">        hostPath:</span><br><span class="line">          path: &#x2F;data&#x2F;docker</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="2-3-3-应用资源配置清单："><a href="#2-3-3-应用资源配置清单：" class="headerlink" title="2.3.3 应用资源配置清单："></a>2.3.3 应用资源配置清单：</h4><p>应用清单前,先在每个node上做以下软连接,否则服务可能报错</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mount -o remount,rw &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;</span><br><span class="line">ln -s &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu,cpuacct &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpuacct,cpu</span><br></pre></td></tr></table></figure><p>应用清单</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;cadvisor&#x2F;ds.yaml</span><br></pre></td></tr></table></figure><p>检查：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get pod -o wide|grep cadvisor</span><br></pre></td></tr></table></figure><h3 id="2-4-部署blackbox-exporter"><a href="#2-4-部署blackbox-exporter" class="headerlink" title="2.4 部署blackbox-exporter"></a>2.4 部署blackbox-exporter</h3><h4 id="2-4-1-准备docker镜像"><a href="#2-4-1-准备docker镜像" class="headerlink" title="2.4.1 准备docker镜像"></a>2.4.1 准备docker镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull prom&#x2F;blackbox-exporter:v0.15.1</span><br><span class="line">docker tag  81b70b6158be  harbor.zq.com&#x2F;public&#x2F;blackbox-exporter:v0.15.1</span><br><span class="line">docker push harbor.zq.com&#x2F;public&#x2F;blackbox-exporter:v0.15.1</span><br></pre></td></tr></table></figure><p>准备目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;data&#x2F;k8s-yaml&#x2F;blackbox-exporter</span><br><span class="line">cd &#x2F;data&#x2F;k8s-yaml&#x2F;blackbox-exporter</span><br></pre></td></tr></table></figure><h4 id="2-4-2-准备cm资源清单"><a href="#2-4-2-准备cm资源清单" class="headerlink" title="2.4.2 准备cm资源清单"></a>2.4.2 准备cm资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;cm.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: blackbox-exporter</span><br><span class="line">  name: blackbox-exporter</span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:</span><br><span class="line">  blackbox.yml: |-</span><br><span class="line">    modules:</span><br><span class="line">      http_2xx:</span><br><span class="line">        prober: http</span><br><span class="line">        timeout: 2s</span><br><span class="line">        http:</span><br><span class="line">          valid_http_versions: [&quot;HTTP&#x2F;1.1&quot;, &quot;HTTP&#x2F;2&quot;]</span><br><span class="line">          valid_status_codes: [200,301,302]</span><br><span class="line">          method: GET</span><br><span class="line">          preferred_ip_protocol: &quot;ip4&quot;</span><br><span class="line">      tcp_connect:</span><br><span class="line">        prober: tcp</span><br><span class="line">        timeout: 2s</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="2-4-3-准备dp资源清单"><a href="#2-4-3-准备dp资源清单" class="headerlink" title="2.4.3 准备dp资源清单"></a>2.4.3 准备dp资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;dp.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: blackbox-exporter</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    app: blackbox-exporter</span><br><span class="line">  annotations:</span><br><span class="line">    deployment.kubernetes.io&#x2F;revision: 1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: blackbox-exporter</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: blackbox-exporter</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: config</span><br><span class="line">        configMap:</span><br><span class="line">          name: blackbox-exporter</span><br><span class="line">          defaultMode: 420</span><br><span class="line">      containers:</span><br><span class="line">      - name: blackbox-exporter</span><br><span class="line">        image: harbor.zq.com&#x2F;public&#x2F;blackbox-exporter:v0.15.1</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        args:</span><br><span class="line">        - --config.file&#x3D;&#x2F;etc&#x2F;blackbox_exporter&#x2F;blackbox.yml</span><br><span class="line">        - --log.level&#x3D;info</span><br><span class="line">        - --web.listen-address&#x3D;:9115</span><br><span class="line">        ports:</span><br><span class="line">        - name: blackbox-port</span><br><span class="line">          containerPort: 9115</span><br><span class="line">          protocol: TCP</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 200m</span><br><span class="line">            memory: 256Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 50Mi</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: config</span><br><span class="line">          mountPath: &#x2F;etc&#x2F;blackbox_exporter</span><br><span class="line">        readinessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 9115</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="2-4-4-准备svc资源清单"><a href="#2-4-4-准备svc资源清单" class="headerlink" title="2.4.4 准备svc资源清单"></a>2.4.4 准备svc资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;svc.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: blackbox-exporter</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: blackbox-exporter</span><br><span class="line">  ports:</span><br><span class="line">    - name: blackbox-port</span><br><span class="line">      protocol: TCP</span><br><span class="line">      port: 9115</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="2-4-5-准备ingress资源清单"><a href="#2-4-5-准备ingress资源清单" class="headerlink" title="2.4.5 准备ingress资源清单"></a>2.4.5 准备ingress资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;ingress.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: blackbox-exporter</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: blackbox.zq.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: &#x2F;</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: blackbox-exporter</span><br><span class="line">          servicePort: blackbox-port</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="2-4-6-添加域名解析"><a href="#2-4-6-添加域名解析" class="headerlink" title="2.4.6 添加域名解析"></a>2.4.6 添加域名解析</h4><p>这里用到了一个域名，添加解析</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;var&#x2F;named&#x2F;zq.com.zone</span><br><span class="line">blackbox       A    10.4.7.10</span><br><span class="line">systemctl restart named</span><br></pre></td></tr></table></figure><h4 id="2-4-7-应用资源配置清单"><a href="#2-4-7-应用资源配置清单" class="headerlink" title="2.4.7 应用资源配置清单"></a>2.4.7 应用资源配置清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;blackbox-exporter&#x2F;cm.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;blackbox-exporter&#x2F;dp.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;blackbox-exporter&#x2F;svc.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;blackbox-exporter&#x2F;ingress.yaml</span><br></pre></td></tr></table></figure><h4 id="2-4-8-访问域名测试"><a href="#2-4-8-访问域名测试" class="headerlink" title="2.4.8 访问域名测试"></a>2.4.8 访问域名测试</h4><p>访问<a href="http://blackbox.zq.com，显示如下界面,表示blackbox已经运行成" target="_blank" rel="noopener">http://blackbox.zq.com，显示如下界面,表示blackbox已经运行成</a></p><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601219938890-ac98286e-bfe4-40be-91ad-b1d024a5b92b.png" alt="image"></p><h2 id="3-部署prometheus-server"><a href="#3-部署prometheus-server" class="headerlink" title="3 部署prometheus server"></a>3 部署prometheus server</h2><h3 id="3-1-准备prometheus-server环境"><a href="#3-1-准备prometheus-server环境" class="headerlink" title="3.1 准备prometheus server环境"></a>3.1 准备prometheus server环境</h3><h4 id="3-1-1-准备docker镜像"><a href="#3-1-1-准备docker镜像" class="headerlink" title="3.1.1 准备docker镜像"></a>3.1.1 准备docker镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull prom&#x2F;prometheus:v2.14.0</span><br><span class="line">docker tag  7317640d555e harbor.zq.com&#x2F;infra&#x2F;prometheus:v2.14.0</span><br><span class="line">docker push harbor.zq.com&#x2F;infra&#x2F;prometheus:v2.14.0</span><br></pre></td></tr></table></figure><p>准备目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;data&#x2F;k8s-yaml&#x2F;prometheus-server</span><br><span class="line">cd &#x2F;data&#x2F;k8s-yaml&#x2F;prometheus-server</span><br></pre></td></tr></table></figure><h4 id="3-1-2-准备rbac资源清单"><a href="#3-1-2-准备rbac资源清单" class="headerlink" title="3.1.2 准备rbac资源清单"></a>3.1.2 准备rbac资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;rbac.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">    kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: infra</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">    kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">  name: prometheus</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - nodes</span><br><span class="line">  - nodes&#x2F;metrics</span><br><span class="line">  - services</span><br><span class="line">  - endpoints</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">- nonResourceURLs:</span><br><span class="line">  - &#x2F;metrics</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">    kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">  name: prometheus</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: prometheus</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: infra</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="3-1-3-准备dp资源清单"><a href="#3-1-3-准备dp资源清单" class="headerlink" title="3.1.3 准备dp资源清单"></a>3.1.3 准备dp资源清单</h4><blockquote><p>加上<code>--web.enable-lifecycle</code>启用远程热加载配置文件,配置文件改变后不用重启prometheus</p><p>调用指令是<code>curl -X POST http://localhost:9090/-/reload</code></p><p><code>storage.tsdb.min-block-duration=10m</code>只加载10分钟数据到内</p><p><code>storage.tsdb.retention=72h</code> 保留72小时数据</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;dp.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    deployment.kubernetes.io&#x2F;revision: &quot;5&quot;</span><br><span class="line">  labels:</span><br><span class="line">    name: prometheus</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  progressDeadlineSeconds: 600</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: prometheus</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 1</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: prometheus</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: prometheus</span><br><span class="line">        image: harbor.zq.com&#x2F;infra&#x2F;prometheus:v2.14.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        command:</span><br><span class="line">        - &#x2F;bin&#x2F;prometheus</span><br><span class="line">        args:</span><br><span class="line">        - --config.file&#x3D;&#x2F;data&#x2F;etc&#x2F;prometheus.yml</span><br><span class="line">        - --storage.tsdb.path&#x3D;&#x2F;data&#x2F;prom-db</span><br><span class="line">        - --storage.tsdb.min-block-duration&#x3D;10m</span><br><span class="line">        - --storage.tsdb.retention&#x3D;72h</span><br><span class="line">        - --web.enable-lifecycle</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9090</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: &#x2F;data</span><br><span class="line">          name: data</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: &quot;1000m&quot;</span><br><span class="line">            memory: &quot;1.5Gi&quot;</span><br><span class="line">          limits:</span><br><span class="line">            cpu: &quot;2000m&quot;</span><br><span class="line">            memory: &quot;3Gi&quot;</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      securityContext:</span><br><span class="line">        runAsUser: 0</span><br><span class="line">      serviceAccountName: prometheus</span><br><span class="line">      volumes:</span><br><span class="line">      - name: data</span><br><span class="line">        nfs:</span><br><span class="line">          server: hdss7-200</span><br><span class="line">          path: &#x2F;data&#x2F;nfs-volume&#x2F;prometheus</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="3-1-4-准备svc资源清单"><a href="#3-1-4-准备svc资源清单" class="headerlink" title="3.1.4 准备svc资源清单"></a>3.1.4 准备svc资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;svc.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 9090</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 9090</span><br><span class="line">    selector:</span><br><span class="line">    app: prometheus</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="3-1-5-准备ingress资源清单"><a href="#3-1-5-准备ingress资源清单" class="headerlink" title="3.1.5 准备ingress资源清单"></a>3.1.5 准备ingress资源清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;ingress.yaml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io&#x2F;ingress.class: traefik</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: prometheus.zq.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: &#x2F;</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: prometheus</span><br><span class="line">          servicePort: 9090</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="3-1-6-添加域名解析"><a href="#3-1-6-添加域名解析" class="headerlink" title="3.1.6 添加域名解析"></a>3.1.6 添加域名解析</h4><p>这里用到一个域名<code>prometheus.zq.com</code>，添加解析：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;var&#x2F;named&#x2F;od.com.zone</span><br><span class="line">prometheus         A    10.4.7.10</span><br><span class="line">systemctl restart named</span><br></pre></td></tr></table></figure><h3 id="3-2-部署prometheus-server"><a href="#3-2-部署prometheus-server" class="headerlink" title="3.2 部署prometheus server"></a>3.2 部署prometheus server</h3><h4 id="3-2-1-准备目录和证书"><a href="#3-2-1-准备目录和证书" class="headerlink" title="3.2.1 准备目录和证书"></a>3.2.1 准备目录和证书</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;data&#x2F;nfs-volume&#x2F;prometheus&#x2F;etc</span><br><span class="line">mkdir -p &#x2F;data&#x2F;nfs-volume&#x2F;prometheus&#x2F;prom-db</span><br><span class="line">cd &#x2F;data&#x2F;nfs-volume&#x2F;prometheus&#x2F;etc&#x2F;</span><br><span class="line"># 拷贝配置文件中用到的证书：</span><br><span class="line">cp &#x2F;opt&#x2F;certs&#x2F;ca.pem .&#x2F;</span><br><span class="line">cp &#x2F;opt&#x2F;certs&#x2F;client.pem .&#x2F;</span><br><span class="line">cp &#x2F;opt&#x2F;certs&#x2F;client-key.pem .&#x2F;</span><br></pre></td></tr></table></figure><h4 id="3-2-2-创建prometheus配置文件"><a href="#3-2-2-创建prometheus配置文件" class="headerlink" title="3.2.2 创建prometheus配置文件"></a>3.2.2 创建prometheus配置文件</h4><blockquote><p><strong>配置文件说明:</strong></p><p>此配置为通用配置,除第一个job<code>etcd</code>是做的静态配置外,其他8个job都是做的自动发现</p><p>因此只需要修改<code>etcd</code>的配置后,就可以直接用于生产环境</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;data&#x2F;nfs-volume&#x2F;prometheus&#x2F;etc&#x2F;prometheus.yml &lt;&lt;&#39;EOF&#39;</span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s</span><br><span class="line">  evaluation_interval: 15s</span><br><span class="line">scrape_configs:</span><br><span class="line">- job_name: &#39;etcd&#39;</span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: &#x2F;data&#x2F;etc&#x2F;ca.pem</span><br><span class="line">    cert_file: &#x2F;data&#x2F;etc&#x2F;client.pem</span><br><span class="line">    key_file: &#x2F;data&#x2F;etc&#x2F;client-key.pem</span><br><span class="line">  scheme: https</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets:</span><br><span class="line">    - &#39;10.4.7.12:2379&#39;</span><br><span class="line">    - &#39;10.4.7.21:2379&#39;</span><br><span class="line">    - &#39;10.4.7.22:2379&#39;</span><br><span class="line">  </span><br><span class="line">- job_name: &#39;kubernetes-apiservers&#39;</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: endpoints</span><br><span class="line">  scheme: https</span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: &#x2F;var&#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccount&#x2F;ca.crt</span><br><span class="line">  bearer_token_file: &#x2F;var&#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccount&#x2F;token</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class="line">    action: keep</span><br><span class="line">    regex: default;kubernetes;https</span><br><span class="line">  </span><br><span class="line">- job_name: &#39;kubernetes-pods&#39;</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">    action: keep</span><br><span class="line">    regex: true</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: __metrics_path__</span><br><span class="line">    regex: (.+)</span><br><span class="line">  - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="line">    action: replace</span><br><span class="line">    regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">    replacement: $1:$2</span><br><span class="line">    target_label: __address__</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_namespace</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_pod_name</span><br><span class="line">  </span><br><span class="line">- job_name: &#39;kubernetes-kubelet&#39;</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: node</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_node_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_node_name]</span><br><span class="line">    regex: (.+)</span><br><span class="line">    target_label: __address__</span><br><span class="line">    replacement: $&#123;1&#125;:10255</span><br><span class="line">  </span><br><span class="line">- job_name: &#39;kubernetes-cadvisor&#39;</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: node</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_node_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_node_name]</span><br><span class="line">    regex: (.+)</span><br><span class="line">    target_label: __address__</span><br><span class="line">    replacement: $&#123;1&#125;:4194</span><br><span class="line">  </span><br><span class="line">- job_name: &#39;kubernetes-kube-state&#39;</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_namespace</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_pod_name</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_label_grafanak8sapp]</span><br><span class="line">    regex: .*true.*</span><br><span class="line">    action: keep</span><br><span class="line">  - source_labels: [&#39;__meta_kubernetes_pod_label_daemon&#39;, &#39;__meta_kubernetes_pod_node_name&#39;]</span><br><span class="line">    regex: &#39;node-exporter;(.*)&#39;</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: nodename</span><br><span class="line">  </span><br><span class="line">- job_name: &#39;blackbox_http_pod_probe&#39;</span><br><span class="line">  metrics_path: &#x2F;probe</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  params:</span><br><span class="line">    module: [http_2xx]</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_blackbox_scheme]</span><br><span class="line">    action: keep</span><br><span class="line">    regex: http</span><br><span class="line">  - source_labels: [__address__, __meta_kubernetes_pod_annotation_blackbox_port,  __meta_kubernetes_pod_annotation_blackbox_path]</span><br><span class="line">    action: replace</span><br><span class="line">    regex: ([^:]+)(?::\d+)?;(\d+);(.+)</span><br><span class="line">    replacement: $1:$2$3</span><br><span class="line">    target_label: __param_target</span><br><span class="line">  - action: replace</span><br><span class="line">    target_label: __address__</span><br><span class="line">    replacement: blackbox-exporter.kube-system:9115</span><br><span class="line">  - source_labels: [__param_target]</span><br><span class="line">    target_label: instance</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_namespace</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_pod_name</span><br><span class="line">  </span><br><span class="line">- job_name: &#39;blackbox_tcp_pod_probe&#39;</span><br><span class="line">  metrics_path: &#x2F;probe</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  params:</span><br><span class="line">    module: [tcp_connect]</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_blackbox_scheme]</span><br><span class="line">    action: keep</span><br><span class="line">    regex: tcp</span><br><span class="line">  - source_labels: [__address__, __meta_kubernetes_pod_annotation_blackbox_port]</span><br><span class="line">    action: replace</span><br><span class="line">    regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">    replacement: $1:$2</span><br><span class="line">    target_label: __param_target</span><br><span class="line">  - action: replace</span><br><span class="line">    target_label: __address__</span><br><span class="line">    replacement: blackbox-exporter.kube-system:9115</span><br><span class="line">  - source_labels: [__param_target]</span><br><span class="line">    target_label: instance</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_namespace</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_pod_name</span><br><span class="line">  </span><br><span class="line">- job_name: &#39;traefik&#39;</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scheme]</span><br><span class="line">    action: keep</span><br><span class="line">    regex: traefik</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: __metrics_path__</span><br><span class="line">    regex: (.+)</span><br><span class="line">  - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="line">    action: replace</span><br><span class="line">    regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">    replacement: $1:$2</span><br><span class="line">    target_label: __address__</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_namespace</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_pod_name</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="3-2-3-应用资源配置清单"><a href="#3-2-3-应用资源配置清单" class="headerlink" title="3.2.3 应用资源配置清单"></a>3.2.3 应用资源配置清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;prometheus-server&#x2F;rbac.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;prometheus-server&#x2F;dp.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;prometheus-server&#x2F;svc.yaml</span><br><span class="line">kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;prometheus-server&#x2F;ingress.yaml</span><br></pre></td></tr></table></figure><h4 id="3-2-4-浏览器验证"><a href="#3-2-4-浏览器验证" class="headerlink" title="3.2.4 浏览器验证"></a>3.2.4 浏览器验证</h4><p>访问<a href="http://prometheus.zq.com,如果能成功访问的话,表示启动成功" target="_blank" rel="noopener">http://prometheus.zq.com,如果能成功访问的话,表示启动成功</a></p><p>点击<strong>status-&gt;configuration</strong>就是我们的配置文件</p><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601219938865-a380d765-1bde-4948-9878-46528803c465.png" alt="image"></p><h2 id="4-使服务能被prometheus自动监控"><a href="#4-使服务能被prometheus自动监控" class="headerlink" title="4 使服务能被prometheus自动监控"></a>4 使服务能被prometheus自动监控</h2><p>点击<strong>status-&gt;targets</strong>，展示的就是我们在prometheus.yml中配置的job-name，这些targets基本可以满足我们收集数据的需求。</p><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601219938915-db8767e1-361c-415d-bb55-b6f7bf37db50.png" alt="image"></p><blockquote><p>5个编号的job-name已经被发现并获取数据</p><p>接下来就需要将剩下的4个ob-name对应的服务纳入监控</p><p>纳入监控的方式是给需要收集数据的服务添加annotations</p></blockquote><h3 id="4-1-让traefik能被自动监控"><a href="#4-1-让traefik能被自动监控" class="headerlink" title="4.1 让traefik能被自动监控"></a>4.1 让traefik能被自动监控</h3><h4 id="4-1-1-修改traefik的yaml"><a href="#4-1-1-修改traefik的yaml" class="headerlink" title="4.1.1 修改traefik的yaml"></a>4.1.1 修改traefik的yaml</h4><p>修改fraefik的yaml文件,跟labels同级,添加annotations配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;data&#x2F;k8s-yaml&#x2F;traefik&#x2F;ds.yaml</span><br><span class="line">........</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: traefik-ingress</span><br><span class="line">        name: traefik-ingress</span><br><span class="line">#--------增加内容--------</span><br><span class="line">      annotations:</span><br><span class="line">        prometheus_io_scheme: &quot;traefik&quot;</span><br><span class="line">        prometheus_io_path: &quot;&#x2F;metrics&quot;</span><br><span class="line">        prometheus_io_port: &quot;8080&quot;</span><br><span class="line">#--------增加结束--------</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: traefik-ingress-controller</span><br><span class="line">........</span><br></pre></td></tr></table></figure><p>任意节点重新应用配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;traefik&#x2F;ds.yaml</span><br><span class="line">kubectl apply  -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;traefik&#x2F;ds.yaml</span><br></pre></td></tr></table></figure><h4 id="4-1-2-应用配置查看"><a href="#4-1-2-应用配置查看" class="headerlink" title="4.1.2 应用配置查看"></a>4.1.2 应用配置查看</h4><p>等待pod重启以后，再在prometheus上查看traefik是否能正常获取数据了</p><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601219938921-6fc54a66-c82d-4886-bcba-839ad5a311b2.png" alt="image"></p><h3 id="4-2-用blackbox检测TCP-HTTP服务状态"><a href="#4-2-用blackbox检测TCP-HTTP服务状态" class="headerlink" title="4.2 用blackbox检测TCP/HTTP服务状态"></a>4.2 用blackbox检测TCP/HTTP服务状态</h3><p>blackbox是检测容器内服务存活性的，也就是端口健康状态检查，分为tcp和http两种方法</p><p>能用http的情况尽量用http,没有提供http接口的服务才用tcp</p><h4 id="4-2-1-被检测服务准备"><a href="#4-2-1-被检测服务准备" class="headerlink" title="4.2.1 被检测服务准备"></a>4.2.1 被检测服务准备</h4><p>使用测试环境的dubbo服务来做演示,其他环境类似</p><ol><li>dashboard中开启apollo-portal和test空间中的apollo</li><li>dubbo-demo-service使用tcp的annotation</li><li>dubbo-demo-consumer使用HTTP的annotation</li></ol><h4 id="4-2-2-添加tcp的annotation"><a href="#4-2-2-添加tcp的annotation" class="headerlink" title="4.2.2 添加tcp的annotation"></a>4.2.2 添加tcp的annotation</h4><p>等两个服务起来以后，首先在dubbo-demo-service资源中添加一个TCP的annotation</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;data&#x2F;k8s-yaml&#x2F;test&#x2F;dubbo-demo-server&#x2F;dp.yaml</span><br><span class="line">......</span><br><span class="line">spec:</span><br><span class="line">......</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: dubbo-demo-service</span><br><span class="line">        name: dubbo-demo-service</span><br><span class="line">#--------增加内容--------</span><br><span class="line">      annotations:</span><br><span class="line">        blackbox_port: &quot;20880&quot;</span><br><span class="line">        blackbox_scheme: &quot;tcp&quot;</span><br><span class="line">#--------增加结束--------</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        image: harbor.zq.com&#x2F;app&#x2F;dubbo-demo-service:apollo_200512_0746</span><br></pre></td></tr></table></figure><p>任意节点重新应用配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;test&#x2F;dubbo-demo-server&#x2F;dp.yaml</span><br><span class="line">kubectl apply  -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;test&#x2F;dubbo-demo-server&#x2F;dp.yaml</span><br></pre></td></tr></table></figure><p>浏览器中查看<a href="http://blackbox.zq.com/和http://prometheus.zq.com/targets" target="_blank" rel="noopener">http://blackbox.zq.com/和http://prometheus.zq.com/targets</a></p><p>我们运行的dubbo-demo-server服务,tcp端口20880已经被发现并在监控中</p><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601219938915-2fc3c386-8185-4e5a-9692-86524c14201e.png" alt="image"></p><h4 id="4-2-3-添加http的annotation"><a href="#4-2-3-添加http的annotation" class="headerlink" title="4.2.3 添加http的annotation"></a>4.2.3 添加http的annotation</h4><p>接下来在dubbo-demo-consumer资源中添加一个HTTP的annotation：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;data&#x2F;k8s-yaml&#x2F;test&#x2F;dubbo-demo-consumer&#x2F;dp.yaml </span><br><span class="line">spec:</span><br><span class="line">......</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: dubbo-demo-consumer</span><br><span class="line">        name: dubbo-demo-consumer</span><br><span class="line">#--------增加内容--------</span><br><span class="line">      annotations:</span><br><span class="line">        blackbox_path: &quot;&#x2F;hello?name&#x3D;health&quot;</span><br><span class="line">        blackbox_port: &quot;8080&quot;</span><br><span class="line">        blackbox_scheme: &quot;http&quot;</span><br><span class="line">#--------增加结束--------</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: dubbo-demo-consumer</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>任意节点重新应用配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;test&#x2F;dubbo-demo-consumer&#x2F;dp.yaml</span><br><span class="line">kubectl apply  -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;test&#x2F;dubbo-demo-consumer&#x2F;dp.yaml</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601219938954-b889a59e-91de-4c2b-85b7-36f390c529ad.png" alt="image"></p><h3 id="4-3-添加监控jvm信息"><a href="#4-3-添加监控jvm信息" class="headerlink" title="4.3 添加监控jvm信息"></a>4.3 添加监控jvm信息</h3><p>dubbo-demo-service和dubbo-demo-consumer都添加下列annotation注解,以便监控pod中的jvm信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;data&#x2F;k8s-yaml&#x2F;test&#x2F;dubbo-demo-server&#x2F;dp.yaml</span><br><span class="line">vim &#x2F;data&#x2F;k8s-yaml&#x2F;test&#x2F;dubbo-demo-consumer&#x2F;dp.yaml </span><br><span class="line">      annotations:</span><br><span class="line">        #....已有略....</span><br><span class="line">        prometheus_io_scrape: &quot;true&quot;</span><br><span class="line">        prometheus_io_port: &quot;12346&quot;</span><br><span class="line">        prometheus_io_path: &quot;&#x2F;&quot;</span><br></pre></td></tr></table></figure><blockquote><p>12346是dubbo的POD启动命令中使用jmx_javaagent用到的端口,因此可以用来收集jvm信息</p></blockquote><p>任意节点重新应用配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply  -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;test&#x2F;dubbo-demo-server&#x2F;dp.yaml</span><br><span class="line">kubectl apply  -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;test&#x2F;dubbo-demo-consumer&#x2F;dp.yaml</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601219938896-309a3f84-71c6-4d02-8245-4d782ee272af.png" alt="image"></p><p><strong>至此,所有9个服务,都获取了数据</strong></p><pre><code></code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;h1 id=&quot;k8s监控实战-部署prometheus&quot;&gt;&lt;a href=&quot;#k8s监控实战-部署prometheus&quot; class=&quot;headerlink&quot; title=&quot;k8s监控实战-部署prometheus&quot;&gt;&lt;/a&gt;k8s监控实战-部署prometheus&lt;
      
    
    </summary>
    
    
      <category term="k8s" scheme="http://yoursite.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="http://yoursite.com/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>K8S(06)web管理方式-dashboard</title>
    <link href="http://yoursite.com/2020/12/26/k8s/8/"/>
    <id>http://yoursite.com/2020/12/26/k8s/8/</id>
    <published>2020-12-26T07:57:13.551Z</published>
    <updated>2020-12-26T07:57:13.544Z</updated>
    
    <content type="html"><![CDATA[<hr><h1 id="K8S的web管理方式-dashboard"><a href="#K8S的web管理方式-dashboard" class="headerlink" title="K8S的web管理方式-dashboard"></a>K8S的web管理方式-dashboard</h1><p>目录</p><ul><li><p>K8S的web管理方式-dashboard</p></li><li><ul><li>1 部署dashboard</li></ul></li><li><ul><li><ul><li>1.1 获取dashboard镜像</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>1.1.1 获取1.8.3版本的dsashboard</li><li>1.1.2 获取1.10.1版本的dashboard</li><li>1.1.3 为何要两个版本的dashbosrd</li></ul></li></ul></li></ul></li><li><ul><li><ul><li>1.2 创建dashboard资源配置清单</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>1.2.1 创建rbca授权清单</li><li>1.2.2 创建depoloy清单</li><li>1.2.3 创建service清单</li><li>1.2.4 创建ingress清单暴露服务</li></ul></li></ul></li></ul></li><li><ul><li><ul><li>1.3 创建相关资源</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>1.3.1 在任意node上创建</li><li>1.3.2 添加域名解析</li><li>1.3.3 通过浏览器验证</li></ul></li></ul></li></ul></li><li><ul><li>2 升级dashboard版本</li></ul></li><li><ul><li><ul><li>2.1 把版本换成1.10以上版本</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>2.1.1 在线修改直接使用</li><li>2.2.2 等待滚动发布</li><li>2.2.3 刷新dashboard页面：</li></ul></li></ul></li></ul></li><li><ul><li><ul><li>2.2 使用token登录</li></ul></li></ul></li><li><ul><li><ul><li><ul><li>2.2.1 首先获取secret资源列表</li><li>2.2.2 获取角色的详情</li><li>2.2.3 申请证书</li><li>2.2.4 前端nginx服务部署证书</li><li>2.2.5 再次登录dashboard</li></ul></li></ul></li></ul></li><li><ul><li><ul><li>2.3 授权细则思考</li></ul></li></ul></li></ul><p>dashboard是k8s的可视化管理平台，是三种管理k8s集群方法之一</p><h2 id="1-部署dashboard"><a href="#1-部署dashboard" class="headerlink" title="1 部署dashboard"></a>1 部署dashboard</h2><h3 id="1-1-获取dashboard镜像"><a href="#1-1-获取dashboard镜像" class="headerlink" title="1.1 获取dashboard镜像"></a>1.1 获取dashboard镜像</h3><p>获取镜像和创建资源配置清单的操作,还是老规矩:<code>7.200</code>上操作</p><h4 id="1-1-1-获取1-8-3版本的dsashboard"><a href="#1-1-1-获取1-8-3版本的dsashboard" class="headerlink" title="1.1.1 获取1.8.3版本的dsashboard"></a>1.1.1 获取1.8.3版本的dsashboard</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull k8scn&#x2F;kubernetes-dashboard-amd64:v1.8.3</span><br><span class="line">docker tag  k8scn&#x2F;kubernetes-dashboard-amd64:v1.8.3 harbor.zq.com&#x2F;public&#x2F;dashboard:v1.8.3</span><br><span class="line">docker push harbor.zq.com&#x2F;public&#x2F;dashboard:v1.8.3</span><br></pre></td></tr></table></figure><h4 id="1-1-2-获取1-10-1版本的dashboard"><a href="#1-1-2-获取1-10-1版本的dashboard" class="headerlink" title="1.1.2 获取1.10.1版本的dashboard"></a>1.1.2 获取1.10.1版本的dashboard</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull loveone&#x2F;kubernetes-dashboard-amd64:v1.10.1</span><br><span class="line">docker tag  loveone&#x2F;kubernetes-dashboard-amd64:v1.10.1 harbor.zq.com&#x2F;public&#x2F;dashboard:v1.10.1</span><br><span class="line">docker push harbor.zq.com&#x2F;public&#x2F;dashboard:v1.10.1</span><br></pre></td></tr></table></figure><h4 id="1-1-3-为何要两个版本的dashbosrd"><a href="#1-1-3-为何要两个版本的dashbosrd" class="headerlink" title="1.1.3 为何要两个版本的dashbosrd"></a>1.1.3 为何要两个版本的dashbosrd</h4><ul><li>1.8.3版本授权不严格,方便学习使用</li><li>1.10.1版本授权严格,学习使用麻烦,但生产需要</li></ul><h3 id="1-2-创建dashboard资源配置清单"><a href="#1-2-创建dashboard资源配置清单" class="headerlink" title="1.2 创建dashboard资源配置清单"></a>1.2 创建dashboard资源配置清单</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;data&#x2F;k8s-yaml&#x2F;dashboard</span><br></pre></td></tr></table></figure><h4 id="1-2-1-创建rbca授权清单"><a href="#1-2-1-创建rbca授权清单" class="headerlink" title="1.2.1 创建rbca授权清单"></a>1.2.1 创建rbca授权清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;data&#x2F;k8s-yaml&#x2F;dashboard&#x2F;rbac.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="1-2-2-创建depoloy清单"><a href="#1-2-2-创建depoloy清单" class="headerlink" title="1.2.2 创建depoloy清单"></a>1.2.2 创建depoloy清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;data&#x2F;k8s-yaml&#x2F;dashboard&#x2F;dp.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kubernetes-dashboard</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kubernetes-dashboard</span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io&#x2F;critical-pod: &#39;&#39;</span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      containers:</span><br><span class="line">      - name: kubernetes-dashboard</span><br><span class="line">        image: harbor.zq.com&#x2F;public&#x2F;dashboard:v1.8.3</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 300Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 50m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8443</span><br><span class="line">          protocol: TCP</span><br><span class="line">        args:</span><br><span class="line">          # PLATFORM-SPECIFIC ARGS HERE</span><br><span class="line">          - --auto-generate-certificates</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: tmp-volume</span><br><span class="line">          mountPath: &#x2F;tmp</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            scheme: HTTPS</span><br><span class="line">            path: &#x2F;</span><br><span class="line">            port: 8443</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          timeoutSeconds: 30</span><br><span class="line">      volumes:</span><br><span class="line">      - name: tmp-volume</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      serviceAccountName: kubernetes-dashboard-admin</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: &quot;CriticalAddonsOnly&quot;</span><br><span class="line">        operator: &quot;Exists&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="1-2-3-创建service清单"><a href="#1-2-3-创建service清单" class="headerlink" title="1.2.3 创建service清单"></a>1.2.3 创建service清单</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;data&#x2F;k8s-yaml&#x2F;dashboard&#x2F;svc.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  ports:</span><br><span class="line">  - port: 443</span><br><span class="line">    targetPort: 8443</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="1-2-4-创建ingress清单暴露服务"><a href="#1-2-4-创建ingress清单暴露服务" class="headerlink" title="1.2.4 创建ingress清单暴露服务"></a>1.2.4 创建ingress清单暴露服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;data&#x2F;k8s-yaml&#x2F;dashboard&#x2F;ingress.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io&#x2F;ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: dashboard.zq.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: kubernetes-dashboard</span><br><span class="line">          servicePort: 443</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="1-3-创建相关资源"><a href="#1-3-创建相关资源" class="headerlink" title="1.3 创建相关资源"></a>1.3 创建相关资源</h3><h4 id="1-3-1-在任意node上创建"><a href="#1-3-1-在任意node上创建" class="headerlink" title="1.3.1 在任意node上创建"></a>1.3.1 在任意node上创建</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;dashboard&#x2F;rbac.yaml</span><br><span class="line">kubectl create -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;dashboard&#x2F;dp.yaml</span><br><span class="line">kubectl create -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;dashboard&#x2F;svc.yaml</span><br><span class="line">kubectl create -f http:&#x2F;&#x2F;k8s-yaml.zq.com&#x2F;dashboard&#x2F;ingress.yaml</span><br></pre></td></tr></table></figure><h4 id="1-3-2-添加域名解析"><a href="#1-3-2-添加域名解析" class="headerlink" title="1.3.2 添加域名解析"></a>1.3.2 添加域名解析</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;var&#x2F;named&#x2F;zq.com.zone</span><br><span class="line">dashboard          A    10.4.7.10</span><br><span class="line"># 注意前滚serial编号</span><br><span class="line">systemctl restart named</span><br></pre></td></tr></table></figure><h4 id="1-3-3-通过浏览器验证"><a href="#1-3-3-通过浏览器验证" class="headerlink" title="1.3.3 通过浏览器验证"></a>1.3.3 通过浏览器验证</h4><p>在本机浏览器上访问<code>http://dashboard.zq.com</code>,如果出来web界面,表示部署成功</p><p>可以看到安装1.8版本的dashboard，默认是可以跳过验证的：</p><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601204047384-94dc3835-a308-4cea-85a2-b5ceff9a42c9.png" alt="image"></p><h2 id="2-升级dashboard版本"><a href="#2-升级dashboard版本" class="headerlink" title="2 升级dashboard版本"></a>2 升级dashboard版本</h2><p>跳过登录是不科学的，因为我们在配置dashboard的rbac权限时，绑定的角色是system:admin，这个是集群管理员的角色，权限很大，如果任何人都可跳过登录直接使用,那你就等着背锅吧</p><h3 id="2-1-把版本换成1-10以上版本"><a href="#2-1-把版本换成1-10以上版本" class="headerlink" title="2.1 把版本换成1.10以上版本"></a>2.1 把版本换成1.10以上版本</h3><p>在前面我们已经同时下载了1.10.1版本的docker镜像</p><h4 id="2-1-1-在线修改直接使用"><a href="#2-1-1-在线修改直接使用" class="headerlink" title="2.1.1 在线修改直接使用"></a>2.1.1 在线修改直接使用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit deploy kubernetes-dashboard -n kube-system</span><br></pre></td></tr></table></figure><h4 id="2-2-2-等待滚动发布"><a href="#2-2-2-等待滚动发布" class="headerlink" title="2.2.2 等待滚动发布"></a>2.2.2 等待滚动发布</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl -n kube-system get pod|grep dashboard</span><br><span class="line">kubernetes-dashboard-5bccc5946b-vgk5n   1&#x2F;1     Running       0          20s</span><br><span class="line">kubernetes-dashboard-b75bfb487-h7zft    0&#x2F;1     Terminating   0          2m27s</span><br><span class="line">[root@hdss7-21 ~]# kubectl -n kube-system get pod|grep dashboard</span><br><span class="line">kubernetes-dashboard-5bccc5946b-vgk5n   1&#x2F;1     Running   0          52s</span><br></pre></td></tr></table></figure><h4 id="2-2-3-刷新dashboard页面："><a href="#2-2-3-刷新dashboard页面：" class="headerlink" title="2.2.3 刷新dashboard页面："></a>2.2.3 刷新dashboard页面：</h4><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601204047500-c1ac6c4c-07b5-4209-a821-9a217a7ffa63.png" alt="image"></p><p>可以看到这里原来的skip跳过已经没有了，我们如果想登陆，必须输入token，那我们如何获取token呢：</p><h3 id="2-2-使用token登录"><a href="#2-2-使用token登录" class="headerlink" title="2.2 使用token登录"></a>2.2 使用token登录</h3><h4 id="2-2-1-首先获取secret资源列表"><a href="#2-2-1-首先获取secret资源列表" class="headerlink" title="2.2.1 首先获取secret资源列表"></a>2.2.1 首先获取<code>secret</code>资源列表</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secret  -n kube-system</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601204047326-4c00405b-d778-4d37-b19e-7d1c5e2d8aa5.png" alt="image"></p><h4 id="2-2-2-获取角色的详情"><a href="#2-2-2-获取角色的详情" class="headerlink" title="2.2.2 获取角色的详情"></a>2.2.2 获取角色的详情</h4><p>列表中有很多角色,不同到角色有不同的权限,找到想要的角色<code>dashboard-admin</code>后,再用describe命令获取详情</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system describe secrets kubernetes-dashboard-admin-token-85gmd</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601204047339-9035a2fe-7c4b-4f65-9399-707aecde4b33.png" alt="image"></p><p>找到详情中的token字段,就是我们需要用来登录的东西</p><p>拿到token去尝试登录,发现仍然登录不了,因为必须使用https登录,所以需要申请证书</p><h4 id="2-2-3-申请证书"><a href="#2-2-3-申请证书" class="headerlink" title="2.2.3 申请证书"></a>2.2.3 申请证书</h4><p>申请证书在<code>7.200</code>主机上</p><p><strong>创建json文件:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;certs&#x2F;</span><br><span class="line">cat &gt;&#x2F;opt&#x2F;certs&#x2F;dashboard-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;*.zq.com&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;zq&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p><strong>申请证书</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca&#x3D;ca.pem \</span><br><span class="line">      -ca-key&#x3D;ca-key.pem \</span><br><span class="line">      -config&#x3D;ca-config.json \</span><br><span class="line">      -profile&#x3D;server \</span><br><span class="line">      dashboard-csr.json |cfssl-json -bare dashboard</span><br></pre></td></tr></table></figure><p><strong>查看申请的证书</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# ll |grep dash</span><br><span class="line">-rw-r--r-- 1 root root  993 May  4 12:08 dashboard.csr</span><br><span class="line">-rw-r--r-- 1 root root  280 May  4 12:08 dashboard-csr.json</span><br><span class="line">-rw------- 1 root root 1675 May  4 12:08 dashboard-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1359 May  4 12:08 dashboard.pem</span><br></pre></td></tr></table></figure><h4 id="2-2-4-前端nginx服务部署证书"><a href="#2-2-4-前端nginx服务部署证书" class="headerlink" title="2.2.4 前端nginx服务部署证书"></a>2.2.4 前端nginx服务部署证书</h4><p>在<code>7.11</code>,<code>7.12</code>两个前端代理上,都做相同操作</p><p><strong>拷贝证书:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;etc&#x2F;nginx&#x2F;certs</span><br><span class="line">scp 10.4.7.200:&#x2F;opt&#x2F;certs&#x2F;dashboard.pem &#x2F;etc&#x2F;nginx&#x2F;certs</span><br><span class="line">scp 10.4.7.200:&#x2F;opt&#x2F;certs&#x2F;dashboard-key.pem &#x2F;etc&#x2F;nginx&#x2F;certs</span><br></pre></td></tr></table></figure><p><strong>创建nginx配置</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;dashboard.zq.com.conf &lt;&lt;&#39;EOF&#39;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  dashboard.zq.com;</span><br><span class="line">    rewrite ^(.*)$ https:&#x2F;&#x2F;$&#123;server_name&#125;$1 permanent;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       443 ssl;</span><br><span class="line">    server_name  dashboard.zq.com;</span><br><span class="line">    ssl_certificate     &quot;certs&#x2F;dashboard.pem&quot;;</span><br><span class="line">    ssl_certificate_key &quot;certs&#x2F;dashboard-key.pem&quot;;</span><br><span class="line">    ssl_session_cache shared:SSL:1m;</span><br><span class="line">    ssl_session_timeout  10m;</span><br><span class="line">    ssl_ciphers HIGH:!aNULL:!MD5;</span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;default_backend_traefik;</span><br><span class="line">        proxy_set_header Host       $http_host;</span><br><span class="line">        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p><strong>重启nginx服务</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nginx -t</span><br><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure><h4 id="2-2-5-再次登录dashboard"><a href="#2-2-5-再次登录dashboard" class="headerlink" title="2.2.5 再次登录dashboard"></a>2.2.5 再次登录dashboard</h4><p>刷新页面后,再次使用前面的token登录,可以成功登录进去了</p><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2511954/1601204047482-1b9839d4-faa7-47a7-956c-c7f335eca9d0.png" alt="image"></p><h3 id="2-3-授权细则思考"><a href="#2-3-授权细则思考" class="headerlink" title="2.3 授权细则思考"></a>2.3 授权细则思考</h3><p>登录是登录了，但是我们要思考一个问题，我们使用rbac授权来访问dashboard,如何做到权限精细化呢？比如开发，只能看，不能摸，不同的项目组，看到的资源应该是不一样的，测试看到的应该是测试相关的资源</p><p>转载自cnblog：<a href="https://www.cnblogs.com/noah-luo/p/13345229.html" target="_blank" rel="noopener">https://www.cnblogs.com/noah-luo/p/13345229.html</a></p><pre><code></code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;h1 id=&quot;K8S的web管理方式-dashboard&quot;&gt;&lt;a href=&quot;#K8S的web管理方式-dashboard&quot; class=&quot;headerlink&quot; title=&quot;K8S的web管理方式-dashboard&quot;&gt;&lt;/a&gt;K8S的web管理方式-dashbo
      
    
    </summary>
    
    
      <category term="k8s" scheme="http://yoursite.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="http://yoursite.com/tags/k8s/"/>
    
  </entry>
  
</feed>
