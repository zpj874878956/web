<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="zpj" type="application/atom+xml" />






<meta name="description" content="愿你在任何困难面前都足够坚强">
<meta property="og:type" content="website">
<meta property="og:title" content="zpj">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="zpj">
<meta property="og:description" content="愿你在任何困难面前都足够坚强">
<meta property="article:author" content="zhangpengjie">
<meta property="article:tag" content="加油">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>zpj</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<!-- 加入APlayer音乐播放器 -->
<link rel="stylesheet" href="/dist/APlayer.min.css">
<div id="aplayer"></div>
<script type="text/javascript" src="/dist/APlayer.min.js"></script>
<script type="text/javascript" src="/dist/music.js"></script>

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zpj</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">好好学习天天向上</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/06/18/elk%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhangpengjie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/zpj.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zpj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/06/18/elk%E5%AE%89%E8%A3%85/" itemprop="url">elk安装</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-18T17:50:00+08:00">
                2021-06-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/elk/" itemprop="url" rel="index">
                    <span itemprop="name">elk</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/06/18/elk%E5%AE%89%E8%A3%85/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2021/06/18/elk%E5%AE%89%E8%A3%85/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>ELK服务部署</p>
<ol>
<li>官网下载对应版本的二进制压缩包</li>
</ol>
<p>elasticsearch 官网下载地址：<br><a href="https://www.elastic.co/cn/downloads/elasticsearch" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/elasticsearch</a><br>elasticsearch 历史版本下载地址：<br> <a href="https://www.elastic.co/cn/downloads/past-releases#elasticsearch" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/past-releases#elasticsearch</a></p>
<p>kinbana 官网下载地址：<br><a href="https://www.elastic.co/cn/downloads/kibana" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/kibana</a><br>kinbana 历史版本下载地址：<br><a href="https://www.elastic.co/cn/downloads/past-releases#kibana" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/past-releases#kibana</a></p>
<p>logstash 官网下载地址：<br><a href="https://www.elastic.co/cn/downloads/logstash" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/logstash</a><br>logstash 历史版本下载地址：<br><a href="https://www.elastic.co/cn/downloads/past-releases" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/past-releases</a></p>
<ol start="2">
<li>解压、准备工作、启动ELK</li>
</ol>
<p>elasticsearch.tar.gz文件解压</p>
<p>tar -zxvf 就可以啦<br>太基础的废话命令就不罗列啦，主要是提几个关键的细节的点<br>比如elasticsearch部署的时候需要注意：</p>
<ol>
<li>使用普通用户</li>
<li>开启max_map_count</li>
<li>设置对应普通用户limit.conf</li>
<li>useradd -d /data/es es &amp;&amp;echo es | passwd –stdin es</li>
<li>echo “vm.max_map_count=655360” &gt;&gt; /etc/sysctl.conf</li>
<li>echo “es soft nofile 655350” &gt;&gt; /etc/security/limits.conf &amp;&amp; echo “es hard nofile 655350” &gt;&gt; /etc/security/limits.conf<br>sysctl -p 刷新一下另其生效</li>
</ol>
<p>然后准备个对应的jdk配置个全局的环境变量：<br>JAVA_HOME=/opt/jdk1.8.0_65<br>PATH=$JAVA_HOME/bin:$PATH<br>CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar<br>追加至系统环境变量文件尾部即可或者普通用户的<br>/etc/profile<br>.bash_profile<br>.bashrc<br>然后给刷新一下环境变量或者exit退出用户重新登录即可刷新<br>登录普通用户记得带上杠表示带着普通用户的环境变量呢 su - es<br>source /etc/profile<br>当我使用elasticsearch-no-jdk-7.9.6.tar.gz版本包时,启动提示要找本地普通用户家目录下面的java<br>例如上面的es用户 elastic为解压包<br>/data/es/elastic/jdk/bin/java<br>配置了全局的环境变量 指定目录的opt jdk java都不行还要去找上面目录的java<br>此时我们可以懒得理他直接根据启动log错误信息解决即可啦<br>使用“小大招”直接软连接射过去就好啦<br>当然前提对应的elastic解压包目录要创建对应的log提示的路劲目录 不然软连接找不到上一层目录无法创建哒<br>mkdir -p /data/es/elastic/jdk/bin/<br>ln -sf /opt/jdk/java/bin/java /data/es/elastic/jdk/bin/</p>
<p>然后配置改吧改吧修改修改elasticsearch.yml文件<br>cat elasticsearch/config/elasticsearch.yml<br>cluster.name: pengge<br>#bootstrap.mlockall: true<br>thread_pool.search.size: 10<br>thread_pool.search.queue_size: 3000<br>thread_pool.bulk.size: 5<br>thread_pool.bulk.queue_size: 2000<br>thread_pool.index.size: 5<br>thread_pool.index.queue_size: 1500<br>node.name: node-pengge<br>cluster.initial_master_nodes: [“node-pengge”]<br>path.data: /data/es/elastic/data<br>path.logs: /data/elastic/logs<br>network.host: 192.168.108.8<br>http.port: 9200<br>transport.tcp.port: 9300<br>transport.tcp.compress: false<br>discovery.zen.ping.unicast.hosts: [“192.168.108.8”, “192.168.108.9”, “192.168.108.10”]</p>
<p>然后就可以启动es节点啦，上面实例yml配置文件是配置的三节点集群，多节点集群也是一样的道理逗号添加集群节点ip即可啦，简简单单部署那是十分的轻松啦<br> ./elasticsearch &amp;&gt; esstart.log &amp; &amp;&amp; tail -f esstart.log<br>直接sh或者./启动二进制脚本&amp;&gt;将屏幕标准正确错误输出输出至本地目录的esstart.log命名的启动日志文件内，同时使用tail -f 观察es服务启动情况即可</p>
<p>下面附上一些基础的es查询语句：<br>命令行get方式查询，pengge为示例索引名称<br>curl 192.168.108.8:9200/_cat/indices<br>curl 192.168.108.8:9200/_cat/health<br>curl 192.168.108.8:9200/_cat/nodes<br>curl 192.168.108.8:9200/_cat/shards<br>curl 192.168.108.8:9200/_cat/allocation<br>curl 192.168.108.8:9200/pengge/_count<br>curl 192.168.108.8:9200/pengge/_search<br>kibana页面方式查询：<br>GET _cat/indices<br>GET _cat/health<br>GET _cat/nodes<br>GET _cat/shards<br>GET _cat/allocation<br>GET /pengge/_count<br>GET /pengge/_search</p>
<p>删除索引<br>DELETE pengge*<br>删除索引内的指定字段，一定注意删除字段是这个动作参数哦：_update_by_query<br>删除字段：@timestamp<br>POST /pengge/_update_by_query<br>{<br>  “script”: {<br>    “inline”: “ctx._source.remove(‘@timestamp’)”,<br>    “lang”: “painless”<br>  },<br>  “query”: {<br>    “bool”: {<br>      “must”: [<br>        {<br>          “exists”: {<br>            “field”: “@timestamp”<br>          }<br>        }<br>      ]<br>    }<br>  }<br>}</p>
<p>至此elasticsearch服务就简简单单的启动成功啦</p>
<p>至于kibana、logstash一样的道理简单解压./启动即可啦<br>不在废话叙述啦<br>简单配置个es 9200读取的节点就可以了如下：<br>[root@zabbix config]# egrep -v “#|^$” kibana.yml<br>server.port: 5601<br>server.host: “192.168.108.143”<br>elasticsearch.hosts: [“<a href="http://192.168.108.9:9200&quot;]">http://192.168.108.9:9200&quot;]</a></p>
<p>./kibana &amp;&gt; start.log &amp; &amp;&amp; tail -f start.log<br>logstash的话主要就是为了针对log日志文件或者txt csv等源数据文件进行整理汇总切割推送给es从而在kibana展示，细节东西下篇文章进行讲解，本期内容就简简单单写写部署启动完事啦<br>logstash配置的job conf文件可以使用-t参数简单配置的字段语法是否正确如下：<br>[root@zabbix bin]# ./logstash -f job/csv-es-debug.conf -t<br>Sending Logstash logs to /data/kinbana/logstash7.8.1/logstash-7.8.1/logs which is now configured via log4j2.properties<br>[2021-03-09T15:24:03,282][WARN ][logstash.config.source.multilocal] Ignoring the ‘pipelines.yml’ file because modules or command line options are specified<br>[2021-03-09T15:24:05,485][INFO ][org.reflections.Reflections] Reflections took 46 ms to scan 1 urls, producing 21 keys and 41 values<br>Configuration OK<br>[2021-03-09T15:24:06,291][INFO ][logstash.runner          ] Using config.test_and_exit mode. Config Validation Result: OK. Exiting Logstash<br>完事就可以-f指定 &amp; 放入后台进行运行使用可爱的logstash啦~</p>
<p>原文链接：<a href="https://blog.csdn.net/pengge2/article/details/114533789" target="_blank" rel="noopener">https://blog.csdn.net/pengge2/article/details/114533789</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/05/14/ansible/Ansible%E4%B8%AD%E7%9A%84playbook%20%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhangpengjie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/zpj.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zpj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/14/ansible/Ansible%E4%B8%AD%E7%9A%84playbook%20%E8%AF%A6%E8%A7%A3/" itemprop="url">playbook详解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-14T12:50:34+08:00">
                2021-05-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ansible/" itemprop="url" rel="index">
                    <span itemprop="name">ansible</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/05/14/ansible/Ansible%E4%B8%AD%E7%9A%84playbook%20%E8%AF%A6%E8%A7%A3/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2021/05/14/ansible/Ansible%E4%B8%AD%E7%9A%84playbook%20%E8%AF%A6%E8%A7%A3/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Ansible-中的-playbook-详解"><a href="#Ansible-中的-playbook-详解" class="headerlink" title="Ansible 中的 playbook 详解"></a><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html" target="_blank" rel="noopener">Ansible 中的 playbook 详解</a></h1><p>目录</p>
<ul>
<li>一、playbook<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#11-playbook是什么" target="_blank" rel="noopener">1.1 playbook是什么</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#12-playbook的语法结构" target="_blank" rel="noopener">1.2 playbook的语法结构</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#13-限定主机范围执行" target="_blank" rel="noopener">1.3 限定主机范围执行</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#14-ansible-palybook的小技巧" target="_blank" rel="noopener">1.4 ansible-palybook的小技巧</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#15-ansible-playbook中的handlers" target="_blank" rel="noopener">1.5 ansible-playbook中的handlers</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#16-使用handlers的注意事项" target="_blank" rel="noopener">1.6 使用handlers的注意事项</a></li>
</ul>
</li>
<li>二、变量<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#21-playbook中的变量" target="_blank" rel="noopener">2.1 playbook中的变量</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#22-playbook中使用vars代码块定义变量" target="_blank" rel="noopener">2.2 playbook中使用vars代码块定义变量</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#23-使用独立的文件来定义playbook变量" target="_blank" rel="noopener">2.3 使用独立的文件来定义playbook变量</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#24-inventory文件中的变量" target="_blank" rel="noopener">2.4 inventory文件中的变量</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#25-主机变量和组变量" target="_blank" rel="noopener">2.5 主机变量和组变量</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#26-巧用主机变量和组变量" target="_blank" rel="noopener">2.6 巧用主机变量和组变量</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#27-注册变量" target="_blank" rel="noopener">2.7 注册变量</a></li>
</ul>
</li>
<li>三、高阶变量<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#31-fasts变量信息" target="_blank" rel="noopener">3.1 fasts变量信息</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#32-本地facts变量" target="_blank" rel="noopener">3.2 本地facts变量</a></li>
</ul>
</li>
<li>四、if/when/while流程控制语句<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#41-when条件判断" target="_blank" rel="noopener">4.1 when条件判断</a></li>
</ul>
</li>
<li>五、任务间的流程控制<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#51-任务委托" target="_blank" rel="noopener">5.1 任务委托</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#52-任务暂停" target="_blank" rel="noopener">5.2 任务暂停</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#53-交互式提示" target="_blank" rel="noopener">5.3 交互式提示</a></li>
</ul>
</li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#六、tags标签" target="_blank" rel="noopener">六、tags标签</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html#七、block块" target="_blank" rel="noopener">七、Block块</a></li>
</ul>
<h3 id="一、playbook"><a href="#一、playbook" class="headerlink" title="一、playbook"></a>一、playbook</h3><h4 id="1-1-playbook是什么"><a href="#1-1-playbook是什么" class="headerlink" title="1.1 playbook是什么"></a>1.1 playbook是什么</h4><p>根本上说playbook和shell脚本没有任何的区别，playbook就像shell一样，也是把一堆的命令组合起来，然后加入对应条件判断等等，在shell脚本中是一条一条的命令，而在playbook中是一个一个的task任务构成，每个task任务可以看做shell中的一条命令；shell脚本一般只是在当前服务器上执行，而playbook则是在不止一个服务器上执行，因此playbook需要在其中指定运行该playbook的服务器名。</p>
<h4 id="1-2-playbook的语法结构"><a href="#1-2-playbook的语法结构" class="headerlink" title="1.2 playbook的语法结构"></a>1.2 playbook的语法结构</h4><p>playbook使用yml标记语言，这是一种标记语言，这种标记语言在文件的最开始需要使用三个“-”来说明文件开始，然后使用缩进来说明代码块的范围。下面通过一个简易的实例，来说明playbook的语法。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">---</span>      <span class="comment"># 标记文件的开始</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span>   <span class="comment"># 指定该playbook在哪个服务器上执行</span></span><br><span class="line">  <span class="attr">vars:</span>         <span class="comment"># 表示下面是定义的变量，</span></span><br><span class="line">    <span class="attr">http_port:</span> <span class="number">80</span>    <span class="comment"># 变量的形式，key: value，这里http_port是变量名，80是值</span></span><br><span class="line">    <span class="attr">max_clients:</span> <span class="number">200</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span>  <span class="comment"># 指定远程的用户名，这里缩进和vars保持了一致，说明变量的代码块已经结束。</span></span><br><span class="line">  <span class="attr">tasks:</span>  <span class="comment"># 下面构成playbook的tasks，每个task都有 - name: 开始，name指定该任务的名称。</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">at</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span>  <span class="comment"># 指定该任务的名称。</span></span><br><span class="line">    <span class="attr">yum:</span> <span class="string">pkg=httpd</span> <span class="string">state=latest</span>  <span class="comment"># yum说明要是用的模板名称，后面指定对应的参数，这两行结合起来就相当于一个shell命令。</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">write</span> <span class="string">the</span> <span class="string">apache</span> <span class="string">config</span> <span class="string">file</span>      <span class="comment"># 每个task之间可以使用空行来做区分。</span></span><br><span class="line">    <span class="attr">template:</span> <span class="string">src=/srv/httpd.j2</span> <span class="string">dest=/etc/httpd.conf</span></span><br></pre></td></tr></table></figure>

<p>需要说明的是缩进的意义和python中缩进的意义是一样，是来区分代码块的。</p>
<p><strong>一个简单的实例：检查MySQL的运行状态</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">   <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">   <span class="attr">gather_facts:</span> <span class="literal">no</span>   <span class="comment"># 不收集对应主机的信息，这样运行会快点。</span></span><br><span class="line">   <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">check</span> <span class="string">the</span> <span class="string">mysql</span> <span class="string">stauts</span></span><br><span class="line">       <span class="attr">service:</span> <span class="string">name=mysqld</span> <span class="string">state=running</span></span><br></pre></td></tr></table></figure>

<p>运行playbook：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">TASK: [check the mysql stauts] ************************************************</span><br><span class="line">ok: [10.0.102.200]</span><br><span class="line">ok: [10.0.102.162]</span><br><span class="line">ok: [10.0.102.212]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=1    changed=0    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=1    changed=0    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=1    changed=0    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<h4 id="1-3-限定主机范围执行"><a href="#1-3-限定主机范围执行" class="headerlink" title="1.3 限定主机范围执行"></a>1.3 限定主机范围执行</h4><p>虽然playbook中定义了执行的主机，但是有时候我们可能仅想在定义的主机中的部分机器上执行，这时候怎么办？修改playbook中的hosts的范围，但是每次改变主机就修改一次，比较麻烦，我们可以使用–limit参数，指定该playbook在指定的主机上执行。有以下inventory文件，我们想在dbservers上执行上面测试用的playbook内容。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[all]</span><br><span class="line">10.0.102.212</span><br><span class="line">10.0.102.200</span><br><span class="line">10.0.102.162</span><br><span class="line"></span><br><span class="line">[dbservers]</span><br><span class="line">10.0.102.162</span><br></pre></td></tr></table></figure>

<p><strong>上面测试的playbook中hosts定义all，我们想仅在dbservers上执行。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml --<span class="built_in">limit</span> dbservers</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">TASK: [check the mysql stauts] ************************************************</span><br><span class="line">ok: [10.0.102.162]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=1    changed=0    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p><strong>查看当前playbook在哪些主机上执行</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml --list-hosts</span></span><br><span class="line"></span><br><span class="line">playbook: test.yml</span><br><span class="line"></span><br><span class="line">  play              # 1 (all): host count=3</span><br><span class="line">    10.0.102.162</span><br><span class="line">    10.0.102.212</span><br><span class="line">    10.0.102.200</span><br></pre></td></tr></table></figure>

<h4 id="1-4-ansible-palybook的小技巧"><a href="#1-4-ansible-palybook的小技巧" class="headerlink" title="1.4 ansible-palybook的小技巧"></a>1.4 ansible-palybook的小技巧</h4><ul>
<li><code>--inventory=path</code>，指定inventory文件，默认是在/etc/ansible/hosts下面。</li>
<li><code>--verbose</code>，显示详细的输出，使用-vvvv显示精确到每分钟的输出。</li>
<li><code>--extra-vars=vars</code>：定义在playbook使用的变量。</li>
<li><code>--forks</code>：指定并发的线程数，默认是5.</li>
<li><code>--connection=type</code>:指定远程连接主机的方式，默认是ssh，设置为local时，则只在本地执行playbook、</li>
<li><code>--check</code>:检测模式，playbook中定义的所有任务将在每台主机上检测，但是并不执行。</li>
</ul>
<h4 id="1-5-ansible-playbook中的handlers"><a href="#1-5-ansible-playbook中的handlers" class="headerlink" title="1.5 ansible-playbook中的handlers"></a>1.5 ansible-playbook中的handlers</h4><p>在系统中，我们修改了服务器的配置文件，这时候就需要重启操作服务，就可以使用到handlers。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">handlers:</span>             <span class="comment"># 定义两个handlers</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">memcached</span></span><br><span class="line">      <span class="attr">service:</span>  <span class="string">name=memcached</span> <span class="string">state=restarted</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=apache</span> <span class="string">state=restarted</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">template</span> <span class="string">configuration</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">template:</span> <span class="string">src=template.j2</span> <span class="string">dest=/etc/foo.conf</span>  <span class="comment"># 修改了配置文件然后依次启动memcached和apache服务。</span></span><br><span class="line">  <span class="attr">notify:</span>        <span class="comment"># 使用notify来声明引用handlers。</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">restart</span> <span class="string">memcached</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">restart</span> <span class="string">apache</span></span><br></pre></td></tr></table></figure>

<h4 id="1-6-使用handlers的注意事项"><a href="#1-6-使用handlers的注意事项" class="headerlink" title="1.6 使用handlers的注意事项"></a>1.6 使用handlers的注意事项</h4><ul>
<li>Handlers只有在其所在的任务被执行时，才会被运行；如果一个任务中定义了notify调用Handlers，但是由于条件判断等原因，该任务未被执行，那么Handlers同样不会被执行。</li>
<li>Handlers只会在每一个play的末尾运行一次；如果想在一个playbook中间运行Handlers，则需要使用meta模块来实现。例如：<code>-meta: flush_handlers</code>.</li>
<li>如果一个play在运行到调用Handlers的语句之前失败了，那么这个Handlers将不会被执行。我们可以使用meta模块的<code>--force-handlers</code>选项来强制执行Handlers，即使Handlers所在的play中途运行失败也能执行。</li>
</ul>
<h3 id="二、变量"><a href="#二、变量" class="headerlink" title="二、变量"></a>二、变量</h3><p>这个变量我们来说明ansible中变量（不包含role中的变量）用法。</p>
<h4 id="2-1-playbook中的变量"><a href="#2-1-playbook中的变量" class="headerlink" title="2.1 playbook中的变量"></a>2.1 playbook中的变量</h4><p>在运行playbook的时候使用<code>--extra-vars</code>来指定变量</p>
<p>有如下playbook脚本：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">   <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">   <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">   <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">playbook</span> <span class="string">variables</span></span><br><span class="line">       <span class="attr">command:</span> <span class="string">echo</span> <span class="string">&#123;&#123;</span> <span class="string">test_var</span> <span class="string">&#125;&#125;</span>   <span class="comment"># 打印出变量test_var的值。</span></span><br></pre></td></tr></table></figure>

<p>运行playbook：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml --extra-vars <span class="string">"test_var=test"</span> -v    </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 加上-v选项，会显示详细的信息</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">TASK: [test playbook variables] ***********************************************</span><br><span class="line">changed: [10.0.102.212] =&gt; &#123;"changed": true, "cmd": ["echo", "test"], "delta": "0:00:00.006045", "end": "2019-02-15 23:04:49.789452", "rc": 0, "start": "2019-02-15 23:04:49.783407", "stderr": "", "stdout": "test"&#125;</span><br><span class="line">changed: [10.0.102.200] =&gt; &#123;"changed": true, "cmd": ["echo", "test"], "delta": "0:00:00.005318", "end": "2019-02-15 23:04:52.976471", "rc": 0, "start": "2019-02-15 23:04:52.971153", "stderr": "", "stdout": "test"&#125;</span><br><span class="line">changed: [10.0.102.162] =&gt; &#123;"changed": true, "cmd": ["echo", "test"], "delta": "0:00:00.005082", "end": "2019-02-15 23:04:52.424959", "rc": 0, "start": "2019-02-15 23:04:52.419877", "stderr": "", "stdout": "test"&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=1    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=1    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=1    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>上面详细信息的标准输出为test，说明变量的值已经传递了。</p>
<h4 id="2-2-playbook中使用vars代码块定义变量"><a href="#2-2-playbook中使用vars代码块定义变量" class="headerlink" title="2.2 playbook中使用vars代码块定义变量"></a>2.2 playbook中使用vars代码块定义变量</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">---</span><br><span class="line"> - hosts: all</span><br><span class="line">   remote_user: root</span><br><span class="line">   gather_facts: no</span><br><span class="line">   vars:                  # 在这里使用了vars代码块来定义变量</span><br><span class="line">       test_var: Hello World</span><br><span class="line">   tasks:</span><br><span class="line">     - name: test playbook variables</span><br><span class="line">       command: echo &#123;&#123; test_var &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml  -v</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">TASK: [test playbook variables] ***********************************************</span><br><span class="line">changed: [10.0.102.162] =&gt; &#123;"changed": true, "cmd": ["echo", "Hello", "World"], "delta": "0:00:00.004940", "end": "2019-02-15 23:20:06.541672", "rc": 0, "start": "2019-02-15 23:20:06.536732", "stderr": "", "stdout": "Hello World"&#125;</span><br><span class="line">changed: [10.0.102.212] =&gt; &#123;"changed": true, "cmd": ["echo", "Hello", "World"], "delta": "0:00:00.004843", "end": "2019-02-15 23:20:03.957950", "rc": 0, "start": "2019-02-15 23:20:03.953107", "stderr": "", "stdout": "Hello World"&#125;</span><br><span class="line">changed: [10.0.102.200] =&gt; &#123;"changed": true, "cmd": ["echo", "Hello", "World"], "delta": "0:00:00.004219", "end": "2019-02-15 23:20:07.166900", "rc": 0, "start": "2019-02-15 23:20:07.162681", "stderr": "", "stdout": "Hello World"&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=1    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=1    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=1    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<h4 id="2-3-使用独立的文件来定义playbook变量"><a href="#2-3-使用独立的文件来定义playbook变量" class="headerlink" title="2.3 使用独立的文件来定义playbook变量"></a>2.3 使用独立的文件来定义playbook变量</h4><p>playbook的内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">   <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">   <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">   <span class="attr">vars_files:</span>       <span class="comment"># 这里使用了vars_files来引入变量文件</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">vars.yml</span></span><br><span class="line">   <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">playbook</span> <span class="string">variables</span></span><br><span class="line">       <span class="attr">command:</span> <span class="string">echo</span> <span class="string">&#123;&#123;</span> <span class="string">test_var</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>变量文件的定义：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">vars.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line">  <span class="attr">test_var:</span> <span class="string">Hello</span> <span class="string">World</span></span><br></pre></td></tr></table></figure>

<p>执行的结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml  -v</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">TASK: [test playbook variables] ***********************************************</span><br><span class="line">changed: [10.0.102.212] =&gt; &#123;"changed": true, "cmd": ["echo", "Hello", "World"], "delta": "0:00:00.005198", "end": "2019-02-15 23:23:16.397557", "rc": 0, "start": "2019-02-15 23:23:16.392359", "stderr": "", "stdout": "Hello World"&#125;</span><br><span class="line">changed: [10.0.102.200] =&gt; &#123;"changed": true, "cmd": ["echo", "Hello", "World"], "delta": "0:00:00.004359", "end": "2019-02-15 23:23:19.629804", "rc": 0, "start": "2019-02-15 23:23:19.625445", "stderr": "", "stdout": "Hello World"&#125;</span><br><span class="line">changed: [10.0.102.162] =&gt; &#123;"changed": true, "cmd": ["echo", "Hello", "World"], "delta": "0:00:01.006185", "end": "2019-02-15 23:23:20.039320", "rc": 0, "start": "2019-02-15 23:23:19.033135", "stderr": "", "stdout": "Hello World"&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=1    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=1    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=1    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<h4 id="2-4-inventory文件中的变量"><a href="#2-4-inventory文件中的变量" class="headerlink" title="2.4 inventory文件中的变量"></a>2.4 inventory文件中的变量</h4><p>在ansible中，inventory文件通常是指ansible的主机和组定义文件hosts。在hosts文件中，变量会被定义在主机名后面或组名的下方。</p>
<p><strong>为特定的主机定义变量，变量名跟在对应主机的后边。</strong></p>
<p>inventory文件如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat /etc/ansible/hosts</span></span><br><span class="line">[all]</span><br><span class="line">10.0.102.212 test_var=212</span><br><span class="line">10.0.102.200 test_var=200</span><br><span class="line">10.0.102.162 test_var=162</span><br><span class="line"><span class="meta">#</span><span class="bash"> 为三个主机定义了同名的变量，但是变量值却不一样。</span></span><br></pre></td></tr></table></figure>

<p>playbook的内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">   <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">   <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">   <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">playbook</span> <span class="string">variables</span></span><br><span class="line">       <span class="attr">command:</span> <span class="string">echo</span> <span class="string">&#123;&#123;</span> <span class="string">test_var</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>执行这个playbook，结果如下（对应的主机显示了各自对应的变量值）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml -v</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">TASK: [test playbook variables] ***********************************************</span><br><span class="line">changed: [10.0.102.212] =&gt; &#123;"changed": true, "cmd": ["echo", "212"], "delta": "0:00:00.004399", "end": "2019-02-15 23:31:20.648111", "rc": 0, "start": "2019-02-15 23:31:20.643712", "stderr": "", "stdout": "212"&#125;</span><br><span class="line">changed: [10.0.102.200] =&gt; &#123;"changed": true, "cmd": ["echo", "200"], "delta": "0:00:00.005932", "end": "2019-02-15 23:31:23.873082", "rc": 0, "start": "2019-02-15 23:31:23.867150", "stderr": "", "stdout": "200"&#125;</span><br><span class="line">changed: [10.0.102.162] =&gt; &#123;"changed": true, "cmd": ["echo", "162"], "delta": "0:00:00.006723", "end": "2019-02-15 23:31:23.287861", "rc": 0, "start": "2019-02-15 23:31:23.281138", "stderr": "", "stdout": "162"&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=1    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=1    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=1    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p><strong>给主机组定义变量，作用范围为整个主机组。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat /etc/ansible/hosts</span></span><br><span class="line">[all]</span><br><span class="line">10.0.102.212</span><br><span class="line">10.0.102.200</span><br><span class="line">10.0.102.162</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[all:vars]                            #给主机组定义变量</span><br><span class="line">test_var=Hello World</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml -v</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">TASK: [test playbook variables] ***********************************************</span><br><span class="line">changed: [10.0.102.212] =&gt; &#123;"changed": true, "cmd": ["echo", "Hello", "World"], "delta": "0:00:00.003923", "end": "2019-02-15 23:37:29.322158", "rc": 0, "start": "2019-02-15 23:37:29.318235", "stderr": "", "stdout": "Hello World"&#125;</span><br><span class="line">changed: [10.0.102.200] =&gt; &#123;"changed": true, "cmd": ["echo", "Hello", "World"], "delta": "0:00:00.004161", "end": "2019-02-15 23:37:32.548947", "rc": 0, "start": "2019-02-15 23:37:32.544786", "stderr": "", "stdout": "Hello World"&#125;</span><br><span class="line">changed: [10.0.102.162] =&gt; &#123;"changed": true, "cmd": ["echo", "Hello", "World"], "delta": "0:00:00.006090", "end": "2019-02-15 23:37:32.005067", "rc": 0, "start": "2019-02-15 23:37:31.998977", "stderr": "", "stdout": "Hello World"&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=1    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=1    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=1    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>回想一下，这种方法定义变量虽然简单直观，但是若是变量特别多的情况下，会怎么样？特别是给对应的主机定义变量，若是变量太多，则管理起来会很不方便的，因此引入了主机变量和组变量。</p>
<h4 id="2-5-主机变量和组变量"><a href="#2-5-主机变量和组变量" class="headerlink" title="2.5 主机变量和组变量"></a>2.5 主机变量和组变量</h4><p><strong>inventory文件仍然使用上面的文件！</strong></p>
<p>在执行ansbile命令时，ansible默认会从<code>/etc/ansible/host_vars/</code>和<code>/etc/amsible/group_vars/</code>两个目录下读取变量定义，如果<code>/etc/ansible</code>下面没有这两个目录，可以直接手动创建，并且可以在这两个目录中创建与<code>hosts</code>（这里是指<code>inventory</code>文件）文件中主机名或组名同名的文件来定义变量。</p>
<p><strong>先来看主机变量</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> tree /etc/ansible/</span></span><br><span class="line">.</span><br><span class="line">├── group_vars</span><br><span class="line">├── hosts</span><br><span class="line">└── host_vars                 # 定义与主机名同名的文件</span><br><span class="line">    ├── 10.0.102.162</span><br><span class="line">    ├── 10.0.102.200</span><br><span class="line">    └── 10.0.102.212</span><br><span class="line"></span><br><span class="line">2 directories, 4 files</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 文件中的内容如下：</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat host_vars/10.0.102.162</span></span><br><span class="line">---</span><br><span class="line">test_var: 162</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat host_vars/10.0.102.200</span></span><br><span class="line">---</span><br><span class="line">  test_var: 200</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat host_vars/10.0.102.212</span></span><br><span class="line">---</span><br><span class="line">  test_var: 212</span><br></pre></td></tr></table></figure>

<p>playbook的内容如下，执行结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">---</span><br><span class="line"> - hosts: all</span><br><span class="line">   remote_user: root</span><br><span class="line">   gather_facts: no</span><br><span class="line">   tasks:</span><br><span class="line">     - name: test playbook variables</span><br><span class="line">       command: echo &#123;&#123; test_var &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml -v</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">TASK: [test playbook variables] ***********************************************</span><br><span class="line">changed: [10.0.102.212] =&gt; &#123;"changed": true, "cmd": ["echo", "212"], "delta": "0:00:00.003767", "end": "2019-02-15 23:55:58.595282", "rc": 0, "start": "2019-02-15 23:55:58.591515", "stderr": "", "stdout": "212"&#125;</span><br><span class="line">changed: [10.0.102.162] =&gt; &#123;"changed": true, "cmd": ["echo", "162"], "delta": "0:00:00.006254", "end": "2019-02-15 23:56:01.235307", "rc": 0, "start": "2019-02-15 23:56:01.229053", "stderr": "", "stdout": "162"&#125;</span><br><span class="line">changed: [10.0.102.200] =&gt; &#123;"changed": true, "cmd": ["echo", "200"], "delta": "0:00:01.004509", "end": "2019-02-15 23:56:02.775410", "rc": 0, "start": "2019-02-15 23:56:01.770901", "stderr": "", "stdout": "200"&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=1    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=1    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=1    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>再来说明一下主机组变量！</p>
<p>创建与组名同名的文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> tree</span></span><br><span class="line">.</span><br><span class="line">├── group_vars</span><br><span class="line">│   └── all               #创建与组名同名的文件</span><br><span class="line">├── hosts</span><br><span class="line">└── host_vars</span><br><span class="line">    ├── 10.0.102.162</span><br><span class="line">    ├── 10.0.102.200</span><br><span class="line">    └── 10.0.102.212</span><br><span class="line"></span><br><span class="line">2 directories, 5 files</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat group_vars/all</span></span><br><span class="line">---</span><br><span class="line">  test_group_var: from group</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">---</span><br><span class="line"> - hosts: all</span><br><span class="line">   remote_user: root</span><br><span class="line">   gather_facts: no</span><br><span class="line">   tasks:</span><br><span class="line">     - name: test the host variables</span><br><span class="line">       command: echo &#123;&#123; test_var &#125;&#125;</span><br><span class="line"></span><br><span class="line">     - name: test host group variables           #写入测试组变量的task</span><br><span class="line">       command: echo &#123;&#123; test_group_var &#125;&#125;</span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml -v</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">TASK: [test the host variables] ***********************************************</span><br><span class="line">changed: [10.0.102.212] =&gt; &#123;"changed": true, "cmd": ["echo", "212"], "delta": "0:00:00.004613", "end": "2019-02-15 23:59:23.227722", "rc": 0, "start": "2019-02-15 23:59:23.223109", "stderr": "", "stdout": "212"&#125;</span><br><span class="line">changed: [10.0.102.200] =&gt; &#123;"changed": true, "cmd": ["echo", "200"], "delta": "0:00:00.006490", "end": "2019-02-15 23:59:26.422682", "rc": 0, "start": "2019-02-15 23:59:26.416192", "stderr": "", "stdout": "200"&#125;</span><br><span class="line">changed: [10.0.102.162] =&gt; &#123;"changed": true, "cmd": ["echo", "162"], "delta": "0:00:00.004709", "end": "2019-02-15 23:59:25.812786", "rc": 0, "start": "2019-02-15 23:59:25.808077", "stderr": "", "stdout": "162"&#125;</span><br><span class="line"></span><br><span class="line">TASK: [test host group variables] *********************************************</span><br><span class="line">changed: [10.0.102.212] =&gt; &#123;"changed": true, "cmd": ["echo", "from", "group"], "delta": "0:00:00.003759", "end": "2019-02-15 23:59:23.519180", "rc": 0, "start": "2019-02-15 23:59:23.515421", "stderr": "", "stdout": "from group"&#125;</span><br><span class="line">changed: [10.0.102.162] =&gt; &#123;"changed": true, "cmd": ["echo", "from", "group"], "delta": "0:00:00.003748", "end": "2019-02-15 23:59:26.109337", "rc": 0, "start": "2019-02-15 23:59:26.105589", "stderr": "", "stdout": "from group"&#125;</span><br><span class="line">changed: [10.0.102.200] =&gt; &#123;"changed": true, "cmd": ["echo", "from", "group"], "delta": "0:00:00.004339", "end": "2019-02-15 23:59:26.724525", "rc": 0, "start": "2019-02-15 23:59:26.720186", "stderr": "", "stdout": "from group"&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=2    changed=2    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=2    changed=2    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=2    changed=2    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<h4 id="2-6-巧用主机变量和组变量"><a href="#2-6-巧用主机变量和组变量" class="headerlink" title="2.6 巧用主机变量和组变量"></a>2.6 巧用主机变量和组变量</h4><p>有时候在执行ansbile任务时，可能需要从一台远程主机上获取另一台远程主机的变量信息，这时候可以使用hostvars变量，这个变量包含了指定主机上所定义的所有变量。</p>
<p>譬如，若是想获取host1上变量admin_user的内容，在任意主机上直接上使用下面代码即可。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;  hostvars['host1']['admin_user']&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>ansible提供了一些非常有用的内置变量，几个常用的如下：</p>
<ul>
<li><code>grorps</code>：包含了所有hosts文件里的主机组的一个列表。</li>
<li><code>group_names</code>: 包含了当前主机所在的所有主机组名的一个列表。</li>
<li><code>inventory_hostname</code>: 通过hosts文件定义的主机名。（与<code>ansible_home</code>意义不同）</li>
<li><code>inventory_hostname_short</code>：变量<code>inventory_hostname</code>的第一部分。譬如<code>inventory_hostname</code>的值为<code>books.ansible.com</code>，那么<code>inventory_hostname_short</code>的值就是books。</li>
<li><code>play_hosts</code>: 将执行当前任务的所有主机</li>
</ul>
<h4 id="2-7-注册变量"><a href="#2-7-注册变量" class="headerlink" title="2.7 注册变量"></a>2.7 注册变量</h4><p>注册变量，其实就是将操作结果，包括标准输出和标准错误输出，保存到变量中，然后再根据这个变量的内容来决定下一步的操作，在这个过程中用来保存操作结果的变量就叫注册变量。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">   <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">   <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">   <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">the</span> <span class="string">register</span> <span class="string">variables</span></span><br><span class="line">       <span class="attr">shell:</span> <span class="string">uptime</span></span><br><span class="line">       <span class="attr">register:</span> <span class="string">results</span>     <span class="comment"># 使用关键字register声明注册变量，上面uptime命令产生的结果，存入到results中。结果是字典形式。</span></span><br><span class="line"></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">print</span> <span class="string">the</span> <span class="string">register</span> <span class="string">result</span></span><br><span class="line">       <span class="attr">debug:</span> <span class="string">msg="&#123;&#123;</span> <span class="string">results.stdout</span> <span class="string">&#125;&#125;"</span>   <span class="comment"># 使用debug模块，打印出上面命令的输出结果。</span></span><br></pre></td></tr></table></figure>

<p>上面的playbook执行结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">TASK: [test the register variables] *******************************************</span><br><span class="line">changed: [10.0.102.212]</span><br><span class="line">changed: [10.0.102.200]</span><br><span class="line">changed: [10.0.102.162]</span><br><span class="line"></span><br><span class="line">TASK: [print the register result] *********************************************</span><br><span class="line">ok: [10.0.102.212] =&gt; &#123;</span><br><span class="line">    "msg": " 00:18:01 up 3 days,  2:56,  3 users,  load average: 0.02, 0.03, 0.05"          #msg的结果就是注册变量的标准输出</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.0.102.200] =&gt; &#123;</span><br><span class="line">    "msg": " 00:18:04 up 4 days,  7:45,  3 users,  load average: 0.03, 0.06, 0.05"</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.0.102.162] =&gt; &#123;</span><br><span class="line">    "msg": " 00:18:04 up 4 days,  7:45,  3 users,  load average: 0.01, 0.02, 0.05"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=2    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>一个注册变量通常会有以下4个属性：</p>
<ul>
<li><code>changed</code>：任务是否对远程主机造成的变更。</li>
<li><code>delta</code>：任务运行所用的时间。</li>
<li><code>stdout</code>：正常的输出信息。</li>
<li><code>stderr</code>：错误信息。</li>
</ul>
<h3 id="三、高阶变量"><a href="#三、高阶变量" class="headerlink" title="三、高阶变量"></a>三、高阶变量</h3><p>对于普通变量，在ansible命令行设定的，在hosts文件中定义的，或者在playbook中定义的等，这些都是普通变量，在引用时，可以使用使用<code></code>的形式。ansible是用python语言写的，因此也支持一种叫做列表的变量，形式如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">   <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">   <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">   <span class="attr">vars:</span></span><br><span class="line">      <span class="attr">var_list:</span>     <span class="comment"># 注意形式，定义了var_list列表，取值方法和列表取值一样，不推荐使用jinja2的方法取值。</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">one</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">two</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">three</span></span><br><span class="line">   <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">the</span> <span class="string">list</span> <span class="string">variables</span></span><br><span class="line">       <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">&#123;&#123;</span> <span class="string">var_list[0]</span> <span class="string">&#125;&#125;</span>   <span class="comment"># 取列表中的第一个字，也就是one</span></span><br><span class="line">       <span class="attr">register:</span> <span class="string">results</span></span><br><span class="line"></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">print</span> <span class="string">the</span> <span class="string">register</span> <span class="string">result</span></span><br><span class="line">       <span class="attr">debug:</span> <span class="string">msg="&#123;&#123;</span> <span class="string">results.stdout</span> <span class="string">&#125;&#125;"</span></span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">TASK: [test the list variables] ***********************************************</span><br><span class="line">changed: [10.0.102.212]</span><br><span class="line">changed: [10.0.102.200]</span><br><span class="line">changed: [10.0.102.162]</span><br><span class="line"></span><br><span class="line">TASK: [print the register result] *********************************************</span><br><span class="line">ok: [10.0.102.212] =&gt; &#123;</span><br><span class="line">    "msg": "one"</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.0.102.200] =&gt; &#123;</span><br><span class="line">    "msg": "one"</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.0.102.162] =&gt; &#123;</span><br><span class="line">    "msg": "one"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=2    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<h4 id="3-1-fasts变量信息"><a href="#3-1-fasts变量信息" class="headerlink" title="3.1 fasts变量信息"></a>3.1 fasts变量信息</h4><p>在上面的测试中，我们的playbook都执行了一条命令叫<code>gater_facts:no</code>，加入了这条命令后，playbook脚本的执行速度会快很多，这是因为默认情况下，ansible是会手机远程服务器的主机信息，这些信息包含了服务器的一些基本设置。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GATHERING FACTS ***************************************************************</span><br><span class="line">ok: [10.0.102.200]</span><br><span class="line">ok: [10.0.102.212]</span><br><span class="line">ok: [10.0.102.162]</span><br></pre></td></tr></table></figure>

<p>收集的主机信息可以使用setup模块查看，一个主机的收集信息如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line">ansible 10.0.102.162 -m setup</span><br><span class="line">10.0.102.162 | success &gt;&gt; &#123;</span><br><span class="line">    "ansible_facts": &#123;</span><br><span class="line">        "ansible_all_ipv4_addresses": [</span><br><span class="line">            "10.0.102.162"</span><br><span class="line">        ],</span><br><span class="line">        "ansible_all_ipv6_addresses": [</span><br><span class="line">            "fe80::1392:ecd3:5adf:c3ae"</span><br><span class="line">        ],</span><br><span class="line">        "ansible_architecture": "x86_64",</span><br><span class="line">        "ansible_bios_date": "04/01/2014",</span><br><span class="line">        "ansible_bios_version": "1.9.1-5.el7.centos",</span><br><span class="line">        "ansible_cmdline": &#123;</span><br><span class="line">            "BOOT_IMAGE": "/vmlinuz-3.10.0-514.el7.x86_64",</span><br><span class="line">            "LANG": "en_US.UTF-8",</span><br><span class="line">            "crashkernel": "auto",</span><br><span class="line">            "quiet": true,</span><br><span class="line">            "rd.lvm.lv": "cl/swap",</span><br><span class="line">            "rhgb": true,</span><br><span class="line">            "ro": true,</span><br><span class="line">            "root": "/dev/mapper/cl-root"</span><br><span class="line">        &#125;,</span><br><span class="line">        "ansible_date_time": &#123;</span><br><span class="line">            "date": "2019-02-16",</span><br><span class="line">            "day": "16",</span><br><span class="line">            "epoch": "1550248590",</span><br><span class="line">            "hour": "00",</span><br><span class="line">            "iso8601": "2019-02-15T16:36:30Z",</span><br><span class="line">            "iso8601_micro": "2019-02-15T16:36:30.311222Z",</span><br><span class="line">            "minute": "36",</span><br><span class="line">            "month": "02",</span><br><span class="line">            "second": "30",</span><br><span class="line">            "time": "00:36:30",</span><br><span class="line">            "tz": "CST",</span><br><span class="line">            "tz_offset": "+0800",</span><br><span class="line">            "weekday": "Saturday",</span><br><span class="line">            "year": "2019"</span><br><span class="line">        &#125;,</span><br><span class="line">        "ansible_default_ipv4": &#123;</span><br><span class="line">            "address": "10.0.102.162",</span><br><span class="line">            "alias": "eth0",</span><br><span class="line">            "gateway": "10.0.100.1",</span><br><span class="line">            "interface": "eth0",</span><br><span class="line">            "macaddress": "fa:0a:e3:54:a6:00",</span><br><span class="line">            "mtu": 1500,</span><br><span class="line">            "netmask": "255.255.252.0",</span><br><span class="line">            "network": "10.0.100.0",</span><br><span class="line">            "type": "ether"</span><br><span class="line">        &#125;,</span><br><span class="line">        "ansible_default_ipv6": &#123;&#125;,</span><br><span class="line">        "ansible_devices": &#123;</span><br><span class="line">            "sr0": &#123;</span><br><span class="line">                "holders": [],</span><br><span class="line">                "host": "IDE interface: Intel Corporation 82371SB PIIX3 IDE [Natoma/Triton II]",</span><br><span class="line">                "model": "QEMU DVD-ROM",</span><br><span class="line">                "partitions": &#123;&#125;,</span><br><span class="line">                "removable": "1",</span><br><span class="line">                "rotational": "1",</span><br><span class="line">                "scheduler_mode": "cfq",</span><br><span class="line">                "sectors": "2097151",</span><br><span class="line">                "sectorsize": "512",</span><br><span class="line">                "size": "1024.00 MB",</span><br><span class="line">                "support_discard": "0",</span><br><span class="line">                "vendor": "QEMU"</span><br><span class="line">            &#125;,</span><br><span class="line">            "vda": &#123;</span><br><span class="line">                "holders": [],</span><br><span class="line">                "host": "SCSI storage controller: Red Hat, Inc Virtio block device",</span><br><span class="line">                "model": null,</span><br><span class="line">                "partitions": &#123;</span><br><span class="line">                    "vda1": &#123;</span><br><span class="line">                        "sectors": "2097152",</span><br><span class="line">                        "sectorsize": 512,</span><br><span class="line">                        "size": "1.00 GB",</span><br><span class="line">                        "start": "2048"</span><br><span class="line">                    &#125;,</span><br><span class="line">                    "vda2": &#123;</span><br><span class="line">                        "sectors": "81786880",</span><br><span class="line">                        "sectorsize": 512,</span><br><span class="line">                        "size": "39.00 GB",</span><br><span class="line">                        "start": "2099200"</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                "removable": "0",</span><br><span class="line">                "rotational": "1",</span><br><span class="line">                "scheduler_mode": "",</span><br><span class="line">                "sectors": "83886080",</span><br><span class="line">                "sectorsize": "512",</span><br><span class="line">                "size": "40.00 GB",</span><br><span class="line">                "support_discard": "0",</span><br><span class="line">                "vendor": "0x1af4"</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        "ansible_distribution": "CentOS",</span><br><span class="line">        "ansible_distribution_major_version": "7",</span><br><span class="line">        "ansible_distribution_release": "Core",</span><br><span class="line">        "ansible_distribution_version": "7.3.1611",</span><br><span class="line">        "ansible_domain": "",</span><br><span class="line">        "ansible_env": &#123;</span><br><span class="line">            "HOME": "/root",</span><br><span class="line">            "LANG": "en_US.UTF-8",</span><br><span class="line">            "LC_CTYPE": "en_US.UTF-8",</span><br><span class="line">            "LESSOPEN": "||/usr/bin/lesspipe.sh %s",</span><br><span class="line">            "LOGNAME": "root",</span><br><span class="line">            "LS_COLORS": "rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=01;05;37;41:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc=01;31:*.arj=01;31:*.taz=01;31:*.lha=01;31:*.lz4=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.tzo=01;31:*.t7z=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.dz=01;31:*.gz=01;31:*.lrz=01;31:*.lz=01;31:*.lzo=01;31:*.xz=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.alz=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.cab=01;31:*.jpg=01;35:*.jpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.axv=01;35:*.anx=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=01;36:*.au=01;36:*.flac=01;36:*.mid=01;36:*.midi=01;36:*.mka=01;36:*.mp3=01;36:*.mpc=01;36:*.ogg=01;36:*.ra=01;36:*.wav=01;36:*.axa=01;36:*.oga=01;36:*.spx=01;36:*.xspf=01;36:",</span><br><span class="line">            "MAIL": "/var/mail/root",</span><br><span class="line">            "PATH": "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin",</span><br><span class="line">            "PWD": "/root",</span><br><span class="line">            "SELINUX_LEVEL_REQUESTED": "",</span><br><span class="line">            "SELINUX_ROLE_REQUESTED": "",</span><br><span class="line">            "SELINUX_USE_CURRENT_RANGE": "",</span><br><span class="line">            "SHELL": "/bin/bash",</span><br><span class="line">            "SHLVL": "2",</span><br><span class="line">            "SSH_CLIENT": "10.0.102.204 4242 22",</span><br><span class="line">            "SSH_CONNECTION": "10.0.102.204 4242 10.0.102.162 22",</span><br><span class="line">            "SSH_TTY": "/dev/pts/1",</span><br><span class="line">            "TERM": "xterm",</span><br><span class="line">            "USER": "root",</span><br><span class="line">            "XDG_RUNTIME_DIR": "/run/user/0",</span><br><span class="line">            "XDG_SESSION_ID": "168",</span><br><span class="line">            "_": "/usr/bin/python"</span><br><span class="line">        &#125;,</span><br><span class="line">        "ansible_eth0": &#123;</span><br><span class="line">            "active": true,</span><br><span class="line">            "device": "eth0",</span><br><span class="line">            "ipv4": &#123;</span><br><span class="line">                "address": "10.0.102.162",</span><br><span class="line">                "netmask": "255.255.252.0",</span><br><span class="line">                "network": "10.0.100.0"</span><br><span class="line">            &#125;,</span><br><span class="line">            "ipv6": [</span><br><span class="line">                &#123;</span><br><span class="line">                    "address": "fe80::1392:ecd3:5adf:c3ae",</span><br><span class="line">                    "prefix": "64",</span><br><span class="line">                    "scope": "link"</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            "macaddress": "fa:0a:e3:54:a6:00",</span><br><span class="line">            "module": "virtio_net",</span><br><span class="line">            "mtu": 1500,</span><br><span class="line">            "promisc": false,</span><br><span class="line">            "type": "ether"</span><br><span class="line">        &#125;,</span><br><span class="line">        "ansible_form_factor": "Other",</span><br><span class="line">        "ansible_fqdn": "docker4",</span><br><span class="line">        "ansible_hostname": "docker4",</span><br><span class="line">        "ansible_interfaces": [</span><br><span class="line">            "lo",</span><br><span class="line">            "eth0"</span><br><span class="line">        ],</span><br><span class="line">        "ansible_kernel": "3.10.0-514.el7.x86_64",</span><br><span class="line">        "ansible_lo": &#123;</span><br><span class="line">            "active": true,</span><br><span class="line">            "device": "lo",</span><br><span class="line">            "ipv4": &#123;</span><br><span class="line">                "address": "127.0.0.1",</span><br><span class="line">                "netmask": "255.0.0.0",</span><br><span class="line">                "network": "127.0.0.0"</span><br><span class="line">            &#125;,</span><br><span class="line">            "ipv6": [</span><br><span class="line">                &#123;</span><br><span class="line">                    "address": "::1",</span><br><span class="line">                    "prefix": "128",</span><br><span class="line">                    "scope": "host"</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            "mtu": 65536,</span><br><span class="line">            "promisc": false,</span><br><span class="line">            "type": "loopback"</span><br><span class="line">        &#125;,</span><br><span class="line">        "ansible_machine": "x86_64",</span><br><span class="line">        "ansible_memfree_mb": 881,</span><br><span class="line">        "ansible_memtotal_mb": 1839,</span><br><span class="line">        "ansible_mounts": [</span><br><span class="line">            &#123;</span><br><span class="line">                "device": "/dev/mapper/cl-root",</span><br><span class="line">                "fstype": "xfs",</span><br><span class="line">                "mount": "/",</span><br><span class="line">                "options": "rw,seclabel,relatime,attr2,inode64,noquota",</span><br><span class="line">                "size_available": 34615087104,</span><br><span class="line">                "size_total": 39700664320</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                "device": "/dev/vda1",</span><br><span class="line">                "fstype": "xfs",</span><br><span class="line">                "mount": "/boot",</span><br><span class="line">                "options": "rw,seclabel,relatime,attr2,inode64,noquota",</span><br><span class="line">                "size_available": 918556672,</span><br><span class="line">                "size_total": 1063256064</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        "ansible_nodename": "docker4",</span><br><span class="line">        "ansible_os_family": "RedHat",</span><br><span class="line">        "ansible_pkg_mgr": "yum",</span><br><span class="line">        "ansible_processor": [</span><br><span class="line">            "QEMU Virtual CPU version 2.5+",</span><br><span class="line">            "QEMU Virtual CPU version 2.5+"</span><br><span class="line">        ],</span><br><span class="line">        "ansible_processor_cores": 2,</span><br><span class="line">        "ansible_processor_count": 1,</span><br><span class="line">        "ansible_processor_threads_per_core": 1,</span><br><span class="line">        "ansible_processor_vcpus": 2,</span><br><span class="line">        "ansible_product_name": "KVM",</span><br><span class="line">        "ansible_product_serial": "NA",</span><br><span class="line">        "ansible_product_uuid": "E5E1D5E6-1A4D-4E0D-98C3-B8AD422B10CC",</span><br><span class="line">        "ansible_product_version": "RHEL 7.3.0 PC (i440FX + PIIX, 1996)",</span><br><span class="line">        "ansible_python_version": "2.7.5",</span><br><span class="line">        "ansible_selinux": &#123;</span><br><span class="line">            "config_mode": "enforcing",</span><br><span class="line">            "mode": "enforcing",</span><br><span class="line">            "policyvers": 28,</span><br><span class="line">            "status": "enabled",</span><br><span class="line">            "type": "targeted"</span><br><span class="line">        &#125;,</span><br><span class="line">        "ansible_ssh_host_key_ecdsa_public": "AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBEp5iF/lAqB9Q9FNKfnsi3mLJSVvvooVhRRcuGTBHEJs+TaM36oBaIr764IX1zdn2sWFLdYgmcuaAeiPu3fK+UU=",</span><br><span class="line">        "ansible_ssh_host_key_rsa_public": "AAAAB3NzaC1yc2EAAAADAQABAAABAQC6yHI2+V64EMW3jDISBrzKmWurP7uF4IqemJgowpqC3mVlFsPOSqerDoJN9hE34fViXcbLUj9wIi0kc3QzxxNwTefwJCdPSL17ns9eIEDKJqrHswts7OXYC1948bdyhyGnaW57BEfVUJ+Vt8OI1JSKkKsi3aCumaZDz9tNGCVYiqW4PMUQFaT/yEnPqKhSp8mDX/SL/unpVsctB0w37o38ZVApKPaNkHW25uiwroStLGqY4VgoZHTqHUdvqk4EZQOD0+JmBcYKVj2ABBl1sMiH8mmrc2W2Gi0gJx31Ky/t5SWQtXTdMRB3D7N9yRd1pPcnh0zebS/OPnX4G5UWX/aP",</span><br><span class="line">        "ansible_swapfree_mb": 0,</span><br><span class="line">        "ansible_swaptotal_mb": 0,</span><br><span class="line">        "ansible_system": "Linux",</span><br><span class="line">        "ansible_system_vendor": "Red Hat",</span><br><span class="line">        "ansible_user_id": "root",</span><br><span class="line">        "ansible_userspace_architecture": "x86_64",</span><br><span class="line">        "ansible_userspace_bits": "64",</span><br><span class="line">        "ansible_virtualization_role": "guest",</span><br><span class="line">        "ansible_virtualization_type": "kvm",</span><br><span class="line">        "module_setup": true</span><br><span class="line">    &#125;,</span><br><span class="line">    "changed": false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在实际应用中，运用的比较多的facts变量有<code>ansible_os_family</code>，<code>ansible_hostname</code>等，这些变量通常会被拿来作为when条件语句的判断条件，来决定下一步的操作。一个简单的实例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">   <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">   <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">the</span> <span class="string">list</span> <span class="string">variables</span></span><br><span class="line">       <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">&#123;&#123;</span> <span class="string">ansible_os_family</span> <span class="string">&#125;&#125;</span></span><br><span class="line">       <span class="attr">register:</span> <span class="string">results</span></span><br><span class="line"></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">print</span> <span class="string">the</span> <span class="string">register</span> <span class="string">result</span></span><br><span class="line">       <span class="attr">debug:</span> <span class="string">msg="&#123;&#123;</span> <span class="string">results.stdout</span> <span class="string">&#125;&#125;"</span></span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook test.yml</span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">GATHERING FACTS ***************************************************************</span><br><span class="line">ok: [10.0.102.162]</span><br><span class="line">ok: [10.0.102.212]</span><br><span class="line">ok: [10.0.102.200]</span><br><span class="line"></span><br><span class="line">TASK: [test the list variables] ***********************************************</span><br><span class="line">changed: [10.0.102.162]</span><br><span class="line">changed: [10.0.102.212]</span><br><span class="line">changed: [10.0.102.200]</span><br><span class="line"></span><br><span class="line">TASK: [print the register result] *********************************************</span><br><span class="line">ok: [10.0.102.212] =&gt; &#123;</span><br><span class="line">    "msg": "RedHat"                   #对应变量的结果</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.0.102.200] =&gt; &#123;</span><br><span class="line">    "msg": "RedHat"</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.0.102.162] =&gt; &#123;</span><br><span class="line">    "msg": "RedHat"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=3    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=3    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=3    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<h4 id="3-2-本地facts变量"><a href="#3-2-本地facts变量" class="headerlink" title="3.2 本地facts变量"></a>3.2 本地facts变量</h4><p>我们可以自己定义facts变量，把这个变量写入一个以<code>.fact</code>结尾的文件中，这个文件可以是json文件或ini文件，或者是一个可以返回json代码的可执行文件。然后将其放在远程主机的<code>/etc/ansible/facts.d</code>文件夹中，ansible在执行的任务时会自动到这个文件夹中读取变量的信息。</p>
<p>在远程主机上做如下操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 自定义fact信息</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p /etc/ansible/facts.d &amp;&amp; <span class="built_in">cd</span> /etc/ansible/facts.d</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat test.fact</span></span><br><span class="line">[test_fact]</span><br><span class="line">admin=hongkong</span><br></pre></td></tr></table></figure>

<p>然后再ansible主机上获取自定义的信息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible 10.0.102.162 -m setup -a <span class="string">"filter=ansible_local"</span></span></span><br><span class="line">10.0.102.162 | success &gt;&gt; &#123;</span><br><span class="line">    "ansible_facts": &#123;</span><br><span class="line">        "ansible_local": &#123;</span><br><span class="line">            "test": &#123;</span><br><span class="line">                "test_fact": &#123;</span><br><span class="line">                    "admin": "hongkong"</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "changed": false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="四、if-when-while流程控制语句"><a href="#四、if-when-while流程控制语句" class="headerlink" title="四、if/when/while流程控制语句"></a>四、if/when/while流程控制语句</h3><p>条件判断在ansible任务中的使用频率非常高。我们可以根据一些条件的不一样执行不同的task。</p>
<h4 id="4-1-when条件判断"><a href="#4-1-when条件判断" class="headerlink" title="4.1 when条件判断"></a>4.1 when条件判断</h4><p>很多任务只有在特定条件下才能执行，这就是when语句发挥作用的地方。</p>
<p>一个简单的实例，关闭掉ip地址为10.0.102.162服务器上的mysql服务，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@test2 playbook]# cat test.yml</span><br><span class="line">---</span><br><span class="line"> - hosts: all</span><br><span class="line">   remote_user: root</span><br><span class="line">   tasks:</span><br><span class="line">     - name: shut down the db server</span><br><span class="line">       service: name=mysqld state=stopped</span><br><span class="line">       when: ansible_eth0.ipv4.address  == "10.0.102.162"  # 这里使用了when条件语句</span><br></pre></td></tr></table></figure>

<p>执行的结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">GATHERING FACTS ***************************************************************</span><br><span class="line">ok: [10.0.102.212]</span><br><span class="line">ok: [10.0.102.200]</span><br><span class="line">ok: [10.0.102.162]</span><br><span class="line"></span><br><span class="line">TASK: [shut down the db server] ***********************************************</span><br><span class="line">skipping: [10.0.102.200]</span><br><span class="line">skipping: [10.0.102.212]</span><br><span class="line">changed: [10.0.102.162]                      #162的服务状态已经改变</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=2    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=1    changed=0    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=1    changed=0    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>这个就是when条件语句的用法很简单。需要注意when语句的作用于paly的作用时间，当when的条件满足时，然后才会执行play中的任务。ansible还提供了另外两个与when相关的语句<code>changed_when</code>和<code>failed_when</code>条件判断。</p>
<h3 id="五、任务间的流程控制"><a href="#五、任务间的流程控制" class="headerlink" title="五、任务间的流程控制"></a>五、任务间的流程控制</h3><h4 id="5-1-任务委托"><a href="#5-1-任务委托" class="headerlink" title="5.1 任务委托"></a>5.1 任务委托</h4><p>默认情况下，ansible所有任务都是在我们指定的机器上面运行的，当在一个独立的集群环境配置时，这并没有什么问题。而在有些情况下，比如给某台服务器发送通知或者向监控服务器中添加被监控的主机，这个时候任务就需要在特定的主机上运行，而非一开始指定的所有主机，此时就需要ansible的委托任务。</p>
<p>使用<code>delegate_to</code>关键字可以配置任务在指定的服务器上执行，而其他任务还是在hosts关键字配置的所有机器上执行，当到了这个关键字所在的任务时，就使用委托的机器运行。</p>
<p>查看MySQL是否在运行状态，因此在检查之前首先关掉162上的mysql服务。（为了方便查看状态）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">   <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">   <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">stop</span> <span class="string">the</span> <span class="string">db</span> <span class="string">server</span></span><br><span class="line">       <span class="attr">service:</span> <span class="string">name=mysqld</span> <span class="string">state=stopped</span></span><br><span class="line">       <span class="attr">delegate_to:</span> <span class="number">10.0</span><span class="number">.102</span><span class="number">.162</span>       <span class="comment"># 这里使用了委托，仅关闭162这台服务器上，这个play仅在162这台服务器上执行。</span></span><br><span class="line"></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">check</span> <span class="string">mysql</span> <span class="string">status</span></span><br><span class="line">       <span class="attr">service:</span> <span class="string">name=mysqld</span> <span class="string">state=running</span></span><br></pre></td></tr></table></figure>

<p>这里委托是在指定的机器上执行，若是想在本地服务器上执行，可以把ip地址换为127.0.0.1即可。也可以使用<code>local_action</code>方法。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">   <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">   <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">the</span> <span class="string">test</span> <span class="string">file</span></span><br><span class="line">       <span class="attr">local_action:</span> <span class="string">shell</span> <span class="string">touch</span> <span class="string">test1111</span> <span class="comment"># 在本地创建一个测试文件</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">check</span> <span class="string">mysql</span> <span class="string">status</span></span><br><span class="line">       <span class="attr">service:</span> <span class="string">name=mysqld</span> <span class="string">state=running</span></span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">GATHERING FACTS ***************************************************************</span><br><span class="line">ok: [10.0.102.212]</span><br><span class="line">ok: [10.0.102.200]</span><br><span class="line">ok: [10.0.102.162]</span><br><span class="line"></span><br><span class="line">TASK: [create the test file] **************************************************</span><br><span class="line">changed: [10.0.102.212 -&gt; 127.0.0.1]</span><br><span class="line">changed: [10.0.102.200 -&gt; 127.0.0.1]</span><br><span class="line">changed: [10.0.102.162 -&gt; 127.0.0.1]</span><br><span class="line"></span><br><span class="line">TASK: [check mysql status] ****************************************************</span><br><span class="line">ok: [10.0.102.200]</span><br><span class="line">ok: [10.0.102.212]</span><br><span class="line">ok: [10.0.102.162]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=3    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=3    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.212               : ok=3    changed=1    unreachable=0    failed=0</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls                     <span class="comment"># 默认会在当前目录创建对应的文件</span></span></span><br><span class="line">test1111  test.yml  vars.yml</span><br></pre></td></tr></table></figure>

<h4 id="5-2-任务暂停"><a href="#5-2-任务暂停" class="headerlink" title="5.2 任务暂停"></a>5.2 任务暂停</h4><p>有些情况下，一些任务的运行需要等待一些状态的恢复，比如某一台主机或者应用刚刚重启，我们需要等待它上面的某个端口开启，此时我们就不得不将正在运行的任务暂停，直到其状态满足我们的需求。</p>
<p>下一个实例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wait</span> <span class="string">for</span> <span class="string">webserver</span> <span class="string">to</span> <span class="string">start</span></span><br><span class="line">   <span class="attr">local_action:</span></span><br><span class="line">        <span class="attr">module:</span> <span class="string">wait_for</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">webserver1</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">timeout:</span> <span class="number">300</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">startted</span></span><br><span class="line"><span class="comment"># 这个实例中，这个任务将会每10s检查一次主机webserver1上面的80端口是否开启，如果超过了300s则失败</span></span><br></pre></td></tr></table></figure>

<h4 id="5-3-交互式提示"><a href="#5-3-交互式提示" class="headerlink" title="5.3 交互式提示"></a>5.3 交互式提示</h4><p>在少数情况下，ansible任务运行的过程中需要用户输入一些数据，这些数据要么比较秘密不方便，或者数据是动态的，不同的用户有不同的需求，比如输入用户自己的账户和密码或者输入不同的版本号会触发不同的后续操作等。ansible的<code>vars_prompt</code>关键字就是用来处理上述这种与用户交互的情况的。下面是一个简单的实例。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">   <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">   <span class="attr">vars_prompt:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">share_user</span></span><br><span class="line">        <span class="attr">prompt:</span> <span class="string">"what is your network username?"</span></span><br><span class="line">        <span class="attr">private:</span> <span class="literal">no</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">share_pass</span></span><br><span class="line">        <span class="attr">prompt:</span> <span class="string">"what is your network password"</span></span><br><span class="line">        <span class="attr">private:</span> <span class="literal">no</span></span><br></pre></td></tr></table></figure>

<p>然后执行上面的playbook，因为我们只是测试，只需要在一台机器上执行，因此加入了<code>--limit</code>参数。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml --<span class="built_in">limit</span> 10.0.102.162</span></span><br><span class="line">what is your network username?: test        # 需要手动交互输入</span><br><span class="line">what is your network password: 123456       # 手动输入</span><br><span class="line"></span><br><span class="line">PLAY [all] ********************************************************************</span><br><span class="line"></span><br><span class="line">GATHERING FACTS ***************************************************************</span><br><span class="line">ok: [10.0.102.162]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ********************************************************************</span><br><span class="line">10.0.102.162               : ok=1    changed=0    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>手动输入的变量值，在后面的play中仍然可以用<code></code>的形式调用。</p>
<p>关键字<code>vars_prompt</code>几个常用的选项总结如下：</p>
<ul>
<li><code>private</code>：默认值为yes，表示用户输入的值在命令行不可见；将值设为no时，用户输入可见。</li>
<li><code>default</code>：为变量设置默认值，以节省用户输入时间。</li>
<li><code>confirm</code>：特别适合输入密码的情况，如果将其设置为yes，则会要求用户输入两次，以增加输入的安全性。</li>
</ul>
<h3 id="六、tags标签"><a href="#六、tags标签" class="headerlink" title="六、tags标签"></a>六、tags标签</h3><p>默认情况下，ansible在执行一个playbook时，会执行playbook中定义的所有任务。ansible的标签功能可以给角色，文件，单独的任务甚至整个playbook打上标签，然后利用这些标签来指定要运行playbook中的个别任务，或不执行指定的任务，并且它的语法非常简单。</p>
<p>通过一段代码来说明tags的用法：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 可以给整个playbook的所有任务打一个标签。</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">deploy</span></span><br><span class="line">    <span class="attr">roles:</span></span><br><span class="line">     <span class="comment"># 给角色打的标签将会应用与角色下所有的任务。</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">&#123;role:</span> <span class="string">tomcat,</span> <span class="attr">tags :</span> <span class="string">["tomcat",</span> <span class="string">"app"</span><span class="string">]&#125;</span>        <span class="comment"># 一个对象添加多个tag的写法之一</span></span><br><span class="line">    <span class="attr">tasks:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Notify</span> <span class="string">on</span> <span class="string">completion</span></span><br><span class="line">         <span class="attr">local_action:</span></span><br><span class="line">            <span class="attr">module:</span> <span class="string">osx_say</span></span><br><span class="line">            <span class="attr">msg:</span> <span class="string">"<span class="template-variable">&#123;&#123;inventory_hostname&#125;&#125;</span> is finished"</span></span><br><span class="line">            <span class="attr">voice:</span> <span class="string">Zarvox</span></span><br><span class="line">         <span class="attr">tags:</span>      <span class="comment"># 一个对象添加多个tag写法之二</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">notifications</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">say</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">include:</span> <span class="string">foo.yml</span></span><br><span class="line">         <span class="string">tags:</span>　<span class="string">foo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 缩进可能不太对</span></span><br></pre></td></tr></table></figure>

<p>将上述代码保存，可以通过以下命令来只执行<code>Notify on completion</code>任务。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml --tags <span class="string">"say"</span></span></span><br></pre></td></tr></table></figure>

<p>如果想忽略掉某个任务，可以使用<code>--skip-tags</code>关键字指定。</p>
<h3 id="七、Block块"><a href="#七、Block块" class="headerlink" title="七、Block块"></a>七、Block块</h3><p>ansible从2.0.0版本开始引入了块功能。块功能可以将任务进行分组，并且可以在块级别上应用任务变量。同时，块功能还可以使用类似于其他编程语言处理异常那样的方法，来处理块内部的任务异常。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">   <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line">   <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">block:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=no</span></span><br><span class="line">       <span class="attr">when:</span>  <span class="string">ansible_eth0.ipv4.address</span>  <span class="string">==</span> <span class="string">"10.0.102.162"</span></span><br><span class="line"></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">block:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">yum:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=started</span> <span class="string">enabled=no</span></span><br><span class="line">       <span class="attr">when:</span>  <span class="string">ansible_eth0.ipv4.address</span>  <span class="string">==</span> <span class="string">"10.0.102.200"</span></span><br></pre></td></tr></table></figure>

<p>运行结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook -i hosts test.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [all] **************************************************************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **************************************************************************************************************************************************************************</span><br><span class="line">ok: [10.0.102.162]</span><br><span class="line">ok: [10.0.102.200]</span><br><span class="line"></span><br><span class="line">TASK [yum] **************************************************************************************************************************************************************************************</span><br><span class="line">skipping: [10.0.102.200]          # 因为在inventory文件中注释了这一台服务器，因此这里忽略了。</span><br><span class="line">ok: [10.0.102.162]</span><br><span class="line"></span><br><span class="line">TASK [service] **********************************************************************************************************************************************************************************</span><br><span class="line">skipping: [10.0.102.200]</span><br><span class="line">changed: [10.0.102.162]</span><br><span class="line"></span><br><span class="line">TASK [yum] **************************************************************************************************************************************************************************************</span><br><span class="line">skipping: [10.0.102.162]</span><br><span class="line">ok: [10.0.102.200]</span><br><span class="line"></span><br><span class="line">TASK [service] **********************************************************************************************************************************************************************************</span><br><span class="line">skipping: [10.0.102.162]</span><br><span class="line">changed: [10.0.102.200]</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************************************************************************</span><br><span class="line">10.0.102.162               : ok=3    changed=1    unreachable=0    failed=0</span><br><span class="line">10.0.102.200               : ok=3    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>

<p>上面的playbook和之前的并没有什么不同，只是假如了block之后，代码更容易查看。</p>
<p>块功能可以用来处理任务的异常。比如一个ansible任务时监控一个并不太重要的应用，这个应用的正常运行与否对后续的任务并不产生影响，这时候我们就可以通过块功能来处理这个应用的报错。如下代码：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">block:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shell</span> <span class="string">script</span> <span class="string">to</span> <span class="string">connect</span> <span class="string">the</span> <span class="string">app</span> <span class="string">ti</span> <span class="string">a</span> <span class="string">mointoring</span> <span class="string">service.</span></span><br><span class="line">          <span class="attr">script:</span> <span class="string">mointoring-connect.sh</span></span><br><span class="line">          <span class="attr">rescue:</span></span><br><span class="line">             <span class="bullet">-</span> <span class="string">name:只有脚本报错时才执行</span></span><br><span class="line">　　　　　　　　 <span class="string">debug：msg="There</span> <span class="string">was</span> <span class="string">an</span> <span class="string">error</span> <span class="string">in</span> <span class="string">the</span> <span class="string">block"</span></span><br><span class="line">          <span class="attr">always:</span></span><br><span class="line">             <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">无论结果如何都执行</span></span><br><span class="line">               <span class="attr">debug:</span> <span class="string">msg="This</span> <span class="string">always</span> <span class="string">executes"</span></span><br></pre></td></tr></table></figure>

<p>当块中任意任务出错时，rescue关键字对应的代码块就会被执行，而always关键字对应的代码块无论如何都会被执行。</p>
<p><strong><strong><strong>***</strong></strong></strong> 当你发现自己的才华撑不起野心时，就请安静下来学习吧！<strong><strong><strong>***</strong></strong></strong></p>
<p>原文链接：<a href="https://www.cnblogs.com/lvzhenjiang/p/14198755.html" target="_blank" rel="noopener">https://www.cnblogs.com/lvzhenjiang/p/14198755.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/05/14/ansible/ansible-playbook%E4%B8%AD%E7%9A%84%E5%8F%98%E9%87%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhangpengjie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/zpj.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zpj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/14/ansible/ansible-playbook%E4%B8%AD%E7%9A%84%E5%8F%98%E9%87%8F/" itemprop="url">ansible-playbook中的变量</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-14T12:49:42+08:00">
                2021-05-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ansible/" itemprop="url" rel="index">
                    <span itemprop="name">ansible</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/05/14/ansible/ansible-playbook%E4%B8%AD%E7%9A%84%E5%8F%98%E9%87%8F/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2021/05/14/ansible/ansible-playbook%E4%B8%AD%E7%9A%84%E5%8F%98%E9%87%8F/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原文链接：<a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html" target="_blank" rel="noopener">https://www.cnblogs.com/lvzhenjiang/p/14385777.html</a></p>
<h1 id="ansible-playbook中的变量"><a href="#ansible-playbook中的变量" class="headerlink" title="ansible playbook中的变量"></a><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html" target="_blank" rel="noopener">ansible playbook中的变量</a></h1><p>目录</p>
<ul>
<li>一、变量的优先级<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html#11-yaml陷阱" target="_blank" rel="noopener">1.1 YAML陷阱</a></li>
</ul>
</li>
<li>二、 Ansbile-playbook变量配置方法<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html#21-在inventory主机清单文件中定义变量" target="_blank" rel="noopener">2.1 在inventory主机清单文件中定义变量</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html#22-通过host_vars和group_vars目录来定义变量" target="_blank" rel="noopener">2.2 通过host_vars和group_vars目录来定义变量</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html#23-通过var_files定义变量" target="_blank" rel="noopener">2.3 通过var_files定义变量</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html#24-通过vars_prompt交互式传入变量" target="_blank" rel="noopener">2.4 通过vars_prompt交互式传入变量</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html#25-通过ansible-playbook命令行定义变量！即参数传入变量" target="_blank" rel="noopener">2.5 通过ansible-playbook命令行定义变量！即参数传入变量</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html#26-在playbook剧本中定义变量" target="_blank" rel="noopener">2.6 在playbook剧本中定义变量</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html#27-通过roles角色定义变量" target="_blank" rel="noopener">2.7 通过roles角色定义变量</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html#28-使用facts获取的信息" target="_blank" rel="noopener">2.8 使用Facts获取的信息</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html#29-register注册变量" target="_blank" rel="noopener">2.9 register注册变量</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html#210-hostvars-变量" target="_blank" rel="noopener">2.10 hostvars 变量</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14385777.html#211-列表变量、循环变量、字典变量" target="_blank" rel="noopener">2.11 列表变量、循环变量、字典变量</a></li>
</ul>
</li>
</ul>
<h3 id="一、变量的优先级"><a href="#一、变量的优先级" class="headerlink" title="一、变量的优先级"></a>一、变量的优先级</h3><ul>
<li><code>extra vars</code>变量（在命令行中使用 <code>-e</code>）；优先级最高；</li>
<li>在inventory中定义的连接变量（比如<code>ansible_ssh_user</code>）；优先级第二；</li>
<li>大多数的其他变量（命令行转换，play中的变量，include的变量，role的变量等）；优先级第三；</li>
<li>在<code>inventory</code>定义的其他变量；优先级第四；</li>
<li>有系统发现的<code>facts</code>；优先级第五；</li>
<li>“role默认变量”，这个是最默认的值，很容易丧失优先权。优先级最小；</li>
</ul>
<p>另外：在inventory清单列表里定义的变量：<strong>单个主机定义的变量优先级高于主机组定义的变量</strong><br>经过实验，ansible使用inventory定义变量的优先级顺序从高到低为：<br>host_vars下定义变量 —&gt; inventory中单个主机定义变量 —&gt; group_vars下定义变量 —&gt; inventory中组定义变量</p>
<h4 id="1-1-YAML陷阱"><a href="#1-1-YAML陷阱" class="headerlink" title="1.1 YAML陷阱"></a>1.1 YAML陷阱</h4><p>YAML语法要求如果值以开头的话，那么就需要将整行用双引号包起来，这是为了确认你不是想声明一个YAML字典。<br>如下面配置是不行的！！！</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">app_servers</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">app_path:</span> <span class="string">&#123;&#123;</span> <span class="string">base_path</span> <span class="string">&#125;&#125;/data/web</span></span><br></pre></td></tr></table></figure>

<p>应该改成下面这样：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">app_servers</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">app_path:</span> <span class="string">"<span class="template-variable">&#123;&#123; base_path &#125;&#125;</span>/data/web"</span></span><br></pre></td></tr></table></figure>

<h3 id="二、-Ansbile-playbook变量配置方法"><a href="#二、-Ansbile-playbook变量配置方法" class="headerlink" title="二、 Ansbile-playbook变量配置方法"></a>二、 Ansbile-playbook变量配置方法</h3><h4 id="2-1-在inventory主机清单文件中定义变量"><a href="#2-1-在inventory主机清单文件中定义变量" class="headerlink" title="2.1 在inventory主机清单文件中定义变量"></a>2.1 在inventory主机清单文件中定义变量</h4><p>可以直接定义在主机清单文件<code>/etc/ansible/hosts</code>中，表明该变量只对对应的主机或者组有效，对其余的主机和组无效。</p>
<p><strong>示例：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> egrep -v <span class="string">"^#|^$"</span> /etc/ansible/hosts </span></span><br><span class="line">10.4.7.101 key=20180101</span><br><span class="line">10.4.7.102 key="niubility"</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim ansi.yml </span></span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  gather_facts: False</span><br><span class="line">  tasks:</span><br><span class="line">    - name: haha</span><br><span class="line">      debug: msg="the &#123;&#123; inventory_hostname &#125;&#125; value is &#123;&#123; key &#125;&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行结果（注意inventory_hostname代表inventory列表列表里被控节点的主机名）：</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook ansi.yml </span></span><br><span class="line"></span><br><span class="line">PLAY [all] **************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [haha] *************************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; &#123;</span><br><span class="line">    "msg": "the 10.4.7.101 value is 20180101"</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.4.7.102] =&gt; &#123;</span><br><span class="line">    "msg": "the 10.4.7.102 value is niubility"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">10.4.7.102                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>

<h4 id="2-2-通过host-vars和group-vars目录来定义变量"><a href="#2-2-通过host-vars和group-vars目录来定义变量" class="headerlink" title="2.2 通过host_vars和group_vars目录来定义变量"></a>2.2 通过host_vars和group_vars目录来定义变量</h4><p><code>/etc/ansible/</code>目录是linux系统上ansible默认的配置文件目录（Mac系统上的话，其默认配置目录是在<code>/usr/local/etc/ansible/</code>），在该目录下创建<code>host_vars</code>和<code>group_vars</code>两个目录用来存放定义变量的文件。</p>
<p><strong>针对单个主机的变量</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat /etc/ansible/host_vars/10.4.7.101</span></span><br><span class="line">---</span><br><span class="line">user: root</span><br><span class="line">pass: root@123</span><br></pre></td></tr></table></figure>

<p><strong>针对test组的变量</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat /etc/ansible/group_vars/<span class="built_in">test</span></span></span><br><span class="line">---</span><br><span class="line">user: work</span><br><span class="line">pass: work@123</span><br></pre></td></tr></table></figure>

<p><strong>在inventory清单列表文件里，单个主机定义的变量优先级高于主机组定义的变量</strong></p>
<h4 id="2-3-通过var-files定义变量"><a href="#2-3-通过var-files定义变量" class="headerlink" title="2.3 通过var_files定义变量"></a>2.3 通过var_files定义变量</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat vars.yml </span></span><br><span class="line">---</span><br><span class="line">key: jiayou</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat bo.yml </span></span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  gather_facts: False</span><br><span class="line">  vars_files:</span><br><span class="line">      - vars.yml</span><br><span class="line">  tasks:</span><br><span class="line">    - name: display</span><br><span class="line">      debug: msg="the &#123;&#123; inventory_hostname &#125;&#125; valus is &#123;&#123; key &#125;&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook bo.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [all] **************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [display] **********************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; &#123;</span><br><span class="line">    "msg": "the 10.4.7.101 valus is jiayou"</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.4.7.102] =&gt; &#123;</span><br><span class="line">    "msg": "the 10.4.7.102 valus is jiayou"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">10.4.7.102                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>

<h4 id="2-4-通过vars-prompt交互式传入变量"><a href="#2-4-通过vars-prompt交互式传入变量" class="headerlink" title="2.4 通过vars_prompt交互式传入变量"></a>2.4 通过vars_prompt交互式传入变量</h4><p>在playbook中定义<code>vars_prompt</code>的变量名和交互式提示信息，就可以实现在运行playbook时，通过交互的传入变量值。<br><strong>private字段</strong>：用来定义交互时是否回显输入的值，默认private为yes；<br><strong>default字段</strong>：用来定义变量的默认值。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat prom.yml </span></span><br><span class="line">---</span><br><span class="line">- hosts: test</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars_prompt:</span><br><span class="line">      - name: "var1"</span><br><span class="line">        prompt: "please input you name"</span><br><span class="line">        private: no</span><br><span class="line">      - name: "var2"</span><br><span class="line">        prompt: "please input you age"</span><br><span class="line">        private: yes</span><br><span class="line">        default: 18</span><br><span class="line">  tasks:</span><br><span class="line">      - name: display var1</span><br><span class="line">        debug: msg="your name of var1 is &#123;&#123; var1 &#125;&#125;"</span><br><span class="line">      - name: display var2</span><br><span class="line">        debug: msg="you age of var2 is &#123;&#123; var2 &#125;&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook prom.yml </span></span><br><span class="line">please input you name: lvzhenjiang    # 把输入的内容传递给变量var1。输入的值显示出来！</span><br><span class="line">please input you age [18]:           # playbook中定义默认值是18，如果不输入便是18，但是输入的值不显示出来！比如这里输入的23</span><br><span class="line"></span><br><span class="line">PLAY [test] *************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">TASK [display var1] *****************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; &#123;</span><br><span class="line">    "msg": "your name of var1 is lvzhenjiang"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [display var2] *****************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; &#123;</span><br><span class="line">    "msg": "you age of var2 is 23"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>

<h4 id="2-5-通过ansible-playbook命令行定义变量！即参数传入变量"><a href="#2-5-通过ansible-playbook命令行定义变量！即参数传入变量" class="headerlink" title="2.5 通过ansible-playbook命令行定义变量！即参数传入变量"></a>2.5 通过ansible-playbook命令行定义变量！即参数传入变量</h4><p>除了<code>vars_prompt</code>和<code>vars_files</code>，也可以通过Ansible命令行发送变量。如果想要编写一个通用的发布playbook时则特别有用！你可以传递应用的版本以便部署。例如下面命令（注意： <code>--extra-vars</code> 相等于 -e）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat exap.yml </span></span><br><span class="line">---</span><br><span class="line">- hosts: '&#123;&#123;hosts&#125;&#125;'</span><br><span class="line">  remote_user: '&#123;&#123;user&#125;&#125;'</span><br><span class="line">  tasks:</span><br><span class="line">    - name: "一个测试"</span><br><span class="line">      debug: msg="your hosts is &#123;&#123;hosts&#125;&#125;, user is &#123;&#123;user&#125;&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">  ansible-playbook exap.yml -e <span class="string">"hosts=test user=root"</span> </span></span><br><span class="line">[WARNING]: Found variable using reserved name: hosts</span><br><span class="line"></span><br><span class="line">PLAY [test] *************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">TASK [一个测试] *************************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; &#123;</span><br><span class="line">    "msg": "your hosts is test, user is root"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>

<p><strong>也可以将参数放在文件里面进行传递（注意命令行里要是用<code>&quot;@文件名&quot;</code>）：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 同样使用上面的例子</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat anhui.yml </span></span><br><span class="line">---</span><br><span class="line">hosts: test</span><br><span class="line">user: root</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook exap.yml -e <span class="string">"@anhui.yml"</span></span></span><br><span class="line">[WARNING]: Found variable using reserved name: hosts</span><br><span class="line"></span><br><span class="line">PLAY [test] *************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">TASK [一个测试] *************************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; &#123;</span><br><span class="line">    "msg": "your hosts is test, user is root"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>

<h4 id="2-6-在playbook剧本中定义变量"><a href="#2-6-在playbook剧本中定义变量" class="headerlink" title="2.6 在playbook剧本中定义变量"></a>2.6 在playbook剧本中定义变量</h4><p>在playbook中定义变量需要用到Ansible的vars模块，可以将所有需要用到的变量统一在vars模块下定义，定义格式需要遵循YAML语言格式：</p>
<p>语法格式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vars:</span><br><span class="line">  - var1: value1</span><br><span class="line">  - var2: value2</span><br><span class="line">  - var3: value3</span><br><span class="line">  - ....: .....</span><br></pre></td></tr></table></figure>

<p>示例如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat playbook.yml </span></span><br><span class="line">---</span><br><span class="line">- hosts: test</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    - dir1: /root/Ansible</span><br><span class="line">    - dir2: /root/Ansible/test1</span><br><span class="line">    - dir3: /root/Ansible/test2</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Create New Folder</span><br><span class="line">      file: name=&#123;&#123; dir1 &#125;&#125; state=directory</span><br><span class="line">    - name: Create New Folder</span><br><span class="line">      file: name=&#123;&#123; dir2 &#125;&#125; state=directory</span><br><span class="line">    - name: Create New Folder</span><br><span class="line">      file: name=&#123;&#123; dir3 &#125;&#125; state=directory</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook playbook.yml </span></span><br><span class="line"></span><br><span class="line">PLAY [test] *************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">TASK [Create New Folder] ************************************************************************************************************************</span><br><span class="line">changed: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">TASK [Create New Folder] ************************************************************************************************************************</span><br><span class="line">changed: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">TASK [Create New Folder] ************************************************************************************************************************</span><br><span class="line">changed: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=4    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>

<h4 id="2-7-通过roles角色定义变量"><a href="#2-7-通过roles角色定义变量" class="headerlink" title="2.7 通过roles角色定义变量"></a>2.7 通过roles角色定义变量</h4><p>在Ansible的roles中定义变量，需要将变量及值的键值对形式写到roles的vars目录下的main.yml文件中，同样适用YAML语言格式，格式如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var1: value1</span><br><span class="line">var2: value2</span><br><span class="line">var3: value3</span><br></pre></td></tr></table></figure>

<p>但是请注意：通过Roles定义的变量只适用于当前roles。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> roles目录结构</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tree .</span></span><br><span class="line">.</span><br><span class="line">├── hosts</span><br><span class="line">├── playbook.yml</span><br><span class="line">└── test</span><br><span class="line">    ├── files</span><br><span class="line">    ├── tasks</span><br><span class="line">    │   └── main.yml</span><br><span class="line">    ├── templates</span><br><span class="line">    └── vars</span><br><span class="line">        └── main.yml</span><br><span class="line"></span><br><span class="line">5 directories, 4 files</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat <span class="built_in">test</span>/tasks/main.yml </span></span><br><span class="line">- name: create directory</span><br><span class="line">  file: name=&#123;&#123; dir &#125;&#125; state=directory</span><br><span class="line">- name: Get IP Address</span><br><span class="line">  shell: echo `&#123;&#123; cmd &#125;&#125;` &gt;&gt; &#123;&#123; dir &#125;&#125;/&#123;&#123; file &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat <span class="built_in">test</span>/vars/main.yml </span></span><br><span class="line">cmd: hostname -I</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat playbook.yml </span></span><br><span class="line">---</span><br><span class="line">- hosts: test</span><br><span class="line">  remote_user: root</span><br><span class="line">  roles:</span><br><span class="line">    - test</span><br><span class="line">    </span><br><span class="line"><span class="meta">$</span><span class="bash"> cat hosts </span></span><br><span class="line">[test]</span><br><span class="line">10.4.7.101 dir=/root/node2</span><br><span class="line">10.4.7.102 dir=/root/node1</span><br><span class="line"></span><br><span class="line">[node1]</span><br><span class="line">10.4.7.100</span><br><span class="line"></span><br><span class="line">[test:vars]</span><br><span class="line">file=hostname.txt</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook -i hosts  playbook.yml </span></span><br><span class="line"></span><br><span class="line">PLAY [test] *************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101]</span><br><span class="line">ok: [10.4.7.102]</span><br><span class="line"></span><br><span class="line">TASK [test : create directory] ******************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101]</span><br><span class="line">ok: [10.4.7.102]</span><br><span class="line"></span><br><span class="line">TASK [test : Get IP Address] ********************************************************************************************************************</span><br><span class="line">changed: [10.4.7.102]</span><br><span class="line">changed: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">10.4.7.102                 : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>

<h4 id="2-8-使用Facts获取的信息"><a href="#2-8-使用Facts获取的信息" class="headerlink" title="2.8 使用Facts获取的信息"></a>2.8 使用Facts获取的信息</h4><p>还有其它地方可以获取变量, 这些变量是自动发现的，而不是用户自己设置的。Facts通过访问远程系统获取相应的信息，一个很好的例子就是远程主机的IP地址或者操作系统是什么。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible <span class="built_in">test</span> -m setup</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用以下命令可以查看哪些信息是可用的（<span class="built_in">test</span>是上面在/etc/ansible/hosts列表文件中配置的主机群组）</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible <span class="built_in">test</span> -m setup|grep <span class="string">"ansible_python_version"</span></span></span><br><span class="line">        "ansible_python_version": "2.7.5", </span><br><span class="line"><span class="meta">#</span><span class="bash"> 在playbook中这样引用上面被控制主机的python版本: &#123;&#123; ansible_python_version &#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible <span class="built_in">test</span> -m setup|grep <span class="string">"ansible_nodename"</span></span></span><br><span class="line">        "ansible_nodename": "template", </span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以在playbook中这样引用上面被控制主机的主机名: &#123;&#123; ansible_nodename &#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible <span class="built_in">test</span> -m setup | grep <span class="string">"ansible_hostname"</span></span></span><br><span class="line">        "ansible_hostname": "template",</span><br><span class="line"><span class="meta">#</span><span class="bash"> 被控制主机的主机名变量还可以是: &#123;&#123; ansible_hostname &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>如果关闭Facts，可以大大提高ansible的执行速度 ，关闭方法如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat anhui.yml</span></span><br><span class="line">---</span><br><span class="line">- hosts: test</span><br><span class="line">  gather_facts: no</span><br></pre></td></tr></table></figure>

<h4 id="2-9-register注册变量"><a href="#2-9-register注册变量" class="headerlink" title="2.9 register注册变量"></a>2.9 register注册变量</h4><p>变量的另一个主要用途是在运行命令时，把命令结果存储到一个变量中，不同模块的执行结果是不同的。运行playbook时使用-v选项可以看到可能的结果值，ansible执行任务的结果值可以保存在变量中，以便稍后使用它。register方式主要用于在task之间传递变量。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat /etc/ansible/hosts</span></span><br><span class="line">[test]</span><br><span class="line">10.4.7.101</span><br><span class="line">10.4.7.102</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat register.yml</span></span><br><span class="line">---</span><br><span class="line">- hosts: test</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">      - name: register bo_test</span><br><span class="line">        shell: hostname -I</span><br><span class="line">        register: info</span><br><span class="line">      - name: display info</span><br><span class="line">        debug: msg="this host ip is &#123;&#123; info['stdout'] &#125;&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook register.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [test] *************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **************************************************************************************************</span><br><span class="line">ok: [10.4.7.102]</span><br><span class="line">ok: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">TASK [register bo_test] *************************************************************************************************</span><br><span class="line">changed: [10.4.7.102]</span><br><span class="line">changed: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">TASK [display info] *****************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; &#123;</span><br><span class="line">    "msg": "this host ip is 10.4.7.101 "</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.4.7.102] =&gt; &#123;</span><br><span class="line">    "msg": "this host ip is 10.4.7.102 "</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line">10.4.7.102                 : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>

<h4 id="2-10-hostvars-变量"><a href="#2-10-hostvars-变量" class="headerlink" title="2.10 hostvars 变量"></a>2.10 hostvars 变量</h4><p>该变量用于引用其他主机上收集的facts中的数据，或者引用其他主机的主机变量、主机组变量。即从一台远程主机获取另一台远程主机的变量。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat /etc/ansible/hosts</span></span><br><span class="line">[test]</span><br><span class="line">10.4.7.101 addr=beijing</span><br><span class="line">10.4.7.102 user=shibo age=39</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">---</span><br><span class="line">- hosts: test</span><br><span class="line">  remote_user: root</span><br><span class="line">  gather_facts: False</span><br><span class="line">  tasks:</span><br><span class="line">    - name: this is test1</span><br><span class="line">      debug: msg="She is come from &#123;&#123; hostvars['10.4.7.101']['addr'] &#125;&#125;"</span><br><span class="line">    - name: this is test2</span><br><span class="line">      debug: msg="I am &#123;&#123; hostvars['10.4.7.102']['user'] &#125;&#125;, and age is &#123;&#123; hostvars['10.4.7.102']['age'] &#125;&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [test] *************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [this is test1] ****************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; &#123;</span><br><span class="line">    "msg": "She is come from beijing"</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.4.7.102] =&gt; &#123;</span><br><span class="line">    "msg": "She is come from beijing"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [this is test2] ****************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; &#123;</span><br><span class="line">    "msg": "I am shibo, and age is 39"</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.4.7.102] =&gt; &#123;</span><br><span class="line">    "msg": "I am shibo, and age is 39"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line">10.4.7.102                 : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>

<h4 id="2-11-列表变量、循环变量、字典变量"><a href="#2-11-列表变量、循环变量、字典变量" class="headerlink" title="2.11 列表变量、循环变量、字典变量"></a>2.11 列表变量、循环变量、字典变量</h4><p><strong>1）ansible的变量不仅可以是单个的值，也可以为列表，即ansible传列表作为变量</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">---</span><br><span class="line">- hosts: test</span><br><span class="line">  remote_user: root</span><br><span class="line">  gather_facts: False</span><br><span class="line">  vars:</span><br><span class="line">    - list: [1,2,3]</span><br><span class="line">  tasks:</span><br><span class="line">    - name: echo</span><br><span class="line">      debug: msg="&#123;&#123; list &#125;&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [test] *************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [echo] *************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; &#123;</span><br><span class="line">    "msg": [</span><br><span class="line">        1,</span><br><span class="line">        2,</span><br><span class="line">        3</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.4.7.102] =&gt; &#123;</span><br><span class="line">    "msg": [</span><br><span class="line">        1,</span><br><span class="line">        2,</span><br><span class="line">        3</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line">10.4.7.102                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=</span><br></pre></td></tr></table></figure>

<p><strong>2）循环列表</strong></p>
<p>结合循环，这个特性就变得很有用；以参数传递列表给playbook，不用在playbook中固定循环的次数与内容。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">---</span><br><span class="line">- hosts: 10.4.7.101</span><br><span class="line">  remote_user: root</span><br><span class="line">  gather_facts: False</span><br><span class="line">  vars:</span><br><span class="line">    - list: [1,2,3]</span><br><span class="line">  tasks:</span><br><span class="line">    - name: this is loop</span><br><span class="line">      debug: msg="&#123;&#123; item &#125;&#125;"</span><br><span class="line">      with_items: '&#123;&#123;list&#125;&#125;'</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [10.4.7.101] *******************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [this is loop] *****************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; (item=1) =&gt; &#123;</span><br><span class="line">    "msg": 1</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.4.7.101] =&gt; (item=2) =&gt; &#123;</span><br><span class="line">    "msg": 2</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.4.7.101] =&gt; (item=3) =&gt; &#123;</span><br><span class="line">    "msg": 3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>

<p><strong><strong><strong>***</strong></strong></strong> 当你发现自己的才华撑不起野心时，就请安静下来学习吧！<strong><strong><strong>***</strong></strong></strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/05/14/ansible/ansible%E4%B8%ADtemplate%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhangpengjie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/zpj.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zpj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/14/ansible/ansible%E4%B8%ADtemplate%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" itemprop="url">ansible中template简单使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-14T12:45:10+08:00">
                2021-05-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ansible/" itemprop="url" rel="index">
                    <span itemprop="name">ansible</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/05/14/ansible/ansible%E4%B8%ADtemplate%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2021/05/14/ansible/ansible%E4%B8%ADtemplate%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ansible中template简单使用"><a href="#ansible中template简单使用" class="headerlink" title="ansible中template简单使用"></a><a href="https://www.cnblogs.com/lvzhenjiang/p/14199384.html" target="_blank" rel="noopener">ansible中template简单使用</a></h1><p>目录</p>
<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199384.html#一、模板（template）简介" target="_blank" rel="noopener">一、模板（template）简介</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199384.html#二、使用template部署nginx" target="_blank" rel="noopener">二、使用template部署nginx</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199384.html#三、playbook中when简单使用" target="_blank" rel="noopener">三、playbook中when简单使用</a></li>
<li>四、playbook中with_items简单使用<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199384.html#41-迭代：with_items" target="_blank" rel="noopener">4.1 迭代：with_items</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199384.html#42-迭代嵌套子变量" target="_blank" rel="noopener">4.2 迭代嵌套子变量</a></li>
</ul>
</li>
<li>五、template循环示例<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199384.html#51-第一种写法" target="_blank" rel="noopener">5.1 第一种写法</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199384.html#52-第二种写法" target="_blank" rel="noopener">5.2 第二种写法</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199384.html#53-第三种写法" target="_blank" rel="noopener">5.3 第三种写法</a></li>
</ul>
</li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199384.html#六、playbook中if简单使用" target="_blank" rel="noopener">六、playbook中if简单使用</a></li>
</ul>
<h3 id="一、模板（template）简介"><a href="#一、模板（template）简介" class="headerlink" title="一、模板（template）简介"></a>一、模板（template）简介</h3><ul>
<li>文件文件，嵌套有脚本（使用模板编程语言编写）；</li>
<li>jinja2语言，使用字面量，有以下形式：<ul>
<li>字符串：使用单引号或双引号；</li>
<li>数字：整数，浮点数；</li>
<li>列表：[ item1,item2,……]</li>
<li>元组：(item1,item2,……)</li>
<li>字典：{key1:value1,key2,value2,……}</li>
<li>布尔型：true/false</li>
</ul>
</li>
<li>算术运算：+，-，<em>，/，//，%，*</em></li>
<li>比较操作：==，!=，&gt;，&gt;=，&lt;，&lt;=</li>
<li>逻辑运算：and，or，not</li>
<li>流表达式：for，if，when</li>
</ul>
<h3 id="二、使用template部署nginx"><a href="#二、使用template部署nginx" class="headerlink" title="二、使用template部署nginx"></a>二、使用template部署nginx</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ls     //建议，安装nginx的yaml和templates目录在同一目录下</span></span><br><span class="line">install_nginx.yaml  templates</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat install_nginx.yaml </span></span><br><span class="line">---</span><br><span class="line">- hosts: webservers</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:         #创建变量信息</span><br><span class="line">    - http_port: 8888</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: install package</span><br><span class="line">      yum: name=nginx</span><br><span class="line">    - name: template copy</span><br><span class="line">      template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf   #由于模板文件在tmplate下，所以src后的路径就可以只写配置文件名称</span><br><span class="line">      notify: restart service    #定义notify便于修改文件重启服务</span><br><span class="line">    - name: start service</span><br><span class="line">      service: name=nginx state=started enabled=yes</span><br><span class="line"></span><br><span class="line">  handlers:    #定义重启服务策略</span><br><span class="line">    - name: restart service</span><br><span class="line">      service: name=nginx state=restarted</span><br><span class="line"><span class="meta">$</span><span class="bash"> ls templates/     <span class="comment">#注意模板的文件名称有一定的要求</span></span></span><br><span class="line">nginx.conf.j2</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat templates/nginx.conf.j2    <span class="comment">#该文件就是nginx的配置文件复制而成的</span></span></span><br><span class="line">…………      #省略部分内容</span><br><span class="line">worker_processes &#123;&#123; ansible_processor_vcpus**2 &#125;&#125;;    #使用变量是cpu核心数的2次方</span><br><span class="line">listen       &#123;&#123; http_port &#125;&#125; default_server;</span><br><span class="line">listen       [::]:&#123;&#123; http_port &#125;&#125; default_server;</span><br><span class="line"><span class="meta">#</span><span class="bash">使用playbook中定义的变量信息</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook install_nginx.yaml</span></span><br><span class="line"><span class="meta">#</span><span class="bash">运行playbook文件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible webservers -m shell -a <span class="string">'rpm -q nginx'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">nginx确实已经安装成功</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible webservers -m shell -a <span class="string">'ss -lnt | grep 8888'</span> </span></span><br><span class="line"><span class="meta">#</span><span class="bash">端口已经正常开启</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible webservers -m shell -a <span class="string">'ps aux | grep nginx'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">确认工作进程数是预期设定的值</span></span><br></pre></td></tr></table></figure>

<p>至此template批量部署nginx已经实现！</p>
<h3 id="三、playbook中when简单使用"><a href="#三、playbook中when简单使用" class="headerlink" title="三、playbook中when简单使用"></a>三、playbook中when简单使用</h3><p><strong>when</strong>：可以简单理解为一个条件判断，类似于shell脚本中的if语句！</p>
<p>因为ansible管理的主机可能不是一个系统版本的，那么就需要区别部署了！</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible all -m setup -a <span class="string">'filter=*distribution*'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">查看ansible默认支持的变量</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat install_nginx.yaml </span></span><br><span class="line">---</span><br><span class="line">- hosts: all     #针对所有主机</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    - http_port: 8888</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: install package</span><br><span class="line">      yum: name=nginx</span><br><span class="line">    - name: template copy for centos7</span><br><span class="line">      template: src=nginx.conf7.j2 dest=/etc/nginx/nginx.conf</span><br><span class="line">      when: ansible_distribution_major_version == "7"    #当检测到系统版本为7才执行本模块的操作</span><br><span class="line">      notify: restart service</span><br><span class="line">    - name: template copy for centos6</span><br><span class="line">      template: src=nginx.conf6.j2 dest=/etc/nginx/nginx.conf</span><br><span class="line">      when: ansible_distribution_major_version == "6"</span><br><span class="line">      notify: restart service</span><br><span class="line">    - name: start service</span><br><span class="line">      service: name=nginx state=started enabled=yes</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">    - name: restart service</span><br><span class="line">      service: name=nginx state=restarted</span><br><span class="line"><span class="meta">$</span><span class="bash"> ls templates/   <span class="comment">#注意一个是nginx6的配置文件，一个nginx7的配置文件</span></span></span><br><span class="line">nginx.conf6.j2  nginx.conf7.j2</span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook install_nginx.yaml</span></span><br><span class="line"><span class="meta">#</span><span class="bash">执行playbook文件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible all -m shell -a <span class="string">'ss -lntp | grep nginx'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">确认centos 6系统的nginx已经启动</span></span><br></pre></td></tr></table></figure>

<h3 id="四、playbook中with-items简单使用"><a href="#四、playbook中with-items简单使用" class="headerlink" title="四、playbook中with_items简单使用"></a>四、playbook中with_items简单使用</h3><h4 id="4-1-迭代：with-items"><a href="#4-1-迭代：with-items" class="headerlink" title="4.1 迭代：with_items"></a>4.1 迭代：with_items</h4><p><strong>迭代：with_items</strong>：当有需要重复性执行任务是，可以使用迭代机制！</p>
<ul>
<li>带迭代项的引用，固定变量为“item”；</li>
<li>在task中使用with_items定义需要迭代的元素列表；</li>
<li>列表格式：<ul>
<li>字符串；</li>
<li>字典；</li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test.yaml </span></span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: touch some file</span><br><span class="line">      file: name=/data/&#123;&#123; item &#125;&#125; state=touch   #文件名定义为列表元素</span><br><span class="line">      when: ansible_distribution_major_version == "7"</span><br><span class="line">      with_items:      #定义列表元素</span><br><span class="line">        - file1</span><br><span class="line">        - file2</span><br><span class="line">        - file3</span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible all -m shell -a <span class="string">'ls -l /data'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">当满足条件的主机都创建了文件</span></span><br></pre></td></tr></table></figure>

<h4 id="4-2-迭代嵌套子变量"><a href="#4-2-迭代嵌套子变量" class="headerlink" title="4.2 迭代嵌套子变量"></a>4.2 迭代嵌套子变量</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test1.yaml </span></span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: create some group</span><br><span class="line">      group: name=&#123;&#123; item &#125;&#125;</span><br><span class="line">      with_items:</span><br><span class="line">        - g1</span><br><span class="line">        - g2</span><br><span class="line">        - g3</span><br><span class="line">    - name: create some users</span><br><span class="line">      user: name=&#123;&#123; item.name &#125;&#125; group=&#123;&#123; item.group &#125;&#125;</span><br><span class="line">      with_items:</span><br><span class="line">        - &#123; name: 'user1', group: 'g1'&#125;</span><br><span class="line">        - &#123; name: 'user2', group: 'g2'&#125;</span><br><span class="line">        - &#123; name: 'user3', group: 'g3'&#125;</span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test1.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible all -m shell -a <span class="string">'getent group'</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible all -m shell -a <span class="string">'getent passwd'</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible all -m shell -a <span class="string">'id user1'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">进行验证</span></span><br></pre></td></tr></table></figure>

<h3 id="五、template循环示例"><a href="#五、template循环示例" class="headerlink" title="五、template循环示例"></a>五、template循环示例</h3><h4 id="5-1-第一种写法"><a href="#5-1-第一种写法" class="headerlink" title="5.1 第一种写法"></a>5.1 第一种写法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test2.yaml </span></span><br><span class="line">---</span><br><span class="line">- hosts: webservers</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    ports:</span><br><span class="line">      - 81</span><br><span class="line">      - 82</span><br><span class="line">      - 83</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: copy conf</span><br><span class="line">      template: src=for2.conf.j2 dest=/data/for2.conf</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat templates/for2.conf.j2 </span></span><br><span class="line">&#123;% for port in ports %&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen &#123;&#123; port &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test2.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible webservers -m shell -a <span class="string">'cat /data/for2.conf'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">进行验证</span></span><br></pre></td></tr></table></figure>

<h4 id="5-2-第二种写法"><a href="#5-2-第二种写法" class="headerlink" title="5.2 第二种写法"></a>5.2 第二种写法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test3.yaml </span></span><br><span class="line">---</span><br><span class="line">- hosts: webservers</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    ports:</span><br><span class="line">      - listen_port: 81</span><br><span class="line">      - listen_port: 82</span><br><span class="line">      - listen_port: 83</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: copy conf</span><br><span class="line">      template: src=for3.conf.j2 dest=/data/for3.conf</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat templates/for3.conf.j2 </span></span><br><span class="line">&#123;% for port in ports %&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen &#123;&#123; port.listen_port &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test3.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible webservers -m shell -a <span class="string">'cat /data/for3.conf'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">进行验证</span></span><br></pre></td></tr></table></figure>

<h4 id="5-3-第三种写法"><a href="#5-3-第三种写法" class="headerlink" title="5.3 第三种写法"></a>5.3 第三种写法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test4.yaml </span></span><br><span class="line">---</span><br><span class="line">- hosts: webservers</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    ports:</span><br><span class="line">      - web1:</span><br><span class="line">        port: 81</span><br><span class="line">        name: web1.lzj.com</span><br><span class="line">        rootdir: /data/web1</span><br><span class="line">      - web2:</span><br><span class="line">        port: 82</span><br><span class="line">        name: web2.lzj.com</span><br><span class="line">        rootdir: /data/web2</span><br><span class="line">      - web1:</span><br><span class="line">        port: 83</span><br><span class="line">        name: web3.lzj.com</span><br><span class="line">        rootdir: /data/web3</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: copy conf</span><br><span class="line">      template: src=for4.conf.j2 dest=/data/for4.conf</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat templates/for4.conf.j2 </span></span><br><span class="line">&#123;% for p in ports %&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen &#123;&#123; p.port &#125;&#125;</span><br><span class="line">	servername &#123;&#123; p.name &#125;&#125;</span><br><span class="line">	documentroot &#123;&#123; p.rootdir &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test4.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible webservers -m shell -a <span class="string">'cat /data/for4.conf'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">进行验证</span></span><br></pre></td></tr></table></figure>

<h3 id="六、playbook中if简单使用"><a href="#六、playbook中if简单使用" class="headerlink" title="六、playbook中if简单使用"></a>六、playbook中if简单使用</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test5.yaml </span></span><br><span class="line">---</span><br><span class="line">- hosts: webservers</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    ports:</span><br><span class="line">      - web1:</span><br><span class="line">        port: 81</span><br><span class="line">        rootdir: /data/web1</span><br><span class="line">      - web2:</span><br><span class="line">        port: 82</span><br><span class="line">        name: web2.lzj.com</span><br><span class="line">        rootdir: /data/web2</span><br><span class="line">      - web1:</span><br><span class="line">        port: 83</span><br><span class="line">        rootdir: /data/web3</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: copy conf</span><br><span class="line">      template: src=for5.conf.j2 dest=/data/for5.conf</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat templates/for5.conf.j2 </span></span><br><span class="line">&#123;% for p in ports %&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen &#123;&#123; p.port &#125;&#125;</span><br><span class="line">&#123;% if p.name is defined%&#125;    #如果名称被定义了才给名字赋值</span><br><span class="line">	servername &#123;&#123; p.name &#125;&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">	documentroot &#123;&#123; p.rootdir &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test5.yaml	  </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible webservers -m shell -a <span class="string">'cat /data/for5.conf'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">进行验证</span></span><br></pre></td></tr></table></figure>

<p><strong><strong><strong>***</strong></strong></strong> 当你发现自己的才华撑不起野心时，就请安静下来学习吧！<strong><strong><strong>***</strong></strong></strong></p>
<p>原文链接：<a href="https://www.cnblogs.com/lvzhenjiang/p/14199384.html" target="_blank" rel="noopener">https://www.cnblogs.com/lvzhenjiang/p/14199384.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/05/14/ansible/ansible%E4%B9%8Broles%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhangpengjie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/zpj.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zpj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/14/ansible/ansible%E4%B9%8Broles%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" itemprop="url">ansible之roles简单使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-14T12:44:28+08:00">
                2021-05-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ansible/" itemprop="url" rel="index">
                    <span itemprop="name">ansible</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/05/14/ansible/ansible%E4%B9%8Broles%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2021/05/14/ansible/ansible%E4%B9%8Broles%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ansible之roles简单使用"><a href="#ansible之roles简单使用" class="headerlink" title="ansible之roles简单使用"></a><a href="https://www.cnblogs.com/lvzhenjiang/p/14199463.html" target="_blank" rel="noopener">ansible之roles简单使用</a></h1><p>目录</p>
<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199463.html#一、roles简介" target="_blank" rel="noopener">一、roles简介</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199463.html#二、简单的roles示例" target="_blank" rel="noopener">二、简单的roles示例</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199463.html#三、roles示例二" target="_blank" rel="noopener">三、roles示例二</a></li>
</ul>
<h3 id="一、roles简介"><a href="#一、roles简介" class="headerlink" title="一、roles简介"></a>一、roles简介</h3><p>将多种不同的tasks的文件集中存储在某个目录下，则该目录就是角色，角色一般存放在/etc/ansible/roles/目录下，可通过ansible的配置文件来调整默认的角色目录，/etc/ansible/roles/目录下有很多子目录，其中每一个子目录对应一个角色，每个角色也有自己的目录结构，如图：</p>
<p><img src="https://gitee.com/lvzhenjiang/document/raw/master/%E5%B0%8F%E4%B9%A6%E5%8C%A0/20200322142808.png" alt="20200322142808"></p>
<p>每个角色的定义，以特定的层级目录结构进行组织。比如：</p>
<ul>
<li>files：存放有copy或script等模块调用的文件；</li>
<li>templates：存放template模块查找所需要的模板文件的目录；</li>
<li>tasks：任务存放的目录；</li>
<li>handlers：存放相关触发执行器的目录；</li>
<li>vars：变量存放的目录；</li>
<li>meta：用于存放此角色元数据；</li>
<li>default：默认变量存放的目录，文件中定义了此角色使用的默认变量；</li>
</ul>
<p>上述目录中，tasks、handlers、vars、meta、default至少应该包含一个main.yaml文件，该目录下也可由其他.yaml文件，但是需要在main.yml文件中用include指令将其他.yml文件包含起来。</p>
<h3 id="二、简单的roles示例"><a href="#二、简单的roles示例" class="headerlink" title="二、简单的roles示例"></a>二、简单的roles示例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir roles   </span></span><br><span class="line"><span class="meta">#</span><span class="bash">创建一个目录，名称为roles。官方推荐在/etc/ansible/roles/这个目录，不过在哪里都是可以的</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir roles/nginx</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> roles/nginx/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir tasks templates</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> tasks/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat user.yaml </span></span><br><span class="line">- name: create user</span><br><span class="line">  user: name=nginx uid=80 group=nginx system=yes shell=/sbin/nologin</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat group.yaml </span></span><br><span class="line">- name: create group</span><br><span class="line">  group: name=nginx gid=80</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat yum.yaml </span></span><br><span class="line">- name: install package</span><br><span class="line">  yum: name=nginx</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat templ.yaml </span></span><br><span class="line">- name: copy conf</span><br><span class="line">  template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf </span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat stservice.yaml </span></span><br><span class="line">- name: start service</span><br><span class="line">  service: name=nginx state=started enabled=yes</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat main.yaml </span></span><br><span class="line">- include: group.yaml</span><br><span class="line">- include: user.yaml</span><br><span class="line">- include: yum.yaml</span><br><span class="line">- include: templ.yaml</span><br><span class="line">- include: stservice.yaml</span><br><span class="line"><span class="meta">#</span><span class="bash">如果需要调用别的角色的yaml文件，也可以这样写，比如：- include：roles/httpd/tasks/copyfile.yaml</span></span><br><span class="line">注意：copyfiile.yaml文件中的源路径必须是绝对路径</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls</span></span><br><span class="line">nginx.conf.j2</span><br><span class="line"><span class="meta">#</span><span class="bash">该文件就是nginx的配置文件改名了而已</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ../../../</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat nginx.yaml </span></span><br><span class="line">- hosts: webservers</span><br><span class="line">  remote_user: root</span><br><span class="line">  roles:</span><br><span class="line">    - role: nginx    </span><br><span class="line"><span class="meta">#</span><span class="bash">定义了多个角色，也可在接着写，每行调用一个角色</span></span><br><span class="line"><span class="meta">#</span><span class="bash">也可以定义tags标签，比如：- &#123; roles： httpd ，tags：[<span class="string">'web'</span>,<span class="string">'httpd'</span>]&#125;或- &#123; roles： httpd ，tags：<span class="string">'web'</span>  如果需要加when语句，在此处添加 &#125;都可以</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls</span></span><br><span class="line">nginx.yaml  roles</span><br><span class="line"><span class="meta">#</span><span class="bash">确保调用nginx的yaml文件是和roles是在同一目录下的</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tree</span></span><br><span class="line">.</span><br><span class="line">├── nginx.yaml</span><br><span class="line">└── roles</span><br><span class="line">    └── nginx</span><br><span class="line">        ├── tasks</span><br><span class="line">        │   ├── group.yaml</span><br><span class="line">        │   ├── main.yaml</span><br><span class="line">        │   ├── reservice.yaml</span><br><span class="line">        │   ├── stservice.yaml</span><br><span class="line">        │   ├── templ.yaml</span><br><span class="line">        │   ├── user.yaml</span><br><span class="line">        │   └── yum.yaml</span><br><span class="line">        └── templates</span><br><span class="line">            └── nginx.conf.j2</span><br><span class="line"><span class="meta">#</span><span class="bash">确保目录的层次效果是这样的</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook nginx.yaml </span></span><br><span class="line"><span class="meta">#</span><span class="bash">如果定义了标签，就可对标签进行操作（比如：web或httpd）</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible webservers -m shell -a <span class="string">'ss -lntp | grep nginx'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">确认被控端的主机nginx已经启动</span></span><br></pre></td></tr></table></figure>

<p>一个简单的nginx的roles已经编写完成了！</p>
<h3 id="三、roles示例二"><a href="#三、roles示例二" class="headerlink" title="三、roles示例二"></a>三、roles示例二</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir app</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> app/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir tasks templates vars handlers files</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> tasks/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat group.yaml </span></span><br><span class="line">- name: create group</span><br><span class="line">  group: name=apache system=yes</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat user.yaml </span></span><br><span class="line">- name: create user</span><br><span class="line">  user: name=apache group=apache system=yes shell=/sbin/nologin</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat yum.yaml </span></span><br><span class="line">- name: install package</span><br><span class="line">  yum: name=httpd</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat templ.yaml </span></span><br><span class="line">- name: copy file</span><br><span class="line">  template: src=httpd.conf.j2 dest=/etc/httpd/httpd.conf</span><br><span class="line">  notify: restart service</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat copyfile.yaml </span></span><br><span class="line">- name: copy config</span><br><span class="line">  copy: src=vhosts.conf dest=/etc/httpd/conf.d/ owner=apache</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat start.yaml </span></span><br><span class="line">- name: start service</span><br><span class="line">  service: name=httpd state=started</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat main.yaml </span></span><br><span class="line">- include: group.yaml</span><br><span class="line">- include: user.yaml</span><br><span class="line">- include: yum.yaml</span><br><span class="line">- include: templ.yaml</span><br><span class="line">- include: copyfile.yaml</span><br><span class="line">- include: start.yaml</span><br><span class="line"><span class="meta">$</span><span class="bash"> ls files/vhosts.conf </span></span><br><span class="line">files/vhosts.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">空文件用于测试</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat handlers/main.yaml </span></span><br><span class="line">- name: restart service</span><br><span class="line">  service: name=httpd state=restarted</span><br><span class="line"><span class="meta">$</span><span class="bash"> cat templates/httpd.conf.j2 </span></span><br><span class="line"><span class="meta">#</span><span class="bash">httpd的配置文件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat vars/main.yaml </span></span><br><span class="line">username: apache</span><br><span class="line">groupname: apache</span><br><span class="line"><span class="meta">$</span><span class="bash"> tree</span></span><br><span class="line">.</span><br><span class="line">├── files</span><br><span class="line">│   └── vhosts.conf</span><br><span class="line">├── handlers</span><br><span class="line">│   └── main.yaml</span><br><span class="line">├── tasks</span><br><span class="line">│   ├── copyfile.yaml</span><br><span class="line">│   ├── group.yaml</span><br><span class="line">│   ├── main.yaml</span><br><span class="line">│   ├── start.yaml</span><br><span class="line">│   ├── templ.yaml</span><br><span class="line">│   ├── user.yaml</span><br><span class="line">│   └── yum.yaml</span><br><span class="line">├── templates</span><br><span class="line">│   └── httpd.conf.j2</span><br><span class="line">└── vars</span><br><span class="line">    └── main.yaml</span><br><span class="line"><span class="meta">#</span><span class="bash">目录结构</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat httpd.yaml </span></span><br><span class="line">---</span><br><span class="line">- hosts: webservers</span><br><span class="line">  remote_user: root</span><br><span class="line">  roles:</span><br><span class="line">    - httpd</span><br><span class="line"><span class="meta">$</span><span class="bash"> ls</span></span><br><span class="line">httpd.yaml  nginx.yaml  roles</span><br><span class="line"><span class="meta">#</span><span class="bash">确保与roles目录在同一目录下</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook httpd.yaml </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible all -m shell -a <span class="string">'ps -ef | grep apache'</span></span></span><br><span class="line">//根据配置文件中修改的内容自行进行修改</span><br></pre></td></tr></table></figure>

<p><strong><strong><strong>***</strong></strong></strong> 当你发现自己的才华撑不起野心时，就请安静下来学习吧！<strong><strong><strong>***</strong></strong></strong></p>
<p>原文链接：<a href="https://www.cnblogs.com/lvzhenjiang/p/14199463.html" target="_blank" rel="noopener">https://www.cnblogs.com/lvzhenjiang/p/14199463.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/05/14/ansible/Ansible%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E2%80%94%E2%80%94%E6%8F%90%E5%8D%87ansible%E6%89%A7%E8%A1%8C%E6%95%88%E7%8E%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhangpengjie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/zpj.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zpj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/14/ansible/Ansible%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E2%80%94%E2%80%94%E6%8F%90%E5%8D%87ansible%E6%89%A7%E8%A1%8C%E6%95%88%E7%8E%87/" itemprop="url">Ansible性能优化——提升ansible执行效率</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-14T12:43:01+08:00">
                2021-05-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ansible/" itemprop="url" rel="index">
                    <span itemprop="name">ansible</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/05/14/ansible/Ansible%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E2%80%94%E2%80%94%E6%8F%90%E5%8D%87ansible%E6%89%A7%E8%A1%8C%E6%95%88%E7%8E%87/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2021/05/14/ansible/Ansible%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E2%80%94%E2%80%94%E6%8F%90%E5%8D%87ansible%E6%89%A7%E8%A1%8C%E6%95%88%E7%8E%87/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原文链接：<a href="https://www.cnblogs.com/lvzhenjiang/p/14386197.html" target="_blank" rel="noopener">https://www.cnblogs.com/lvzhenjiang/p/14386197.html</a></p>
<h1 id="Ansible性能优化——提升ansible执行效率"><a href="#Ansible性能优化——提升ansible执行效率" class="headerlink" title="Ansible性能优化——提升ansible执行效率"></a><a href="https://www.cnblogs.com/lvzhenjiang/p/14386197.html" target="_blank" rel="noopener">Ansible性能优化——提升ansible执行效率</a></h1><p>目录</p>
<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14386197.html#一、关闭gathering-facts功能" target="_blank" rel="noopener">一、关闭gathering facts功能</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14386197.html#二、开启ssh-pipelining" target="_blank" rel="noopener">二、开启SSH pipelining</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14386197.html#三、开启ssh长连接" target="_blank" rel="noopener">三、开启SSH长连接</a></li>
<li>三、设置facts缓存<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14386197.html#31-使用json文件缓存" target="_blank" rel="noopener">3.1 使用json文件缓存</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14386197.html#32-使用redis存储facts文件需安装redis，还需要安装python库" target="_blank" rel="noopener">3.2 使用redis存储facts文件需安装redis，还需要安装python库</a></li>
</ul>
</li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14386197.html#四、ansible取消交互" target="_blank" rel="noopener">四、Ansible取消交互</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14386197.html#五、ansible的-t选项，提高ansible执行效率" target="_blank" rel="noopener">五、Ansible的-t选项，提高ansible执行效率</a></li>
</ul>
<p>最初，ansible的执行效率和saltstack(基于zeromq消息队列的方式)相比要慢的多的多，特别是被控节点量很大的时候。但是ansible发展到现在，它的效率得到了极大的改善。在被控节点不太多的时候，默认的设置已经够快。即使被控节点数量巨大的时候，也可以通过一些优化去极大的提高ansible的执行效率。所以在使用 Ansible 的过程中，当管理的服务器数量增加时，不得不面对一个无法避免的问题执行效率慢，这里列出一些解决办法。</p>
<h3 id="一、关闭gathering-facts功能"><a href="#一、关闭gathering-facts功能" class="headerlink" title="一、关闭gathering facts功能"></a>一、关闭gathering facts功能</h3><p>如果观察过ansible-playbook的执行过程，就会发现ansible-playbook的第1个步骤总是执行gather facts，不论你有没有在playbook设定这个tasks。<br>如果你不需要获取被控机器的fact数据的话，就可以关闭获取fact数据功能。关闭之后，可以加快ansible-playbook的执行效率，尤其是你管理很大量的机器时，这非常明显。<br>关闭获取facts很简单，只需要在playbook文件中加上<code>&quot;gather_facts: False&quot;</code> 或者 <code>&quot;gather_facts: No&quot;</code>即可（False和No都为小写也可以）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">- hosts: test_server</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: this is a test</span><br><span class="line">      shell: echo "haha"</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行这个paly，会发现第一个执行的是gather facts，因为默认是打开gather facts功能的！！！！</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [test_server] ******************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **************************************************************************************************</span><br><span class="line">ok: [10.4.7.102]</span><br><span class="line">ok: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">TASK [this is a test] ***************************************************************************************************</span><br><span class="line">changed: [10.4.7.102]</span><br><span class="line">changed: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line">10.4.7.102                 : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>

<p><strong>现在关闭gathering facts功能</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">- hosts: test_server</span><br><span class="line">  remote_user: root</span><br><span class="line">  gather_facts: False</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: this is a test</span><br><span class="line">      shell: echo "haha"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 再执行这个play，就会发现没有了gathering facts执行过程，整个执行速度也快了！</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook test.yml</span></span><br><span class="line"></span><br><span class="line">PLAY [test_server] ******************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [this is a test] ***************************************************************************************************</span><br><span class="line">changed: [10.4.7.102]</span><br><span class="line">changed: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line">10.4.7.102                 : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>

<h3 id="二、开启SSH-pipelining"><a href="#二、开启SSH-pipelining" class="headerlink" title="二、开启SSH pipelining"></a>二、开启SSH pipelining</h3><p>pipeline是openssh的一个特性，<code>ssh pipelining</code> 是一个加速Ansible执行速度的简单方法。</p>
<p>在ansible执行每个任务的整个流程中，有一个过程是将临时任务文件put到远程的ansible客户机上，然后通过<code>ssh</code>连接过去远程执行这个任务。<br>如果开启了pipelining，一个任务的所有动作都在一个<code>ssh</code>会话中完成，也会省去<code>sftp</code>到远端的过程，它会直接将要执行的任务在<code>ssh</code>会话中进行。</p>
<p>ssh``pipelining 默认是关闭!!!!之所以默认关闭是为了兼容不同的<code>sudo</code>配置，主要是 requiretty 选项。如果不使用<code>sudo</code>，建议开启！！！<br>打开此选项可以减少ansible执行没有传输时<code>ssh</code>在被控机器上执行任务的连接数。<br>不过，如果使用<code>sudo</code>，必须关闭requiretty选项。修改<code>/etc/ansible/ansible.cfg</code> 文件可以开启pipelining</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim /etc/ansible/ansible.cfg</span></span><br><span class="line">........</span><br><span class="line">pipelining = True</span><br></pre></td></tr></table></figure>

<p>这样开启了pipelining之后, ansible执行的整个流程就少了一个PUT脚本去远程服务端的流程，然后就可以批量对机器执行命令试下，可以明显感受到速度的提升。</p>
<hr>
<p>但是要注意的是：<br><strong>如果在ansible中使用<code>sudo</code>命令的话(<code>ssh user@host sudo cmd</code>)，需要在被控节点的<code>/etc/sudoers</code>中禁用<code>&quot;requiretty&quot;</code>!!!!</strong></p>
<p>之所以要设置<code>/etc/sudoers</code>中的requiretty，是因为<code>ssh</code>远程执行命令时，它的环境是非登录式非交互式shell，默认不会分配<code>tty</code>，没有<code>tty</code>，<code>ssh</code>的<code>sudo</code>就无法关闭密码回显(使用<br>“-tt”选项强制SSH分配<code>tty</code>)。所以出于安全考虑，<code>/etc/sudoers</code>中默认是开启requiretty的，它要求只有拥有<code>tty</code>的用户才能使用<code>sudo</code>，也就是说<code>ssh</code>连接过去不允许执行<code>sudo</code>。<br>可以通过visudo编辑配置文件，注释该选项来禁用它。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> grep requiretty /etc/sudoers　　</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Defaults  requiretty</span></span><br></pre></td></tr></table></figure>

<h3 id="三、开启SSH长连接"><a href="#三、开启SSH长连接" class="headerlink" title="三、开启SSH长连接"></a>三、开启SSH长连接</h3><p>ansible天然支持openssh，默认连接方式下，它对<code>ssh</code>的依赖性非常强。所以优化<code>ssh</code>连接，在一定程度上也在优化ansible。其中一点是开启<code>ssh</code>的长连接，即长时间保持连接状态。</p>
<p>Ansible模式是使用SSH和远程主机进行通信, 所以Ansible对SSH的依赖性非常强, 在OpenSSH 5.6版本以后SSH就支持了Multiplexing（多路复用）。<br>所以如果Ansible中控机的SSH -V版本高于5.6时, 就可以使用ControlPersist来提高<code>ssh</code>连接速度，从而提高ansible执行效率。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat /etc/redhat-release </span></span><br><span class="line">CentOS Linux release 7.6.1810 (Core) </span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ssh -V</span></span><br><span class="line">OpenSSH_7.4p1, OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim /etc/ansible/ansible.cfg</span></span><br><span class="line">..........</span><br><span class="line">ssh_args = -C -o ControlMaster=auto -o ControlPersist=5d</span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意：ConrolPersist=5d, 这个参数是设置整个长连接保持时间为5天。</span></span><br></pre></td></tr></table></figure>

<p>开启此参数的<code>ssh</code>长连接功能后，在会话过期前会一直建立连接，在<code>netstat</code>的结果中会看到<code>ssh</code>连接是一直established状态，且通过SSH连接过的设备都会在当前用户家目录的<br><code>&quot;.ansible/cp&quot;</code>目录下生成一个socket文件，每个会话对应生成一个socket文件。也可以通过<code>netstat</code>命令查看, 会发现有一个ESTABLISHED状态的连接一直与远程设备进行着TCP连接。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ps -ef|grep ssh|grep ansible</span></span><br><span class="line">root      26064      1  0 17:32 ?        00:00:00 ssh: /root/.ansible/cp/cb9972d2a5 [mux]</span><br><span class="line">root      26067      1  0 17:32 ?        00:00:00 ssh: /root/.ansible/cp/baefa88ac8 [mux]</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ps -ef|grep ssh|grep /root</span></span><br><span class="line">root      26064      1  0 17:32 ?        00:00:00 ssh: /root/.ansible/cp/cb9972d2a5 [mux]</span><br><span class="line">root      26067      1  0 17:32 ?        00:00:00 ssh: /root/.ansible/cp/baefa88ac8 [mux]</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls /root/.ansible/cp/</span></span><br><span class="line">baefa88ac8  cb9972d2a5</span><br></pre></td></tr></table></figure>

<p>需要注意：<br>ControlPersist 特性需要高版本的SSH才支持，CentOS 6默认是不支持的，如果需要使用，需要自行升级openssh（确保SSH -V版本高于5.6）。<br>ControlPersist即持久化socket，一次验证，多次通信。并且只需要修改 <code>ssh</code> 客户端就行，也就是 Ansible 机器即可。</p>
<h3 id="三、设置facts缓存"><a href="#三、设置facts缓存" class="headerlink" title="三、设置facts缓存"></a>三、设置facts缓存</h3><p>如果细心的话, 就会发现执行playbook的时候, 默认第一个task都是GATHERING FACTS, 这个过程就是Ansible在收集每台主机的facts信息。<br>方便我们在playbook中直接饮用facts里的信息，当然如果你的playbook中不需要facts信息, 可以在playbook中设置<code>&quot;gather_facts: False&quot;</code>来提高playbook效率.</p>
<p>但是如果我们既想在每次执行playbook的时候都能收集facts, 又想加速这个收集过程, 那么就需要配置facts缓存了。</p>
<h4 id="3-1-使用json文件缓存"><a href="#3-1-使用json文件缓存" class="headerlink" title="3.1 使用json文件缓存"></a>3.1 使用json文件缓存</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim /etc/ansible/ansible.cfg</span></span><br><span class="line">.........</span><br><span class="line">gathering = smart</span><br><span class="line">fact_caching_timeout = 86400</span><br><span class="line">fact_caching = jsonfile</span><br><span class="line">fact_caching_connection = /dev/shm/ansible_fact_cache</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 正常配置palybook，不需要关闭gathering facts功能</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml </span></span><br><span class="line">---</span><br><span class="line">- hosts: 10.4.7.101</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    - list: [1,2,3]</span><br><span class="line">  tasks:</span><br><span class="line">    - name: this is loop</span><br><span class="line">      debug: msg="&#123;&#123; item &#125;&#125;"</span><br><span class="line">      with_items: '&#123;&#123;list&#125;&#125;'</span><br><span class="line"></span><br><span class="line">查看这个playbook过程，用时6.699s（第一次可能稍微慢点，缓存之后，后面执行就很快了）</span><br><span class="line"><span class="meta">$</span><span class="bash"> time ansible-playbook test.yml </span></span><br><span class="line"></span><br><span class="line">PLAY [10.4.7.101] *******************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">TASK [this is loop] *****************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; (item=1) =&gt; &#123;</span><br><span class="line">    "msg": 1</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.4.7.101] =&gt; (item=2) =&gt; &#123;</span><br><span class="line">    "msg": 2</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.4.7.101] =&gt; (item=3) =&gt; &#123;</span><br><span class="line">    "msg": 3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">real	0m6.699s</span><br><span class="line">user	0m1.301s</span><br><span class="line">sys     0m0.250s</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果去掉上面的facts缓存的四行配置，再次执行上面的playbok，发现用时10s左右！！！</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看缓存文件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls /dev/shm/ansible_fact_cache/</span></span><br><span class="line">10.4.7.101</span><br></pre></td></tr></table></figure>

<h4 id="3-2-使用redis存储facts文件需安装redis，还需要安装python库"><a href="#3-2-使用redis存储facts文件需安装redis，还需要安装python库" class="headerlink" title="3.2 使用redis存储facts文件需安装redis，还需要安装python库"></a>3.2 使用redis存储facts文件需安装redis，还需要安装python库</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> yum install redis</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yum -y install epel-release</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yum install python-pip</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pip install redis</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim /etc/ansible/ansible.cfg</span></span><br><span class="line">........</span><br><span class="line">gathering = smart</span><br><span class="line">facts_caching_timeout = 86400      #设置缓存过期时间86400秒</span><br><span class="line">facts_caching = redis              # 使用redis或者 (或者使用memcached，即"facts_caching = memcached")</span><br><span class="line">fact_caching_connection = 127.0.0.1:6379</span><br><span class="line"><span class="meta">#</span><span class="bash">若redis设置了密码,比如密码为<span class="string">"admin"</span>，则配置修改如下：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> fact_caching_connection = localhost:6379:0:admin</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl start redis</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> lsof -i:6379</span></span><br><span class="line">COMMAND     PID  USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">redis-ser 26593 redis    4u  IPv4 125427      0t0  TCP localhost:6379 (LISTEN)</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> time ansible-playbook test.yml </span></span><br><span class="line"></span><br><span class="line">PLAY [10.4.7.101] *******************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101]</span><br><span class="line"></span><br><span class="line">TASK [this is loop] *****************************************************************************************************************************</span><br><span class="line">ok: [10.4.7.101] =&gt; (item=1) =&gt; &#123;</span><br><span class="line">    "msg": 1</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.4.7.101] =&gt; (item=2) =&gt; &#123;</span><br><span class="line">    "msg": 2</span><br><span class="line">&#125;</span><br><span class="line">ok: [10.4.7.101] =&gt; (item=3) =&gt; &#123;</span><br><span class="line">    "msg": 3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************************</span><br><span class="line">10.4.7.101                 : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">real	0m6.720s</span><br><span class="line">user	0m1.219s</span><br><span class="line">sys	    0m0.338s</span><br><span class="line"></span><br><span class="line">需要注意：</span><br><span class="line">在使用redis缓存后，如果出现异常（若未出现，请忽略）：TypeError: the JSON object must be str, not 'bytes'。</span><br><span class="line">解决办法：</span><br><span class="line"><span class="meta">$</span><span class="bash"> find / -name ansible</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim /usr/lib/python2.7/site-packages/ansible/plugins/cache/redis.py</span></span><br><span class="line">..........</span><br><span class="line">self._cache[key] = json.loads(value.decode('utf-8'))     # 修改为这个</span><br><span class="line">    </span><br><span class="line">查看redis存储情况</span><br><span class="line"><span class="meta">$</span><span class="bash"> redis-cli</span></span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) "ansible_facts10.4.7.101"</span><br><span class="line">2) "ansible_cache_keys"</span><br></pre></td></tr></table></figure>

<p>总之：不同网络环境下的耗时肯定是不同的，但是设置缓存是肯定可以加快 Ansible 运行速度的，特别是 playbook 的运行。</p>
<h3 id="四、Ansible取消交互"><a href="#四、Ansible取消交互" class="headerlink" title="四、Ansible取消交互"></a>四、Ansible取消交互</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim /etc/ansible/ansible.cfg</span></span><br><span class="line">........</span><br><span class="line">host_key_checking = False          # 打开注释即可</span><br><span class="line">    </span><br><span class="line"><span class="meta">#</span><span class="bash"> 取消ssh的yes和no的交互：</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim /root/.ssh/config</span></span><br><span class="line">UserKnownHostsFile /dev/null</span><br><span class="line">ConnectTimeout 15</span><br><span class="line">StrictHostKeyChecking no</span><br><span class="line">    </span><br><span class="line">或者直接ssh时增加一个参数</span><br><span class="line"><span class="meta">$</span><span class="bash"> ssh -o StrictHostKeyChecking=no -p22 root@10.4.7.101</span></span><br></pre></td></tr></table></figure>

<h3 id="五、Ansible的-t选项，提高ansible执行效率"><a href="#五、Ansible的-t选项，提高ansible执行效率" class="headerlink" title="五、Ansible的-t选项，提高ansible执行效率"></a>五、Ansible的-t选项，提高ansible执行效率</h3><p>ansible的<code>&quot;-t&quot;</code>或<code>&quot;--tree&quot;</code>选项是将ansible的执行结果按主机名保存在指定目录下的文件中。</p>
<p>有些时候，ansible执行起来的速度会非常慢，这种慢体现在即使执行的是一个立即返回的简单命令(如<code>ping</code>模块)，也会耗时很久，且不是因为<code>ssh</code>连接慢导致的。<br>如果使用-t选项，将第一次执行得到的结果按inventory中定义的主机名保存在文件中，下次执行到同一台主机时速度将会变快很多，即使之后不再加上-t选项，<br>也可以在一定时间内保持迅速执行。即使执行速度正常（如执行一个Ping命令0.7秒左右），使用-t选项也可以在此基础上变得更快。</p>
<p>除了使用-t选项，使用重定向将结果重定向到某个文件中也是一样的效果。<br>这也算是一种ansible提速方式，但在centos6上使用低版本ansible时，有时会出现执行很慢的现象，但不是每次都这样，且centos7执行速度正常<br>所以这也是一种<code>&quot;bug&quot;</code>式问题，故这种方式没有通用性。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> time ansible test_server -m <span class="built_in">command</span> -a <span class="string">"hostname"</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> time ansible test_server -m <span class="built_in">command</span> -a <span class="string">"hostname"</span> -t /tmp/<span class="built_in">test</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">$</span><span class="bash"> ll /tmp/<span class="built_in">test</span>/</span></span><br><span class="line">总用量 8</span><br><span class="line">-rw-r--r--. 1 root root 236 2月   7 17:59 10.4.7.101</span><br><span class="line">-rw-r--r--. 1 root root 307 2月   7 17:59 10.4.7.102</span><br></pre></td></tr></table></figure>

<p>上面做了对比，发现使用-t或重定向方式，将ansible的执行结果按主机名保存在指定目录下的文件中，ansible执行效率会有所提升。</p>
<p><strong><strong><strong>***</strong></strong></strong> 当你发现自己的才华撑不起野心时，就请安静下来学习吧！<strong><strong><strong>***</strong></strong></strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/05/14/ansible/anisble%E6%89%B9%E9%87%8F%E5%AE%89%E8%A3%85node_exporter/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhangpengjie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/zpj.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zpj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/14/ansible/anisble%E6%89%B9%E9%87%8F%E5%AE%89%E8%A3%85node_exporter/" itemprop="url">anisble批量安装node_exporter</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-14T12:40:47+08:00">
                2021-05-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ansible/" itemprop="url" rel="index">
                    <span itemprop="name">ansible</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/05/14/ansible/anisble%E6%89%B9%E9%87%8F%E5%AE%89%E8%A3%85node_exporter/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2021/05/14/ansible/anisble%E6%89%B9%E9%87%8F%E5%AE%89%E8%A3%85node_exporter/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原文链接：<a href="https://www.cnblogs.com/lvzhenjiang/p/14374243.html" target="_blank" rel="noopener">https://www.cnblogs.com/lvzhenjiang/p/14374243.html</a></p>
<h1 id="anisble批量安装node-exporter"><a href="#anisble批量安装node-exporter" class="headerlink" title="anisble批量安装node_exporter"></a><a href="https://www.cnblogs.com/lvzhenjiang/p/14374243.html" target="_blank" rel="noopener">anisble批量安装node_exporter</a></h1><p>目录</p>
<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14374243.html#一、目录结构" target="_blank" rel="noopener">一、目录结构</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14374243.html#二、playbook文件" target="_blank" rel="noopener">二、playbook文件</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14374243.html#三、服务文件" target="_blank" rel="noopener">三、服务文件</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14374243.html#四、任务文件" target="_blank" rel="noopener">四、任务文件</a></li>
</ul>
<h3 id="一、目录结构"><a href="#一、目录结构" class="headerlink" title="一、目录结构"></a>一、目录结构</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> tree .</span></span><br><span class="line">.</span><br><span class="line">|-- hosts</span><br><span class="line">|-- node_exporter</span><br><span class="line">|   |-- files</span><br><span class="line">|   |   |-- node_exporter-1.0.1.linux-amd64.tar.gz</span><br><span class="line">|   |   `-- node_exporter.service</span><br><span class="line">|   `-- tasks</span><br><span class="line">|       `-- main.yml</span><br><span class="line">`-- node_exporter.yml</span><br></pre></td></tr></table></figure>

<h3 id="二、playbook文件"><a href="#二、playbook文件" class="headerlink" title="二、playbook文件"></a>二、playbook文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat node_exporter.yml </span></span><br><span class="line"><span class="meta">#</span><span class="bash">!/usr/bin/env ansible-playbook</span></span><br><span class="line">- hosts: all</span><br><span class="line">  remote_user: root</span><br><span class="line">  gather_facts: false</span><br><span class="line">  roles:</span><br><span class="line">  - role: node_exporter</span><br></pre></td></tr></table></figure>

<h3 id="三、服务文件"><a href="#三、服务文件" class="headerlink" title="三、服务文件"></a>三、服务文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat node_exporter/files/node_exporter.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Prometheus node_exporter</span><br><span class="line">Requires=network.target remote-fs.target</span><br><span class="line">After=network.target remote-fs.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=root</span><br><span class="line">Group=root</span><br><span class="line">ExecStart=/usr/local/node_exporter/node_exporter --web.listen-address=0.0.0.0:9100</span><br><span class="line">ExecReload=/bin/kill -HUP $MAINPID</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<h3 id="四、任务文件"><a href="#四、任务文件" class="headerlink" title="四、任务文件"></a>四、任务文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat node_exporter/tasks/main.yml </span></span><br><span class="line">- name: 安装node_exporter</span><br><span class="line">  unarchive: </span><br><span class="line">    src: node_exporter-1.0.1.linux-amd64.tar.gz</span><br><span class="line">    dest: /usr/local/</span><br><span class="line"></span><br><span class="line">- name: 创建软链接</span><br><span class="line">  file:</span><br><span class="line">    src: /usr/local/node_exporter-1.0.1.linux-amd64</span><br><span class="line">    dest: /usr/local/node_exporter</span><br><span class="line">    state: link</span><br><span class="line"></span><br><span class="line">- name: 添加node_exporter服务</span><br><span class="line">  copy: </span><br><span class="line">    src: node_exporter.service</span><br><span class="line">    dest: /usr/lib/systemd/system/</span><br><span class="line"></span><br><span class="line">- name: daemon-reload</span><br><span class="line">  systemd: </span><br><span class="line">    daemon_reload: yes</span><br><span class="line"></span><br><span class="line">- name: 设置开机自动启动</span><br><span class="line">  systemd: </span><br><span class="line">    name: node_exporter</span><br><span class="line">    state: started</span><br><span class="line">    enabled: True</span><br><span class="line"></span><br><span class="line">- name: 确定端口在监听</span><br><span class="line">  wait_for:</span><br><span class="line">    host: 0.0.0.0</span><br><span class="line">    port: 9100</span><br><span class="line">    delay: 2</span><br></pre></td></tr></table></figure>

<p><strong><strong><strong>***</strong></strong></strong> 当你发现自己的才华撑不起野心时，就请安静下来学习吧！<strong><strong><strong>***</strong></strong></strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/05/14/ansible/ansible%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhangpengjie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/zpj.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zpj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/14/ansible/ansible%E5%85%A5%E9%97%A8/" itemprop="url">ansible入门</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-14T12:39:05+08:00">
                2021-05-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ansible/" itemprop="url" rel="index">
                    <span itemprop="name">ansible</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/05/14/ansible/ansible%E5%85%A5%E9%97%A8/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2021/05/14/ansible/ansible%E5%85%A5%E9%97%A8/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原文链接：<a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html" target="_blank" rel="noopener">https://www.cnblogs.com/lvzhenjiang/p/14199445.html</a></p>
<h1 id="ansible入门"><a href="#ansible入门" class="headerlink" title="ansible入门"></a><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html" target="_blank" rel="noopener">ansible入门</a></h1><p>目录</p>
<ul>
<li>一、Ansible基础概述<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#11--什么是ansible" target="_blank" rel="noopener">1.1 什么是Ansible</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#12-ansible-可以完成哪些功能" target="_blank" rel="noopener">1.2 Ansible 可以完成哪些功能</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#13-ansible特点" target="_blank" rel="noopener">1.3 Ansible特点</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#14-ansible的架构中的控制节点、被控制节点、inventory、ad-hoc、playbook、连接协议这些是什么？" target="_blank" rel="noopener">1.4 Ansible的架构中的控制节点、被控制节点、inventory、ad-hoc、playbook、连接协议这些是什么？</a></li>
</ul>
</li>
<li>二、Ansible安装配置<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#21-ansible安装" target="_blank" rel="noopener">2.1 ansible安装</a></li>
</ul>
</li>
<li>三、Ansible inventory<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#31-场景一：基于密码连接" target="_blank" rel="noopener">3.1 场景一：基于密码连接</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#32-场景二：基于秘钥连接" target="_blank" rel="noopener">3.2 场景二：基于秘钥连接</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#33-场景三：主机组使用方式" target="_blank" rel="noopener">3.3 场景三：主机组使用方式</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#34-列出每个主机组下面的主机情况" target="_blank" rel="noopener">3.4 列出每个主机组下面的主机情况</a></li>
</ul>
</li>
<li>四、Ansible ad-hoc<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#41-什么是ad-hoc" target="_blank" rel="noopener">4.1 什么是ad-hoc</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#42-ad-hocm模式的使用场景" target="_blank" rel="noopener">4.2 ad-hocm模式的使用场景</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#43-ad-hoc模式的命令使用" target="_blank" rel="noopener">4.3 ad-hoc模式的命令使用</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#44-使用ad-doc指定一次远程命令，注意观察返回结果的颜色" target="_blank" rel="noopener">4.4 使用ad-doc指定一次远程命令，注意观察返回结果的颜色</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#45-ad-hoc常用的模块" target="_blank" rel="noopener">4.5 ad-hoc常用的模块</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#46-使用过程中需要先了解anisble-doc帮助手册" target="_blank" rel="noopener">4.6 使用过程中需要先了解anisble-doc帮助手册</a></li>
</ul>
</li>
<li>五、ansibel 模块<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#51-yum模块" target="_blank" rel="noopener">5.1 yum模块</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#52-copy模块" target="_blank" rel="noopener">5.2 copy模块</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#53-file模块" target="_blank" rel="noopener">5.3 file模块</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#54-get_url模块" target="_blank" rel="noopener">5.4 get_url模块</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#55-service模块" target="_blank" rel="noopener">5.5 service模块</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#56-group模块" target="_blank" rel="noopener">5.6 group模块</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#57-user模块" target="_blank" rel="noopener">5.7 user模块</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#58-cron模块" target="_blank" rel="noopener">5.8 cron模块</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#59-mount" target="_blank" rel="noopener">5.9 mount</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#510-firewalld" target="_blank" rel="noopener">5.10 firewalld</a></li>
</ul>
</li>
<li>六、Ansible playbook<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#61-什么是playbook" target="_blank" rel="noopener">6.1 什么是playbook</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#62-ansible-playbook与ad-hoc的关系" target="_blank" rel="noopener">6.2 Ansible playbook与ad-hoc的关系</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#63-ansible-playbook书写格式" target="_blank" rel="noopener">6.3 Ansible playbook书写格式</a></li>
</ul>
</li>
<li>七、变量<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#71-变量概述" target="_blank" rel="noopener">7.1 变量概述</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#72-变量定义" target="_blank" rel="noopener">7.2 变量定义</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#73-变量注册" target="_blank" rel="noopener">7.3 变量注册</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#74-facts变量" target="_blank" rel="noopener">7.4 facts变量</a></li>
</ul>
</li>
<li>八、Ansible Task 任务控制<ul>
<li>8.1 piaybook条件语句<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#案例一：根据不同操作系统，安装相同的软件包" target="_blank" rel="noopener">案例一：根据不同操作系统，安装相同的软件包</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#案例二：为所有web主机名的添加nginx仓库，其余的都跳过添加" target="_blank" rel="noopener">案例二：为所有web主机名的添加nginx仓库，其余的都跳过添加</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#案例三：根据命令执行的结果进行判断" target="_blank" rel="noopener">案例三：根据命令执行的结果进行判断</a></li>
</ul>
</li>
<li>8.2 playbook循环语句<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#案例一：-使用循环启动多个服务" target="_blank" rel="noopener">案例一： 使用循环启动多个服务</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#案例二：-使用字典批量创建用户" target="_blank" rel="noopener">案例二： 使用字典批量创建用户</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#案例三：-使用变量字典循环的方式拷贝文件" target="_blank" rel="noopener">案例三： 使用变量字典循环的方式拷贝文件</a></li>
</ul>
</li>
<li>8.3 playbook handlers<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#案例：playbook安装nginx" target="_blank" rel="noopener">案例：playbook安装nginx</a></li>
</ul>
</li>
<li>8.4 playbook tag<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#案例：" target="_blank" rel="noopener">案例：</a></li>
</ul>
</li>
<li>8.5 playbook include<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#案例：" target="_blank" rel="noopener">案例：</a></li>
</ul>
</li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#86-ignore_errors忽略错误" target="_blank" rel="noopener">8.6 ignore_errors忽略错误</a></li>
<li>8.7 playbook错误处理<ul>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#案例一：task执行失败强制调用handlers" target="_blank" rel="noopener">案例一：task执行失败强制调用handlers</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#案例二：-关闭change的状态（确定不会对被控端主机进行任何的修改和变更）" target="_blank" rel="noopener">案例二： 关闭change的状态（确定不会对被控端主机进行任何的修改和变更）</a></li>
<li><a href="https://www.cnblogs.com/lvzhenjiang/p/14199445.html#案例三：-使用changed_when检查tasksrre任务返回结果" target="_blank" rel="noopener">案例三： 使用changed_when检查tasksrre任务返回结果</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="一、Ansible基础概述"><a href="#一、Ansible基础概述" class="headerlink" title="一、Ansible基础概述"></a>一、Ansible基础概述</h3><h4 id="1-1-什么是Ansible"><a href="#1-1-什么是Ansible" class="headerlink" title="1.1 什么是Ansible"></a>1.1 什么是Ansible</h4><p>Ansible是一个IT自动化的配置管理工具，自动化主要体现在Ansible集成了丰富模块、丰富的功能组件，可以通过一个命令完成一系列的操作。进而减少我们重复性的工作和维护成本，以提高工作效率！</p>
<h4 id="1-2-Ansible-可以完成哪些功能"><a href="#1-2-Ansible-可以完成哪些功能" class="headerlink" title="1.2 Ansible 可以完成哪些功能"></a>1.2 Ansible 可以完成哪些功能</h4><ul>
<li>批量执行远程命令，可以对N多台主机同时进行命令的执行；</li>
<li>批量配置软件服务，可以进行自动化的方式配置和管理服务；</li>
<li>实现软件开发功能，Jumpserver底层使用ansible来实现的自动化管理；</li>
<li>编排高级的IT任务，Ansible的Playbook是一门编程语言，可以用来描绘一套IT架构；</li>
</ul>
<h4 id="1-3-Ansible特点"><a href="#1-3-Ansible特点" class="headerlink" title="1.3 Ansible特点"></a>1.3 Ansible特点</h4><ul>
<li>容易学习，无代理模式，不像saltstack既要学习客户端与服务端，还要学习客户端与服务端中间通信协议；</li>
<li>操作灵活，体现在Ansible有较多的模块，提供了丰富的功能、playbook则提供类似于编程语言的复杂功能；</li>
<li>简单复用，体现在Ansible一个命令可以完成很多事情；</li>
<li>安全可靠，因为Ansible使用了SSH协议进行通信，既稳定也安全；</li>
<li>移植性高，可以将写好的playbook拷贝任意机器进行执行；</li>
</ul>
<h4 id="1-4-Ansible的架构中的控制节点、被控制节点、inventory、ad-hoc、playbook、连接协议这些是什么？"><a href="#1-4-Ansible的架构中的控制节点、被控制节点、inventory、ad-hoc、playbook、连接协议这些是什么？" class="headerlink" title="1.4 Ansible的架构中的控制节点、被控制节点、inventory、ad-hoc、playbook、连接协议这些是什么？"></a>1.4 Ansible的架构中的控制节点、被控制节点、inventory、ad-hoc、playbook、连接协议这些是什么？</h4><p><img src="https://gitee.com/lvzhenjiang/document/raw/master/%E5%B0%8F%E4%B9%A6%E5%8C%A0/20200925223530.png" alt="20200925223530"></p>
<h3 id="二、Ansible安装配置"><a href="#二、Ansible安装配置" class="headerlink" title="二、Ansible安装配置"></a>二、Ansible安装配置</h3><h4 id="2-1-ansible安装"><a href="#2-1-ansible安装" class="headerlink" title="2.1 ansible安装"></a>2.1 ansible安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yum install ansible -y</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible --version</span></span><br><span class="line">ansible 2.9.10</span><br><span class="line">  config file = /etc/ansible/ansible.cfg</span><br><span class="line">  configured module search path = [u'/root/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules']</span><br><span class="line">  ansible python module location = /usr/lib/python2.7/site-packages/ansible</span><br><span class="line">  executable location = /usr/bin/ansible</span><br><span class="line">  python version = 2.7.5 (default, Nov 20 2015, 02:00:19) [GCC 4.8.5 20150623 (Red Hat 4.8.5-4)]</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible &lt;host-pattern&gt; [option]</span></span><br><span class="line">--version: # ansible版本信息</span><br><span class="line">-v：显示详细信息</span><br><span class="line">-i：主机清单文件路径，默认是/etc/ansibel/hosts</span><br><span class="line">-m：使用的模块的名称，默认使用command模块</span><br><span class="line">-a：使用的模块参数，模块的具体工作</span><br><span class="line">-k：提示输入ssh密码，而不使用基于ssh的秘钥认证</span><br><span class="line">-C：模拟执行测试，但不会真的执行</span><br><span class="line">-T：指定命令的超时时间</span><br></pre></td></tr></table></figure>

<p><strong>ansible配置文件优先级顺序：</strong></p>
<ul>
<li>最先查找$ANSIBLE_CONFIG变量；</li>
<li>其次查找当前目录下ansible.cfg</li>
<li>然后查找用户家目录下的.ansible.cfg</li>
<li>最后查找/etc/ansible/ansible.cfg（默认）</li>
</ul>
<h3 id="三、Ansible-inventory"><a href="#三、Ansible-inventory" class="headerlink" title="三、Ansible inventory"></a>三、Ansible inventory</h3><p><code>Inventory</code>文件中填写需要被管理主机与主机组信息（逻辑上定义）。默认<code>Inventory</code>文件在<code>/etc/ansible/hosts</code>。当然也可以自定义，然后使用<code>-i</code>指定<code>Inventory</code>文件位置：示例：</p>
<h4 id="3-1-场景一：基于密码连接"><a href="#3-1-场景一：基于密码连接" class="headerlink" title="3.1 场景一：基于密码连接"></a>3.1 场景一：基于密码连接</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat /etc/ansible/hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 方法一</span></span><br><span class="line">[webservers]</span><br><span class="line">192.168.100.225 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass='123456'</span><br><span class="line">192.168.100.226 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass='123456'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 方法二</span></span><br><span class="line">[webservers]</span><br><span class="line">web[1:2].lzj.com ansible_ssh_pass='123456'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 方法三</span></span><br><span class="line">[webservers]</span><br><span class="line">web[1:2].lzj.com</span><br><span class="line">[webservers：vars]</span><br><span class="line">ansible_ssh_pass='123456'</span><br></pre></td></tr></table></figure>

<h4 id="3-2-场景二：基于秘钥连接"><a href="#3-2-场景二：基于秘钥连接" class="headerlink" title="3.2 场景二：基于秘钥连接"></a>3.2 场景二：基于秘钥连接</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ssh-keygen</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ssh-copy-id 192.168.100.225</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ssh-copy-id 192.168.100.226</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir project1/ &amp;&amp; <span class="built_in">cd</span> project1/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim hosts</span></span><br><span class="line">[web]</span><br><span class="line">192.168.100.225</span><br><span class="line">192.168.100.226</span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m ping -i hosts</span></span><br></pre></td></tr></table></figure>

<h4 id="3-3-场景三：主机组使用方式"><a href="#3-3-场景三：主机组使用方式" class="headerlink" title="3.3 场景三：主机组使用方式"></a>3.3 场景三：主机组使用方式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[lbservers]</span><br><span class="line">192.168.100.221</span><br><span class="line">192.168.100.222</span><br><span class="line"></span><br><span class="line">[webservers]</span><br><span class="line">192.168.100.223</span><br><span class="line">192.168.100.224</span><br><span class="line"></span><br><span class="line">[servers:children]    # 定义servers组包含两个子组（lbservers、webservers）</span><br><span class="line">lbservers</span><br><span class="line">webservers</span><br></pre></td></tr></table></figure>

<h4 id="3-4-列出每个主机组下面的主机情况"><a href="#3-4-列出每个主机组下面的主机情况" class="headerlink" title="3.4 列出每个主机组下面的主机情况"></a>3.4 列出每个主机组下面的主机情况</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible all -i hosts --list-hosts</span></span><br><span class="line">  hosts (2):</span><br><span class="line">    192.168.100.225</span><br><span class="line">    192.168.100.226</span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -i hosts --list-hosts</span></span><br><span class="line">  hosts (2):</span><br><span class="line">    192.168.100.225</span><br><span class="line">    192.168.100.226</span><br></pre></td></tr></table></figure>

<h3 id="四、Ansible-ad-hoc"><a href="#四、Ansible-ad-hoc" class="headerlink" title="四、Ansible ad-hoc"></a>四、Ansible ad-hoc</h3><h4 id="4-1-什么是ad-hoc"><a href="#4-1-什么是ad-hoc" class="headerlink" title="4.1 什么是ad-hoc"></a>4.1 什么是ad-hoc</h4><p><code>ad-hoc</code>就是临时命令，执行完成后就结束，并不会保存！</p>
<h4 id="4-2-ad-hocm模式的使用场景"><a href="#4-2-ad-hocm模式的使用场景" class="headerlink" title="4.2 ad-hocm模式的使用场景"></a>4.2 ad-hocm模式的使用场景</h4><p>比如在多台机器上查看某个进程是否启动，或拷贝指定文件到本地，等等！</p>
<h4 id="4-3-ad-hoc模式的命令使用"><a href="#4-3-ad-hoc模式的命令使用" class="headerlink" title="4.3 ad-hoc模式的命令使用"></a>4.3 ad-hoc模式的命令使用</h4><p><img src="https://gitee.com/lvzhenjiang/document/raw/master/%E5%B0%8F%E4%B9%A6%E5%8C%A0/20200926003906.png" alt="20200926003906"></p>
<h4 id="4-4-使用ad-doc指定一次远程命令，注意观察返回结果的颜色"><a href="#4-4-使用ad-doc指定一次远程命令，注意观察返回结果的颜色" class="headerlink" title="4.4 使用ad-doc指定一次远程命令，注意观察返回结果的颜色"></a>4.4 使用ad-doc指定一次远程命令，注意观察返回结果的颜色</h4><ul>
<li>绿色：表示被管理主机没有被修改；</li>
<li>黄色：表示被管理端主机发现变更；</li>
<li>红色：表示出现了故障，注意查看提示；</li>
</ul>
<h4 id="4-5-ad-hoc常用的模块"><a href="#4-5-ad-hoc常用的模块" class="headerlink" title="4.5 ad-hoc常用的模块"></a>4.5 ad-hoc常用的模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">command			# 指定shell命令（不支持管道等特殊字符）</span><br><span class="line">shell			# 执行shell命令</span><br><span class="line">scripts			# 执行shell脚本</span><br><span class="line">yum_repository	# 配置yum仓库</span><br><span class="line">yum				# 安装软件</span><br><span class="line">copy			# 变更配置文件</span><br><span class="line">file			# 建立目录或文件</span><br><span class="line">service			# 启动、停止服务</span><br><span class="line">mount			# 挂载设备</span><br><span class="line">cron			# 定时任务</span><br><span class="line">firewalld		# 防火墙</span><br><span class="line">get_url			# 下载软件</span><br></pre></td></tr></table></figure>

<h4 id="4-6-使用过程中需要先了解anisble-doc帮助手册"><a href="#4-6-使用过程中需要先了解anisble-doc帮助手册" class="headerlink" title="4.6 使用过程中需要先了解anisble-doc帮助手册"></a>4.6 使用过程中需要先了解anisble-doc帮助手册</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible-doc -l		<span class="comment"># 查看所有模块说明</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-doc copy		<span class="comment"># 表示指定模块方法</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-doc -s copy	<span class="comment"># 表示指定模块参数</span></span></span><br></pre></td></tr></table></figure>

<h3 id="五、ansibel-模块"><a href="#五、ansibel-模块" class="headerlink" title="五、ansibel 模块"></a>五、ansibel 模块</h3><h4 id="5-1-yum模块"><a href="#5-1-yum模块" class="headerlink" title="5.1 yum模块"></a>5.1 yum模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 示例一： 安装当前最新的Apache软件，如果存在则更新</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m yum -a <span class="string">"name=httpd state=latest"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例二： 安装当前最新的Apache软件，通过epel安装</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m yum -a <span class="string">"name=httpd state=present enablerepo=epel"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例三： 通过公网URL安装rpm软件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m yum -a <span class="string">"name=https://mirrors4.tuna.tsinghua.edu.cn/zabbix/zabbix/4.0/rhel/7/x86_64/zabbix-agent-4.0.0-2.el7.x86_64.rpm state=present"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例四：更新所有的软件包，但排除和kernel相关的</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m yum -a <span class="string">"name="</span>*<span class="string">" state=present exclude="</span>kernel*<span class="string">" -i hosts</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例五： 删除Apache软件</span></span><br><span class="line"><span class="meta">$</span><span class="bash">  ansible web -m yum -a <span class="string">"name=httpd state=absent"</span> -i hosts</span></span><br></pre></td></tr></table></figure>

<h4 id="5-2-copy模块"><a href="#5-2-copy模块" class="headerlink" title="5.2 copy模块"></a>5.2 copy模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 示例一： 将本地的httpd.conf文件Listen 端口修改为9999，然后推送到远程主机</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sed -i <span class="string">'s/Listen 80/Listen 9999/g'</span> httpd.conf</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m copy -a <span class="string">"src=httpd.conf dest=/etc/httpd/conf/httpd.conf owner=root group=root mode-644"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例二： 将本地的httpd.conf文件Listen端口修改为9988，然后推送到远端，检查远端是否存在上次备份的文件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sed -i <span class="string">'s/Listen 9999/Listen 9988/g'</span> httpd.conf</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m copy -a <span class="string">"src=httpd.conf dest=/etc/httpd/conf/httpd.conf owner=root group=root mode=644 backup=yes"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例三： 往远程的主机文件写入内容</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m copy -a <span class="string">"content=123456........ dest=/var/www/html/index.html"</span> -i hosts</span></span><br></pre></td></tr></table></figure>

<h4 id="5-3-file模块"><a href="#5-3-file模块" class="headerlink" title="5.3 file模块"></a>5.3 file模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 示例一： 创建文件，并设置属主、属组、权限</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m file -a <span class="string">"path=/var/www/html/t1.html state=touch owner=apache group=apache mode=644"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例二： 创建目录，并设置属主、属组、权限</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m file -a <span class="string">"path=/var/www/html/dd state=directory owner=apache group=apache mode=755"</span> -i hosts</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例三：递归授权目录的方式</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m file -a <span class="string">"path=/var/www/html state=directory owner=apache group=apache recurse=yes"</span> -i hosts</span></span><br></pre></td></tr></table></figure>

<h4 id="5-4-get-url模块"><a href="#5-4-get-url模块" class="headerlink" title="5.4 get_url模块"></a>5.4 get_url模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 示例一： 下载互联网的软件到本地</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m get_url -a <span class="string">"url=http://192.168.99.181:12138/document/Ansible.docx dest=/root/"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例二： 下载互联网文件并进行mds校验</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> md5sum Ansible.docx      <span class="comment"># 获取文件md5值</span></span></span><br><span class="line">7b1a6fe7af7252005987e16ce64e1e1a  Ansible.docx</span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m get_url -a <span class="string">"url=http://192.168.99.181:12138/document/Ansible.docx dest=/root/ checksum=md5:7b1a6fe7af7252005987e16ce64e1e1a"</span> -i hosts</span></span><br></pre></td></tr></table></figure>

<h4 id="5-5-service模块"><a href="#5-5-service模块" class="headerlink" title="5.5 service模块"></a>5.5 service模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 示例一： 启动httpd服务</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m service -a <span class="string">"name=httpd state=started"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例二： 重载httpd服务</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m service -a <span class="string">"name=httpd state=reloaded"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例三： 重启httpd服务</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m service -a <span class="string">"name=httpd state=restarted"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例四： 停止httpd服务</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m service -a <span class="string">"name=httpd state=stopped"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例五： 启动httpd服务，并加入开机自启</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m service -a <span class="string">"name=httpd state=started enabled=yes"</span> -i hosts</span></span><br></pre></td></tr></table></figure>

<h4 id="5-6-group模块"><a href="#5-6-group模块" class="headerlink" title="5.6 group模块"></a>5.6 group模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 示例一： 创建news基本组，指定gid为9999</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m group -a <span class="string">"name=news gid=9999 state=present"</span></span></span><br><span class="line"> -i hosts</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例二： 创建http系统组，指定gid为8888</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m group -a <span class="string">"name=http gid=8888  state=present</span></span></span><br><span class="line"> system=yes" -i hosts</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例三： 删除<span class="built_in">test</span>基本组</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m group -a <span class="string">"name=test state=absent"</span> -i hosts</span></span><br></pre></td></tr></table></figure>

<h4 id="5-7-user模块"><a href="#5-7-user模块" class="headerlink" title="5.7 user模块"></a>5.7 user模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 示例一： 创建job用户，uid是1040，主要组是adm</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m user -a <span class="string">"name=job uid=1040 group=adm"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例二： 创建joh用户，登录shell是/sbin/nologin，追加bin、sys两个组</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m user -a <span class="string">"name=joh groups=bin,sys shell=/sbin/nologin"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例三： 创建jsm用户，为其添加123作为登录密码，并创建家目录</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible localhost -m debug -a <span class="string">"msg=&#123;&#123; '123' | password_hash('sha512','salt') &#125;&#125;"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取123加密后的字符串</span></span><br><span class="line"><span class="meta">$</span><span class="bash">6<span class="variable">$salt</span><span class="variable">$jkHSO0tOjmLW0S1NFlw5veSIDRAVsiQQMTrkOKy4xdCCLPNIsHhZkIRlzfzIvKyXeGdOfCBoW1wJZPLyQ9Qx</span>/1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m user -a <span class="string">'name=jsm password=$6$salt$jkHSO0tOjmLW0S1NFlw5veSIDRAVsiQQMTrkOKy4xdCCLPNIsHhZkIRlzfzIvKyXeGdOfCBoW1wJZPLyQ9Qx/1 create_home=yes'</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例四： 移除job用户</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m user -a <span class="string">"name=job state=absent remove=yes"</span> -i hosts</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> remove=yes删除普通用户家目录</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例五： 创建http用户，并为该用户创建2048字节的私钥，存放在~/http/.ssh/id_rsa</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m user -a <span class="string">"name=http generate_ssh_key=yes ssh_key_bits=2048 ssh_key_file=.ssh/id_rsa"</span> -i hosts</span></span><br></pre></td></tr></table></figure>

<h4 id="5-8-cron模块"><a href="#5-8-cron模块" class="headerlink" title="5.8 cron模块"></a>5.8 cron模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 示例一： 添加定时任务，每分钟执行一次ls</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m cron -a <span class="string">"name=job1 job='ls &gt; /dev/null'"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例二： 添加定时任务，每天的凌晨2点和凌晨5点执行一次ls</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m cron -a <span class="string">"name=job2 job='ls &gt; /dev/null' minute=0 hour=2,5"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例三： 关闭定时任务，使定时任务失败</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m cron -a <span class="string">"name=job2 job='ls &gt; /dev/null' minute=0 hour=2,5 disabled=yes"</span> -i hosts</span></span><br></pre></td></tr></table></figure>

<h4 id="5-9-mount"><a href="#5-9-mount" class="headerlink" title="5.9 mount"></a>5.9 mount</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 环境准备：</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible localhost -m yum -a <span class="string">"name=nfs-utils state=present"</span> </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible localhost -m file -a <span class="string">"path=/ops state=directory"</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible localhost -m copy -a <span class="string">'content="/ops 192.168.100.1/24(rw,sync)" dest=/etc/exports'</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible localhost -m service -a <span class="string">"name=nfs state=restarted"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例一： 挂载nfs存储到本地的/opt目录，并实现开机自动挂载</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m mount -a <span class="string">"src=192.168.99.181:/ops path=/opt fstype=nfs opts=defaults state=mounted"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例二： 临时卸载nfs的挂载，但不会清理/etc/fstab</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m mount -a <span class="string">"src=192.168.99.181:/ops path=/opt fstype=nfs opts=defaults state=unmounted"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例三： 永久卸载ns的挂载，清理/etc/fstab</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m mount -a <span class="string">"src=192.168.99.181:/ops path=/opt fstype=nfs opts=defaults state=absent"</span> -i hosts</span></span><br></pre></td></tr></table></figure>

<h4 id="5-10-firewalld"><a href="#5-10-firewalld" class="headerlink" title="5.10 firewalld"></a>5.10 firewalld</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 示例一： 永久放行https的流量，只有重启才生效</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m firewalld -a <span class="string">"zone=public service=https permanent=yes state=enabled"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例二： 永久放行8081端口的流量，只有重启才生效</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m firewalld -a <span class="string">"zone=public port=8081/tcp permanent=yes state=enabled"</span> -i hosts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 示例三： 放行8080-8090的所有的tcp端口流量，临时和永久都生效</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m firewalld -a <span class="string">"zone=public port=8080-8090/tcp immediate=yes permanent=yes state=enabled"</span> -i hosts</span></span><br></pre></td></tr></table></figure>

<h3 id="六、Ansible-playbook"><a href="#六、Ansible-playbook" class="headerlink" title="六、Ansible playbook"></a>六、Ansible playbook</h3><h4 id="6-1-什么是playbook"><a href="#6-1-什么是playbook" class="headerlink" title="6.1 什么是playbook"></a>6.1 什么是playbook</h4><ul>
<li>playbook：定义了一个文本文件，以.yml为后缀结尾；</li>
<li>play：定义的是主机的角色；</li>
<li>task：定义的是具体执行的任务；</li>
</ul>
<p>总结：playbook是由一个多个多个play组成，一个play可以包含多个task任务。可以理解为：使用不同的模块来共同完成一件事情！</p>
<p><img src="https://gitee.com/lvzhenjiang/document/raw/master/%E5%B0%8F%E4%B9%A6%E5%8C%A0/20200926140848.png" alt="20200926140848"></p>
<h4 id="6-2-Ansible-playbook与ad-hoc的关系"><a href="#6-2-Ansible-playbook与ad-hoc的关系" class="headerlink" title="6.2 Ansible playbook与ad-hoc的关系"></a>6.2 Ansible playbook与ad-hoc的关系</h4><ul>
<li>playbook是对ad-hoc的一种编排方式；</li>
<li>playbook可以持久运行，而ad-hoc只能临时运行；</li>
<li>playbook适合复杂的任务，而ad-hoc适合做快速简单的任务；</li>
<li>playbook能控制任务执行的先后顺序；</li>
</ul>
<h4 id="6-3-Ansible-playbook书写格式"><a href="#6-3-Ansible-playbook书写格式" class="headerlink" title="6.3 Ansible playbook书写格式"></a>6.3 Ansible playbook书写格式</h4><p>playbook是由yaml语法书写，结构清晰、可读性强。所以必须掌握yaml基础语法！</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>概述</th>
</tr>
</thead>
<tbody><tr>
<td>缩进</td>
<td>YAML使用固定的缩进风格表示层级结构，每个缩进由两个空格组成，不能使用ta键</td>
</tr>
<tr>
<td>冒号</td>
<td>以冒号结尾的除外，其他所有冒号后面所有必须有空格</td>
</tr>
<tr>
<td>短横线</td>
<td>表示列表项，使用一个短横杠加一个空格。多个项使用同样的缩进级别作为统一列表</td>
</tr>
</tbody></table>
<h3 id="七、变量"><a href="#七、变量" class="headerlink" title="七、变量"></a>七、变量</h3><h4 id="7-1-变量概述"><a href="#7-1-变量概述" class="headerlink" title="7.1 变量概述"></a>7.1 变量概述</h4><p>变量提供了便捷的方式来管理ansible项目中的动态值，比如：nginx-1.12，可能后期会反复的使用这个版本的值，那么如果将此值设置为变量，后续使用和修改都将变得非常方便。这样可以简化项目的创建和维护。</p>
<p>那么在ansible中定义变量分为以下三种方式：</p>
<ul>
<li>通过命令行进行变量定义；</li>
<li>在play文件中进行定义变量；</li>
<li>通过Inventory在主机组或单个主机中设置变量；</li>
</ul>
<p>如果定义的变量出现重复，且造成冲突，怎么办？谁说了算？</p>
<h4 id="7-2-变量定义"><a href="#7-2-变量定义" class="headerlink" title="7.2 变量定义"></a>7.2 变量定义</h4><p>1、在playbook的文件开头通过vars关键字进行变量定义</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">web_packages:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ftp_packages:</span> <span class="string">vsftpd</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Rpm</span> <span class="string">Packages</span> <span class="string">"<span class="template-variable">&#123;&#123; web_packages &#125;&#125;</span>"</span> <span class="string">"<span class="template-variable">&#123;&#123; ftp_packages &#125;&#125;</span>"</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">"<span class="template-variable">&#123;&#123; web_packages &#125;&#125;</span>"</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">"<span class="template-variable">&#123;&#123; ftp_packages &#125;&#125;</span>"</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br></pre></td></tr></table></figure>

<p>2、可以在playbook中使用<code>vars_files</code>指定文件作为变量文件，好处就是其他的playbook也可以调用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1）准备一个变量的文件，建议使用yml格式</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat vars.yml</span></span><br><span class="line">web_packages: httpd</span><br><span class="line">ftp_packages: vsftpd</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2）准备playbook进行调用</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">- hosts: web</span><br><span class="line">  vars_files:</span><br><span class="line">    - vars.yml</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Rpm Packages "&#123;&#123; web_packages &#125;&#125;" "&#123;&#123; ftp_packages &#125;&#125;"</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - "&#123;&#123; web_packages &#125;&#125;"</span><br><span class="line">          - "&#123;&#123; ftp_packages &#125;&#125;"</span><br><span class="line">        state: present</span><br></pre></td></tr></table></figure>

<p>3、在Inventory主机清单中定义变量，但是注意：主机变量优先级高于主机组变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1）在Inventory主机清单中对主机组进行定义变量</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat hosts</span></span><br><span class="line">[web]</span><br><span class="line">192.168.100.225</span><br><span class="line">192.168.100.226</span><br><span class="line"></span><br><span class="line">[web:vars]</span><br><span class="line">filename=group_vars</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2）playbook中直接调用变量</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">- hosts: web</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Create File</span><br><span class="line">      file:</span><br><span class="line">        name: /tmp/&#123;&#123; filename&#125;&#125;</span><br><span class="line">        state: touch</span><br></pre></td></tr></table></figure>

<p>4、官方建议是在ansible项目目录中创建两个额外的变量目录，分别是<code>host_vars</code>和<code>group_vars</code></p>
<ul>
<li>测试<code>group_vars</code>定义变量方式</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat hosts</span></span><br><span class="line">[web]</span><br><span class="line">192.168.100.225</span><br><span class="line">192.168.100.226</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1）在当前的项目目录中创建两个变量的目录</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir &#123;group,host&#125;_vars</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2）在group_vars目录中创建一个文件，文件名与Inventory清单中的主机组名称要保持一致</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat group_vars/web</span></span><br><span class="line">web_packages: wget</span><br><span class="line">ftp_packages: tree</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3）编写playbook，只需在playbook中使用变量即可</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">- hosts: web</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Rpm Packages "&#123;&#123; web_packages &#125;&#125;" "&#123;&#123; ftp_packages &#125;&#125;"</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - "&#123;&#123; web_packages &#125;&#125;"</span><br><span class="line">          - "&#123;&#123; ftp_packages &#125;&#125;"</span><br><span class="line">        state: present</span><br></pre></td></tr></table></figure>

<p><strong>测试test组能否使用web组定义的变量，无法使用！但是系统提供了特殊的all组，也就是说<code>group_vars</code>目录下创建一个all文件，定义变量对所有的主机都生效！</strong></p>
<ul>
<li>测试<code>host_vars</code>定义变量方式</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1）在host_vars目录创建一个文件，文件名与Inventory清单中的主机名称要保持一致，如果是IP地址，则创建相同的IP</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat hosts</span></span><br><span class="line">[web]</span><br><span class="line">192.168.100.225</span><br><span class="line">192.168.100.226</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2）在host_vars目录中创建文件，给192.168.100.225主机定义变量</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat host_vars/192.168.100.225</span></span><br><span class="line">web_packages: zlib-static</span><br><span class="line">ftp_packages: zmap</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3）转别一个playbook文件调用host主机变量</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">- hosts: 192.168.100.225</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Rpm Packages "&#123;&#123; web_packages &#125;&#125;" "&#123;&#123; ftp_packages &#125;&#125;"</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - "&#123;&#123; web_packages &#125;&#125;"</span><br><span class="line">          - "&#123;&#123; ftp_packages &#125;&#125;"</span><br><span class="line">        state: present</span><br></pre></td></tr></table></figure>

<p>5、通过命令行<code>-extra-vars</code>或<code>-e</code>外置穿餐设定变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1）准备playbook文件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat test.yml</span></span><br><span class="line">- hosts: "&#123;&#123; host &#125;&#125;"</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Rpm Packages "&#123;&#123; web_packages &#125;&#125;" "&#123;&#123; ftp_packages &#125;&#125;"</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - "&#123;&#123; web_packages &#125;&#125;"</span><br><span class="line">          - "&#123;&#123; ftp_packages &#125;&#125;"</span><br><span class="line">        state: present</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2）执行playbook时进行变量的传递</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook -i hosts test.yml -e <span class="string">"host=web"</span></span></span><br></pre></td></tr></table></figure>

<p>6、变量的优先级顺序：</p>
<p>命令行变量——&gt;paly中的vars_files——&gt;paly中的vars——&gt;host_vars——&gt;group_vars/all</p>
<h4 id="7-3-变量注册"><a href="#7-3-变量注册" class="headerlink" title="7.3 变量注册"></a>7.3 变量注册</h4><p><code>register</code>关键字可以将某个task任务结果存储至变量中，最后使用debug输出变量内容，可以用于后续排查故障！</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">system</span> <span class="string">status</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">netstat</span> <span class="string">-lntp</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">System_Status</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">System</span> <span class="string">Status</span></span><br><span class="line">      <span class="attr">debug:</span> <span class="string">msg="&#123;&#123;</span> <span class="string">System_Status.stdout_lines</span> <span class="string">&#125;&#125;"</span></span><br></pre></td></tr></table></figure>

<h4 id="7-4-facts变量"><a href="#7-4-facts变量" class="headerlink" title="7.4 facts变量"></a>7.4 facts变量</h4><p>Ansible facts是在被管理主机上通过ansible自动采集发现的变量。facts包含每台特定的主机信息。比如：被控端主机的主机名、IP地址、系统版本、CPU数量、内存状态、磁盘状态等等。</p>
<p>默认情况的facts变量名都已经预先定义好了，只需要采集被控端的信息，然后传递至facts变量即可！</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible web -m setup -i hosts &gt; facts.txt</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取所有的facts变量</span></span><br></pre></td></tr></table></figure>

<p>facts变量使用场景：</p>
<ul>
<li><p>通过facts变量检查被控端主机硬件CPU信息，从而生成不同的Nginx配置文件；</p>
</li>
<li><p>通过facts变量检查被控端主机名称信息，从而生成不同的zabbix配置文件；</p>
</li>
<li><p>通过facts变量检查被控端主机内存状态信息，从而生成不同的memcached配置文件；</p>
<p>………………</p>
</li>
</ul>
<p>1、facts基本用法：比如获取被控端的主机名和IP地址，然后通过debug输出</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OutPut</span> <span class="string">variables</span> <span class="string">ansible</span> <span class="string">facts</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">this</span> <span class="string">default</span> <span class="string">IPv4</span> <span class="string">address</span> <span class="string">"<span class="template-variable">&#123;&#123; ansible_fqdn &#125;&#125;</span>"</span> <span class="string">is</span> <span class="string">"<span class="template-variable">&#123;&#123; ansible_default_ipv4.address &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure>

<p>2、facts开启后会影响Ansible主机的性能，如果没有采集被控端主机需求可选择关闭</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span>    <span class="comment"># 关闭信息采集</span></span><br></pre></td></tr></table></figure>

<h3 id="八、Ansible-Task-任务控制"><a href="#八、Ansible-Task-任务控制" class="headerlink" title="八、Ansible Task 任务控制"></a>八、Ansible Task 任务控制</h3><h4 id="8-1-piaybook条件语句"><a href="#8-1-piaybook条件语句" class="headerlink" title="8.1 piaybook条件语句"></a>8.1 piaybook条件语句</h4><p>判断在Ansible任务中的使用频率非常高，比如yum模块可以检测软件包是否已经被安装，而在这个过程中我们不用做太多的人工干预。但是也有部分任务需要进行判断。</p>
<h5 id="案例一：根据不同操作系统，安装相同的软件包"><a href="#案例一：根据不同操作系统，安装相同的软件包" class="headerlink" title="案例一：根据不同操作系统，安装相同的软件包"></a>案例一：根据不同操作系统，安装相同的软件包</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Centos</span> <span class="string">Install</span> <span class="string">Httpd</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">(</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">"CentOS"</span> <span class="string">)</span></span><br></pre></td></tr></table></figure>

<h5 id="案例二：为所有web主机名的添加nginx仓库，其余的都跳过添加"><a href="#案例二：为所有web主机名的添加nginx仓库，其余的都跳过添加" class="headerlink" title="案例二：为所有web主机名的添加nginx仓库，其余的都跳过添加"></a>案例二：为所有web主机名的添加nginx仓库，其余的都跳过添加</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">YUM</span> <span class="string">Repo</span></span><br><span class="line">      <span class="attr">yum_repository:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">ansible_nginx</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">ansible_test</span></span><br><span class="line">        <span class="attr">baseurl:</span> <span class="string">http://nginx.org/packages/centos/$releasever/$basearch/</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="attr">gpgcheck:</span> <span class="literal">no</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">(</span> <span class="string">ansible_fqdn</span> <span class="string">is</span> <span class="string">match("web*")</span> <span class="string">)</span></span><br><span class="line">      </span><br><span class="line"><span class="comment"># 当然when也可以使用and与or方式</span></span><br><span class="line"><span class="comment"># when： ( ansible_fqdn is match("web*") ) or</span></span><br><span class="line"><span class="comment">#		 ( ansible_fqdn is match("lb*") )</span></span><br></pre></td></tr></table></figure>

<h5 id="案例三：根据命令执行的结果进行判断"><a href="#案例三：根据命令执行的结果进行判断" class="headerlink" title="案例三：根据命令执行的结果进行判断"></a>案例三：根据命令执行的结果进行判断</h5><p>通过register将命令执行结果保存至变量，然后通过when语句进行判断</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">Httpd</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">systemctl</span> <span class="string">is-active</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">ignore_errors:</span> <span class="literal">yes</span>        <span class="comment"># 忽略错误</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">check_httpd</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Httpd</span> <span class="string">Restart</span>        <span class="comment"># 如果check_httpd执行命令结果等于0，则重启httpd,否则跳过</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">check_httpd.rc</span> <span class="string">==</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h4 id="8-2-playbook循环语句"><a href="#8-2-playbook循环语句" class="headerlink" title="8.2 playbook循环语句"></a>8.2 playbook循环语句</h4><p>有时候我们写playbook的时候会发现了很多task都要重复引用某个模块，比如一次启动10个服务，或者一个拷贝10个文件。如果安装传统的写法最少要写10次，这样会显得playbook很臃肿。如果使用循环的方式来编写playbokk，这样可以减少重复使用某个模块！</p>
<h5 id="案例一：-使用循环启动多个服务"><a href="#案例一：-使用循环启动多个服务" class="headerlink" title="案例一： 使用循环启动多个服务"></a>案例一： 使用循环启动多个服务</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Service</span> <span class="string">Start</span></span><br><span class="line">      <span class="attr">service:</span> </span><br><span class="line">        <span class="attr">name:</span> <span class="string">"<span class="template-variable">&#123;&#123; item &#125;&#125;</span>"</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">httpd</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">sshd</span></span><br></pre></td></tr></table></figure>

<h5 id="案例二：-使用字典批量创建用户"><a href="#案例二：-使用字典批量创建用户" class="headerlink" title="案例二： 使用字典批量创建用户"></a>案例二： 使用字典批量创建用户</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Add</span> <span class="string">Users</span></span><br><span class="line">      <span class="attr">user:</span> </span><br><span class="line">        <span class="attr">name:</span> <span class="string">"<span class="template-variable">&#123;&#123; item.name &#125;&#125;</span>"</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">"<span class="template-variable">&#123;&#123;item.group &#125;&#125;</span>"</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'test01'</span><span class="string">,group:</span> <span class="string">'bin'</span> <span class="string">&#125;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'test02'</span><span class="string">,group:</span> <span class="string">'root'</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="案例三：-使用变量字典循环的方式拷贝文件"><a href="#案例三：-使用变量字典循环的方式拷贝文件" class="headerlink" title="案例三： 使用变量字典循环的方式拷贝文件"></a>案例三： 使用变量字典循环的方式拷贝文件</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">"<span class="template-variable">&#123;&#123; item.src &#125;&#125;</span>"</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">"<span class="template-variable">&#123;&#123; item.dest &#125;&#125;</span>"</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">"<span class="template-variable">&#123;&#123; item.mode &#125;&#125;</span>"</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">src:</span> <span class="string">'rsync.conf'</span> <span class="string">,</span> <span class="attr">dest:</span> <span class="string">'/tmp/rsync.conf'</span> <span class="string">,</span> <span class="attr">mode:</span> <span class="number">644</span> <span class="string">&#125;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">src:</span> <span class="string">'rsync.pass'</span> <span class="string">,</span> <span class="attr">dest:</span> <span class="string">'/tmp/rsync.pass'</span> <span class="string">,</span> <span class="attr">mode:</span> <span class="number">600</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>高级写法(变量套变量)：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">Path:</span> <span class="string">/tmp</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">"<span class="template-variable">&#123;&#123; item.src &#125;&#125;</span>"</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">"<span class="template-variable">&#123;&#123; item.dest &#125;&#125;</span>"</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">"<span class="template-variable">&#123;&#123; item.mode &#125;&#125;</span>"</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">src:</span> <span class="string">'rsync.conf'</span> <span class="string">,</span> <span class="attr">dest:</span> <span class="string">'<span class="template-variable">&#123;&#123; Path &#125;&#125;</span>/rsync.conf'</span> <span class="string">,</span> <span class="attr">mode:</span> <span class="number">644</span> <span class="string">&#125;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">src:</span> <span class="string">'rsync.pass'</span> <span class="string">,</span> <span class="attr">dest:</span> <span class="string">'<span class="template-variable">&#123;&#123; Path &#125;&#125;</span>/rsync.pass'</span> <span class="string">,</span> <span class="attr">mode:</span> <span class="number">600</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="8-3-playbook-handlers"><a href="#8-3-playbook-handlers" class="headerlink" title="8.3 playbook handlers"></a>8.3 playbook handlers</h4><p>handlers是一个触发器，也是一个tasks，只不过是一个特殊的tasks，它是需要被tasks触发才会执行。只要配置文件发生变更，则会触发handlers执行重启服务操作，如果配置文件不发生任何变化，则不会重启！<br>notify监控——&gt;通知——&gt;handlers触发</p>
<h5 id="案例：playbook安装nginx"><a href="#案例：playbook安装nginx" class="headerlink" title="案例：playbook安装nginx"></a>案例：playbook安装nginx</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Instll</span> <span class="string">Nginx</span></span><br><span class="line">    <span class="attr">yum:</span> </span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">Nignx.conf</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">src:</span> <span class="string">nginx.conf.j2</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Nignx</span> <span class="string">Service</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nignx</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>

<p><strong>handlers注意事项：</strong></p>
<ul>
<li>无论多少个task通知相同的handlers，handlers仅会在所有task结束后执行一次；</li>
<li>只有task发生变化后才会通知handlers，没有改变则不会触发handlers；</li>
<li>不能使用handlers代替task，因为handlers是一个特殊的task；</li>
</ul>
<h4 id="8-4-playbook-tag"><a href="#8-4-playbook-tag" class="headerlink" title="8.4 playbook tag"></a>8.4 playbook tag</h4><p>默认情况下，Ansible在执行一个playbook时，会执行playbook中的定义的所有任务。Ansible的标签（Tags）功能可以给单独任务甚至整个playbook打上tag标签，然后利用tag标签指定要运行的个别任务，或跳过个别的任务！</p>
<h6 id="案例："><a href="#案例：" class="headerlink" title="案例："></a>案例：</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Instll</span> <span class="string">Nginx</span></span><br><span class="line">    <span class="attr">yum:</span> </span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">install</span> <span class="string">nginx</span>            <span class="comment"># 添加tag标签</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">Nignx.conf</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">src:</span> <span class="string">nginx.conf.j2</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Nignx</span> <span class="string">Service</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">Nginx</span> </span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">start</span> <span class="string">nginx</span>          <span class="comment"># 添加tag标签</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Nignx</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line"><span class="string">$</span> <span class="string">ansible-playbook</span> <span class="string">-i</span> <span class="string">hosts</span> <span class="string">test.yml</span>  <span class="string">-t</span> <span class="string">'install nginx'</span></span><br><span class="line"><span class="comment"># 仅仅执行playbook中的某个tag标签</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">$</span> <span class="string">ansible-playbook</span> <span class="string">-i</span> <span class="string">hosts</span> <span class="string">test.yml</span>  <span class="string">--skip-tags</span> <span class="string">'install nginx'</span></span><br><span class="line"><span class="comment"># 跳过playbook中的特定的tag标签</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">ansible-playbook</span> <span class="string">-i</span> <span class="string">hosts</span> <span class="string">test.yml</span>  <span class="string">-t</span> <span class="string">'install nginx'</span> <span class="string">-t</span> <span class="string">'start nginx'</span></span><br><span class="line"><span class="comment"># 指定多个tag标签</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">ansible-playbook</span> <span class="string">-i</span> <span class="string">hosts</span> <span class="string">test.yml</span>  <span class="string">--skip-tags</span> <span class="string">'install nginx'</span> <span class="string">--skip-tags</span> <span class="string">'start nginx'</span></span><br><span class="line"><span class="comment"># 跳过多个tag标签</span></span><br></pre></td></tr></table></figure>

<h4 id="8-5-playbook-include"><a href="#8-5-playbook-include" class="headerlink" title="8.5 playbook include"></a>8.5 playbook include</h4><p>有时发现大量的playbook内容要重复编写，与tasks之间贡呢需相互调用才能完成各自贡呢。playbook庞大到维护困难，这是就需要使用include！</p>
<h6 id="案例：-1"><a href="#案例：-1" class="headerlink" title="案例："></a>案例：</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat restart_httpd.yml </span></span><br><span class="line">- name: Restart Httpd Service</span><br><span class="line">  service:</span><br><span class="line">    name: httpd</span><br><span class="line">    state: restarted</span><br></pre></td></tr></table></figure>

<p>A Project的yaml文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">A</span> <span class="string">Project</span> <span class="string">command</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">echo</span> <span class="string">"A"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Httpd</span></span><br><span class="line">      <span class="attr">include:</span> <span class="string">restart_httpd.yml</span></span><br></pre></td></tr></table></figure>

<p>A Project的yaml文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">B</span> <span class="string">Project</span> <span class="string">command</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">echo</span> <span class="string">"B"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Httpd</span></span><br><span class="line">      <span class="attr">include:</span> <span class="string">restart_httpd.yml</span></span><br></pre></td></tr></table></figure>

<p><strong>高级用法：</strong></p>
<p>一次执行的多个playbook文件！</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat tasks_total.yml </span></span><br><span class="line">- import_playbook: test.yml</span><br><span class="line">- import_playbook: test01.yml</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ansible-playbook -i hosts  tasks_total.yml</span></span><br></pre></td></tr></table></figure>

<h4 id="8-6-ignore-errors忽略错误"><a href="#8-6-ignore-errors忽略错误" class="headerlink" title="8.6 ignore_errors忽略错误"></a>8.6 ignore_errors忽略错误</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Command</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/false</span></span><br><span class="line">      <span class="attr">ignore_errors:</span> <span class="literal">yes</span></span><br><span class="line">  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/tmp/file</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">touch</span></span><br></pre></td></tr></table></figure>

<h4 id="8-7-playbook错误处理"><a href="#8-7-playbook错误处理" class="headerlink" title="8.7 playbook错误处理"></a>8.7 playbook错误处理</h4><p>通常情况下，当task失败后，play将会终止，任何在前面已经被tasks notify的handlers都不会被执行。如果在play中设置<code>force_handlers</code>，被通知的handlers就会被强制执行。</p>
<h5 id="案例一：task执行失败强制调用handlers"><a href="#案例一：task执行失败强制调用handlers" class="headerlink" title="案例一：task执行失败强制调用handlers"></a>案例一：task执行失败强制调用handlers</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">force_handlers:</span> <span class="literal">yes</span>     <span class="comment"># 强制调用handlers</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Touch</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/tmp/test</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">touch</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Httpd</span> <span class="string">Service</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Packages</span></span><br><span class="line">      <span class="attr">yum:</span> </span><br><span class="line">        <span class="attr">name:</span> <span class="string">sb</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Httpd</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>

<h5 id="案例二：-关闭change的状态（确定不会对被控端主机进行任何的修改和变更）"><a href="#案例二：-关闭change的状态（确定不会对被控端主机进行任何的修改和变更）" class="headerlink" title="案例二： 关闭change的状态（确定不会对被控端主机进行任何的修改和变更）"></a>案例二： 关闭change的状态（确定不会对被控端主机进行任何的修改和变更）</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Httpd</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">yum:</span> </span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Service</span> <span class="string">Httpd</span> <span class="string">Started</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">Httpd</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">ps</span> <span class="string">aux</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">check_httpd</span></span><br><span class="line">      <span class="attr">changed_when:</span> <span class="literal">false</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OutPut</span> <span class="string">Variables</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">&#123;&#123; check_httpd.stdout_lines &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure>

<h5 id="案例三：-使用changed-when检查tasksrre任务返回结果"><a href="#案例三：-使用changed-when检查tasksrre任务返回结果" class="headerlink" title="案例三： 使用changed_when检查tasksrre任务返回结果"></a>案例三： 使用changed_when检查tasksrre任务返回结果</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Nginx</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">nginx.conf.j2</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">Restart</span> <span class="string">Nginx</span> <span class="string">Server</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">Httpd</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">/usr/sbin/nginx</span> <span class="string">-t</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">nginx_check</span></span><br><span class="line">      <span class="attr">changed_when:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">(nginx_check.stdout.find('successful'))</span></span><br><span class="line">        <span class="bullet">-</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">Httpd</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">handlers:</span> <span class="string">Restart</span> <span class="string">Httpd</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>

<p><strong><strong><strong>***</strong></strong></strong> 当你发现自己的才华撑不起野心时，就请安静下来学习吧！<strong><strong><strong>***</strong></strong></strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/04/04/fastdfs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhangpengjie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/zpj.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zpj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/04/fastdfs/" itemprop="url">fastdfs</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-04-04T11:47:17+08:00">
                2021-04-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/fastdfs/" itemprop="url" rel="index">
                    <span itemprop="name">fastdfs</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/04/04/fastdfs/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2021/04/04/fastdfs/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="用FastDFS一步步搭建文件管理系统"><a href="#用FastDFS一步步搭建文件管理系统" class="headerlink" title="用FastDFS一步步搭建文件管理系统"></a><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html" target="_blank" rel="noopener">用FastDFS一步步搭建文件管理系统</a></h1><p><strong>目录</strong></p>
<ul>
<li>一、FastDFS介绍<ul>
<li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label0_0" target="_blank" rel="noopener">1、简介</a></li>
<li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label0_1" target="_blank" rel="noopener">2、FastDFS的存储策略</a></li>
<li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label0_2" target="_blank" rel="noopener">3、FastDFS的上传过程</a></li>
<li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label0_3" target="_blank" rel="noopener">4、FastDFS的文件同步</a></li>
<li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label0_4" target="_blank" rel="noopener">5、FastDFS的文件下载</a></li>
</ul>
</li>
<li>二、安装FastDFS环境<ul>
<li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label1_0" target="_blank" rel="noopener">0、前言</a></li>
<li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label1_1" target="_blank" rel="noopener">1、下载安装 libfastcommon</a></li>
<li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label1_2" target="_blank" rel="noopener">2、下载安装FastDFS</a></li>
<li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label1_3" target="_blank" rel="noopener">3、配置FastDFS跟踪器(Tracker)</a></li>
<li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label1_4" target="_blank" rel="noopener">4、配置 FastDFS 存储 (Storage)</a></li>
<li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label1_5" target="_blank" rel="noopener">5、文件上传测试</a></li>
</ul>
</li>
<li>三、安装Nginx<ul>
<li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label2_0" target="_blank" rel="noopener">1、安装nginx所需环境　　</a></li>
<li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label2_1" target="_blank" rel="noopener">2、安装Nginx</a></li>
<li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label2_2" target="_blank" rel="noopener">3、访问文件</a></li>
</ul>
</li>
<li>四、FastDFS 配置 Nginx 模块<ul>
<li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label3_0" target="_blank" rel="noopener">1、安装配置Nginx模块</a></li>
</ul>
</li>
<li>五、Java客户端<ul>
<li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label4_0" target="_blank" rel="noopener">1、首先需要搭建 FastDFS 客户端Java开发环境</a></li>
<li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label4_1" target="_blank" rel="noopener">2、客户端API</a></li>
<li><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_label4_2" target="_blank" rel="noopener">六、权限控制</a></li>
</ul>
</li>
</ul>
<hr>
<p><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_labelTop" target="_blank" rel="noopener">回到顶部</a></p>
<h2 id="一、FastDFS介绍"><a href="#一、FastDFS介绍" class="headerlink" title="一、FastDFS介绍"></a>一、FastDFS介绍</h2><p>FastDFS开源地址：<a href="https://github.com/happyfish100" target="_blank" rel="noopener">https://github.com/happyfish100</a></p>
<p>参考：<a href="http://blog.chinaunix.net/uid-20196318-id-4058561.html" target="_blank" rel="noopener">分布式文件系统FastDFS设计原理</a> </p>
<p>参考：<a href="http://www.cnblogs.com/Leo_wl/p/6731647.html" target="_blank" rel="noopener">FastDFS分布式文件系统</a></p>
<p>个人封装的FastDFS Java API：<a href="https://github.com/bojiangzhou/lyyzoo-fastdfs-java" target="_blank" rel="noopener">https://github.com/bojiangzhou/lyyzoo-fastdfs-java</a></p>
<h3 id="1、简介"><a href="#1、简介" class="headerlink" title="1、简介"></a>1、简介</h3><p>FastDFS 是一个开源的高性能分布式文件系统（DFS）。 它的主要功能包括：文件存储，文件同步和文件访问，以及高容量和负载平衡。主要解决了海量数据存储问题，特别适合以中小文件（建议范围：4KB &lt; file_size &lt;500MB）为载体的在线服务。</p>
<p>FastDFS 系统有三个角色：跟踪服务器(Tracker Server)、存储服务器(Storage Server)和客户端(Client)。</p>
<p>　　<strong>Tracker Server</strong>：跟踪服务器，主要做调度工作，起到均衡的作用；负责管理所有的 storage server和 group，每个 storage 在启动后会连接 Tracker，告知自己所属 group 等信息，并保持周期性心跳。</p>
<p>　　<strong>Storage Server</strong>：存储服务器，主要提供容量和备份服务；以 group 为单位，每个 group 内可以有多台 storage server，数据互为备份。</p>
<p>　　<strong>Client</strong>：客户端，上传下载数据的服务器，也就是我们自己的项目所部署在的服务器。</p>
<p> <img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011144153840-1185141903.png" alt="img"></p>
<h3 id="2、FastDFS的存储策略"><a href="#2、FastDFS的存储策略" class="headerlink" title="2、FastDFS的存储策略"></a><strong>2、FastDFS的存储策略</strong></h3><p>为了支持大容量，存储节点（服务器）采用了分卷（或分组）的组织方式。存储系统由一个或多个卷组成，卷与卷之间的文件是相互独立的，所有卷的文件容量累加就是整个存储系统中的文件容量。一个卷可以由一台或多台存储服务器组成，一个卷下的存储服务器中的文件都是相同的，卷中的多台存储服务器起到了冗余备份和负载均衡的作用。</p>
<p>在卷中增加服务器时，同步已有的文件由系统自动完成，同步完成后，系统自动将新增服务器切换到线上提供服务。当存储空间不足或即将耗尽时，可以动态添加卷。只需要增加一台或多台服务器，并将它们配置为一个新的卷，这样就扩大了存储系统的容量。</p>
<h3 id="3、FastDFS的上传过程"><a href="#3、FastDFS的上传过程" class="headerlink" title="3、FastDFS的上传过程"></a><strong>3、FastDFS的上传过程</strong></h3><p>FastDFS向使用者提供基本文件访问接口，比如upload、download、append、delete等，以客户端库的方式提供给用户使用。</p>
<p>Storage Server会定期的向Tracker Server发送自己的存储信息。当Tracker Server Cluster中的Tracker Server不止一个时，各个Tracker之间的关系是对等的，所以客户端上传时可以选择任意一个Tracker。</p>
<p>当Tracker收到客户端上传文件的请求时，会为该文件分配一个可以存储文件的group，当选定了group后就要决定给客户端分配group中的哪一个storage server。当分配好storage server后，客户端向storage发送写文件请求，storage将会为文件分配一个数据存储目录。然后为文件分配一个fileid，最后根据以上的信息生成文件名存储文件。</p>
<p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171012121639387-1574147926.png" alt="img"></p>
<h3 id="4、FastDFS的文件同步"><a href="#4、FastDFS的文件同步" class="headerlink" title="4、FastDFS的文件同步"></a><strong>4、FastDFS的文件同步</strong></h3><p>写文件时，客户端将文件写至group内一个storage server即认为写文件成功，storage server写完文件后，会由后台线程将文件同步至同group内其他的storage server。</p>
<p>每个storage写文件后，同时会写一份binlog，binlog里不包含文件数据，只包含文件名等元信息，这份binlog用于后台同步，storage会记录向group内其他storage同步的进度，以便重启后能接上次的进度继续同步；进度以时间戳的方式进行记录，所以最好能保证集群内所有server的时钟保持同步。</p>
<p>storage的同步进度会作为元数据的一部分汇报到tracker上，tracke在选择读storage的时候会以同步进度作为参考。</p>
<h3 id="5、FastDFS的文件下载"><a href="#5、FastDFS的文件下载" class="headerlink" title="5、FastDFS的文件下载"></a><strong>5、FastDFS的文件下载</strong></h3><p>客户端uploadfile成功后，会拿到一个storage生成的文件名，接下来客户端根据这个文件名即可访问到该文件。</p>
<p><img src="https://images2015.cnblogs.com/blog/380252/201704/380252-20170415090611017-204910775.png" alt="img"></p>
<p>跟upload file一样，在downloadfile时客户端可以选择任意tracker server。tracker发送download请求给某个tracker，必须带上文件名信息，tracke从文件名中解析出文件的group、大小、创建时间等信息，然后为该请求选择一个storage用来服务读请求。</p>
<p><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_labelTop" target="_blank" rel="noopener">回到顶部</a></p>
<h2 id="二、安装FastDFS环境"><a href="#二、安装FastDFS环境" class="headerlink" title="二、安装FastDFS环境"></a>二、安装FastDFS环境</h2><h3 id="0、前言"><a href="#0、前言" class="headerlink" title="0、前言"></a>0、前言</h3><p>操作环境：CentOS7 X64，以下操作都是单机环境。</p>
<p>我把所有的安装包下载到/softpackages/下，解压到当前目录。</p>
<p>先做一件事，修改hosts，将文件服务器的ip与域名映射(单机TrackerServer环境)，因为后面很多配置里面都需要去配置服务器地址，ip变了，就只需要修改hosts即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># vim &#x2F;etc&#x2F;hosts</span><br><span class="line"></span><br><span class="line">增加如下一行，这是我的IP</span><br><span class="line">192.168.51.128 file.ljzsg.com</span><br><span class="line"></span><br><span class="line">如果要本机访问虚拟机，在C:\Windows\System32\drivers\etc\hosts中同样增加一行</span><br></pre></td></tr></table></figure>



<h3 id="1、下载安装-libfastcommon"><a href="#1、下载安装-libfastcommon" class="headerlink" title="1、下载安装 libfastcommon"></a>1、下载安装 libfastcommon</h3><p>libfastcommon是从 FastDFS 和 FastDHT 中提取出来的公共 C 函数库，基础环境，安装即可 。</p>
<p>① 下载libfastcommon</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># wget https:&#x2F;&#x2F;github.com&#x2F;happyfish100&#x2F;libfastcommon&#x2F;archive&#x2F;V1.0.7.tar.gz</span><br></pre></td></tr></table></figure>

<p>② 解压</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># tar -zxvf V1.0.7.tar.gz</span><br><span class="line"># cd libfastcommon-1.0.7</span><br></pre></td></tr></table></figure>

<p>③ 编译、安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># .&#x2F;make.sh</span><br><span class="line"># .&#x2F;make.sh install</span><br></pre></td></tr></table></figure>

<p>④ libfastcommon.so 安装到了/usr/lib64/libfastcommon.so，但是FastDFS主程序设置的lib目录是/usr/local/lib，所以需要创建软链接。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># ln -s &#x2F;usr&#x2F;lib64&#x2F;libfastcommon.so &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libfastcommon.so</span><br><span class="line"># ln -s &#x2F;usr&#x2F;lib64&#x2F;libfastcommon.so &#x2F;usr&#x2F;lib&#x2F;libfastcommon.so</span><br><span class="line"># ln -s &#x2F;usr&#x2F;lib64&#x2F;libfdfsclient.so &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libfdfsclient.so</span><br><span class="line"># ln -s &#x2F;usr&#x2F;lib64&#x2F;libfdfsclient.so &#x2F;usr&#x2F;lib&#x2F;libfdfsclient.so</span><br></pre></td></tr></table></figure>



<h3 id="2、下载安装FastDFS"><a href="#2、下载安装FastDFS" class="headerlink" title="2、下载安装FastDFS"></a>2、下载安装FastDFS</h3><p>① 下载FastDFS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># wget https:&#x2F;&#x2F;github.com&#x2F;happyfish100&#x2F;fastdfs&#x2F;archive&#x2F;V5.05.tar.gz</span><br></pre></td></tr></table></figure>

<p>② 解压</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># tar -zxvf V5.05.tar.gz</span><br><span class="line"># cd fastdfs-5.05</span><br></pre></td></tr></table></figure>

<p>③ 编译、安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># .&#x2F;make.sh</span><br><span class="line"># .&#x2F;make.sh install</span><br></pre></td></tr></table></figure>

<p>④ 默认安装方式安装后的相应文件与目录<br>　　A、服务脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;init.d&#x2F;fdfs_storaged</span><br><span class="line">&#x2F;etc&#x2F;init.d&#x2F;fdfs_tracker</span><br></pre></td></tr></table></figure>

<p>　　B、配置文件（这三个是作者给的样例配置文件） :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;fdfs&#x2F;client.conf.sample</span><br><span class="line">&#x2F;etc&#x2F;fdfs&#x2F;storage.conf.sample</span><br><span class="line">&#x2F;etc&#x2F;fdfs&#x2F;tracker.conf.sample</span><br></pre></td></tr></table></figure>

<p>　　C、命令工具在 /usr/bin/ 目录下：</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">fdfs_appender_test</span><br><span class="line">fdfs_appender_test1</span><br><span class="line">fdfs_append_file</span><br><span class="line">fdfs_crc32</span><br><span class="line">fdfs_delete_file</span><br><span class="line">fdfs_download_file</span><br><span class="line">fdfs_file_info</span><br><span class="line">fdfs_monitor</span><br><span class="line">fdfs_storaged</span><br><span class="line">fdfs_test</span><br><span class="line">fdfs_test1</span><br><span class="line">fdfs_trackerd</span><br><span class="line">fdfs_upload_appender</span><br><span class="line">fdfs_upload_file</span><br><span class="line">stop.sh</span><br><span class="line">restart.sh</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>⑤ FastDFS 服务脚本设置的 bin 目录是 /usr/local/bin， 但实际命令安装在 /usr/bin/ 下。</p>
<p>　　两种方式：</p>
<p>　　》 一是修改FastDFS 服务脚本中相应的命令路径，也就是把 /etc/init.d/fdfs_storaged 和 /etc/init.d/fdfs_tracker 两个脚本中的 /usr/local/bin 修改成 /usr/bin。</p>
<p> 　　　# vim fdfs_trackerd<br>　　　　使用查找替换命令进统一修改:%s+/usr/local/bin+/usr/bin<br>　　　　# vim fdfs_storaged<br>　　　　使用查找替换命令进统一修改:%s+/usr/local/bin+/usr/bin</p>
<p>　　　　<img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011104718043-576731412.png" alt="img"></p>
<p>　　》 二是建立 /usr/bin 到 /usr/local/bin 的软链接，我是用这种方式。　　</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># ln -s &#x2F;usr&#x2F;bin&#x2F;fdfs_trackerd   &#x2F;usr&#x2F;local&#x2F;bin</span><br><span class="line"># ln -s &#x2F;usr&#x2F;bin&#x2F;fdfs_storaged   &#x2F;usr&#x2F;local&#x2F;bin</span><br><span class="line"># ln -s &#x2F;usr&#x2F;bin&#x2F;stop.sh         &#x2F;usr&#x2F;local&#x2F;bin</span><br><span class="line"># ln -s &#x2F;usr&#x2F;bin&#x2F;restart.sh      &#x2F;usr&#x2F;local&#x2F;bin</span><br></pre></td></tr></table></figure>



<h3 id="3、配置FastDFS跟踪器-Tracker"><a href="#3、配置FastDFS跟踪器-Tracker" class="headerlink" title="3、配置FastDFS跟踪器(Tracker)"></a>3、配置FastDFS跟踪器(Tracker)</h3><p>配置文件详细说明参考：<a href="http://bbs.chinaunix.net/forum.php?mod=viewthread&tid=1941456&extra=page%3D1%26filter%3Ddigest%26digest%3D1" target="_blank" rel="noopener">FastDFS 配置文件详解</a></p>
<p>① 进入 /etc/fdfs，复制 FastDFS 跟踪器样例配置文件 tracker.conf.sample，并重命名为 tracker.conf。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;etc&#x2F;fdfs</span><br><span class="line"># cp tracker.conf.sample tracker.conf</span><br><span class="line"># vim tracker.conf</span><br></pre></td></tr></table></figure>

<p>② 编辑tracker.conf ，标红的需要修改下，其它的默认即可。</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 配置文件是否不生效，false 为生效</span><br><span class="line">disabled&#x3D;false</span><br><span class="line"># 提供服务的端口</span><br><span class="line">port&#x3D;22122</span><br><span class="line"># Tracker 数据和日志目录地址(根目录必须存在,子目录会自动创建)</span><br><span class="line">base_path&#x3D;&#x2F;ljzsg&#x2F;fastdfs&#x2F;tracker</span><br><span class="line"># HTTP 服务端口</span><br><span class="line">http.server_port&#x3D;80</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>③ 创建tracker基础数据目录，即base_path对应的目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p &#x2F;ljzsg&#x2F;fastdfs&#x2F;tracker</span><br></pre></td></tr></table></figure>

<p>④ 防火墙中打开跟踪端口（默认的22122）</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># vim &#x2F;etc&#x2F;sysconfig&#x2F;iptables</span><br><span class="line">添加如下端口行：</span><br><span class="line">-A INPUT -m state --state NEW -m tcp -p tcp --dport 22122 -j ACCEPT</span><br><span class="line">重启防火墙：</span><br><span class="line"># service iptables restart</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>⑤ 启动Tracker</p>
<p>初次成功启动，会在 /ljzsg/fdfsdfs/tracker/ (配置的base_path)下创建 data、logs 两个目录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">可以用这种方式启动</span><br><span class="line"># &#x2F;etc&#x2F;init.d&#x2F;fdfs_trackerd start</span><br><span class="line"></span><br><span class="line">也可以用这种方式启动，前提是上面创建了软链接，后面都用这种方式</span><br><span class="line"># service fdfs_trackerd start</span><br></pre></td></tr></table></figure>

<p>查看 FastDFS Tracker 是否已成功启动 ，22122端口正在被监听，则算是Tracker服务安装成功。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># netstat -unltp|grep fdfs</span><br></pre></td></tr></table></figure>

<p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011121344184-1089101646.png" alt="img"></p>
<p>关闭Tracker命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># service fdfs_trackerd stop</span><br></pre></td></tr></table></figure>

<p>⑥ 设置Tracker开机启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># chkconfig fdfs_trackerd on</span><br><span class="line"></span><br><span class="line">或者：</span><br><span class="line"># vim &#x2F;etc&#x2F;rc.d&#x2F;rc.local</span><br><span class="line">加入配置：</span><br><span class="line">&#x2F;etc&#x2F;init.d&#x2F;fdfs_trackerd start</span><br></pre></td></tr></table></figure>

<p>⑦ tracker server 目录及文件结构</p>
<p>Tracker服务启动成功后，会在base_path下创建data、logs两个目录。目录结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$&#123;base_path&#125;</span><br><span class="line">  |__data</span><br><span class="line">  |   |__storage_groups.dat：存储分组信息</span><br><span class="line">  |   |__storage_servers.dat：存储服务器列表</span><br><span class="line">  |__logs</span><br><span class="line">  |   |__trackerd.log： tracker server 日志文件</span><br></pre></td></tr></table></figure>



<h3 id="4、配置-FastDFS-存储-Storage"><a href="#4、配置-FastDFS-存储-Storage" class="headerlink" title="4、配置 FastDFS 存储 (Storage)"></a>4、配置 FastDFS 存储 (Storage)</h3><p>① 进入 /etc/fdfs 目录，复制 FastDFS 存储器样例配置文件 storage.conf.sample，并重命名为 storage.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;etc&#x2F;fdfs</span><br><span class="line"># cp storage.conf.sample storage.conf# vim storage.conf</span><br></pre></td></tr></table></figure>

<p>② 编辑storage.conf</p>
<p>标红的需要修改，其它的默认即可。</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># 配置文件是否不生效，false 为生效</span><br><span class="line">disabled&#x3D;false </span><br><span class="line"></span><br><span class="line"># 指定此 storage server 所在 组(卷)</span><br><span class="line">group_name&#x3D;group1</span><br><span class="line"></span><br><span class="line"># storage server 服务端口</span><br><span class="line">port&#x3D;23000</span><br><span class="line"></span><br><span class="line"># 心跳间隔时间，单位为秒 (这里是指主动向 tracker server 发送心跳)</span><br><span class="line">heart_beat_interval&#x3D;30</span><br><span class="line"></span><br><span class="line"># Storage 数据和日志目录地址(根目录必须存在，子目录会自动生成)</span><br><span class="line">base_path&#x3D;&#x2F;ljzsg&#x2F;fastdfs&#x2F;storage</span><br><span class="line"></span><br><span class="line"># 存放文件时 storage server 支持多个路径。这里配置存放文件的基路径数目，通常只配一个目录。</span><br><span class="line">store_path_count&#x3D;1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 逐一配置 store_path_count 个路径，索引号基于 0。</span><br><span class="line"># 如果不配置 store_path0，那它就和 base_path 对应的路径一样。</span><br><span class="line">store_path0&#x3D;&#x2F;ljzsg&#x2F;fastdfs&#x2F;file</span><br><span class="line"></span><br><span class="line"># FastDFS 存储文件时，采用了两级目录。这里配置存放文件的目录个数。 </span><br><span class="line"># 如果本参数只为 N（如： 256），那么 storage server 在初次运行时，会在 store_path 下自动创建 N * N 个存放文件的子目录。</span><br><span class="line">subdir_count_per_path&#x3D;256</span><br><span class="line"></span><br><span class="line"># tracker_server 的列表 ，会主动连接 tracker_server</span><br><span class="line"># 有多个 tracker server 时，每个 tracker server 写一行</span><br><span class="line">tracker_server&#x3D;file.ljzsg.com:22122# 允许系统同步的时间段 (默认是全天) 。一般用于避免高峰同步产生一些问题而设定。sync_start_time&#x3D;00:00sync_end_time&#x3D;23:59</span><br><span class="line"># 访问端口</span><br><span class="line">http.server_port&#x3D;80</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>③ 创建Storage基础数据目录，对应base_path目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p &#x2F;ljzsg&#x2F;fastdfs&#x2F;storage</span><br><span class="line"></span><br><span class="line"># 这是配置的store_path0路径</span><br><span class="line"># mkdir -p &#x2F;ljzsg&#x2F;fastdfs&#x2F;file</span><br></pre></td></tr></table></figure>

<p>④ 防火墙中打开存储器端口（默认的 23000）</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># vim &#x2F;etc&#x2F;sysconfig&#x2F;iptables</span><br><span class="line"></span><br><span class="line">添加如下端口行：</span><br><span class="line">-A INPUT -m state --state NEW -m tcp -p tcp --dport 23000 -j ACCEPT</span><br><span class="line"></span><br><span class="line">重启防火墙：</span><br><span class="line"># service iptables restart</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011133233777-1903096242.png" alt="img"></p>
<p>⑤ 启动 Storage</p>
<p>启动Storage前确保Tracker是启动的。初次启动成功，会在 /ljzsg/fastdfs/storage 目录下创建 data、 logs 两个目录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">可以用这种方式启动</span><br><span class="line"># &#x2F;etc&#x2F;init.d&#x2F;fdfs_storaged start</span><br><span class="line"></span><br><span class="line">也可以用这种方式，后面都用这种</span><br><span class="line"># service fdfs_storaged start</span><br></pre></td></tr></table></figure>

<p>查看 Storage 是否成功启动，23000 端口正在被监听，就算 Storage 启动成功。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># netstat -unltp|grep fdfs</span><br></pre></td></tr></table></figure>

<p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011134723387-604894314.png" alt="img"></p>
<p>关闭Storage命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># service fdfs_storaged stop</span><br></pre></td></tr></table></figure>

<p>查看Storage和Tracker是否在通信：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;bin&#x2F;fdfs_monitor &#x2F;etc&#x2F;fdfs&#x2F;storage.conf</span><br></pre></td></tr></table></figure>

<p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171016093815615-757608481.png" alt="img"></p>
<p>⑥ 设置 Storage 开机启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># chkconfig fdfs_storaged on</span><br><span class="line">或者：</span><br><span class="line"># vim &#x2F;etc&#x2F;rc.d&#x2F;rc.local</span><br><span class="line">加入配置：</span><br><span class="line">&#x2F;etc&#x2F;init.d&#x2F;fdfs_storaged start</span><br></pre></td></tr></table></figure>

<p>⑦ Storage 目录</p>
<p>同 Tracker，Storage 启动成功后，在base_path 下创建了data、logs目录，记录着 Storage Server 的信息。</p>
<p>在 store_path0 目录下，创建了N*N个子目录：</p>
<p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011135658074-1715166829.png" alt="img"></p>
<h3 id="5、文件上传测试"><a href="#5、文件上传测试" class="headerlink" title="5、文件上传测试"></a>5、文件上传测试</h3><p>① 修改 Tracker 服务器中的客户端配置文件 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;etc&#x2F;fdfs</span><br><span class="line"># cp client.conf.sample client.conf</span><br><span class="line"># vim client.conf</span><br></pre></td></tr></table></figure>

<p>修改如下配置即可，其它默认。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Client 的数据和日志目录</span><br><span class="line">base_path&#x3D;&#x2F;ljzsg&#x2F;fastdfs&#x2F;client</span><br><span class="line"></span><br><span class="line"># Tracker端口</span><br><span class="line">tracker_server&#x3D;file.ljzsg.com:22122</span><br></pre></td></tr></table></figure>

<p>② 上传测试</p>
<p> 在linux内部执行如下命令上传 namei.jpeg 图片</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># &#x2F;usr&#x2F;bin&#x2F;fdfs_upload_file &#x2F;etc&#x2F;fdfs&#x2F;client.conf namei.jpeg</span><br></pre></td></tr></table></figure>

<p>上传成功后返回文件ID号：group1/M00/00/00/wKgz6lnduTeAMdrcAAEoRmXZPp870.jpeg</p>
<p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011142634105-1857091563.png" alt="img"></p>
<p>返回的文件ID由group、存储目录、两级子目录、fileid、文件后缀名（由客户端指定，主要用于区分文件类型）拼接而成。</p>
<p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011151728965-914197096.png" alt="img"></p>
<p><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_labelTop" target="_blank" rel="noopener">回到顶部</a></p>
<h2 id="三、安装Nginx"><a href="#三、安装Nginx" class="headerlink" title="三、安装Nginx"></a>三、安装Nginx</h2><p>上面将文件上传成功了，但我们无法下载。因此安装Nginx作为服务器以支持Http方式访问文件。同时，后面安装FastDFS的Nginx模块也需要Nginx环境。</p>
<p>Nginx只需要安装到StorageServer所在的服务器即可，用于访问文件。我这里由于是单机，TrackerServer和StorageServer在一台服务器上。</p>
<h3 id="1、安装nginx所需环境"><a href="#1、安装nginx所需环境" class="headerlink" title="1、安装nginx所需环境　　"></a>1、安装nginx所需环境　　</h3><p>① gcc 安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># yum install gcc-c++</span><br></pre></td></tr></table></figure>

<p>② PCRE pcre-devel 安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># yum install -y pcre pcre-devel</span><br></pre></td></tr></table></figure>

<p>③ zlib 安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># yum install -y zlib zlib-devel</span><br></pre></td></tr></table></figure>

<p>④ OpenSSL 安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># yum install -y openssl openssl-devel</span><br></pre></td></tr></table></figure>



<h3 id="2、安装Nginx"><a href="#2、安装Nginx" class="headerlink" title="2、安装Nginx"></a>2、安装Nginx</h3><p>① 下载nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># wget -c https:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.12.1.tar.gz</span><br></pre></td></tr></table></figure>

<p>② 解压</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># tar -zxvf nginx-1.12.1.tar.gz</span><br><span class="line"># cd nginx-1.12.1</span><br></pre></td></tr></table></figure>

<p>③ 使用默认配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># .&#x2F;configure</span><br></pre></td></tr></table></figure>

<p>④ 编译、安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># make</span><br><span class="line"># make install</span><br></pre></td></tr></table></figure>

<p>⑤ 启动nginx</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;</span><br><span class="line"># .&#x2F;nginx </span><br><span class="line"></span><br><span class="line">其它命令</span><br><span class="line"># .&#x2F;nginx -s stop</span><br><span class="line"># .&#x2F;nginx -s quit</span><br><span class="line"># .&#x2F;nginx -s reload</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>⑥ 设置开机启动</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># vim &#x2F;etc&#x2F;rc.local</span><br><span class="line"></span><br><span class="line">添加一行：</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx# 设置执行权限# chmod 755 rc.local</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>⑦ 查看nginx的版本及模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -V</span><br></pre></td></tr></table></figure>

<p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011165300730-1693050013.png" alt="img"></p>
<p>⑧ 防火墙中打开Nginx端口（默认的 80） </p>
<p>添加后就能在本机使用80端口访问了。</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># vim &#x2F;etc&#x2F;sysconfig&#x2F;iptables</span><br><span class="line"></span><br><span class="line">添加如下端口行：</span><br><span class="line">-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT</span><br><span class="line"></span><br><span class="line">重启防火墙：</span><br><span class="line"># service iptables restart</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011172121746-2118138931.png" alt="img"></p>
<h3 id="3、访问文件"><a href="#3、访问文件" class="headerlink" title="3、访问文件"></a>3、访问文件</h3><p>简单的测试访问文件</p>
<p>① 修改nginx.conf</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># vim &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</span><br><span class="line"></span><br><span class="line">添加如下行，将 &#x2F;group1&#x2F;M00 映射到 &#x2F;ljzsg&#x2F;fastdfs&#x2F;file&#x2F;data</span><br><span class="line">location &#x2F;group1&#x2F;M00 &#123;</span><br><span class="line">    alias &#x2F;ljzsg&#x2F;fastdfs&#x2F;file&#x2F;data;</span><br><span class="line">&#125;# 重启nginx# &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -s reload</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011180543746-937678567.png" alt="img"></p>
<p>② 在浏览器访问之前上传的图片、成功。</p>
<p><a href="http://file.ljzsg.com/group1/M00/00/00/wKgz6lnduTeAMdrcAAEoRmXZPp870.jpeg" target="_blank" rel="noopener">http://file.ljzsg.com/group1/M00/00/00/wKgz6lnduTeAMdrcAAEoRmXZPp870.jpeg</a></p>
<p><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_labelTop" target="_blank" rel="noopener">回到顶部</a></p>
<h2 id="四、FastDFS-配置-Nginx-模块"><a href="#四、FastDFS-配置-Nginx-模块" class="headerlink" title="四、FastDFS 配置 Nginx 模块"></a>四、FastDFS 配置 Nginx 模块</h2><h3 id="1、安装配置Nginx模块"><a href="#1、安装配置Nginx模块" class="headerlink" title="1、安装配置Nginx模块"></a>1、安装配置Nginx模块</h3><p>① fastdfs-nginx-module 模块说明</p>
<p>　　FastDFS 通过 Tracker 服务器，将文件放在 Storage 服务器存储， 但是同组存储服务器之间需要进行文件复制， 有同步延迟的问题。</p>
<p>　　假设 Tracker 服务器将文件上传到了 192.168.51.128，上传成功后文件 ID已经返回给客户端。</p>
<p>　　此时 FastDFS 存储集群机制会将这个文件同步到同组存储 192.168.51.129，在文件还没有复制完成的情况下，客户端如果用这个文件 ID 在 192.168.51.129 上取文件,就会出现文件无法访问的错误。</p>
<p>　　而 fastdfs-nginx-module 可以重定向文件链接到源服务器取文件，避免客户端由于复制延迟导致的文件无法访问错误。</p>
<p>② 下载 fastdfs-nginx-module、解压</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 这里为啥这么长一串呢，因为最新版的master与当前nginx有些版本问题。</span><br><span class="line"># wget https:&#x2F;&#x2F;github.com&#x2F;happyfish100&#x2F;fastdfs-nginx-module&#x2F;archive&#x2F;5e5f3566bbfa57418b5506aaefbe107a42c9fcb1.zip</span><br><span class="line"></span><br><span class="line"># 解压</span><br><span class="line"># unzip 5e5f3566bbfa57418b5506aaefbe107a42c9fcb1.zip</span><br><span class="line"></span><br><span class="line"># 重命名</span><br><span class="line"># mv fastdfs-nginx-module-5e5f3566bbfa57418b5506aaefbe107a42c9fcb1  fastdfs-nginx-module-master</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>③ 配置Nginx</p>
<p>在nginx中添加模块</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 先停掉nginx服务# &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -s stop进入解压包目录</span><br><span class="line"># cd &#x2F;softpackages&#x2F;nginx-1.12.1&#x2F;</span><br><span class="line"></span><br><span class="line"># 添加模块</span><br><span class="line"># .&#x2F;configure --add-module&#x3D;..&#x2F;fastdfs-nginx-module-master&#x2F;src</span><br><span class="line"></span><br><span class="line">重新编译、安装</span><br><span class="line"># make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p> ④ 查看Nginx的模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -V</span><br></pre></td></tr></table></figure>

<p>有下面这个就说明添加模块成功</p>
<p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011224125574-1739252073.png" alt="img"></p>
<p>⑤ 复制 fastdfs-nginx-module 源码中的配置文件到/etc/fdfs 目录， 并修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;softpackages&#x2F;fastdfs-nginx-module-master&#x2F;src</span><br><span class="line"></span><br><span class="line"># cp mod_fastdfs.conf &#x2F;etc&#x2F;fdfs&#x2F;</span><br></pre></td></tr></table></figure>

<p>修改如下配置，其它默认</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 连接超时时间connect_timeout&#x3D;10</span><br><span class="line"></span><br><span class="line"># Tracker Server</span><br><span class="line">tracker_server&#x3D;file.ljzsg.com:22122</span><br><span class="line"># StorageServer 默认端口</span><br><span class="line">storage_server_port&#x3D;23000</span><br><span class="line"></span><br><span class="line"># 如果文件ID的uri中包含&#x2F;group**，则要设置为true</span><br><span class="line">url_have_group_name &#x3D; true</span><br><span class="line"></span><br><span class="line"># Storage 配置的store_path0路径，必须和storage.conf中的一致</span><br><span class="line">store_path0&#x3D;&#x2F;ljzsg&#x2F;fastdfs&#x2F;file</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>⑥ 复制 FastDFS 的部分配置文件到/etc/fdfs 目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;softpackages&#x2F;fastdfs-5.05&#x2F;conf&#x2F;</span><br><span class="line"></span><br><span class="line"># cp anti-steal.jpg http.conf mime.types &#x2F;etc&#x2F;fdfs&#x2F;</span><br></pre></td></tr></table></figure>

<p> ⑦ 配置nginx，修改nginx.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vim &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</span><br></pre></td></tr></table></figure>

<p>修改配置，其它的默认</p>
<p>在80端口下添加fastdfs-nginx模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location ~&#x2F;group([0-9])&#x2F;M00 &#123;</span><br><span class="line">    ngx_fastdfs_module;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011184247777-40074297.png" alt="img"></p>
<p>注意：</p>
<p>　　listen 80 端口值是要与 /etc/fdfs/storage.conf 中的 http.server_port=80 (前面改成80了)相对应。如果改成其它端口，则需要统一，同时在防火墙中打开该端口。</p>
<p>　　location 的配置，如果有多个group则配置location ~/group([0-9])/M00 ，没有则不用配group。</p>
<p>⑧ 在/ljzsg/fastdfs/file 文件存储目录下创建软连接，将其链接到实际存放数据的目录，这一步可以省略。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ln -s &#x2F;ljzsg&#x2F;fastdfs&#x2F;file&#x2F;data&#x2F; &#x2F;ljzsg&#x2F;fastdfs&#x2F;file&#x2F;data&#x2F;M00</span><br></pre></td></tr></table></figure>

<p>⑨ 启动nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx</span><br></pre></td></tr></table></figure>

<p>打印处如下就算配置成功</p>
<p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171011230509512-654301113.png" alt="img"></p>
<p>⑩ 在地址栏访问。</p>
<p>能下载文件就算安装成功。注意和第三点中直接使用nginx路由访问不同的是，这里配置 fastdfs-nginx-module 模块，可以重定向文件链接到源服务器取文件。</p>
<p><a href="http://file.ljzsg.com/group1/M00/00/00/wKgz6lnduTeAMdrcAAEoRmXZPp870.jpeg" target="_blank" rel="noopener">http://file.ljzsg.com/group1/M00/00/00/wKgz6lnduTeAMdrcAAEoRmXZPp870.jpeg</a></p>
<p>最终部署结构图(盗的图)：可以按照下面的结构搭建环境。</p>
<p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171012180511480-692747720.png" alt="img"></p>
<p><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html#_labelTop" target="_blank" rel="noopener">回到顶部</a></p>
<h2 id="五、Java客户端"><a href="#五、Java客户端" class="headerlink" title="五、Java客户端"></a>五、Java客户端</h2><p>前面文件系统平台搭建好了，现在就要写客户端代码在系统中实现上传下载，这里只是简单的测试代码。</p>
<h3 id="1、首先需要搭建-FastDFS-客户端Java开发环境"><a href="#1、首先需要搭建-FastDFS-客户端Java开发环境" class="headerlink" title="1、首先需要搭建 FastDFS 客户端Java开发环境"></a>1、首先需要搭建 FastDFS 客户端Java开发环境</h3><p>① 项目中使用maven进行依赖管理，可以在pom.xml中引入如下依赖即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">   &lt;groupId&gt;net.oschina.zcx7878&lt;&#x2F;groupId&gt;</span><br><span class="line">   &lt;artifactId&gt;fastdfs-client-java&lt;&#x2F;artifactId&gt;</span><br><span class="line">   &lt;version&gt;1.27.0.0&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<p>其它的方式，参考官方文档：<a href="https://github.com/happyfish100/fastdfs-client-java" target="_blank" rel="noopener">https://github.com/happyfish100/fastdfs-client-java</a></p>
<p>② 引入配置文件</p>
<p>可直接复制包下的 fastdfs-client.properties.sample 或者 fdfs_client.conf.sample，到你的项目中，去掉.sample。</p>
<p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171012112805371-395330483.png" alt="img"></p>
<p>我这里直接复制 fastdfs-client.properties.sample 中的配置到项目配置文件 config.properties 中，修改tracker_servers。只需要加载这个配置文件即可</p>
<p><img src="https://images2017.cnblogs.com/blog/856154/201710/856154-20171012120004199-247798219.png" alt="img"></p>
<h3 id="2、客户端API"><a href="#2、客户端API" class="headerlink" title="2、客户端API"></a>2、客户端API</h3><p>个人封装的FastDFS Java API以同步到github：<a href="https://github.com/bojiangzhou/lyyzoo-fastdfs-java.git" target="_blank" rel="noopener">https://github.com/bojiangzhou/lyyzoo-fastdfs-java.git</a></p>
<h3 id="六、权限控制"><a href="#六、权限控制" class="headerlink" title="六、权限控制"></a>六、权限控制</h3><p>前面使用nginx支持http方式访问文件，但所有人都能直接访问这个文件服务器了，所以做一下权限控制。</p>
<p>FastDFS的权限控制是在服务端开启token验证，客户端根据文件名、当前unix时间戳、秘钥获取token，在地址中带上token参数即可通过http方式访问文件。</p>
<p>① 服务端开启token验证</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">修改http.conf</span><br><span class="line"># vim &#x2F;etc&#x2F;fdfs&#x2F;http.conf</span><br><span class="line"></span><br><span class="line">设置为true表示开启token验证</span><br><span class="line">http.anti_steal.check_token&#x3D;true设置token失效的时间单位为秒(s)http.anti_steal.token_ttl&#x3D;1800</span><br><span class="line">密钥，跟客户端配置文件的fastdfs.http_secret_key保持一致</span><br><span class="line">http.anti_steal.secret_key&#x3D;FASTDFS1234567890</span><br><span class="line"></span><br><span class="line">如果token检查失败，返回的页面</span><br><span class="line">http.anti_steal.token_check_fail&#x3D;&#x2F;ljzsg&#x2F;fastdfs&#x2F;page&#x2F;403.html</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>记得重启服务。</p>
<p>② 配置客户端</p>
<p>客户端只需要设置如下两个参数即可，两边的密钥保持一致。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># token 防盗链功能</span><br><span class="line">fastdfs.http_anti_steal_token&#x3D;true</span><br><span class="line"># 密钥</span><br><span class="line">fastdfs.http_secret_key&#x3D;FASTDFS1234567890</span><br></pre></td></tr></table></figure>

<p>③ 客户端生成token</p>
<p>访问文件需要带上生成的token以及unix时间戳，所以返回的token是token和时间戳的拼接。</p>
<p>之后，将token拼接在地址后即可访问：file.ljzsg.com/group1/M00/00/00/wKgzgFnkaXqAIfXyAAEoRmXZPp878.jpeg?token=078d370098b03e9020b82c829c205e1f&amp;ts=1508141521</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> 1     &#x2F;**</span><br><span class="line"> 2      * 获取访问服务器的token，拼接到地址后面</span><br><span class="line"> 3      *</span><br><span class="line"> 4      * @param filepath 文件路径 group1&#x2F;M00&#x2F;00&#x2F;00&#x2F;wKgzgFnkTPyAIAUGAAEoRmXZPp876.jpeg</span><br><span class="line"> 5      * @param httpSecretKey 密钥</span><br><span class="line"> 6      * @return 返回token，如： token&#x3D;078d370098b03e9020b82c829c205e1f&amp;ts&#x3D;1508141521</span><br><span class="line"> 7      *&#x2F;</span><br><span class="line"> 8     public static String getToken(String filepath, String httpSecretKey)&#123;</span><br><span class="line"> 9         &#x2F;&#x2F; unix seconds</span><br><span class="line">10         int ts &#x3D; (int) Instant.now().getEpochSecond();</span><br><span class="line">11         &#x2F;&#x2F; token</span><br><span class="line">12         String token &#x3D; &quot;null&quot;;</span><br><span class="line">13         try &#123;</span><br><span class="line">14             token &#x3D; ProtoCommon.getToken(getFilename(filepath), ts, httpSecretKey);</span><br><span class="line">15         &#125; catch (UnsupportedEncodingException e) &#123;</span><br><span class="line">16             e.printStackTrace();</span><br><span class="line">17         &#125; catch (NoSuchAlgorithmException e) &#123;</span><br><span class="line">18             e.printStackTrace();</span><br><span class="line">19         &#125; catch (MyException e) &#123;</span><br><span class="line">20             e.printStackTrace();</span><br><span class="line">21         &#125;</span><br><span class="line">22 </span><br><span class="line">23         StringBuilder sb &#x3D; new StringBuilder();</span><br><span class="line">24         sb.append(&quot;token&#x3D;&quot;).append(token);</span><br><span class="line">25         sb.append(&quot;&amp;ts&#x3D;&quot;).append(ts);</span><br><span class="line">26 </span><br><span class="line">27         return sb.toString();</span><br><span class="line">28     &#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>④ 注意事项</p>
<p>如果生成的token验证无法通过，请进行如下两项检查：<br>　　A. 确认调用token生成函数(ProtoCommon.getToken)，传递的文件ID中没有包含group name。传递的文件ID格式形如：M00/00/00/wKgzgFnkTPyAIAUGAAEoRmXZPp876.jpeg</p>
<p>　　B. 确认服务器时间基本是一致的，注意服务器时间不能相差太多，不要相差到分钟级别。</p>
<p>⑤ 对比下发现，如果系统文件隐私性较高，可以直接通过fastdfs-client提供的API去访问即可，不用再配置Nginx走http访问。配置Nginx的主要目的是为了快速访问服务器的文件(如图片)，如果还要加权限验证，则需要客户端生成token，其实已经没有多大意义。</p>
<p>关键是，这里我没找到FastDFS如何对部分资源加token验证，部分开放。有知道的还请留言。</p>
<hr>
<p>OK，以上就是单机中使用FastDFS搭建文件系统并上传下载的过程。</p>
<p>完！！！</p>
<p>原文链接：<a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html" target="_blank" rel="noopener">https://www.cnblogs.com/chiangchou/p/fastdfs.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/04/04/glusterfs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhangpengjie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/zpj.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zpj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/04/glusterfs/" itemprop="url">glusterfs</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-04-04T11:46:38+08:00">
                2021-04-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/glusterfs/" itemprop="url" rel="index">
                    <span itemprop="name">glusterfs</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/04/04/glusterfs/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2021/04/04/glusterfs/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>GlusterFS文件存储介绍</p>
<p>原文链接：<a href="https://www.viayc.com/categories/GlusterFS/" target="_blank" rel="noopener">https://www.viayc.com/categories/GlusterFS/</a></p>
<p><strong>说明</strong></p>
<p><strong>简介</strong></p>
<table>
<thead>
<tr>
<th>1234567891011</th>
<th>GlusterFS 是 Scale-Out 存储解决方案 Gluster 的核心，它是一个开源的分布式文件系统， 具有强大的横向扩展能力，通过扩展能够支持数 PB 存储容量和处理数千客户端。 GlusterFS 借助 TCP/IP 或 InfiniBand RDMA 网络将物理分布的存储资源聚集在一起，使用单一全局命名空间来管理数据。 GlusterFS 基于可堆叠的用户空间设计，可为各种不同的数据负载提供优异的性能。 GlusterFS 支持运行在任何 IP 网络上的标准应用程序的标准客户端，用户可以在全局统一的命名空间中使用 NFS/CIFS 等标准协议来访问应用数据。 GlusterFS 使得用户可摆脱原有的独立、高成本的封闭存储系统，能够利用普通廉价的存储设备来部署可集中管理、横向扩展、虚拟化的存储池，存储容量可扩展至 TB/PB 级。 目前 GlusterFS 已被 Red Hat 收购，它的官网是：<a href="https://www.gluster.org/" target="_blank" rel="noopener">https://www.gluster.org/</a></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><strong>GlusterFS 在企业中的应用场景</strong></p>
<p>理论和实践上分析，GlusterFS 目前主要适用于大文件存储场景，对于小文件尤其是海量小文件，存储效率和访问性能都表现不佳。建议存放文件大小大于 1MB</p>
<p><strong>GlusterFS 安装</strong></p>
<p><strong>环境说明</strong></p>
<ul>
<li>CentOS 7</li>
<li>GlusterFS</li>
</ul>
<p>3 台机器安装 GlusterFS 组成一个集群。</p>
<table>
<thead>
<tr>
<th>12345678910111213</th>
<th>服务器：10.1.0.1110.1.0.1210.1.0.13 配置 hosts 10.1.0.11 manager10.1.0.12 node-110.1.0.13 node-2 client:10.1.0.10 client</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><strong>安装 GlusterFS</strong></p>
<p>CentOS 安装 GlusterFS 非常的简单</p>
<p>在三个节点都安装 GlusterFS</p>
<table>
<thead>
<tr>
<th>12345</th>
<th># 安装 GlusterFS yum 源文件#yum install centos-release-gluster # 安装 GlusterFS 软件yum install -y glusterfs glusterfs-server glusterfs-fuse glusterfs-rdma</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>启动 GlusterFS</p>
<table>
<thead>
<tr>
<th>1234567891011121314</th>
<th>[root@manager ~]#systemctl start glusterd.service[root@manager ~]#systemctl enable glusterd.service[root@manager ~]#systemctl status glusterd.service● glusterd.service - GlusterFS, a clustered file-system server  Loaded: loaded (/usr/lib/systemd/system/glusterd.service; disabled; vendor preset: disabled)  Active: active (running) since 一 2017-02-27 17:55:56 CST; 11s ago Process: 5476 ExecStart=/usr/sbin/glusterd -p /var/run/glusterd.pid –log-level $LOG_LEVEL $GLUSTERD_OPTIONS (code=exited, status=0/SUCCESS)Main PID: 5477 (glusterd) Memory: 15.0M CGroup: /system.slice/glusterd.service        └─5477 /usr/sbin/glusterd -p /var/run/glusterd.pid –log-level INFO 2 月 27 17:55:56 meetbill systemd[1]: Starting GlusterFS, a clustered file-system server…2 月 27 17:55:56 meetbill systemd[1]: Started GlusterFS, a clustered file-system server.</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><strong>配置 GlusterFS</strong></p>
<p>在 manager 节点上配置，将 节点 加入到 集群中。</p>
<table>
<thead>
<tr>
<th>12345678</th>
<th>[root@manager ~]#gluster peer probe managerpeer probe: success. Probe on localhost not needed [root@manager ~]#gluster peer probe node-1peer probe: success. [root@manager ~]#gluster peer probe node-2peer probe: success.</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>查看集群状态：</p>
<table>
<thead>
<tr>
<th>12345678910</th>
<th>[root@manager ~]#gluster peer statusNumber of Peers: 2 Hostname: node-1Uuid: 41573e8b-eb00-4802-84f0-f923a2c7be79State: Peer in Cluster (Connected) Hostname: node-2Uuid: da068e0b-eada-4a50-94ff-623f630986d7State: Peer in Cluster (Connected)</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>创建数据存储目录：</p>
<table>
<thead>
<tr>
<th>123</th>
<th>[root@manager ~]#mkdir -p /opt/gluster/data[root@node-1 ~]# mkdir -p /opt/gluster/data[root@node-2 ~]# mkdir -p /opt/gluster/data</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>查看 volume 状态：</p>
<table>
<thead>
<tr>
<th>12</th>
<th>[root@manager ~]#gluster volume infoNo volumes present</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><strong>volume 模式说明</strong></p>
<p>一、 默认模式，既 DHT, 也叫 分布卷：将文件已 hash 算法随机分布到 一台服务器节点中存储。</p>
<table>
<thead>
<tr>
<th>1</th>
<th>gluster volume create test-volume server1:/exp1 server2:/exp2</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>二、 复制模式，既 AFR, 创建 volume 时带 replica x 数量：将文件复制到 replica x 个节点中。</p>
<table>
<thead>
<tr>
<th>1</th>
<th>gluster volume create test-volume replica 2 transport tcp server1:/exp1 server2:/exp2</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>三、 条带模式，既 Striped, 创建 volume 时带 stripe x 数量： 将文件切割成数据块，分别存储到 stripe x 个节点中 ( 类似 raid 0 )。</p>
<table>
<thead>
<tr>
<th>1</th>
<th>gluster volume create test-volume stripe 2 transport tcp server1:/exp1 server2:/exp2</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>四、 分布式条带模式（组合型），最少需要 4 台服务器才能创建。 创建 volume 时 stripe 2 server = 4 个节点： 是 DHT 与 Striped 的组合型。</p>
<table>
<thead>
<tr>
<th>1</th>
<th>gluster volume create test-volume stripe 2 transport tcp server1:/exp1 server2:/exp2 server3:/exp3 server4:/exp4</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>五、 分布式复制模式（组合型）, 最少需要 4 台服务器才能创建。 创建 volume 时 replica 2 server = 4 个节点：是 DHT 与 AFR 的组合型。</p>
<table>
<thead>
<tr>
<th>1</th>
<th>gluster volume create test-volume replica 2 transport tcp server1:/exp1 server2:/exp2　server3:/exp3 server4:/exp4</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>六、 条带复制卷模式（组合型）, 最少需要 4 台服务器才能创建。 创建 volume 时 stripe 2 replica 2 server = 4 个节点： 是 Striped 与 AFR 的组合型。</p>
<table>
<thead>
<tr>
<th>1</th>
<th>gluster volume create test-volume stripe 2 replica 2 transport tcp server1:/exp1 server2:/exp2 server3:/exp3 server4:/exp4</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>七、 三种模式混合，至少需要 8 台 服务器才能创建。 stripe 2 replica 2 , 每 4 个节点 组成一个 组。</p>
<table>
<thead>
<tr>
<th>1</th>
<th>gluster volume create test-volume stripe 2 replica 2 transport tcp server1:/exp1 server2:/exp2 server3:/exp3 server4:/exp4 server5:/exp5 server6:/exp6 server7:/exp7 server8:/exp8</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><strong>创建 GlusterFS 磁盘</strong></p>
<table>
<thead>
<tr>
<th>12</th>
<th>[root@manager ~]#gluster volume create models replica 3 manager:/opt/gluster/data node-1:/opt/gluster/data node-2:/opt/gluster/data forcevolume create: models: success: please start the volume to access data</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>再查看 volume 状态：</p>
<table>
<thead>
<tr>
<th>1234567891011121314</th>
<th>[root@manager ~]#gluster volume info Volume Name: modelsType: ReplicateVolume ID: e539ff3b-2278-4f3f-a594-1f101eabbf1eStatus: CreatedNumber of Bricks: 1 x 3 = 3Transport-type: tcpBricks:Brick1: manager:/opt/gluster/dataBrick2: node-1:/opt/gluster/dataBrick3: node-2:/opt/gluster/dataOptions Reconfigured:performance.readdir-ahead: on</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>启动 models</p>
<table>
<thead>
<tr>
<th>12</th>
<th>[root@manager ~]#gluster volume start modelsvolume start: models: success</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><strong>GlusterFS 客户端</strong></p>
<p>部署 GlusterFS 客户端并 mount GlusterFS 文件系统</p>
<table>
<thead>
<tr>
<th>123</th>
<th>[root@client ~]#yum install -y glusterfs glusterfs-fuse[root@client ~]#mkdir -p /opt/gfsmnt[root@client ~]#mount -t glusterfs manager:models /opt/gfsmnt/</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>1234567891011</th>
<th>[root@node-94 ~]#df -h文件系统 容量 已用 可用 已用 % 挂载点/dev/mapper/vg001-root 98G 1.2G 97G 2% /devtmpfs 32G 0 32G 0% /devtmpfs 32G 0 32G 0% /dev/shmtmpfs 32G 130M 32G 1% /runtmpfs 32G 0 32G 0% /sys/fs/cgroup/dev/mapper/vg001-opt 441G 71G 370G 17% /opt/dev/sda2 497M 153M 344M 31% /boottmpfs 6.3G 0 6.3G 0% /run/user/0manager:models 441G 18G 424G 4% /opt/gfsmnt</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><strong>维护</strong></p>
<ol>
<li>查看 GlusterFS 中所有的 volume:</li>
</ol>
<table>
<thead>
<tr>
<th>1</th>
<th>[root@manager ~]#gluster volume list</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<ol>
<li>删除 GlusterFS 磁盘：</li>
</ol>
<table>
<thead>
<tr>
<th>12</th>
<th>[root@manager ~]#gluster volume stop models   #停止名字为 models 的磁盘[root@manager ~]#gluster volume delete models #删除名字为 models 的磁盘</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>注： 删除 磁盘 以后，必须删除 磁盘 ( /opt/gluster/data ) 中的 （ .glusterfs/ .trashcan/ ）目录。</p>
<p>否则创建新 volume 相同的 磁盘 会出现文件 不分布，或者 类型 错乱 的问题。</p>
<ol>
<li>卸载某个节点 GlusterFS 磁盘</li>
</ol>
<table>
<thead>
<tr>
<th>1</th>
<th>[root@manager ~]#gluster peer detach node-2</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<ol>
<li>设置访问限制，按照每个 volume 来限制</li>
</ol>
<table>
<thead>
<tr>
<th>1</th>
<th>[root@manager ~]#gluster volume set models auth.allow 10.6.0.<em>,10.7.0.</em></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<ol>
<li>添加 GlusterFS 节点：</li>
</ol>
<table>
<thead>
<tr>
<th>12</th>
<th>[root@manager ~]#gluster peer probe node-3[root@manager ~]#gluster volume add-brick models node-3:/opt/gluster/data</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>注：如果是复制卷或者条带卷，则每次添加的 Brick 数必须是 replica 或者 stripe 的整数倍</p>
<ol>
<li>配置卷</li>
</ol>
<table>
<thead>
<tr>
<th>1</th>
<th>[root@manager ~]# gluster volume set</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<ol>
<li>缩容 volume:</li>
</ol>
<p>先将数据迁移到其它可用的 Brick，迁移结束后才将该 Brick 移除：</p>
<table>
<thead>
<tr>
<th>1</th>
<th>[root@manager ~]#gluster volume remove-brick models node-2:/opt/gluster/data node-3:/opt/gluster/data start</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>在执行了 start 之后，可以使用 status 命令查看移除进度：</p>
<table>
<thead>
<tr>
<th>1</th>
<th>[root@manager ~]#gluster volume remove-brick models node-2:/opt/gluster/data node-3:/opt/gluster/data status</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>不进行数据迁移，直接删除该 Brick：</p>
<table>
<thead>
<tr>
<th>1</th>
<th>[root@manager ~]#gluster volume remove-brick models node-2:/opt/gluster/data node-3:/opt/gluster/data commit</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>注意，如果是复制卷或者条带卷，则每次移除的 Brick 数必须是 replica 或者 stripe 的整数倍。</p>
<p>扩容：</p>
<table>
<thead>
<tr>
<th>1</th>
<th>gluster volume add-brick models node-2:/opt/gluster/data</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<ol>
<li>修复命令：</li>
</ol>
<table>
<thead>
<tr>
<th>1</th>
<th>[root@manager ~]#gluster volume replace-brick models node-2:/opt/gluster/data node-3:/opt/gluster/data commit -force</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<ol>
<li>迁移 volume:</li>
</ol>
<table>
<thead>
<tr>
<th>1</th>
<th>[root@manager ~]#gluster volume replace-brick models node-2:/opt/gluster/data node-3:/opt/gluster/data start</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>pause 为暂停迁移</p>
<table>
<thead>
<tr>
<th>1</th>
<th>[root@manager ~]#gluster volume replace-brick models node-2:/opt/gluster/data node-3:/opt/gluster/data pause</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>abort 为终止迁移</p>
<table>
<thead>
<tr>
<th>1</th>
<th>[root@manager ~]#gluster volume replace-brick models node-2:/opt/gluster/data node-3:/opt/gluster/data abort</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>status 查看迁移状态</p>
<table>
<thead>
<tr>
<th>1</th>
<th>[root@manager ~]#gluster volume replace-brick models node-2:/opt/gluster/data node-3:/opt/gluster/data status</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>迁移结束后使用 commit 来生效</p>
<table>
<thead>
<tr>
<th>1</th>
<th>[root@manager ~]#gluster volume replace-brick models node-2:/opt/gluster/data node-3:/opt/gluster/data commit</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<ol>
<li>均衡 volume:</li>
</ol>
<table>
<thead>
<tr>
<th>12345</th>
<th>[root@manager ~]#gluster volume models lay-outstart[root@manager ~]#gluster volume models start[root@manager ~]#gluster volume models startforce[root@manager ~]#gluster volume models status[root@manager ~]#gluster volume models stop</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">下一页</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/zpj.jpg"
                alt="zhangpengjie" />
            
              <p class="site-author-name" itemprop="name">zhangpengjie</p>
              <p class="site-description motion-element" itemprop="description">愿你在任何困难面前都足够坚强</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">33</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://cn.bing.com/" title="必应" target="_blank">必应</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhangpengjie</span>

  
</div>


  <div class="powered-by">爱分享爱自由</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'SFffbOWnbxhEhkvt0mSxlD0E-gzGzoHsz',
        appKey: 'gdvigtTA0Ux7TDRUmqRJMoTV',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
